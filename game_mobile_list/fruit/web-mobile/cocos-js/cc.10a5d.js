System.register(["split:/physx.release.asm.js"],(function(e,t){"use strict";var n;return{setters:[function(e){n=e.default}],execute:function(){e({BitMask:Ye,CCClass:Ht,CacheMode:void 0,DebugMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:Ke,Eventify:an,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:LA,WorldNode3DToWorldNodeUI:BA,absMax:fi,absMaxComponent:_i,approx:Qn,assert:v,assertID:P,bezier:zf,bezierByTime:np,ccenum:Je,clamp:Zn,clamp01:Jn,color:vi,computeRatioByType:yU,createDefaultPipeline:BM,debug:g,deserialize:Gh,earcut:a4,enumerableProps:pi,equals:Kn,error:m,errorID:w,find:DO,fragmentText:HK,getBaselineOffset:function(){return 0},getError:O,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[hl]},getWorldTransformUntilRoot:KG,instantiate:r_,inverseLerp:hi,isCustomTargetModifier:nH,isDisplayStats:D,isElementModifier:tH,isPropertyModifier:eH,isUnicodeCJK:zK,isUnicodeSpace:UK,isValid:Zt,lerp:$n,log:p,logID:E,markAsWarning:void 0,mat4:Bi,murmurhash2_32_gc:Da,nextPow2:ci,pingPong:ui,pseudoRandom:oi,pseudoRandomRange:ai,pseudoRandomRangeInt:si,quat:Oi,randomRange:ii,randomRangeInt:ri,rect:Xi,removeProperty:void 0,repeat:li,replaceProperty:void 0,safeMeasureText:kK,sampleAnimationCurve:gU,setDefaultLogTimes:function(e){e>0&&(Vn=e)},setDisplayStats:M,size:Wi,toDegree:ti,toRadian:ei,tween:IRe,tweenUtil:PRe,v2:ki,v3:xi,v4:Hi,warn:d,warnID:b});var i="undefined"==typeof window?global:window,r=e("cclegacy",{_global:i});r.internal={},i.CC_BUILD=!0,i.CC_TEST=!1,i.CC_EDITOR=false,i.CC_PREVIEW=!1,i.CC_DEV=!1,i.CC_DEBUG=!1,i.CC_JSB=!1,i.CC_BYTEDANCE=!1,i.CC_WECHAT=!1,i.CC_ALIPAY=!1,i.CC_XIAOMI=!1,i.CC_BAIDU=!1,i.CC_COCOSPLAY=!1,i.CC_HUAWEI=!1,i.CC_OPPO=!1,i.CC_VIVO=!1,i.CC_MINIGAME=!1,i.CC_RUNTIME_BASED=!1,i.CC_SUPPORT_JIT=!0,i.CC_UI_GPU_DRIVEN=!1;var o=e("VERSION","3.4.0");i.CocosEngine=r.ENGINE_VERSION=o,i.cc=r;var a="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",s=null,c=console.log.bind(console),l=c,u=c,h=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+f.apply(void 0,[t].concat(i)))}},_=c;function f(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return r.js.formatStr.apply(null,[e].concat(n))}function p(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return c.apply(void 0,[e].concat(n))}function d(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return l.apply(void 0,[e].concat(n))}function m(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return u.apply(void 0,[e].concat(n))}function v(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return h.apply(void 0,[e,t].concat(i))}function g(){return _.apply(void 0,arguments)}function y(e){if(c=l=u=h=_=function(){},e!==R.NONE){if(e>R.ERROR){var t=function(e){if(r.game.canvas){if(!s){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",r.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(s=document.createElement("textarea")).setAttribute("rows","20"),s.setAttribute("cols","30"),s.setAttribute("disabled","true");var i=s.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(s),r.game.canvas.parentNode.appendChild(t)}s.value=s.value+e+"\r\n",s.scrollTop=s.scrollHeight}};u=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+f.apply(void 0,[e].concat(i)))},h=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t("ASSERT: "+f.apply(void 0,[n].concat(r)))}},e!==R.ERROR_FOR_WEB_PAGE&&(l=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+f.apply(void 0,[e].concat(i)))}),e===R.INFO_FOR_WEB_PAGE&&(c=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(f.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),u=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},h=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=f.apply(void 0,[t].concat(i));throw new Error(o)}});if(e!==R.ERROR&&(l=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=R.INFO&&(c=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=R.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);_=function(){return n.apply(void 0,arguments)}}}}function S(e){m(e.stack||e)}function x(e){return function(t){for(var n=e+" "+t+", please go to "+a+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var T=x("Log");function E(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];p(T.apply(void 0,[e].concat(n)))}var C=x("Warning");function b(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];d(C.apply(void 0,[e].concat(n)))}var A=x("Error");function w(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];m(A.apply(void 0,[e].concat(n)))}var R,I=x("Assert");function P(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];v(!1,I.apply(void 0,[t].concat(i)))}}function O(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return A.apply(void 0,[e].concat(n))}function D(){return!!r.profiler&&r.profiler.isShowingStats()}function M(e){r.profiler&&(e?r.profiler.showStats():r.profiler.hideStats(),r.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(R||(R=e("DebugMode",{})));var N=Object.freeze({__proto__:null,log:p,warn:d,error:m,assert:v,debug:g,_resetDebugSetting:y,_throw:S,logID:E,warnID:b,errorID:w,assertID:P,get DebugMode(){return R},getError:O,isDisplayStats:D,setDisplayStats:M});function L(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function B(e,t,n){return t&&L(e.prototype,t),n&&L(e,n),e}function F(){return(F=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function z(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,k(e,t)}function U(e){return(U=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function k(e,t){return(k=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function G(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function H(e,t,n){return(H=G()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&k(r,n.prototype),r}).apply(null,arguments)}function V(e){var t="function"==typeof Map?new Map:void 0;return(V=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return H(e,arguments,U(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),k(i,e)})(e)}function j(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function W(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function q(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return W(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?W(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function X(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function Y(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}var K=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},B(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function Q(e,t){e.splice(t,1)}function Z(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function J(e,t){var n=e.indexOf(t);return n>=0&&(Q(e,n),!0)}function $(e,t){return e.indexOf(t)>=0}var ee=Object.freeze({__proto__:null,removeAt:Q,fastRemoveAt:Z,remove:J,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return Q(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=q(e);!(n=i()).done;)if(!(n.value instanceof t))return E(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)J(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:$,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:K}),te=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();te.global=new te("global");var ne=new te("TmpCId."),ie="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),re="__cid__";function oe(e){return"number"==typeof e||e instanceof Number}function ae(e){return"string"==typeof e||e instanceof String}function se(e){for(var t in e)return!1;return!0}var ce,le=(ce={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){ce.value=n,ce.writable=i,ce.enumerable=r,Object.defineProperty(e,t,ce),ce.value=void 0}),ue=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),e.get=i,e.set=r,e.enumerable=o,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),he=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.get=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0}}(),_e=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.set=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.set=void 0}}();function fe(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function pe(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?pe(e.constructor):""}function de(e,t,n,i){var r=/([^.]+)$/,o=r.exec(t)[0],a=r.exec(n)[0];function s(){return this[a]}i?ue(e,o,s,(function(e){this[a]=e})):he(e,o,s)}function me(e,t,n,i){for(var r in n)de(e,t+"."+r,n[r],i)}var ve=/(%d)|(%s)/,ge=/%s/;function ye(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&ve.test(e);if(r)for(var o,a=q(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?ve:ge;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=q(n);!(u=h()).done;){var _=u.value;e+=" "+_}return e}function Se(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function xe(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Te(e,t,n){var i=xe(t,e);i&&Object.defineProperty(n,e,i)}function Ee(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){w(5402,a);continue}for(var s in a)s in e||Te(s,a,e)}}return e}function Ce(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){w(5403,a);continue}for(var s in a)Te(s,a,e)}}return e}function be(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ae(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function we(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ae(e)))return!1;if(e===t)return!0}}return!1}function Re(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Ie=fe(!0),Pe=fe(!0);function Oe(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],le(i.prototype,e,n),n){var r=t[n];r&&r!==i?m("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var De=Oe("__cid__",Ie),Me=Oe("__classname__",Pe);function Ne(e,t){if(Me(e,t),!t.prototype.hasOwnProperty(re)){var n=e||ne.getNewId();n&&De(n,t)}}function Le(e,t){var n=Pe[t],i=Ie[t],r=!0;if(n&&n!==e&&(m('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(m('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var o=e[ie];o||(o=[],e[ie]=o),o.push(t),Pe[t]=e,Ie[t]=e}}function Be(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Ie[s];var c=a.__classname__;c&&delete Pe[c];var l=a[ie];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Pe[h],delete Ie[h]}}}function Fe(e){return Ie[e]}function ze(e){return Pe[e]}function Ue(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(re))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(re))return e.__cid__}return""}var ke=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),Ge=ee,He={IDGenerator:te,Pool:ke,array:ee,isNumber:oe,isString:ae,isEmptyObject:se,getPropertyDescriptor:xe,addon:Ee,mixin:Ce,extend:be,getSuper:Ae,isChildClassOf:we,clear:Re,value:le,getset:ue,get:he,set:_e,unregisterClass:Be,getClassName:pe,setClassName:Ne,setClassAlias:Le,getClassByName:ze,get _registeredClassNames(){return F({},Pe)},set _registeredClassNames(e){Re(Pe),Object.assign(Pe,e)},get _registeredClassIds(){return F({},Ie)},set _registeredClassIds(e){Re(Ie),Object.assign(Ie,e)},_getClassId:Ue,_setClassId:De,_getClassById:Fe,obsolete:de,obsoletes:me,formatStr:ye,shiftArguments:Se,createMap:fe};r.js=He,e("js",Object.freeze({__proto__:null,array:Ge,js:He,IDGenerator:te,Pool:ke,isNumber:oe,isString:ae,isEmptyObject:se,value:le,getset:ue,get:he,set:_e,createMap:fe,getClassName:pe,obsolete:de,obsoletes:me,formatStr:ye,shiftArguments:Se,getPropertyDescriptor:xe,addon:Ee,mixin:Ce,extend:be,getSuper:Ae,isChildClassOf:we,clear:Re,_idToClass:Ie,_nameToClass:Pe,_setClassId:De,setClassName:Ne,setClassAlias:Le,unregisterClass:Be,_getClassById:Fe,getClassByName:ze,_getClassId:Ue}));var Ve=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,He.array.fastRemoveAt(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),je=function(){function e(){this._poolHandle=-1,Ve.addContainer(this)}return e.prototype.destroy=function(){Ve.removeContainer(this)},e}(),We=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(t());return r}z(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&b(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(je)),qe=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=t();return r}z(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},B(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(je)),Xe=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=void 0!==n?n:function(e,t){return e-t},i}z(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(je));function Ye(e){if("__bitmask__"in e)return e;le(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&le(e,a,r)}return e}function Ke(e){return"__enums__"in e?e:(le(e,"__enums__",null,!0),Ke.update(e))}function Qe(e){e.hasOwnProperty("__enums__")}function Ze(e){Qe(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function Je(e){"__enums__"in e||le(e,"__enums__",null,!0)}e("memop",Object.freeze({__proto__:null,Pool:We,RecyclePool:qe,CachedArray:Xe})),Ye.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},Ye.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},r.BitMask=Ye,Ke.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&le(e,a,r)}return Array.isArray(e.__enums__)&&Ze(e),e},Ke||(Ke=e("Enum",{})),Ke.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},Ke.getList=function(e){return Qe(e),e.__enums__?e.__enums__:Ze(e)},r.Enum=Ke;var $e=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return w(100,pe(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){w(100,pe(this)+".set")},t.toString=function(){return""+{}},e}());Ne("cc.ValueType",$e),r.ValueType=$e;var et=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});r.macro=et;for(var tt=/^(?:cc|dragonBones|sp|ccsg)\..+/,nt=new Array(123),it=0;it<123;++it)nt[it]=64;for(var rt=0;rt<64;++rt)nt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(rt)]=rt;var ot=nt;function at(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var o=e[n];ue(e,t,o,e[i])}}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function st(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function ct(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function lt(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ut(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function ht(e){return!(!e||e.constructor!==Object)&&se(e)}function _t(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function ft(e){return e*et.RAD}function pt(e){return e*et.DEG}r.misc={BUILTIN_CLASSID_RE:tt,BASE64_VALUES:ot,propertyDefine:at,pushToMap:st,contains:ct,isDomNode:lt,callInNextTick:ut,isPlainEmptyObj_DEV:ht,clampf:_t,degreesToRadians:ft,radiansToDegrees:pt},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:tt,BASE64_VALUES:ot,propertyDefine:at,pushToMap:st,contains:ct,isDomNode:lt,callInNextTick:ut,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ht,clampf:_t,degreesToRadians:ft,radiansToDegrees:pt}));var dt="$_$";function mt(e,t){var n=t?Object.create(t):{};return le(e,"__attrs__",n),n}function vt(e){if("function"!=typeof e)return mt(e,yt(e.constructor));for(var t,n=r.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var o=n[i];o.hasOwnProperty("__attrs__")&&o.__attrs__||mt(o,(t=n[i+1])&&t.__attrs__)}return mt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function gt(e,t){var n=yt(e),i=t+dt,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function yt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||vt(e)}function St(e,t,n,i){yt(e)[t+dt+n]=i}var xt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),Tt=e("CCInteger",new xt("Integer",0));r.Integer=Tt,r.CCInteger=Tt;var Et=e("CCFloat",new xt("Float",0));r.Float=Et,r.CCFloat=Et;var Ct=e("CCBoolean",new xt("Boolean",!1));r.Boolean=Ct,r.CCBoolean=Ct;var bt=e("CCString",new xt("String",""));function At(e,t){return function(n,i){var r='"'+pe(n)+"."+i+'"',o=gt(n,i),a=o.type;if(a===Tt||a===Et?a="Number":a!==bt&&a!==Ct||(a=""+a),a===e){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!ht(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;b(3605,r,pe(o.ctor))}else"Number"!==e&&b(3606,t,r,e);else{if("function"===c)return;e===bt.default&&null==s?b(3607,r):b(3611,t,r,c)}delete o.type}}}else b(3604,r)}}r.String=bt,r.CCString=bt;var wt=Object.freeze({__proto__:null,DELIMETER:dt,createAttrsSingle:mt,createAttrs:vt,attr:gt,getClassAttrs:yt,setClassAttr:St,PrimitiveType:xt,CCInteger:Tt,CCFloat:Et,CCBoolean:Ct,CCString:bt,getTypeChecker_ET:At,getObjTypeChecker_ET:function(e){return function(t,n){At("Object","type")(t,n);var i=yt(t)[n+dt+"default"],o=r.Class.getDefault(i);if(!Array.isArray(o)&&we(e,r.ValueType)){var a=pe(e),s=ye('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',pe(t),n,a);i?p(s):b(3612,s,a,pe(t),n,a)}}}}),Rt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function It(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var o={};for(var a in i[r]=o,Rt){var s=Rt[a];e.hasOwnProperty(a)&&(o[a]=e[a],s.canUsedInGet||delete e[a])}}}function Pt(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return w(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=r.String:t===Boolean?e.type=r.Boolean:t===Number&&(e.type=r.Float))}function Ot(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Dt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Ot(t,[],e);if("function"==typeof e){var n=e;return Ot(t,we(n,r.ValueType)?new n:null,n)}return Ot(t,e instanceof xt?e.default:e)}return null}var Mt=[];function Nt(){return Mt[Mt.length-1]}r._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Mt.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Mt.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Nt};var Lt=dt,Bt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=pe(i);r?Gt(i,o,r,i.$super,n.mixins):w(3633,o)}this.datas=null}}};function Ft(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),jt(e,i,t,n)}function zt(e,t,n,i){var r=i.get;i.set,r&&(jt(e,i,t,n),St(e,n,"serializable",!1))}function Ut(e){return"function"==typeof e?e():e}function kt(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,xe(t,i))}function Gt(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Dt(i,!1);if(r&&(i=e[n]=r),i){var o=i.notify;o&&It(i,n,o,e),"type"in i&&Pt(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?zt(e,t,s,c):Ft(e,t,s,c)}var l=yt(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Lt+"serializable"]}))}function Ht(e){var t=e.name,n=e.extends,i=e.mixins,o=function(e,t,n,i){var o=r.Component,a=Nt();if(a&&we(t,o)){if(we(a.cls,o))return w(3615),null;e=e||a.script}var s=function(e,t,n,i){var r=i.ctor,o=[r],a=r;le(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];kt(s,l.prototype),Ht._isCCClass(l)&&kt(yt(a),yt(l))}s.constructor=a}return Ne(e,a),a}(e,t,n,i);if(a)if(we(t,o)){var c=a.uuid;c&&De(c,s),a.cls=s}else we(a.cls,o)||(a.cls=s);return s}(t,n,i,e);t||(t=r.js.getClassName(o)),o._sealed=!0,n&&(n._sealed=!1);var a=e.properties;"function"==typeof a||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(Bt.push({cls:o,props:a,mixins:i}),o.__props__=o.__values__=null):Gt(o,t,a,n,e.mixins);var s=e.editor;return s&&we(n,r.Component)&&r.Component._registerEditorProps(o,s),o}Ht._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},Ht.fastDefine=function(e,t,n){Ne(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=yt(t),o=0;o<i.length;o++){var a=i[o];r[a+Lt+"visible"]=!1,r[a+Lt+"default"]=n[a]}},Ht.Attr=wt,Ht.attr=gt,Ht.getInheritanceChain=function(e){for(var t=[];e=Ae(e);)e!==Object&&t.push(e);return t};var Vt={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function jt(e,t,n,i){var r=null,o="";function a(){return o=i+Lt,r=yt(e)}"type"in t&&void 0===t.type&&b(3660,i,n);var s=t.type;s&&(Vt[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?Ke.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=Ke.getList(s)):Ye.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=Ye.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in t&&((r||a())[o+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||a())[o+e]=i)}};t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.__noImplicit?(r||a())[o+"serializable"]=null!==(c=t.serializable)&&void 0!==c&&c:!1===t.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Ht.isArray=function(e){return e=Ut(e),Array.isArray(e)},Ht.getDefault=Ut,Ht.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Ht.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Ht.getNewValueTypeCode=function(e){for(var t=pe(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},r.Class=Ht;var Wt,qt=e("editorExtrasTag","__editorExtras__"),Xt=1<<22,Yt=[],Kt=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=Yt.length,t=0;t<e;++t){var n=Yt[t];1&n._objFlags||n._destroyImmediate()}e===Yt.length?Yt.length=0:Yt.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(b(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Yt.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof r._BaseNode||e instanceof r.Component,o=i?"_id":null,a={};for(n in e)if(e.hasOwnProperty(n)){if(n===o)continue;switch(typeof e[n]){case"string":a[n]="";break;case"object":case"function":a[n]=null}}if(Ht._isCCClass(t))for(var s=r.Class.Attr.getClassAttrs(t),c=t.__props__,l=0;l<c.length;l++){var u=(n=c[l])+r.Class.Attr.DELIMETER+"default";if(u in s){if(i&&"_id"===n)continue;switch(typeof s[u]){case"string":a[n]="";break;case"object":case"function":a[n]=null;break;case"undefined":a[n]=void 0}}}var h="";for(n in a){var _;_=Ht.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Ht.escapeForJS(n)+"]=";var f=a[n];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,e),le(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?w(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},B(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&Xt)},set:function(e){e?this._objFlags|=Xt:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),Qt=Kt.prototype;function Zt(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}Qt._deserialize=null,Qt._onPreDestroy=null,Ht.fastDefine("cc.Object",Kt,((Wt={_name:"",_objFlags:0})[qt]={},Wt)),Ht.Attr.setClassAttr(Kt,qt,"editorOnly",!0),Ht.Attr.setClassAttr(Kt,"replicated","visible",!1),le(Kt,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),r.isValid=Zt,r.Object=Kt;var Jt=Ge.fastRemoveAt;function $t(){}var en=function(){function e(){this.callback=$t,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||$t,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=$t,this.once=!1},t.check=function(){return!(this.target instanceof Kt&&!Zt(this.target,!0))},e}(),tn=new We((function(){return new en}),32),nn=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),tn.free(n),Jt(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),tn.free(n),Jt(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Jt(this.callbackInfos,e),tn.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),tn.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Jt(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),rn=new We((function(){return new nn}),16),on=function(){function e(){this._callbackTable=fe(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=rn.alloc());var o=tn.alloc();o.set(t,n,i),r.callbackInfos.push(o)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),rn.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===e&&r.cancel(a)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var o=r.callbackInfos;if(t)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===t&&s.target===n){r.cancel(a);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,r,o):_(t,n,i,r,o):this.off(e,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),rn.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function an(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=fe(!0),t}z(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=on.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(t.prototype,o,a)}}return t}var sn,cn,ln,un,hn,_n,fn=e("EventTarget",an((function(){})));r.EventTarget=fn,function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(sn||(sn={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(cn||(cn={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(ln||(ln={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(un||(un={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(hn||(hn={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(_n||(_n={}));var pn=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(t=o.getBattery)||void 0===t||t.call(o).then((function(e){i._battery=e})),i.networkType=ln.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?hn.MOBILE_BROWSER:hn.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:cn.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=un.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=un.WINDOWS:l?f=un.IOS:-1!==o.appVersion.indexOf("Mac")?f=un.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=un.LINUX:c?f=un.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=un.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=sn.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),d=p?p[0].toLowerCase():un.UNKNOWN;("safari"===d&&c||"qq"===d&&/android.*applewebkit/i.test(a))&&(d=sn.ANDROID);var m={micromessenger:sn.WECHAT,wechat:sn.WECHAT,weixin:sn.WECHAT,trident:sn.IE,edge:sn.EDGE,"360 aphone":sn.BROWSER_360,mxbrowser:sn.MAXTHON,"opr/":sn.OPERA,ubrowser:sn.UC,huaweibrowser:sn.HUAWEI};i.browserType=m[d]||d,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var S=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){S=!0,null==e||e.close()})).catch((function(){})));var x=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,T=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[_n.WEBP]=g,n[_n.IMAGE_BITMAP]=S,n[_n.WEB_VIEW]=!0,n[_n.VIDEO_PLAYER]=!0,n[_n.SAFE_AREA]=!1,n[_n.INPUT_TOUCH]=x,n[_n.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[_n.EVENT_MOUSE]=T,n[_n.EVENT_TOUCH]=x||T,n[_n.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}z(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,o,a){n&&(n=!1,t.emit("show",e,i,r,o,a))};if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(fn)),dn=/(\.[^\.\/\?\\]*)(\?.*)?$/,mn=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,vn=/[^\.\/]+\/\.\.\//;function gn(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function yn(e){var t=dn.exec(e);return t?t[1]:""}function Sn(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function xn(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function Tn(e){var t=mn.exec(e);return t?t[2]:""}function En(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function Cn(e,t,n){if(0===t.indexOf("."))return En(e,t);var i=e.indexOf("?"),r="",o=n?yn(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function bn(e){var t=e=String(e);do{t=e,e=e.replace(vn,"")}while(t.length!==e.length);return e}function An(e){return e.replace(/[\/\\]$/,"")}function wn(){return pn.os===un.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:gn,extname:yn,mainFileName:Sn,basename:xn,dirname:Tn,changeExtname:En,changeBasename:Cn,_normalize:bn,stripSep:An,getSeperator:wn})),r.log=p,r.warn=d,r.error=m,r.assert=v,r._throw=S,r.logID=E,r.warnID=b,r.errorID=w,r.assertID=P,r.debug=N,r.path={join:gn,extname:yn,mainFileName:Sn,basename:xn,dirname:Tn,changeExtname:En,changeBasename:Cn,_normalize:bn,stripSep:An,get sep(){return wn()}};var Rn=0,In={},Pn=2147483647;function On(e){return(e>0)-(e<0)}function Dn(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function Mn(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function Nn(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}var Ln=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(Ln);var Bn=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:Pn,INT_MIN:-2147483648,sign:On,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:Dn,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:Mn,nextPow2:Nn,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return Ln[255&e]<<24|Ln[e>>>8&255]<<16|Ln[e>>>16&255]<<8|Ln[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>Mn(e)+1}});e("bits",Bn);var Fn,zn,Un,kn,Gn,Hn,Vn=10,jn=0,Wn=new Map;kn=function(e,t,n,i,r,o,a){var s=Wn.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},Fn=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=jn++;Wn.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Vn});var r=null!=n.target?n.target:e,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return kn(t,n.name,a,o,d,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return kn(t,n.name,a,o,d,i,c),n.customGetter.call(this)},set:function(e){kn(t,n.name,a,o,d,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){kn(t,n.name,a,o,d,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return kn(t,n.name,a,o,d,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return kn(t,n.name,a,o,d,i,c),s?this[o]:r[o]},set:function(e){kn(t,n.name,a,o,d,i,c),s?this[o]=e:r[o]=e},enumerable:!1})}))})),Hn=function(e,t,n,i,r){var o=Wn.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,e+"."+t),o.count++)},zn=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=jn++;Wn.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Vn});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return Hn(t,n.name,m,i,r)},set:function(){Hn(t,n.name,m,i,r)},enumerable:!1})}))})),Gn=function(e,t,n,i,r){var o=Wn.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,e+"."+t),o.count++)},Un=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var o=jn++;Wn.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Vn});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return Gn(t,i,d,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return Gn(t,i,d,o,a),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){Gn(t,i,d,o,a),c=e}})}else!function(t,n,i,r,o,a){if(t.get){var s=t.get;t.get=function(){return Gn(n,i,r,o,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){Gn(n,i,r,o,a),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,d,o,a);Object.defineProperty(e,i,{enumerable:!1})}}))}));var qn=Math.PI/180,Xn=180/Math.PI,Yn=e("EPSILON",1e-6);function Kn(e,t){return Math.abs(e-t)<=Yn*Math.max(1,Math.abs(e),Math.abs(t))}function Qn(e,t,n){return n=n||Yn,Math.abs(e-t)<=n}function Zn(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function Jn(e){return e<0?0:e>1?1:e}function $n(e,t,n){return e+(t-e)*n}function ei(e){return e*qn}function ti(e){return e*Xn}var ni=e("random",Math.random);function ii(e,t){return Math.random()*(t-e)+e}function ri(e,t){return Math.floor(ii(e,t))}function oi(e){return(e=(9301*e+49297)%233280)/233280}function ai(e,t,n){return oi(e)*(n-t)+t}function si(e,t,n){return Math.floor(ai(e,t,n))}function ci(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function li(e,t){return e-Math.floor(e/t)*t}function ui(e,t){return e=li(e,2*t),t-Math.abs(e-t)}function hi(e,t,n){return(n-e)/(t-e)}function _i(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function fi(e,t){return Math.abs(e)>Math.abs(t)?e:t}function pi(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var di=1/255,mi=e("Color",function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this)._val=0,"string"==typeof t?o.fromHEX(t):void 0!==n?o.set(t,n,i,r):o.set(t),o}z(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16),e.a=Number.isNaN(e.a)?255:e.a,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,o=t.g,a=t.b,s=t.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=Yn),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*di).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,o=0;if(0===t)i=r=o=n;else if(0===n)i=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*di,t=this.g*di,n=this.b*di,i={h:0,s:0,v:0},r=Math.max(e,t,n),o=Math.min(e,t,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=e===r?(t-n)/a:t===r?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},B(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~Zn(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~Zn(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~Zn(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~Zn(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*di},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*di},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*di},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*di},set:function(e){this.a=255*e}}]),t}($e));function vi(e,t,n,i){return new mi(e,t,n,i)}mi.WHITE=Object.freeze(new mi(255,255,255,255)),mi.GRAY=Object.freeze(new mi(127,127,127,255)),mi.BLACK=Object.freeze(new mi(0,0,0,255)),mi.TRANSPARENT=Object.freeze(new mi(0,0,0,0)),mi.RED=Object.freeze(new mi(255,0,0,255)),mi.GREEN=Object.freeze(new mi(0,255,0,255)),mi.BLUE=Object.freeze(new mi(0,0,255,255)),mi.CYAN=Object.freeze(new mi(0,255,255,255)),mi.MAGENTA=Object.freeze(new mi(255,0,255,255)),mi.YELLOW=Object.freeze(new mi(255,255,0,255)),Ht.fastDefine("cc.Color",mi,{r:0,g:0,b:0,a:255}),r.Color=mi,r.color=vi;var gi=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}z(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<Yn?e.x=0:e.x=1/n,Math.abs(i)<Yn?e.y=0:e.y=1/i,Math.abs(r)<Yn?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z;return e.x=r*c-o*s,e.y=o*a-i*c,e.z=i*s-r*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*ni()*Math.PI,i=2*ni()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,e.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,e.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o)*a,e.y=(n.m01*i+n.m05*r+n.m09*o)*a,e.z=(n.m02*i+n.m06*r+n.m10*o)*a,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=i*n.m00+r*n.m03+o*n.m06,e.y=i*n.m01+r*n.m04+o*n.m07,e.z=i*n.m02+r*n.m05+o*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13,e.x=n.m02*i+n.m06*r+n.m10*o+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,o=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,e.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,e.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var o=t.x*r.x,a=t.y*r.y,s=t.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var o=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=Yn);var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},t.angle=function(e,n){t.normalize(yi,e),t.normalize(Si,n);var i=t.dot(yi,Si);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=Yn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=Yn),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=Zn(this.x,e.x,t.x),this.y=Zn(this.y,e.y,t.y),this.z=Zn(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}($e));gi.UNIT_X=Object.freeze(new gi(1,0,0)),gi.UNIT_Y=Object.freeze(new gi(0,1,0)),gi.UNIT_Z=Object.freeze(new gi(0,0,1)),gi.RIGHT=Object.freeze(new gi(1,0,0)),gi.UP=Object.freeze(new gi(0,1,0)),gi.FORWARD=Object.freeze(new gi(0,0,-1)),gi.ZERO=Object.freeze(new gi(0,0,0)),gi.ONE=Object.freeze(new gi(1,1,1)),gi.NEG_ONE=Object.freeze(new gi(-1,-1,-1));var yi=new gi,Si=new gi;function xi(e,t,n){return new gi(e,t,n)}Ht.fastDefine("cc.Vec3",gi,{x:0,y:0,z:0}),r.Vec3=gi,r.v3=xi;var Ti=e("Mat3",function(e){function t(t,n,i,r,o,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}z(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,o,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,p=n*h+i*_+r*f;return 0===p?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(p=1/p,e.m00=h*p,e.m01=(-u*i+r*l)*p,e.m02=(s*i-r*a)*p,e.m03=_*p,e.m04=(u*n-r*c)*p,e.m05=(-s*n+r*o)*p,e.m06=f*p,e.m07=(-l*n+i*c)*p,e.m08=(a*n-i*o)*p,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,S=n.m08;return e.m00=_*i+f*a+p*l,e.m01=_*r+f*s+p*u,e.m02=_*o+f*c+p*h,e.m03=d*i+m*a+v*l,e.m04=d*r+m*s+v*u,e.m05=d*o+m*c+v*h,e.m06=g*i+y*a+S*l,e.m07=g*r+y*s+S*u,e.m08=g*o+y*c+S*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,S=n.m10;return e.m00=_*i+f*a+p*l,e.m01=_*r+f*s+p*u,e.m02=_*o+f*c+p*h,e.m03=d*i+m*a+v*l,e.m04=d*r+m*s+v*u,e.m05=d*o+m*c+v*h,e.m06=g*i+y*a+S*l,e.m07=g*r+y*s+S*u,e.m08=g*o+y*c+S*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=_*i+f*a+l,e.m07=_*r+f*s+u,e.m08=_*o+f*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*a,e.m01=f*r+_*s,e.m02=f*o+_*c,e.m03=f*a-_*i,e.m04=f*s-_*r,e.m05=f*c-_*o,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return gi.lengthSqr(n)<Yn*Yn?(t.identity(e),e):(i=i||gi.UNIT_Y,gi.normalize(Ei,gi.cross(Ei,i,n)),gi.lengthSqr(Ei)<Yn*Yn?(t.identity(e),e):(gi.cross(Ci,n,Ei),t.set(e,Ei.x,Ei.y,Ei.z,Ci.x,Ci.y,Ci.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return e.m00=1-h-p,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-p,e.m07=f-d,e.m02=_-m,e.m05=f+d,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,T=i*l-o*s,E=r*l-o*c,C=u*d-h*p,b=u*m-_*p,A=u*v-f*p,w=h*m-_*d,R=h*v-f*d,I=_*v-f*m,P=g*I-y*R+S*w+x*A-T*b+E*C;return P?(P=1/P,e.m00=(s*I-c*R+l*w)*P,e.m01=(c*A-a*I-l*b)*P,e.m02=(a*R-s*A+l*C)*P,e.m03=(r*R-i*I-o*w)*P,e.m04=(n*I-r*A+o*b)*P,e.m05=(i*A-n*R-o*C)*P,e.m06=(d*E-m*T+v*x)*P,e.m07=(m*S-p*E-v*y)*P,e.m08=(p*T-d*S+v*g)*P,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=Yn),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,o,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=Yn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(o*t-n*r)*_,this.m03=u*_,this.m04=(c*e-n*a)*_,this.m05=(-o*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*a)*_,this.m08=(r*e-t*i)*_,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,p=e.m04,d=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*t+p*r+d*s,this.m04=f*n+p*o+d*c,this.m05=f*i+p*a+d*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*t,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-f,this.m07=_-p,this.m02=h-d,this.m05=_+p,this.m08=1-c-u,this},t}($e));Ti.IDENTITY=Object.freeze(new Ti);var Ei=new gi,Ci=new gi;Ht.fastDefine("cc.Mat3",Ti,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),r.Mat3=Ti;var bi=e("Quat",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}z(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=gi.dot(n,i);return r<-.999999?(gi.cross(Ri,gi.UNIT_X,n),Ri.length()<1e-6&&gi.cross(Ri,gi.UNIT_Y,n),gi.normalize(Ri,Ri),t.fromAxisAngle(e,Ri,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(gi.cross(Ri,n,i),e.x=Ri.x,e.y=Ri.y,e.z=Ri.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,o=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=o,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+c*i,e.y=a*r+s*i,e.z=s*r-a*i,e.w=c*r-o*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r-s*i,e.y=a*r+c*i,e.z=s*r+o*i,e.w=c*r-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+a*i,e.y=a*r-o*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(Ai,n),gi.transformQuat(Ri,i,Ai),t.fromAxisAngle(Ai,Ri,r),t.multiply(e,n,Ai),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(Ai,i,r),t.multiply(e,n,Ai),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return e.x=r*t.x+o*a,e.y=r*t.y+o*s,e.z=r*t.z+o*c,e.w=r*t.w+o*l,e},t.sqlerp=function(e,n,i,r,o,a){return t.slerp(Ai,n,o,a),t.slerp(wi,i,r,a),t.slerp(e,Ai,wi,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return Ti.set(Ii,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,Ii))},t.fromViewUp=function(e,n,i){return Ti.fromViewUp(Ii,n,i),t.normalize(e,t.fromMat3(e,Ii))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(r-c)*_,e.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+o)/f,e.z=(r+c)/f}else if(a>u){var p=2*Math.sqrt(1+a-n-u);e.w=(r-c)/p,e.x=(i+o)/p,e.y=.25*p,e.z=(s+l)/p}else{var d=2*Math.sqrt(1+u-n-a);e.w=(o-i)/d,e.x=(r+c)/d,e.y=(s+l)/d,e.z=.25*d}return e},t.fromEuler=function(e,t,n,i){t*=Pi,n*=Pi,i*=Pi;var r=Math.sin(t),o=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+o*a*c,e.y=o*a*l+r*s*c,e.z=o*s*c-r*a*l,e.w=o*s*l-r*a*c,e},t.fromAngleZ=function(e,t){return t*=Pi,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=ti(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-ti(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=ti(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=ti(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=ti(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=Yn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=Yn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}($e));bi.IDENTITY=Object.freeze(new bi);var Ai=new bi,wi=new bi,Ri=new gi,Ii=new Ti,Pi=.5*Math.PI/180;function Oi(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new bi(e,t,n,i)}Ht.fastDefine("cc.Quat",bi,{x:0,y:0,z:0,w:1}),r.Quat=bi,r.quat=Oi;var Di=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Mi=e("Mat4",function(e){function t(t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=p,v.m14=d,v.m15=m),v}z(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=p,e.m14=d,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,T=i*l-o*s,E=r*l-o*c,C=u*d-h*p,b=u*m-_*p,A=u*v-f*p,w=h*m-_*d,R=h*v-f*d,I=_*v-f*m,P=g*I-y*R+S*w+x*A-T*b+E*C;return 0===P?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(P=1/P,e.m00=(s*I-c*R+l*w)*P,e.m01=(r*R-i*I-o*w)*P,e.m02=(d*E-m*T+v*x)*P,e.m03=(_*T-h*E-f*x)*P,e.m04=(c*A-a*I-l*b)*P,e.m05=(n*I-r*A+o*b)*P,e.m06=(m*S-p*E-v*y)*P,e.m07=(u*E-_*S+f*y)*P,e.m08=(a*R-s*A+l*C)*P,e.m09=(i*A-n*R-o*C)*P,e.m10=(p*T-d*S+v*g)*P,e.m11=(h*S-u*T-f*g)*P,e.m12=(s*b-a*w-c*C)*P,e.m13=(n*w-i*b+r*C)*P,e.m14=(d*y-p*x-m*g)*P,e.m15=(u*x-h*y+_*g)*P,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,p=e.m13,d=e.m14,m=e.m15;return(t*a-n*o)*(h*m-_*d)-(t*s-i*o)*(u*m-_*p)+(t*c-r*o)*(u*d-h*p)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*d-h*f)+(i*c-r*s)*(l*p-u*f)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,p=t.m11,d=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,S=n.m01,x=n.m02,T=n.m03;return e.m00=y*i+S*s+x*h+T*d,e.m01=y*r+S*c+x*_+T*m,e.m02=y*o+S*l+x*f+T*v,e.m03=y*a+S*u+x*p+T*g,y=n.m04,S=n.m05,x=n.m06,T=n.m07,e.m04=y*i+S*s+x*h+T*d,e.m05=y*r+S*c+x*_+T*m,e.m06=y*o+S*l+x*f+T*v,e.m07=y*a+S*u+x*p+T*g,y=n.m08,S=n.m09,x=n.m10,T=n.m11,e.m08=y*i+S*s+x*h+T*d,e.m09=y*r+S*c+x*_+T*m,e.m10=y*o+S*l+x*f+T*v,e.m11=y*a+S*u+x*p+T*g,y=n.m12,S=n.m13,x=n.m14,T=n.m15,e.m12=y*i+S*s+x*h+T*d,e.m13=y*r+S*c+x*_+T*m,e.m14=y*o+S*l+x*f+T*v,e.m15=y*a+S*u+x*p+T*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,o=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*o+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*o+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*o+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*o+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,p=t.m08,d=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=p,e.m09=d,e.m10=m,e.m11=v,e.m12=a*i+u*r+p*o+t.m12,e.m13=s*i+h*r+d*o+t.m13,e.m14=c*i+_*r+m*o+t.m14,e.m15=l*i+f*r+v*o+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,o=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<Yn)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,p=t.m03,d=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,S=t.m09,x=t.m10,T=t.m11,E=r*r*u+l,C=o*r*u+a*c,b=a*r*u-o*c,A=r*o*u-a*c,w=o*o*u+l,R=a*o*u+r*c,I=r*a*u+o*c,P=o*a*u-r*c,O=a*a*u+l;return e.m00=h*E+d*C+y*b,e.m01=_*E+m*C+S*b,e.m02=f*E+v*C+x*b,e.m03=p*E+g*C+T*b,e.m04=h*A+d*w+y*R,e.m05=_*A+m*w+S*R,e.m06=f*A+v*w+x*R,e.m07=p*A+g*w+T*R,e.m08=h*I+d*P+y*O,e.m09=_*I+m*P+S*O,e.m10=f*I+v*P+x*O,e.m11=p*I+g*P+T*O,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*r+l*i,e.m05=a*r+u*i,e.m06=s*r+h*i,e.m07=c*r+_*i,e.m08=l*r-o*i,e.m09=u*r-a*i,e.m10=h*r-s*i,e.m11=_*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r-l*i,e.m01=a*r-u*i,e.m02=s*r-h*i,e.m03=c*r-_*i,e.m08=o*i+l*r,e.m09=a*i+u*r,e.m10=s*i+h*r,e.m11=c*i+_*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r+l*i,e.m01=a*r+u*i,e.m02=s*r+h*i,e.m03=c*r+_*i,e.m04=l*r-o*i,e.m05=u*r-a*i,e.m06=h*r-s*i,e.m07=_*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<Yn)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+o*s,e.m02=o*i*l-r*s,e.m03=0,e.m04=i*r*l-o*s,e.m05=r*r*l+c,e.m06=o*r*l+i*s,e.m07=0,e.m08=i*o*l+r*s,e.m09=r*o*l-i*s,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(f+d),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+d),e.m06=p+m,e.m07=0,e.m08=_+v,e.m09=p-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Li.m00=t.m00,i=Li.m01=t.m01,r=Li.m02=t.m02,o=Li.m03=t.m04,a=Li.m04=t.m05,s=Li.m05=t.m06,c=Li.m06=t.m08,l=Li.m07=t.m09,u=Li.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Ti.determinant(Li)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=gi.set(Ni,e.m00,e.m01,e.m02).length(),Li.m00=e.m00/i.x,Li.m01=e.m01/i.x,Li.m02=e.m02/i.x,i.y=gi.set(Ni,e.m04,e.m05,e.m06).length(),Li.m03=e.m04/i.y,Li.m04=e.m05/i.y,Li.m05=e.m06/i.y,i.z=gi.set(Ni,e.m08,e.m09,e.m10).length(),Li.m06=e.m08/i.z,Li.m07=e.m09/i.z,Li.m08=e.m10/i.z,Ti.determinant(Li)<0&&(i.x*=-1,Li.m00*=-1,Li.m01*=-1,Li.m02*=-1),bi.fromMat3(t,Li),gi.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=t.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,p=o*l,d=o*u,m=a*u,v=s*c,g=s*l,y=s*u,S=i.x,x=i.y,T=i.z;return e.m00=(1-(p+m))*S,e.m01=(_+y)*S,e.m02=(f-g)*S,e.m03=0,e.m04=(_-y)*x,e.m05=(1-(h+m))*x,e.m06=(d+v)*x,e.m07=0,e.m08=(f+g)*T,e.m09=(d-v)*T,e.m10=(1-(h+p))*T,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var o=t.x,a=t.y,s=t.z,c=t.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,p=o*h,d=a*u,m=a*h,v=s*h,g=c*l,y=c*u,S=c*h,x=i.x,T=i.y,E=i.z,C=r.x,b=r.y,A=r.z;return e.m00=(1-(d+v))*x,e.m01=(f+S)*x,e.m02=(p-y)*x,e.m03=0,e.m04=(f-S)*T,e.m05=(1-(_+v))*T,e.m06=(m+g)*T,e.m07=0,e.m08=(p+y)*E,e.m09=(m-g)*E,e.m10=(1-(_+d))*E,e.m11=0,e.m12=n.x+C-(e.m00*C+e.m04*b+e.m08*A),e.m13=n.y+b-(e.m01*C+e.m05*b+e.m09*A),e.m14=n.z+A-(e.m02*C+e.m06*b+e.m10*A),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return e.m00=1-h-p,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-p,e.m06=f+d,e.m07=0,e.m08=_+m,e.m09=f-d,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),c=1/(r-i),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=Di[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,p=-2*h,d=(t+n)*u,m=(r+i)*h,v=Di[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=p*v[2],e.m05=p*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=d*v[0]+m*v[2],e.m13=d*v[1]+m*v[3],e.m14=(o-s*a)*_,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),p=c*(_*=f)-l*(h*=f),d=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(p*p+d*d+m*m))-_*(d*=f),g=_*(p*=f)-u*m,y=u*d-h*p;return e.m00=p,e.m01=v,e.m02=u,e.m03=0,e.m04=d,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(p*r+d*o+m*a),e.m13=-(v*r+g*o+y*a),e.m14=-(u*r+h*o+_*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,T=i*l-o*s,E=r*l-o*c,C=u*d-h*p,b=u*m-_*p,A=u*v-f*p,w=h*m-_*d,R=h*v-f*d,I=_*v-f*m,P=g*I-y*R+S*w+x*A-T*b+E*C;return P?(P=1/P,e.m00=(s*I-c*R+l*w)*P,e.m01=(c*A-a*I-l*b)*P,e.m02=(a*R-s*A+l*C)*P,e.m03=0,e.m04=(r*R-i*I-o*w)*P,e.m05=(n*I-r*A+o*b)*P,e.m06=(i*A-n*R-o*C)*P,e.m07=0,e.m08=(d*E-m*T+v*x)*P,e.m09=(m*S-p*E-v*y)*P,e.m10=(p*T-d*S+v*g)*P,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=Yn),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=p,this.m15=d,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=Yn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15,m=e*o-t*r,v=e*a-n*r,g=e*s-i*r,y=t*a-n*o,S=t*s-i*o,x=n*s-i*a,T=c*f-l*_,E=c*p-u*_,C=c*d-h*_,b=l*p-u*f,A=l*d-h*f,w=u*d-h*p,R=m*w-v*A+g*b+y*C-S*E+x*T;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(o*w-a*A+s*b)*R,this.m01=(n*A-t*w-i*b)*R,this.m02=(f*x-p*S+d*y)*R,this.m03=(u*S-l*x-h*y)*R,this.m04=(a*C-r*w-s*E)*R,this.m05=(e*w-n*C+i*E)*R,this.m06=(p*g-_*x-d*v)*R,this.m07=(c*x-u*g+h*v)*R,this.m08=(r*A-o*C+s*T)*R,this.m09=(t*C-e*A-i*T)*R,this.m10=(_*S-f*g+d*m)*R,this.m11=(l*g-c*S-h*m)*R,this.m12=(o*E-r*b-a*T)*R,this.m13=(e*b-t*E+n*T)*R,this.m14=(f*v-_*y-p*m)*R,this.m15=(c*y-l*v+u*m)*R,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15;return(e*o-t*r)*(u*d-h*p)-(e*a-n*r)*(l*d-h*f)+(e*s-i*r)*(l*p-u*f)+(t*a-n*o)*(c*d-h*_)-(t*s-i*o)*(c*p-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,p=this.m13,d=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,S=e.m03;return this.m00=v*t+g*o+y*l+S*f,this.m01=v*n+g*a+y*u+S*p,this.m02=v*i+g*s+y*h+S*d,this.m03=v*r+g*c+y*_+S*m,v=e.m04,g=e.m05,y=e.m06,S=e.m07,this.m04=v*t+g*o+y*l+S*f,this.m05=v*n+g*a+y*u+S*p,this.m06=v*i+g*s+y*h+S*d,this.m07=v*r+g*c+y*_+S*m,v=e.m08,g=e.m09,y=e.m10,S=e.m11,this.m08=v*t+g*o+y*l+S*f,this.m09=v*n+g*a+y*u+S*p,this.m10=v*i+g*s+y*h+S*d,this.m11=v*r+g*c+y*_+S*m,v=e.m12,g=e.m13,y=e.m14,S=e.m15,this.m12=v*t+g*o+y*l+S*f,this.m13=v*n+g*a+y*u+S*p,this.m14=v*i+g*s+y*h+S*d,this.m15=v*r+g*c+y*_+S*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<Yn)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,p=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,S=this.m11,x=n*n*c+s,T=i*n*c+r*a,E=r*n*c-i*a,C=n*i*c-r*a,b=i*i*c+s,A=r*i*c+n*a,w=n*r*c+i*a,R=i*r*c-n*a,I=r*r*c+s;return this.m00=l*x+f*T+v*E,this.m01=u*x+p*T+g*E,this.m02=h*x+d*T+y*E,this.m03=_*x+m*T+S*E,this.m04=l*C+f*b+v*A,this.m05=u*C+p*b+g*A,this.m06=h*C+d*b+y*A,this.m07=_*C+m*b+S*A,this.m08=l*w+f*R+v*I,this.m09=u*w+p*R+g*I,this.m10=h*w+d*R+y*I,this.m11=_*w+m*R+S*I,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Li.m00=this.m00,n=Li.m01=this.m01,i=Li.m02=this.m02,r=Li.m03=this.m04,o=Li.m04=this.m05,a=Li.m05=this.m06,s=Li.m06=this.m08,c=Li.m07=this.m09,l=Li.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),Ti.determinant(Li)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l,y=n.x,S=n.y,x=n.z;return this.m00=(1-(f+d))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*S,this.m05=(1-(u+d))*S,this.m06=(p+m)*S,this.m07=0,this.m08=(_+v)*x,this.m09=(p-m)*x,this.m10=(1-(u+f))*x,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+p,this.m07=0,this.m08=h+d,this.m09=_-p,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}($e));Mi.IDENTITY=Object.freeze(new Mi);var Ni=new gi,Li=new Ti;function Bi(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return new Mi(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d)}Ht.fastDefine("cc.Mat4",Mi,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),r.Mat4=Mi,r.mat4=Bi;var Fi=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}z(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<Yn?e.x=0:e.x=1/n,Math.abs(i)<Yn?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof gi?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,o=t.y;return e.x=r+i*(n.x-r),e.y=o+i*(n.y-o),e},t.random=function(e,t){t=t||1;var n=2*ni()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=Yn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(zi,e),t.normalize(Ui,n);var i=t.dot(zi,Ui);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=Yn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=Yn),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=Zn(this.x,e.x,t.x),this.y=Zn(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=Zn(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}($e));Fi.ZERO=Object.freeze(new Fi(0,0)),Fi.ONE=Object.freeze(new Fi(1,1)),Fi.NEG_ONE=Object.freeze(new Fi(-1,-1)),Fi.UNIT_X=Object.freeze(new Fi(1,0)),Fi.UNIT_Y=Object.freeze(new Fi(0,1));var zi=new Fi,Ui=new Fi;function ki(e,t){return new Fi(e,t)}Ht.fastDefine("cc.Vec2",Fi,{x:0,y:0}),r.Vec2=Fi,r.v2=ki;var Gi=e("Vec4",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=r||0),o}z(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return n*n+i*i+r*r+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w;return Math.abs(n)<Yn?e.x=0:e.x=1/n,Math.abs(i)<Yn?e.y=0:e.y=1/i,Math.abs(r)<Yn?e.z=0:e.z=1/r,Math.abs(o)<Yn?e.w=0:e.w=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a,e.w=o*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*ni()*Math.PI,i=2*ni()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,e.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,e.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return e.x=u*l+f*-a+h*-c-_*-s,e.y=h*l+f*-s+_*-a-u*-c,e.z=_*l+f*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=Yn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=Yn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=Yn),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=Zn(this.x,e.x,t.x),this.y=Zn(this.y,e.y,t.y),this.z=Zn(this.z,e.z,t.z),this.w=Zn(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}($e));function Hi(e,t,n,i){return new Gi(e,t,n,i)}Gi.ZERO=Object.freeze(new Gi(0,0,0,0)),Gi.ONE=Object.freeze(new Gi(1,1,1,1)),Gi.NEG_ONE=Object.freeze(new Gi(-1,-1,-1,-1)),Ht.fastDefine("cc.Vec4",Gi,{x:0,y:0,z:0,w:0}),r.Vec4=Gi,r.v4=Hi,Fn(Fi,"Vec2",[{name:"sub",newName:"subtract",target:Fi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Fi,targetName:"Vec2"},{name:"div",newName:"divide",target:Fi,targetName:"Vec2"},{name:"dist",newName:"distance",target:Fi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Fi,targetName:"Vec2"},{name:"mag",newName:"len",target:Fi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Fi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Fi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Fi,targetName:"Vec2"}]),Fn(Fi.prototype,"Vec2",[{name:"mag",newName:"length",target:Fi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Fi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Fi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Fi.prototype,targetName:"Vec2"}]),Fn(gi,"Vec3",[{name:"sub",newName:"subtract",target:gi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:gi,targetName:"Vec3"},{name:"div",newName:"divide",target:gi,targetName:"Vec3"},{name:"dist",newName:"distance",target:gi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:gi,targetName:"Vec3"},{name:"mag",newName:"len",target:gi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:gi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:gi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:gi,targetName:"Vec3"}]),Fn(gi.prototype,"Vec3",[{name:"mag",newName:"length",target:gi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:gi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:gi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:gi.prototype,targetName:"Vec3"}]),Fn(Gi,"Vec4",[{name:"sub",newName:"subtract",target:Gi,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Gi,targetName:"Vec4"},{name:"div",newName:"divide",target:Gi,targetName:"Vec4"},{name:"dist",newName:"distance",target:Gi,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Gi,targetName:"Vec4"},{name:"mag",newName:"len",target:Gi,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Gi,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Gi,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Gi,targetName:"Vec4"}]),Fn(Gi.prototype,"Vec4",[{name:"mag",newName:"length",target:Gi.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Gi.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Gi.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Gi.prototype,targetName:"Vec4"}]),Fn(bi,"Quat",[{name:"mag",newName:"len",target:bi,targetName:"Quat"},{name:"mul",newName:"multiply",target:bi,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:bi,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:bi,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:bi,targetName:"Quat"}]),Fn(bi.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:bi.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:bi.prototype,targetName:"Quat"}]),Fn(mi,"Color",[{name:"sub",newName:"subtract",target:mi,targetName:"Color"},{name:"mul",newName:"multiply",target:mi,targetName:"Color"},{name:"div",newName:"divide",target:mi,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:mi,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[1].toString(16);return r.Color.fromHEX(t[0],i)}}]),Fn(Ti,"Mat3",[{name:"sub",newName:"subtract",target:Ti,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Ti,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Ti,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Ti,targetName:"Mat3"}]),Fn(Ti.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Ti.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Ti.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Ti.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Ti.prototype,targetName:"Mat3"}]),Fn(Mi,"Mat4",[{name:"sub",newName:"subtract",target:Mi,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Mi,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Mi,targetName:"Mat4"}]),Fn(Mi.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Mi.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Mi.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Mi.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Mi.prototype,targetName:"Mat4"}]);var Vi=e("AffineTransform",function(){function e(e,t,n,i,r,o){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=o}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=o*n.a+a*n.c,e.d=o*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,o;void 0===i?(i=n,r=t.x,o=t.y):(r=t,o=n),e.x=i.a*r+i.c*o+i.tx,e.y=i.b*r+i.d*o+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,o=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);e.x=f,e.y=d,e.width=p-f,e.height=m-d},e.transformObb=function(e,t,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());r.AffineTransform=Vi;var ji=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}z(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},B(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}($e));function Wi(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new ji(e,t)}ji.ZERO=Object.freeze(new ji(0,0)),ji.ONE=Object.freeze(new ji(1,1)),Ht.fastDefine("cc.Size",ji,{width:0,height:0}),r.size=Wi,r.Size=ji;var qi=e("Rect",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.y=t.y,o.width=t.width,o.height=t.height,o.x=t.x):(o.x=t||0,o.y=n||0,o.width=i||0,o.height=r||0),o}z(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),o=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=o-i,e.height=a-r,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y,a=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=o+(n.y-o)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,o=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,o=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+o,s+l)-e.x,e.height=Math.max(r+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,o=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,_=e.m01*i+e.m05*r+e.m13,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=d,this.width=p-f,this.height=m-d,this},n.transformMat4ToPoints=function(e,t,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*o+e.m04*c+e.m12,n.y=e.m01*o+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},B(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Fi(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new Fi(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new ji(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}($e));function Xi(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new qi(e,t,n,i)}Ht.fastDefine("cc.Rect",qi,{x:0,y:0,width:0,height:0}),r.Rect=qi,r.rect=Xi;var Yi=e("MATH_FLOAT_ARRAY",Float64Array),Ki=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t.createFloatArray=function(e){return new Yi(e)},B(t,[{key:"array",get:function(){return this._array}}]),t}($e)),Qi=Object.freeze({__proto__:null,bits:Bn,Vec2:Fi,v2:ki,Vec3:gi,v3:xi,Vec4:Gi,v4:Hi,Quat:bi,quat:Oi,Mat3:Ti,Mat4:Mi,mat4:Bi,AffineTransform:Vi,Size:ji,size:Wi,Rect:qi,rect:Xi,Color:mi,color:vi,EPSILON:Yn,equals:Kn,approx:Qn,clamp:Zn,clamp01:Jn,lerp:$n,toRadian:ei,toDegree:ti,random:ni,randomRange:ii,randomRangeInt:ri,pseudoRandom:oi,pseudoRandomRange:ai,pseudoRandomRangeInt:si,nextPow2:ci,repeat:li,pingPong:ui,inverseLerp:hi,absMaxComponent:_i,absMax:fi,enumerableProps:pi,MATH_FLOAT_ARRAY:Yi,MathBase:Ki});e("math",Qi);var Zi=function(){function e(){this._groundAlbedoHDR=new Gi(.2,.2,.2,1),this._skyColorHDR=new Gi(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Gi(.2,.2,.2,1),this._skyColorLDR=new Gi(.2,.5,.8,1),this._skyIllumLDR=0,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.x=e.groundAlbedoHDR.x,this._groundAlbedoHDR.y=e.groundAlbedoHDR.y,this._groundAlbedoHDR.z=e.groundAlbedoHDR.z,this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.x=e.groundAlbedoLDR.x,this._groundAlbedoLDR.y=e.groundAlbedoLDR.y,this._groundAlbedoLDR.z=e.groundAlbedoLDR.z,this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?(this._skyColorHDR.x=e.x,this._skyColorHDR.y=e.y,this._skyColorHDR.z=e.z):(this._skyColorLDR.x=e.x,this._skyColorLDR.y=e.y,this._skyColorLDR.z=e.z)}},{key:"skyIllum",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?(this._groundAlbedoHDR.x=e.x,this._groundAlbedoHDR.y=e.y,this._groundAlbedoHDR.z=e.z):(this._groundAlbedoLDR.x=e.x,this._groundAlbedoLDR.y=e.y,this._groundAlbedoLDR.z=e.z)}},{key:"native",get:function(){return this._nativeObj}}]),e}();Zi.SUN_ILLUM=65e3,Zi.SKY_ILLUM=2e4,r.Ambient=Zi;var Ji=function(){function e(){this._enabled=!1,this._minPos=new gi(0,0,0),this._maxPos=new gi(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),$i=new gi,er=new gi,tr=new gi,nr=new gi,ir=new gi,rr=new gi,or=new Array(3),ar=new Array(3);function sr(e,t){return gi.dot(t.n,e)-t.d}function cr(e,t,n){return gi.copy(e,t),gi.subtract(ir,n.center,n.halfExtents),gi.add(rr,n.center,n.halfExtents),e.x=e.x<ir.x?ir.x:e.x,e.y=e.y<ir.y?ir.y:e.y,e.z=e.z<ir.z?ir.z:e.z,e.x=e.x>rr.x?rr.x:e.x,e.y=e.y>rr.y?rr.y:e.y,e.z=e.z>rr.z?rr.z:e.z,e}function lr(e,t,n){gi.set($i,n.orientation.m00,n.orientation.m01,n.orientation.m02),gi.set(er,n.orientation.m03,n.orientation.m04,n.orientation.m05),gi.set(tr,n.orientation.m06,n.orientation.m07,n.orientation.m08),or[0]=$i,or[1]=er,or[2]=tr,ar[0]=n.halfExtents.x,ar[1]=n.halfExtents.y,ar[2]=n.halfExtents.z,gi.subtract(nr,t,n.center),gi.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=gi.dot(nr,or[i]);r>ar[i]&&(r=ar[i]),r<-ar[i]&&(r=-ar[i]),e.x+=r*or[i].x,e.y+=r*or[i].y,e.z+=r*or[i].z}return e}var ur=Object.freeze({__proto__:null,point_plane:sr,pt_point_plane:function(e,t,n){var i=sr(t,n);return gi.subtract(e,t,gi.multiplyScalar(e,n.n,i))},pt_point_aabb:cr,pt_point_obb:lr,pt_point_line:function(e,t,n,i){gi.subtract($i,n,i);var r=$i,o=gi.lengthSqr(r);if(0==o)gi.copy(e,n);else{gi.subtract($i,t,n);var a=gi.dot($i,r)/o;a<0?gi.copy(e,n):a>1?gi.copy(e,i):gi.scaleAndAdd(e,n,r,a)}}}),hr={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},_r=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=hr.SHAPE_LINE,this.s=new gi(e,t,n),this.e=new gi(i,r,o)}return e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return gi.copy(e.s,t.s),gi.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return gi.copy(e.s,t),gi.copy(e.e,n),e},e.set=function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e},e.len=function(e){return gi.distance(e.s,e.e)},e.prototype.length=function(){return gi.distance(this.s,this.e)},B(e,[{key:"type",get:function(){return this._type}}]),e}(),fr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=hr.SHAPE_RAY,this.o=new gi(e,t,n),this.d=new gi(i,r,o)}return e.create=function(t,n,i,r,o,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return gi.copy(e.o,t.o),gi.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return gi.copy(e.o,t),gi.normalize(e.d,gi.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e},e.prototype.computeHit=function(e,t){gi.normalize(e,this.d),gi.scaleAndAdd(e,this.o,e,t)},B(e,[{key:"type",get:function(){return this._type}}]),e}(),pr=new gi,dr=new gi,mr=new gi,vr=new gi;function gr(e){return Math.max(Math.max(e.x,e.y),e.z)}var yr,Sr,xr,Tr,Er,Cr,br,Ar,wr,Rr,Ir,Pr,Or,Dr,Mr,Nr,Lr,Br,Fr,zr,Ur,kr,Gr,Hr,Vr,jr,Wr,qr,Xr,Yr,Kr,Qr,Zr,Jr,$r,eo,to,no,io,ro,oo,ao=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new gi(0,0,0),this._radius=0,this._type=void 0,this._type=hr.SHAPE_SPHERE,this._center=new gi(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return gi.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return gi.multiplyScalar(e.center,gi.add(pr,t,n),.5),e.radius=.5*gi.subtract(pr,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){gi.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),gi.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){gi.transformMat4(r.center,this.center,e),r.radius=this.radius*gr(i)},t.translateAndRotate=function(e,t,n){gi.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*gr(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),gi.subtract(dr,e,this.center);var t=dr.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,gi.multiplyScalar(dr,dr,n/t),gi.add(this.center,this.center,dr)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(mr,vr),this.mergePoint(mr),this.mergePoint(vr)},B(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),so=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=hr.SHAPE_TRIANGLE,this.a=new gi(e,t,n),this.b=new gi(i,r,o),this.c=new gi(a,s,c)}return e.create=function(t,n,i,r,o,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,o,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return gi.copy(e.a,t.a),gi.copy(e.b,t.b),gi.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return gi.copy(e.a,t),gi.copy(e.b,n),gi.copy(e.c,i),e},e.set=function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},B(e,[{key:"type",get:function(){return this._type}}]),e}(),co=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(yr||(yr={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(Sr||(Sr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(xr||(xr={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(Tr||(Tr={})),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_SRGB=7]="FORMAT_SRGB",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.FORMAT_RGB8=13]="FORMAT_RGB8",e[e.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=17]="BLEND_MINMAX",e[e.COMPUTE_SHADER=18]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=20]="COUNT"}(Er||(Er={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(Cr||(Cr={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(br||(br={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(Ar||(Ar={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(wr||(wr={})),function(e){e[e.NONE=0]="NONE"}(Rr||(Rr={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(Ir||(Ir={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Pr||(Pr={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Or||(Or={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Dr||(Dr={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Mr||(Mr={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Nr||(Nr={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Lr||(Lr={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Br||(Br={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Fr||(Fr={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(zr||(zr={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Ur||(Ur={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(kr||(kr={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Gr||(Gr={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Hr||(Hr={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Vr||(Vr={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(jr||(jr={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Wr||(Wr={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(qr||(qr={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Xr||(Xr={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Yr||(Yr={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Kr||(Kr={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Qr||(Qr={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Zr||(Zr={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Jr||(Jr={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}($r||($r={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(eo||(eo={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(to||(to={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(no||(no={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(io||(io={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(ro||(ro={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(oo||(oo={}));var lo,uo=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),ho=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,S,x){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=new uo),void 0===v&&(v=new uo),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===S&&(S=1),void 0===x&&(x=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=p,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=S,this.clipSpaceSignY=x}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),_o=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),fo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),po=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),mo=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),vo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),go=function(){function e(e,t,n,i,r){void 0===e&&(e=new mo),void 0===t&&(t=new _o),void 0===n&&(n=new mo),void 0===i&&(i=new _o),void 0===r&&(r=new po),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),yo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=new mo),void 0===t&&(t=new _o),void 0===n&&(n=new po),void 0===i&&(i=new mo),void 0===r&&(r=new _o),void 0===o&&(o=new po),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),So=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new _o),void 0===i&&(i=new po),void 0===r&&(r=new mo),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),xo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),To=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),Eo=function(){function e(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=0),this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=n}return e.prototype.copy=function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this},e}(),Co=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=Lr.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),bo=function(){function e(e){void 0===e&&(e=new Eo),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),Ao=function(){function e(e,t,n,i,r){void 0===e&&(e=wr.NONE),void 0===t&&(t=Pr.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=Rr.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),wo=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),Ro=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),Io=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),Po=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return co(this.drawInfos,e.drawInfos,Ro),this},e}(),Oo=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=Or.TEX2D),void 0===t&&(t=Dr.NONE),void 0===n&&(n=Cr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=Mr.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Nr.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),Do=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=null),void 0===t&&(t=Or.TEX2D),void 0===n&&(n=Cr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),Mo=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=Br.LINEAR),void 0===t&&(t=Br.LINEAR),void 0===n&&(n=Br.NONE),void 0===i&&(i=Fr.WRAP),void 0===r&&(r=Fr.WRAP),void 0===o&&(o=Fr.WRAP),void 0===a&&(a=0),void 0===s&&(s=zr.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),No=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=Ar.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Lo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,co(this.members,e.members,No),this.count=e.count,this},e}(),Bo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Ar.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Fo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),zo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Ar.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Uo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Ar.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=Ir.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),ko=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=Ir.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Go=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Ho=function(){function e(e,t){void 0===e&&(e=Vr.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),Vo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=""),void 0===t&&(t=Cr.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),jo=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,co(this.stages,e.stages,Ho),co(this.attributes,e.attributes,Vo),co(this.blocks,e.blocks,Lo),co(this.buffers,e.buffers,ko),co(this.samplerTextures,e.samplerTextures,Bo),co(this.samplers,e.samplers,Fo),co(this.textures,e.textures,zo),co(this.images,e.images,Uo),co(this.subpassInputs,e.subpassInputs,Go),this},e}(),Wo=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return co(this.attributes,e.attributes,Vo),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),qo=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=Cr.UNKNOWN),void 0===t&&(t=Nr.ONE),void 0===n&&(n=jr.CLEAR),void 0===i&&(i=Wr.STORE),void 0===r&&(r=[]),void 0===o&&(o=[qr.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Xo=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=Cr.UNKNOWN),void 0===t&&(t=Nr.ONE),void 0===n&&(n=jr.CLEAR),void 0===i&&(i=Wr.STORE),void 0===r&&(r=jr.CLEAR),void 0===o&&(o=Wr.STORE),void 0===a&&(a=[]),void 0===s&&(s=[qr.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Yo=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Xr.NONE),void 0===s&&(s=Xr.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),Ko=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=e,this.dstSubpass=t,this.srcAccesses=n,this.dstAccesses=i}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this},e}(),Qo=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Xo),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return co(this.colorAttachments,e.colorAttachments,qo),this.depthStencilAttachment.copy(e.depthStencilAttachment),co(this.subpasses,e.subpasses,Yo),co(this.dependencies,e.dependencies,Ko),this},e}(),Zo=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this},e}(),Jo=function(){function e(e,t,n,i,r){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),$o=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),ea=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=to.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Vr.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),ta=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return co(this.bindings,e.bindings,ea),this},e}(),na=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),ia=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),ra=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return co(this.attributes,e.attributes,Vo),this},e}(),oa=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=ro.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),aa=function(){function e(e){void 0===e&&(e=no.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),sa=function(){function e(e,t,n){void 0===e&&(e=io.OCCLUSION),void 0===t&&(t=65536),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),ca=function(e,t,n,i,r,o,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=br.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},la=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),ua=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),ha=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=new xo),void 0===t&&(t=new fo),void 0===n&&(n=new To),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new ua),void 0===u&&(u=new ua),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),_a=function(){function e(t){this._objectType=yr.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=t,this._objectID=e._idTable[yr.UNKNOWN]++,this._typedID=e._idTable[t]++}return B(e,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),e}();_a._idTable=Array(yr.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(lo||(lo={}));var fa=Object.freeze([new ca("UNKNOWN",0,0,br.NONE,!1,!1,!1,!1),new ca("A8",1,1,br.UNORM,!0,!1,!1,!1),new ca("L8",1,1,br.UNORM,!1,!1,!1,!1),new ca("LA8",1,2,br.UNORM,!0,!1,!1,!1),new ca("R8",1,1,br.UNORM,!1,!1,!1,!1),new ca("R8SN",1,1,br.SNORM,!1,!1,!1,!1),new ca("R8UI",1,1,br.UINT,!1,!1,!1,!1),new ca("R8I",1,1,br.INT,!1,!1,!1,!1),new ca("R16F",2,1,br.FLOAT,!1,!1,!1,!1),new ca("R16UI",2,1,br.UINT,!1,!1,!1,!1),new ca("R16I",2,1,br.INT,!1,!1,!1,!1),new ca("R32F",4,1,br.FLOAT,!1,!1,!1,!1),new ca("R32UI",4,1,br.UINT,!1,!1,!1,!1),new ca("R32I",4,1,br.INT,!1,!1,!1,!1),new ca("RG8",2,2,br.UNORM,!1,!1,!1,!1),new ca("RG8SN",2,2,br.SNORM,!1,!1,!1,!1),new ca("RG8UI",2,2,br.UINT,!1,!1,!1,!1),new ca("RG8I",2,2,br.INT,!1,!1,!1,!1),new ca("RG16F",4,2,br.FLOAT,!1,!1,!1,!1),new ca("RG16UI",4,2,br.UINT,!1,!1,!1,!1),new ca("RG16I",4,2,br.INT,!1,!1,!1,!1),new ca("RG32F",8,2,br.FLOAT,!1,!1,!1,!1),new ca("RG32UI",8,2,br.UINT,!1,!1,!1,!1),new ca("RG32I",8,2,br.INT,!1,!1,!1,!1),new ca("RGB8",3,3,br.UNORM,!1,!1,!1,!1),new ca("SRGB8",3,3,br.UNORM,!1,!1,!1,!1),new ca("RGB8SN",3,3,br.SNORM,!1,!1,!1,!1),new ca("RGB8UI",3,3,br.UINT,!1,!1,!1,!1),new ca("RGB8I",3,3,br.INT,!1,!1,!1,!1),new ca("RGB16F",6,3,br.FLOAT,!1,!1,!1,!1),new ca("RGB16UI",6,3,br.UINT,!1,!1,!1,!1),new ca("RGB16I",6,3,br.INT,!1,!1,!1,!1),new ca("RGB32F",12,3,br.FLOAT,!1,!1,!1,!1),new ca("RGB32UI",12,3,br.UINT,!1,!1,!1,!1),new ca("RGB32I",12,3,br.INT,!1,!1,!1,!1),new ca("RGBA8",4,4,br.UNORM,!0,!1,!1,!1),new ca("BGRA8",4,4,br.UNORM,!0,!1,!1,!1),new ca("SRGB8_A8",4,4,br.UNORM,!0,!1,!1,!1),new ca("RGBA8SN",4,4,br.SNORM,!0,!1,!1,!1),new ca("RGBA8UI",4,4,br.UINT,!0,!1,!1,!1),new ca("RGBA8I",4,4,br.INT,!0,!1,!1,!1),new ca("RGBA16F",8,4,br.FLOAT,!0,!1,!1,!1),new ca("RGBA16UI",8,4,br.UINT,!0,!1,!1,!1),new ca("RGBA16I",8,4,br.INT,!0,!1,!1,!1),new ca("RGBA32F",16,4,br.FLOAT,!0,!1,!1,!1),new ca("RGBA32UI",16,4,br.UINT,!0,!1,!1,!1),new ca("RGBA32I",16,4,br.INT,!0,!1,!1,!1),new ca("R5G6B5",2,3,br.UNORM,!1,!1,!1,!1),new ca("R11G11B10F",4,3,br.FLOAT,!1,!1,!1,!1),new ca("RGB5A1",2,4,br.UNORM,!0,!1,!1,!1),new ca("RGBA4",2,4,br.UNORM,!0,!1,!1,!1),new ca("RGB10A2",2,4,br.UNORM,!0,!1,!1,!1),new ca("RGB10A2UI",2,4,br.UINT,!0,!1,!1,!1),new ca("RGB9E5",2,4,br.FLOAT,!0,!1,!1,!1),new ca("DEPTH",4,1,br.FLOAT,!1,!0,!1,!1),new ca("DEPTH_STENCIL",5,2,br.FLOAT,!1,!0,!0,!1),new ca("BC1",1,3,br.UNORM,!1,!1,!1,!0),new ca("BC1_ALPHA",1,4,br.UNORM,!0,!1,!1,!0),new ca("BC1_SRGB",1,3,br.UNORM,!1,!1,!1,!0),new ca("BC1_SRGB_ALPHA",1,4,br.UNORM,!0,!1,!1,!0),new ca("BC2",1,4,br.UNORM,!0,!1,!1,!0),new ca("BC2_SRGB",1,4,br.UNORM,!0,!1,!1,!0),new ca("BC3",1,4,br.UNORM,!0,!1,!1,!0),new ca("BC3_SRGB",1,4,br.UNORM,!0,!1,!1,!0),new ca("BC4",1,1,br.UNORM,!1,!1,!1,!0),new ca("BC4_SNORM",1,1,br.SNORM,!1,!1,!1,!0),new ca("BC5",1,2,br.UNORM,!1,!1,!1,!0),new ca("BC5_SNORM",1,2,br.SNORM,!1,!1,!1,!0),new ca("BC6H_UF16",1,3,br.UFLOAT,!1,!1,!1,!0),new ca("BC6H_SF16",1,3,br.FLOAT,!1,!1,!1,!0),new ca("BC7",1,4,br.UNORM,!0,!1,!1,!0),new ca("BC7_SRGB",1,4,br.UNORM,!0,!1,!1,!0),new ca("ETC_RGB8",1,3,br.UNORM,!1,!1,!1,!0),new ca("ETC2_RGB8",1,3,br.UNORM,!1,!1,!1,!0),new ca("ETC2_SRGB8",1,3,br.UNORM,!1,!1,!1,!0),new ca("ETC2_RGB8_A1",1,4,br.UNORM,!0,!1,!1,!0),new ca("ETC2_SRGB8_A1",1,4,br.UNORM,!0,!1,!1,!0),new ca("ETC2_RGBA8",2,4,br.UNORM,!0,!1,!1,!0),new ca("ETC2_SRGB8_A8",2,4,br.UNORM,!0,!1,!1,!0),new ca("EAC_R11",1,1,br.UNORM,!1,!1,!1,!0),new ca("EAC_R11SN",1,1,br.SNORM,!1,!1,!1,!0),new ca("EAC_RG11",2,2,br.UNORM,!1,!1,!1,!0),new ca("EAC_RG11SN",2,2,br.SNORM,!1,!1,!1,!0),new ca("PVRTC_RGB2",2,3,br.UNORM,!1,!1,!1,!0),new ca("PVRTC_RGBA2",2,4,br.UNORM,!0,!1,!1,!0),new ca("PVRTC_RGB4",2,3,br.UNORM,!1,!1,!1,!0),new ca("PVRTC_RGBA4",2,4,br.UNORM,!0,!1,!1,!0),new ca("PVRTC2_2BPP",2,4,br.UNORM,!0,!1,!1,!0),new ca("PVRTC2_4BPP",2,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_4x4",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_5x4",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_5x5",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_6x5",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_6x6",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_8x5",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_8x6",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_8x8",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_10x5",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_10x6",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_10x8",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_10x10",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_12x10",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_RGBA_12x12",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_4x4",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_5x4",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_5x5",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_6x5",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_6x6",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_8x5",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_8x6",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_8x8",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_10x5",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_10x6",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_10x8",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_10x10",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_12x10",1,4,br.UNORM,!0,!1,!1,!0),new ca("ASTC_SRGBA_12x12",1,4,br.UNORM,!0,!1,!1,!0)]),pa=to.UNIFORM_BUFFER|to.DYNAMIC_UNIFORM_BUFFER|to.STORAGE_BUFFER|to.DYNAMIC_STORAGE_BUFFER,da=to.SAMPLER_TEXTURE|to.SAMPLER|to.TEXTURE|to.STORAGE_IMAGE|to.INPUT_ATTACHMENT,ma=to.DYNAMIC_STORAGE_BUFFER|to.DYNAMIC_UNIFORM_BUFFER,va=28;function ga(e){return e>0&&0==(e&e-1)}function ya(e,t,n,i){if(!fa[e].isCompressed)return t*n*i*fa[e].size;switch(e){case Cr.BC1:case Cr.BC1_ALPHA:case Cr.BC1_SRGB:case Cr.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Cr.BC2:case Cr.BC2_SRGB:case Cr.BC3:case Cr.BC3_SRGB:case Cr.BC4:case Cr.BC4_SNORM:case Cr.BC6H_SF16:case Cr.BC6H_UF16:case Cr.BC7:case Cr.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Cr.BC5:case Cr.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case Cr.ETC_RGB8:case Cr.ETC2_RGB8:case Cr.ETC2_SRGB8:case Cr.ETC2_RGB8_A1:case Cr.EAC_R11:case Cr.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Cr.ETC2_RGBA8:case Cr.ETC2_SRGB8_A1:case Cr.EAC_RG11:case Cr.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Cr.PVRTC_RGB2:case Cr.PVRTC_RGBA2:case Cr.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case Cr.PVRTC_RGB4:case Cr.PVRTC_RGBA4:case Cr.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case Cr.ASTC_RGBA_4X4:case Cr.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Cr.ASTC_RGBA_5X4:case Cr.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case Cr.ASTC_RGBA_5X5:case Cr.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case Cr.ASTC_RGBA_6X5:case Cr.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case Cr.ASTC_RGBA_6X6:case Cr.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case Cr.ASTC_RGBA_8X5:case Cr.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case Cr.ASTC_RGBA_8X6:case Cr.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case Cr.ASTC_RGBA_8X8:case Cr.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case Cr.ASTC_RGBA_10X5:case Cr.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case Cr.ASTC_RGBA_10X6:case Cr.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case Cr.ASTC_RGBA_10X8:case Cr.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case Cr.ASTC_RGBA_10X10:case Cr.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case Cr.ASTC_RGBA_12X10:case Cr.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case Cr.ASTC_RGBA_12X12:case Cr.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function Sa(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=ya(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var xa=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Ta(e){return xa[e]||0}function Ea(e){var t=e.size/e.count;switch(e.type){case br.UNORM:case br.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case br.SNORM:case br.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case br.FLOAT:return Float32Array}return Float32Array}var Ca=Object.freeze({__proto__:null,get ObjectType(){return yr},get Status(){return Sr},get API(){return xr},get SurfaceTransform(){return Tr},get Feature(){return Er},get Format(){return Cr},get FormatType(){return br},get Type(){return Ar},get BufferUsageBit(){return wr},get BufferFlagBit(){return Rr},get MemoryAccessBit(){return Ir},get MemoryUsageBit(){return Pr},get TextureType(){return Or},get TextureUsageBit(){return Dr},get TextureFlagBit(){return Mr},get SampleCount(){return Nr},get VsyncMode(){return Lr},get Filter(){return Br},get Address(){return Fr},get ComparisonFunc(){return zr},get StencilOp(){return Ur},get BlendFactor(){return kr},get BlendOp(){return Gr},get ColorMask(){return Hr},get ShaderStageFlagBit(){return Vr},get LoadOp(){return jr},get StoreOp(){return Wr},get AccessType(){return qr},get ResolveMode(){return Xr},get PipelineBindPoint(){return Yr},get PrimitiveMode(){return Kr},get PolygonMode(){return Qr},get ShadeModel(){return Zr},get CullMode(){return Jr},get DynamicStateFlagBit(){return $r},get StencilFace(){return eo},get DescriptorType(){return to},get QueueType(){return no},get QueryType(){return io},get CommandBufferType(){return ro},get ClearFlagBit(){return oo},Size:uo,DeviceCaps:ho,Offset:_o,Rect:fo,Extent:po,TextureSubresLayers:mo,TextureSubresRange:vo,TextureCopy:go,TextureBlit:yo,BufferTextureCopy:So,Viewport:xo,Color:To,BindingMappingInfo:Eo,SwapchainInfo:Co,DeviceInfo:bo,BufferInfo:Ao,BufferViewInfo:wo,DrawInfo:Ro,DispatchInfo:Io,IndirectBuffer:Po,TextureInfo:Oo,TextureViewInfo:Do,SamplerInfo:Mo,Uniform:No,UniformBlock:Lo,UniformSamplerTexture:Bo,UniformSampler:Fo,UniformTexture:zo,UniformStorageImage:Uo,UniformStorageBuffer:ko,UniformInputAttachment:Go,ShaderStage:Ho,Attribute:Vo,ShaderInfo:jo,InputAssemblerInfo:Wo,ColorAttachment:qo,DepthStencilAttachment:Xo,SubpassInfo:Yo,SubpassDependency:Ko,RenderPassInfo:Qo,GlobalBarrierInfo:Zo,TextureBarrierInfo:Jo,FramebufferInfo:$o,DescriptorSetLayoutBinding:ea,DescriptorSetLayoutInfo:ta,DescriptorSetInfo:na,PipelineLayoutInfo:ia,InputState:ra,CommandBufferInfo:oa,QueueInfo:aa,QueryPoolInfo:sa,FormatInfo:ca,MemoryStatus:la,DynamicStencilStates:ua,DynamicStates:ha,GFXObject:_a,get AttributeName(){return lo},FormatInfos:fa,DESCRIPTOR_BUFFER_TYPE:pa,DESCRIPTOR_SAMPLER_TYPE:da,DESCRIPTOR_DYNAMIC_TYPE:ma,DRAW_INFO_SIZE:va,IsPowerOf2:ga,FormatSize:ya,FormatSurfaceSize:Sa,GetTypeSize:Ta,getTypedArrayConstructor:Ea}),ba=function(e){function t(){var t;return(t=e.call(this,yr.BUFFER)||this)._usage=wr.NONE,t._memUsage=Pr.NONE,t._size=0,t._stride=1,t._count=0,t._flags=Rr.NONE,t._isBufferView=!1,t}return z(t,e),B(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(_a),Aa=function(e){function t(){var t;return(t=e.call(this,yr.COMMAND_BUFFER)||this)._queue=null,t._type=ro.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return z(t,e),B(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(_a),wa=function(){function e(){this._gfxAPI=xr.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(Er.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new la,this._caps=new ho,this._bindingMappingInfo=new Eo,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return e.prototype.hasFeature=function(e){return this._features[e]},B(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();wa.canvas=void 0;var Ra=function(e){function t(){var t;return(t=e.call(this,yr.SWAPCHAIN)||this)._transform=Tr.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return z(t,e),B(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}(_a),Ia=function(e){function t(){var t;return(t=e.call(this,yr.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return z(t,e),B(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(_a),Pa=String.prototype.charCodeAt;function Oa(e){return this[e]}function Da(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?Pa:Oa;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var Ma=function(e){function t(){var t;return(t=e.call(this,yr.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new Ro,t}z(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return Da(e,666)},B(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}(_a),Na=function(e){function t(){var t;return(t=e.call(this,yr.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}z(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&pa){var o=this._layout.descriptorIndices[e];this._buffers[o+n]!==t&&(this._buffers[o+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&da){var o=this._layout.descriptorIndices[e];this._samplers[o+n]!==t&&(this._samplers[o+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&da){var o=this._layout.descriptorIndices[e];this._textures[o+n]!==t&&(this._textures[o+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},B(t,[{key:"layout",get:function(){return this._layout}}]),t}(_a),La=function(e){function t(){var t;return(t=e.call(this,yr.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return z(t,e),B(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(_a),Ba=function(e){function t(){var t;return(t=e.call(this,yr.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return z(t,e),B(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(_a),Fa=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Qr.FILL),void 0===n&&(n=Zr.GOURAND),void 0===i&&(i=Jr.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Qr.FILL,this.shadeModel=Zr.GOURAND,this.cullMode=Jr.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},B(e,[{key:"native",get:function(){return this}}]),e}(),za=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=zr.LESS),void 0===i&&(i=!1),void 0===r&&(r=zr.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Ur.KEEP),void 0===c&&(c=Ur.KEEP),void 0===l&&(l=Ur.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=zr.ALWAYS),void 0===f&&(f=65535),void 0===p&&(p=65535),void 0===d&&(d=Ur.KEEP),void 0===m&&(m=Ur.KEEP),void 0===v&&(v=Ur.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=zr.LESS,this.stencilTestFront=!1,this.stencilFuncFront=zr.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Ur.KEEP,this.stencilZFailOpFront=Ur.KEEP,this.stencilPassOpFront=Ur.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=zr.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Ur.KEEP,this.stencilZFailOpBack=Ur.KEEP,this.stencilPassOpBack=Ur.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},B(e,[{key:"native",get:function(){return this}}]),e}(),Ua=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=!1),void 0===t&&(t=kr.ONE),void 0===n&&(n=kr.ZERO),void 0===i&&(i=Gr.ADD),void 0===r&&(r=kr.ONE),void 0===o&&(o=kr.ZERO),void 0===a&&(a=Gr.ADD),void 0===s&&(s=Hr.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=kr.ONE,this.blendDst=kr.ZERO,this.blendEq=Gr.ADD,this.blendSrcAlpha=kr.ONE,this.blendDstAlpha=kr.ZERO,this.blendAlphaEq=Gr.ADD,this.blendColorMask=Hr.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),ka=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new To),void 0===i&&(i=[new Ua]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new Ua),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},B(e,[{key:"native",get:function(){return this}}]),e}(),Ga=function(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new ra),void 0===r&&(r=new Fa),void 0===o&&(o=new za),void 0===a&&(a=new ka),void 0===s&&(s=Kr.TRIANGLE_LIST),void 0===c&&(c=$r.NONE),void 0===l&&(l=Yr.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Ha=function(e){function t(){var t;return(t=e.call(this,yr.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=Kr.TRIANGLE_LIST,t._is=null,t._rs=new Fa,t._dss=new za,t._bs=new ka,t._dynamicStates=$r.NONE,t._renderPass=null,t}return z(t,e),B(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(_a),Va=function(e){function t(){var t;return(t=e.call(this,yr.QUEUE)||this)._type=no.GRAPHICS,t}return z(t,e),B(t,[{key:"type",get:function(){return this._type}}]),t}(_a),ja=function(e){function t(){var t;return(t=e.call(this,yr.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return z(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return Da(e,666)},B(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(_a),Wa=function(e){function t(t,n){var i;return(i=e.call(this,yr.SAMPLER)||this)._info=new Mo,i._hash=0,i._info.copy(t),i._hash=n,i}return z(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new Mo;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},B(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(_a),qa=function(e){function t(){var t;return(t=e.call(this,yr.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return z(t,e),B(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(_a),Xa=function(e){function t(){var t;return(t=e.call(this,yr.TEXTURE)||this)._type=Or.TEX2D,t._usage=Dr.NONE,t._format=Cr.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._layerCount=1,t._levelCount=1,t._samples=Nr.ONE,t._flags=Mr.NONE,t._isPowerOf2=!1,t._size=0,t}return z(t,e),B(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),t}(_a),Ya=function(e){function t(t,n){var i;return(i=e.call(this,yr.GLOBAL_BARRIER)||this)._info=new Zo,i._hash=0,i._info.copy(t),i._hash=n,i}return z(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return Da(t,666)},B(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(_a),Ka=function(e){function t(t,n){var i;return(i=e.call(this,yr.TEXTURE_BARRIER)||this)._info=new Jo,i._hash=0,i._info.copy(t),i._hash=n,i}return z(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,Da(t+=e.dstQueue?e.dstQueue.type:0,666)},B(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(_a),Qa={Device:wa,Swapchain:Ra,Buffer:ba,Texture:Xa,Sampler:Wa,Shader:qa,InputAssembler:Ma,RenderPass:ja,Framebuffer:Ia,DescriptorSet:Na,DescriptorSetLayout:La,PipelineLayout:Ba,PipelineState:Ha,CommandBuffer:Aa,Queue:Va,GlobalBarrier:Ya,TextureBarrier:Ka,RasterizerState:Fa,BlendState:ka,BlendTarget:Ua,DepthStencilState:za,PipelineStateInfo:Ga};Object.assign(Qa,Ca),r.gfx=Qa;var Za,Ja={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var $a in r.gfx)if("__esModule"!==$a){var es=Ja[$a];""===es?es=$a:void 0===es&&(es="GFX"+$a),Fn(r,"cc",[{name:es,newName:$a,target:r.gfx,targetName:"cc.gfx"}])}e("gfx",Object.freeze({__proto__:null,DescriptorSet:Na,Buffer:ba,CommandBuffer:Aa,get ObjectType(){return yr},get Status(){return Sr},get API(){return xr},get SurfaceTransform(){return Tr},get Feature(){return Er},get Format(){return Cr},get FormatType(){return br},get Type(){return Ar},get BufferUsageBit(){return wr},get BufferFlagBit(){return Rr},get MemoryAccessBit(){return Ir},get MemoryUsageBit(){return Pr},get TextureType(){return Or},get TextureUsageBit(){return Dr},get TextureFlagBit(){return Mr},get SampleCount(){return Nr},get VsyncMode(){return Lr},get Filter(){return Br},get Address(){return Fr},get ComparisonFunc(){return zr},get StencilOp(){return Ur},get BlendFactor(){return kr},get BlendOp(){return Gr},get ColorMask(){return Hr},get ShaderStageFlagBit(){return Vr},get LoadOp(){return jr},get StoreOp(){return Wr},get AccessType(){return qr},get ResolveMode(){return Xr},get PipelineBindPoint(){return Yr},get PrimitiveMode(){return Kr},get PolygonMode(){return Qr},get ShadeModel(){return Zr},get CullMode(){return Jr},get DynamicStateFlagBit(){return $r},get StencilFace(){return eo},get DescriptorType(){return to},get QueueType(){return no},get QueryType(){return io},get CommandBufferType(){return ro},get ClearFlagBit(){return oo},Size:uo,DeviceCaps:ho,Offset:_o,Rect:fo,Extent:po,TextureSubresLayers:mo,TextureSubresRange:vo,TextureCopy:go,TextureBlit:yo,BufferTextureCopy:So,Viewport:xo,Color:To,BindingMappingInfo:Eo,SwapchainInfo:Co,DeviceInfo:bo,BufferInfo:Ao,BufferViewInfo:wo,DrawInfo:Ro,DispatchInfo:Io,IndirectBuffer:Po,TextureInfo:Oo,TextureViewInfo:Do,SamplerInfo:Mo,Uniform:No,UniformBlock:Lo,UniformSamplerTexture:Bo,UniformSampler:Fo,UniformTexture:zo,UniformStorageImage:Uo,UniformStorageBuffer:ko,UniformInputAttachment:Go,ShaderStage:Ho,Attribute:Vo,ShaderInfo:jo,InputAssemblerInfo:Wo,ColorAttachment:qo,DepthStencilAttachment:Xo,SubpassInfo:Yo,SubpassDependency:Ko,RenderPassInfo:Qo,GlobalBarrierInfo:Zo,TextureBarrierInfo:Jo,FramebufferInfo:$o,DescriptorSetLayoutBinding:ea,DescriptorSetLayoutInfo:ta,DescriptorSetInfo:na,PipelineLayoutInfo:ia,InputState:ra,CommandBufferInfo:oa,QueueInfo:aa,QueryPoolInfo:sa,FormatInfo:ca,MemoryStatus:la,DynamicStencilStates:ua,DynamicStates:ha,GFXObject:_a,get AttributeName(){return lo},FormatInfos:fa,DESCRIPTOR_BUFFER_TYPE:pa,DESCRIPTOR_SAMPLER_TYPE:da,DESCRIPTOR_DYNAMIC_TYPE:ma,DRAW_INFO_SIZE:va,IsPowerOf2:ga,FormatSize:ya,FormatSurfaceSize:Sa,GetTypeSize:Ta,getTypedArrayConstructor:Ea,Device:wa,Swapchain:Ra,Framebuffer:Ia,InputAssembler:Ma,DescriptorSetLayout:La,PipelineLayout:Ba,RasterizerState:Fa,DepthStencilState:za,BlendTarget:Ua,BlendState:ka,PipelineStateInfo:Ga,PipelineState:Ha,Queue:Va,RenderPass:ja,Sampler:Wa,Shader:qa,Texture:Xa,GlobalBarrier:Ya,TextureBarrier:Ka})),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(Za||(Za={}));var ts,ns,is,rs,os,as,ss,cs,ls=(ts=new gi(0,0,0),function(e,t){var n=gi.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;gi.multiplyScalar(ts,t.n,t.d);var i=gi.dot(gi.subtract(ts,ts,e.o),t.n)/n;return i<0?0:i}),us=(ns=new gi(0,0,0),is=new gi(0,0,0),rs=new gi(0,0,0),os=new gi(0,0,0),as=new gi(0,0,0),function(e,t,n){gi.subtract(ns,t.b,t.a),gi.subtract(is,t.c,t.a),gi.cross(rs,e.d,is);var i=gi.dot(ns,rs);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;gi.subtract(os,e.o,t.a);var o=gi.dot(os,rs)*r;if(o<0||o>1)return 0;gi.cross(as,os,ns);var a=gi.dot(e.d,as)*r;if(a<0||o+a>1)return 0;var s=gi.dot(is,as)*r;return s<0?0:s}),hs=function(){var e=new gi(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,s=i*i;gi.subtract(e,r,o);var c=e.lengthSqr(),l=gi.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),_s=(ss=new gi,cs=new gi,function(e,t){return gi.subtract(ss,t.center,t.halfExtents),gi.add(cs,t.center,t.halfExtents),fs(e,ss,cs)});function fs(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,h=(n.y-i.y)*a,_=(t.z-i.z)*s,f=(n.z-i.z)*s,p=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return d<0||p>d?0:p>0?p:d}var ps,ds,ms,vs,gs=function(){var e=new gi,t=new gi,n=new gi,i=new gi,r=new gi,o=new gi,a=new gi,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,gi.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),gi.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),gi.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),gi.subtract(a,e,t),c[0]=gi.dot(i,n),c[1]=gi.dot(r,n),c[2]=gi.dot(o,n),l[0]=gi.dot(i,a),l[1]=gi.dot(r,a),l[2]=gi.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var p=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||p>d?0:p>0?p:d}}(),ys=function(){var e=new gi,t=new gi,n=new gi,i=new gi,r=new gi,o=new gi,a=new gi,s=new ao;return function(c,l){var u=l.radius*l.radius,h=gi.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,p=gi.subtract(t,f,_);if(p.equals(gi.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),ic.raySphere(c,s);var d=c.o,m=gi.subtract(n,d,_),v=gi.cross(i,h,p),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=gi.subtract(r,f,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ic.raySphere(c,s)}var S=gi.cross(r,m,p),x=p.lengthSqr(),T=2*gi.dot(v,S),E=T*T-4*g*(S.lengthSqr()-u*x);if(E<0)return 0;var C=(-T-Math.sqrt(E))/(2*g);if(C<0){s.radius=l.radius;var b=gi.subtract(o,f,d);return m.lengthSqr()<b.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ic.raySphere(c,s)}var A=gi.scaleAndAdd(o,c.o,h,C),w=gi.subtract(a,A,_),R=gi.dot(w,p)/x;return R>=0&&R<=1?C:R<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),ic.raySphere(c,s)):R>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),ic.raySphere(c,s)):0}}(),Ss=(ps=so.create(),ds={distance:1/0,doubleSided:!1,mode:Za.ANY},ms=0,vs=function(e,t,n,i,r,o){e===Za.CLOSEST?(ms>t||0===ms)&&(ms=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(ms=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(ms=0,0===t.geometricInfo.positions.length)return ms;var i=void 0===n?ds:n;if(fs(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,o=t.geometricInfo;!function(e,t,n,i,r){if(n===Kr.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];gi.set(ps.a,e[s],e[s+1],e[s+2]),gi.set(ps.b,e[c],e[c+1],e[c+2]),gi.set(ps.c,e[l],e[l+1],e[l+2]);var u=ic.rayTriangle(i,ps,r.doubleSided);if(!(0===u||u>r.distance)&&(vs(r.mode,u,s,c,l,r.result),r.mode===Za.ANY))return u}else if(n===Kr.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var p=3*t[f-_],d=3*t[f+_+1],m=3*t[f+2];gi.set(ps.a,e[p],e[p+1],e[p+2]),gi.set(ps.b,e[d],e[d+1],e[d+2]),gi.set(ps.c,e[m],e[m+1],e[m+2]),_=~_;var v=ic.rayTriangle(i,ps,r.doubleSided);if(!(0===v||v>r.distance)&&(vs(r.mode,v,p,d,m,r.result),r.mode===Za.ANY))return v}else if(n===Kr.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];gi.set(ps.a,e[y],e[y+1],e[y+2]);for(var S=1;S<g;S+=1){var x=3*t[S],T=3*t[S+1];gi.set(ps.b,e[x],e[x+1],e[x+2]),gi.set(ps.c,e[T],e[T+1],e[T+2]);var E=ic.rayTriangle(i,ps,r.doubleSided);if(!(0===E||E>r.distance)&&(vs(r.mode,E,y,x,T,r.result),r.mode===Za.ANY))return E}}}(o.positions,o.indices,r,e,i)}return ms}),xs=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Za.ANY};return function(n,i,r){e=0;var o=void 0===r?t:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!fs(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=Ss(n,u,o);if(h)if(o.mode===Za.CLOSEST)(0===e||e>h)&&(e=h,o.subIndices&&(o.subIndices[0]=l));else if(e=h,o.subIndices&&o.subIndices.push(l),o.mode===Za.ANY)return h}return e&&o.mode===Za.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),Ts=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Za.ANY},n=new fr,i=new Mi;return function(r,o,a){e=0;var s=void 0===a?t:a,c=o.worldBounds;if(c&&!_s(r,c))return e;fr.copy(n,r),o.node&&(Mi.invert(i,o.node.getWorldMatrix(i)),gi.transformMat4(n.o,r.o,i),gi.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=Ss(n,h,s);if(_)if(s.mode===Za.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===Za.ANY)return _}return e&&s.mode===Za.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),Es=function(){var e=new gi(0,0,0);return function(t,n){gi.subtract(e,t.e,t.s);var i=(n.d-gi.dot(t.s,n.n))/gi.dot(e,n.n);return i<0||i>1?0:i}}(),Cs=function(){var e=new gi(0,0,0),t=new gi(0,0,0),n=new gi(0,0,0),i=new gi(0,0,0),r=new gi(0,0,0),o=new gi(0,0,0);return function(a,s,c){gi.subtract(e,s.b,s.a),gi.subtract(t,s.c,s.a),gi.subtract(n,a.s,a.e),gi.cross(r,e,t);var l=gi.dot(n,r);if(l<=0)return 0;gi.subtract(i,a.s,s.a);var u=gi.dot(i,r);if(u<0||u>l)return 0;gi.cross(o,n,i);var h=gi.dot(t,o);if(h<0||h>l)return 0;var _=-gi.dot(e,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,p=1-(h*=f)-(_*=f);gi.set(c,s.a.x*p+s.b.x*h+s.c.x*_,s.a.y*p+s.b.y*h+s.c.y*_,s.a.z*p+s.b.z*h+s.c.z*_)}return 1}}(),bs=new fr;function As(e,t){bs.o.set(e.s),gi.subtract(bs.d,e.e,e.s),bs.d.normalize();var n=_s(bs,t);return n<=e.length()?n:0}function ws(e,t){bs.o.set(e.s),gi.subtract(bs.d,e.e,e.s),bs.d.normalize();var n=gs(bs,t);return n<=e.length()?n:0}function Rs(e,t){bs.o.set(e.s),gi.subtract(bs.d,e.e,e.s),bs.d.normalize();var n=hs(bs,t);return n<=e.length()?n:0}var Is,Ps,Os,Ds,Ms=(Is=new gi,Ps=new gi,Os=new gi,Ds=new gi,function(e,t){return gi.subtract(Is,e.center,e.halfExtents),gi.add(Ps,e.center,e.halfExtents),gi.subtract(Os,t.center,t.halfExtents),gi.add(Ds,t.center,t.halfExtents),Is.x<=Ds.x&&Ps.x>=Os.x&&Is.y<=Ds.y&&Ps.y>=Os.y&&Is.z<=Ds.z&&Ps.z>=Os.z});function Ns(e,t,n,i,r,o){gi.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),gi.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),gi.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),gi.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),gi.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),gi.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),gi.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),gi.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function Ls(e,t){for(var n=gi.dot(t,e[0]),i=n,r=1;r<8;++r){var o=gi.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Bs,Fs,zs,Us=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new gi(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new gi(0,0,0),i[r]=new gi(0,0,0);var o=new gi,a=new gi;return function(t,r){gi.set(e[0],1,0,0),gi.set(e[1],0,1,0),gi.set(e[2],0,0,1),gi.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),gi.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),gi.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)gi.cross(e[6+3*s],e[s],e[3]),gi.cross(e[7+3*s],e[s],e[4]),gi.cross(e[7+3*s],e[s],e[5]);gi.subtract(o,t.center,t.halfExtents),gi.add(a,t.center,t.halfExtents),function(e,t,n){gi.set(n[0],e.x,t.y,t.z),gi.set(n[1],e.x,t.y,e.z),gi.set(n[2],e.x,e.y,t.z),gi.set(n[3],e.x,e.y,e.z),gi.set(n[4],t.x,t.y,t.z),gi.set(n[5],t.x,t.y,e.z),gi.set(n[6],t.x,e.y,t.z),gi.set(n[7],t.x,e.y,e.z)}(o,a,n),Ns(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Ls(n,e[c]),u=Ls(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),ks=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=gi.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Gs=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===ks(e,t.planes[n]))return 0;return 1},Hs=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new gi(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=ks(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)gi.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),Vs=(Bs=new gi(0,0,0),Fs=new Ti,function(e,t){return gi.subtract(Bs,t,e.center),gi.transformMat3(Bs,Bs,Ti.transpose(Fs,e.orientation)),n=Bs,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),js=(zs=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*zs(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*zs(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*zs(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=gi.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),Ws=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===js(e,t.planes[n]))return 0;return 1},qs=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new gi(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=js(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)gi.subtract(e[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=o(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),Xs=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new gi(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new gi(0,0,0),i[r]=new gi(0,0,0);return function(t,r){gi.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),gi.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),gi.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),gi.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),gi.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),gi.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)gi.cross(e[6+3*o],e[o],e[3]),gi.cross(e[7+3*o],e[o],e[4]),gi.cross(e[8+3*o],e[o],e[5]);Ns(t.center,t.halfExtents,e[0],e[1],e[2],n),Ns(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=Ls(n,e[a]),c=Ls(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),Ys=function(){for(var e=new ao,t=new gi,n=new gi,i=new gi,r=new Array(8),o=0;o<8;o++)r[o]=new gi;for(var a=new Array(8),s=0;s<8;s++)a[s]=new gi;return function(o,s){if(0===gi.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),ic.sphereOBB(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Ns(o.center,o.halfExtents,t,n,i,r);var c=a,l=gi.copy(c[0],t),u=gi.copy(c[1],n),h=gi.copy(c[2],i);gi.subtract(c[3],s.center,o.center).normalize();var _=gi.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),gi.cross(c[5],l,_),gi.cross(c[6],u,_),gi.cross(c[7],h,_);for(var f=0;f<8;++f){var p=Ls(r,c[f]),d=gi.dot(c[f],s.ellipseCenter0),m=gi.dot(c[f],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>p[1]||p[0]>y)return 0}return 1}}(),Ks=function(e,t){var n=gi.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},Qs=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ks(e,t.planes[n]))return 0;return 1},Zs=function(){var e=new gi(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=gi.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){gi.add(e,s,gi.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=i.planes[h];if(gi.dot(_.n,e)<_.d)return 0}}}return 1}}(),Js=function(e,t){var n=e.radius+t.radius;return gi.squaredDistance(e.center,t.center)<n*n},$s=function(){var e=new gi;return function(t,n){return cr(e,t.center,n),gi.squaredDistance(t.center,e)<t.radius*t.radius}}(),ec=function(){var e=new gi;return function(t,n){return lr(e,t.center,n),gi.squaredDistance(t.center,e)<t.radius*t.radius}}(),tc=function(){var e=new gi,t=new gi;return function(n,i){var r=n.radius+i.radius,o=r*r,a=gi.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return gi.squaredDistance(n.center,i.center)<o;gi.subtract(e,n.center,i.ellipseCenter0),gi.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=gi.dot(e,t)/a;return s<0?gi.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?gi.squaredDistance(n.center,i.ellipseCenter1)<o:(gi.scaleAndAdd(e,i.ellipseCenter0,t,s),gi.squaredDistance(n.center,e)<o)}}(),nc=function(){var e=new gi,t=new gi,n=new gi,i=new gi,r=new gi,o=new gi;return function(a,s){var c,l,u=gi.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=gi.subtract(t,s.ellipseCenter1,s.ellipseCenter0),_=gi.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=gi.dot(u,u),p=gi.dot(u,h),d=gi.dot(h,h),m=gi.dot(u,_),v=gi.dot(h,_),g=f*d-p*p,y=g,S=g;g<Yn?(c=0,y=1,l=v,S=d):(l=f*v-p*m,(c=p*v-d*m)<0?(c=0,l=v,S=d):c>y&&(c=y,l=v+p,S=d)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>S&&(l=S,-m+p<0?c=0:-m+p>f?c=y:(c=-m+p,y=f));var x=Math.abs(c)<Yn?0:c/y,T=Math.abs(l)<Yn?0:l/S,E=i;E.set(_),E.add(gi.multiplyScalar(r,u,x)),E.subtract(gi.multiplyScalar(o,h,T));var C=a.radius+s.radius;return E.lengthSqr()<C*C}}(),ic={raySphere:hs,rayAABB:_s,rayOBB:gs,rayPlane:ls,rayTriangle:us,rayCapsule:ys,raySubMesh:Ss,rayMesh:xs,rayModel:Ts,lineSphere:Rs,lineAABB:As,lineOBB:ws,linePlane:Es,lineTriangle:Cs,sphereWithSphere:Js,sphereAABB:$s,sphereOBB:ec,spherePlane:Ks,sphereFrustum:Qs,sphereFrustumAccurate:Zs,sphereCapsule:tc,aabbWithAABB:Ms,aabbWithOBB:Us,aabbPlane:ks,aabbFrustum:Gs,aabbFrustumAccurate:Hs,obbWithOBB:Xs,obbPlane:js,obbFrustum:Ws,obbFrustumAccurate:qs,obbPoint:Vs,obbCapsule:Ys,capsuleWithCapsule:nc,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}};ic[hr.SHAPE_RAY|hr.SHAPE_SPHERE]=hs,ic[hr.SHAPE_RAY|hr.SHAPE_AABB]=_s,ic[hr.SHAPE_RAY|hr.SHAPE_OBB]=gs,ic[hr.SHAPE_RAY|hr.SHAPE_PLANE]=ls,ic[hr.SHAPE_RAY|hr.SHAPE_TRIANGLE]=us,ic[hr.SHAPE_RAY|hr.SHAPE_CAPSULE]=ys,ic[hr.SHAPE_LINE|hr.SHAPE_SPHERE]=Rs,ic[hr.SHAPE_LINE|hr.SHAPE_AABB]=As,ic[hr.SHAPE_LINE|hr.SHAPE_OBB]=ws,ic[hr.SHAPE_LINE|hr.SHAPE_PLANE]=Es,ic[hr.SHAPE_LINE|hr.SHAPE_TRIANGLE]=Cs,ic[hr.SHAPE_SPHERE]=Js,ic[hr.SHAPE_SPHERE|hr.SHAPE_AABB]=$s,ic[hr.SHAPE_SPHERE|hr.SHAPE_OBB]=ec,ic[hr.SHAPE_SPHERE|hr.SHAPE_PLANE]=Ks,ic[hr.SHAPE_SPHERE|hr.SHAPE_FRUSTUM]=Qs,ic[hr.SHAPE_SPHERE|hr.SHAPE_FRUSTUM_ACCURATE]=Zs,ic[hr.SHAPE_SPHERE|hr.SHAPE_CAPSULE]=tc,ic[hr.SHAPE_AABB]=Ms,ic[hr.SHAPE_AABB|hr.SHAPE_OBB]=Us,ic[hr.SHAPE_AABB|hr.SHAPE_PLANE]=ks,ic[hr.SHAPE_AABB|hr.SHAPE_FRUSTUM]=Gs,ic[hr.SHAPE_AABB|hr.SHAPE_FRUSTUM_ACCURATE]=Hs,ic[hr.SHAPE_OBB]=Xs,ic[hr.SHAPE_OBB|hr.SHAPE_PLANE]=js,ic[hr.SHAPE_OBB|hr.SHAPE_FRUSTUM]=Ws,ic[hr.SHAPE_OBB|hr.SHAPE_FRUSTUM_ACCURATE]=qs,ic[hr.SHAPE_OBB|hr.SHAPE_CAPSULE]=Ys,ic[hr.SHAPE_CAPSULE]=nc,Fn(_r.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),zn(ic,"intersect",[{name:"line_quad"}]);var rc,oc,ac,sc,cc,lc,uc,hc=new gi(0,0,0),_c=new gi(0,0,0),fc=r.mat4(),pc=r.v4(),dc=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=hr.SHAPE_PLANE,this.n=new gi(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return gi.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return gi.subtract(hc,n,t),gi.subtract(_c,i,t),gi.normalize(e.n,gi.cross(e.n,hc,_c)),e.d=gi.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return gi.copy(e.n,t),e.d=gi.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return gi.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){Mi.invert(fc,e),Mi.transpose(fc,fc),Gi.set(pc,this.n.x,this.n.y,this.n.z,this.d),Gi.transformMat4(pc,pc,fc),gi.set(this.n,pc.x,pc.y,pc.z),this.d=pc.w},B(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),mc=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(uc||(uc={}));var vc,gc,yc=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new mc(e,r,this._stride);var o=uc.NEVER,a=!1,s=!1;for(var c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==uc.FLOAT32?s||o!==uc.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,o=(this._dataType[t]===uc.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[t];return o.subarray(r,r+a)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(vc||(vc={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(gc||(gc={}));var Sc,xc=((rc={})[gc.DIRTY_FLAG]=uc.UINT32,rc[gc.LAYER]=uc.UINT32,rc[gc.WORLD_SCALE]=uc.FLOAT32,rc[gc.WORLD_POSITION]=uc.FLOAT32,rc[gc.WORLD_ROTATION]=uc.FLOAT32,rc[gc.WORLD_MATRIX]=uc.FLOAT32,rc[gc.LOCAL_SCALE]=uc.FLOAT32,rc[gc.LOCAL_POSITION]=uc.FLOAT32,rc[gc.LOCAL_ROTATION]=uc.FLOAT32,rc[gc.COUNT]=uc.NEVER,rc),Tc=((oc={})[gc.DIRTY_FLAG]=gc.LAYER-gc.DIRTY_FLAG,oc[gc.LAYER]=gc.WORLD_SCALE-gc.LAYER,oc[gc.WORLD_SCALE]=gc.WORLD_POSITION-gc.WORLD_SCALE,oc[gc.WORLD_POSITION]=gc.WORLD_ROTATION-gc.WORLD_POSITION,oc[gc.WORLD_ROTATION]=gc.WORLD_MATRIX-gc.WORLD_ROTATION,oc[gc.WORLD_MATRIX]=gc.LOCAL_SCALE-gc.WORLD_MATRIX,oc[gc.LOCAL_SCALE]=gc.LOCAL_POSITION-gc.LOCAL_SCALE,oc[gc.LOCAL_POSITION]=gc.LOCAL_ROTATION-gc.LOCAL_POSITION,oc[gc.LOCAL_ROTATION]=gc.COUNT-gc.LOCAL_ROTATION,oc[gc.COUNT]=1,oc),Ec=new yc(vc.NODE,xc,Tc,gc);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(Sc||(Sc={}));var Cc,bc=((ac={})[Sc.PRIORITY]=uc.UINT32,ac[Sc.STAGE]=uc.UINT32,ac[Sc.PHASE]=uc.UINT32,ac[Sc.PRIMITIVE]=uc.UINT32,ac[Sc.BATCHING_SCHEME]=uc.UINT32,ac[Sc.DYNAMIC_STATE]=uc.UINT32,ac[Sc.HASH]=uc.UINT32,ac[Sc.COUNT]=uc.NEVER,ac),Ac=((sc={})[Sc.PRIORITY]=Sc.STAGE-Sc.PRIORITY,sc[Sc.STAGE]=Sc.PHASE-Sc.STAGE,sc[Sc.PHASE]=Sc.PRIMITIVE-Sc.PHASE,sc[Sc.PRIMITIVE]=Sc.BATCHING_SCHEME-Sc.PRIMITIVE,sc[Sc.BATCHING_SCHEME]=Sc.DYNAMIC_STATE-Sc.BATCHING_SCHEME,sc[Sc.DYNAMIC_STATE]=Sc.HASH-Sc.DYNAMIC_STATE,sc[Sc.HASH]=Sc.COUNT-Sc.HASH,sc[Sc.COUNT]=1,sc),wc=new yc(vc.PASS,bc,Ac,Sc);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(Cc||(Cc={}));var Rc=((cc={})[Cc.CENTER]=uc.FLOAT32,cc[Cc.HALFEXTENTS]=uc.FLOAT32,cc[Cc.COUNT]=uc.NEVER,cc),Ic=((lc={})[Cc.CENTER]=Cc.HALFEXTENTS-Cc.CENTER,lc[Cc.HALFEXTENTS]=Cc.COUNT-Cc.HALFEXTENTS,lc[Cc.COUNT]=1,lc),Pc=new yc(vc.AABB,Rc,Ic,Cc),Oc=new gi,Dc=new gi,Mc=new gi,Nc=new gi,Lc=new Ti,Bc=function(e,t,n){Lc.m00=Math.abs(n.m00),Lc.m01=Math.abs(n.m01),Lc.m02=Math.abs(n.m02),Lc.m03=Math.abs(n.m04),Lc.m04=Math.abs(n.m05),Lc.m05=Math.abs(n.m06),Lc.m06=Math.abs(n.m08),Lc.m07=Math.abs(n.m09),Lc.m08=Math.abs(n.m10),gi.transformMat3(e,t,Lc)},Fc=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=hr.SHAPE_AABB,this.center=new gi(e,t,n),this.halfExtents=new gi(i,r,o)}e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return gi.copy(e.center,t.center),gi.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return gi.add(Oc,n,t),gi.subtract(Dc,n,t),gi.multiplyScalar(e.center,Oc,.5),gi.multiplyScalar(e.halfExtents,Dc,.5),e},e.set=function(e,t,n,i,r,o,a){return e.center.set(t,n,i),e.halfExtents.set(r,o,a),e},e.merge=function(t,n,i){return gi.subtract(Oc,n.center,n.halfExtents),gi.subtract(Dc,i.center,i.halfExtents),gi.add(Mc,n.center,n.halfExtents),gi.add(Nc,i.center,i.halfExtents),gi.max(Nc,Mc,Nc),gi.min(Mc,Oc,Dc),e.fromPoints(t,Mc,Nc)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return gi.transformMat4(e.center,t.center,n),Bc(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){gi.subtract(e,this.center,this.halfExtents),gi.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){gi.transformMat4(r.center,this.center,e),Bc(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(Oc,Dc),e.x<Oc.x&&(Oc.x=e.x),e.y<Oc.y&&(Oc.y=e.y),e.z<Oc.z&&(Oc.z=e.z),e.x>Dc.x&&(Dc.x=e.x),e.y>Dc.y&&(Dc.y=e.y),e.z>Dc.z&&(Dc.z=e.z),gi.add(Mc,Oc,Dc),this.center.set(gi.multiplyScalar(Mc,Mc,.5)),this.halfExtents.set(Dc.x-Mc.x,Dc.y-Mc.y,Dc.z-Mc.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},B(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),zc=new gi,Uc=new gi,kc=new Ti,Gc=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=hr.SHAPE_OBB,this.center=new gi(e,t,n),this.halfExtents=new gi(i,r,o),this.orientation=new Ti(a,s,c,l,u,h,_,f,p)}e.create=function(t,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return new e(t,n,i,r,o,a,s,c,l,u,h,_,f,p,d)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return gi.copy(e.center,t.center),gi.copy(e.halfExtents,t.halfExtents),Ti.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return gi.multiplyScalar(e.center,gi.add(zc,t,n),.5),gi.multiplyScalar(e.halfExtents,gi.subtract(Uc,n,t),.5),Ti.identity(e.orientation),e},e.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return gi.set(e.center,t,n,i),gi.set(e.halfExtents,r,o,a),Ti.set(e.orientation,s,c,l,u,h,_,f,p,d),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){kc.m00=Math.abs(n.m00),kc.m01=Math.abs(n.m01),kc.m02=Math.abs(n.m02),kc.m03=Math.abs(n.m03),kc.m04=Math.abs(n.m04),kc.m05=Math.abs(n.m05),kc.m06=Math.abs(n.m06),kc.m07=Math.abs(n.m07),kc.m08=Math.abs(n.m08),gi.transformMat3(e,t,kc)}(zc,this.halfExtents,this.orientation),gi.subtract(e,this.center,zc),gi.add(t,this.center,zc)},t.transform=function(e,t,n,i,r){gi.transformMat4(r.center,this.center,e),Ti.fromQuat(r.orientation,n),gi.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){gi.transformMat4(n.center,this.center,e),Ti.fromQuat(n.orientation,t)},t.setScale=function(e,t){gi.multiply(t.halfExtents,this.halfExtents,e)},B(e,[{key:"type",get:function(){return this._type}}]),e}(),Hc=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=hr.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new gi,this.rotation=new bi,this.ellipseCenter0=new gi(0,t,0),this.ellipseCenter1=new gi(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var o=i,a=_i(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,gi.transformMat4(r.center,this.center,e),bi.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),gi.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),gi.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},B(e,[{key:"type",get:function(){return this._type}}]),e}(),Vc=new Array(8);Vc[0]=new gi(1,1,1),Vc[1]=new gi(-1,1,1),Vc[2]=new gi(-1,-1,1),Vc[3]=new gi(1,-1,1),Vc[4]=new gi(1,1,-1),Vc[5]=new gi(-1,1,-1),Vc[6]=new gi(-1,-1,-1),Vc[7]=new gi(1,-1,-1);var jc,Wc,qc=new gi,Xc=new gi,Yc=new gi,Kc=function(){function e(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=hr.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=dc.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new gi}e.createFromAABB=function(e,t){var n=new gi,i=new gi;return gi.subtract(n,t.center,t.halfExtents),gi.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==hr.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var o=Math.tan(.5*t.fov),a=o*t.aspect;qc.set(i*a,i*o,i),Xc.set(r*a,r*o,r);var s=e.vertices;return Yc.set(qc.x,qc.y,qc.z),gi.transformMat4(s[0],Yc,n),Yc.set(-qc.x,qc.y,qc.z),gi.transformMat4(s[1],Yc,n),Yc.set(-qc.x,-qc.y,qc.z),gi.transformMat4(s[2],Yc,n),Yc.set(qc.x,-qc.y,qc.z),gi.transformMat4(s[3],Yc,n),Yc.set(Xc.x,Xc.y,Xc.z),gi.transformMat4(s[4],Yc,n),Yc.set(-Xc.x,Xc.y,Xc.z),gi.transformMat4(s[5],Yc,n),Yc.set(-Xc.x,-Xc.y,Xc.z),gi.transformMat4(s[6],Yc,n),Yc.set(Xc.x,-Xc.y,Xc.z),gi.transformMat4(s[7],Yc,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)dc.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)gi.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(gi.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),gi.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),gi.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),gi.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),gi.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),gi.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===hr.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();gi.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)gi.transformMat4(this.vertices[o],Vc[o],t)}},t.transform=function(e){if(this._type===hr.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)gi.transformMat4(this.vertices[t],this.vertices[t],e);dc.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),dc.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),dc.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),dc.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),dc.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),dc.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},t.updatePlanes=function(){dc.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),dc.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),dc.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),dc.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),dc.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),dc.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},B(e,[{key:"accurate",set:function(e){this._type=e?hr.SHAPE_FRUSTUM_ACCURATE:hr.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();Kc.createOrtho=function(e,t,n,i,r,o){var a=t/2,s=n/2;gi.set(Yc,a,s,-i),gi.transformMat4(e.vertices[0],Yc,o),gi.set(Yc,-a,s,-i),gi.transformMat4(e.vertices[1],Yc,o),gi.set(Yc,-a,-s,-i),gi.transformMat4(e.vertices[2],Yc,o),gi.set(Yc,a,-s,-i),gi.transformMat4(e.vertices[3],Yc,o),gi.set(Yc,a,s,-r),gi.transformMat4(e.vertices[4],Yc,o),gi.set(Yc,-a,s,-r),gi.transformMat4(e.vertices[5],Yc,o),gi.set(Yc,-a,-s,-r),gi.transformMat4(e.vertices[6],Yc,o),gi.set(Yc,a,-s,-r),gi.transformMat4(e.vertices[7],Yc,o),dc.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),dc.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),dc.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),dc.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),dc.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),dc.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(jc||(jc={})),function(e){e[e.Default=jc.Default]="Default",e[e.Normal=jc.Normal]="Normal",e[e.Reverse=jc.Reverse]="Reverse",e[e.Loop=jc.Loop]="Loop",e[e.LoopReverse=jc.Loop|jc.Reverse]="LoopReverse",e[e.PingPong=jc.PingPong]="PingPong",e[e.PingPongReverse=jc.PingPong|jc.Reverse]="PingPongReverse"}(Wc||(Wc={})),Je(Wc);var Qc=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function Zc(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=e[o];if(a>t+n)r=o-1;else{if(!(a<t-n))return o;i=o+1}}return~i}var Jc=function(){},$c=function(){return Jc},el=tl((function(){}));function tl(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function nl(e){return function(t){return function(n){!function(e,t,n){var i=rl(e);if(i){var r=ol(i,"proto");ol(r,"editor")[t]=n}}(n,e,t)}}}var il="__ccclassCache__";function rl(e){return ol(e,il)}function ol(e,t){return e[t]||(e[t]={})}var al=tl((function(e,t){var n=He.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[il];if(r){var o=r.proto;o&&He.mixin(i,o),e[il]=void 0}return Ht(i)})),sl=nl("requireComponent"),cl=nl("executionOrder"),ll=el;function ul(e,t,n){var i=null;function r(e,t,n){var r=rl(e.constructor);if(r){var o=ol(r,"proto"),a=ol(o,"properties");!function(e,t,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=Dt(i,s));var c=t[n],l=He.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var u=o.default||(o.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(n)&&(l.default=u[n])}t[n]=l}(e.constructor,a,t,i,n,r)}}return void 0===e?ul({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}var hl=Symbol("cc:SerializationMetadata"),_l=function(e,t,n){return ul(dl({}))(e,t,n)};function fl(e){return ul(dl({formerlySerializedAs:e}))}var pl=function(e,t,n){return ul({editorOnly:!0})(e,t,n)};function dl(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var ml=Jc,vl=el,gl=$c,yl=el,Sl=$c,xl=$c,Tl=$c,El=Jc,Cl=$c,bl=Jc,Al=$c,wl=$c,Rl=$c,Il=$c,Pl=$c,Ol=$c,Dl=Jc,Ml=$c,Nl=Jc,Ll=Jc,Bl=Jc,Fl=Gl(Tt),zl=Gl(Et),Ul=Gl(Ct),kl=Gl(bt);function Gl(e){return ul({type:e})}var Hl,Vl,jl,Wl,ql,Xl,Yl,Kl,Ql,Zl=function(e,t,n){return ul({__noImplicit:!0,override:!0})(e,t,n)},Jl=al("cc.KeyframeCurve")((Hl=Symbol.iterator,Xl=function(){function e(){X(this,"_times",Wl,this),X(this,"_values",ql,this)}var t=e.prototype;return t[Hl]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return Zc(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return Zc(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||Qn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,o=Zc(n,e);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(e),i.unshift(t)):a===r?(n.push(e),i.push(t)):(n.splice(a-1,0,e),i.splice(a-1,0,t)),a},B(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}(),Wl=Y((jl=Xl).prototype,"_times",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ql=Y(jl.prototype,"_values",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vl=jl))||Vl;function $l(e){return e>-1e-9&&e<1e-9}!function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(Yl||(Yl=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(Kl||(Kl=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(Ql||(Ql=e("TangentWeightMode",{})));var eu=function(){},tu=Object.freeze({__proto__:null,uniquelyReferenced:ml,ccclass:al,property:ul,requireComponent:sl,executionOrder:cl,disallowMultiple:ll,allowReplicated:function(e){Ht.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:vl,menu:gl,playOnFocus:yl,inspector:Sl,icon:xl,help:Tl,type:Gl,integer:Fl,float:zl,boolean:Ul,string:kl});e("_decorator",tu);var nu=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=He.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=He.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},B(e,[{key:"count",get:function(){return this._count}}]),e}(),iu=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(b(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();iu._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=He.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},B(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var ru,ou=new nu,au=new nu,su=new nu,cu=new nu,lu=new iu("normal load",[]),uu=new iu("fetch",[]),hu=new iu("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(ru||(ru={}));var _u,fu={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(_u||(_u={}));var pu=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();pu.MAX_DEAD_NUM=500,pu._taskId=0,pu._deadPool=[];var du="0123456789abcdef".split(""),mu=["","","",""],vu=mu.concat(mu,"-",mu,"-",mu,"-",mu,"-",mu,mu,mu),gu=vu.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function yu(e){var t=e.split("@")[0];if(22!==t.length)return e;vu[0]=e[0],vu[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=ot[e.charCodeAt(n)],o=ot[e.charCodeAt(n+1)];vu[gu[i++]]=du[r>>2],vu[gu[i++]]=du[(3&r)<<2|o>>4],vu[gu[i++]]=du[15&o]}return e.replace(t,vu.join(""))}var Su=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function xu(e){var t=Su.exec(e);return t?t[1]:""}function Tu(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;var n=cu.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),bu(e,t)}function Eu(e){return!!e&&(e instanceof r.SceneAsset||e instanceof r.Scene)}function Cu(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function bu(e,t){var n=pu.create({input:e,options:t}),i=[];try{for(var r,o=q(hu.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=q(n.output);!(c=l()).done;)c.value.recycle();m(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var Au,wu,Ru,Iu,Pu,Ou,Du,Mu,Nu=Object.freeze({__proto__:null,getUuidFromURL:xu,getUrlWithUuid:Tu,isScene:Eu,normalize:Cu,transform:bu,decodeUuid:yu}),Lu=new(function(){function e(){this._finalizationRegistry=null}var t=e.prototype;return t.registerGCObject=function(e){return e},t.unregisterGCObject=function(){},t.init=function(){},t.finalizationRegistryCallback=function(e){e.isValid&&e.destroy()},t.destroy=function(){},e}()),Bu=al("cc.GCObject")(Au=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return t=e.call.apply(e,[this].concat(i))||this,Lu.registerGCObject(j(t))||j(t)}z(t,e);var n=t.prototype;return n.equals=function(e){return!!e&&e===this},n.destroy=function(){return Lu.unregisterGCObject(this),e.prototype.destroy.call(this)},t}(Kt))||Au,Fu=e("Asset",al("cc.Asset")((Pu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,X(t,"_native",Iu,j(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(j(t),"_uuid",{value:"",writable:!0}),t}z(t,e),t.deserialize=function(e){return r.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&r.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return g(O(12101,this._uuid)),e.prototype.destroy.call(this)},B(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=Tu(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=Tu(this._uuid,{__nativeName__:e,nativeExt:yn(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(an(Bu)),Iu=Y((Ru=Pu).prototype,"_native",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Y(Ru.prototype,"_nativeAsset",[ul],Object.getOwnPropertyDescriptor(Ru.prototype,"_nativeAsset"),Ru.prototype),wu=Ru))||wu);Fu.prototype.createNode=null,r.Asset=Fu;var zu=e("Script",al("cc.Script")(Ou=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(Fu))||Ou);r._Script=zu;var Uu=e("JavaScript",al("cc.JavaScript")(Du=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(zu))||Du);r._JavaScript=Uu;var ku,Gu,Hu,Vu,ju,Wu,qu,Xu,Yu,Ku,Qu,Zu=e("TypeScript",al("cc.TypeScript")(Mu=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(zu))||Mu);r._TypeScript=Zu;var Ju,$u,eh,th,nh=new te("Comp"),ih=Kt.Flags.IsOnLoadCalled,rh=e("Component",(ku=al("cc.Component"),Gu=Al(),Hu=Gl(zu),Vu=wl(),ku((Qu=Ku=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"node",qu,j(t)),X(t,"_enabled",Xu,j(t)),X(t,"__prefab",Yu,j(t)),t._sceneGetter=null,t._id=nh.getNewId(),t}z(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&r.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),r.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=r.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=r.macro.REPEAT_FOREVER),void 0===i&&(i=0),P(e,1619),P((t=t||0)>=0,1620),n=Number.isNaN(n)?r.macro.REPEAT_FOREVER:n,i=i||0;var o=r.director.getScheduler(),a=o.isTargetPaused(this);o.schedule(e,this,t,n,i,a)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&r.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){r.director.getScheduler().unscheduleAllForTarget(this)},B(t,[{key:"name",get:function(){if(this._name)return this._name;var e=pe(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=r.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&ih}}]),t}(Kt),Ku.system=null,Y((Wu=Qu).prototype,"__scriptAsset",[Gu,Hu,Vu,Bl],Object.getOwnPropertyDescriptor(Wu.prototype,"__scriptAsset"),Wu.prototype),qu=Y(Wu.prototype,"node",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xu=Y(Wu.prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yu=Y(Wu.prototype,"__prefab",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ju=Wu))||ju)),oh=rh.prototype;oh.update=null,oh.lateUpdate=null,oh.__preload=null,oh.onLoad=null,oh.start=null,oh.onEnable=null,oh.onDisable=null,oh.onDestroy=null,oh.onFocusInEditor=null,oh.onLostFocusInEditor=null,oh.resetInEditor=null,oh._getLocalBounds=null,oh.onRestore=null,rh._requireComponent=null,rh._executionOrder=0,le(rh,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),r.Component=rh;var ah,sh=e("MissingScript",al("cc.MissingScript")(Ju=Sl()((th=function(e){function t(){var t;return X(t=e.call(this)||this,"_$erialized",eh,j(t)),t}return z(t,e),t.safeFindClass=function(e){var t=Fe(e);if(t)return t;r.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){b(4600,this.node.name)},t}(rh),eh=Y(($u=th).prototype,"_$erialized",[_l,pl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ju=$u))||Ju)||Ju);r._MissingScript=sh;try{var ch=sh.__values__;0!==ch.length&&"_$erialized"===ch[ch.length-1]||(m("The '_$erialized' prop in MissingScript is missing. Please contact jare."),m("    Error props: ['"+ch+"']"))}catch(ar){m("Error when checking MissingScript 5, "+ar)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(ah||(ah={}));var lh,uh={auto:ah.AUTO,landscape:ah.LANDSCAPE,portrait:ah.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(lh||(lh={}));var hh=new(function(e){function t(){var t,n,i,r,o,a;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new ji(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=ah.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)t._fn[s[0][l]]=a[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}z(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=uh[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===lh.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===lh.Fullscreen?document[this._fn.fullscreenElement]:e===lh.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=pn.isMobile&&(t&&e===ah.PORTRAIT||!t&&e===ah.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void b(9201);var e,t,n=r.view.getDesignResolutionSize(),i=this._gameFrame,o=i.clientWidth,a=i.clientHeight,s=n.width,c=n.height,l=o/s,u=a/c,h=this._gameContainer.style;l<u?(e=o,t=c*l):(e=s*u,t=a),h.width=e+"px",h.height=t+"px"}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else b(9201)},B(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){return window.devicePixelRatio||1}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===lh.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):b(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new ji(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new ji(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(b(9201),new ji(0,0));var e,t,n;switch(this._windowType){case lh.SubFrame:return this._gameFrame?new ji(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(b(9201),new ji(0,0));case lh.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new ji(t,n);case lh.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new ji(t,n);case lh.Unknown:default:return new ji(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?lh.Fullscreen:this._gameFrame?this._exactFitScreen?lh.BrowserWindow:lh.SubFrame:(b(9201),lh.Unknown)}}]),t}(fn)),_h=function(){function e(){}var t=e.prototype;return t._init=function(e){hh.init(e,(function(){var e,t=r.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=hh.resolutionScale:b(1220)}))},t.fullScreen=function(){return hh.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&b(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),hh.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return hh.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},B(e,[{key:"windowSize",get:function(){return hh.windowSize},set:function(e){hh.windowSize=e}},{key:"resolution",get:function(){return hh.resolution}},{key:"supportsFullScreen",get:function(){return hh.supportFullScreen}}]),e}(),fh=e("screen",new _h);r.screen=fh;var ph=e("sys",{Feature:_n,hasFeature:function(e){return pn.hasFeature(e)},NetworkType:ln,Language:cn,OS:un,Platform:hn,BrowserType:sn,isNative:pn.isNative,isBrowser:pn.isBrowser,isMobile:pn.isMobile,isLittleEndian:pn.isLittleEndian,platform:pn.platform,language:pn.language,languageCode:pn.nativeLanguage,os:pn.os,osVersion:pn.osVersion,osMainVersion:pn.osMainVersion,browserType:pn.browserType,browserVersion:pn.browserVersion,windowPixelResolution:fh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:pn.hasFeature(_n.WEBP),imageBitmap:pn.hasFeature(_n.IMAGE_BITMAP),touches:pn.hasFeature(_n.INPUT_TOUCH),mouse:pn.hasFeature(_n.EVENT_MOUSE),keyboard:pn.hasFeature(_n.EVENT_KEYBOARD),accelerometer:pn.hasFeature(_n.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return pn.networkType},getBatteryLevel:function(){return pn.getBatteryLevel()},garbageCollect:function(){pn.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",p(e+="Using "+(r.game.renderType===r.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){pn.openURL(e)},now:function(){return pn.now()},restartVM:function(){pn.restartJSVM()},getSafeAreaRect:function(){var e=r.view,t=hh.safeAreaEdge,n=hh.windowSize,i=new Fi(t.left,t.bottom),o=new Fi(n.width-t.right,n.height-t.top);e._convertToUISpace(i),e._convertToUISpace(o);var a=i.x,s=i.y,c=o.x-i.x,l=o.y-i.y;return new qi(a,s,c,l)}});!function(){try{var e=ph.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){b(5200)};ph.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}ph.__isWebIOS14OrIPadOS14Env=(ph.os===un.IOS||ph.os===un.OSX)&&pn.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent)}(),r.sys=ph;var dh=e("serializeTag",Symbol("[[Serialize]]")),mh=e("deserializeTag",Symbol("[[Deserialize]]")),vh=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return B(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function gh(e){var t=e;return{chunks:t.chunks,document:t.document}}function yh(e){if(e.length<16)throw new Sh(O(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new Sh(O(13100));var n=t.getUint32(4,!0);if(1!==n)throw new Sh(O(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new Sh(O(13102));var i=12,r=t.getUint32(i,!0);i+=4;var o=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var a,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(O(13104))}(o);try{a=JSON.parse(s)}catch(e){throw new Sh(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new Sh(O(13102));return new vh(a,c)}var Sh=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(V(Error));function xh(e,t,n,i,o){if(t instanceof r.ValueType){o||e.push("if(prop){");var a=pe(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+a+");"),o||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},B(e,[{key:"byteLength",get:function(){return this._length}}])}(),r.internal.parseCCONJson=gh,r.internal.decodeCCONBinary=yh,r.internal.CCON=vh;var Th="$_$default",Eh="$_$formerlySerializedAs",Ch=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return z(t,e),t.prototype.get=function(e,t,n,i,r){var o=this._get();return o?(o.reset(e,t,n,i,r),o):new bh(e,t,n,i,r)},t}(ke),bh=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof vh?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,o=e.__type__,a=this._classFinder(o,e,n,i);if(!a)return this._classFinder===Fe&&this._reportMissingClass(o),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(a);return this._deserializeInto(e,s,a),s},t._deserializeInto=function(e,t,n,i){void 0===i&&(i=!1),i||!t[mh]?t._deserialize?t._deserialize(e.content,this):r.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Ae(n);r&&i._deserializeInto(e,t,r)}};t[mh](r,this._context)},t._deserializeFireClass=function(e,t,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(e,t){for(var n=yt(t),i=t.__values__,o=["var prop;"],a=tt.test(Ue(t)),s=0;s<i.length;s++){var c=i[s],l=void 0,u=void 0;Ht.IDENTIFIER_RE.test(c)?(u='"'+c+'"',l="."+c):l="["+(u=Ht.escapeForJS(c))+"]";var h=l;if(n[c+Eh]){var _=n[c+Eh];h=Ht.IDENTIFIER_RE.test(_)?"."+_:"["+Ht.escapeForJS(_)+"]"}o.push("prop=d"+h+";"),o.push('if(typeof prop!=="undefined"){');var f=Ht.getDefault(n[c+Th]);if(a){var p=void 0,d=n[c+"$_$type"];if(void 0===f&&d)p=d instanceof xt;else{var m=typeof f;p="string"===m||"number"===m||"boolean"===m}p?o.push("o"+l+"=prop;"):xh(o,f,l,u,!0)}else o.push('if(typeof prop!=="object"){o'+l+"=prop;}else{"),xh(o,f,l,u,!1),o.push("}");o.push("}")}return(r.js.isChildClassOf(t,r._BaseNode)||r.js.isChildClassOf(t,r.Component))&&o.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(o.push("o._$erialized=JSON.parse(JSON.stringify(d));"),o.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",o.join(""))}(0,n);try{if(n===sh){var o=n.__values__;0!==o.length&&"_$erialized"===o[o.length-1]||(m("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),m("    Error props: ['"+o+"']. Please contact jare."));var a=i;i=function(e,t,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||m("Unable to load previously serialized data. "+JSON.stringify(n))}catch(e){m("Error when checking MissingScript 7, "+e)}a(e,t,n,i)}}}catch(e){m("Error when checking MissingScript 6, "+e)}le(n,"__deserialize__",i,!0)}i(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var o,a=this._serializedData[i];e[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===r.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===r.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==r.Color){if(n===r.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=yt(n),o=n.__values__,a=0;a<o.length;a++){var s=o[a],c=t[s];void 0!==c||t.hasOwnProperty(s)||(c=Ht.getDefault(i[s+Th])),"object"!=typeof c?e[s]=c:c?this._deserializeAndAssignField(e,c,s):e[s]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var l=t.a;e.a=void 0===l?255:l}},e}();bh.pool=new Ch;var Ah=[Fi,gi,Gi,bi,mi,ji,qi,Mi];function wh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var Rh=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},wh,wh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){Mi.fromArray(e,t,1)}],Ih=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function Ph(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=t[c];for(;c<t.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,Bh[u])(e,r,l,t[c])}return r}function Oh(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):w(5303,pe(t)),i}function Dh(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function Mh(e){return function(t,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)e(t,r,o,r[o])}}function Nh(e,t,n,i){t[n]=null,e[8][i]=t}function Lh(e,t,n,i){t[n]=Ph(e,i)}Ih.pool=new ke((function(e){e.reset()}),5),Ih.pool.get=function(){return this._get()||new Ih};var Bh=new Array(13);function Fh(e,t,n){return e||n(t),Object}function zh(e,t,n,i,r,o,a){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||Fh(o,i,a);return t[n]=r,new r}}(n,i,t));s=Fh(o,t,a)}n[i]=s}function Uh(e,t,n,i){for(var r=n||Fe,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?zh(r,s[0],s,0,t,n,i):zh(r,s,o,a,t,n,i)}}function kh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function Gh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,o=!t;if(t=t||Ih.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Hh}return!1}(e)){t.init(e),n=n||{};var a,s=e[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(O(5304,s));n._version=s,n.result=t,e[0]=n,c||(Uh(e,!1,n.classFinder,null!==(a=n.reportMissingClass)&&void 0!==a?a:Gh.reportMissingClass),kh(e)),r.game._isCloning=!0;var l=e[5],u=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],o=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=Ph(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=Oh(e,h,u)}else(0,Bh[l=~l])(e,t,a,u)}return r}(e);r.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,o=3*e[i];r<o;r+=3){var a=e[r],s=t[e[r+2]],c=e[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],l,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],o=e[9],a=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),i=l[u]}else i=function(e,t,n){var i,o=(n=n||{}).classFinder||Fe,a=n.createAssetRefs||ph.platform===hn.EDITOR_CORE,s=n.customEnv,c=n.ignoreEditorOnly,l=null!==(i=n.reportMissingClass)&&void 0!==i?i:r.deserialize.reportMissingClass;t.init();var u=bh.pool.get(t,o,l,s,c);r.game._isCloning=!0;var h=u.deserialize(e);return r.game._isCloning=!1,bh.pool.put(u),a&&t.assignAssetsBy(EditorExtends.serialize.asAsset),h}(e,t,n);return o&&Ih.pool.put(t),i}Bh[0]=function(e,t,n,i){t[n]=i},Bh[1]=Dh,Bh[2]=Mh(Dh),Bh[3]=Mh(Nh),Bh[4]=Lh,Bh[5]=function(e,t,n,i){Rh[i[0]](t[n],i)},Bh[6]=Nh,Bh[7]=function(e,t,n,i){t[n].set(i)},Bh[8]=function(e,t,n,i){var r=new Ah[i[0]];Rh[i[0]](r,i),t[n]=r},Bh[9]=Mh(Lh),Bh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=Oh(e,r,i[1])},Bh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,Bh[s])(e,r,a,c)}},Bh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,Bh[s])(e,r,o,a)}},Gh.Details=Ih,Gh.reportMissingClass=function(e){w(5302,e)};var Hh=function(e){this.preprocessed=!0,this.version=e};function Vh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}r.deserialize=Gh;var jh,Wh,qh,Xh,Yh,Kh,Qh,Zh,Jh,$h,e_,t_=Kt.Flags.Destroyed,n_=Kt.Flags.PersistentMask,i_=[];function r_(e){var t;if(e instanceof Kt){if(e._instantiate)return r.game._isCloning=!0,t=e._instantiate(null,!0),r.game._isCloning=!1,t;if(e instanceof r.Asset)throw new TypeError(O(6903))}return r.game._isCloning=!0,t=o_(e),r.game._isCloning=!1,t}function o_(e,t){var n;a_(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=i_.length;i<r;++i)i_[i]._iN$t=null;return i_.length=0,n}function a_(e,t,n){He.value(e,"_iN$t",t,!0),i_.push(e);var i=e.constructor;if(r.Class._isCCClass(i))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof $e&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||s_(s,i)}else n[a]=s}}(i,e,t,n);else for(var o in e)if(e.hasOwnProperty(o)&&(95!==o.charCodeAt(0)||95!==o.charCodeAt(1)||"__type__"===o||"__prefab"===o)){var a=e[o];if("object"==typeof a&&a){if(a===t)continue;t[o]=a._iN$t||s_(a,n)}else t[o]=a}e instanceof Kt&&(t._objFlags&=n_)}function s_(e,t){if(e instanceof $e)return e.clone();if(e instanceof r.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,i_.push(e);for(var o=0;o<i;++o)n[o]=e[o];return n}if(Array.isArray(e)){var a=e.length;n=new Array(a),e._iN$t=n,i_.push(e);for(var s=0;s<a;++s){var c=e[s];n[s]="object"==typeof c&&c?c._iN$t||s_(c,t):c}return n}if(e._objFlags&t_)return null;var l=e.constructor;if(r.Class._isCCClass(l)){if(t)if(t instanceof r.Component){if(e instanceof r._BaseNode||e instanceof r.Component)return e}else if(t instanceof r._BaseNode)if(e instanceof r._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof r.Component&&e.node&&!e.node.isChildOf(t))return e;n=new l}else if(l===Object)n={};else{if(l)return e;n=Object.create(null)}return a_(e,n,t),n}function c_(e,t){return(t<<3)+e}function l_(e){return h_[e]}function u_(e){switch(e){case $h.Uint8:return Uint8Array;case $h.Uint16:return Uint16Array;case $h.Uint32:return Uint32Array;case $h.Int8:return Int8Array;case $h.Int16:return Int16Array;case $h.Int32:return Int32Array;case $h.Float32:return Float32Array;case $h.Float64:return Float64Array}}r_._clone=o_,r.instantiate=r_,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}($h||($h={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(e_||(e_={})),e("CompactValueTypeArray",al("cc.CompactValueTypeArray")((Zh=Qh=function(){function e(){X(this,"_byteOffset",qh,this),X(this,"_unitCount",Xh,this),X(this,"_unitElement",Yh,this),X(this,"_length",Kh,this)}return e.lengthFor=function(e,t,n){return l_(t).requiredUnits*e.length*u_(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,o,a){for(var s=l_(n),c=u_(i),l=s.requiredUnits*t.length,u=new c(r,o,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=c_(i,n),_._byteOffset=a,_._unitCount=l,_._length=t.length,_},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=l_(n.elementType),o=new(u_(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},e}(),Qh.StorageUnit=$h,Qh.ElementType=e_,qh=Y((Wh=Zh).prototype,"_byteOffset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xh=Y(Wh.prototype,"_unitCount",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yh=Y(Wh.prototype,"_unitElement",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return c_($h.Uint8,e_.Scalar)}}),Kh=Y(Wh.prototype,"_length",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jh=Wh))||jh);var h_=((Jh={})[e_.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},Jh[e_.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new gi(e[2*t],e[2*t+1])}},Jh[e_.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new gi(e[3*t],e[3*t+1],e[3*t+2])}},Jh[e_.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Gi(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Jh[e_.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new bi(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Jh[e_.Mat4]={requiredUnits:16,compress:function(e,t,n){Mi.toArray(e,n,16*t)},decompress:function(e,t){return Mi.fromArray(new Mi,e,16*t)}},Jh);function __(){return 0}function f_(e){return e}function p_(e){return e*e}function d_(e){return e*(2-e)}function m_(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function v_(e){return e*e*e}function g_(e){return--e*e*e+1}function y_(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function S_(e){return e*e*e*e}function x_(e){return 1- --e*e*e*e}function T_(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function E_(e){return e*e*e*e*e}function C_(e){return--e*e*e*e*e+1}function b_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function A_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function w_(e){return Math.sin(e*Math.PI/2)}function R_(e){return.5*(1-Math.cos(Math.PI*e))}function I_(e){return 0===e?0:Math.pow(1024,e-1)}function P_(e){return 1===e?1:1-Math.pow(2,-10*e)}function O_(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function D_(e){return 1-Math.sqrt(1-e*e)}function M_(e){return Math.sqrt(1- --e*e)}function N_(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function L_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function B_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function F_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function z_(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function U_(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function k_(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function G_(e){return 1-H_(1-e)}function H_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function V_(e){return e<.5?.5*G_(2*e):.5*H_(2*e-1)+.5}function j_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function W_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}r._decorator=tu;var q_=nf(p_,d_),X_=nf(v_,g_),Y_=nf(S_,x_),K_=nf(E_,C_),Q_=nf(A_,w_),Z_=nf(I_,P_),J_=nf(D_,M_),$_=nf(L_,B_),ef=nf(z_,U_),tf=nf(G_,H_);function nf(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var rf,of,af=Object.freeze({__proto__:null,constant:__,linear:f_,quadIn:p_,quadOut:d_,quadInOut:m_,cubicIn:v_,cubicOut:g_,cubicInOut:y_,quartIn:S_,quartOut:x_,quartInOut:T_,quintIn:E_,quintOut:C_,quintInOut:b_,sineIn:A_,sineOut:w_,sineInOut:R_,expoIn:I_,expoOut:P_,expoInOut:O_,circIn:D_,circOut:M_,circInOut:N_,elasticIn:L_,elasticOut:B_,elasticInOut:F_,backIn:z_,backOut:U_,backInOut:k_,bounceIn:G_,bounceOut:H_,bounceInOut:V_,smooth:j_,fade:W_,quadOutIn:q_,cubicOutIn:X_,quartOutIn:Y_,quintOutIn:K_,sineOutIn:Q_,expoOutIn:Z_,circOutIn:J_,elasticOutIn:$_,backOutIn:ef,bounceOutIn:tf});e("easing",af),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(of||(of={}));var sf,cf,lf,uf,hf,_f=((rf={})[of.CONSTANT]=__,rf[of.LINEAR]=f_,rf[of.QUAD_IN]=p_,rf[of.QUAD_OUT]=d_,rf[of.QUAD_IN_OUT]=m_,rf[of.QUAD_OUT_IN]=q_,rf[of.CUBIC_IN]=v_,rf[of.CUBIC_OUT]=g_,rf[of.CUBIC_IN_OUT]=y_,rf[of.CUBIC_OUT_IN]=X_,rf[of.QUART_IN]=S_,rf[of.QUART_OUT]=x_,rf[of.QUART_IN_OUT]=T_,rf[of.QUART_OUT_IN]=Y_,rf[of.QUINT_IN]=E_,rf[of.QUINT_OUT]=C_,rf[of.QUINT_IN_OUT]=b_,rf[of.QUINT_OUT_IN]=K_,rf[of.SINE_IN]=A_,rf[of.SINE_OUT]=w_,rf[of.SINE_IN_OUT]=R_,rf[of.SINE_OUT_IN]=Q_,rf[of.EXPO_IN]=I_,rf[of.EXPO_OUT]=P_,rf[of.EXPO_IN_OUT]=O_,rf[of.EXPO_OUT_IN]=Z_,rf[of.CIRC_IN]=D_,rf[of.CIRC_OUT]=M_,rf[of.CIRC_IN_OUT]=N_,rf[of.CIRC_OUT_IN]=J_,rf[of.ELASTIC_IN]=L_,rf[of.ELASTIC_OUT]=B_,rf[of.ELASTIC_IN_OUT]=F_,rf[of.ELASTIC_OUT_IN]=$_,rf[of.BACK_IN]=z_,rf[of.BACK_OUT]=U_,rf[of.BACK_IN_OUT]=k_,rf[of.BACK_OUT_IN]=ef,rf[of.BOUNCE_IN]=G_,rf[of.BOUNCE_OUT]=H_,rf[of.BOUNCE_IN_OUT]=V_,rf[of.BOUNCE_OUT_IN]=tf,rf[of.SMOOTH]=j_,rf[of.FADE]=W_,rf);function ff(e){return _f[e]}var pf,df,mf,vf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).interpolationMode=Yl.LINEAR,t.tangentWeightMode=Ql.NONE,t.value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t.easingMethod=of.LINEAR,t}return z(t,e),t}(eu);function gf(e){var t=new vf;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,o=e.rightTangent,a=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[qt];t.value=null!=r?r:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[qt]=u)}return t}Ht.fastDefine("cc.RealKeyframeValue",vf,{interpolationMode:Yl.LINEAR,tangentWeightMode:Ql.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:of.LINEAR}),Ht.Attr.setClassAttr(vf,qt,"editorOnly",!0),(pf=vf,null!==(mf=(df=pf)[hl])&&void 0!==mf?mf:df[hl]={}).uniquelyReferenced=!0;var yf,Sf=e("RealCurve",al("cc.RealCurve")((hf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",lf,j(t)),X(t,"postExtrapolation",uf,j(t)),t}z(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],o=t[i-1];if(e<r){var a=this.preExtrapolation,s=n[0];if(a===Kl.CLAMP||i<2)return s.value;switch(a){case Kl.LINEAR:return Bf(r,n[0].value,t[1],n[1].value,e);case Kl.LOOP:e=Nf(e,r,o);break;case Kl.PING_PONG:e=Lf(e,r,o);break;default:return s.value}}else if(e>o){var c=this.postExtrapolation,l=n[i-1];if(c===Kl.CLAMP||i<2)return l.value;switch(c){case Kl.LINEAR:return Bf(o,l.value,t[i-2],n[i-2].value,e);case Kl.LOOP:e=Nf(e,r,o);break;case Kl.PING_PONG:e=Lf(e,r,o);break;default:return l.value}}var u=Zc(t,e);if(u>=0)return n[u].value;var h=~u,_=h-1,f=t[_],p=n[_],d=t[h];return function(e,t,n,i,r){var o=n-e;switch(t.interpolationMode){default:case Yl.CONSTANT:return t.value;case Yl.LINEAR:var a=t.easingMethod===of.LINEAR?r:ff(t.easingMethod)(r);return $n(t.value,i.value,a);case Yl.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&Ql.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&Ql.LEFT);if(u||f){var p=0;if(u)p=l;else{var d=o,m=o*c;p=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*p+e,y=Math.sin(v)*p+t.value,S=0;if(f)S=_;else{var x=o,T=o*h;S=Math.sqrt(x*x+T*T)*s}var E=Math.atan(h),C=(g-e)/o,b=(-Math.cos(E)*S+n-e)/o,A=y,w=-Math.sin(E)*S+i.value,R=[0,0,0],I=function(e,t,n,i,r){var o=n/i,a=t/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+e/i),u=c*c*c,h=l*l+u,_=0;if($l(h)){if($l(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var p=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(p),r[1]=-d*Math.cos(p+Math.PI/3),r[2]=-d*Math.cos(p-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,S=0;S<_;++S)r[S]-=y;return _}(0-r,3*C,3*b-6*C,3*(C-b)+1,R),P=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var o=e[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(R,I,r);return Ff(t.value,A,w,i.value,P)}var O=t.value+s*c*o,D=i.value-s*h*o;return Ff(t.value,O,D,i.value,r)}}(f,p,d,n[h],(e-f)/(d-f))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,gf(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return gf(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return gf(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return Qn(n.value,t,e)}))},n[dh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+xf+xf+Tf+Ef*r+Of*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=xf,o.setUint8(a,this.postExtrapolation),a+=xf,o.setUint32(a,r,!0),a+=Tf,n.forEach((function(e,t){return o.setFloat32(a+Ef*t,e,!0)})),a+=Ef*r;for(var s,c=q(i);!(s=c()).done;){var l=s.value;a=Df(o,l,a)}var u=new Uint8Array(o.buffer,0,a);e.writeProperty("bytes",u);var h=i.map((function(e){return e[qt]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[mh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=xf,this.postExtrapolation=i.getUint8(r),r+=xf;var o=i.getUint32(r,!0);r+=Tf;var a=Array.from({length:o},(function(e,t){return i.getFloat32(r+Ef*t,!0)}));r+=Ef*o;for(var s=new Array(o),c=0;c<o;++c){var l=gf({});r=Mf(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][qt]=e}))),this._times=a,this._values=s}else e.readThis()},t}(Jl),lf=Y((cf=hf).prototype,"preExtrapolation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kl.CLAMP}}),uf=Y(cf.prototype,"postExtrapolation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kl.CLAMP}}),sf=cf))||sf);!function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(yf||(yf={}));var xf=1,Tf=4,Ef=4,Cf=gf({}),bf=Cf.interpolationMode,Af=Cf.tangentWeightMode,wf=Cf.leftTangent,Rf=Cf.leftTangentWeight,If=Cf.rightTangent,Pf=Cf.rightTangentWeight,Of=26;function Df(e,t,n){var i=0,r=n,o=r;r+=4;var a=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,s!==bf&&(i|=yf.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==Af&&(i|=yf.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==wf&&(i|=yf.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),_!==Rf&&(i|=yf.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),l!==If&&(i|=yf.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==Pf&&(i|=yf.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=f<<8,e.setUint32(o,i,!0),r}function Mf(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&yf.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&yf.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&yf.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&yf.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&yf.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&yf.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return t.easingMethod=o,i}function Nf(e,t,n){return t+li(e-t,n-t)}function Lf(e,t,n){return t+ui(e-t,n-t)}function Bf(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function Ff(e,t,n,i,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*n+r*r*r*i}function zf(e,t,n,i,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}r.bezier=zf;var Uf,kf,Gf,Hf,Vf,jf,Wf,qf,Xf,Yf,Kf,Qf=Math.cos,Zf=Math.acos,Jf=Math.max,$f=2*Math.PI,ep=Math.sqrt;function tp(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function np(e,t){var n=function(e,t){var n,i,r,o,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,p=f*_,d=(-c+l)*h,m=(3*d-f*f)*_,v=m*_,g=(2*f*f*f-9*f*d+a*h*27)/27,y=g/2,S=y*y+v*v*v;if(S<0){var x=-m*_,T=ep(x*x*x),E=-g/(2*T),C=Zf(E<-1?-1:E>1?1:E),b=2*tp(T);return i=b*Qf(C*_)-p,r=b*Qf((C+$f)*_)-p,o=b*Qf((C+2*$f)*_)-p,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Jf(i,r,o):Jf(i,r):o>=0&&o<=1?Jf(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Jf(r,o):r:o}if(0===S)return r=-(n=y<0?tp(-y):-tp(y))-p,(i=2*n-p)>=0&&i<=1?r>=0&&r<=1?Jf(i,r):i:r;var A=ep(S);return(n=tp(-y+A))-tp(y+A)-p}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}r.bezierByTime=np,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(Kf||(Kf=e("QuatInterpolationMode",{})));var ip=al("cc.QuatKeyframeValue")(Uf=ml((Gf=Y((kf=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;X(this,"interpolationMode",Gf,this),X(this,"value",Hf,this),X(this,"easingMethod",Vf,this),this.value=n?bi.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kf.SLERP}}),Hf=Y(kf.prototype,"value",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bi.clone(bi.IDENTITY)}}),Vf=Y(kf.prototype,"easingMethod",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return of.LINEAR}}),Uf=kf))||Uf)||Uf;function rp(e){return new ip(e)}var op,ap=e("QuatCurve",al("cc.QuatCurve")((Yf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",qf,j(t)),X(t,"postExtrapolation",Xf,j(t)),t}z(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new bi);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(a){case Kl.LOOP:e=c+li(e-c,l-c);break;case Kl.PING_PONG:e=c+ui(e-c,l-c);break;case Kl.CLAMP:default:return bi.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(o){case Kl.LOOP:e=c+li(e-c,l-c);break;case Kl.PING_PONG:e=c+ui(e-c,l-c);break;case Kl.CLAMP:default:return bi.copy(t,h.value)}}var _=Zc(i,e);if(_>=0)return bi.copy(t,r[_].value);var f=~_,p=f-1,d=i[p],m=r[p],v=i[f],g=r[f],y=(e-d)/(v-d);switch(m.interpolationMode){default:case Kf.CONSTANT:return bi.copy(t,m.value);case Kf.SLERP:var S=m.easingMethod,x=S===of.LINEAR?y:Array.isArray(S)?np(S,y):ff(S)(y);return bi.slerp(t,m.value,g.value,x)}},n.addKeyFrame=function(t,n){var i=new ip(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return rp(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return rp(e[1])})))}},n[dh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=vp*(r?1:o),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?gp+4*Sp:gp)}),0),c=0,l=new DataView(new ArrayBuffer(c+=fp+pp+dp*o+4*mp*o+s+a+0)),u=0,h=0;r&&(h|=op.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=fp,l.setUint32(u,o,!0),u+=pp,n.forEach((function(e,t){return l.setFloat32(u+dp*t,e,!0)})),u+=dp*o,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*mp*t;l.setFloat32(s+0*mp,i,!0),l.setFloat32(s+1*mp,r,!0),l.setFloat32(s+2*mp,o,!0),l.setFloat32(s+3*mp,a,!0)})),u+=4*mp*o,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,yp),++u,l.setFloat32(u+0*Sp,t[0],!0),l.setFloat32(u+1*Sp,t[1],!0),l.setFloat32(u+2*Sp,t[2],!0),l.setFloat32(u+3*Sp,t[3],!0),u+=4*Sp):(l.setUint8(u,t),++u)}));var _=u;u+=a;var f=_;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(f,t),r||(f+=vp)}));var p=new Uint8Array(l.buffer);e.writeProperty("bytes",p)}else e.writeThis()},n[mh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=fp;var a=o&op.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=pp;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+dp*t,!0)})),l=r+=dp*s;r+=4*mp*s;var u=Array.from({length:s},(function(e,t){var n=l+4*mp*t,o=i.getFloat32(n+0*mp,!0),a=i.getFloat32(n+1*mp,!0),s=i.getFloat32(n+2*mp,!0),c=i.getFloat32(n+3*mp,!0),u=i.getUint8(r);++r;var h=rp({value:{x:o,y:a,z:s,w:c}});return u!==yp?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*Sp,!0),i.getFloat32(r+1*Sp,!0),i.getFloat32(r+2*Sp,!0),i.getFloat32(r+3*Sp,!0)],r+=4*Sp),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var p=i.getUint8(r+f);u[f].interpolationMode=p}r+=s}this._times=c,this._values=u}else e.readThis()},t}(Jl),qf=Y((Wf=Yf).prototype,"preExtrapolation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kl.CLAMP}}),Xf=Y(Wf.prototype,"postExtrapolation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kl.CLAMP}}),jf=Wf))||jf);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(op||(op={}));var sp,cp,lp,up,hp,_p,fp=1,pp=4,dp=4,mp=4,vp=1,gp=1,yp=255,Sp=4,xp=e("ObjectCurve",al("cc.ObjectCurve")(sp=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=Zn(~t-1,0,this._values.length-1);return this._values[n]},t}(Jl))||sp),Tp=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Ht.fastDefine("cc.Keyframe",Tp,{time:0,value:0,inTangent:0,outTangent:0});var Ep=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),Cp=al("cc.AnimationCurve")((_p=hp=function(){function e(e){if(void 0===e&&(e=null),X(this,"_curve",up,this),this.cachedKey=void 0,e instanceof Sf)this._curve=e;else{var t=new Sf;this._curve=t,t.preExtrapolation=Kl.LOOP,t.postExtrapolation=Kl.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:Yl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:Yl.CUBIC,value:1}],[1,{interpolationMode:Yl.CUBIC,value:1}]])}this.cachedKey=new Ep}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:Yl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,o=e<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case Kl.LOOP:r=li(e-a,s-a)+a;break;case Kl.PING_PONG:r=ui(e-a,s-a)+a;break;case Kl.CLAMP:default:r=Zn(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(t),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,_=l-a,f=1/(h*h),p=s*h,d=u*h;e.coefficient[0]=(p+d-_-_)*f/h,e.coefficient[1]=(_+_+_-p-p-d)*f,e.coefficient[2]=s,e.coefficient[3]=a},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},B(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new Tp;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:Yl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return Ap(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=bp(e)}},{key:"postWrapMode",get:function(){return Ap(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=bp(e)}}]),e}(),hp.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],up=Y((lp=_p).prototype,"_curve",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cp=lp))||cp;function bp(e){switch(e){default:case jc.Default:case jc.Normal:case jc.Clamp:return Kl.CLAMP;case jc.PingPong:return Kl.PING_PONG;case jc.Loop:return Kl.LOOP}}function Ap(e){switch(e){default:case Kl.LINEAR:case Kl.CLAMP:return jc.Clamp;case Kl.PING_PONG:return jc.PingPong;case Kl.LOOP:return jc.Loop}}function wp(){var e=new Sf;return e.assignSorted([[0,{interpolationMode:Yl.CUBIC,value:1}],[1,{interpolationMode:Yl.CUBIC,value:1}]]),e}function Rp(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}Fn(ic,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Ip=function(e){function t(){var t;return t=e.call(this)||this,Rp("line","Line"),t}return z(t,e),t}(_r),Pp=function(e){function t(){var t;return t=e.call(this)||this,Rp("plane","Plane"),t}return z(t,e),t}(dc),Op=function(e){function t(){var t;return t=e.call(this)||this,Rp("ray","Ray"),t}return z(t,e),t}(fr),Dp=function(e){function t(){var t;return t=e.call(this)||this,Rp("triangle","Triangle"),t}return z(t,e),t}(so),Mp=function(e){function t(){var t;return t=e.call(this)||this,Rp("sphere","Sphere"),t}return z(t,e),t}(ao),Np=function(e){function t(){var t;return t=e.call(this)||this,Rp("aabb","AABB"),t}return z(t,e),t}(Fc),Lp=function(e){function t(){var t;return t=e.call(this)||this,Rp("obb","OBB"),t}return z(t,e),t}(Gc),Bp=function(e){function t(){var t;return t=e.call(this)||this,Rp("capsule","Capsule"),t}return z(t,e),t}(Hc),Fp=function(e){function t(){var t;return t=e.call(this)||this,Rp("frustum","Frustum"),t}return z(t,e),t}(Kc),zp=Object.freeze({__proto__:null,distance:ur,enums:hr,intersect:ic,Line:_r,Plane:dc,Ray:fr,Triangle:so,Sphere:ao,AABB:Fc,OBB:Gc,Capsule:Hc,Frustum:Kc,Keyframe:Tp,AnimationCurve:Cp,get ERaycastMode(){return Za},line:Ip,plane:Pp,ray:Op,triangle:Dp,sphere:Mp,aabb:Np,obb:Lp,capsule:Bp,frustum:Fp});e("geometry",zp);var Up={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},kp=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=q(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],O(2104,t),e.Enum[t]=i,He.value(e.Enum,String(i),t),e.BitMask[t]=i,He.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):Dn(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());kp.Enum=Ke(Up),kp.BitMask=Ye(F({},Up)),r.Layers=kp;var Gp,Hp,Vp="MainFlow",jp="ForwardFlow",Wp="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Gp||(Gp={})),r.RenderPassStage=Gp,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Hp||(Hp={}));var qp,Xp={bindings:[],layouts:{}},Yp={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(qp||(qp={}));var Kp,Qp=qp.SAMPLER_SHADOWMAP,Zp=qp.COUNT-Qp;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(Kp||(Kp={}));var Jp,$p=Kp.SAMPLER_JOINTS,ed=Kp.COUNT-$p;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Jp||(Jp={}));var td=new Eo;td.bufferOffsets=[0,Qp+$p,Qp],td.samplerOffsets=[-Qp,Zp+ed,Zp-$p],td.flexibleSet=1;var nd=function(){};nd.SIZE=4*(nd.COUNT=4+(nd.SCREEN_SIZE_OFFSET=4+(nd.NATIVE_SIZE_OFFSET=4+(nd.TIME_OFFSET=0)))),nd.NAME="CCGlobal",nd.BINDING=qp.UBO_GLOBAL,nd.DESCRIPTOR=new ea(nd.BINDING,to.UNIFORM_BUFFER,1,Vr.ALL),nd.LAYOUT=new Lo(Jp.GLOBAL,nd.BINDING,nd.NAME,[new No("cc_time",Ar.FLOAT4,1),new No("cc_screenSize",Ar.FLOAT4,1),new No("cc_nativeSize",Ar.FLOAT4,1)],1),Xp.layouts[nd.NAME]=nd.LAYOUT,Xp.bindings[nd.BINDING]=nd.DESCRIPTOR;var id=function(){};id.SIZE=4*(id.COUNT=4+(id.VIEW_PORT_OFFSET=4+(id.NEAR_FAR_OFFSET=4+(id.GLOBAL_FOG_ADD_OFFSET=4+(id.GLOBAL_FOG_BASE_OFFSET=4+(id.GLOBAL_FOG_COLOR_OFFSET=4+(id.AMBIENT_GROUND_OFFSET=4+(id.AMBIENT_SKY_OFFSET=4+(id.MAIN_LIT_COLOR_OFFSET=4+(id.MAIN_LIT_DIR_OFFSET=4+(id.EXPOSURE_OFFSET=4+(id.SCREEN_SCALE_OFFSET=4+(id.CAMERA_POS_OFFSET=16+(id.MAT_VIEW_PROJ_INV_OFFSET=16+(id.MAT_VIEW_PROJ_OFFSET=16+(id.MAT_PROJ_INV_OFFSET=16+(id.MAT_PROJ_OFFSET=16+(id.MAT_VIEW_INV_OFFSET=16+(id.MAT_VIEW_OFFSET=0))))))))))))))))))),id.NAME="CCCamera",id.BINDING=qp.UBO_CAMERA,id.DESCRIPTOR=new ea(id.BINDING,to.UNIFORM_BUFFER,1,Vr.ALL),id.LAYOUT=new Lo(Jp.GLOBAL,id.BINDING,id.NAME,[new No("cc_matView",Ar.MAT4,1),new No("cc_matViewInv",Ar.MAT4,1),new No("cc_matProj",Ar.MAT4,1),new No("cc_matProjInv",Ar.MAT4,1),new No("cc_matViewProj",Ar.MAT4,1),new No("cc_matViewProjInv",Ar.MAT4,1),new No("cc_cameraPos",Ar.FLOAT4,1),new No("cc_screenScale",Ar.FLOAT4,1),new No("cc_exposure",Ar.FLOAT4,1),new No("cc_mainLitDir",Ar.FLOAT4,1),new No("cc_mainLitColor",Ar.FLOAT4,1),new No("cc_ambientSky",Ar.FLOAT4,1),new No("cc_ambientGround",Ar.FLOAT4,1),new No("cc_fogColor",Ar.FLOAT4,1),new No("cc_fogBase",Ar.FLOAT4,1),new No("cc_fogAdd",Ar.FLOAT4,1),new No("cc_nearFar",Ar.FLOAT4,1),new No("cc_viewPort",Ar.FLOAT4,1)],1),Xp.layouts[id.NAME]=id.LAYOUT,Xp.bindings[id.BINDING]=id.DESCRIPTOR;var rd=function(){};rd.SIZE=4*(rd.COUNT=4+(rd.SHADOW_COLOR_OFFSET=4+(rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(rd.SHADOW_PROJ_INFO_OFFSET=4+(rd.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(rd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(rd.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(rd.MAT_LIGHT_VIEW_OFFSET=16+(rd.MAT_LIGHT_PLANE_PROJ_OFFSET=0))))))))))),rd.NAME="CCShadow",rd.BINDING=qp.UBO_SHADOW,rd.DESCRIPTOR=new ea(rd.BINDING,to.UNIFORM_BUFFER,1,Vr.ALL),rd.LAYOUT=new Lo(Jp.GLOBAL,rd.BINDING,rd.NAME,[new No("cc_matLightPlaneProj",Ar.MAT4,1),new No("cc_matLightView",Ar.MAT4,1),new No("cc_matLightViewProj",Ar.MAT4,1),new No("cc_shadowInvProjDepthInfo",Ar.FLOAT4,1),new No("cc_shadowProjDepthInfo",Ar.FLOAT4,1),new No("cc_shadowProjInfo",Ar.FLOAT4,1),new No("cc_shadowNFLSInfo",Ar.FLOAT4,1),new No("cc_shadowWHPBInfo",Ar.FLOAT4,1),new No("cc_shadowLPNNInfo",Ar.FLOAT4,1),new No("cc_shadowColor",Ar.FLOAT4,1)],1),Xp.layouts[rd.NAME]=rd.LAYOUT,Xp.bindings[rd.BINDING]=rd.DESCRIPTOR;var od=qp.SAMPLER_SHADOWMAP,ad=new ea(od,to.SAMPLER_TEXTURE,1,Vr.FRAGMENT),sd=new Bo(Jp.GLOBAL,od,"cc_shadowMap",Ar.SAMPLER2D,1);Xp.layouts.cc_shadowMap=sd,Xp.bindings[od]=ad;var cd=qp.SAMPLER_ENVIRONMENT,ld=new ea(cd,to.SAMPLER_TEXTURE,1,Vr.FRAGMENT),ud=new Bo(Jp.GLOBAL,cd,"cc_environment",Ar.SAMPLER_CUBE,1);Xp.layouts.cc_environment=ud,Xp.bindings[cd]=ld;var hd=qp.SAMPLER_DIFFUSEMAP,_d=new ea(hd,to.SAMPLER_TEXTURE,1,Vr.FRAGMENT),fd=new Bo(Jp.GLOBAL,hd,"cc_diffuseMap",Ar.SAMPLER_CUBE,1);Xp.layouts.cc_diffuseMap=fd,Xp.bindings[hd]=_d;var pd=qp.SAMPLER_SPOT_LIGHTING_MAP,dd=new ea(pd,to.SAMPLER_TEXTURE,1,Vr.FRAGMENT),md=new Bo(Jp.GLOBAL,pd,"cc_spotLightingMap",Ar.SAMPLER2D,1);Xp.layouts.cc_spotLightingMap=md,Xp.bindings[pd]=dd;var vd=function(){};vd.SIZE=4*(vd.COUNT=4+(vd.LIGHTINGMAP_UVPARAM=16+(vd.MAT_WORLD_IT_OFFSET=16+(vd.MAT_WORLD_OFFSET=0)))),vd.NAME="CCLocal",vd.BINDING=Kp.UBO_LOCAL,vd.DESCRIPTOR=new ea(vd.BINDING,to.UNIFORM_BUFFER,1,Vr.VERTEX|Vr.COMPUTE),vd.LAYOUT=new Lo(Jp.LOCAL,vd.BINDING,vd.NAME,[new No("cc_matWorld",Ar.MAT4,1),new No("cc_matWorldIT",Ar.MAT4,1),new No("cc_lightingMapUVParam",Ar.FLOAT4,1)],1),Yp.layouts[vd.NAME]=vd.LAYOUT,Yp.bindings[vd.BINDING]=vd.DESCRIPTOR;var gd=function(){};gd.SIZE=4*(gd.COUNT=4+(gd.WORLD_BOUND_HALF_EXTENTS=4+(gd.WORLD_BOUND_CENTER=0))),gd.NAME="CCWorldBound",gd.BINDING=Kp.UBO_LOCAL,gd.DESCRIPTOR=new ea(gd.BINDING,to.UNIFORM_BUFFER,1,Vr.VERTEX|Vr.COMPUTE),gd.LAYOUT=new Lo(Jp.LOCAL,gd.BINDING,gd.NAME,[new No("cc_worldBoundCenter",Ar.FLOAT4,1),new No("cc_worldBoundHalfExtents",Ar.FLOAT4,1)],1),Yp.layouts[gd.NAME]=gd.LAYOUT,Yp.bindings[gd.BINDING]=gd.DESCRIPTOR;var yd="a_matWorld0",Sd=function(){};Sd.BATCHING_COUNT=10,Sd.MAT_WORLDS_OFFSET=0,Sd.SIZE=4*(Sd.COUNT=16*Sd.BATCHING_COUNT),Sd.NAME="CCLocalBatched",Sd.BINDING=Kp.UBO_LOCAL,Sd.DESCRIPTOR=new ea(Sd.BINDING,to.UNIFORM_BUFFER,1,Vr.VERTEX|Vr.COMPUTE),Sd.LAYOUT=new Lo(Jp.LOCAL,Sd.BINDING,Sd.NAME,[new No("cc_matWorlds",Ar.MAT4,Sd.BATCHING_COUNT)],1),Yp.layouts[Sd.NAME]=Sd.LAYOUT,Yp.bindings[Sd.BINDING]=Sd.DESCRIPTOR;var xd=function(){};xd.LIGHTS_PER_PASS=1,xd.SIZE=4*(xd.COUNT=(xd.LIGHT_DIR_OFFSET=(xd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(xd.LIGHT_COLOR_OFFSET=(xd.LIGHT_POS_OFFSET=0)+4*xd.LIGHTS_PER_PASS)+4*xd.LIGHTS_PER_PASS)+4*xd.LIGHTS_PER_PASS)+4*xd.LIGHTS_PER_PASS),xd.NAME="CCForwardLight",xd.BINDING=Kp.UBO_FORWARD_LIGHTS,xd.DESCRIPTOR=new ea(xd.BINDING,to.DYNAMIC_UNIFORM_BUFFER,1,Vr.FRAGMENT),xd.LAYOUT=new Lo(Jp.LOCAL,xd.BINDING,xd.NAME,[new No("cc_lightPos",Ar.FLOAT4,xd.LIGHTS_PER_PASS),new No("cc_lightColor",Ar.FLOAT4,xd.LIGHTS_PER_PASS),new No("cc_lightSizeRangeAngle",Ar.FLOAT4,xd.LIGHTS_PER_PASS),new No("cc_lightDir",Ar.FLOAT4,xd.LIGHTS_PER_PASS)],1),Yp.layouts[xd.NAME]=xd.LAYOUT,Yp.bindings[xd.BINDING]=xd.DESCRIPTOR;var Td=function(){};Td.LIGHTS_PER_PASS=10;var Ed=function(){};Ed.SIZE=4*(Ed.COUNT=4+(Ed.JOINTS_TEXTURE_INFO_OFFSET=0)),Ed.NAME="CCSkinningTexture",Ed.BINDING=Kp.UBO_SKINNING_TEXTURE,Ed.DESCRIPTOR=new ea(Ed.BINDING,to.UNIFORM_BUFFER,1,Vr.VERTEX),Ed.LAYOUT=new Lo(Jp.LOCAL,Ed.BINDING,Ed.NAME,[new No("cc_jointTextureInfo",Ar.FLOAT4,1)],1),Yp.layouts[Ed.NAME]=Ed.LAYOUT,Yp.bindings[Ed.BINDING]=Ed.DESCRIPTOR;var Cd=function(){};Cd.SIZE=4*(Cd.COUNT=4+(Cd.JOINTS_ANIM_INFO_OFFSET=0)),Cd.NAME="CCSkinningAnimation",Cd.BINDING=Kp.UBO_SKINNING_ANIMATION,Cd.DESCRIPTOR=new ea(Cd.BINDING,to.UNIFORM_BUFFER,1,Vr.VERTEX),Cd.LAYOUT=new Lo(Jp.LOCAL,Cd.BINDING,Cd.NAME,[new No("cc_jointAnimInfo",Ar.FLOAT4,1)],1),Yp.layouts[Cd.NAME]=Cd.LAYOUT,Yp.bindings[Cd.BINDING]=Cd.DESCRIPTOR;var bd="a_jointAnimInfo",Ad=function(){};Ad.SIZE=4*(Ad.COUNT=360+(Ad.JOINTS_OFFSET=0)),Ad.NAME="CCSkinning",Ad.BINDING=Kp.UBO_SKINNING_TEXTURE,Ad.DESCRIPTOR=new ea(Ad.BINDING,to.UNIFORM_BUFFER,1,Vr.VERTEX),Ad.LAYOUT=new Lo(Jp.LOCAL,Ad.BINDING,Ad.NAME,[new No("cc_joints",Ar.FLOAT4,90)],1),Yp.layouts[Ad.NAME]=Ad.LAYOUT,Yp.bindings[Ad.BINDING]=Ad.DESCRIPTOR;var wd=function(){};wd.MAX_MORPH_TARGET_COUNT=60,wd.OFFSET_OF_WEIGHTS=0,wd.OFFSET_OF_VERTICES_COUNT=4+(wd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(wd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*wd.MAX_MORPH_TARGET_COUNT)),wd.COUNT_BASE_4_BYTES=4*Math.ceil(wd.MAX_MORPH_TARGET_COUNT/4)+4,wd.SIZE=4*wd.COUNT_BASE_4_BYTES,wd.NAME="CCMorph",wd.BINDING=Kp.UBO_MORPH,wd.DESCRIPTOR=new ea(wd.BINDING,to.UNIFORM_BUFFER,1,Vr.VERTEX),wd.LAYOUT=new Lo(Jp.LOCAL,wd.BINDING,wd.NAME,[new No("cc_displacementWeights",Ar.FLOAT4,wd.MAX_MORPH_TARGET_COUNT/4),new No("cc_displacementTextureInfo",Ar.FLOAT4,1)],1),Yp.layouts[wd.NAME]=wd.LAYOUT,Yp.bindings[wd.BINDING]=wd.DESCRIPTOR;var Rd=function(){};Rd.NAME="CCUILocal",Rd.BINDING=Kp.UBO_UI_LOCAL,Rd.DESCRIPTOR=new ea(Rd.BINDING,to.DYNAMIC_UNIFORM_BUFFER,1,Vr.VERTEX),Rd.LAYOUT=new Lo(Jp.LOCAL,Rd.BINDING,Rd.NAME,[new No("cc_local_data",Ar.FLOAT4,1)],1),Yp.layouts[Rd.NAME]=Rd.LAYOUT,Yp.bindings[Rd.BINDING]=Rd.DESCRIPTOR;var Id=Kp.SAMPLER_JOINTS,Pd=new ea(Id,to.SAMPLER_TEXTURE,1,Vr.VERTEX),Od=new Bo(Jp.LOCAL,Id,"cc_jointTexture",Ar.SAMPLER2D,1);Yp.layouts.cc_jointTexture=Od,Yp.bindings[Id]=Pd;var Dd=Kp.SAMPLER_MORPH_POSITION,Md=new ea(Dd,to.SAMPLER_TEXTURE,1,Vr.VERTEX),Nd=new Bo(Jp.LOCAL,Dd,"cc_PositionDisplacements",Ar.SAMPLER2D,1);Yp.layouts.cc_PositionDisplacements=Nd,Yp.bindings[Dd]=Md;var Ld=Kp.SAMPLER_MORPH_NORMAL,Bd=new ea(Ld,to.SAMPLER_TEXTURE,1,Vr.VERTEX),Fd=new Bo(Jp.LOCAL,Ld,"cc_NormalDisplacements",Ar.SAMPLER2D,1);Yp.layouts.cc_NormalDisplacements=Fd,Yp.bindings[Ld]=Bd;var zd=Kp.SAMPLER_MORPH_TANGENT,Ud=new ea(zd,to.SAMPLER_TEXTURE,1,Vr.VERTEX),kd=new Bo(Jp.LOCAL,zd,"cc_TangentDisplacements",Ar.SAMPLER2D,1);Yp.layouts.cc_TangentDisplacements=kd,Yp.bindings[zd]=Ud;var Gd=Kp.SAMPLER_LIGHTMAP,Hd=new ea(Gd,to.SAMPLER_TEXTURE,1,Vr.FRAGMENT),Vd=new Bo(Jp.LOCAL,Gd,"cc_lightingMap",Ar.SAMPLER2D,1);Yp.layouts.cc_lightingMap=Vd,Yp.bindings[Gd]=Hd;var jd=Kp.SAMPLER_SPRITE,Wd=new ea(jd,to.SAMPLER_TEXTURE,1,Vr.FRAGMENT),qd=new Bo(Jp.LOCAL,jd,"cc_spriteTexture",Ar.SAMPLER2D,1);Yp.layouts.cc_spriteTexture=qd,Yp.bindings[jd]=Wd;var Xd=Kp.SAMPLER_REFLECTION,Yd=new ea(Xd,to.SAMPLER_TEXTURE,1,Vr.FRAGMENT),Kd=new Bo(Jp.LOCAL,Xd,"cc_reflectionTexture",Ar.SAMPLER2D,1);Yp.layouts.cc_reflectionTexture=Kd,Yp.bindings[Xd]=Yd;var Qd=Kp.STORAGE_REFLECTION,Zd=new ea(Qd,to.STORAGE_IMAGE,1,Vr.COMPUTE),Jd=new Uo(Jp.LOCAL,Qd,"cc_reflectionStorage",Ar.IMAGE2D,1);Yp.layouts.cc_reflectionStorage=Jd,Yp.bindings[Qd]=Zd;var $d,em,tm,nm,im,rm=kp.makeMaskExclude([kp.BitMask.UI_2D,kp.BitMask.GIZMOS,kp.BitMask.EDITOR,kp.BitMask.SCENE_GIZMO,kp.BitMask.PROFILER]),om=kp.makeMaskExclude([kp.BitMask.UI_2D,kp.BitMask.PROFILER]),am=kp.Enum.ALL;function sm(e){return e.hasFeature(Er.COLOR_FLOAT)&&e.hasFeature(Er.TEXTURE_FLOAT)&&!(e.gfxAPI===xr.WEBGL)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Vp,PIPELINE_FLOW_FORWARD:jp,PIPELINE_FLOW_SHADOW:Wp,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Gp},get RenderPriority(){return Hp},globalDescriptorSetLayout:Xp,localDescriptorSetLayout:Yp,get PipelineGlobalBindings(){return qp},get ModelLocalBindings(){return Kp},get SetIndex(){return Jp},bindingMappingInfo:td,UBOGlobal:nd,UBOCamera:id,UBOShadow:rd,UNIFORM_SHADOWMAP_BINDING:od,UNIFORM_ENVIRONMENT_BINDING:cd,UNIFORM_DIFFUSEMAP_BINDING:hd,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:pd,UBOLocal:vd,UBOWorldBound:gd,INST_MAT_WORLD:yd,UBOLocalBatched:Sd,UBOForwardLight:xd,UBODeferredLight:Td,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Ed,UBOSkinningAnimation:Cd,INST_JOINT_ANIM_INFO:bd,UBOSkinning:Ad,UBOMorph:wd,UBOUILocal:Rd,UNIFORM_JOINT_TEXTURE_BINDING:Id,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Dd,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Ld,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:zd,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Gd,UNIFORM_SPRITE_TEXTURE_BINDING:jd,UNIFORM_REFLECTION_TEXTURE_BINDING:Xd,UNIFORM_REFLECTION_STORAGE_BINDING:Qd,CAMERA_DEFAULT_MASK:rm,CAMERA_EDITOR_MASK:om,MODEL_ALWAYS_MASK:am,supportsHalfFloatTexture:function(e){return e.hasFeature(Er.COLOR_HALF_FLOAT)&&e.hasFeature(Er.TEXTURE_HALF_FLOAT)&&!(e.gfxAPI===xr.WEBGL)},supportsFloatTexture:sm})),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}($d||($d={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(em||(em={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(tm||(tm={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(nm||(nm={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(im||(im={}));var cm,lm,um,hm,_m,fm,pm,dm=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],mm=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],vm=[100,200,400,800],gm=new gi,ym=new gi,Sm=new Mi,xm=oo.STENCIL<<1,Tm=[],Em=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=$d.VERTICAL,this._fov=ei(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new To(.2,.2,.2,1),this._viewport=new qi(0,0,1,1),this._orientedViewport=new qi(0,0,1,1),this._curTransform=Tr.IDENTITY,this._isProjDirty=!0,this._matView=new Mi,this._matProj=new Mi,this._matProjInv=new Mi,this._matViewProj=new Mi,this._matViewProjInv=new Mi,this._frustum=new Kc,this._forward=new gi,this._position=new gi,this._priority=0,this._aperture=tm.F16_0,this._apertureValue=void 0,this._shutter=im.D125,this._shutterValue=0,this._iso=nm.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=oo.NONE,this._clearDepth=1,this._visibility=rm,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=dm[this._aperture],this._shutterValue=mm[this._shutter],this._isoValue=vm[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!Tm.length){var t=e.capabilities.clipSpaceSignY;Tm[Tr.IDENTITY]=new Mi(1,0,0,0,0,t),Tm[Tr.ROTATE_90]=new Mi(0,1,0,0,-t,0),Tm[Tr.ROTATE_180]=new Mi(-1,0,0,0,0,-t),Tm[Tr.ROTATE_270]=new Mi(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||Tr.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=oo.NONE,this.clearDepth=1,this.visibility=rm,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t._destroy=function(){},t.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(Mi.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||Tr.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===em.PERSPECTIVE)Mi.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===$d.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Mi.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Mi.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Mi.multiply(this._matViewProj,this._matProj,this._matView),Mi.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,o=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||Tr.IDENTITY){case Tr.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case Tr.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case Tr.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case Tr.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||r.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||Tr.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===em.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Di[this._curTransform];gi.set(gm,(t-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=gm.x,f=gm.y;return gm.x=_*h[0]+f*h[2]*u,gm.y=_*h[1]+f*h[3]*u,gi.transformMat4(l?gm:e.o,gm,this._matViewProjInv),l?(this._node.getWorldPosition(ym),fr.fromPoints(e,ym,gm)):gi.transformQuat(e.d,gi.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Di[this._curTransform];if(this._proj===em.PERSPECTIVE){gi.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,gi.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(gm),gi.lerp(e,gm,e,$n(this._nearClip/this._farClip,1,t.z))}else{gi.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*l[0]+f*l[2]*c,e.y=_*l[1]+f*l[3]*c,gi.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=Di[this._curTransform];gi.transformMat4(e,t,this._matViewProj);var r=e.x,o=e.y;e.x=r*i[0]+o*i[2]*n,e.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){Mi.multiply(e,this._matViewProj,t),Mi.multiply(e,Tm[this._curTransform],e);var r=n/2,o=i/2;return Mi.identity(Sm),Mi.transform(Sm,Sm,gi.set(gm,r,o,0)),Mi.scale(Sm,Sm,gi.set(gm,r,o,1)),Mi.multiply(e,Sm,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},B(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){b(8302),this.setViewportInOrientedSpace(e)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=dm[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=mm[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=vm[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),Cm=1024;function bm(e){return!!(r.sys.hasFeature(r.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}!function(e){e[e.RGB565=Cr.R5G6B5]="RGB565",e[e.RGB5A1=Cr.RGB5A1]="RGB5A1",e[e.RGBA4444=Cr.RGBA4]="RGBA4444",e[e.RGB888=Cr.RGB8]="RGB888",e[e.RGB32F=Cr.RGB32F]="RGB32F",e[e.RGBA8888=Cr.RGBA8]="RGBA8888",e[e.RGBA32F=Cr.RGBA32F]="RGBA32F",e[e.A8=Cr.A8]="A8",e[e.I8=Cr.L8]="I8",e[e.AI8=Cr.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Cr.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Cr.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Cm++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Cr.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Cr.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Cm++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Cr.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Cm++]="RGBA_ETC1",e[e.RGB_ETC2=Cr.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Cr.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Cr.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Cr.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Cr.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Cr.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Cr.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Cr.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Cr.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Cr.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Cr.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Cr.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Cr.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Cr.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Cr.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Cr.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(cm||(cm={})),function(e){e[e.REPEAT=Fr.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Fr.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Fr.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Fr.BORDER]="CLAMP_TO_BORDER"}(lm||(lm={})),function(e){e[e.NONE=Br.NONE]="NONE",e[e.LINEAR=Br.LINEAR]="LINEAR",e[e.NEAREST=Br.POINT]="NEAREST"}(um||(um={}));var Am,wm,Rm,Im,Pm,Om,Dm,Mm,Nm,Lm,Bm,Fm,zm=e("ImageAsset",al("cc.ImageAsset")((pm=fm=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=cm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}z(t,e);var n=t.prototype;return n.reset=function(e){bm(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):bm(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var i,o=r.director.root?r.director.root.device:null,a=n.split("_"),s=Number.MAX_VALUE,c=this._format,l="",u=r.macro.SUPPORT_TEXTURE_FORMATS,h=q(a);!(i=h()).done;){var _=i.value.split("@"),f=parseInt(_[0],void 0),p=t.extnames[f]||_[0],d=u.indexOf(p);if(-1!==d&&d<s){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==p||o&&o.hasFeature(Er.FORMAT_ASTC)))continue;if(!(".pvr"!==p||o&&o.hasFeature(Er.FORMAT_PVRTC)))continue;if(!(m!==cm.RGB_ETC1&&m!==cm.RGBA_ETC1||o&&o.hasFeature(Er.FORMAT_ETC1)))continue;if(!(m!==cm.RGB_ETC2&&m!==cm.RGBA_ETC2||o&&o.hasFeature(Er.FORMAT_ETC2)))continue;if(".webp"===p&&!r.sys.hasFeature(r.sys.Feature.WEBP))continue;s=d,l=p,c=m}}l?(this._setRawAsset(l),this._format=c):b(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},B(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||bm(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||bm(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=cm.RGB_ETC1&&this._format<=cm.RGBA_ASTC_12x12||this._format>=cm.RGB_A_PVRTC_2BPPV1&&this._format<=cm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(Fu),fm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],fm._sharedPlaceHolderCanvas=null,Y((_m=pm).prototype,"_nativeAsset",[Zl],Object.getOwnPropertyDescriptor(_m.prototype,"_nativeAsset"),_m.prototype),hm=_m))||hm);r.ImageAsset=zm,Je(Cr);var Um=new te("Tex"),km=al("cc.TextureBase")((Fm=Bm=function(e){function t(){var t;return X(t=e.call(this)||this,"_format",Rm,j(t)),X(t,"_minFilter",Im,j(t)),X(t,"_magFilter",Pm,j(t)),X(t,"_mipFilter",Om,j(t)),X(t,"_wrapS",Dm,j(t)),X(t,"_wrapT",Mm,j(t)),X(t,"_wrapR",Nm,j(t)),X(t,"_anisotropy",Lm,j(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new Mo,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=Um.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=Da(t._id,666),t}z(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=r.director.root)||void 0===t?void 0:t.batcher2D)&&r.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):w(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return r.director.root?r.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?cm.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===cm.RGBA_ETC1?e=cm.RGB_ETC1:e===cm.RGB_A_PVRTC_4BPPV1?e=cm.RGB_PVRTC_4BPPV1:e===cm.RGB_A_PVRTC_2BPPV1&&(e=cm.RGB_PVRTC_2BPPV1),e},B(t,[{key:"isCompressed",get:function(){return this._format>=cm.RGB_ETC1&&this._format<=cm.RGBA_ASTC_12x12||this._format>=cm.RGB_A_PVRTC_2BPPV1&&this._format<=cm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(Fu),Bm.PixelFormat=cm,Bm.WrapMode=lm,Bm.Filter=um,Rm=Y((wm=Fm).prototype,"_format",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cm.RGBA8888}}),Im=Y(wm.prototype,"_minFilter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return um.LINEAR}}),Pm=Y(wm.prototype,"_magFilter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return um.LINEAR}}),Om=Y(wm.prototype,"_mipFilter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return um.NONE}}),Dm=Y(wm.prototype,"_wrapS",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lm.REPEAT}}),Mm=Y(wm.prototype,"_wrapT",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lm.REPEAT}}),Nm=Y(wm.prototype,"_wrapR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lm.REPEAT}}),Lm=Y(wm.prototype,"_anisotropy",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Am=wm))||Am;r.TextureBase=km;var Gm=new WeakMap,Hm=new WeakSet,Vm=new WeakSet;function jm(e,t){var n;n=sh.safeFindClass;var i,r=Ih.pool.get();try{i=Gh(e,r,{classFinder:n,customEnv:t})}catch(e){throw m(e),Ih.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:yu(h),owner:a[u],prop:s[u],type:He._getClassById(c[u])}}return Gm.set(i,l),i._native&&Hm.add(i),Ih.pool.put(r),i}var Wm,qm=new(function(){function e(){this._depends=new nu}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?F({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof vh){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var o=jm(t,{__uuid__:e});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=e),su.add(e+"@import",o)}catch(t){au.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=Gm.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Hm.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=yu(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,n.push(o),this._descend(o,t,n))}},e}()),Xm=[new So];function Ym(e){return e&&0==(e&e-1)}var Km,Qm,Zm,Jm,$m,ev,tv=al("cc.SimpleTexture")(Wm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t}z(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=Xm[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,Xm):i.copyTexImagesToTexture([e],this._gfxTexture,Xm)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),et.CLEANUP_IMAGE_CACHE)){var r=qm.getDeps(this._uuid),o=r.indexOf(e._uuid);-1!==o&&(Z(r,o),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=Mr.NONE;this._mipFilter!==um.NONE&&function(e,t,n){return!(e.gfxAPI===xr.WEBGL)||Ym(t)&&Ym(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=Mr.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Dr.SAMPLED|Dr.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},B(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(km))||Wm;r.SimpleTexture=tv;var nv,iv,rv,ov,av,sv,cv,lv=e("Texture2D",(Km=al("cc.Texture2D"),Qm=Gl([zm]),Km((ev=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",$m,j(t)),t}z(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.create=function(e,t,n,i){void 0===n&&(n=cm.RGBA8888),void 0===i&&(i=1),this.reset({width:e,height:t,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new zm,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,He._getClassId(zm))}},n._getGfxTextureCreateInfo=function(e){var t=new Oo(Or.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new zm;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},B(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(tv),$m=Y((Jm=ev).prototype,"_mipmaps",[Qm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zm=Jm))||Zm));r.Texture2D=lv,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(cv||(cv={}));var uv=e("TextureCube",al("cc.TextureCube")((sv=av=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",rv,j(t)),X(t,"_mipmaps",ov,j(t)),t}z(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+cv.front].image,back:e[a+cv.back].image,left:e[a+cv.left].image,right:e[a+cv.right].image,top:e[a+cv.top].image,bottom:e[a+cv.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;hv(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new zm,back:new zm,left:new zm,right:new zm,top:new zm,bottom:new zm};var o=i.mipmaps[r],a=He._getClassId(zm);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new Oo(Or.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new zm;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},B(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){hv(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(tv),av.FaceIndex=cv,rv=Y((iv=sv).prototype,"isRGBE",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ov=Y(iv.prototype,"_mipmaps",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nv=iv))||nv);function hv(e,t){t(e.front,cv.front),t(e.back,cv.back),t(e.left,cv.left),t(e.right,cv.right),t(e.top,cv.top),t(e.bottom,cv.bottom)}r.TextureCube=uv;var _v,fv,pv=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1813246314,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2766437914,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite-gpu",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",hash:2450198964,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCUILocal",defines:[]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_batch_id",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:2864919663,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:221,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:64},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_ENABLE_DIR_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1774012115,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:182,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:64},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:1017881636,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:69,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:60},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_ENABLE_DIR_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:809389262,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:67,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3340914951,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:58},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_ENABLE_DIR_SHADOW",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_positionMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2954155677,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:215,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:58},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:3653711100,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),dv=4227858432,mv=66060288,vv=1044480,gv=function(e,t,n,i){return void 0===i&&(i=0),t<<26&dv|e<<20&mv|n<<12&vv|4095&i},yv=function(e){return(e&dv)>>>26},Sv=function(e){return(e&mv)>>>20},xv=function(e){return(e&vv)>>>12},Tv=function(e){return 4095&e},Ev=function(e,t){return 67108863&e|t<<26&dv},Cv=((_v={})[Ar.UNKNOWN]=function(){return console.warn("illegal uniform handle")},_v[Ar.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},_v[Ar.INT2]=function(e,t,n){return void 0===n&&(n=0),Fi.fromArray(t,e,n)},_v[Ar.INT3]=function(e,t,n){return void 0===n&&(n=0),gi.fromArray(t,e,n)},_v[Ar.INT4]=function(e,t,n){return void 0===n&&(n=0),Gi.fromArray(t,e,n)},_v[Ar.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},_v[Ar.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Fi.fromArray(t,e,n)},_v[Ar.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),gi.fromArray(t,e,n)},_v[Ar.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Gi.fromArray(t,e,n)},_v[Ar.MAT3]=function(e,t,n){return void 0===n&&(n=0),Ti.fromArray(t,e,n)},_v[Ar.MAT4]=function(e,t,n){return void 0===n&&(n=0),Mi.fromArray(t,e,n)},_v),bv=((fv={})[Ar.UNKNOWN]=function(){return console.warn("illegal uniform handle")},fv[Ar.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},fv[Ar.INT2]=function(e,t,n){return void 0===n&&(n=0),Fi.toArray(e,t,n)},fv[Ar.INT3]=function(e,t,n){return void 0===n&&(n=0),gi.toArray(e,t,n)},fv[Ar.INT4]=function(e,t,n){return void 0===n&&(n=0),Gi.toArray(e,t,n)},fv[Ar.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},fv[Ar.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Fi.toArray(e,t,n)},fv[Ar.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),gi.toArray(e,t,n)},fv[Ar.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Gi.toArray(e,t,n)},fv[Ar.MAT3]=function(e,t,n){return void 0===n&&(n=0),Ti.toArray(e,t,n)},fv[Ar.MAT4]=function(e,t,n){return void 0===n&&(n=0),Mi.toArray(e,t,n)},fv),Av=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function wv(e){switch(e){case Ar.BOOL:case Ar.INT:case Ar.UINT:case Ar.FLOAT:return Av[0];case Ar.BOOL2:case Ar.INT2:case Ar.UINT2:case Ar.FLOAT2:return Av[1];case Ar.BOOL4:case Ar.INT4:case Ar.UINT4:case Ar.FLOAT4:return Av[2];case Ar.MAT4:return Av[3];case Ar.SAMPLER2D:return"default-texture";case Ar.SAMPLER_CUBE:return"default-cube-texture"}return Av[0]}function Rv(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var Iv=new ta;function Pv(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Ov(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function Dv(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=function(e){var t=o.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&pa))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var l=[],u=function(e){var t=o.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&da))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function Mv(e){return e.members.reduce((function(e,t){return e+Ta(t.type)*t.count}),0)}function Nv(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function Lv(e){switch(e.gfxAPI){case xr.GLES2:case xr.WEBGL:return"glsl1";case xr.GLES3:case xr.WEBGL2:return"glsl3";default:return"glsl4"}}var Bv=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=F({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=Pv(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=Pv(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new jo,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(Mv(l)),s.bindings.push(new ea(l.binding,to.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new Lo(Jp.MATERIAL,l.binding,l.name,l.members.map((function(e){return new No(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new ea(h.binding,to.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Bo(Jp.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<n.samplers.length;_++){var f=n.samplers[_];s.bindings.push(new ea(f.binding,to.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new Fo(Jp.MATERIAL,f.binding,f.name,f.count))}for(var p=0;p<n.textures.length;p++){var d=n.textures[p];s.bindings.push(new ea(d.binding,to.TEXTURE,d.count,d.stageFlags)),s.shaderInfo.textures.push(new zo(Jp.MATERIAL,d.binding,d.name,d.type,d.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new ea(v.binding,to.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new ko(Jp.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new ea(y.binding,to.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new Uo(Jp.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var S=0;S<n.subpassInputs.length;S++){var x=n.subpassInputs[S];s.bindings.push(new ea(x.binding,to.INPUT_ATTACHMENT,x.count,x.stageFlags)),s.shaderInfo.subpassInputs.push(new Go(Jp.MATERIAL,x.binding,x.name,x.count))}s.gfxAttributes=[];for(var T=0;T<n.attributes.length;T++){var E=n.attributes[T];s.gfxAttributes.push(new Vo(E.name,E.format,E.isNormalized,0,E.isInstanced,E.location))}Dv(n,s,Yp,"locals"),s.shaderInfo.stages.push(new Ho(Vr.VERTEX,"")),s.shaderInfo.stages.push(new Ho(Vr.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=gv(i.binding,s.type,s.count,o),o+=(Ta(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=gv(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(Iv.bindings=r.bindings,r.setLayouts[Jp.MATERIAL]=e.createDescriptorSetLayout(Iv),Iv.bindings=Yp.bindings,r.setLayouts[Jp.LOCAL]=e.createDescriptorSetLayout(Iv)),r.setLayouts[n?Jp.LOCAL:Jp.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=t[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];g("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),Dv(a,s,Xp,"globals"),s.setLayouts[Jp.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new ia(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=Ov(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=Lv(e);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,o=t.gfxAttributes,a=0;a<r.length;a++)Nv(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());r.programLib=Bv;var Fv,zv,Uv,kv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute float a_batch_id;\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nuniform vec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nvarying vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_positionMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 positionMap = gl_LastFragData[1];\nvec4 normalMap = gl_LastFragData[2];\nvec4 emissiveMap = gl_LastFragData[3];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture2D(gbuffer_positionMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(s.position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[3] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec2 a_texCoord;\nin float a_batch_id;\nout vec2 v_uv0;\nout float v_uvMode;\nout vec4 v_uvSizeOffset;\nout vec4 v_uvParams0;\nout vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nlayout(std140) uniform CCUILocal {\nvec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\n};\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nout vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\nin vec2 v_uv0;\nin float v_uvMode;\nin vec4 v_uvSizeOffset;\nin vec4 v_uvParams0;\nin vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_positionMap;\nlayout(location = 2) inout vec4 gbuffer_normalMap;\nlayout(location = 3) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_positionMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 positionMap = gbuffer_positionMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(s.position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Gv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;var n=this._resources,i=document.createElement("canvas"),o=i.getContext("2d"),a=new zm(i),s=i.width=i.height=2;o.fillStyle="#000",o.fillRect(0,0,s,s);var c=new lv;c._uuid="black-texture",c.image=a,n[c._uuid]=c,o.fillStyle="rgba(0,0,0,0)",o.fillRect(0,0,s,s);var l=new lv;l._uuid="empty-texture",l.image=a,n[l._uuid]=l;var u=new uv;u._uuid="black-cube-texture",u.setMipFilter(uv.Filter.NEAREST),u.image={front:new zm(i),back:new zm(i),left:new zm(i),right:new zm(i),top:new zm(i),bottom:new zm(i)},n[u._uuid]=u,o.fillStyle="#777",o.fillRect(0,0,s,s);var h=new lv;h._uuid="grey-texture",h.image=a,n[h._uuid]=h,o.fillStyle="#fff",o.fillRect(0,0,s,s);var _=new lv;_._uuid="white-texture",_.image=a,n[_._uuid]=_;var f=new uv;f._uuid="white-cube-texture",f.setMipFilter(uv.Filter.NEAREST),f.image={front:new zm(i),back:new zm(i),left:new zm(i),right:new zm(i),top:new zm(i),bottom:new zm(i)},n[f._uuid]=f,o.fillStyle="#7f7fff",o.fillRect(0,0,s,s);var p=new lv;p._uuid="normal-texture",p.image=a,n[p._uuid]=p,i.width=i.height=16,o.fillStyle="#ddd",o.fillRect(0,0,16,16),o.fillStyle="#555",o.fillRect(0,0,8,8),o.fillStyle="#555",o.fillRect(8,8,8,8);var d=new lv;d._uuid="default-texture",d.image=a,n[d._uuid]=d;var m=new uv;if(m.setMipFilter(uv.Filter.NEAREST),m._uuid="default-cube-texture",m.image={front:new zm(i),back:new zm(i),left:new zm(i),right:new zm(i),top:new zm(i),bottom:new zm(i)},n[m._uuid]=m,r.SpriteFrame){var v=new r.SpriteFrame,g=a,y=new lv;y.image=g,v.texture=y,v._uuid="default-spriteframe",n[v._uuid]=v}var S=Lv(e);if(!S)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var x=kv[S];return x?Promise.resolve().then((function(){pv.forEach((function(e,t){var n=Object.assign(new r.EffectAsset,e);n.shaders.forEach((function(e,n){var i=x[t][n];i&&(e[S]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+S+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new r.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new r.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",r.color("#ffff00")),e[i._uuid]=i,t.push(i);var o=new r.Material;o._uuid="missing-material",o.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),o.setProperty("mainColor",r.color("#ff00ff")),e[o._uuid]=o,t.push(o);var a=new r.Material;a._uuid="default-clear-stencil",a.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[a._uuid]=a,t.push(a);var s=new r.Material;s._uuid="ui-base-material",s.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new r.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new r.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new r.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new r.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var _=new r.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_,t.push(_);var f=new r.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),e[f._uuid]=f,t.push(f);var p=new r.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),e[p._uuid]=p,t.push(p);var d=new r.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),e[d._uuid]=d,t.push(d);var m=new r.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new r.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new r.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),r.game.on(r.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),Hv=e("builtinResMgr",r.builtinResMgr=new Gv),Vv=e("getPhaseID",(Fv=new Map,zv=0,function(e){return"number"==typeof e?e:(Fv.has(e)||(Fv.set(e,1<<zv),zv++),Fv.get(e))})),jv=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var o=e.inputAssembler,a=e.descriptorSet.getTexture(Gd),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,32*r,r)),p=new Uint8Array(32*r),d=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],S=new Vo(y.name,y.format,y.isNormalized,d.length,!0);m.push(S)}p.set(t.buffer),d.push(f);var x=new Wo(m,d,v),T=this._device.createInputAssembler(x);this.instances.push({count:1,capacity:32,vb:f,data:p,ia:T,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),Wv=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<Sd.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var p=0;p<_.vbs.length;++p){var d=i[p],m=_.vbs[p],v=_.vbDatas[p];(r=(a+_.vbCount)*d.stride)>m.size&&(m.resize(r),_.vbDatas[p]=new Uint8Array(r),_.vbDatas[p].set(v)),_.vbDatas[p].set(d.buffer,_.vbCount*d.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,S=y+a,x=_.mergeCount;if(g[y]!==x||g[S-1]!==x)for(var T=y;T<S;T++)g[T]=x+.1;return Mi.toArray(_.uboData,n.transform.worldMatrix,Sd.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(Sd.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var E=[],C=[],b=[],A=0;A<i.length;++A){var w=i[A],R=this._device.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,w.count*w.stride,w.stride));R.update(w.buffer.buffer),E.push(R),C.push(new Uint8Array(R.size)),b.push(R)}var I=this._device.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,4*a,4)),P=new Float32Array(a);P.fill(0),I.update(P),b.push(I);for(var O=e.inputAssembler.attributes,D=new Array(O.length+1),M=0;M<O.length;++M)D[M]=O[M];D[O.length]=new Vo("a_dyn_batch_id",Cr.R32F,!1,i.length);var N=new Wo(D,b),L=this._device.createInputAssembler(N),B=this._device.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,Sd.SIZE,Sd.SIZE));l.bindBuffer(Sd.BINDING,B),l.update();var F=new Float32Array(Sd.COUNT);Mi.toArray(F,n.transform.worldMatrix,Sd.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:C,vbIdx:I,vbIdxData:P,vbCount:a,ia:L,ubo:B,uboData:F,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),qv=new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.DEVICE),Xv=new wo(null),Yv=new na(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(Uv||(Uv={}));var Kv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new ka,this._dss=new za,this._rs=new Fa,this._priority=Hp.DEFAULT,this._stage=Gp.DEFAULT,this._phase=Vv("default"),this._primitive=Kr.TRIANGLE_LIST,this._batchingScheme=Uv.NONE,this._dynamicStates=$r.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(Vv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=Bv.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=q(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),Da(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=Ar.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=Ev(i,n):t&&(i=Ev(i,yv(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);bv[r](a,n,o),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);return Cv[r](a,n,o)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=Ta(r)>>2,a=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&bv[r](a,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):w(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new jv(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new Wv(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||wv(i),u=(Ta(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":wv(r),l=Hv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Wa.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],o=this._getBlockView(r.type,t.binding),a=this._properties[r.name],s=a&&a.value||wv(r.type),c=(Ta(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=Bv.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(Bv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=Bv.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Hp.DEFAULT),this._setStage(Gp.DEFAULT),this._setPhase(Vv("default")),this._setPrimitive(Kr.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?F({},t.defines):t.defines,this._shaderInfo=Bv.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),Yv.layout=Bv.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(Yv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Bv.getTemplateInfo(t.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=a[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var p=l[l.length-1]+u;p&&(qv.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(qv),this._rootBlock=new ArrayBuffer(p));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=a[d];Xv.buffer=this._rootBuffer,Xv.offset=l[m++],Xv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Xv);this._blocks[v]=new Float32Array(this._rootBlock,Xv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var S=this._propertyHandleMap=s,x={};for(var T in this._properties){var E=this._properties[T];E.handleInfo&&(x[T]=this.getHandle.apply(this,E.handleInfo))}Object.assign(S,x)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(Er.INSTANCED_ARRAYS)?this._setBatchingScheme(Uv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Uv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Uv.VB_MERGING):this._setBatchingScheme(Uv.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<Ar.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(Bv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},B(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Bv.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();Kv.getTypeFromHandle=yv,Kv.getBindingFromHandle=Sv,Kv.getCountFromHandle=xv,Kv.getOffsetFromHandle=Tv;var Qv,Zv=new na(null),Jv=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Hp.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var i=r.director.root;this._device=i.device,Zv.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(Zv);var o=r.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),a=new na(null);if(a.layout=o.localSetLayout,this._createWorldBoundDescriptorSet(a),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===Uv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Hp.DEFAULT,t[0].phase===Vv("reflection")){var s=i.mainWindow.width,c=i.mainWindow.height,l=512;c<s?(s=l*s/c,c=l):c=l*c/(s=l),this._reflectionTex=this._device.createTexture(new Oo(Or.TEX2D,Dr.STORAGE|Dr.TRANSFER_SRC|Dr.SAMPLED,Cr.RGBA8,s,c)),this.descriptorSet.bindTexture(Xd,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Mo(Br.LINEAR,Br.LINEAR,Br.NONE,Fr.CLAMP,Fr.CLAMP,Fr.CLAMP)),this.descriptorSet.bindSampler(Xd,this._reflectionSampler),this.descriptorSet.bindTexture(Qd,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=r.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=r.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Hp.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},B(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?w(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===Uv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),Zv.layout=e[0].localSetLayout,this._createDescriptorSet(Zv)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===Uv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),$v=new Mi,eg=[{name:"CC_ENABLE_DIR_SHADOW",value:!0},{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Qv||(Qv={}));var tg,ng,ig=new Mo(Br.LINEAR,Br.LINEAR,Br.NONE,Fr.CLAMP,Fr.CLAMP,Fr.CLAMP),rg=new Mo(Br.LINEAR,Br.LINEAR,Br.LINEAR,Fr.CLAMP,Fr.CLAMP,Fr.CLAMP),og=function(){function e(){this.type=Qv.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(vd.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Gi,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=kp.Enum.NONE,this._device=r.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=kp.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Mi.toArray(this._localData,i,vd.MAT_WORLD_OFFSET),Mi.inverseTranspose($v,i);var a=Math.abs(Mi.determinant($v)),s=1/Math.sqrt(a);Mi.multiplyScalar($v,$v,s),Mi.toArray(this._localData,$v,vd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Fc.fromPoints(Fc.create(),e,t),this._worldBounds=Fc.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new Jv},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){Gi.toArray(this._localData,t,vd.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=Hv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?rg:ig),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Gd,n),a.bindSampler(Gd,i),a.update()}},t.getMacroPatches=function(){return this.receiveShadow?eg:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(Er.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=fa[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new Vo;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=fa[c.format],h=new(Ea(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}t.batchingScheme===Uv.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(yd)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.DEVICE,vd.SIZE,vd.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.DEVICE,gd.SIZE,gd.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(vd.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(gd.BINDING,this._worldBoundBuffer)},B(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(tg||(tg={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(ng||(ng={})),r.internal.TransformBit=ng;var ag,sg,cg,lg,ug,hg,_g,fg,pg=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t._destroy=function(){},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=q(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=ng.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=q(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=q(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._createNativeObject=function(){},B(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),e}(),dg=e("EffectAsset",al("cc.EffectAsset")((fg=_g=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"techniques",cg,j(t)),X(t,"shaders",lg,j(t)),X(t,"combinations",ug,j(t)),X(t,"hideInEditor",hg,j(t)),t}z(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name].equals(e)&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){Bv.register(this),t.register(this),r.game.once(r.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=r.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],o=0;o<i.length;++o){var a=F({},n);a[t]=i[o],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return Bv.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(Fu),_g._effects={},cg=Y((sg=fg).prototype,"techniques",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lg=Y(sg.prototype,"shaders",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ug=Y(sg.prototype,"combinations",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hg=Y(sg.prototype,"hideInEditor",[_l,pl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ag=sg))||ag);r.EffectAsset=dg;var mg=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var o=t.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=t.pipelineLayout,c=new ra(r.attributes),l=new Ga(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},e}());mg._PSOHashMap=new Map;var vg=new xo,gg=new fo;function yg(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var Sg,xg,Tg,Eg,Cg,bg,Ag,wg,Rg,Ig,Pg=null;function Og(e,t,n,i,r){if(i&&i.enabled&&r===Pg){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;vg.width=gg.width=r.window.width,vg.height=gg.height=r.window.height;var u=mg.getOrCreatePipelineState(e,s[0],c[0],t,a);n.setViewport(vg),n.setScissor(gg),n.bindPipelineState(u),n.bindDescriptorSet(Jp.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(Jp.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Dg=new Gi,Mg=e("Material",(Sg=al("cc.Material"),xg=Gl(dg),Sg((Ig=function(e){function t(){var t;return X(t=e.call(this)||this,"_effectAsset",Cg,j(t)),X(t,"_techIdx",bg,j(t)),X(t,"_defines",Ag,j(t)),X(t,"_states",wg,j(t)),X(t,"_props",Rg,j(t)),t._passes=[],t._hash=0,t}z(t,e),t.getHash=function(e){for(var t,n=0,i=q(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?b(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=dg.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=q(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=F({},e._props[t]);this._defines.length=e._defines.length;for(var n=0;n<e._defines.length;n++)this._defines[n]=F({},e._defines[n]);this._states.length=e._states.length;for(var i=0;i<e._states.length;i++)this._states[i]=F({},e._states[i]);this._effectAsset=e._effectAsset,this._update()},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var o=e.passes[i],a=o.passIndex=i,s=o.defines=this._defines[a]||(this._defines[a]={});if(o.stateOverrides=this._states[a]||(this._states[a]={}),void 0!==o.propertyIndex&&Object.assign(s,this._defines[o.propertyIndex]),void 0!==o.embeddedMacros&&Object.assign(s,o.embeddedMacros),!o.switch||s[o.switch]){var c=new Kv(r.director.root);c.initialize(o),n.push(c)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(Kv.getTypeFromHandle(i)<Ar.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var o=n;yg(Dg,o),Dg.w=o.w,n=Dg}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(e,i,n[a],a);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=Kv.getBindingFromHandle(t);if(n instanceof Xa)e.bindTexture(r,n,i);else if(n instanceof km){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=q(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new mi("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},B(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(Fu),Cg=Y((Eg=Ig).prototype,"_effectAsset",[xg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bg=Y(Eg.prototype,"_techIdx",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ag=Y(Eg.prototype,"_defines",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wg=Y(Eg.prototype,"_states",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rg=Y(Eg.prototype,"_props",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tg=Eg))||Tg));r.Material=Mg;var Ng=Ke({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Lg=Ke({Planar:0,ShadowMap:1}),Bg=Ke({HARD:0,SOFT:1,SOFT_2X:2}),Fg=Lg.ShadowMap+1,zg=function(){function e(){this.fixedSphere=new ao(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Mi,this.matShadowProj=new Mi,this.matShadowViewProj=new Mi,this._normal=new gi(0,1,0),this._shadowColor=new mi(0,0,0,76),this._matLight=new Mi,this._material=null,this._instancingMaterial=null,this._size=new Fi(512,512),this._enabled=!1,this._distance=0,this._type=Fg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new Mg,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Mg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:Fg},t.initialize=function(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation},t.activate=function(){if(this.enabled)this.type===Lg.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{var e=r.director.root;e.pipeline.macros.CC_ENABLE_DIR_SHADOW=0,e.onGlobalPipelineStateChanged()}},t._updatePlanarInfo=function(){this._material||(this._material=new Mg,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Mg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}));var e=r.director.root;e.pipeline.macros.CC_ENABLE_DIR_SHADOW=0,e.onGlobalPipelineStateChanged()},t._updatePipeline=function(){var e=r.director.root;e.pipeline.macros.CC_ENABLE_DIR_SHADOW=1,e.onGlobalPipelineStateChanged()},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){gi.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"near",get:function(){return this._near},set:function(e){this._near=e}},{key:"far",get:function(){return this._far},set:function(e){this._far=e}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();zg.MAX_FAR=2e3,zg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),r.Shadows=zg,zn(pg.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),zn(pg.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var Ug={};zn(Ug,"CameraVisFlags",[{name:"GENERAL"}]),Fn(Ug,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:kp.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:kp.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:kp.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:kp.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:kp.BitMask,targetName:"UI_2D"}]),r.CameraVisFlags=Ug;var kg,Gg={};function Hg(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}zn(Gg,"VisibilityFlags",[{name:"GENERAL"}]),Fn(Gg,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:kp.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:kp.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:kp.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:kp.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:kp.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:kp.Enum,targetName:"UI_2D"}]),r.VisibilityFlags=Gg,Fn(Kv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),zn(Em.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),zn(zg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(kg||(kg={}));var Vg=function(e){return 4*Math.PI*Math.PI*e*e},jg=function(){function e(){this._baked=!1,this._color=new gi(1,1,1),this._colorTemp=6550,this._colorTempRGB=new gi(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=kg.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new gi(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},B(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Hg(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=ng.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Wg=new gi(0,0,-1),qg=new gi,Xg=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new gi(1,-1,-1),t._illuminanceHDR=Zi.SUN_ILLUM,t._illuminanceLDR=1,t._type=kg.DIRECTIONAL,t}z(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=Zi.SUN_ILLUM,this.direction=new gi(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=gi.transformQuat(qg,Wg,this._node.worldRotation))},B(t,[{key:"direction",get:function(){return this._dir},set:function(e){gi.normalize(this._dir,e)}},{key:"illuminance",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}}]),t}(jg),Yg=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return e.prototype.tryCompile.call(j(i)),i}z(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Kv.fillPipelineInfo(this,e),Kv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!Rv(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Uv.NONE)},n._onStateChange=function(){this._setHash(Kv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},B(t,[{key:"parent",get:function(){return this._parent}}]),t}(Kv),Kg=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}z(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=q(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=Mg.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new Yg(t[n],this));return e},B(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Mg),Qg=null,Zg=null,Jg=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t;var n=r.director.root;n.pipeline.pipelineSceneData.isHDR?e&&(n.pipeline.pipelineSceneData.ambient.groundAlbedo.w=e.mipmapLevel):t&&(n.pipeline.pipelineSceneData.ambient.groundAlbedo.w=t.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=r.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=Hv.get("default-cube-texture"),this._model||(this._model=r.director.root.createModel(r.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!Zg){var n=new Mg;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),Zg=new Kg({parent:n})}this.enabled&&(Qg||(Qg=r.utils.createMesh(r.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Qg.renderingSubMeshes[0],Zg)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){this.enabled&&Zg&&Zg.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,Zg);var e=r.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,o=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===i&&t.macros.CC_USE_HDR===o||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=i,t.macros.CC_USE_HDR=o,e.onGlobalPipelineStateChanged())},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=r.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),i=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(cd,i),this._globalDSManager.bindTexture(cd,n)}var o=this.diffuseMap?this.diffuseMap:this._default;if(o){var a=o.getGFXTexture(),s=e.getSampler(o.getSamplerInfo());this._globalDSManager.bindSampler(hd,s),this._globalDSManager.bindTexture(hd,a)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},B(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this._updateGlobalBinding(),this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();r.Skybox=Jg;var $g,ey,ty=function(e){z(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=Fc.create(),t._pos=new gi,t._type=kg.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/Vg(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;Fc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},B(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(jg),ny=new gi(0,0,-1),iy=new bi,ry=new Mi,oy=new Mi,ay=new Mi,sy=new Mi,cy=function(e){z(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new gi(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._aspect=0,t._aabb=Fc.create(),t._frustum=Kc.create(),t._pos=new gi,t._type=kg.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/Vg(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new gi(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),gi.transformQuat(this._dir,ny,this._node.getWorldRotation(iy)),gi.normalize(this._dir,this._dir),Fc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(ry),Mi.invert(ry,ry),Mi.perspective(oy,this._angle,1,.001,this._range),Mi.multiply(ay,oy,ry),this._frustum.update(ay,sy),this._needUpdate=!1)},B(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(jg),ly=Object.freeze({__proto__:null,Ambient:Zi,Octree:Ji,get CameraFOVAxis(){return $d},get CameraProjection(){return em},get CameraAperture(){return tm},get CameraISO(){return nm},get CameraShutter(){return im},SKYBOX_FLAG:xm,Camera:Em,CameraVisFlags:Ug,VisibilityFlags:Gg,DirectionalLight:Xg,ColorTemperatureToRGB:Hg,get LightType(){return kg},nt2lm:Vg,Light:jg,get ModelType(){return Qv},Model:og,ShadowSize:Ng,ShadowType:Lg,PCFType:Bg,Shadows:zg,RenderScene:pg,Skybox:Jg,SphereLight:ty,SpotLight:cy,SubModel:Jv,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null});function uy(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function hy(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}($g||($g={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(ey||(ey={}));var _y=function(){function e(e){this._device=void 0,this._format=Cr.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new So,this._region1=new So,this._region2=new So,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=fa[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=Ea(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=hy(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,uy(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;g("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new Oo(Or.TEX2D,Dr.SAMPLED|Dr.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=hy(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,uy(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}(),fy=function(e){if(void 0===In[e]){var t=1<<Rn;In[e]=t,Rn+=1}},py=Object.freeze({__proto__:null,addStage:fy,scene:ly,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[];o.push(new Vo(lo.ATTR_POSITION,Cr.RGB32F)),t.normals&&o.push(new Vo(lo.ATTR_NORMAL,Cr.RGB32F)),t.uvs&&o.push(new Vo(lo.ATTR_TEX_COORD,Cr.RG32F)),t.colors&&o.push(new Vo(lo.ATTR_COLOR,Cr.RGB32F));var a=e.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new Wo(o,[a],s))},get RenderQueue(){return $g},get PassStage(){return ey},genHandle:gv,getTypeFromHandle:yv,getBindingFromHandle:Sv,getCountFromHandle:xv,getOffsetFromHandle:Tv,customizeType:Ev,type2reader:Cv,type2writer:bv,getDefaultFromType:wv,overrideMacros:Rv,get BatchingSchemes(){return Uv},Pass:Kv,getDeviceShaderVersion:Lv,programLib:Bv,nearestPOT:uy,TextureBufferPool:_y,MaterialInstance:Kg,PassInstance:Yg,get PoolType(){return vc},NULL_HANDLE:0,get NodeView(){return gc},NodePool:Ec,get PassView(){return Sc},PassPool:wc,get AABBView(){return Cc},AABBPool:Pc});e("renderer",py);var dy=new gi,my=(new gi,new gi,new gi),vy=new Mi,gy=new Fc,yy=new Fc,Sy=!1,xy=ao.create(0,0,0,1),Ty=new ao,Ey=new Kc;Ey.accurate=!0;var Cy=new Kc;Cy.accurate=!0;var by=new Kc,Ay=new Mi,wy=new Mi,Ry=new Mi,Iy=new Mi,Py=new Mi,Oy=new Mi,Dy=new Mi,My=new gi,Ny=new Fi,Ly=new gi,By=new gi,Fy=new gi(0,0,0),zy=new Fc,Uy=new We((function(){return{model:null,depth:0}}),128),ky=new We((function(){return{model:null,depth:0}}),128),Gy=new We((function(){return{model:null,depth:0}}),128);function Hy(e,t){var n=0;e.node&&(gi.subtract(dy,e.node.worldPosition,t.position),n=gi.dot(dy,t.forward));var i=Uy.alloc();return i.model=e,i.depth=n,i}function Vy(e,t){var n=0;e.node&&(gi.subtract(dy,e.node.worldPosition,t.position),n=gi.dot(dy,t.forward));var i=ky.alloc();return i.model=e,i.depth=n,i}function jy(e,t){var n=0;e.node&&(gi.subtract(dy,e.node.worldPosition,t.position),n=gi.dot(dy,t.forward));var i=Gy.alloc();return i.model=e,i.depth=n,i}function Wy(e,t,n){var i=t.direction,r=e.normal,o=e.distance+.001,a=1/gi.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,Mi.toArray(n,f,rd.MAT_LIGHT_PLANE_PROJ_OFFSET)}function qy(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(ao.set(xy,o.position.x,o.position.y,o.position.z,o.range),ic.sphereFrustum(xy,t.frustum)&&n.push(o))}for(var a=t.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(ao.set(xy,c.position.x,c.position.y,c.position.z,c.range),ic.sphereFrustum(xy,t.frustum)&&n.push(c))}}function Xy(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;Uy.freeArray(s),s.length=0;var c=r.castShadowObjects;Gy.freeArray(c),c.length=0,Sy=!1;var l=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(rd.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===Lg.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,ky.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var o=t.device,a=r.invisibleOcclusionRange,s=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();Mi.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(vy,i),Kc.split(Ey,i,vy,.1,r.shadowDistance),Cy=Kc.clone(Ey),Mi.fromRT(Ay,n.node.rotation,Fy),Mi.invert(wy,Ay),Mi.invert(Ry,wy);var c=wy.clone();Cy.transform(wy),Fc.fromPoints(gy,new gi(1e7,1e7,1e7),new gi(-1e7,-1e7,-1e7)),gy.mergeFrustum(Cy);var l=2*gy.halfExtents.z;my.set(gy.center.x,gy.center.y,gy.center.z+gy.halfExtents.z+a),gi.transformMat4(my,my,Ry),Mi.fromRT(Ay,n.node.rotation,my),Mi.invert(wy,Ay),Mi.invert(Ry,wy);var u=gi.distance(Ey.vertices[0],Ey.vertices[6]);Ty.center.set(0,0,0),Ty.radius=-1,Ty.mergePoints(Ey.vertices);var h=.8*u+.4*Ty.radius;r.shadowCameraFar=l+a;var _=.5*h;if(Mi.ortho(Iy,-_,_,-_,_,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),s>0){Mi.multiply(Oy,Iy,c),gi.transformMat4(My,my,Oy);var f=2/s;Ny.set(f,f);var p=My.x%Ny.x,d=My.y%Ny.y;Ly.set(My.x-p,My.y-d,My.z),Mi.invert(Dy,Oy),gi.transformMat4(By,Ly,Dy),Mi.fromRT(Ay,n.node.rotation,By),Mi.invert(wy,Ay),Mi.invert(Ry,wy),Kc.createOrtho(e,h,h,.1,r.shadowCameraFar,Ry)}else{for(var m=0;m<8;m++)e.vertices[m].set(0,0,0);e.updatePlanes()}Mi.multiply(Py,Iy,wy),r.matShadowView=wy,r.matShadowProj=Iy,r.matShadowViewProj=Py}(by,e,i,t,o);else{for(var u=0;u<8;u++)by.vertices[u].set(0,0,0);by.updatePlanes()}i&&o.type===Lg.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,o=n.distance+.001,a=1/gi.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,e.pipelineUBO.updateShadowUBORange(rd.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&xm&&s.push(Hy(a.model,t));for(var h=n.models,_=t.visibility,f=0;f<h.length;f++){var p=h[f];if(p.enabled&&(p.castShadow&&c.push(jy(p,t)),o.firstSetCSM&&p.worldBounds&&(Sy||(yy.copy(p.worldBounds),Sy=!0),Fc.merge(yy,yy,p.worldBounds)),p.node&&(_&p.node.layer)===p.node.layer||_&p.visFlags)){if(null!=l&&p.castShadow&&p.worldBounds&&(o.fixedArea?(Fc.transform(zy,p.worldBounds,o.matLight),ic.aabbFrustum(zy,t.frustum)&&l.push(Vy(p,t))):ic.aabbFrustum(p.worldBounds,by)&&l.push(Vy(p,t))),p.worldBounds&&!ic.aabbFrustum(p.worldBounds,t.frustum))continue;s.push(Hy(p,t))}}o.firstSetCSM&&(o.shadowDistance=2*yy.halfExtents.length(),o.firstSetCSM=!1)}var Yy,Ky,Qy,Zy,Jy,$y,eS,tS,nS,iS,rS=new Mo(Br.LINEAR,Br.LINEAR,Br.NONE,Fr.CLAMP,Fr.CLAMP,Fr.CLAMP),oS=new Mo(Br.POINT,Br.POINT,Br.NONE,Fr.CLAMP,Fr.CLAMP,Fr.CLAMP),aS=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(rS),this._pointSampler=this._device.getSampler(oS);var t=new ta(Xp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new na(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new na(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=qp.UBO_GLOBAL;r<qp.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=t.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,rd.SIZE,rd.SIZE));i.bindBuffer(rd.BINDING,o),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},B(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),sS=new Mi,cS=new Mi,lS=new Mi,uS=new Gi,hS=function(){function e(){this._globalUBO=new Float32Array(nd.COUNT),this._cameraUBO=new Float32Array(id.COUNT),this._shadowUBO=new Float32Array(rd.COUNT)}e.updateGlobalUBOView=function(e,t){var n=r.director.root,i=t,o=Math.floor(e.width),a=Math.floor(e.height);i[nd.TIME_OFFSET]=n.cumulativeTime,i[nd.TIME_OFFSET+1]=n.frameTime,i[nd.TIME_OFFSET+2]=r.director.getTotalFrames(),i[nd.SCREEN_SIZE_OFFSET]=o,i[nd.SCREEN_SIZE_OFFSET+1]=a,i[nd.SCREEN_SIZE_OFFSET+2]=1/o,i[nd.SCREEN_SIZE_OFFSET+3]=1/a,i[nd.NATIVE_SIZE_OFFSET]=o,i[nd.NATIVE_SIZE_OFFSET+1]=a,i[nd.NATIVE_SIZE_OFFSET+2]=1/i[nd.NATIVE_SIZE_OFFSET],i[nd.NATIVE_SIZE_OFFSET+3]=1/i[nd.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){r.director.root;var i=(n.scene?n.scene:r.director.getScene().renderScene).mainLight,o=e.pipelineSceneData,a=o.ambient,s=o.fog,c=t,l=n.exposure,u=o.isHDR;if(c[id.SCREEN_SCALE_OFFSET]=o.shadingScale,c[id.SCREEN_SCALE_OFFSET+1]=o.shadingScale,c[id.SCREEN_SCALE_OFFSET+2]=1/c[id.SCREEN_SCALE_OFFSET],c[id.SCREEN_SCALE_OFFSET+3]=1/c[id.SCREEN_SCALE_OFFSET+1],c[id.EXPOSURE_OFFSET]=l,c[id.EXPOSURE_OFFSET+1]=1/l,c[id.EXPOSURE_OFFSET+2]=u?1:0,c[id.EXPOSURE_OFFSET+3]=0,i){if(gi.toArray(c,i.direction,id.MAIN_LIT_DIR_OFFSET),gi.toArray(c,i.color,id.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var h=i.colorTemperatureRGB;c[id.MAIN_LIT_COLOR_OFFSET]*=h.x,c[id.MAIN_LIT_COLOR_OFFSET+1]*=h.y,c[id.MAIN_LIT_COLOR_OFFSET+2]*=h.z}c[id.MAIN_LIT_COLOR_OFFSET+3]=u?i.illuminance*l:i.illuminance}else gi.toArray(c,gi.UNIT_Z,id.MAIN_LIT_DIR_OFFSET),Gi.toArray(c,Gi.ZERO,id.MAIN_LIT_COLOR_OFFSET);var _=a.skyColor;_.w=u?a.skyIllum*l:a.skyIllum,c[id.AMBIENT_SKY_OFFSET+0]=_.x,c[id.AMBIENT_SKY_OFFSET+1]=_.y,c[id.AMBIENT_SKY_OFFSET+2]=_.z,c[id.AMBIENT_SKY_OFFSET+3]=_.w,c[id.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,c[id.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,c[id.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,c[id.AMBIENT_GROUND_OFFSET+3]=a.groundAlbedo.w,Mi.toArray(c,n.matView,id.MAT_VIEW_OFFSET),Mi.toArray(c,n.node.worldMatrix,id.MAT_VIEW_INV_OFFSET),gi.toArray(c,n.position,id.CAMERA_POS_OFFSET),Mi.toArray(c,n.matProj,id.MAT_PROJ_OFFSET),Mi.toArray(c,n.matProjInv,id.MAT_PROJ_INV_OFFSET),Mi.toArray(c,n.matViewProj,id.MAT_VIEW_PROJ_OFFSET),Mi.toArray(c,n.matViewProjInv,id.MAT_VIEW_PROJ_INV_OFFSET),c[id.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var f=s.colorArray;c[id.GLOBAL_FOG_COLOR_OFFSET]=f.x,c[id.GLOBAL_FOG_COLOR_OFFSET+1]=f.y,c[id.GLOBAL_FOG_COLOR_OFFSET+2]=f.z,c[id.GLOBAL_FOG_COLOR_OFFSET+3]=f.z,c[id.GLOBAL_FOG_BASE_OFFSET]=s.fogStart,c[id.GLOBAL_FOG_BASE_OFFSET+1]=s.fogEnd,c[id.GLOBAL_FOG_BASE_OFFSET+2]=s.fogDensity,c[id.GLOBAL_FOG_ADD_OFFSET]=s.fogTop,c[id.GLOBAL_FOG_ADD_OFFSET+1]=s.fogRange,c[id.GLOBAL_FOG_ADD_OFFSET+2]=s.fogAtten,c[id.NEAR_FAR_OFFSET]=n.nearClip,c[id.NEAR_FAR_OFFSET+1]=n.farClip,c[id.VIEW_PORT_OFFSET]=n.viewport.x,c[id.VIEW_PORT_OFFSET+1]=n.viewport.y,c[id.VIEW_PORT_OFFSET+1]=n.viewport.z,c[id.VIEW_PORT_OFFSET+1]=n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,o=e.pipelineSceneData.shadows,a=t;if(o.enabled){if(r&&o.type===Lg.ShadowMap){var s,c,l,u=.1,h=0;if(o.fixedArea){Mi.invert(sS,r.node.getWorldMatrix()),s=sS;var _=o.orthoSize,f=o.orthoSize;u=o.near,h=o.far,Mi.ortho(cS,-_,_,-f,f,u,h,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY),c=cS,Mi.multiply(lS,cS,sS),l=lS}else u=.1,h=o.shadowCameraFar,s=o.matShadowView,c=o.matShadowProj,l=o.matShadowViewProj;Mi.toArray(t,s,rd.MAT_LIGHT_VIEW_OFFSET),a[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=c.m10,a[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=c.m14,a[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=c.m11,a[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=c.m15,a[rd.SHADOW_PROJ_INFO_OFFSET+0]=c.m00,a[rd.SHADOW_PROJ_INFO_OFFSET+1]=c.m05,a[rd.SHADOW_PROJ_INFO_OFFSET+2]=1/c.m00,a[rd.SHADOW_PROJ_INFO_OFFSET+3]=1/c.m05,Mi.toArray(t,l,rd.MAT_LIGHT_VIEW_PROJ_OFFSET);var p=sm(i)?0:1;a[rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=u,a[rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h,a[rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=p,a[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===Lg.Planar&&Wy(o,r,a);mi.toArray(a,o.shadowColor,rd.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i,r,o,a=e.device,s=e.pipelineSceneData.shadows,c=t,l=sm(a)?0:1,u=.1,h=0;switch(n.type){case kg.DIRECTIONAL:if(s.fixedArea){Mi.invert(sS,n.node.getWorldMatrix()),i=sS;var _=s.orthoSize,f=s.orthoSize;u=s.near,h=s.far,Mi.ortho(cS,-_,_,-f,f,u,h,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),r=cS,Mi.multiply(lS,cS,sS),o=lS}else u=.1,h=s.shadowCameraFar,i=s.matShadowView,r=s.matShadowProj,o=s.matShadowViewProj;Mi.toArray(t,i,rd.MAT_LIGHT_VIEW_OFFSET),c[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=r.m10,c[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=r.m14,c[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=r.m11,c[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=r.m15,c[rd.SHADOW_PROJ_INFO_OFFSET+0]=r.m00,c[rd.SHADOW_PROJ_INFO_OFFSET+1]=r.m05,c[rd.SHADOW_PROJ_INFO_OFFSET+2]=1/r.m00,c[rd.SHADOW_PROJ_INFO_OFFSET+3]=1/r.m05,Mi.toArray(t,o,rd.MAT_LIGHT_VIEW_PROJ_OFFSET),uS.set(u,h,0,1-s.saturation),Gi.toArray(c,uS,rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),uS.set(0,l,s.normalBias,0),Gi.toArray(c,uS,rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case kg.SPOT:Mi.invert(sS,n.node.getWorldMatrix()),Mi.toArray(c,sS,rd.MAT_LIGHT_VIEW_OFFSET),Mi.perspective(cS,n.angle,n.aspect,.001,n.range),Mi.multiply(lS,cS,sS),Mi.toArray(c,lS,rd.MAT_LIGHT_VIEW_PROJ_OFFSET),uS.set(.01,n.range,0,1-s.saturation),Gi.toArray(c,uS,rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),uS.set(1,l,s.normalBias,0),Gi.toArray(c,uS,rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}uS.set(s.size.x,s.size.y,s.pcf,s.bias),Gi.toArray(c,uS,rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),mi.toArray(c,s.shadowColor,rd.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,nd.SIZE,nd.SIZE));n.bindBuffer(nd.BINDING,i);var r=e.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,id.SIZE,id.SIZE));n.bindBuffer(id.BINDING,r);var o=e.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,rd.SIZE,rd.SIZE));n.bindBuffer(rd.BINDING,o)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(nd.BINDING),this._globalUBO),n.bindBuffer(nd.BINDING,i.getBuffer(nd.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(id.BINDING),this._cameraUBO),n.bindBuffer(id.BINDING,i.getBuffer(id.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=t.scene.mainLight;a&&o.has(a)&&i.bindTexture(od,o.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(rd.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(od,Hv.get("default-texture").getGFXTexture()),t.bindTexture(pd,Hv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(rd.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof Mi?Mi.toArray(this._shadowUBO,t,e):t instanceof mi&&mi.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();hS._combineSignY=0;var _S,fS,pS,dS,mS,vS,gS,yS,SS,xS,TS,ES,CS,bS=e("RenderStage",(Yy=al("RenderStage"),Ky=Ml(),Qy=Ml(),Zy=Ml(),Yy((iS=function(){function e(){X(this,"_name",eS,this),X(this,"_priority",tS,this),this._enabled=!0,X(this,"_tag",nS,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},B(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),eS=Y(($y=iS).prototype,"_name",[Ky,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tS=Y($y.prototype,"_priority",[Qy,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nS=Y($y.prototype,"_tag",[Zy,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jy=$y))||Jy));r.RenderStage=bS;var AS,wS=e("RenderFlow",(_S=al("RenderFlow"),fS=Ml(),pS=Ml(),dS=Ml(),mS=Ml(),vS=Gl([bS]),_S((CS=function(){function e(){X(this,"_name",SS,this),X(this,"_priority",xS,this),X(this,"_tag",TS,this),X(this,"_stages",ES,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},B(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),SS=Y((yS=CS).prototype,"_name",[fS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xS=Y(yS.prototype,"_priority",[pS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TS=Y(yS.prototype,"_tag",[dS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ES=Y(yS.prototype,"_stages",[mS,vS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gS=yS))||gS));r.RenderFlow=wS,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(AS||(AS=e("PipelineEventType",{})));var RS,IS,PS,OS,DS,MS,NS,LS,BS,FS,zS,US,kS,GS,HS,VS=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}z(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(fn)),jS=new fo,WS=new xo,qS=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},XS=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},YS=e("RenderPipeline",(RS=al("cc.RenderPipeline"),IS=Ml(),PS=Ml(),OS=Gl([wS]),RS((BS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_tag",NS,j(t)),X(t,"_flows",LS,j(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new VS,t._commandBuffers=[],t._pipelineUBO=new hS,t._macros={},t._constantMacros="",t._profiler=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new fo,t._clusterEnabled=!1,t._bloomEnabled=!1,t}z(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new qo,o=new Xo;r.format=t,o.format=n,o.stencilStoreOp=Wr.DISCARD,o.depthStoreOp=Wr.DISCARD,e&oo.COLOR||(e&xm?r.loadOp=jr.DISCARD:(r.loadOp=jr.LOAD,r.beginAccesses=[qr.COLOR_ATTACHMENT_WRITE])),(e&oo.DEPTH_STENCIL)!==oo.DEPTH_STENCIL&&(e&oo.DEPTH||(o.depthLoadOp=jr.LOAD),e&oo.STENCIL||(o.stencilLoadOp=jr.LOAD)),o.beginAccesses=[qr.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Qo([r],o);return i.createRenderPass(a)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTexture.format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new $o(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,jS),t||(t=WS);var n=this.pipelineSceneData.shadingScale;return t.left=jS.x*n,t.top=jS.y*n,t.width=jS.width*n,t.height=jS.height*n,t},n.generateScissor=function(e,t){t||(t=jS),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=r.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new aS(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(AS.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(Pg=n)}Pg=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(AS.RENDER_CAMERA_BEGIN,n),qy(this,n),Xy(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(AS.RENDER_CAMERA_END,n)}}this.emit(AS.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,o=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(e){case Tr.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case Tr.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case Tr.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case Tr.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var e=new XS,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE|Pr.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.DEVICE,o,r));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Vo("a_position",Cr.RG32F),c[1]=new Vo("a_texCoord",Cr.RG32F);var l=this._device.createInputAssembler(new Wo(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(Tr.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||Tr.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(Er.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(Er.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new qS,t=this.device,n=new qo;n.format=Cr.RGBA8,n.loadOp=jr.CLEAR,n.storeOp=Wr.STORE,n.endAccesses=[qr.COLOR_ATTACHMENT_WRITE],e.renderPass=t.createRenderPass(new Qo([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Cr.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new $o(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)e.downsampleTexs.push(t.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Cr.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[o]=t.createFramebuffer(new $o(e.renderPass,[e.downsampleTexs[o]])),e.upsampleTexs.push(t.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Cr.RGBA8,i,r))),e.upsampleFramebuffers[o]=t.createFramebuffer(new $o(e.renderPass,[e.upsampleTexs[o]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Cr.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new $o(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},B(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(Fu),NS=Y((MS=BS).prototype,"_tag",[IS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LS=Y(MS.prototype,"_flows",[PS,OS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DS=MS))||DS));r.RenderPipeline=YS,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(FS||(FS={})),function(e){e[e.FORWARD=10]="FORWARD"}(zS||(zS={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(US||(US={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(kS||(kS={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(GS||(GS={}));var KS=new qo;KS.format=Cr.RGBA8,KS.beginAccesses=[qr.FRAGMENT_SHADER_READ_TEXTURE],KS.endAccesses=[qr.FRAGMENT_SHADER_READ_TEXTURE];var QS=new Xo;QS.format=Cr.DEPTH_STENCIL;var ZS,JS,$S,ex,tx,nx,ix,rx,ox,ax,sx,cx,lx,ux,hx,_x,fx,px,dx,mx,vx,gx,yx,Sx,xx,Tx,Ex,Cx,bx,Ax,wx,Rx,Ix,Px,Ox,Dx,Mx,Nx,Lx,Bx,Fx,zx,Ux,kx,Gx,Hx,Vx,jx,Wx,qx,Xx,Yx,Kx,Qx,Zx,Jx,$x,eT,tT,nT,iT,rT,oT,aT,sT,cT,lT,uT,hT,_T,fT,pT,dT,mT,vT,gT,yT,ST,xT,TT=new Qo([KS],QS),ET={width:1,height:1,renderPassInfo:TT},CT=e("RenderTexture",al("cc.RenderTexture")(HS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=r.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(Zn(e,1,2048)),this._height=Math.floor(Zn(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=r.director.root;ET.title=this._name,ET.width=this._width,ET.height=this._height,ET.renderPassInfo=e&&e.passInfo?e.passInfo:TT,this._window?(this._window.destroy(),this._window.initialize(t.device,ET)):this._window=t.createWindow(ET)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),i=(n=n||this.width)||this.height;var r=this.getGFXTexture();if(!r)return null;var o=this._getGFXDevice(),a=[],s=[],c=new So;c.texOffset.x=e,c.texOffset.y=t,c.texExtent.width=n,c.texExtent.height=i,s.push(c);var l=new Uint8Array(n*i*4);return a.push(l),null==o||o.copyTextureToBuffers(r,a,s),l},B(t,[{key:"window",get:function(){return this._window}}]),t}(km))||HS);r.RenderTexture=CT,Je(Or),Je(Dr),Je(Wr),Je(jr),Je(qr),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(xT||(xT={})),Je(xT),ZS=al("RenderTextureDesc"),JS=Gl(Or),$S=Gl(Dr),ex=Gl(Cr),ZS((nx=Y((tx=function(){X(this,"name",nx,this),X(this,"type",ix,this),X(this,"usage",rx,this),X(this,"format",ox,this),X(this,"width",ax,this),X(this,"height",sx,this)}).prototype,"name",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ix=Y(tx.prototype,"type",[JS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Or.TEX2D}}),rx=Y(tx.prototype,"usage",[$S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.COLOR_ATTACHMENT}}),ox=Y(tx.prototype,"format",[ex],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cr.UNKNOWN}}),ax=Y(tx.prototype,"width",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),sx=Y(tx.prototype,"height",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),tx));var bT,AT=(cx=al("RenderTextureConfig"),lx=Gl(CT),cx((_x=Y((hx=function(){X(this,"name",_x,this),X(this,"texture",fx,this)}).prototype,"name",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fx=Y(hx.prototype,"texture",[lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ux=hx))||ux),wT=(px=al("MaterialConfig"),dx=Gl(Mg),px((vx=Y((mx=function(){X(this,"name",vx,this),X(this,"material",gx,this)}).prototype,"name",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gx=Y(mx.prototype,"material",[dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mx)),yx=al("FrameBufferDesc"),Sx=Gl([bt]),xx=Gl(CT),yx((Ex=Y((Tx=function(){X(this,"name",Ex,this),X(this,"renderPass",Cx,this),X(this,"colorTextures",bx,this),X(this,"depthStencilTexture",Ax,this),X(this,"texture",wx,this)}).prototype,"name",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Cx=Y(Tx.prototype,"renderPass",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bx=Y(Tx.prototype,"colorTextures",[Sx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ax=Y(Tx.prototype,"depthStencilTexture",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wx=Y(Tx.prototype,"texture",[xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tx)),Rx=al("ColorDesc"),Ix=Gl(Cr),Px=Gl(jr),Ox=Gl(Wr),Dx=Gl([qr]),Mx=Gl([qr]),Rx((Bx=Y((Lx=function(){X(this,"format",Bx,this),X(this,"loadOp",Fx,this),X(this,"storeOp",zx,this),X(this,"sampleCount",Ux,this),X(this,"beginAccesses",kx,this),X(this,"endAccesses",Gx,this)}).prototype,"format",[Ix],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cr.UNKNOWN}}),Fx=Y(Lx.prototype,"loadOp",[Px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jr.CLEAR}}),zx=Y(Lx.prototype,"storeOp",[Ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wr.STORE}}),Ux=Y(Lx.prototype,"sampleCount",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kx=Y(Lx.prototype,"beginAccesses",[Dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gx=Y(Lx.prototype,"endAccesses",[Mx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[qr.COLOR_ATTACHMENT_WRITE]}}),Nx=Lx))||Nx),RT=(Hx=al("DepthStencilDesc"),Vx=Gl(Cr),jx=Gl(jr),Wx=Gl(Wr),qx=Gl(jr),Xx=Gl(Wr),Yx=Gl([qr]),Kx=Gl([qr]),Hx((Jx=Y((Zx=function(){X(this,"format",Jx,this),X(this,"depthLoadOp",$x,this),X(this,"depthStoreOp",eT,this),X(this,"stencilLoadOp",tT,this),X(this,"stencilStoreOp",nT,this),X(this,"sampleCount",iT,this),X(this,"beginAccesses",rT,this),X(this,"endAccesses",oT,this)}).prototype,"format",[Vx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cr.UNKNOWN}}),$x=Y(Zx.prototype,"depthLoadOp",[jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jr.CLEAR}}),eT=Y(Zx.prototype,"depthStoreOp",[Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wr.STORE}}),tT=Y(Zx.prototype,"stencilLoadOp",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jr.CLEAR}}),nT=Y(Zx.prototype,"stencilStoreOp",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wr.STORE}}),iT=Y(Zx.prototype,"sampleCount",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rT=Y(Zx.prototype,"beginAccesses",[Yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oT=Y(Zx.prototype,"endAccesses",[Kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[qr.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),Qx=Zx))||Qx);aT=al("RenderPassDesc"),sT=Gl([wT]),cT=Gl(RT),aT((uT=Y((lT=function(){X(this,"index",uT,this),X(this,"colorAttachments",hT,this),X(this,"depthStencilAttachment",_T,this)}).prototype,"index",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),hT=Y(lT.prototype,"colorAttachments",[sT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_T=Y(lT.prototype,"depthStencilAttachment",[cT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RT}}),lT)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(bT||(bT={})),Je(bT);var IT=(fT=al("RenderQueueDesc"),pT=Gl(bT),dT=Gl([bt]),fT((gT=Y((vT=function(){X(this,"isTransparent",gT,this),X(this,"sortMode",yT,this),X(this,"stages",ST,this)}).prototype,"isTransparent",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yT=Y(vT.prototype,"sortMode",[pT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bT.FRONT_TO_BACK}}),ST=Y(vT.prototype,"stages",[dT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mT=vT))||mT);function PT(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function OT(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var DT=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new qe((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Xe(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=e.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=mg.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(Jp.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Jp.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function MT(e){for(var t=0,n=0;n<e.stages.length;n++)t|=Vv(e.stages[n]);var i=PT;switch(e.sortMode){case bT.BACK_TO_FRONT:i=OT;break;case bT.FRONT_TO_BACK:i=PT}return new DT({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function NT(e){e.clear()}function LT(e){e.sort()}var BT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=mg.getOrCreatePipelineState(e,s.pass,c,t,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(Jp.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(Jp.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},e}(),FT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(Jp.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,_=mg.getOrCreatePipelineState(e,s,h,t,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(Jp.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},e}(),zT=new We((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),UT=new Float32Array(4),kT=[],GT=[],HT=new Mi,VT=new Mi;function jT(e,t){return!(!t.worldBounds||ic.aabbWithAABB(t.worldBounds,e.aabb))}function WT(e,t){return!(!t.worldBounds||ic.aabbWithAABB(t.worldBounds,e.aabb)&&ic.aabbFrustum(t.worldBounds,e.frustum))}var qT=Vv("forward-add"),XT=[];function YT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===qT){o=a,n=!0;break}t.push(o)}return n}var KT,QT,ZT,JT,$T,eE,tE,nE,iE,rE,oE,aE=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(rd.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new FT,this._batchedQueue=new BT;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(xd.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new wo(this._lightBuffer,0,xd.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}zT.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(rd.BINDING).destroy(),r.getTexture(od).destroy(),r.getTexture(pd).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(YT(a,XT)&&(GT.length=0,this._lightCulling(o,n),GT.length))for(var s=0;s<a.length;s++){var c=XT[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(xd.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],_=a.inputAssembler,f=mg.getOrCreatePipelineState(e,u,h,t,_),p=u.descriptorSet,d=a.descriptorSet;n.bindPipelineState(f),n.bindDescriptorSet(Jp.MATERIAL,p),n.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);kT[0]=c[m],n.bindDescriptorSet(Jp.GLOBAL,g),n.bindDescriptorSet(Jp.LOCAL,d,kT),n.draw(_)}}},t._lightCulling=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=!1;switch(i.type){case kg.SPHERE:r=jT(i,e);break;case kg.SPOT:r=WT(i,e)}r||GT.push(n)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===Uv.INSTANCING)for(var o=0;o<GT.length;o++){var a=GT[o],s=e.getInstancedBuffer(a);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===Uv.VB_MERGING)for(var c=0;c<GT.length;c++){var l=GT[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=zT.alloc();h.subModel=t,h.passIdx=i;for(var _=0;_<GT.length;_++){var f=GT[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=e.scene.mainLight,s=sm(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,p=void 0;switch(h.type){case kg.SPHERE:a&&Wy(r,a,this._shadowUBO),this._shadowUBO[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,mi.toArray(this._shadowUBO,r.shadowColor,rd.SHADOW_COLOR_OFFSET);break;case kg.SPOT:if(a&&Wy(r,a,this._shadowUBO),Mi.invert(HT,h.node.getWorldMatrix()),Mi.perspective(VT,h.angle,h.aspect,.001,h.range),f=VT.clone(),p=VT.clone().invert(),Mi.multiply(VT,VT,HT),Mi.toArray(this._shadowUBO,HT,rd.MAT_LIGHT_VIEW_OFFSET),Mi.toArray(this._shadowUBO,VT,rd.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[rd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[rd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[rd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[rd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[rd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[rd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[rd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[rd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[rd.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[rd.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[rd.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[rd.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,mi.toArray(this._shadowUBO,r.shadowColor,rd.SHADOW_COLOR_OFFSET),o.has(h)){var d,m=null===(d=o.get(h))||void 0===d?void 0:d.colorTextures[0];m&&_.bindTexture(pd,m)}}_.update(),t.updateBuffer(_.getBuffer(rd.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=ci(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new wo(this._lightBuffer,0,xd.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case kg.SPHERE:if(gi.toArray(UT,l.position),UT[3]=0,this._lightBufferData.set(UT,c+xd.LIGHT_POS_OFFSET),UT[0]=l.size,UT[1]=l.range,UT[2]=0,UT[3]=o.enabled&&o.type===Lg.ShadowMap?1:0,this._lightBufferData.set(UT,c+xd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),gi.toArray(UT,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;UT[0]*=u.x,UT[1]*=u.y,UT[2]*=u.z}UT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(UT,c+xd.LIGHT_COLOR_OFFSET);break;case kg.SPOT:if(gi.toArray(UT,l.position),UT[3]=1,this._lightBufferData.set(UT,c+xd.LIGHT_POS_OFFSET),UT[0]=l.size,UT[1]=l.range,UT[2]=l.spotAngle,UT[3]=o.enabled&&o.type===Lg.ShadowMap?1:0,this._lightBufferData.set(UT,c+xd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),gi.toArray(UT,l.direction),this._lightBufferData.set(UT,c+xd.LIGHT_DIR_OFFSET),gi.toArray(UT,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;UT[0]*=h.x,UT[1]*=h.y,UT[2]*=h.z}UT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(UT,c+xd.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),sE=new Fc,cE=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new FT,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===Lg.Planar){var r=e.scene,o=e.frustum,a=0!=(e.visibility&kp.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(Fc.transform(sE,_.worldBounds,i.matLight),ic.aabbFrustum(sE,o)))if(_.isInstancingEnabled)for(var f=_.subModels,p=0;p<f.length;p++){var d=f[p];u.merge(d,_.instancedAttributes,0,d.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Lg.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(Jp.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=mg.getOrCreatePipelineState(e,r,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(Jp.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},e}(),lE=function(){function e(){this._phaseID=Vv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,p=mg.getOrCreatePipelineState(i,h,_,t,f);r.bindPipelineState(p),r.bindDescriptorSet(Jp.MATERIAL,h.descriptorSet);var d=s.descriptorSet;r.bindDescriptorSet(Jp.LOCAL,d),r.bindInputAssembler(f),r.draw(f)}}}},e}(),uE=[new To(0,0,0,1)],hE=e("ForwardStage",(KT=al("ForwardStage"),QT=Gl([IT]),ZT=Ml(),KT((nE=tE=function(e){function t(){var t;return X(t=e.call(this)||this,"renderQueues",eE,j(t)),t._renderQueues=[],t._renderArea=new fo,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Vv("default"),t._clearFlag=4294967295,t._batchedQueue=new BT,t._instancedQueue=new FT,t._uiPhase=new lE,t}z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=MT(this.renderQueues[i]);this._additiveLightQueue=new aE(this._pipeline),this._planarQueue=new cE(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(NT);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Uv.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===Uv.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(LT);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&oo.COLOR&&(uE[0].x=e.clearColor.x,uE[0].y=e.clearColor.y,uE[0].z=e.clearColor.z,uE[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.swapchain,g=e.window.framebuffer,y=v?t.getRenderPass(e.clearFlag&this._clearFlag,v):g.renderPass;m.beginRenderPass(y,g,this._renderArea,uE,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Jp.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,y,m),this._instancedQueue.recordCommandBuffer(n,y,m),this._batchedQueue.recordCommandBuffer(n,y,m),this._additiveLightQueue.recordCommandBuffer(n,y,m),m.bindDescriptorSet(Jp.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,y,m),this._renderQueues[1].recordCommandBuffer(n,y,m),this._uiPhase.render(e,y),Og(n,y,m,t.profiler,e),m.endRenderPass()},t}(bS),tE.initInfo={name:"ForwardStage",priority:zS.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:bT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:bT.BACK_TO_FRONT,stages:["default","planarShadow"]}]},eE=Y(($T=nE).prototype,"renderQueues",[QT,_l,ZT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JT=$T))||JT)),_E=e("ForwardFlow",al("ForwardFlow")((oE=rE=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new hE;n.initialize(hE.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(wS),rE.initInfo={name:jp,priority:US.FORWARD,stages:[]},iE=oE))||iE),fE=new Mi,pE=new Mi,dE=new Mi,mE=new Fc,vE=Vv("shadow-caster"),gE=[];function yE(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===vE){o=a,n=!0;break}t.push(o)}return n}var SE,xE,TE,EE,CE,bE,AE=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new FT,this._batchedQueue=new BT}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows,a=r.dirShadowObjects,s=r.castShadowObjects;if(n&&o.enabled&&o.type===Lg.ShadowMap)switch(n.type){case kg.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;yE(l.subModels,gE)&&this.add(l,i,gE)}break;case kg.SPOT:Mi.invert(fE,n.node.getWorldMatrix()),Mi.perspective(pE,n.angle,n.aspect,.001,n.range),Mi.multiply(dE,pE,fE);for(var u=0;u<s.length;u++){var h=s[u].model;yE(h.subModels,gE)&&(h.worldBounds&&(Fc.transform(mE,h.worldBounds,dE),!ic.aabbFrustum(mE,t.frustum))||this.add(h,i,gE))}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t,n){for(var i=e.subModels,r=0;r<i.length;r++){var o=i[r],a=n[r],s=o.passes[a];if(s.batchingScheme===Uv.INSTANCING){var c=s.getInstancedBuffer();c.merge(o,e.instancedAttributes,a),this._instancedQueue.queue.add(c)}else if(s.batchingScheme===Uv.VB_MERGING){var l=s.getBatchedBuffer();l.merge(o,a,e),this._batchedQueue.queue.add(l)}else{var u=o.shaders[a];this._subModelsArray.push(o),u&&this._shaderArray.push(u),this._passArray.push(s)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=mg.getOrCreatePipelineState(e,a,o,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Jp.MATERIAL,l),n.bindDescriptorSet(Jp.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),wE=[new To(1,1,1,1)],RE=e("ShadowStage",al("ShadowStage")((TE=xE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new fo,t._light=null,t._globalDS=null,t}z(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){wE[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,wE,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,e,this._light,a);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,wE,e.clearDepth,e.clearStencil),a.bindDescriptorSet(Jp.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new AE(t)},t}(bS),xE.initInfo={name:"ShadowStage",priority:zS.FORWARD,tag:0},SE=TE))||SE),IE=[],PE=e("ShadowFlow",al("ShadowFlow")((bE=CE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new RE;n.initialize(RE.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===Lg.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===kg.SPOT&&(IE.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(e)}}for(var p=0;p<IE.length;p++){var d=IE[p],m=t.globalDSManager.getOrCreateDescriptorSet(p);i.has(d)||this._initShadowFrameBuffer(t,d,e.window.swapchain);for(var v=i.get(d),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,d,v),y.render(e)}}IE.length=0}else this.clearShadowMap(IE,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,o=sm(n)?Cr.R32F:Cr.RGBA8;if(!this._shadowRenderPass){var a=new qo;a.format=o,a.loadOp=jr.CLEAR,a.storeOp=Wr.STORE,a.sampleCount=1;var s=new Xo;s.format=Cr.DEPTH_STENCIL,s.depthLoadOp=jr.CLEAR,s.depthStoreOp=Wr.DISCARD,s.stencilLoadOp=jr.CLEAR,s.stencilStoreOp=Wr.DISCARD,s.sampleCount=1;var c=new Qo([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new Oo(Or.TEX2D,Dr.DEPTH_STENCIL_ATTACHMENT,Cr.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new $o(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var p=this._stages[f];p.setUsage(_,u,h),p.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=sm(i)?Cr.R32F:Cr.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,o,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new $o(h,l,u)),s=a.next()}else s=a.next()}e.shadowMapDirty=!1},t}(wS),CE.initInfo={name:Wp,priority:US.SHADOW,tag:xT.SCENE,stages:[]},EE=bE))||EE),OE=new Gi,DE=Ke({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),ME=DE.LAYERED+1,NE=function(){function e(){this._fogColor=new mi("#C8C8C8"),this._colorArray=new Gi(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:ME},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=r.director.root,t=this.enabled?this.type:ME,n=this.accurate?1:0,i=e.pipeline;i.macros.CC_USE_FOG===t&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=t,i.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=ME,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),OE.set(e.x,e.y,e.z,e.w),yg(this._colorArray,OE)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();function LE(e,t){for(var n,i=q(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?LE(e,r):e.push(r)}}function BE(e){var t=[];return LE(t,e),t.join("")}r.Fog=NE;var FE=Kt.Flags.Destroyed,zE=Kt.Flags.PersistentMask,UE=Ht.IDENTIFIER_RE,kE="var ",GE="o",HE={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},VE=Ht.escapeForJS,jE=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return kE+this.varName+"="+this.expression+";"},e}();function WE(e,t){return t instanceof jE?new jE(t.varName,e+t.expression):e+t}function qE(e,t,n){Array.isArray(n)?(n[0]=WE(t,n[0]),e.push(n)):e.push(WE(t,n)+";")}var XE=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];qE(e,t+YE(i[0])+"=",i[1])}},e}();function YE(e){return UE.test(e)?"."+e:"["+VE(e)+"]"}XE.pool=void 0,XE.pool=new ke((function(e){e._exps.length=0,e._targetExp=null}),1),XE.pool.get=function(e){var t=this._get()||new XE;return t._targetExp=e,t};var KE=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=fe(),Ce(this.funcModuleCache,HE),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=kE+this.globalVariables.join(",")+";");var i=BE(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=pe(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=XE.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),XE.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var i=n.__values__,o=yt(n),a=0;a<i.length;a++){var s=i[a],c=t[s],l=o[s+"$_$default"];if(!QE(l,c))if("object"==typeof c&&c instanceof r.ValueType&&(l=Ht.getDefault(l))&&l.constructor===c.constructor){var u=GE+YE(s);this.setValueType(e,l,c,u)}else this.setObjProp(e,t,s,c)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new jE(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)qE(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new jE(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&qE(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=WE(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?VE(n):("_objFlags"===t&&e instanceof Kt&&(n&=zE),n)},t.setObjProp=function(e,t,n,i){qE(e,GE+YE(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(r.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var o=t[i];"object"==typeof o&&o&&o===t._iN$t||this.setObjProp(e,t,i,o)}},t.instantiateObj=function(e){if(e instanceof r.ValueType)return Ht.getNewValueTypeCode(e);if(e instanceof r.Asset)return this.getObjRef(e);if(e._objFlags&FE)return null;var t,n=e.constructor;if(r.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof r.Component){if(e instanceof r._BaseNode||e instanceof r.Component)return this.getObjRef(e)}else if(this.parent instanceof r._BaseNode)if(e instanceof r._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof r.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new jE(GE,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new jE(GE,"{}");else{if(n)return this.getObjRef(e);t=new jE(GE,"Object.create(null)")}var i=[t];return e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e),this.enumerateObject(i,e),["(function(){",i,"return o;})();"]},e}();function QE(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof r.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return se(e)&&se(t)}return!1}var ZE,JE,$E,eC,tC,nC,iC,rC,oC,aC,sC=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.opacityDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(t,n){void 0===n&&(n=!0),t._uiProps.opacityDirty=n;for(var i=0,r=t.children.length;i<r;i++){var o=t.children[i];e.markOpacityTree(o,n)}},B(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?b(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,e.markOpacityTree(this._node)}}]),e}();Kt.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(ZE||(ZE={}));var cC=Kt.Flags.Destroying,lC=Kt.Flags.DontDestroy,uC=Kt.Flags.Deactivating,hC=new te("Node");function _C(e){return e?"string"==typeof e?ze(e):e:(w(3804),null)}var fC,pC,dC,mC,vC,gC,yC,SC,xC,TC,EC,CC=e("BaseNode",al("cc.BaseNode")((aC=oC=function(e){z(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],o=n._findComponent(r,t);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,t)))return o}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var o=e[r];n._findComponents(o,t,i),o._children.length>0&&n._findChildComponents(o._children,t,i)}};var t=n.prototype;function n(t){var n;return X(n=e.call(this,t)||this,"_parent",eC,j(n)),X(n,"_children",tC,j(n)),X(n,"_active",nC,j(n)),X(n,"_components",iC,j(n)),X(n,"_prefab",rC,j(n)),n._scene=null,n._activeInHierarchy=!1,n._id=hC.getNewId(),n._name=void 0,n._eventProcessor=new r.NodeEventProcessor(j(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?m("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){Ce(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(ZE.PARENT_CHANGED,n),n&&!(n._objFlags&cC)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(ZE.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(ZE.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return p("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return p("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&uC)w(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&t&&t(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=_C(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=_C(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=_C(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=_C(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=ze(e)))throw r._RF.peek()&&w(3808,e),TypeError(O(3807,e))}else{if(!e)throw TypeError(O(3804));t=e}if("function"!=typeof t)throw TypeError(O(3809));if(!we(t,r.Component))throw TypeError(O(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var o=n[i];this.getComponent(o)||this.addComponent(o)}else{var a=n;this.getComponent(a)||this.addComponent(a)}var s=new t;return s.node=this,this._components.push(s),this._activeInHierarchy&&r.director._nodeActivator.activateComp(s),s},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof rh?e:this.getComponent(e))&&t.destroy()}else w(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case ZE.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case ZE.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(ZE.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&cC)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&w(3815)}}else w(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(ZE.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=r.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof r.Scene||r.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&r.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=cC;var e=this._parent,t=!!e&&0!=(e._objFlags&cC);if(this._persistNode&&r.game.removePersistRootNode(this),!t&&e){this.emit(ZE.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(ZE.CHILD_REMOVED,this)}this.emit(ZE.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,o=0;o<i.length;++o)i[o]._destroyImmediate();for(var a=this._components,s=0;s<a.length;++s)a[s]._destroyImmediate();return t},B(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&lC)>0},set:function(e){e?this._objFlags|=lC:this._objFlags&=~lC}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&r.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(Kt),oC.idGenerator=hC,oC._stacks=[[]],oC._stackId=0,Y(($E=aC).prototype,"_persistNode",[ul],Object.getOwnPropertyDescriptor($E.prototype,"_persistNode"),$E.prototype),Y($E.prototype,"name",[El],Object.getOwnPropertyDescriptor($E.prototype,"name"),$E.prototype),Y($E.prototype,"children",[El],Object.getOwnPropertyDescriptor($E.prototype,"children"),$E.prototype),Y($E.prototype,"active",[El],Object.getOwnPropertyDescriptor($E.prototype,"active"),$E.prototype),Y($E.prototype,"activeInHierarchy",[El],Object.getOwnPropertyDescriptor($E.prototype,"activeInHierarchy"),$E.prototype),Y($E.prototype,"parent",[El],Object.getOwnPropertyDescriptor($E.prototype,"parent"),$E.prototype),eC=Y($E.prototype,"_parent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tC=Y($E.prototype,"_children",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nC=Y($E.prototype,"_active",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iC=Y($E.prototype,"_components",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rC=Y($E.prototype,"_prefab",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JE=$E))||JE);r._BaseNode=CC;var bC=new gi,AC=new bi,wC=new bi,RC=new bi,IC=new Ti,PC=new Ti,OC=new Mi,DC=[],MC=[],NC=[],LC=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return NC[0]=this._chunks[e],NC[1]=this._freelists[e].pop(),NC},e}();LC.CAPACITY_PER_CHUNK=256;var BC,FC,zC,UC,kC,GC,HC,VC,jC,WC,qC,XC,YC,KC,QC,ZC,JC,$C,eb,tb,nb,ib,rb,ob,ab,sb,cb,lb,ub,hb,_b,fb,pb,db,mb,vb,gb,yb,Sb,xb,Tb,Eb,Cb,bb,Ab,wb,Rb,Ib,Pb,Ob,Db,Mb,Nb,Lb,Bb,Fb,zb,Ub,kb,Gb,Hb,Vb,jb,Wb,qb,Xb,Yb,Kb,Qb,Zb=new LC,Jb=Symbol("ReserveContentsForAllSyncablePrefab"),$b=e("Node",(fC=al("cc.Node"),pC=Gl(gi),fC((EC=TC=function(e){z(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new sC(j(n)),n._static=!1,X(n,"_lpos",vC,j(n)),X(n,"_lrot",gC,j(n)),X(n,"_lscale",yC,j(n)),X(n,"_layer",SC,j(n)),X(n,"_euler",xC,j(n)),n._dirtyFlagsPri=ng.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=Zb.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new gi,this._rot=new bi,this._scale=new gi(1,1,1),this._mat=new Mi},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof r.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return Zb.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[dh]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),Mi.multiply(OC,Mi.invert(OC,i._mat),this._mat),Mi.toRTS(OC,this._lrot,this._lpos,this._lscale)):(gi.copy(this._lpos,this._pos),bi.copy(this._lrot,this._rot),gi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(ng.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=ng.TRS,this._dirtyFlags|=ng.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(ng.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||tg.LOCAL;if(n===tg.LOCAL)gi.transformQuat(bC,e,this._lrot),this._lpos.x+=bC.x,this._lpos.y+=bC.y,this._lpos.z+=bC.z;else if(n===tg.WORLD)if(this._parent){bi.invert(AC,this._parent.worldRotation),gi.transformQuat(bC,e,AC);var i=this.worldScale;this._lpos.x+=bC.x/i.x,this._lpos.y+=bC.y/i.y,this._lpos.z+=bC.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(ng.POSITION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.POSITION)},t.rotate=function(e,t){var n=t||tg.LOCAL;if(bi.normalize(AC,e),n===tg.LOCAL)bi.multiply(this._lrot,this._lrot,AC);else if(n===tg.WORLD){var i=this.worldRotation;bi.multiply(wC,AC,i),bi.invert(AC,i),bi.multiply(wC,AC,wC),bi.multiply(this._lrot,this._lrot,wC)}this._eulerDirty=!0,this.invalidateChildren(ng.ROTATION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(bC),gi.subtract(bC,bC,e),gi.normalize(bC,bC),bi.fromViewUp(AC,bC,t),this.setWorldRotation(AC)},t._setDirtyNode=function(e,t){DC[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,o=0,a=0,s=0,c=0,l=e|ng.POSITION;for(DC[0]=this;r>=0;){if(c=(t=DC[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,a=(i=t._children).length,o=0;o<a;o++)n=i[o],DC[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=DC[--n])._dirtyFlags,t?(i&ng.POSITION&&(gi.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&ng.RS&&(Mi.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Mi.multiply(e._mat,t._mat,e._mat),i&ng.ROTATION&&bi.multiply(e._rot,t._rot,e._lrot),Ti.fromQuat(IC,bi.conjugate(RC,e._rot)),Ti.multiplyMat4(IC,IC,e._mat),e._scale.x=IC.m00,e._scale.y=IC.m04,e._scale.z=IC.m08)):(i&ng.POSITION&&(gi.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&ng.RS&&(i&ng.ROTATION&&bi.copy(e._rot,e._lrot),i&ng.SCALE&&(gi.copy(e._scale,e._lscale),Mi.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=ng.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?gi.copy(this._lpos,e):void 0===n?gi.set(this._lpos,e,t,this._lpos.z):gi.set(this._lpos,e,t,n),this.invalidateChildren(ng.POSITION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.POSITION)},t.getPosition=function(e){return e?gi.set(e,this._lpos.x,this._lpos.y,this._lpos.z):gi.copy(new gi,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?bi.copy(this._lrot,e):bi.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(ng.ROTATION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(gi.copy(this._euler,e),bi.fromEuler(this._lrot,e.x,e.y,e.z)):(gi.set(this._euler,e,t,i),bi.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(ng.ROTATION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.ROTATION)},t.getRotation=function(e){return e?bi.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):bi.copy(new bi,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?gi.copy(this._lscale,e):void 0===n?gi.set(this._lscale,e,t,this._lscale.z):gi.set(this._lscale,e,t,n),this.invalidateChildren(ng.SCALE),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.SCALE)},t.getScale=function(e){return e?gi.set(e,this._lscale.x,this._lscale.y,this._lscale.z):gi.copy(new gi,this._lscale)},t.inverseTransformPoint=function(e,t){gi.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)gi.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=DC[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?gi.copy(this._pos,e):gi.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),gi.transformMat4(r,this._pos,Mi.invert(OC,i._mat))):gi.copy(r,this._pos),this.invalidateChildren(ng.POSITION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?gi.copy(e,this._pos):gi.copy(new gi,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?bi.copy(this._rot,e):bi.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),bi.multiply(this._lrot,bi.conjugate(this._lrot,this._parent._rot),this._rot)):bi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ng.ROTATION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){bi.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),bi.multiply(this._lrot,bi.conjugate(this._lrot,this._parent._rot),this._rot)):bi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ng.ROTATION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?bi.copy(e,this._rot):bi.copy(new bi,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?gi.copy(this._scale,e):gi.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Ti.fromQuat(IC,bi.conjugate(RC,i._rot)),Ti.multiplyMat4(IC,IC,i._mat),PC.m00=this._scale.x,PC.m04=this._scale.y,PC.m08=this._scale.z,Ti.multiply(IC,PC,Ti.invert(IC,IC)),this._lscale.x=gi.set(bC,IC.m00,IC.m01,IC.m02).length(),this._lscale.y=gi.set(bC,IC.m03,IC.m04,IC.m05).length(),this._lscale.z=gi.set(bC,IC.m06,IC.m07,IC.m08).length()):gi.copy(this._lscale,this._scale),this.invalidateChildren(ng.SCALE),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?gi.copy(e,this._scale):gi.copy(new gi,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new Mi;return Mi.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new Mi;return Mi.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new Mi;return Mi.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=ng.ROTATION,void 0!==e.w?(bi.copy(this._lrot,e),this._eulerDirty=!0):(gi.copy(this._euler,e),bi.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(gi.copy(this._lpos,t),i|=ng.POSITION),n&&(gi.copy(this._lscale,n),i|=ng.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){Zb.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,DC.length=0,MC.length=0)},B(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(bi.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){gi.set(this._euler,0,0,e),bi.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(ng.ROTATION),1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Mi.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(ng.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(ZE.TRANSFORM_CHANGED,ng.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return gi.transformQuat(new gi,gi.FORWARD,this.worldRotation)},set:function(e){var t=e.length();gi.multiplyScalar(bC,e,-1/t),bi.fromViewUp(AC,bC),this.setWorldRotation(AC)}},{key:"up",get:function(){return gi.transformQuat(new gi,gi.UP,this.worldRotation)}},{key:"right",get:function(){return gi.transformQuat(new gi,gi.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(ZE.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(CC),TC.EventType=ZE,TC.NodeSpace=tg,TC.TransformDirtyBit=ng,TC.TransformBit=ng,TC.reserveContentsForAllSyncablePrefabTag=Jb,TC.ClearFrame=0,TC.ClearRound=1e3,vC=Y((mC=EC).prototype,"_lpos",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),gC=Y(mC.prototype,"_lrot",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bi}}),yC=Y(mC.prototype,"_lscale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(1,1,1)}}),SC=Y(mC.prototype,"_layer",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kp.Enum.DEFAULT}}),xC=Y(mC.prototype,"_euler",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),Y(mC.prototype,"eulerAngles",[pC],Object.getOwnPropertyDescriptor(mC.prototype,"eulerAngles"),mC.prototype),Y(mC.prototype,"angle",[El],Object.getOwnPropertyDescriptor(mC.prototype,"angle"),mC.prototype),Y(mC.prototype,"layer",[El],Object.getOwnPropertyDescriptor(mC.prototype,"layer"),mC.prototype),dC=mC))||dC));r.Node=$b;var eA=al("cc.TargetInfo")((zC=Y((FC=function(){X(this,"localID",zC,this)}).prototype,"localID",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BC=FC))||BC,tA=(UC=al("cc.TargetOverrideInfo"),kC=Gl(Kt),GC=Gl(eA),HC=Gl($b),VC=Gl(eA),UC((qC=Y((WC=function(){X(this,"source",qC,this),X(this,"sourceInfo",XC,this),X(this,"propertyPath",YC,this),X(this,"target",KC,this),X(this,"targetInfo",QC,this)}).prototype,"source",[_l,kC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XC=Y(WC.prototype,"sourceInfo",[_l,GC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YC=Y(WC.prototype,"propertyPath",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KC=Y(WC.prototype,"target",[_l,HC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QC=Y(WC.prototype,"targetInfo",[_l,VC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jC=WC))||jC),nA=al("cc.CompPrefabInfo")(($C=Y((JC=function(){X(this,"fileId",$C,this)}).prototype,"fileId",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZC=JC))||ZC,iA=(eb=al("CCPropertyOverrideInfo"),tb=Gl(eA),eb((sb=function(){function e(){X(this,"targetInfo",rb,this),X(this,"propertyPath",ob,this),X(this,"value",ab,this)}return e.prototype.isTarget=function(){},e}(),rb=Y((ib=sb).prototype,"targetInfo",[_l,tb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ob=Y(ib.prototype,"propertyPath",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ab=Y(ib.prototype,"value",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),nb=ib))||nb),rA=(cb=al("cc.MountedChildrenInfo"),lb=Gl(eA),ub=Gl([$b]),cb((db=function(){function e(){X(this,"targetInfo",fb,this),X(this,"nodes",pb,this)}return e.prototype.isTarget=function(){},e}(),fb=Y((_b=db).prototype,"targetInfo",[_l,lb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pb=Y(_b.prototype,"nodes",[_l,ub],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hb=_b))||hb),oA=(mb=al("cc.MountedComponentsInfo"),vb=Gl(eA),gb=Gl([rh]),mb((Eb=function(){function e(){X(this,"targetInfo",xb,this),X(this,"components",Tb,this)}return e.prototype.isTarget=function(){},e}(),xb=Y((Sb=Eb).prototype,"targetInfo",[_l,vb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tb=Y(Sb.prototype,"components",[_l,gb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yb=Sb))||yb),aA=(Cb=al("cc.PrefabInstance"),bb=Gl($b),Ab=Gl([rA]),wb=Gl([oA]),Rb=Gl([iA]),Ib=Gl([eA]),Cb((zb=function(){function e(){X(this,"fileId",Db,this),X(this,"prefabRootNode",Mb,this),X(this,"mountedChildren",Nb,this),X(this,"mountedComponents",Lb,this),X(this,"propertyOverrides",Bb,this),X(this,"removedComponents",Fb,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),Db=Y((Ob=zb).prototype,"fileId",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mb=Y(Ob.prototype,"prefabRootNode",[_l,bb],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Nb=Y(Ob.prototype,"mountedChildren",[_l,Ab],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lb=Y(Ob.prototype,"mountedComponents",[_l,wb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bb=Y(Ob.prototype,"propertyOverrides",[_l,Rb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fb=Y(Ob.prototype,"removedComponents",[_l,Ib],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pb=Ob))||Pb),sA=(Ub=al("cc.PrefabInfo"),kb=Gl($b),Gb=Gl(aA),Hb=Gl([tA]),Ub((Wb=Y((jb=function(){X(this,"root",Wb,this),X(this,"asset",qb,this),X(this,"fileId",Xb,this),X(this,"instance",Yb,this),X(this,"targetOverrides",Kb,this),X(this,"nestedPrefabInstanceRoots",Qb,this)}).prototype,"root",[_l,kb],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qb=Y(jb.prototype,"asset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Xb=Y(jb.prototype,"fileId",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yb=Y(jb.prototype,"instance",[_l,Gb],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Kb=Y(jb.prototype,"targetOverrides",[_l,Hb],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Qb=Y(jb.prototype,"nestedPrefabInstanceRoots",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vb=jb))||Vb);function cA(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return w(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,o=e._id,a=e._prefab;e[qt],r.game._isCloning=!0,t.asset._doInstantiate(e),r.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=o,e._prefab&&(e._prefab.instance=null==a?void 0:a.instance)}}function lA(e,t,n){var i;if(t&&e){var r=t,o=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&o&&(t[o.fileId]={},r=t[o.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)lA(e.children[u],r,!1)}}function uA(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function hA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=uA(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,lA(u,a,!1),u._siblingIndex=o._children.length-1,mA(u,!0))}}}}function _A(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=uA(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function fA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=uA(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function pA(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var o=t[r];if(o&&o.targetInfo){if(!(i=uA(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof $e?a[c].set(o.value):a[c]=o.value}}}}function dA(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=uA(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var p=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(p&&p.targetMap&&(_=uA(f.localID,p.targetMap))){var d=a.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=_}}}}}}function mA(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){cA(e);var r={};i.targetMap=r,lA(e,r,!0),hA(0,i.mountedChildren,r),fA(0,i.removedComponents,r),_A(0,i.mountedComponents,r),pA(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){mA(e,!0)}))}function vA(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){mA(e)}))}r._PrefabInfo=sA;var gA,yA,SA,xA,TA,EA,CA,bA,AA,wA,RA,IA,PA,OA=Object.freeze({__proto__:null,TargetInfo:eA,TargetOverrideInfo:tA,CompPrefabInfo:nA,PropertyOverrideInfo:iA,MountedChildrenInfo:rA,MountedComponentsInfo:oA,PrefabInstance:aA,PrefabInfo:sA,createNodeWithPrefab:cA,generateTargetMap:lA,getTarget:uA,applyMountedChildren:hA,applyMountedComponents:_A,applyRemovedComponents:fA,applyPropertyOverrides:pA,applyTargetOverrides:dA,expandPrefabInstanceNode:mA,expandNestedPrefabInstanceNode:vA}),DA=Ke({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),MA=e("Prefab",al("cc.Prefab")((EA=TA=function(e){function t(){var t;return X(t=e.call(this)||this,"data",SA,j(t)),X(t,"optimizationPolicy",xA,j(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}z(t,e);var n=t.prototype;return n.createNode=function(e){var t=r.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof r._BaseNode&&e,new KE(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||b(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==DA.SINGLE_INSTANCE&&(this.optimizationPolicy===DA.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new $b,this.data.name="(Missing Node)";var n=new r._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;vA(e),dA(e)},t}(Fu),TA.OptimizationPolicy=DA,TA.OptimizationPolicyThreshold=3,SA=Y((yA=EA).prototype,"data",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xA=Y(yA.prototype,"optimizationPolicy",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DA.AUTO}}),gA=yA))||gA);He.value(MA,"_utils",OA),r.Prefab=MA,de(r,"cc._Prefab","Prefab"),e("PrefabLink",(CA=al("cc.PrefabLink"),bA=Gl(MA),AA=Cl(),CA((PA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"prefab",IA,j(t)),t}return z(t,e),t}(rh),IA=Y((RA=PA).prototype,"prefab",[bA,_l,AA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wA=RA))||wA));var NA=new gi;function LA(e,t,n,i){i||(i=new gi),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function BA(e,t,n){return n||(n=new gi),e.worldToScreen(t,n),n.x/=r.view.getScaleX(),n.y/=r.view.getScaleY(),n}var FA,zA,UA=e("convertUtils",{WorldNode3DToLocalNodeUI:LA,WorldNode3DToWorldNodeUI:BA});r.pipelineUtils=UA,Fn(r.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||NA;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),zn(km.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Fn(CT.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var kA,GA=e("BufferAsset",al("cc.BufferAsset")((Y((zA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}z(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},B(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(Fu)).prototype,"_nativeAsset",[Zl],Object.getOwnPropertyDescriptor(zA.prototype,"_nativeAsset"),zA.prototype),FA=zA))||FA);r.BufferAsset=GA;var HA=((kA={})[br.UNORM]="Uint",kA[br.SNORM]="Int",kA[br.UINT]="Uint",kA[br.INT]="Int",kA[br.UFLOAT]="Float",kA[br.FLOAT]="Float",kA.default="Uint",kA);function VA(e){return""+(HA[e.type]||HA.default)+e.size/e.count*8}function jA(e,t,n,i,r){void 0===n&&(n=Cr.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=fa[n];r||(r=o.size);for(var a="set"+VA(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=ph.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<o.count;++_){var f=h+s*_;e[a](f,t[o.count*u+_],l)}}function WA(e,t,n,i,r,o){void 0===t&&(t=Cr.R32F),void 0===n&&(n=0),void 0===i&&(i=e.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=fa[t];r||(r=a.size);for(var s="get"+VA(a),c=a.size/a.count,l=Math.floor(i/r),u=ph.isLittleEndian,h=0;h<l;++h)for(var _=n+r*h,f=0;f<a.count;++f){var p=_+c*f;o[a.count*h+f]=e[s](p,u)}return o}function qA(e,t,n,i,r,o,a){void 0===n&&(n=Cr.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=fa[n];o||(o=s.size);for(var c="set"+VA(s),l="get"+VA(s),u=s.size/s.count,h=Math.floor(r/o),_=ph.isLittleEndian,f=0;f<h;++f)for(var p=i+o*f,d=0;d<s.count;++d){var m=p+u*d,v=e[l](m,_);a[c](m,t(v,d,e),_)}return a}var XA,YA,KA=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new Wo(t,e,i,r),this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=e.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*s,p=h[_]*s,d=0;d<s;++d)u[f+d]=l[p+d];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new Vo("a_vertexId",Cr.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},B(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:gi.ZERO,max:gi.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:gi.ZERO,max:gi.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,lo.ATTR_POSITION),i=e.readIndices(t),r=new gi,o=new gi,a=this.attributes.find((function(e){return e.name===lo.ATTR_POSITION}));if(a){var s=fa[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,o,a=this.mesh.struct,s=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===s.jointMapIndex||!a.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=r.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){var u=a.vertexBundles[s.vertexBundelIndices[l]];o=0,i=Cr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===lo.ATTR_JOINTS){i=_.format;break}o+=fa[_.format].size}i?function(){var r=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(r.slice().buffer),_=a.jointMaps[s.jointMapIndex];qA(h,(function(e){return _.indexOf(e)}),i,o,u.view.length,u.view.stride,h);var f=c.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),t.push(f),n.push(l)}():t.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(c)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(XA||(XA=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(YA||(YA={})),r.SystemEventType=XA;var QA,ZA=new Array(16),JA=null,$A=new Fi,ew=[ZE.TOUCH_START,ZE.TOUCH_MOVE,ZE.TOUCH_END,ZE.TOUCH_CANCEL],tw=[ZE.MOUSE_DOWN,ZE.MOUSE_ENTER,ZE.MOUSE_MOVE,ZE.MOUSE_LEAVE,ZE.MOUSE_UP,ZE.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR"}(QA||(QA={}));var nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,_w,fw,pw,dw,mw,vw,gw,yw,Sw,xw,Tw,Ew,Cw,bw,Aw,ww,Rw,Iw,Pw,Ow,Dw,Mw,Nw,Lw,Bw,Fw,zw,Uw,kw,Gw,Hw,Vw,jw,Ww,qw,Xw,Yw,Kw,Qw,Zw,Jw,$w,eR,tR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,_R,fR,pR,dR,mR,vR,gR,yR,SR,xR,TR,ER,CR,bR,AR,wR,RR,IR,PR,OR,DR,MR,NR,LR,BR,FR,zR,UR,kR,GR,HR,VR,jR,WR,qR,XR,YR,KR,QR,ZR,JR,$R,eI,tI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,_I,fI,pI,dI,mI,vI,gI,yI,SI,xI,TI,EI,CI,bI,AI,wI,RI,II,PI,OI,DI,MI,NI,LI,BI,FI,zI,UI,kI,GI,HI,VI,jI,WI,qI,XI,YI,KI,QI,ZI,JI,$I,eP,tP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,pP,dP,mP,vP,gP,yP,SP,xP,TP,EP,CP,bP,AP,wP,RP,IP,PP,OP,DP,MP,NP,LP,BP=function(){var e=t.prototype;function t(e){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=e}return e.setEnabled=function(e,t){void 0===t&&(t=!1),this._isEnabled=e;var n=this.node.children;if(e&&this._attachMask(),t&&n.length>0)for(var i=0;i<n.length;++i)n[i]._eventProcessor.setEnabled(e,!0)},e._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&$b.isNode(r);r=r.parent,++n){var o=r.getComponent(e);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},e._attachMask=function(){this.maskList=this._searchComponentsInParent(t._maskComp)},e.reattach=function(){var e,n=this;this.node.walk((function(i){e||(e=n._searchComponentsInParent(t._maskComp)),i.eventProcessor.maskList=e}))},e.destroy=function(){JA===this._node&&(JA=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),t.callbacksInvoker.emit(QA.REMOVE_POINTER_EVENT_PROCESSOR,this)},e._isTouchEvent=function(e){return-1!==ew.indexOf(e)},e._isMouseEvent=function(e){return-1!==tw.indexOf(e)},e._hasTouchListeners=function(){for(var e=0;e<ew.length;++e){var t=ew[e];if(this.hasEventListener(t))return!0}return!1},e._hasMouseListeners=function(){for(var e=0;e<tw.length;++e){var t=tw[e];if(this.hasEventListener(t))return!0}return!1},e._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},e._tryEmittingAddEvent=function(e){var n=this._isTouchEvent(e),i=this._isMouseEvent(e);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||t.callbacksInvoker.emit(QA.ADD_POINTER_EVENT_PROCESSOR,this)},e._newCallbacksInvoker=function(){var e=this,n=new on;return n._registerOffCallback((function(){e.shouldHandleEventTouch&&!e._hasTouchListeners()&&(e.shouldHandleEventTouch=!1),e.shouldHandleEventMouse&&!e._hasMouseListeners()&&(e.shouldHandleEventMouse=!1),e._hasPointerListeners()||t.callbacksInvoker.emit(QA.REMOVE_POINTER_EVENT_PROCESSOR,e)})),n},e.on=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},e.once=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},e.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},e.targetOff=function(e){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(e),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(e),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||t.callbacksInvoker.emit(QA.REMOVE_POINTER_EVENT_PROCESSOR,this)},e.emit=function(e,t,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,n,i,r,o)},e.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,ZA.length=0,this.getCapturingTargets(e.type,ZA),e.eventPhase=1,i=ZA.length-1;i>=0;--i)if((t=ZA[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,ZA),e.propagationStopped))return void(ZA.length=0);if(ZA.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,ZA),e.eventPhase=3,i=0;i<ZA.length;++i)if((t=ZA[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(ZA.length=0);ZA.length=0},e.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},e.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e._handleEventMouse=function(e){switch(e.type){case YA.MOUSE_DOWN:return this._handleMouseDown(e);case YA.MOUSE_MOVE:return this._handleMouseMove(e);case YA.MOUSE_UP:return this._handleMouseUp(e);case YA.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},e._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||($A=e.getUILocation(),!t._uiProps.uiTransformComp.isHit($A)||(e.type=ZE.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||($A=e.getUILocation(),t._uiProps.uiTransformComp.isHit($A)?(this.previousMouseIn||(JA&&JA!==t&&(e.type=ZE.MOUSE_LEAVE,JA.dispatchEvent(e),JA.eventProcessor.previousMouseIn=!1),JA=t,e.type=ZE.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=ZE.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=ZE.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,JA=null),1)))},e._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||($A=e.getUILocation(),!t._uiProps.uiTransformComp.isHit($A)||(e.type=ZE.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||($A=e.getUILocation(),!t._uiProps.uiTransformComp.isHit($A)||(e.type=ZE.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleEventTouch=function(e){switch(e.type){case YA.TOUCH_START:return this._handleTouchStart(e);case YA.TOUCH_MOVE:return this._handleTouchMove(e);case YA.TOUCH_END:return this._handleTouchEnd(e);case YA.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},e._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getUILocation($A),!t._uiProps.uiTransformComp.isHit($A)||(e.type=ZE.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},e._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=ZE.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},e._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getUILocation($A),t._uiProps.uiTransformComp.isHit($A)?e.type=ZE.TOUCH_END:e.type=ZE.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},e._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=ZE.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},B(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),t}();BP._maskComp=null,BP.callbacksInvoker=new on,r.NodeEventProcessor=BP;var FP=new gi(0,1,0),zP=new gi,UP=new Gi,kP=new mi,GP=new bi,HP=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},VP=(nw=al("cc.AmbientInfo"),iw=Tl(),rw=fl("_skyColor"),ow=fl("_skyIllum"),aw=fl("_groundAlbedo"),sw=Cl(),cw=wl(),lw=Gl(Et),uw=wl(),hw=Cl(),_w=wl(),nw(fw=iw((xw=function(){function e(){X(this,"_skyColorHDR",dw,this),X(this,"_skyIllumHDR",mw,this),X(this,"_groundAlbedoHDR",vw,this),X(this,"_skyColorLDR",gw,this),X(this,"_skyIllumLDR",yw,this),X(this,"_groundAlbedoLDR",Sw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},B(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=r.director.root.pipeline.pipelineSceneData.isHDR;return UP.set(e?this._skyColorHDR:this._skyColorLDR),HP(UP),kP.set(255*UP.x,255*UP.y,255*UP.z,255)},set:function(e){UP.set(e.x,e.y,e.z,e.w),r.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(UP):this._skyColorLDR.set(UP),this._resource&&this._resource.skyColor.set(UP)}},{key:"skyColor",set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=r.director.root.pipeline.pipelineSceneData.isHDR;return UP.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),HP(UP),kP.set(255*UP.x,255*UP.y,255*UP.z,255)},set:function(e){UP.set(e.x,e.y,e.z,e.w),r.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(UP):this._groundAlbedoLDR.set(UP),this._resource&&this._resource.groundAlbedo.set(UP)}},{key:"groundAlbedo",set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}(),dw=Y((pw=xw).prototype,"_skyColorHDR",[_l,rw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(.2,.5,.8,1)}}),mw=Y(pw.prototype,"_skyIllumHDR",[_l,ow],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zi.SKY_ILLUM}}),vw=Y(pw.prototype,"_groundAlbedoHDR",[_l,aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(.2,.2,.2,1)}}),gw=Y(pw.prototype,"_skyColorLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(.2,.5,.8,1)}}),yw=Y(pw.prototype,"_skyIllumLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zi.SKY_ILLUM}}),Sw=Y(pw.prototype,"_groundAlbedoLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi(.2,.2,.2,1)}}),Y(pw.prototype,"skyLightingColor",[sw,El,cw],Object.getOwnPropertyDescriptor(pw.prototype,"skyLightingColor"),pw.prototype),Y(pw.prototype,"skyIllum",[El,lw,uw],Object.getOwnPropertyDescriptor(pw.prototype,"skyIllum"),pw.prototype),Y(pw.prototype,"groundLightingColor",[hw,El,_w],Object.getOwnPropertyDescriptor(pw.prototype,"groundLightingColor"),pw.prototype),fw=pw))||fw)||fw);r.AmbientInfo=VP;var jP=(Tw=al("cc.SkyboxInfo"),Ew=Tl(),Cw=Gl(uv),bw=fl("_envmap"),Aw=Gl(uv),ww=Gl(uv),Rw=Gl(uv),Iw=Cl(),Pw=wl(),Ow=wl(),Dw=wl(),Mw=wl(),Nw=Gl(uv),Lw=wl(),Bw=Cl(),Fw=Gl(uv),Tw(zw=Ew((Yw=function(){function e(){X(this,"_applyDiffuseMap",kw,this),X(this,"_envmapHDR",Gw,this),X(this,"_envmapLDR",Hw,this),X(this,"_diffuseMapHDR",Vw,this),X(this,"_diffuseMapLDR",jw,this),X(this,"_enabled",Ww,this),X(this,"_useIBL",qw,this),X(this,"_useHDR",Xw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},B(e,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(e){this._applyDiffuseMap=e,this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=e:this._envmapLDR=e,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}(),kw=Y((Uw=Yw).prototype,"_applyDiffuseMap",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gw=Y(Uw.prototype,"_envmapHDR",[_l,Cw,bw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hw=Y(Uw.prototype,"_envmapLDR",[_l,Aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vw=Y(Uw.prototype,"_diffuseMapHDR",[_l,ww],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jw=Y(Uw.prototype,"_diffuseMapLDR",[_l,Rw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ww=Y(Uw.prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qw=Y(Uw.prototype,"_useIBL",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Xw=Y(Uw.prototype,"_useHDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y(Uw.prototype,"applyDiffuseMap",[Iw,El,Pw],Object.getOwnPropertyDescriptor(Uw.prototype,"applyDiffuseMap"),Uw.prototype),Y(Uw.prototype,"enabled",[El,Ow],Object.getOwnPropertyDescriptor(Uw.prototype,"enabled"),Uw.prototype),Y(Uw.prototype,"useIBL",[El,Dw],Object.getOwnPropertyDescriptor(Uw.prototype,"useIBL"),Uw.prototype),Y(Uw.prototype,"useHDR",[El,Mw],Object.getOwnPropertyDescriptor(Uw.prototype,"useHDR"),Uw.prototype),Y(Uw.prototype,"envmap",[El,Nw,Lw],Object.getOwnPropertyDescriptor(Uw.prototype,"envmap"),Uw.prototype),Y(Uw.prototype,"diffuseMap",[Bw,El,bl,Fw],Object.getOwnPropertyDescriptor(Uw.prototype,"diffuseMap"),Uw.prototype),zw=Uw))||zw)||zw);r.SkyboxInfo=jP;var WP=(Kw=al("cc.FogInfo"),Qw=Tl(),Zw=wl(),Jw=wl(),$w=wl(),eR=Gl(DE),tR=wl(),nR=Cl(),iR=Gl(Et),rR=Rl(),oR=Ol(),aR=Ml(),sR=wl(),cR=Cl(),lR=Gl(Et),uR=Ol(),hR=Ml(),_R=wl(),fR=Cl(),pR=Gl(Et),dR=Ol(),mR=Ml(),vR=wl(),gR=Cl(),yR=Gl(Et),SR=Il(),xR=Ol(),TR=Ml(),ER=wl(),CR=Cl(),bR=Gl(Et),AR=Ol(),wR=Ml(),RR=wl(),IR=Cl(),PR=Gl(Et),OR=Ol(),DR=Ml(),MR=wl(),Kw(NR=Qw((XR=qR=function(){function e(){X(this,"_type",BR,this),X(this,"_fogColor",FR,this),X(this,"_enabled",zR,this),X(this,"_fogDensity",UR,this),X(this,"_fogStart",kR,this),X(this,"_fogEnd",GR,this),X(this,"_fogAtten",HR,this),X(this,"_fogTop",VR,this),X(this,"_fogRange",jR,this),X(this,"_accurate",WR,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),qR.FogType=DE,BR=Y((LR=XR).prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DE.LINEAR}}),FR=Y(LR.prototype,"_fogColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi("#C8C8C8")}}),zR=Y(LR.prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UR=Y(LR.prototype,"_fogDensity",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),kR=Y(LR.prototype,"_fogStart",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),GR=Y(LR.prototype,"_fogEnd",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),HR=Y(LR.prototype,"_fogAtten",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),VR=Y(LR.prototype,"_fogTop",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),jR=Y(LR.prototype,"_fogRange",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),WR=Y(LR.prototype,"_accurate",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(LR.prototype,"enabled",[El,Zw],Object.getOwnPropertyDescriptor(LR.prototype,"enabled"),LR.prototype),Y(LR.prototype,"accurate",[El,Jw],Object.getOwnPropertyDescriptor(LR.prototype,"accurate"),LR.prototype),Y(LR.prototype,"fogColor",[El,$w],Object.getOwnPropertyDescriptor(LR.prototype,"fogColor"),LR.prototype),Y(LR.prototype,"type",[El,eR,tR],Object.getOwnPropertyDescriptor(LR.prototype,"type"),LR.prototype),Y(LR.prototype,"fogDensity",[nR,iR,rR,oR,Dl,aR,sR],Object.getOwnPropertyDescriptor(LR.prototype,"fogDensity"),LR.prototype),Y(LR.prototype,"fogStart",[cR,lR,uR,hR,_R],Object.getOwnPropertyDescriptor(LR.prototype,"fogStart"),LR.prototype),Y(LR.prototype,"fogEnd",[fR,pR,dR,mR,vR],Object.getOwnPropertyDescriptor(LR.prototype,"fogEnd"),LR.prototype),Y(LR.prototype,"fogAtten",[gR,yR,SR,xR,TR,ER],Object.getOwnPropertyDescriptor(LR.prototype,"fogAtten"),LR.prototype),Y(LR.prototype,"fogTop",[CR,bR,AR,wR,RR],Object.getOwnPropertyDescriptor(LR.prototype,"fogTop"),LR.prototype),Y(LR.prototype,"fogRange",[IR,PR,OR,DR,MR],Object.getOwnPropertyDescriptor(LR.prototype,"fogRange"),LR.prototype),NR=LR))||NR)||NR),qP=(YR=al("cc.ShadowsInfo"),KR=Tl(),QR=wl(),ZR=Gl(Lg),JR=Cl(),$R=Cl(),eI=wl(),tI=Gl(Et),nI=wl(),iI=Cl(),rI=Rl(),oI=Gl(Et),aI=wl(),sI=Cl(),cI=Gl(Bg),lI=wl(),uI=Cl(),hI=Gl(Tt),_I=Cl(),fI=Gl(Et),pI=wl(),dI=Cl(),mI=Gl(Et),vI=wl(),gI=Cl(),yI=Gl(Ng),SI=wl(),xI=Cl(),TI=Gl(Ct),EI=wl(),CI=Cl(),bI=Gl(Et),AI=wl(),wI=Cl(),RI=Gl(Et),II=wl(),PI=Cl(),OI=Rl(),DI=Gl(Et),MI=wl(),NI=Cl(),LI=Rl(),BI=Gl(Et),FI=wl(),zI=Cl(),UI=Gl(Et),kI=wl(),GI=Cl(),YR(HI=KR((cP=function(){function e(){X(this,"_type",jI,this),X(this,"_enabled",WI,this),X(this,"_normal",qI,this),X(this,"_distance",XI,this),X(this,"_shadowColor",YI,this),X(this,"_firstSetCSM",KI,this),X(this,"_fixedArea",QI,this),X(this,"_pcf",ZI,this),X(this,"_bias",JI,this),X(this,"_normalBias",$I,this),X(this,"_near",eP,this),X(this,"_far",tP,this),X(this,"_shadowDistance",nP,this),X(this,"_invisibleOcclusionRange",iP,this),X(this,"_orthoSize",rP,this),X(this,"_maxReceived",oP,this),X(this,"_size",aP,this),X(this,"_saturation",sP,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(GP),this.normal=gi.transformQuat(zP,FP,GP),e.getWorldPosition(zP),this.distance=gi.dot(this._normal,zP)},t.activate=function(e){this.pcf=Math.min(this._pcf,Bg.SOFT_2X),this._resource=e,this._resource.initialize(this),this._resource.activate()},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){gi.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"saturation",get:function(){return this._saturation},set:function(e){e>1?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=Math.min(e,zg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=Math.min(e,zg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,zg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}}]),e}(),jI=Y((VI=cP).prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lg.Planar}}),WI=Y(VI.prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qI=Y(VI.prototype,"_normal",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(0,1,0)}}),XI=Y(VI.prototype,"_distance",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YI=Y(VI.prototype,"_shadowColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(0,0,0,76)}}),KI=Y(VI.prototype,"_firstSetCSM",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QI=Y(VI.prototype,"_fixedArea",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZI=Y(VI.prototype,"_pcf",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bg.HARD}}),JI=Y(VI.prototype,"_bias",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),$I=Y(VI.prototype,"_normalBias",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eP=Y(VI.prototype,"_near",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),tP=Y(VI.prototype,"_far",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),nP=Y(VI.prototype,"_shadowDistance",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),iP=Y(VI.prototype,"_invisibleOcclusionRange",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),rP=Y(VI.prototype,"_orthoSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),oP=Y(VI.prototype,"_maxReceived",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),aP=Y(VI.prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(512,512)}}),sP=Y(VI.prototype,"_saturation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),Y(VI.prototype,"enabled",[El,QR],Object.getOwnPropertyDescriptor(VI.prototype,"enabled"),VI.prototype),Y(VI.prototype,"type",[El,ZR],Object.getOwnPropertyDescriptor(VI.prototype,"type"),VI.prototype),Y(VI.prototype,"shadowColor",[JR],Object.getOwnPropertyDescriptor(VI.prototype,"shadowColor"),VI.prototype),Y(VI.prototype,"normal",[$R,eI],Object.getOwnPropertyDescriptor(VI.prototype,"normal"),VI.prototype),Y(VI.prototype,"distance",[tI,nI,iI],Object.getOwnPropertyDescriptor(VI.prototype,"distance"),VI.prototype),Y(VI.prototype,"saturation",[El,rI,Dl,oI,aI,sI],Object.getOwnPropertyDescriptor(VI.prototype,"saturation"),VI.prototype),Y(VI.prototype,"pcf",[cI,lI,uI],Object.getOwnPropertyDescriptor(VI.prototype,"pcf"),VI.prototype),Y(VI.prototype,"maxReceived",[hI,_I],Object.getOwnPropertyDescriptor(VI.prototype,"maxReceived"),VI.prototype),Y(VI.prototype,"bias",[fI,pI,dI],Object.getOwnPropertyDescriptor(VI.prototype,"bias"),VI.prototype),Y(VI.prototype,"normalBias",[mI,vI,gI],Object.getOwnPropertyDescriptor(VI.prototype,"normalBias"),VI.prototype),Y(VI.prototype,"shadowMapSize",[yI,SI,xI],Object.getOwnPropertyDescriptor(VI.prototype,"shadowMapSize"),VI.prototype),Y(VI.prototype,"fixedArea",[TI,EI,CI],Object.getOwnPropertyDescriptor(VI.prototype,"fixedArea"),VI.prototype),Y(VI.prototype,"near",[bI,AI,wI],Object.getOwnPropertyDescriptor(VI.prototype,"near"),VI.prototype),Y(VI.prototype,"far",[RI,II,PI],Object.getOwnPropertyDescriptor(VI.prototype,"far"),VI.prototype),Y(VI.prototype,"invisibleOcclusionRange",[El,OI,Dl,DI,MI,NI],Object.getOwnPropertyDescriptor(VI.prototype,"invisibleOcclusionRange"),VI.prototype),Y(VI.prototype,"shadowDistance",[El,LI,Dl,BI,FI,zI],Object.getOwnPropertyDescriptor(VI.prototype,"shadowDistance"),VI.prototype),Y(VI.prototype,"orthoSize",[UI,kI,GI],Object.getOwnPropertyDescriptor(VI.prototype,"orthoSize"),VI.prototype),HI=VI))||HI)||HI);r.ShadowsInfo=qP;var XP=new gi(-1024,-1024,-1024),YP=new gi(1024,1024,1024),KP=(lP=al("cc.OctreeInfo"),uP=Tl(),hP=wl(),_P=wl(),fP=Al(),pP=wl(),dP=Al(),mP=Rl(),vP=Gl(Tt),gP=wl(),lP(yP=uP((bP=function(){function e(){X(this,"_enabled",xP,this),X(this,"_minPos",TP,this),X(this,"_maxPos",EP,this),X(this,"_depth",CP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}(),xP=Y((SP=bP).prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TP=Y(SP.prototype,"_minPos",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(XP)}}),EP=Y(SP.prototype,"_maxPos",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(YP)}}),CP=Y(SP.prototype,"_depth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),Y(SP.prototype,"enabled",[El,hP],Object.getOwnPropertyDescriptor(SP.prototype,"enabled"),SP.prototype),Y(SP.prototype,"minPos",[El,_P,fP],Object.getOwnPropertyDescriptor(SP.prototype,"minPos"),SP.prototype),Y(SP.prototype,"maxPos",[El,pP,dP],Object.getOwnPropertyDescriptor(SP.prototype,"maxPos"),SP.prototype),Y(SP.prototype,"depth",[El,mP,vP,gP],Object.getOwnPropertyDescriptor(SP.prototype,"depth"),SP.prototype),yP=SP))||yP)||yP),QP=(AP=al("cc.SceneGlobals"),wP=Gl(jP),AP((LP=function(){function e(){X(this,"ambient",PP,this),X(this,"shadows",OP,this),X(this,"_skybox",DP,this),X(this,"fog",MP,this),X(this,"octree",NP,this)}return e.prototype.activate=function(){var e=r.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},B(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),PP=Y((IP=LP).prototype,"ambient",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VP}}),OP=Y(IP.prototype,"shadows",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qP}}),DP=Y(IP.prototype,"_skybox",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jP}}),MP=Y(IP.prototype,"fog",[El,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new WP}}),Y(IP.prototype,"skybox",[El,wP],Object.getOwnPropertyDescriptor(IP.prototype,"skybox"),IP.prototype),NP=Y(IP.prototype,"octree",[El,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KP}}),RP=IP))||RP);r.SceneGlobals=QP;var ZP=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());ZP.NO_TYPE="no_type",ZP.TOUCH="touch",ZP.MOUSE="mouse",ZP.KEYBOARD="keyboard",ZP.ACCELERATION="acceleration",ZP.NONE=0,ZP.CAPTURING_PHASE=1,ZP.AT_TARGET=2,ZP.BUBBLING_PHASE=3,r.Event=ZP;var JP=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,XA.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return z(t,e),t}(ZP));ZP.EventAcceleration=JP;var $P=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?XA.KEY_DOWN:XA.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==XA.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return z(t,e),B(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(ZP));ZP.EventKeyboard=$P;var eO=e("EventMouse",function(e){function t(n,i,r){var o;return(o=e.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=t.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}z(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new Fi),Fi.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new Fi),Fi.set(e,this._x,r.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new Fi),Fi.set(e,this._x,this._y),r.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new Fi),Fi.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new Fi),Fi.set(e,this._prevX,this._prevY),r.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new Fi),Fi.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new Fi),Fi.set(e,(this._x-this._prevX)/r.view.getScaleX(),(this._y-this._prevY)/r.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/r.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/r.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=r.view.getViewportRect();return(this._x-e.x)/r.view.getScaleX()},n.getUILocationY=function(){var e=r.view.getViewportRect();return(this._y-e.y)/r.view.getScaleY()},B(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(ZP));eO.BUTTON_MISSING=-1,eO.BUTTON_LEFT=0,eO.BUTTON_RIGHT=2,eO.BUTTON_MIDDLE=1,eO.BUTTON_4=3,eO.BUTTON_5=4,eO.BUTTON_6=5,eO.BUTTON_7=6,eO.BUTTON_8=7,ZP.EventMouse=eO;var tO=new Fi,nO=e("EventTouch",function(e){function t(t,n,i,r){var o;return void 0===r&&(r=[]),(o=e.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=t||[],o._allTouches=r,o}z(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new Fi},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new Fi},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new Fi},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new Fi},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new Fi},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new Fi},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new Fi},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new Fi},n.getDeltaX=function(){return this.touch?this.touch.getDelta(tO).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(tO).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(ZP));nO.MAX_TOUCHES=5,ZP.EventTouch=nO;var iO,rO=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(iO||(iO=e("KeyCode",{})));var oO=new Fi,aO=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new Fi,this._prevPoint=new Fi,this._lastModified=0,this._id=0,this._startPoint=new Fi,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new Fi),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new Fi),e.set(this._point.x,this._point.y),r.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=r.view.getViewportRect();return(this._point.x-e.x)/r.view.getScaleX()},t.getUILocationY=function(){var e=r.view.getViewportRect();return(this._point.y-e.y)/r.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new Fi),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new Fi),e.set(this._prevPoint.x,this._prevPoint.y),r.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new Fi),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new Fi),e.set(this._startPoint.x,this._startPoint.y),r.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new Fi),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new Fi),oO.set(this._point),oO.subtract(this._prevPoint),e.set(r.view.getScaleX(),r.view.getScaleY()),Fi.divide(e,oO,e),e},t.getLocationInView=function(e){return e||(e=new Fi),e.set(this._point.x,r.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new Fi),e.set(this._prevPoint.x,r.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new Fi),e.set(this._startPoint.x,r.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new Fi(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new Fi(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=r.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new Fi(e.x,e.y):new Fi(e||0,t||0),this._lastModified=r.game.frameStartTime},B(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());r.Touch=aO;var sO,cO=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new fn,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,pn.browserType===sn.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=e;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(hh.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),pn.os===un.ANDROID&&pn.browserType!==sn.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new rO(n,i,r,l),h=new JP(u);this._eventTarget.emit(YA.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),lO={Backspace:iO.BACKSPACE,Tab:iO.TAB,Enter:iO.ENTER,ShiftLeft:iO.SHIFT_LEFT,ControlLeft:iO.CTRL_LEFT,AltLeft:iO.ALT_LEFT,ShiftRight:iO.SHIFT_RIGHT,ControlRight:iO.CTRL_RIGHT,AltRight:iO.ALT_RIGHT,Pause:iO.PAUSE,CapsLock:iO.CAPS_LOCK,Escape:iO.ESCAPE,Space:iO.SPACE,PageUp:iO.PAGE_UP,PageDown:iO.PAGE_DOWN,End:iO.END,Home:iO.HOME,ArrowLeft:iO.ARROW_LEFT,ArrowUp:iO.ARROW_UP,ArrowRight:iO.ARROW_RIGHT,ArrowDown:iO.ARROW_DOWN,Insert:iO.INSERT,Delete:iO.DELETE,Digit0:iO.DIGIT_0,Digit1:iO.DIGIT_1,Digit2:iO.DIGIT_2,Digit3:iO.DIGIT_3,Digit4:iO.DIGIT_4,Digit5:iO.DIGIT_5,Digit6:iO.DIGIT_6,Digit7:iO.DIGIT_7,Digit8:iO.DIGIT_8,Digit9:iO.DIGIT_9,KeyA:iO.KEY_A,KeyB:iO.KEY_B,KeyC:iO.KEY_C,KeyD:iO.KEY_D,KeyE:iO.KEY_E,KeyF:iO.KEY_F,KeyG:iO.KEY_G,KeyH:iO.KEY_H,KeyI:iO.KEY_I,KeyJ:iO.KEY_J,KeyK:iO.KEY_K,KeyL:iO.KEY_L,KeyM:iO.KEY_M,KeyN:iO.KEY_N,KeyO:iO.KEY_O,KeyP:iO.KEY_P,KeyQ:iO.KEY_Q,KeyR:iO.KEY_R,KeyS:iO.KEY_S,KeyT:iO.KEY_T,KeyU:iO.KEY_U,KeyV:iO.KEY_V,KeyW:iO.KEY_W,KeyX:iO.KEY_X,KeyY:iO.KEY_Y,KeyZ:iO.KEY_Z,Numpad0:iO.NUM_0,Numpad1:iO.NUM_1,Numpad2:iO.NUM_2,Numpad3:iO.NUM_3,Numpad4:iO.NUM_4,Numpad5:iO.NUM_5,Numpad6:iO.NUM_6,Numpad7:iO.NUM_7,Numpad8:iO.NUM_8,Numpad9:iO.NUM_9,NumpadMultiply:iO.NUM_MULTIPLY,NumpadAdd:iO.NUM_PLUS,NumpadSubtract:iO.NUM_SUBTRACT,NumpadDecimal:iO.NUM_DECIMAL,NumpadDivide:iO.NUM_DIVIDE,NumpadEnter:iO.NUM_ENTER,F1:iO.F1,F2:iO.F2,F3:iO.F3,F4:iO.F4,F5:iO.F5,F6:iO.F6,F7:iO.F7,F8:iO.F8,F9:iO.F9,F10:iO.F10,F11:iO.F11,F12:iO.F12,NumLock:iO.NUM_LOCK,ScrollLock:iO.SCROLL_LOCK,Semicolon:iO.SEMICOLON,Equal:iO.EQUAL,Comma:iO.COMMA,Minus:iO.DASH,Period:iO.PERIOD,Slash:iO.SLASH,Backquote:iO.BACK_QUOTE,BracketLeft:iO.BRACKET_LEFT,Backslash:iO.BACKSLASH,BracketRight:iO.BRACKET_RIGHT,Quote:iO.QUOTE},uO=function(){function e(){this._eventTarget=new fn,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,YA.KEY_PRESSING);e._eventTarget.emit(YA.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,YA.KEY_DOWN);e._eventTarget.emit(YA.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,YA.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(YA.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,lO[n]||iO.NONE);return new $P(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),hO=function(){function e(){this._canvas=void 0,this._eventTarget=new fn,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Fi,pn.hasFeature(_n.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new qi(t.x,t.y,t.width,t.height):new qi(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=hh.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new Fi(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(YA.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(YA.MOUSE_MOVE));var o=this._createCallback(YA.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),o=n.button;switch(e){case YA.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case YA.MOUSE_UP:t._isPressed=!1;break;case YA.MOUSE_MOVE:t._isPressed||(o=eO.BUTTON_MISSING)}var a=new eO(e,!1,t._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,a)}},t._handleMouseWheel=function(e){var t=YA.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new eO(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),_O=new Fi,fO=new(function(){function e(){this._touchMap={},this._touches=void 0,this._maxTouches=8,this._touches=new Array(this._maxTouches)}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(_O);var n=new aO(_O.x,_O.y,t);return e.getLocation(_O),n.setPoint(_O.x,_O.y),e.getPreviousLocation(_O),n.setPrevPoint(_O),n},t._createTouch=function(e,t,n){if(e in this._touchMap)console.log("Cannot create the same touch object.");else{var i=this._getAvailableTouchIndex(e);if(-1!==i){var r=new aO(t,n,e);return this._touches[i]=r,this._touchMap[e]=i,this._updateTouch(r,t,n),this._cloneTouch(r)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){if(e in this._touchMap){var t=this._touchMap[e];this._touches[t]=void 0,delete this._touchMap[e]}},t.getTouch=function(e,t,n){var i=this._touchMap[e],r=this._touches[i];return r?this._updateTouch(r,t,n):r=this._createTouch(e,t,n),r?this._cloneTouch(r):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touches.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(_O),e.setPrevPoint(_O),e.setPoint(t,n)},t._getAvailableTouchIndex=function(e){var t=this._touchMap[e];if(void 0!==t)return t;for(var n=0;n<this._maxTouches;n++)if(!this._touches[n])return n;for(var i=performance.now(),r=et.TOUCH_TIMEOUT,o=0;o<this._maxTouches;o++){var a=this._touches[o];if(i-a.lastModified>r)return console.log("The touches is more than MAX_TOUCHES, release touch id "+a.getID()+"."),this.releaseTouch(a.getID()),o}return-1},e}()),pO=function(){function e(){this._canvas=void 0,this._eventTarget=new fn,pn.hasFeature(_n.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(YA.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(YA.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(YA.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(YA.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=fO.getTouch(l,u.x,u.y);if(h&&(e!==YA.TOUCH_END&&e!==YA.TOUCH_CANCEL||fO.releaseTouch(l),o.push(h),!et.ENABLE_MULTI_TOUCH))break}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===YA.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),o.length>0){var _=new nO(o,!1,e,et.ENABLE_MULTI_TOUCH?fO.getAllTouches():o);t._eventTarget.emit(e,_)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new qi(t.x,t.y,t.width,t.height):new qi(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(hh.isFrameRotated){var r=n;n=t.height-i,i=r}var o=hh.devicePixelRatio;return new Fi(n*=o,i*=o)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),dO=((sO={})[YA.MOUSE_DOWN]=YA.TOUCH_START,sO[YA.MOUSE_MOVE]=YA.TOUCH_MOVE,sO[YA.MOUSE_UP]=YA.TOUCH_END,sO),mO=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new fn,this._touchInput=new pO,this._mouseInput=new hO,this._keyboardInput=new uO,this._accelerometerInput=new cO,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._registerEvent()}var t=e.prototype;return t._simulateEventTouch=function(e){var t=dO[e.type],n=fO.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new nO(i,!1,t,i);t===YA.TOUCH_END&&fO.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEvent=function(){var e=this;if(ph.hasFeature(ph.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(YA.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(YA.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(YA.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(YA.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(ph.hasFeature(ph.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(YA.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(YA.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(YA.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(YA.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(ph.hasFeature(ph.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(YA.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(YA.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(YA.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(ph.hasFeature(ph.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(YA.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._eventTarget.emit(e.type,e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._eventTarget.emit(e.type,e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._eventTarget.emit(i.type,i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._eventTarget.emit(s.type,s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var p=h[_];this._eventTarget.emit(p.type,p)}for(var d=this._eventAccelerationList,m=0,v=d.length;m<v;++m){var g=d[m];this._eventTarget.emit(g.type,g)}this._clearEvents()},t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},e}());mO.EventType=YA;var vO,gO=e("input",new mO),yO=e("pointerEvent2SystemEvent",((vO={})[YA.TOUCH_START]="system-event-"+YA.TOUCH_START,vO[YA.TOUCH_MOVE]="system-event-"+YA.TOUCH_MOVE,vO[YA.TOUCH_END]="system-event-"+YA.TOUCH_END,vO[YA.TOUCH_CANCEL]="system-event-"+YA.TOUCH_CANCEL,vO[YA.MOUSE_DOWN]="system-event-"+YA.MOUSE_DOWN,vO[YA.MOUSE_MOVE]="system-event-"+YA.MOUSE_MOVE,vO[YA.MOUSE_UP]="system-event-"+YA.MOUSE_UP,vO)),SO=Object.values(YA),xO=e("SystemEvent",function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){gO.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){gO.setAccelerometerInterval(e)},n.on=function(t,n,i,r){var o=r?gO.once:gO.on;if(SO.includes(t)){var a=yO[t];a?o.call(gO,a,n,i):t===XA.KEY_DOWN?(o.call(gO,YA.KEY_DOWN,n,i),o.call(gO,YA.KEY_PRESSING,n,i,r)):o.call(gO,t,n,i)}else e.prototype.on.call(this,t,n,i,r);return n},n.off=function(t,n,i){if(SO.includes(t)){var r=yO[t];r?gO.off(r,n,i):t===XA.KEY_DOWN?(gO.off(YA.KEY_DOWN,n,i),gO.off(YA.KEY_PRESSING,n,i)):gO.off(t,n,i)}else e.prototype.off.call(this,t,n,i)},t}(fn));xO.EventType=XA,r.SystemEvent=xO;var TO,EO=e("systemEvent",new xO);r.systemEvent=EO,Fn(XA,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),Fn(ZP,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:xO.EventType,targetName:"SystemEvent.EventType"}]),Un(ZP,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),Fn(eO,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:xO.EventType,targetName:"SystemEvent.EventType"}}))),Fn(eO,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:xO.EventType,targetName:"SystemEvent.EventType"}]),Un(eO.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),Fn(nO,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:xO.EventType,targetName:"SystemEvent.EventType"}]),Fn(nO,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:xO.EventType,targetName:"SystemEvent.EventType"}]),Fn(nO,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:xO.EventType,targetName:"SystemEvent.EventType"}]),Fn(nO,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:xO.EventType,targetName:"SystemEvent.EventType"}]),Un(nO.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),Fn(nO.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:nO,targetName:"EventTouch"}]),Un(et.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),Un(et.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),Un(et.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),Un(et.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),Un(et,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),Fn(CC.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),Fn($b.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Fi),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new ji),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),zn(QP.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),zn($b.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),zn(kp,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),Fn(kp,"Layers",[{name:"Default",newName:"DEFAULT",target:kp.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:kp.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:kp.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:kp.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:kp.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:kp.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:kp.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:kp.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:kp,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:kp,targetName:"Layers"}]),zn(kp.Enum,"Layers.Enum",[{name:"ALWAYS"}]),zn(kp.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var CO,bO,AO,wO,RO=Kt.Flags.HideInHierarchy,IO=Kt.Flags.DontSave,PO=e("PrivateNode",al("cc.PrivateNode")(TO=function(e){function t(t){var n;return b(12003,(n=e.call(this,t)||this).name),n.hideFlags|=IO|RO,n}return z(t,e),t}($b))||TO);Fn(XA,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:$b.EventType,targetName:"Node.EventType"}}))),Fn($b.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:xO.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:xO.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:xO.EventType,targetName:"SystemEvent.EventType"}]),r.PrivateNode=PO;var OO=e("Scene",al("cc.Scene")((Y((bO=function(e){z(n,e);var t=n.prototype;function n(t){var n;return X(n=e.call(this,t)||this,"autoReleaseAssets",AO,j(n)),X(n,"_globals",wO,j(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=gi.ZERO,n._rot=bi.IDENTITY,n._scale=gi.ONE,n._mat=Mi.IDENTITY,n._dirtyFlags=0,n._lpos=gi.ZERO,n._lrot=bi.IDENTITY,n._lscale=gi.ONE,n._activeInHierarchy=!1,r.director&&r.director.root&&(n._renderScene=r.director.root.createScene({})),n._inited=!r.game||!r.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=Kt.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&r.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(O(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return gi.copy(e||new gi,gi.ZERO)},t.getRotation=function(e){return bi.copy(e||new bi,bi.IDENTITY)},t.getScale=function(e){return gi.copy(e||new gi,gi.ONE)},t.getWorldPosition=function(e){return gi.copy(e||new gi,gi.ZERO)},t.getWorldRotation=function(e){return bi.copy(e||new bi,bi.IDENTITY)},t.getWorldScale=function(e){return gi.copy(e||new gi,gi.ONE)},t.getWorldMatrix=function(e){return Mi.copy(e||new Mi,Mi.IDENTITY)},t.getWorldRS=function(e){return Mi.copy(e||new Mi,Mi.IDENTITY)},t.getWorldRT=function(e){return Mi.copy(e||new Mi,Mi.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(vA(this),dA(this),this._onBatchCreated(false),this._inited=!0),this.walk(CC._setScene)},t._activate=function(e){e=!1!==e,r.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},B(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return gi.ZERO}},{key:"worldPosition",get:function(){return gi.ZERO}},{key:"rotation",get:function(){return bi.IDENTITY}},{key:"worldRotation",get:function(){return bi.IDENTITY}},{key:"scale",get:function(){return gi.ONE}},{key:"worldScale",get:function(){return gi.ONE}},{key:"eulerAngles",get:function(){return gi.ZERO}},{key:"worldMatrix",get:function(){return Mi.IDENTITY}}]),n}(CC)).prototype,"globals",[El],Object.getOwnPropertyDescriptor(bO.prototype,"globals"),bO.prototype),AO=Y(bO.prototype,"autoReleaseAssets",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wO=Y(bO.prototype,"_globals",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QP}}),CO=bO))||CO);function DO(e,t){if(!t){var n=r.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}r.Scene=OO,r.find=DO;var MO=Ge.fastRemoveAt,NO=Kt.Flags.IsStartCalled,LO=Kt.Flags.IsOnEnableCalled;function BO(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function FO(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}Kt.Flags.IsEditorOnEnableCalled;var zO=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=K;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function UO(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}zO.stableRemoveInactive=FO;var kO=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){FO(this._zero,e),FO(this._neg,e),FO(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(UO),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(UO),this._invoke(t),t.array.length=0)},t}(zO),GO=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=BO(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=BO(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(zO);function HO(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",o=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,o){try{t(i,o)}catch(t){r._throw(t);var a=i.array;for(n&&(a[i.i]._objFlags|=n),++i.i;i.i<a.length;++i.i)try{e(a[i.i],o)}catch(e){r._throw(e),n&&(a[i.i]._objFlags|=n)}}}}(Function("c","dt",e),o,n)}var VO=HO("c.start();c._objFlags|="+NO,!1,NO),jO=HO("c.update(dt)",!0),WO=HO("c.lateUpdate(dt)",!0),qO=function(e){var t=r.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},XO=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new kO(VO),this.updateInvoker=new GO(jO),this.lateUpdateInvoker=new GO(WO),this._updating=!1},t._onEnabled=function(e){r.director.getScheduler().resumeTarget(e),e._objFlags|=LO,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){r.director.getScheduler().pauseTarget(e),e._objFlags&=~LO;var t=this._deferredComps.indexOf(e);t>=0?MO(this._deferredComps,t):(!e.start||e._objFlags&NO||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&LO)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&LO&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&NO||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),YO=Kt.Flags.IsPreloadStarted,KO=Kt.Flags.IsOnLoadStarted,QO=Kt.Flags.IsOnLoadCalled,ZO=Kt.Flags.Deactivating,JO=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){zO.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(zO),$O=HO("c.__preload();"),eD=HO("c.onLoad();c._objFlags|="+QO,!1,QO),tD=new ke(4);function nD(e,t,n){w(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):Ge.removeAt(e._components,n)}tD.get=function(){var e=this._get()||{preload:new JO($O),onLoad:new kO(eD),onEnable:new kO(qO)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var iD,rD,oD,aD,sD,cD,lD,uD,hD=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=tD.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),tD.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=q(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(YO),o.onLoad.cancelInactive(KO),o.onEnable.cancelInactive()}}e.emit(ZE.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,i){if(Zt(e,!0)&&(e._objFlags&YO||(e._objFlags|=YO,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&KO||(e._objFlags|=KO,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=QO):e._objFlags|=QO),e._enabled)){if(!e.node._activeInHierarchy)return;r.director._compScheduler.enableComp(e,i)}},t.destroyComp=function(e){r.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&QO&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,i){if(e._objFlags&ZO)w(3816,e.name);else{e._activeInHierarchy=!0;for(var o=e._components.length,a=0;a<o;++a){var s=e._components[a];s instanceof r.Component?this.activateComp(s,t,n,i):(nD(e,s,a),--a,--o)}for(var c=0,l=e._children.length;c<l;++c){var u=e._children[c];u._active&&this._activateNodeRecursively(u,t,n,i)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=ZO,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(r.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~ZO)}for(var o=0,a=e._children.length;o<a;++o){var s=e._children[o];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~ZO)}e._onPostActivated(!1),e._objFlags&=~ZO},e}()),_D=e("SceneAsset",al("cc.SceneAsset")((aD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"scene",oD,j(t)),t}z(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new OO("New Scene")},n.validate=function(){return!!this.scene},t}(Fu),oD=Y((rD=aD).prototype,"scene",[El,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iD=rD))||iD);r.SceneAsset=_D;var fD,pD,dD,mD,vD=e("TextAsset",al("cc.TextAsset")((uD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"text",lD,j(t)),t}return z(t,e),t.prototype.toString=function(){return this.text},t}(Fu),lD=Y((cD=uD).prototype,"text",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sD=cD))||sD);r.TextAsset=vD;var gD=e("JsonAsset",al("cc.JsonAsset")((mD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"json",dD,j(t)),t}return z(t,e),t}(Fu),dD=Y((pD=mD).prototype,"json",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fD=pD))||fD);r.JsonAsset=gD;var yD,SD,xD,TD,ED,CD,bD,AD,wD,RD,ID,PD,OD,DD,MD,ND,LD,BD,FD,zD,UD,kD,GD,HD,VD,jD,WD,qD,XD,YD,KD,QD,ZD,JD,$D,eM,tM,nM,iM=function(){var e=t.prototype;function t(){this.fog=new NE,this.ambient=new Zi,this.skybox=new Jg,this.shadows=new zg,this.octree=new Ji,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initOcclusionQuery(),!0},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Mg;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=e.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Vo("a_position",Cr.RGB32F)],c=new Wo(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},B(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(AS.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(),rM=e("ForwardPipeline",(yD=al("ForwardPipeline"),SD=Gl([AT]),xD=Ml(),yD((bD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",CD,j(t)),t._postRenderPass=null,t}z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new PE;n.initialize(PE.initInfo),this._flows.push(n);var i=new _E;i.initialize(_E.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new iM,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(w(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(od,t),this._descriptorSet.bindTexture(od,Hv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(pd,t),this._descriptorSet.bindTexture(pd,Hv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(nd.BINDING).destroy(),this._descriptorSet.getBuffer(rd.BINDING).destroy(),this._descriptorSet.getBuffer(id.BINDING).destroy(),this._descriptorSet.getTexture(od).destroy(),this._descriptorSet.getTexture(pd).destroy())},B(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(YS),CD=Y((ED=bD).prototype,"renderTextures",[SD,_l,xD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TD=ED))||TD)),oM=[new To(0,0,0,0),new To(0,0,0,0),new To(0,0,0,0),new To(0,0,0,0)],aM=e("GbufferStage",(AD=al("GbufferStage"),wD=Gl([IT]),RD=Ml(),AD((MD=DD=function(e){function t(){var t;return X(t=e.call(this)||this,"renderQueues",OD,j(t)),t._renderQueues=[],t._renderArea=new fo,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Vv("default"),t._batchedQueue=new BT,t._instancedQueue=new FT,t}z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=MT(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(NT),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Uv.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===Uv.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(LT);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&oo.COLOR&&(t.pipelineSceneData.isHDR?yg(oM[0],e.clearColor):(oM[0].x=e.clearColor.x,oM[0].y=e.clearColor.y,oM[0].z=e.clearColor.z)),oM[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,oM,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(Jp.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(bS),DD.initInfo={name:"GbufferStage",priority:kS.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:bT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:bT.BACK_TO_FRONT,stages:["default"]}]},OD=Y((PD=MD).prototype,"renderQueues",[wD,_l,RD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ID=PD))||ID)),sM=[new To(0,0,0,1)],cM=e("LightingStage",(ND=al("LightingStage"),LD=Gl(Mg),BD=Ml(),FD=Gl([IT]),zD=Ml(),ND((jD=VD=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=Td.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new fo,t._uiPhase=void 0,X(t,"_deferredMaterial",GD,j(t)),X(t,"renderQueues",HD,j(t)),t._phaseID=Vv("default"),t._renderQueues=[],t._uiPhase=new lE,t}z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,o=ao.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=Gi.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(ao.set(o,_.position.x,_.position.y,_.position.z,_.range),ic.sphereFrustum(o,e.frustum)){if(gi.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),gi.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}t.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var p=0;p<r.length&&c<this._maxDeferredLights;p++,++c){var d=r[p];if(ao.set(o,d.position.x,d.position.y,d.position.z,d.range),ic.sphereFrustum(o,e.frustum)){if(gi.toArray(a,d.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),gi.toArray(a,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=d.luminance*s*this._lightMeterScale:a[3]=d.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=d.size,a[1]=d.range,a[2]=d.spotAngle,this._lightBufferData.set(a,c*l+2*u),gi.toArray(a,d.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=t.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=MT(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new wo(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new ta(Yp.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new na(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(xd.BINDING,a),this._planarQueue=new cE(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects;this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,i),i.bindDescriptorSet(Jp.LOCAL,this._descriptorSet,[0]),t.generateRenderArea(e,this._renderArea),e.clearFlag&oo.COLOR&&(sM[0].x=e.clearColor.x,sM[0].y=e.clearColor.y,sM[0].z=e.clearColor.z),sM[0].w=0;var a=t.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(c,s,this._renderArea,sM,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(Jp.GLOBAL,t.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<4;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.update(),i.bindDescriptorSet(Jp.MATERIAL,l.descriptorSet);var _=t.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=_&&(f=mg.getOrCreatePipelineState(n,l,u,c,_)),null!=f&&(i.bindPipelineState(f),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(NT);for(var p=0,d=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(p=0;p<y.length;++p){var S=y[p].passes;for(d=0;d<S.length;++d)if(S[d].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,p,d)}}if(o.length>0){this._renderQueues.forEach(LT);for(var x=0;x<this._renderQueues.length;x++)this._renderQueues[x].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(e,c),i.endRenderPass()},t}(bS),VD.initInfo={name:"LightingStage",priority:kS.LIGHTING,tag:0},GD=Y((kD=jD).prototype,"_deferredMaterial",[LD,_l,BD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HD=Y(kD.prototype,"renderQueues",[FD,_l,zD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),UD=kD))||UD)),lM=[new To(0,0,0,1)],uM=e("PostProcessStage",(WD=al("PostProcessStage"),qD=Gl(Mg),XD=Ml(),YD=Gl([IT]),KD=Ml(),WD((tM=eM=function(e){function t(){var t;return X(t=e.call(this)||this,"_postProcessMaterial",JD,j(t)),X(t,"renderQueues",$D,j(t)),t._renderArea=new fo,t._uiPhase=new lE,t}z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.window.width,this._renderArea.y=o.y*e.window.height,this._renderArea.width=o.width*e.window.width,this._renderArea.height=o.height*e.window.height;var a=t.getPipelineRenderData(),s=e.window.framebuffer,c=e.window.swapchain,l=c?t.getRenderPass(e.clearFlag,c):s.renderPass;e.clearFlag&oo.COLOR&&(lM[0].x=e.clearColor.x,lM[0].y=e.clearColor.y,lM[0].z=e.clearColor.z),lM[0].w=e.clearColor.w,r.beginRenderPass(l,s,this._renderArea,lM,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Jp.GLOBAL,t.descriptorSet);var u=i.postprocessMaterial.passes[0],h=u.getShaderVariant();t.bloomEnabled?u.descriptorSet.bindTexture(0,a.bloom.combineTex):u.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),u.descriptorSet.bindSampler(0,a.sampler),u.descriptorSet.update(),r.bindDescriptorSet(Jp.MATERIAL,u.descriptorSet);var _=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,f=null;null!=u&&null!=h&&null!=_&&(f=mg.getOrCreatePipelineState(n,u,h,l,_));var p=t.pipelineSceneData.renderObjects;null!=f&&p.length>0&&(r.bindPipelineState(f),r.bindInputAssembler(_),r.draw(_)),this._uiPhase.render(e,l),Og(n,l,r,t.profiler,e),r.endRenderPass()},t}(bS),eM.initInfo={name:"PostProcessStage",priority:FS.POST_PROCESS,tag:0},JD=Y((ZD=tM).prototype,"_postProcessMaterial",[qD,_l,XD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$D=Y(ZD.prototype,"renderQueues",[YD,_l,KD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QD=ZD))||QD));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(nM||(nM={}));var hM,_M,fM,pM,dM,mM,vM,gM,yM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=nM.NONE,t}z(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),t.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new Mg;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new Mg;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new Mg;r._uuid="builtin-post-process-material",et.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=nM.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},B(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new Mg;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(iM),SM=[new To(0,0,0,1)],xM=function(){};xM.SIZE=4*(xM.COUNT=4+(xM.TEXTURE_SIZE_OFFSET=0));var TM,EM,CM,bM,AM,wM,RM,IM,PM,OM,DM=e("BloomStage",(hM=al("BloomStage"),_M=Gl(Mg),fM=Ml(),hM((gM=vM=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,X(t,"_bloomMaterial",mM,j(t)),t._renderArea=new fo,t._bloomUBO=[],t}z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,xM.SIZE,xM.SIZE));e.clearFlag&oo.COLOR&&(SM[0].x=e.clearColor.x,SM[0].y=e.clearColor.y,SM[0].z=e.clearColor.z),SM[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(xM.COUNT);a[xM.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,SM,0,0),n.bindDescriptorSet(Jp.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(Jp.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=mg.getOrCreatePipelineState(t.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,o=new Float32Array(xM.COUNT),a=0;a<this.iterations;++a){o[xM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[xM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,SM,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Jp.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=mg.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,o=new Float32Array(xM.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[xM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[xM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,SM,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(Jp.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=mg.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(xM.COUNT);a[xM.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,SM,0,0),n.bindDescriptorSet(Jp.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Jp.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=mg.getOrCreatePipelineState(t.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(bS),vM.initInfo={name:"BloomStage",priority:FS.BLOOM,tag:0},mM=Y((dM=gM).prototype,"_bloomMaterial",[_M,_l,fM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pM=dM))||pM)),MM=e("MainFlow",al("MainFlow")((CM=EM=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new aM;n.initialize(aM.initInfo),this._stages.push(n);var i=new cM;i.initialize(cM.initInfo),this._stages.push(i);var r=new DM;r.initialize(DM.initInfo),this._stages.push(r);var o=new uM;o.initialize(uM.initInfo),this._stages.push(o)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(wS),EM.initInfo={name:Vp,priority:GS.MAIN,stages:[]},TM=CM))||TM),NM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return z(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),LM=e("DeferredPipeline",(bM=al("DeferredPipeline"),AM=Gl([AT]),wM=Ml(),bM((OM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,X(t,"renderTextures",PM,j(t)),t}z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new PE;n.initialize(PE.initInfo),this._flows.push(n);var i=new MM;i.initialize(MM.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new yM,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(w(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(od,n),this._descriptorSet.bindTexture(od,Hv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(pd,n),this._descriptorSet.bindTexture(pd,Hv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new XS;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new qo;o.format=Cr.RGBA16F,o.loadOp=jr.CLEAR,o.storeOp=Wr.STORE;var a=new qo;a.format=Cr.RGBA16F,a.loadOp=jr.CLEAR,a.storeOp=Wr.STORE;var s=new qo;s.format=Cr.RGBA16F,s.loadOp=jr.CLEAR,s.storeOp=Wr.STORE;var c=new qo;c.format=Cr.RGBA16F,c.loadOp=jr.CLEAR,c.storeOp=Wr.STORE;var l=new Xo;l.format=Cr.DEPTH_STENCIL,l.depthLoadOp=jr.CLEAR,l.depthStoreOp=Wr.STORE,l.stencilLoadOp=jr.CLEAR,l.stencilStoreOp=Wr.STORE;var u=new Qo([o,a,s,c],l);this._gbufferRenderPass=t.createRenderPass(u)}if(!this._lightingRenderPass){var h=new qo;h.format=Cr.RGBA8,h.loadOp=jr.CLEAR,h.storeOp=Wr.STORE,h.endAccesses=[qr.COLOR_ATTACHMENT_WRITE];var _=new Xo;_.format=Cr.DEPTH_STENCIL,_.depthLoadOp=jr.LOAD,_.depthStoreOp=Wr.DISCARD,_.stencilLoadOp=jr.LOAD,_.stencilStoreOp=Wr.DISCARD,_.beginAccesses=[qr.DEPTH_STENCIL_ATTACHMENT_WRITE],_.endAccesses=[qr.DEPTH_STENCIL_ATTACHMENT_WRITE];var f=new Qo([h],_);this._lightingRenderPass=t.createRenderPass(f)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(nd.BINDING).destroy(),this._descriptorSet.getBuffer(rd.BINDING).destroy(),this._descriptorSet.getBuffer(id.BINDING).destroy(),this._descriptorSet.getTexture(od).destroy(),this._descriptorSet.getTexture(pd).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new NM,i=this.pipelineSceneData,r=0;r<4;++r)n.gbufferRenderTargets.push(t.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Cr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new Oo(Or.TEX2D,Dr.DEPTH_STENCIL_ATTACHMENT,Cr.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new $o(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Cr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new $o(this._lightingRenderPass,n.outputRenderTargets,n.outputDepth)),this.on(AS.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},t}(YS),PM=Y((IM=OM).prototype,"renderTextures",[AM,_l,wM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RM=IM))||RM));function BM(){var e=new rM;return e.initialize({flows:[]}),e}var FM=new Fi,zM=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new To(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new To(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{r.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?r.view.setDesignResolutionSize(n.width,n.height,n.policy):r.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,r.game.once(r.Game.EVENT_GAME_INITED,(function(){r.director._lateUpdate=performance.now()}),r.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else m("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),r.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new To(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new fo(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=t.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Vo("a_position",Cr.RG32F),new Vo("a_texCoord",Cr.RG32F)],u=new Wo(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new Mi,Mi.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),r.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,o=e.swapchain;Mi.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=g_(Jn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,_=e.logoTexture.height,f=c*i.displayRatio,p=f*h/_,d=f;if(o.surfaceTransform!==Tr.ROTATE_90&&o.surfaceTransform!==Tr.ROTATE_270||(p=f*a/s,d=f*_/h*s/a),e.logoMat.setProperty("resolution",FM.set(a,s),0),e.logoMat.setProperty("scale",FM.set(p,d),0),e.logoMat.setProperty("translate",FM.set(.5*a,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;o.surfaceTransform!==Tr.ROTATE_90&&o.surfaceTransform!==Tr.ROTATE_270||(g=.5*m,y=m*a/s*.5),e.watermarkMat.setProperty("resolution",FM.set(a,s),0),e.watermarkMat.setProperty("scale",FM.set(g,y),0),e.watermarkMat.setProperty("translate",FM.set(.5*a,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new Mg,this.logoMat.initialize({effectName:"splash-screen"});var t=new Mo;t.addressU=Fr.CLAMP,t.addressV=Fr.CLAMP,t.addressW=Fr.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new Oo(Or.TEX2D,Dr.SAMPLED|Dr.TRANSFER_DST,Cr.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new So;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new So;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Oo(Or.TEX2D,Dr.SAMPLED|Dr.TRANSFER_DST,Cr.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new Mg,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=mg.getOrCreatePipelineState(e,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(Jp.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=mg.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(Jp.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},B(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();zM._ins=void 0,r.internal.SplashScreen=zM;var UM=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},B(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());UM.Priority=Ke({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var kM=new te("Scheduler"),GM=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};GM.get=function(e,t,n,i){var r=GM._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new GM(e,t,n,i),r},GM.put=function(e){GM._listEntries.length<20&&(e.target=null,GM._listEntries.push(e))},GM._listEntries=[];var HM=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};HM.get=function(e,t,n,i){var r=HM._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new HM(e,t,n,i),r},HM.put=function(e){HM._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,HM._hashUpdateEntries.push(e))},HM._hashUpdateEntries=[];var VM=function(e,t,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};VM.get=function(e,t,n,i,r,o){var a=VM._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new VM(e,t,n,i,r,o),a},VM.put=function(e){VM._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,VM._hashTimerEntries.push(e))},VM._hashTimerEntries=[];var jM=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,i,o,a){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=a,this._useDelay=this._delay>0,this._repeat=o,this._runForever=this._repeat===r.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();jM._timers=[],jM.get=function(){return jM._timers.pop()||new jM},jM.put=function(e){jM._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,jM._timers.push(e))};var WM,qM=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=fe(!0),t._hashForTimers=fe(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}z(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?b(1513):e.id=kM.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(o=a[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,i,o,a){if("function"!=typeof e){var s=e;e=t,t=s}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!i,i=r.macro.REPEAT_FOREVER,o=0),P(t,1502);var c=t.uuid||t.id;if(c){var l,u,h=this._hashForTimers[c];if(h?h.paused!==a&&b(1511):(h=VM.get(null,t,0,null,null,a),this._arrayForTimers.push(h),this._hashForTimers[c]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&e===l._callback)return E(1507,l.getInterval(),n),void(l._interval=n);(l=jM.get()).initWithCallback(this,e,t,n,i,o),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else w(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return E(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var o,a=GM.get(e,t,n,!1);0===t?(o=this._updates0List,this._appendIn(o,a)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,t)),this._hashForUpdates[i]=HM.get(o,a,e,null)}else w(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),jM.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else w(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else w(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)jM.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else w(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(UM.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){P(e,1508),P(t,1509);var n=t.uuid||t.id;if(!n)return w(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(e===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(UM.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,o.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){P(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else w(1510)},n.resumeTarget=function(e){P(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else w(1510)},n.isTargetPaused=function(e){P(e,1505);var t=e.uuid||e.id;if(!t)return w(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}VM.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[t],GM.put(r),HM.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(UM));qM.ID="scheduler",r.Scheduler=qM;var XM=((WM={})[ah.PORTRAIT]=Tr.IDENTITY,WM[ah.LANDSCAPE_RIGHT]=Tr.ROTATE_90,WM[ah.PORTRAIT_UPSIDE_DOWN]=Tr.ROTATE_180,WM[ah.LANDSCAPE_LEFT]=Tr.ROTATE_270,WM),YM=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new Oo(Or.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED|Dr.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==Cr.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new Oo(Or.TEX2D,Dr.DEPTH_STENCIL_ATTACHMENT|Dr.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new $o(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,XM[hh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new $o(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=q(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},B(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),KM=function(){var e=t.prototype;function t(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=r.internal.DataPoolManager&&new r.internal.DataPoolManager(e),pg.registerCreateFunc(this),YM.registerCreateFunc(this),this._cameraPool=new We((function(){return new Em(t._device)}),4,(function(e){return e.destroy()}))}return e._init=function(){},e._destroy=function(){},e._setCumulativeTime=function(e){this._cumulativeTime+=e},e._setFrameTime=function(e){this._frameTime=e},e.initialize=function(){this._init();var e=r.game._swapchain,t=new qo;t.format=e.colorTexture.format;var n=new Xo;n.format=e.depthStencilTexture.format,n.depthStoreOp=Wr.DISCARD,n.stencilStoreOp=Wr.DISCARD;var i=new Qo([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:i,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(Hv.initBuiltinRes(this._device))},e.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},e.resize=function(e,t){for(var n,i=q(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},e.setRenderPipeline=function(e){e instanceof LM&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=BM(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(Er.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=r.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&r.internal.Batcher2D&&(this._batcher=new r.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},e.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},e.activeWindow=function(e){this._curWindow=e},e.resetCumulativeTime=function(){this._setCumulativeTime(0)},e.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();this._batcher&&this._batcher.update();for(var n=this._windows,i=[],o=0;o<n.length;o++)n[o].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([r.game._swapchain]);var a=this._scenes,s=r.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(var c=0;c<a.length;c++)a[c].update(s);r.director.emit(r.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},e.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},e.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},e.destroyWindows=function(){for(var e,t=q(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},e.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},e.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},e.destroyScenes=function(){for(var e,t=q(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},e.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new We((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e)):b(1300,e.constructor.name)},e.createCamera=function(){return this._cameraPool.alloc()},e.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new We((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case kg.SPHERE:e.scene.removeSphereLight(e);break;case kg.SPOT:e.scene.removeSpotLight(e)}},B(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),t}();r.Root=KM;var QM=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t}z(t,e);var n=t.prototype;return n.setFrameRate=function(e){this.frameRate=e},n.getFrameRate=function(){return this.frameRate},n.step=function(){r.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(gO._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return r.director.once(r.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return r.director.getScene().destroy(),r.Object._deferredDestroy(),r.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){pn.close()},n.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},n.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},n.init=function(e){var t=this;if(this._initConfig(e),fh._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&r.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,i=0;i<n.length;i++){var o=n[i],a=Dn(o.value);kp.addLayer(o.name,a)}return this._initEngine().then((function(){return t._initEvents(),r.director.root&&r.director.root.dataPoolManager&&r.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Lu.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(e){if(r.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=r.director._scene;if(r.isValid(n))if(e.parent){if(!(e.parent instanceof r.Scene))return void b(3801);if(e.parent!==n)return void b(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,r.assetManager._releaseManager._addPersistNodeRef(e)}}else b(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",r.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n._initEngine=function(){var e=this;this._initDevice();var n=r.director;return Promise.resolve(n._init()).then((function(){r.view.init(),p("Cocos Creator v"+o),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,r.internal.dynamicAtlasManager&&(r.internal.dynamicAtlasManager.enabled=!et.CLEANUP_IMAGE_CACHE)}))},n._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},n._ctTime=function(e){window.clearTimeout(e)},n._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},n._updateCallback=function(){var e,t=this,n=r.director;if(30===this._frameRate){var i=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(i=!i)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},n._runMainLoop=function(){if(this._inited){var e=this.config,t=r.director;M(!!e.showFPS),t.startAnimation(),this.resume()}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=R.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,y(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},n._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(O(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new bo(td),i=!!window.WebGL2RenderingContext,o=window.navigator.userAgent.toLowerCase();(-1!==o.indexOf("safari")&&-1===o.indexOf("chrome")||ph.browserType===sn.UC)&&(i=!1);var a=[];i&&r.WebGL2Device&&a.push(r.WebGL2Device),r.WebGLDevice&&a.push(r.WebGLDevice),r.EmptyDevice&&a.push(r.EmptyDevice),wa.canvas=this.canvas;for(var s=0;s<a.length&&(this._gfxDevice=new a[s],!this._gfxDevice.initialize(n));s++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&r.EmptyDevice&&(this._gfxDevice=new r.EmptyDevice,this._gfxDevice.initialize(new bo(td)));if(!this._gfxDevice)return m("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var c=new Co(this.canvas),l=fh.windowSize;c.width=l.width,c.height=l.height,this._swapchain=this._gfxDevice.createSwapchain(c),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){pn.on("show",this._onShow,this),pn.on("hide",this._onHide,this)},n._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){r.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof YS?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){d(n),d("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(r.internal.SplashScreen){var e=r.internal.SplashScreen.instance;return e.main(r.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){r.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},B(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(fn));QM.EVENT_HIDE="game_on_hide",QM.EVENT_SHOW="game_on_show",QM.EVENT_LOW_MEMORY="game_on_low_memory",QM.EVENT_GAME_INITED="game_inited",QM.EVENT_ENGINE_INITED="engine_inited",QM.EVENT_RENDERER_INITED="renderer_inited",QM.EVENT_RESTART="game_on_restart",QM.RENDER_TYPE_CANVAS=0,QM.RENDER_TYPE_WEBGL=1,QM.RENDER_TYPE_OPENGL=2,QM.RENDER_TYPE_HEADLESS=3,QM.DEBUG_DT_THRESHOLD=1,r.Game=QM;var ZM=e("game",r.game=new QM),JM=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new qM,t._compScheduler=new XO,t._nodeActivator=new hD,t._systems=[],ZM.once(QM.EVENT_RENDERER_INITED,t._initOnRendererInitialized,j(t)),t}z(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),r.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),r.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof _D&&(e=e.scene),P(e instanceof OO,1216),e._load();for(var i=Object.keys(ZM._persistRootNodes).map((function(e){return ZM._persistRootNodes[e]})),o=0;o<i.length;o++){var a=i[o];a.emit(r.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var s=e.uuid===a._originalSceneId&&e.getChildByUuid(a.uuid);if(s){var c=s.getSiblingIndex();s._destroyImmediate(),e.insertChild(a,c)}else a.parent=e}var l=this._scene;r.isValid(l)&&l.destroy(),r.assetManager._releaseManager._autoRelease(l,e,ZM._persistRootNodes),this._scene=null,Kt._deferredDestroy(),t&&t(),this.emit(r.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(r.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var i=this;e instanceof _D&&(e=e.scene),P(e,1205),P(e instanceof OO,1216),e._load(),this.once(r.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var i=this;if(this._loadingScene)return b(1208,e,this._loadingScene),!1;var o=r.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return o?(this.emit(r.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),o.loadScene(e,(function(r,o){console.timeEnd("LoadScene "+e),i._loadingScene="",r?(m(r),t&&t(r)):i.runSceneImmediate(o,n,t)})),!0):(w(1209,e),!1)},n.preloadScene=function(e,t,n){var i=r.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var o='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(o)),m("preloadScene: "+o)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return ZM.deltaTime},n.getTotalTime=function(){return ZM.totalTime},n.getCurrentTime=function(){return ZM.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(qM.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(UM.sortByPriority)},n.unregisterSystem=function(e){Ge.fastRemove(this._systems,e),this._systems.sort(UM.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(r.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=ZM._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),gO._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),Kt._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),$b.resetHasChangedFlags(),$b.clearNodeArray(),Ve.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(qM.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new KM(ZM._gfxDevice),this._root.initialize({}).catch((function(e){return w(1217),Promise.reject(e)}))},B(t,[{key:"root",get:function(){return this._root}}]),t}(fn));JM.EVENT_INIT="director_init",JM.EVENT_RESET="director_reset",JM.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",JM.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",JM.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",JM.EVENT_BEFORE_UPDATE="director_before_update",JM.EVENT_AFTER_UPDATE="director_after_update",JM.EVENT_BEFORE_DRAW="director_before_draw",JM.EVENT_AFTER_DRAW="director_after_draw",JM.EVENT_BEFORE_COMMIT="director_before_commit",JM.EVENT_BEFORE_PHYSICS="director_before_physics",JM.EVENT_AFTER_PHYSICS="director_after_physics",JM.EVENT_BEGIN_FRAME="director_begin_frame",JM.EVENT_END_FRAME="director_end_frame",JM.instance=void 0,r.Director=JM;var $M=e("director",JM.instance=r.director=new JM),eN={};Fn(eN,"vmath",[{name:"vec2",newName:"Vec2",target:Qi,targetName:"math"},{name:"vec3",newName:"Vec3",target:Qi,targetName:"math"},{name:"vec4",newName:"Vec4",target:Qi,targetName:"math"},{name:"quat",newName:"Quat",target:Qi,targetName:"math"},{name:"mat3",newName:"Mat3",target:Qi,targetName:"math"},{name:"mat4",newName:"Mat4",target:Qi,targetName:"math"},{name:"color4",newName:"Color",target:Qi,targetName:"math"},{name:"rect",newName:"Rect",target:Qi,targetName:"math"},{name:"approx",newName:"approx",target:Qi,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:Qi,targetName:"math"},{name:"equals",newName:"equals",target:Qi,targetName:"math"},{name:"clamp",newName:"clamp",target:Qi,targetName:"math"},{name:"clamp01",newName:"clamp01",target:Qi,targetName:"math"},{name:"lerp",newName:"lerp",target:Qi,targetName:"math"},{name:"toRadian",newName:"toRadian",target:Qi,targetName:"math"},{name:"toDegree",newName:"toDegree",target:Qi,targetName:"math"},{name:"random",newName:"random",target:Qi,targetName:"math"},{name:"randomRange",newName:"randomRange",target:Qi,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:Qi,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:Qi,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:Qi,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:Qi,targetName:"math"},{name:"repeat",newName:"repeat",target:Qi,targetName:"math"},{name:"pingPong",newName:"pingPong",target:Qi,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:Qi,targetName:"math"}]),r.vmath=eN,Fn(qM.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:qM,targetName:"Scheduler"}]),Fn(qM,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return UM.Priority.SCHEDULER}}]),zn(qM,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),Fn(Jv.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),zn(Jv.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),Fn(KM.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),Un(ZM,"game",[{name:"collisionMatrix"},{name:"groupList"}]),Un(JM.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),zn(JM.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var tN,nN={topLeft:r.v2(0,0),topRight:r.v2(0,0),top:r.v2(0,0),bottomLeft:r.v2(0,0),bottomRight:r.v2(0,0),bottom:r.v2(0,0),center:r.v2(0,0),left:r.v2(0,0),right:r.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,o=r+n,a=i+t;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+t/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};r.visibleRect=nN;var iN=new ji,rN=((tN={})[et.ORIENTATION_AUTO]=ah.AUTO,tN[et.ORIENTATION_LANDSCAPE]=ah.LANDSCAPE,tN[et.ORIENTATION_PORTRAIT]=ah.PORTRAIT,tN),oN=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=aN,i=sN;return t._designResolutionSize=new ji(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new qi(0,0,0,0),t._visibleRect=new qi(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new cN(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new cN(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new cN(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new cN(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new cN(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}z(t,e);var n=t.prototype;return n.init=function(){var e=fh.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,iN.width=this._visibleRect.width,iN.height=this._visibleRect.height,nN&&nN.init(this._visibleRect),hh.on("window-resize",this._updateAdaptResult,this),hh.on("orientation-change",this._updateAdaptResult,this),hh.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){hh.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){hh.orientation=rN[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&fh.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){hh.resolutionScale=1;var n=hh.devicePixelRatio,i=new ji(e*n,t*n);fh.windowSize=i},n.getCanvasSize=function(){return fh.windowSize},n.getFrameSize=function(){var e=hh.devicePixelRatio,t=fh.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=hh.devicePixelRatio;fh.windowSize=new ji(e*n,t*n)},n.getVisibleSize=function(){return new ji(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new ji(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Fi(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Fi(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof cN)this._resolutionPolicy=e;else{var t=cN;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=lN.getDesignResolutionSize();lN.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),iN.width=this._visibleRect.width,iN.height=this._visibleRect.height,nN&&nN.init(this._visibleRect),this.emit("design-resolution-changed")}else w(2200)},n.getDesignResolutionSize=function(){return new ji(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return hh.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new Fi);var r=hh.devicePixelRatio*(e-n.left),o=hh.devicePixelRatio*(n.top+n.height-t);return hh.isFrameRotated?(i.x=fh.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;r.director.root.resize(fh.windowSize.width,fh.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(fn));oN.instance=void 0;var aN=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=ZM.canvas;if(e){var t=fh.windowSize;e.width=t.width,e.height=t.height}},e}();aN.EQUAL_TO_FRAME=void 0,aN.PROPORTION_TO_FRAME=void 0;var sN=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,o){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new qi(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},e}();sN.EXACT_FIT=void 0,sN.SHOW_ALL=void 0,sN.NO_BORDER=void 0,sN.FIXED_HEIGHT=void 0,sN.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return z(t,e),t.prototype.apply=function(){hh.isProportionalToFrame=!1,this._setupCanvas()},t}(aN),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return z(t,e),t.prototype.apply=function(){hh.isProportionalToFrame=!0,this._setupCanvas()},t}(aN);aN.EQUAL_TO_FRAME=new e,aN.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return z(t,e),t.prototype.apply=function(e,t){var n=fh.windowSize,i=n.width,r=n.height,o=i/t.width,a=r/t.height;return this._buildResult(i,r,i,r,o,a)},t}(sN),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return z(t,e),t.prototype.apply=function(e,t){var n,i,r=fh.windowSize,o=r.width,a=r.height,s=t.width,c=t.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},t}(sN),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return z(t,e),t.prototype.apply=function(e,t){var n,i,r,o=fh.windowSize,a=o.width,s=o.height,c=t.width,l=t.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},t}(sN),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return z(t,e),t.prototype.apply=function(e,t){var n=fh.windowSize,i=n.width,r=n.height,o=r/t.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(sN),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return z(t,e),t.prototype.apply=function(e,t){var n=fh.windowSize,i=n.width,r=n.height,o=i/t.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(sN);sN.EXACT_FIT=new n,sN.SHOW_ALL=new i,sN.NO_BORDER=new r,sN.FIXED_HEIGHT=new o,sN.FIXED_WIDTH=new a}();var cN=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof aN&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof sN&&(this._contentStrategy=e)},B(e,[{key:"canvasSize",get:function(){return fh.windowSize}}]),e}());cN.EXACT_FIT=0,cN.NO_BORDER=1,cN.SHOW_ALL=2,cN.FIXED_HEIGHT=3,cN.FIXED_WIDTH=4,cN.UNKNOWN=5,cN.ContainerStrategy=aN,cN.ContentStrategy=sN,r.ResolutionPolicy=cN;var lN=e("view",oN.instance=r.view=new oN);r.winSize=iN,zn(oN.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),Un(oN.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"devicePixelRatio is a concept on web standard"},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),Un(r,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),Un(ph,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),Fn(ph,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:ph.Language,targetName:"sys.Language"}}))),Fn(ph,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:ph.OS,targetName:"sys.OS"}}))),Fn(ph,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:ph.BrowserType,targetName:"sys.BrowserType"}}))),Fn(ph,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:ph.BrowserType,targetName:"sys.BrowserType"}]),Fn(ph,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:ph.Platform,targetName:"sys.Platform"}}))),Fn(ph,"sys",[{name:"IPHONE",newName:"IOS",target:ph.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:ph.Platform,targetName:"sys.Platform"}]),zn(ph,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),Fn(ph,"sys",[{name:"windowPixelResolution",target:fh,targetName:"screen",newName:"windowSize"}]),Un(fh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var uN=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new nu,this.scenes=new nu,this.paths=new nu}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=yu(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var p=t[_];t[_]=h[p]=yu(p)}t=h}for(var d in n){var m=n[d];o[t[d]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var S=e.packs;for(var x in S)for(var T=S[x],E=0;E<T.length;++E)T[E]=t[T[E]];var C=e.versions;if(C)for(var b in C)for(var A=C[b],w=0;w<A.length;w+=2){var R=A[w];A[w]=t[R]||R}var I=e.redirect;if(I)for(var P=0;P<I.length;P+=2)I[P]=t[I[P]],I[P+1]=r[I[P+1]];if(e.extensionMap){var O=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var D in e.extensionMap)O(D)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=Cu(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(He.isChildClassOf(o.ctor,t))return o}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=Cu(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var o=0,a=n.length;o<a;o++){var s=n[o];t&&!He.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=He._getClassById(o),t.has(r)?a?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],o=n.get(r);o.url=i,t.add(i,o)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=t.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];t.get(o).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function hN(e,t){e._uuid&&t.push(e._uuid)}function _N(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=e[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Fu&&hN(s,t)}else if(o.constructor&&o.constructor!==Object)o instanceof Fu&&hN(o,t);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Fu&&hN(u,t)}}}}function fN(e,t){for(var n=0;n<e._components.length;n++)_N(e._components[n],t);for(var i=0;i<e._children.length;i++)fN(e._children[i],t)}function pN(e,t,n,i){n.push(e._uuid);for(var r=qm.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s=ou.get(r[o]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||pN(s,t,n,i)}}}var dN=[],mN=new(function(){function e(){this._persistNodeDeps=new nu,this._toDelete=new nu,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];fN(e,t);for(var n=0,i=t.length;n<i;n++){var r=ou.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=ou.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=qm.getDeps(e.uuid),r=0,o=i.length;r<o;r++){var a=ou.get(i[r]);a&&a.decRef(e.autoReleaseAssets)}var s=qm._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=ou.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&qm.remove(e.uuid)}var _=qm._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var p,d,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=q(v);!(d=g()).done;){var y=d.value,S=ou.get(y);S&&S.addRef()}_&&(p=_.persistDeps).push.apply(p,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof Fu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,ut(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),Zt(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,pN(e,t,dN,-1),dN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&pN(ou.get(n),t,dN,1);return dN.length=0,t[e._uuid]}(e)>0)){ou.remove(n);for(var i=qm.getDeps(n),r=0,o=i.length;r<o;r++){var a=ou.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),qm.remove(n)}},e}()),vN=null;function gN(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof Fu&&r.content.decRef(!1),r.recycle()}e.input=null}function yN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function SN(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(o,a){r++,!o||r>t?i&&i(o,a):setTimeout((function(){SN(e,t,n,i,r)}),n)}))}function xN(e,t,n,i,r){try{for(var o=qm.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(F({},o.nativeDep)))}catch(e){m(e.message,e.stack)}}function TN(e,t,n){t&&(n=void 0!==n?n:r.assetManager.cacheAsset,Eu(t)||!n||t.isDefault||ou.add(e,t))}function EN(e,t,n){var i=0,r=[],o=e.length;0===o&&n&&n(r);for(var a=function(e){e&&r.push(e),++i===o&&n&&n(r)},s=0;s<o;s++)t(e[s],a)}function CN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a="function"==typeof e;t?(o=t,a||(r=null)):void 0===t&&a&&(o=e,i=null,r=null),void 0!==t&&a&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function bN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a=He.isChildClassOf(e,Fu);t?(o=t,a&&(r=null)):void 0!==t||a||(o=e,r=null,i=null),void 0===t||a||(r=e,i=null)}return{type:i,onProgress:r||vN,onComplete:o}}function AN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,o=qm.getDeps(t);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===e||AN(e,c,n,i)){r=!0;break}}return r}function wN(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof Fu&&i.push(e.addRef())})):n instanceof Fu&&i.push(n.addRef()),ut((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var RN=function(){function e(){this._config=new uN}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),cu.add(e.name,this)},t.load=function(e,t,n,i){var o=bN(t,n,i),a=o.type,s=o.onProgress,c=o.onComplete,l={__requestType__:ru.PATH,type:a,bundle:this.name,__outputAsArray__:Array.isArray(e)};r.assetManager.loadAny(e,l,s,c)},t.preload=function(e,t,n,i){var o=bN(t,n,i),a=o.type,s=o.onProgress,c=o.onComplete;r.assetManager.preloadAny(e,{__requestType__:ru.PATH,type:a,bundle:this.name},s,c)},t.loadDir=function(e,t,n,i){var o=bN(t,n,i),a=o.type,s=o.onProgress,c=o.onComplete;r.assetManager.loadAny(e,{__requestType__:ru.DIR,type:a,bundle:this.name,__outputAsArray__:!0},s,c)},t.preloadDir=function(e,t,n,i){var o=bN(t,n,i),a=o.type,s=o.onProgress,c=o.onComplete;r.assetManager.preloadAny(e,{__requestType__:ru.DIR,type:a,bundle:this.name},s,c)},t.loadScene=function(e,t,n,i){var o=CN(t,n,i),a=o.options,s=o.onProgress,c=o.onComplete;a.preset=a.preset||"scene",a.bundle=this.name,r.assetManager.loadAny({scene:e},a,s,(function(e,t){if(e)m(e.message,e.stack);else if(t instanceof _D&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");c&&c(e,t)}))},t.preloadScene=function(e,t,n,i){var o=CN(t,n,i),a=o.options,s=o.onProgress,c=o.onComplete;a.bundle=this.name,r.assetManager.preloadAny({scene:e},a,s,(function(t){t&&w(1210,e,t.message),c&&c(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&ou.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&mN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;ou.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&mN.tryRelease(t)}))},t.releaseAll=function(){var e=this;ou.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&mN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},B(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),IN=e("resources",new RN);function PN(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(O(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=e,i}function ON(e,t,n,i){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}r.resources=IN;var DN={};function MN(e,t,n){if(DN[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),DN[e]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(O(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var NN=/^(?:\w+:\/\/|\.+\/).+/,LN=function(e,t,n){(ph.hasFeature(ph.Feature.IMAGE_BITMAP)&&r.assetManager.allowImageBitmap?BN:PN)(e,t,n)},BN=function(e,t,n){t.xhrResponseType="blob",ON(e,t,t.onFileProgress,n)},FN=function(e,t,n){t.xhrResponseType="json",ON(e,t,t.onFileProgress,n)},zN=function(e,t,n){t.xhrResponseType="arraybuffer",ON(e,t,t.onFileProgress,n)},UN=function(e,t,n){FN(e,t,(function(t,i){if(t)n(t);else{var r=gh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){zN(""+Sn(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new vh(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},kN=function(e,t,n){zN(e,t,(function(e,t){if(e)n(e);else try{var i=yh(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},GN=function(e,t,n){t.xhrResponseType="text",ON(e,t,t.onFileProgress,n)},HN=function(e,t,n){var i=xn(e),r=e;NN.test(r)||(r=-1!==VN.remoteBundles.indexOf(i)?VN.remoteServerAddress+"remote/"+i:"assets/"+i);var o=t.version||VN.bundleVers[i],a=0,s=null,c=null;FN(r+"/config."+(o?o+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++a&&n(c,s)})),MN(r+"/index."+(o?o+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},VN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=PN,this.downloadDomAudio=null,this.downloadFile=ON,this.downloadScript=MN,this._downloaders={".png":LN,".jpg":LN,".bmp":LN,".jpeg":LN,".gif":LN,".ico":LN,".tiff":LN,".webp":LN,".image":LN,".pvr":zN,".pkm":zN,".astc":zN,".txt":GN,".xml":GN,".vsh":GN,".fsh":GN,".atlas":GN,".tmx":GN,".tsx":GN,".json":FN,".ExportJson":FN,".plist":GN,".ccon":UN,".cconb":kN,".fnt":GN,".binary":zN,".bin":zN,".dbbin":zN,".skel":zN,".js":MN,bundle:HN,default:GN},this._downloading=new nu,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?Ce(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var o=this,a=au.get(e);if(a)r(null,a);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;SN((function(n,a){if(0===n&&o._downloading.add(e,[r]),o.limited){o._updateTime();var s=function(e,t){o._totalNum--,o._handleQueueInNextFrame(h,_),a(e,t)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(yN(t,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(yN(t,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||au.add(e,n);for(var i=o._downloading.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){r.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=r.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(yN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(ut(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},B(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function jN(e,t,n,i){var r=null,o=null;try{(r=new zm)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}i(o,r)}function WN(e,t,n,i){var r=new gD;r.json=t,i(null,r)}function qN(e,t,n,i){var r=new vD;r.text=t,i(null,r)}function XN(e,t,n,i){var r=new GA;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function YN(e,t,n,i){var r=new Fu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function KN(e,n,i,r){var o=cu.get(n.name);o||(o=n.name===_u.RESOURCES?IN:new RN,n.base=n.base||e+"/",o.init(n)),t.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var QN=new(function(){function e(){this._creating=new nu,this._producers={".png":jN,".jpg":jN,".bmp":jN,".jpeg":jN,".gif":jN,".ico":jN,".tiff":jN,".webp":jN,".image":jN,".pvr":jN,".pkm":jN,".txt":qN,".xml":qN,".vsh":qN,".fsh":qN,".atlas":qN,".tmx":qN,".tsx":qN,".fnt":qN,".json":WN,".ExportJson":WN,".binary":XN,".bin":XN,".dbbin":XN,".skel":XN,bundle:KN,default:YN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?He.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=ou.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),a(e,t,i,(function(t,n){!t&&n instanceof Fu&&(n._uuid=e,TN(e,n,i.cacheAsset));for(var r=o._creating.remove(e),a=0,s=r.length;a<s;a++)r[a](t,n)})))}else r(null,s)},e}()),ZN=new(function(){function e(){this._loading=new nu,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=He.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(O(5304,e[0]));Uh(e,!0,void 0,Gh.reportMissingClass),kh(e);for(var t=new Hh(e[0]),n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,r,o);return a}(t)).length!==e.length&&w(4915);for(var a=0;a<e.length;a++)r[e[a]+"@import"]=t[a]}else{var s=He._getClassId(lv),c=He._getClassId(zm);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&w(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=Vh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&w(4915);for(var _=0;_<e.length;_++)r[e[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?He.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(au.has(e.id))n(null,au.get(e.id));else{var r=e.info.packs,o=r.find((function(e){return i._loading.has(e.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:e.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:e.id}]);var a=bu(o.uuid,{ext:o.ext,bundle:e.config.name});VN.download(o.uuid,a,o.ext,e.options,(function(t,n){au.remove(o.uuid),t&&m(t.message,t.stack),i.unpack(o.packedUuids,n,o.ext,e.options,(function(e,n){if(!e)for(var r in n)au.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else VN.download(e.id,e.url,e.ext,e.options,n)},e}());function JN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,o=e.progress,a=[],s=o.total,c=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],EN(e.input,(function(i,l){if(!i.isNative&&ou.has(i.uuid)){var u=ou.get(i.uuid);return i.content=u.addRef(),e.output.push(i),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,i),void l()}ZN.load(i,e.options,(function(u,h){u?e.isFinish||(!r.assetManager.force||n?(m(u.message,u.stack),o.canInvoke=!1,t(u)):(e.output.push(i),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,i))):e.isFinish||(i.file=h,e.output.push(i),i.isNative||(c[i.uuid]=!0,xN(i.uuid,h,c,a,i.config),o.total=s+a.length),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,i)),l()}))}),(function(){if(e.isFinish)return gN(e,!0),void e.dispatch("error");if(a.length>0){var r=pu.create({input:a,progress:o,options:i,onProgress:e.onProgress,onError:pu.prototype.recycle,onComplete:function(i){var o;i||((o=e.output).push.apply(o,r.output),r.recycle()),n&&$N(e),t(i)}});uu.async(r)}else n&&$N(e),t()}))}function $N(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var eL=new(function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return b(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function tL(e,t){return e[t]<<8|e[t+1]}var nL=new(function(){function e(){this._parsing=new nu,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=tL(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=tL(a,12),l=tL(a,14);tL(a,8),tL(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?cm.RGBA_ASTC_4x4:5===e?4===t?cm.RGBA_ASTC_5x4:cm.RGBA_ASTC_5x5:6===e?5===t?cm.RGBA_ASTC_6x5:cm.RGBA_ASTC_6x6:8===e?5===t?cm.RGBA_ASTC_8x5:6===t?cm.RGBA_ASTC_8x6:cm.RGBA_ASTC_8x8:10===e?5===t?cm.RGBA_ASTC_10x5:6===t?cm.RGBA_ASTC_10x6:8===t?cm.RGBA_ASTC_10x8:cm.RGBA_ASTC_10x10:10===t?cm.RGBA_ASTC_12x10:cm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=eL.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=jm(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?Ce(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var o=this,a=su.get(e);if(a)r(null,a);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?au.remove(e):Eu(n)||su.add(e,n);for(var i=o._parsing.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))):r(null,t)}}},e}());function iL(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,o=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],EN(e.input,(function(a,s){var c=pu.create({input:a,onProgress:e.onProgress,options:i,progress:o,onComplete:function(i,l){i&&!e.isFinish&&(!r.assetManager.force||n?(m(i.message,i.stack),o.canInvoke=!1,t(i)):o.canInvoke&&e.dispatch("progress",++o.finish,o.total,a)),e.output.push(l),c.recycle(),s(null)}});rL.async(c)}),(function(){if(i.__exclude__=null,e.isFinish)return gN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),gN(e,!0),t()}))}var rL=new iu("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&ou.has(o)?t():ZN.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)nL.parse(o,a,n.ext,s,(function(r,a){r?t(r):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),au.remove(o),su.remove(o),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||AN(c,c,r)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&ou.has(c)){var p=ou.get(c);n.content=p.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,nL.parse(o,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),xN(a,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var _=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=pu.create({input:h,options:e.options,onProgress:e.onProgress,onError:pu.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=q(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Fu?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=Gm.get(t);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(m("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Fu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}Gm.delete(t)}Hm.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Hm.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||Vm.has(t)||Hm.has(t)||(t.onLoaded(),Vm.add(t))}catch(e){m("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}au.remove(s),su.remove(s),TN(a,t,u),f.recycle()}for(var l=_.callbacks,h=0,p=l.length;h<p;h++){var d=l[h];t.addRef&&t.addRef(),d.item.content=t,d.done(e)}l.length=0}});lu.async(f)}(e,i,t)}))}}]);function oL(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case ru.PATH:case ru.UUID:case ru.DIR:case ru.SCENE:case ru.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}e.options=r;var a=pu.create({input:e.input,options:i}),s=null;try{e.output=e.source=hu.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var aL=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},B(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();aL.MAX_DEAD_NUM=500,aL._deadPool=[];var sL=[];function cL(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,o=n[i],a=aL.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||ru.UUID]=n[i]),"object"==typeof o)for(var l in Ee(o,t),o.preset&&Ee(o,fu[o.preset]),o){switch(l){case ru.UUID:if("break"===function(){var e,t=a.uuid=yu(o.uuid);if(!o.bundle){var n=cu.find((function(e){return!!e.getAssetInfo(t)}));o.bundle=n&&n.name}if(cu.has(o.bundle)){if(s=cu.get(o.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!cu.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=cu.get(c.redirect).config,c=s.getAssetInfo(t)}a.config=s,a.info=c}return a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case ru.DIR:if(cu.has(o.bundle)){cu.get(o.bundle).config.getDirWithPath(o.dir,o.type,sL);for(var u,h=q(sL);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}sL.length=0}a.recycle(),a=null;break;case ru.PATH:if(cu.has(o.bundle)){if(s=cu.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!cu.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=cu.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case ru.SCENE:if(!o.bundle){var f=cu.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(cu.has(o.bundle)){if(s=cu.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!cu.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=cu.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case ru.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||yn(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function lL(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var o,a,s=i.config;a=i.isNative?s&&s.nativeBase?s.base+s.nativeBase:r.assetManager.generalNativeBase:s&&s.importBase?s.base+s.importBase:r.assetManager.generalImportBase;var c=i.uuid,l="";i.info&&(l=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),o=".ttf"===i.ext?a+"/"+c.slice(0,2)+"/"+c+l+"/"+i.options.__nativeName__:a+"/"+c.slice(0,2)+"/"+c+l+i.ext,i.url=o}}return null}var uL=e("AssetManager",function(){function e(){this.pipeline=lu.append(oL).append(iL),this.fetchPipeline=uu.append(oL).append(JN),this.transformPipeline=hu.append(cL).append(lL),this.bundles=cu,this.assets=ou,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=qm,this.force=!1,this.allowImageBitmap=!ph.isMobile,this.utils=Nu,this.downloader=VN,this.parser=nL,this.packManager=ZN,this.cacheAsset=!0,this.cacheManager=null,this.presets=fu,this.factory=QN,this.preprocessPipe=oL,this.fetchPipe=JN,this.loadPipe=iL,this.references=null,this._releaseManager=mN,this._files=au,this._parsed=su,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return cu.get(e)||null},t.removeBundle=function(e){e._destroy(),cu.remove(e.name)},t.loadAny=function(e,t,n,i){var r=CN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",e=Array.isArray(e)?e.slice():e;var c=pu.create({input:e,onProgress:a,onComplete:wN(s),options:o});lu.async(c)},t.preloadAny=function(e,t,n,i){var r=CN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=pu.create({input:e,onProgress:a,onComplete:wN(s),options:o});uu.async(c)},t.loadRemote=function(e,t,n){var i=CN(t,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(m(t.message,t.stack),o&&o(t,n)):QN.create(e,n,r.ext||yn(e),r,(function(e,t){o&&o(e,t)}))}))):wN(o)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=CN(t,void 0,n),r=i.options,o=i.onComplete,a=xn(e);this.bundles.has(a)?wN(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(m(t.message,t.stack),o&&o(t,n)):QN.create(e,n,"bundle",r,(function(e,t){o&&o(e,t)}))})))},t.releaseAsset=function(e){mN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){ou.forEach((function(e){mN.tryRelease(e)}))},t.releaseAll=function(){ou.forEach((function(e){mN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},B(e,[{key:"main",get:function(){return cu.get(_u.MAIN)||null}},{key:"resources",get:function(){return cu.get(_u.RESOURCES)||null}}]),e}());uL.Pipeline=iu,uL.Task=pu,uL.Cache=nu,uL.RequestItem=aL,uL.Bundle=RN,uL.BuiltinBundleName=_u;var hL=e("assetManager",r.assetManager=new uL);r.AssetManager=uL;var _L=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],fL=[".mp3",".ogg",".wav",".m4a"];function pL(){return!0}var dL={transformURL:function(e){var t=xu(e);if(!t)return e;var n=cu.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var o=!1;if(".ttf"===yn(e)&&(o=!0),o){var a=Tn(e),s=xn(e);e=a+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+i}));return e}},mL=e("CCLoader",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=bN}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];hL.loadAny(i,null,(function(e,n,i){i.content&&(_L.includes(i.ext)?a.push(i.content):fL.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var o=function(e){var n=t[e];if(!(n instanceof Fu)){var r=n,o=i[e].url;a.includes(r)?QN.create(o,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&QN.create(o,n,".mp3",{},(function(n,i){r=t[e]=i})),ou.add(o,r)}},c=0;c<t.length;c++)o(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:pL,_map:l}}else r=t[0]}n&&n(e,r)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return hL.assets.has(e)?{content:hL.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=yn(e);c&&!IN.getInfoWithPath(e,o)&&(e=e.slice(0,-c.length)),IN.load(e,o,a,s)},t.loadResArray=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=yn(t);i&&!IN.getInfoWithPath(t,o)&&(e[n]=t.slice(0,-i.length))})),IN.load(e,o,a,s)},t.loadResDir=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;IN.loadDir(e,o,a,(function(t,n){var i=[];t||(i=IN.getDirWithPath(e,o).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return ou.has(e)?ou.get(e):IN.get(e,t)},t.getResCount=function(){return ou.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return qm.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);VN.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);nL.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=ou.get(n)),hL.releaseAsset(n)}else e&&("string"==typeof e&&(e=ou.get(e)),hL.releaseAsset(e))},t.releaseAsset=function(e){hL.releaseAsset(e)},t.releaseRes=function(e,t){IN.release(e,t)},t.releaseAll=function(){hL.releaseAll(),ou.clear()},t.removeItem=function(e){return!!ou.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=qm.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},B(e,[{key:"onProgress",set:function(e){vN=e}},{key:"_cache",get:function(){if(ou instanceof nu)return ou._map;var e={};return ou.forEach((function(t,n){e[n]=t})),e}},{key:"md5Pipe",get:function(){return dL}},{key:"downloader",get:function(){return VN}},{key:"loader",get:function(){return hL.parser}}]),e}()),vL=e("loader",new mL),gL=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,hL.init(e),e.rawAssets&&IN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:_u.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){hL.loadAny(e,t)}}),yL=e("url",{});Fn(yL,"url",[{name:"normalize",target:hL.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?bu({path:En(e.substr(10)),bundle:_u.RESOURCES,__isNative__:!0,ext:yn(e)}):""}}]),zn(gL,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),zn(vL,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),Fn(r,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return vL}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return gL}},{name:"Pipeline",target:uL,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return yL}}]),zn(r,"cc",[{name:"LoadingItems",suggest:O(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),Fn(et,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:VN,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),Fn($M,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return hL.main?null===(t=hL.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),Fn(ZM,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return hL.main&&hL.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var SL,xL,TL,EL,CL,bL,AL,wL,RL,IL,PL,OL,DL,ML,NL=mN._autoRelease;mN._autoRelease=function(e,t,n){NL.call(mN,e,t,n);for(var i=vL._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=ou.get(a);s&&mN.tryRelease(s)}}};var LL,BL,FL,zL,UL,kL,GL,HL,VL,jL,WL,qL,XL,YL,KL,QL,ZL,JL,$L,eB,tB,nB,iB,rB,oB,aB,sB,cB,lB,uB,hB,_B,fB,pB,dB,mB,vB,gB,yB,SB,xB,TB,EB,CB,bB,AB,wB,RB,IB,PB,OB,DB,MB,NB,LB,BB,FB,zB,UB,kB,GB,HB,VB,jB,WB,qB,XB,YB=e("EventHandler",(SL=al("cc.ClickEvent"),xL=Gl(r.Node),TL=wl(),EL=wl(),CL=wl(),bL=wl(),SL((ML=function(){function e(){X(this,"target",RL,this),X(this,"component",IL,this),X(this,"_componentId",PL,this),X(this,"handler",OL,this),X(this,"customEventData",DL,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=t.length;o<a;o++){var s=t[o];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(r.isValid(t)){this._genCompIdIfNeeded();var n=r.js._getClassById(this._componentId),i=t.getComponent(n);if(r.isValid(i)){var o=i[this.handler];"function"==typeof o&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),o.apply(i,e))}}},t._compName2Id=function(e){var t=r.js.getClassByName(e);return r.js._getClassId(t)},t._compId2Name=function(e){var t=r.js._getClassById(e);return r.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},B(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),RL=Y((wL=ML).prototype,"target",[_l,xL,_l,TL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IL=Y(wL.prototype,"component",[_l,El,EL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),PL=Y(wL.prototype,"_componentId",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OL=Y(wL.prototype,"handler",[_l,El,CL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DL=Y(wL.prototype,"customEventData",[_l,El,bL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),AL=wL))||AL));r.Component.EventHandler=YB;var KB,QB,ZB,JB,$B,eF,tF,nF,iF,rF,oF,aF=new gi,sF=Ke(em),cF=Ke($d),lF=Ke(tm),uF=Ke(im),hF=Ke(nm),_F=Ke({SKYBOX:xm|oo.DEPTH_STENCIL,SOLID_COLOR:oo.ALL,DEPTH_ONLY:oo.DEPTH_STENCIL,DONT_CLEAR:oo.NONE}),fF=(LL=al("cc.Camera"),BL=Tl(),FL=gl(),zL=Ml(),UL=wl(),kL=Gl(kp.BitMask),GL=Ml(),HL=wl(),VL=Gl(_F),jL=Ml(),WL=wl(),qL=Ml(),XL=wl(),YL=Ml(),KL=wl(),QL=Ml(),ZL=wl(),JL=Gl(sF),$L=Ml(),eB=wl(),tB=Gl(cF),nB=Ml(),iB=wl(),rB=Ml(),oB=wl(),aB=Ml(),sB=wl(),cB=Ml(),lB=wl(),uB=Ml(),hB=wl(),_B=Gl(lF),fB=Ml(),pB=wl(),dB=Gl(uF),mB=Ml(),vB=wl(),gB=Gl(hF),yB=Ml(),SB=wl(),xB=Ml(),TB=wl(),EB=Gl(CT),CB=Ml(),bB=wl(),KB=LL(AB=BL(AB=FL(AB=vl((XB=qB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_projection",RB,j(t)),X(t,"_priority",IB,j(t)),X(t,"_fov",PB,j(t)),X(t,"_fovAxis",OB,j(t)),X(t,"_orthoHeight",DB,j(t)),X(t,"_near",MB,j(t)),X(t,"_far",NB,j(t)),X(t,"_color",LB,j(t)),X(t,"_depth",BB,j(t)),X(t,"_stencil",FB,j(t)),X(t,"_clearFlags",zB,j(t)),X(t,"_rect",UB,j(t)),X(t,"_aperture",kB,j(t)),X(t,"_shutter",GB,j(t)),X(t,"_iso",HB,j(t)),X(t,"_screenScale",VB,j(t)),X(t,"_visibility",jB,j(t)),X(t,"_targetTexture",WB,j(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}z(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=ng.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=fr.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new gi),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new gi),!this._camera)return n;this.worldToScreen(e,aF);var i=t.getComponent("cc.UITransform"),o=lN.getVisibleSize(),a=aF.x-.5*this._camera.width,s=aF.y-.5*this._camera.height;return aF.x=a/r.view.getScaleX()+.5*o.width,aF.y=s/r.view.getScaleY()+.5*o.height,i&&i.convertToNodeSpaceAR(aF,n),n},n._createCamera=function(){this._camera||(this._camera=r.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?r.director.root&&r.director.root.mainWindow:r.director.root&&r.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=ei(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},B(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===$d.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=ei(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?r.director.root&&r.director.root.mainWindow:r.director.root&&r.director.root.tempWindow)}}]),t}(rh),qB.ProjectionType=sF,qB.FOVAxis=cF,qB.ClearFlag=_F,qB.Aperture=lF,qB.Shutter=uF,qB.ISO=hF,qB.TARGET_TEXTURE_CHANGE="tex-change",RB=Y((wB=XB).prototype,"_projection",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sF.PERSPECTIVE}}),IB=Y(wB.prototype,"_priority",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PB=Y(wB.prototype,"_fov",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),OB=Y(wB.prototype,"_fovAxis",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cF.VERTICAL}}),DB=Y(wB.prototype,"_orthoHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),MB=Y(wB.prototype,"_near",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NB=Y(wB.prototype,"_far",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),LB=Y(wB.prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi("#333333")}}),BB=Y(wB.prototype,"_depth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FB=Y(wB.prototype,"_stencil",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zB=Y(wB.prototype,"_clearFlags",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _F.SOLID_COLOR}}),UB=Y(wB.prototype,"_rect",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(0,0,1,1)}}),kB=Y(wB.prototype,"_aperture",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lF.F16_0}}),GB=Y(wB.prototype,"_shutter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uF.D125}}),HB=Y(wB.prototype,"_iso",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hF.ISO100}}),VB=Y(wB.prototype,"_screenScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jB=Y(wB.prototype,"_visibility",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rm}}),WB=Y(wB.prototype,"_targetTexture",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(wB.prototype,"priority",[zL,UL],Object.getOwnPropertyDescriptor(wB.prototype,"priority"),wB.prototype),Y(wB.prototype,"visibility",[kL,GL,HL],Object.getOwnPropertyDescriptor(wB.prototype,"visibility"),wB.prototype),Y(wB.prototype,"clearFlags",[VL,jL,WL],Object.getOwnPropertyDescriptor(wB.prototype,"clearFlags"),wB.prototype),Y(wB.prototype,"clearColor",[qL,XL],Object.getOwnPropertyDescriptor(wB.prototype,"clearColor"),wB.prototype),Y(wB.prototype,"clearDepth",[YL,KL],Object.getOwnPropertyDescriptor(wB.prototype,"clearDepth"),wB.prototype),Y(wB.prototype,"clearStencil",[QL,ZL],Object.getOwnPropertyDescriptor(wB.prototype,"clearStencil"),wB.prototype),Y(wB.prototype,"projection",[JL,$L,eB],Object.getOwnPropertyDescriptor(wB.prototype,"projection"),wB.prototype),Y(wB.prototype,"fovAxis",[tB,nB,iB],Object.getOwnPropertyDescriptor(wB.prototype,"fovAxis"),wB.prototype),Y(wB.prototype,"fov",[rB,oB],Object.getOwnPropertyDescriptor(wB.prototype,"fov"),wB.prototype),Y(wB.prototype,"orthoHeight",[aB,sB],Object.getOwnPropertyDescriptor(wB.prototype,"orthoHeight"),wB.prototype),Y(wB.prototype,"near",[cB,lB],Object.getOwnPropertyDescriptor(wB.prototype,"near"),wB.prototype),Y(wB.prototype,"far",[uB,hB],Object.getOwnPropertyDescriptor(wB.prototype,"far"),wB.prototype),Y(wB.prototype,"aperture",[_B,fB,pB],Object.getOwnPropertyDescriptor(wB.prototype,"aperture"),wB.prototype),Y(wB.prototype,"shutter",[dB,mB,vB],Object.getOwnPropertyDescriptor(wB.prototype,"shutter"),wB.prototype),Y(wB.prototype,"iso",[gB,yB,SB],Object.getOwnPropertyDescriptor(wB.prototype,"iso"),wB.prototype),Y(wB.prototype,"rect",[xB,TB],Object.getOwnPropertyDescriptor(wB.prototype,"rect"),wB.prototype),Y(wB.prototype,"targetTexture",[EB,CB,bB],Object.getOwnPropertyDescriptor(wB.prototype,"targetTexture"),wB.prototype),AB=wB))||AB)||AB)||AB)||AB,e({Camera:KB,CameraComponent:KB}),KB);r.Camera=fF;var pF,dF,mF,vF,gF,yF,SF,xF,TF={parent:null,owner:null,subModelIdx:0},EF=e("RenderableComponent",(QB=al("cc.RenderableComponent"),ZB=Gl([Mg]),JB=Gl(Mg),$B=Ml(),eF=Al(),QB((oF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_materials",iF,j(t)),X(t,"_visFlags",rF,j(t)),t._materialInstances=[],t._models=[],t}z(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof Kg&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){TF.parent=this._materials[e],TF.owner=this,TF.subModelIdx=e;var t=new Kg(TF);TF.parent=null,TF.owner=null,TF.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){b(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},B(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(e[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}}]),t}(rh),iF=Y((nF=oF).prototype,"_materials",[ZB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rF=Y(nF.prototype,"_visFlags",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kp.Enum.NONE}}),Y(nF.prototype,"sharedMaterials",[JB,$B,eF],Object.getOwnPropertyDescriptor(nF.prototype,"sharedMaterials"),nF.prototype),tF=nF))||tF));function CF(e){return"string"==typeof e||"number"==typeof e}r.RenderableComponent=EF,Fn(fF,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),Fn(fF.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),r.CameraComponent=fF,He.setClassAlias(fF,"cc.CameraComponent");var bF,AF,wF,RF,IF,PF,OF,DF,MF,NF,LF,BF,FF,zF,UF,kF,GF,HF,VF,jF,WF,qF,XF=al("cc.animation.HierarchyPath")((vF=function(){function e(e){X(this,"path",mF,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof $b?e.getChildByPath(this.path)||(b(3926,e.name,this.path),null):(b(3925),null)},e}(),mF=Y((dF=vF).prototype,"path",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pF=dF))||pF,YF=al("cc.animation.ComponentPath")((xF=function(){function e(e){X(this,"component",SF,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof $b?e.getComponent(this.component)||(b(3928,e.name,this.component),null):(b(3927),null)},e}(),SF=Y((yF=xF).prototype,"component",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gF=yF))||gF,KF=al("cc.animation.UniformProxyFactory")((PF=function(){function e(e,t){X(this,"passIndex",wF,this),X(this,"uniformName",RF,this),X(this,"channelIndex",IF,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(Kv.getTypeFromHandle(n)<Ar.SAMPLER1D){var i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,Ar.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=q(e.shaderInfo.blocks);!(n=i()).done;)for(var r,o=q(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(i,e)}}:{set:function(e){t.setUniform(i,e)}}}var o=Kv.getBindingFromHandle(n),a=t.properties[this.uniformName],s=a&&a.value?a.value+"-texture":wv(a.type),c=Hv.get(s);return c||(d("Illegal texture default value: "+s+"."),c=Hv.get("default-texture")),{set:function(e){e||(e=c);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(o,n),e instanceof km&&t.bindSampler(o,r.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),wF=Y((AF=PF).prototype,"passIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RF=Y(AF.prototype,"uniformName",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),IF=Y(AF.prototype,"channelIndex",[zl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),bF=AF))||bF,QF=al("cc.animation.MorphWeightValueProxy")((LF=function(){function e(){X(this,"subMeshIndex",MF,this),X(this,"shapeIndex",NF,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),MF=Y((DF=LF).prototype,"subMeshIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NF=Y(DF.prototype,"shapeIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OF=DF))||OF,ZF=al("cc.animation.MorphWeightsValueProxy")((UF=function(){function e(){X(this,"subMeshIndex",zF,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),zF=Y((FF=UF).prototype,"subMeshIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BF=FF))||BF,JF=al("cc.animation.MorphWeightsAllValueProxy")(kF=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)e.setWeights(t,o)}}},e}())||kF;function $F(e,t,n,i){var r,o,a,s,c,l,u=new t,h=new t,_=new t,f=al(e)((l=function(){function e(e,n,i){X(this,"dataPoint",a,this),X(this,"inTangent",s,this),X(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var o=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,r),_=n(_,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,p=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,p)},r.getNoLerp=function(){return this.dataPoint},e}(),a=Y((o=l).prototype,"dataPoint",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=Y(o.prototype,"inTangent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=Y(o.prototype,"outTangent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=o))||r;if(t===bi){var p=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=p.call(this,e,t,n);return bi.normalize(i,i),i}}return f}var ez=e("CubicSplineVec2Value",$F("cc.CubicSplineVec2Value",Fi,Fi.multiplyScalar,Fi.scaleAndAdd));r.CubicSplineVec2Value=ez;var tz=e("CubicSplineVec3Value",$F("cc.CubicSplineVec3Value",gi,gi.multiplyScalar,gi.scaleAndAdd));r.CubicSplineVec3Value=tz;var nz=e("CubicSplineVec4Value",$F("cc.CubicSplineVec4Value",Gi,Gi.multiplyScalar,Gi.scaleAndAdd));r.CubicSplineVec4Value=nz;var iz=e("CubicSplineQuatValue",$F("cc.CubicSplineQuatValue",bi,bi.multiplyScalar,bi.scaleAndAdd));r.CubicSplineQuatValue=iz;var rz=e("CubicSplineNumberValue",al("cc.CubicSplineNumberValue")((qF=function(){function e(e,t,n){X(this,"dataPoint",VF,this),X(this,"inTangent",jF,this),X(this,"outTangent",WF,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*n*(o-a)},t.getNoLerp=function(){return this.dataPoint},e}(),VF=Y((HF=qF).prototype,"dataPoint",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jF=Y(HF.prototype,"inTangent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WF=Y(HF.prototype,"outTangent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GF=HF))||GF);r.CubicSplineNumberValue=rz;var oz,az,sz,cz,lz,uz,hz,_z,fz,pz,dz,mz,vz,gz,yz,Sz,xz,Tz,Ez,Cz,bz,Az,wz,Rz,Iz,Pz,Oz,Dz=Symbol("CreateEval"),Mz=Symbol("NormalizedFollow"),Nz=Symbol("ConvertAsTrsPath"),Lz=Symbol("TrackBinding"),Bz=al("cc.animation.TrackPath")((cz=function(){function e(){X(this,"_paths",sz,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new XF(e)),this},t.toComponent=function(e){var t=new YF("string"==typeof e?e:He.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof XF},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof YF},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[Mz](e,t,n)},t[Nz]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var o=t[i];if(!(o instanceof XF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[Mz]=function(e,t,n){for(var i=this._paths,r=e,o=t;o<n;++o){var a=i[o];if(CF(a)){if(!(a in r))return b(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},B(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),sz=Y((az=cz).prototype,"_paths",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oz=az))||oz,Fz=al("cc.animation.TrackBinding")(lz=ml((fz=function(){function e(){X(this,"path",hz,this),X(this,"proxy",_z,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[Nz]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[Mz](e,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return w(3921),null}var h,_=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),f=i[Mz](e,0,o-1);return null===f?null:t&&f instanceof $b&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?t.createPoseWriter(f,_,n):{setValue:function(e){f[_]=e},getValue:function(){return f[_]}}},e}(),hz=Y((uz=fz).prototype,"path",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bz}}),_z=Y(uz.prototype,"proxy",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lz=uz))||lz)||lz,zz=al("cc.animation.Track")((vz=function(){function e(){X(this,"_binding",mz,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=q(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},B(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:Lz,get:function(){return this._binding}}]),e}(),mz=Y((dz=vz).prototype,"_binding",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fz}}),pz=dz))||pz,Uz=al("cc.animation.Channel")((xz=function(){function e(e){this.name="",X(this,"_curve",Sz,this),this._curve=e}return B(e,[{key:"curve",get:function(){return this._curve}}]),e}(),Sz=Y((yz=xz).prototype,"_curve",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),gz=yz))||gz,kz=al("cc.animation.SingleChannelTrack")((bz=function(e){function t(){var t;return X(t=e.call(this)||this,"_channel",Cz,j(t)),t._channel=new Uz(t.createCurve()),t}z(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[Dz]=function(){var e=this._channel.curve;return new Gz(e)},B(t,[{key:"channel",get:function(){return this._channel}}]),t}(zz),Cz=Y((Ez=bz).prototype,"_channel",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Tz=Ez))||Tz,Gz=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),Hz=al("cc.animation.RealTrack")(Az=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t.prototype.createCurve=function(){return new Sf},t}(kz))||Az;function Vz(e){return 0===e.keyFramesCount?void 0:e}var jz,Wz,qz,Xz,Yz,Kz,Qz,Zz,Jz,$z,eU=["X","Y","Z","W"],tU=al("cc.animation.VectorTrack")((Oz=function(e){function t(){var t;X(t=e.call(this)||this,"_channels",Iz,j(t)),X(t,"_nComponents",Pz,j(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new Uz(new Sf);i.name=eU[n],t._channels[n]=i}return t}z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Dz]=function(){switch(this._nComponents){default:case 2:return new nU(Vz(this._channels[0].curve),Vz(this._channels[1].curve));case 3:return new iU(Vz(this._channels[0].curve),Vz(this._channels[1].curve),Vz(this._channels[2].curve));case 4:return new rU(Vz(this._channels[0].curve),Vz(this._channels[1].curve),Vz(this._channels[2].curve),Vz(this._channels[3].curve))}},B(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(zz),Iz=Y((Rz=Oz).prototype,"_channels",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Pz=Y(Rz.prototype,"_nComponents",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),wz=Rz))||wz,nU=function(){function e(e,t){this._result=new Fi,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||Fi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),iU=function(){function e(e,t,n){this._result=new gi,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||gi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),rU=function(){function e(e,t,n,i){this._result=new Gi,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Gi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),oU=al("cc.animation.QuatTrack")(jz=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.createCurve=function(){return new ap},n[Dz]=function(){return new aU(this.channels()[0].curve)},t}(kz))||jz,aU=function(){function e(e){this._result=new bi,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),sU=["Red","Green","Blue","Alpha"],cU=al("cc.animation.ColorTrack")((Yz=function(e){function t(){var t;X(t=e.call(this)||this,"_channels",Xz,j(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new Uz(new Sf);i.name=sU[n],t._channels[n]=i}return t}z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Dz]=function(){return new lU(Vz(this._channels[0].curve),Vz(this._channels[1].curve),Vz(this._channels[2].curve),Vz(this._channels[3].curve))},t}(zz),Xz=Y((qz=Yz).prototype,"_channels",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Wz=qz))||Wz,lU=function(){function e(e,t,n,i){this._result=new mi,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||mi.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),uU=["Width","Height"],hU=al("cc.animation.SizeTrack")((Jz=function(e){function t(){var t;X(t=e.call(this)||this,"_channels",Zz,j(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new Uz(new Sf);i.name=uU[n],t._channels[n]=i}return t}z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Dz]=function(){return new _U(Vz(this._channels[0].curve),Vz(this._channels[1].curve))},t}(zz),Zz=Y((Qz=Jz).prototype,"_channels",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Kz=Qz))||Kz,_U=function(){function e(e,t){this._result=new ji,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),fU=al("cc.animation.ObjectTrack")($z=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t.prototype.createCurve=function(){return new xp},t}(kz))||$z;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:KF,MorphWeightValueProxy:QF,MorphWeightsValueProxy:ZF,MorphWeightsAllValueProxy:JF,Track:zz,TrackPath:Bz,RealTrack:Hz,VectorTrack:tU,QuatTrack:oU,ColorTrack:cU,SizeTrack:hU,ObjectTrack:fU,isPropertyPath:CF,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:XF,ComponentPath:YF,CubicSplineVec2Value:ez,CubicSplineVec3Value:tz,CubicSplineVec4Value:nz,CubicSplineQuatValue:iz,CubicSplineNumberValue:rz}));var pU=Symbol("BakeNodeCurves"),dU=e("SkelAnimDataHub",function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&r.director.root.dataPoolManager.releaseAnimationClip(t);var i=Math.ceil(t.sample*t.duration)+1,o=t.sample;n=t[pU](0,o,i),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}());dU.pool=new Map;var mU=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,o=e.length;r<o;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?SU:Zc}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());r.RatioSampler=mU;var vU=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(t.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=IU(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-n,s=(e-n)/a;if(o&&(s=yU(s,o)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function gU(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function yU(e,t){if("string"==typeof t){var n=af[t];n?e=n(e):w(3906,t)}else Array.isArray(t)&&(e=np(t,e));return e}function SU(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var o=(t=(t-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}vU.Linear=null,r.AnimCurve=vU,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),r.sampleAnimationCurve=gU;var xU,TU,EU,CU,bU,AU,wU,RU,IU=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return $n;if("object"==typeof t&&t.constructor){if(t instanceof bi)return n=new bi,function(e,t,i){return bi.slerp(n,e,t,i)};if(t instanceof $e)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return $n;if("function"==typeof t.lerp)return e}var n}}}(),PU=al("cc.animation.UntypedTrackChannel")((CU=function(e){function t(){var t;return X(t=e.call(this,new Sf)||this,"property",EU,j(t)),t}return z(t,e),t}(Uz),EU=Y((TU=CU).prototype,"property",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xU=TU))||xU,OU=al("cc.animation.UntypedTrack")((RU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_channels",wU,j(t)),t}z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Dz]=function(e){var t=this;if(!e.getValue)throw new Error(O(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(O(3931));case i instanceof Fi:return new nU(n("x"),n("y"));case i instanceof gi:return new iU(n("x"),n("y"),n("z"));case i instanceof Gi:return new rU(n("x"),n("y"),n("z"),n("w"));case i instanceof mi:return new lU(n("r"),n("g"),n("b"),n("a"));case i instanceof ji:return new _U(n("width"),n("height"))}},n.addChannel=function(e){var t=new PU;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new tU;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new cU,h=u.channels(),_=h[0],f=h[1],p=h[2],d=h[3];return n("r",_),n("g",f),n("b",p),n("a",d),n("x",_),n("y",f),n("z",p),n("w",d),u;case"size":}return null},t}(zz),wU=Y((AU=RU).prototype,"_channels",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bU=AU))||bU,DU=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(e,t,n){for(var i,r=new Bz,o=q(t);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof XF?r.toHierarchy(a.path):a instanceof YF?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=n},a=r.map((function(e){var n=new OU;return o(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new NU(s,l.length),f=function(e){o(e,r.modifiers,r.valueAdapter)},p=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return b(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return b(3933),"continue";var d=r.modifiers[0],m=a[r.commonTarget].addChannel(d).curve;p=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void b(3934);var e;if(p)e=p;else{var n=new Hz;f(n),t.push(n),e=n.channel.curve}var i=h?Yl.LINEAR:Yl.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void _.convert(e)}if("object"==typeof u)switch(!0){default:break;case MU(c,Fi):case MU(c,gi):case MU(c,Gi):var r=u instanceof Fi?2:u instanceof gi?3:4,o=new tU;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,d=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?Yl.LINEAR:Yl.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),_.convert(s),d.assignSorted(l,c.map((function(e){return y(e.y)}))),_.convert(d)}return void t.push(o);case MU(c,bi):var S=new oU;f(S);var x=h?Kf.SLERP:Kf.CONSTANT;return S.channel.curve.assignSorted(l,c.map((function(e){return{value:bi.clone(e),interpolationMode:x}}))),_.convertQuatCurve(S.channel.curve),void t.push(S);case MU(c,mi):var T=new cU;f(T);var E=T.channels(),C=E[0].curve,A=E[1].curve,w=E[2].curve,R=E[3].curve,I=h?Yl.LINEAR:Yl.CONSTANT,P=function(e){return{value:e,interpolationMode:I}};return C.assignSorted(l,c.map((function(e){return P(e.r)}))),_.convert(C),A.assignSorted(l,c.map((function(e){return P(e.g)}))),_.convert(A),w.assignSorted(l,c.map((function(e){return P(e.b)}))),_.convert(w),R.assignSorted(l,c.map((function(e){return P(e.a)}))),_.convert(R),void t.push(T);case MU(c,ji):var O=new hU;f(O);var D=O.channels(),M=D[0].curve,N=D[1].curve,L=h?Yl.LINEAR:Yl.CONSTANT,B=function(e){return{value:e,interpolationMode:L}};return M.assignSorted(l,c.map((function(e){return B(e.width)}))),_.convert(M),N.assignSorted(l,c.map((function(e){return B(e.height)}))),_.convert(N),void t.push(O);case MU(c,rz):var F=new Hz;f(F);var z=h?Yl.CUBIC:Yl.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:z}}))),void t.push(F);case MU(c,ez):case MU(c,tz):case MU(c,nz):var U=u instanceof ez?2:u instanceof tz?3:4,k=new tU;f(k),k.componentsCount=U;var G=k.channels(),H=G[0],V=G[1],j=G[2],W=G[3],q=h?Yl.LINEAR:Yl.CONSTANT,X=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:q}};switch(U){case 4:W.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(k);case c.every((function(e){return e instanceof iz})):b(3935)}var Y=new fU;f(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=q(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new mU(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new vU(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},B(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function MU(e,t){return e.every((function(e){return e instanceof t}))}var NU=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,S,x,T,E=this._easingMethods;if(E){var C=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(E)&&E.length;for(var b=C-1,A=0;A<b;++A){var w=E[A];w&&(Array.isArray(w)?(t=w,n=e.getKeyframeTime(A),i=e.getKeyframeValue(A),r=e.getKeyframeTime(A+1),o=e.getKeyframeValue(A+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,p=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,S=void 0,x=void 0,T=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(d=c*f)/(p=s*_),S=Math.sqrt(p*p+d*d)*g,x=v/m,T=Math.sqrt(m*m+v*v)*g,i.interpolationMode=Yl.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===Ql.NONE?Ql.RIGHT:a===Ql.LEFT?Ql.BOTH:a,i.rightTangent=y,i.rightTangentWeight=S,o.tangentWeightMode=function(e){return e===Ql.NONE?Ql.LEFT:e===Ql.RIGHT?Ql.BOTH:e}(o.tangentWeightMode),o.leftTangent=x,o.leftTangentWeight=T):LU(w,e,A))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var o=t[r];o&&(Array.isArray(o)?e.getKeyframeValue(r).easingMethod=o.slice():BU(o,e,r))}}}},B(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function LU(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=_k[e];r===of.CONSTANT?i.interpolationMode=Yl.CONSTANT:(i.interpolationMode=Yl.LINEAR,i.easingMethod=r)}function BU(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=_k[e];i.easingMethod=r}var FU,zU,UU,kU,GU,HU,VU,jU,WU,qU,XU,YU,KU,QU,ZU,JU,$U,ek,tk,nk,ik,rk,ok,ak,sk,ck,lk,uk,hk,_k={constant:of.CONSTANT,linear:of.LINEAR,quadIn:of.QUAD_IN,quadOut:of.QUAD_OUT,quadInOut:of.QUAD_IN_OUT,quadOutIn:of.QUAD_OUT_IN,cubicIn:of.CUBIC_IN,cubicOut:of.CUBIC_OUT,cubicInOut:of.CUBIC_IN_OUT,cubicOutIn:of.CUBIC_OUT_IN,quartIn:of.QUART_IN,quartOut:of.QUART_OUT,quartInOut:of.QUART_IN_OUT,quartOutIn:of.QUART_OUT_IN,quintIn:of.QUINT_IN,quintOut:of.QUINT_OUT,quintInOut:of.QUINT_IN_OUT,quintOutIn:of.QUINT_OUT_IN,sineIn:of.SINE_IN,sineOut:of.SINE_OUT,sineInOut:of.SINE_IN_OUT,sineOutIn:of.SINE_OUT_IN,expoIn:of.EXPO_IN,expoOut:of.EXPO_OUT,expoInOut:of.EXPO_IN_OUT,expoOutIn:of.EXPO_OUT_IN,circIn:of.CIRC_IN,circOut:of.CIRC_OUT,circInOut:of.CIRC_IN_OUT,circOutIn:of.CIRC_OUT_IN,elasticIn:of.ELASTIC_IN,elasticOut:of.ELASTIC_OUT,elasticInOut:of.ELASTIC_IN_OUT,elasticOutIn:of.ELASTIC_OUT_IN,backIn:of.BACK_IN,backOut:of.BACK_OUT,backInOut:of.BACK_IN_OUT,backOutIn:of.BACK_OUT_IN,bounceIn:of.BOUNCE_IN,bounceOut:of.BOUNCE_OUT,bounceInOut:of.BOUNCE_IN_OUT,bounceOutIn:of.BOUNCE_OUT_IN,smooth:of.SMOOTH,fade:of.FADE};function fk(){throw new Error("split() only valid in Editor.")}al("cc.animation.ExoticAnimation")((UU=function(){function e(){X(this,"_nodeAnimations",zU,this)}var t=e.prototype;return t.createEvaluator=function(e){return new Ek(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new pk(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return fk()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),zU=Y((FU=UU).prototype,"_nodeAnimations",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FU));var pk=al("cc.animation.ExoticNodeAnimation")((qU=function(){function e(e){X(this,"_path",HU,this),X(this,"_position",VU,this),X(this,"_rotation",jU,this),X(this,"_scale",WU,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new Sk(e,new gk(t))},t.createRotation=function(e,t){this._rotation=new Sk(e,new yk(t))},t.createScale=function(e,t){this._scale=new Sk(e,new gk(t))},t.createEvaluator=function(e){return new Ck(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return fk()},t.toHashString=function(){var e,t,n,i,r,o;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},B(e,[{key:"path",get:function(){return this._path}}]),e}(),HU=Y((GU=qU).prototype,"_path",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VU=Y(GU.prototype,"_position",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jU=Y(GU.prototype,"_rotation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WU=Y(GU.prototype,"_scale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kU=GU))||kU;function dk(e){return e.toPrecision(2)}function mk(e){return e.map(dk).join(" ")}var vk=al("cc.animation.ExoticVectorLikeTrackValues")((ZU=function(){function e(e){X(this,"_values",KU,this),X(this,"_isQuantized",QU,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=Ak[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),o=Math.max(e,o)}));var a=o-r,s=n.from(e,(function(e){return(e-r)/a*i}));return new Gk(wk(e),s,a,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():mk(t))},B(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:wk(this._values)}}]),e}(),KU=Y((YU=ZU).prototype,"_values",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QU=Y(YU.prototype,"_isQuantized",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XU=YU))||XU,gk=al("cc.animation.ExoticVec3TrackValues")(JU=function(e){function t(){return e.apply(this,arguments)||this}z(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?jk(n,e,t):gi.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(jk(a,e,i),jk(a,t,r)):(gi.fromArray(i,a,3*e),gi.fromArray(r,a,3*t)),gi.lerp(o,i,r,n)},t}(vk))||JU,yk=al("cc.animation.ExoticQuatTrackValues")($U=function(e){function t(){return e.apply(this,arguments)||this}z(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?Wk(n,e,t):bi.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(Wk(a,e,i),Wk(a,t,r)):(bi.fromArray(i,a,4*e),bi.fromArray(r,a,4*t)),bi.slerp(o,i,r,n)},t}(vk))||$U,Sk=al("cc.animation.ExoticTrack")((rk=function(){function e(e,t){X(this,"times",nk,this),X(this,"values",ik,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+mk(e)+"; values: "+t.toHashString()},e}(),nk=Y((tk=rk).prototype,"times",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ik=Y(tk.prototype,"values",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ek=tk))||ek;function xk(e,t){e.length,e.length;var n=0,i=0,r=Zc(e,t);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=e[o],c=e[a];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],o=e[i-1],a=Zn(t,r,o),s=Zn(n,r,o);this._timeOffset=a;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=xk(e,t),o=r.index,a=r.ratio,s=xk(e,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(e,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,p=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,p||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},B(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var Tk,Ek=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),Ck=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=Vk(t.times,t.values,gi,e,"position",r)),n&&(this._rotation=Vk(n.times,n.values,bi,e,"rotation",r)),i&&(this._scale=Vk(i.times,i.values,gi,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),bk=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],o=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>o)n.just=!0,n.index=i-1;else{var a=Zc(e,t);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),Ak={uint8:Uint8Array,uint16:Uint16Array};function wk(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return Tk.FLOAT_32;case 8:return Tk.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(Tk||(Tk={}));var Rk,Ik,Pk,Ok,Dk,Mk,Nk,Lk,Bk,Fk,zk,Uk,kk,Gk=al("cc.animation.QuantizedFloatArray")((hk=function(){function e(e,t,n,i){void 0===i&&(i=0),X(this,"originalPrecision",sk,this),X(this,"min",ck,this),X(this,"extent",lk,this),X(this,"values",uk,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+dk(t)+" "+dk(n)+" "+i.join(" ")},B(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),sk=Y((ak=hk).prototype,"originalPrecision",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ck=Y(ak.prototype,"min",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lk=Y(ak.prototype,"extent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uk=Y(ak.prototype,"values",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ok=ak))||ok;function Hk(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function Vk(e,t,n,i,r,o){var a=new Fz;a.path=(new Bz).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new bk(e,t,n)}:null}function jk(e,t,n){gi.set(n,Hk(e,3*t+0),Hk(e,3*t+1),Hk(e,3*t+2))}function Wk(e,t,n){bi.set(n,Hk(e,4*t+0),Hk(e,4*t+1),Hk(e,4*t+2),Hk(e,4*t+3))}var qk=Symbol("SearchForRootBonePath"),Xk=Symbol("ExoticAnimation"),Yk=e("AnimationClip",al("cc.AnimationClip")((kk=Uk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"sample",Pk,j(t)),X(t,"speed",Ok,j(t)),X(t,"wrapMode",Dk,j(t)),X(t,"enableTrsBlending",Mk,j(t)),X(t,"_duration",Nk,j(t)),X(t,"_hash",Lk,j(t)),t.frameRate=0,X(t,"_tracks",Bk,j(t)),X(t,"_exoticAnimation",Fk,j(t)),t._legacyData=void 0,t._legacyDataDirty=!1,X(t,"_events",zk,j(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}z(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,o=new fU;return o.path=(new Bz).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(o),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new nG(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=r.director.root)||void 0===t?void 0:t.dataPoolManager)&&r.director.root.dataPoolManager.releaseAnimationClip(this),dU.destroy(this),e.prototype.destroy.call(this)},n[pU]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Mi}))};var c=r.reduce((function(e,t){return e[t]=new Zk,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var p=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return tG(n,t.property)}}),void 0),d=0;d<n;++d){var m=e+i*d;p.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Mi.copy(a[g].transforms[d],c[g].globalTransform)}for(var y=0;y<o;++y){var S=r[y];c[S].invalidate()}}return{samples:t,frames:n,joints:a}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof OU){var s=a.upgrade(e);s&&(t.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)Ge.remove(i,n[l]);i.push.apply(i,t)},n[qk]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[Lz]);if(h){var _=u[Dz](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new Kk(a,o,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof $b){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var o=new Qk,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[Lz].parseTrsPath();if(h&&h.node===i){n.push(u);var _=tG(o,h.property);if(_){var f=u[Dz](_);a.push({binding:_,trackEval:f})}}}return new $k(r,this._duration,o,a)}b(3924)}else b(3923)}else w(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[Lz].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,o=t+1;o<n;++o){var a=e[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new DU(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][Lz].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},B(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=Da(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),o=r.length,a=function(e){var o=r[e],a=o.frame/t._duration,s=n.findIndex((function(e){return e===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:Xk,get:function(){return this._exoticAnimation}},{key:Xk,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(Fu),Uk.WrapMode=Wc,Pk=Y((Ik=kk).prototype,"sample",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Ok=Y(Ik.prototype,"speed",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Dk=Y(Ik.prototype,"wrapMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wc.Normal}}),Mk=Y(Ik.prototype,"enableTrsBlending",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Nk=Y(Ik.prototype,"_duration",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lk=Y(Ik.prototype,"_hash",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bk=Y(Ik.prototype,"_tracks",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fk=Y(Ik.prototype,"_exoticAnimation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zk=Y(Ik.prototype,"_events",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rk=Ik))||Rk);r.AnimationClip=Yk;var Kk=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var o=t[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),Qk=function(){function e(){this.position=new gi,this.scale=new gi(1,1,1),this.rotation=new bi,this.eulerAngles=new gi}return e.prototype.getTransform=function(e){Mi.fromRTS(e,this.rotation,this.position,this.scale)},e}(),Zk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new Mi,t}return z(t,e),t.prototype.invalidate=function(){this._dirty=!0},B(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,Mi.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&Mi.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(Qk),Jk=new Mi,$k=function(){function e(e,t,n,i){this._initialTransformCache=new Mi,this._clipEndTransformCache=new Mi,this._startTransformCache=new Mi,this._endTransformCache=new Mi,this._motionTransformCache=new Mi,this._translationMotionCache=new gi,this._rotationMotionCache=new bi,this._scaleMotionCache=new gi,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Mi.toRTS(n,r,i,o),gi.add(i,i,a.position),a.setPosition(i),bi.multiply(r,r,a.rotation),a.setRotation(r),gi.multiply(o,o,a.scale),a.setScale(o)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);eG(n,o,a)}else{Mi.identity(n);var s=function(e,t){eG(Jk,e,t),Mi.multiply(n,n,Jk)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),eG(Jk,h,_);for(var p=0;p<l;++p)Mi.multiply(n,n,Jk);s(h,f)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function eG(e,t,n){Mi.invert(e,t),Mi.multiply(e,n,e)}function tG(e,t){switch(t){default:return;case"position":return{setValue:function(t){gi.copy(e.position,t)}};case"rotation":return{setValue:function(t){bi.copy(e.rotation,t)}};case"scale":return{setValue:function(t){gi.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){gi.copy(e.eulerAngles,t)}}}}var nG=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=rG(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=rG(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var o=this._wrapMode,a=iG(n),s=iG(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((o&jc.PingPong)===jc.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((o&jc.PingPong)===jc.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?r.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},e}();function iG(e){return e-(0|e)==0&&(e-=1),0|e}function rG(e,t){return Zc(t,e)}var oG,aG=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(O(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},B(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),sG=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(oG||(oG={})),Je(oG);var cG=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=Wc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new Qc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=0,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||g("Clip "+t.name+" has zero duration."),i}z(t,e);var n=t.prototype;return n.initialize=function(e,t){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&jc.Loop)===jc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,o,a,s=null!==(i=null!=t?t:null===(o=r.director.getAnimationManager())||void 0===o?void 0:o.blendState)&&void 0!==i?i:null;s&&(this._poseOutput=new sG(s)),this._clipEval=n.createEvaluator({target:e,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||r.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r.director.getAnimationManager().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(oG.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(oG.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(oG.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(oG.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Qc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(oG.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(oG.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(oG.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&jc.PingPong)===jc.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&jc.Reverse)===jc.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new Qc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(e-=n)>0?e/i:-e/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&jc.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){r.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){r.director.getAnimationManager().removeAnimation(this)},B(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&jc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&jc.ShouldWrap,n=(this.wrapMode&jc.Reverse)===jc.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(aG));r.AnimationState=cG;var lG,uG,hG,_G,fG,pG,dG,mG,vG,gG,yG,SG,xG,TG,EG,CG,bG,AG=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:r.director.getAnimationManager(),n}z(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:Jn(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),J(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(aG),wG=function(t){return e({AnimationComponent:t,Animation:t}),t}((lG=al("cc.Animation"),uG=Tl(),hG=cl(99),_G=gl(),fG=Gl([Yk]),pG=wl(),dG=Gl(Yk),mG=wl(),vG=wl(),gG=Gl([Yk]),lG(yG=uG(yG=hG(yG=vl(yG=_G((bG=CG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",xG,j(t)),t._crossFade=new AG,t._nameToState=fe(!0),X(t,"_clips",TG,j(t)),X(t,"_defaultClip",EG,j(t)),t._hasBeenPlayed=!1,t}z(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=fe(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&(this._crossFade.play(),this._crossFade.crossFade(n,t))},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(e){return this.getState(e)},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return $(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void b(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void b(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return t===oG.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===oG.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===oG.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new cG(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(oG.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n._getStateByNameOrDefaultClip=function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}return this._nameToState[e]||null},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];RG(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(oG.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(oG.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},B(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=q(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=q(e);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=e.find((function(e){return RG(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return RG(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(an(rh)),CG.EventType=oG,Y((SG=bG).prototype,"clips",[fG,pG],Object.getOwnPropertyDescriptor(SG.prototype,"clips"),SG.prototype),Y(SG.prototype,"defaultClip",[dG,mG],Object.getOwnPropertyDescriptor(SG.prototype,"defaultClip"),SG.prototype),xG=Y(SG.prototype,"playOnLoad",[_l,vG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TG=Y(SG.prototype,"_clips",[gG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EG=Y(SG.prototype,"_defaultClip",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yG=SG))||yG)||yG)||yG)||yG)||yG));function RG(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}Fn(wG.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return wG.prototype.removeState.call(this,e.name)}}]),r.AnimationComponent=wG,He.setClassAlias(wG,"cc.AnimationComponent");var IG,PG,OG,DG=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new MG(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=new FG,this._nodeBlendStates.set(e,n)),n.refProperty(t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),MG=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},B(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}(),NG=function(e){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=e},LG=function(e){function t(){return e.call(this,new gi)||this}z(t,e);var n=t.prototype;return n.blend=function(e,t){var n=this.blendedValue;1===t?gi.copy(n,e):gi.scaleAndAdd(n,n,e,t),this.blendedWeight+=t},n.reset=function(){this.blendedWeight=0,gi.zero(this.blendedValue)},t}(NG),BG=function(e){function t(){return e.call(this,new bi)||this}z(t,e);var n=t.prototype;return n.blend=function(e,t){if(0!==t){var n=this.blendedValue,i=this.blendedWeight;if(1===t)bi.copy(n,e);else{var r=t/(i+t);bi.slerp(n,n,e,r)}this.blendedWeight+=t}},n.reset=function(){this.blendedWeight=0,bi.identity(this.blendedValue)},t}(NG),FG=function(){function e(){this._properties={}}var t=e.prototype;return t.refProperty=function(e){var t,n,i,r=this._properties;switch(e){default:case"position":case"scale":case"eulerAngles":i=null!==(t=r[e])&&void 0!==t?t:r[e]=new LG;break;case"rotation":i=null!==(n=r[e])&&void 0!==n?n:r[e]=new BG}return++i.refCount,i},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(e.position,1-o.blendedWeight),t=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(e.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(e.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(e.rotation,1-s.blendedWeight),i=s.blendedValue),(i||t||n)&&e.setRTS(i,t,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),_&&c.reset()},B(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),zG=[],UG=new Map;function kG(e,t){for(var n=0,i=Mi.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,zG[n++]=e,e=e.parent}for(;n>0;){e=zG[--n],zG[n]=null;var r=e.node;Mi.fromRTS(e.local,r.rotation,r.position,r.scale),i=Mi.multiply(e.world,i,e.local)}return i}function GG(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(UG.has(o)){i=UG.get(o);break}i={node:e,local:new Mi,world:new Mi,stamp:-1,parent:null},UG.set(o,i),zG[r++]=i,e=e.parent,i=null}for(;r>0;)n=zG[--r],zG[r]=null,n.parent=i,i=n;return i}function HG(e){for(var t=UG.get(e.uuid)||null;t;)UG.delete(t.node.uuid),t=t.parent}var VG=e("AnimationManager",al((OG=PG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new K([]),t._crossFades=new K([]),t._delayEvents=[],t._blendStateBuffer=new DG,t._sockets=[],t}z(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):w(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,i=this._sockets,o=n.array;for(n.i=0;n.i<o.length;++n.i)o[n.i].update(e);var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var c=s[a.i];c.isMotionless||c.update(e)}this._blendStateBuffer.apply();for(var l=r.director.getTotalFrames(),u=0,h=i.length;u<h;u++){var _=i[u],f=_.target,p=_.transform;f.matrix=kG(p,l)}for(var d=0,m=t.length;d<m;d++){var v=t[d];v.fn.apply(v.thisArg,v.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):w(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var o=e.getChildByPath(r.path),a=r.target&&o&&GG(o,e);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){HG(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},B(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(UM),PG.ID="animation",IG=OG))||IG);$M.on(JM.EVENT_INIT,(function(){var e=new VG;$M.registerSystem(VG.ID,e,UM.Priority.HIGH)})),r.AnimationManager=VG;var jG,WG,qG,XG,YG=new Mi;function KG(e,t,n){for(Mi.identity(n);e!==t;)Mi.fromRTS(YG,e.rotation,e.position,e.scale),Mi.multiply(n,YG,n),e=e.parent;return n}r.easing=af;var QG=e("HierachyModifier",al("cc.HierachyModifier")(jG=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(XF))||jG);r.HierachyModifier=QG;var ZG=e("ComponentModifier",al("cc.ComponentModifier")(WG=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(YF))||WG);r.ComponentModifier=ZG;var JG=e("CurveValueAdapter",al("cc.CurveValueAdapter")(qG=function(){function e(){}return e.prototype.forTarget=function(){return{set:function(){}}},e}())||qG);r.CurveValueAdapter=JG;var $G=e("UniformCurveValueAdapter",al("cc.UniformCurveValueAdapter")(XG=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(KF))||XG);function eH(e){return"string"==typeof e}function tH(e){return"number"==typeof e}function nH(e,t){return e instanceof t}r.UniformCurveValueAdapter=$G,r.isPropertyModifier=eH,r.isElementModifier=tH,r.isCustomTargetModifier=nH,r.math=Qi,r.geometry=zp;var iH=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},e}());r.NodePool=iH,r.renderer=py;var rH,oH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&pa){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&da&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},B(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Na);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(rH||(rH={}));var aH=function(){function e(){}return e.setInstance=function(t){e._instance=t},B(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function sH(e,t){switch(e){case Cr.R8:return t.UNSIGNED_BYTE;case Cr.R8SN:return t.BYTE;case Cr.R8UI:return t.UNSIGNED_BYTE;case Cr.R8I:return t.BYTE;case Cr.R16F:return rH.HALF_FLOAT_OES;case Cr.R16UI:return t.UNSIGNED_SHORT;case Cr.R16I:return t.SHORT;case Cr.R32F:return t.FLOAT;case Cr.R32UI:return t.UNSIGNED_INT;case Cr.R32I:return t.INT;case Cr.RG8:return t.UNSIGNED_BYTE;case Cr.RG8SN:return t.BYTE;case Cr.RG8UI:return t.UNSIGNED_BYTE;case Cr.RG8I:return t.BYTE;case Cr.RG16F:return rH.HALF_FLOAT_OES;case Cr.RG16UI:return t.UNSIGNED_SHORT;case Cr.RG16I:return t.SHORT;case Cr.RG32F:return t.FLOAT;case Cr.RG32UI:return t.UNSIGNED_INT;case Cr.RG32I:return t.INT;case Cr.RGB8:case Cr.SRGB8:return t.UNSIGNED_BYTE;case Cr.RGB8SN:return t.BYTE;case Cr.RGB8UI:return t.UNSIGNED_BYTE;case Cr.RGB8I:return t.BYTE;case Cr.RGB16F:return rH.HALF_FLOAT_OES;case Cr.RGB16UI:return t.UNSIGNED_SHORT;case Cr.RGB16I:return t.SHORT;case Cr.RGB32F:return t.FLOAT;case Cr.RGB32UI:return t.UNSIGNED_INT;case Cr.RGB32I:return t.INT;case Cr.BGRA8:case Cr.RGBA8:case Cr.SRGB8_A8:return t.UNSIGNED_BYTE;case Cr.RGBA8SN:return t.BYTE;case Cr.RGBA8UI:return t.UNSIGNED_BYTE;case Cr.RGBA8I:return t.BYTE;case Cr.RGBA16F:return rH.HALF_FLOAT_OES;case Cr.RGBA16UI:return t.UNSIGNED_SHORT;case Cr.RGBA16I:return t.SHORT;case Cr.RGBA32F:return t.FLOAT;case Cr.RGBA32UI:return t.UNSIGNED_INT;case Cr.RGBA32I:return t.INT;case Cr.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Cr.R11G11B10F:return t.FLOAT;case Cr.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Cr.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Cr.RGB10A2:return t.UNSIGNED_BYTE;case Cr.RGB10A2UI:return t.UNSIGNED_INT;case Cr.RGB9E5:return t.UNSIGNED_BYTE;case Cr.DEPTH:return t.UNSIGNED_INT;case Cr.DEPTH_STENCIL:return rH.UNSIGNED_INT_24_8_WEBGL;case Cr.BC1:case Cr.BC1_SRGB:case Cr.BC2:case Cr.BC2_SRGB:case Cr.BC3:case Cr.BC3_SRGB:case Cr.BC4:return t.UNSIGNED_BYTE;case Cr.BC4_SNORM:return t.BYTE;case Cr.BC5:return t.UNSIGNED_BYTE;case Cr.BC5_SNORM:return t.BYTE;case Cr.BC6H_SF16:case Cr.BC6H_UF16:return t.FLOAT;case Cr.BC7:case Cr.BC7_SRGB:case Cr.ETC_RGB8:case Cr.ETC2_RGB8:case Cr.ETC2_SRGB8:case Cr.ETC2_RGB8_A1:case Cr.ETC2_SRGB8_A1:case Cr.EAC_R11:return t.UNSIGNED_BYTE;case Cr.EAC_R11SN:return t.BYTE;case Cr.EAC_RG11:return t.UNSIGNED_BYTE;case Cr.EAC_RG11SN:return t.BYTE;case Cr.PVRTC_RGB2:case Cr.PVRTC_RGBA2:case Cr.PVRTC_RGB4:case Cr.PVRTC_RGBA4:case Cr.PVRTC2_2BPP:case Cr.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Cr.ASTC_RGBA_4X4:case Cr.ASTC_RGBA_5X4:case Cr.ASTC_RGBA_5X5:case Cr.ASTC_RGBA_6X5:case Cr.ASTC_RGBA_6X6:case Cr.ASTC_RGBA_8X5:case Cr.ASTC_RGBA_8X6:case Cr.ASTC_RGBA_8X8:case Cr.ASTC_RGBA_10X5:case Cr.ASTC_RGBA_10X6:case Cr.ASTC_RGBA_10X8:case Cr.ASTC_RGBA_10X10:case Cr.ASTC_RGBA_12X10:case Cr.ASTC_RGBA_12X12:case Cr.ASTC_SRGBA_4X4:case Cr.ASTC_SRGBA_5X4:case Cr.ASTC_SRGBA_5X5:case Cr.ASTC_SRGBA_6X5:case Cr.ASTC_SRGBA_6X6:case Cr.ASTC_SRGBA_8X5:case Cr.ASTC_SRGBA_8X6:case Cr.ASTC_SRGBA_8X8:case Cr.ASTC_SRGBA_10X5:case Cr.ASTC_SRGBA_10X6:case Cr.ASTC_SRGBA_10X8:case Cr.ASTC_SRGBA_10X10:case Cr.ASTC_SRGBA_12X10:case Cr.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function cH(e,t){switch(e){case Ar.BOOL:return t.BOOL;case Ar.BOOL2:return t.BOOL_VEC2;case Ar.BOOL3:return t.BOOL_VEC3;case Ar.BOOL4:return t.BOOL_VEC4;case Ar.INT:return t.INT;case Ar.INT2:return t.INT_VEC2;case Ar.INT3:return t.INT_VEC3;case Ar.INT4:return t.INT_VEC4;case Ar.UINT:return t.UNSIGNED_INT;case Ar.FLOAT:return t.FLOAT;case Ar.FLOAT2:return t.FLOAT_VEC2;case Ar.FLOAT3:return t.FLOAT_VEC3;case Ar.FLOAT4:return t.FLOAT_VEC4;case Ar.MAT2:return t.FLOAT_MAT2;case Ar.MAT3:return t.FLOAT_MAT3;case Ar.MAT4:return t.FLOAT_MAT4;case Ar.SAMPLER2D:return t.SAMPLER_2D;case Ar.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Ar.UNKNOWN}}function lH(e){switch(e){case Ar.BOOL:case Ar.BOOL2:case Ar.BOOL3:case Ar.BOOL4:case Ar.INT:case Ar.INT2:case Ar.INT3:case Ar.INT4:case Ar.UINT:return Int32Array;case Ar.FLOAT:case Ar.FLOAT2:case Ar.FLOAT3:case Ar.FLOAT4:case Ar.MAT2:case Ar.MAT3:case Ar.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function uH(e,t){switch(e){case t.BOOL:return Ar.BOOL;case t.BOOL_VEC2:return Ar.BOOL2;case t.BOOL_VEC3:return Ar.BOOL3;case t.BOOL_VEC4:return Ar.BOOL4;case t.INT:return Ar.INT;case t.INT_VEC2:return Ar.INT2;case t.INT_VEC3:return Ar.INT3;case t.INT_VEC4:return Ar.INT4;case t.UNSIGNED_INT:return Ar.UINT;case t.FLOAT:return Ar.FLOAT;case t.FLOAT_VEC2:return Ar.FLOAT2;case t.FLOAT_VEC3:return Ar.FLOAT3;case t.FLOAT_VEC4:return Ar.FLOAT4;case t.FLOAT_MAT2:return Ar.MAT2;case t.FLOAT_MAT3:return Ar.MAT3;case t.FLOAT_MAT4:return Ar.MAT4;case t.SAMPLER_2D:return Ar.SAMPLER2D;case t.SAMPLER_CUBE:return Ar.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Ar.UNKNOWN}}function hH(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function _H(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}aH._instance=null;var fH,pH=[512,513,514,515,516,517,518,519],dH=[0,7680,7681,7682,7683,5386,34055,34056],mH=[32774,32778,32779,32775,32776],vH=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(fH||(fH={}));var gH=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},yH=function(e){function t(){var t;return(t=e.call(this,fH.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new fo,t.clearFlag=oo.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return z(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(gH),SH=function(e){function t(){var t;return(t=e.call(this,fH.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new ha,t}return z(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(gH),xH=function(e){function t(){var t;return(t=e.call(this,fH.DRAW)||this).drawInfo=new Ro,t}return z(t,e),t.prototype.clear=function(){},t}(gH),TH=function(e){function t(){var t;return(t=e.call(this,fH.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return z(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(gH),EH=function(e){function t(){var t;return(t=e.call(this,fH.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return z(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(gH),CH=function(){function e(){this.cmds=new Xe(1),this.beginRenderPassCmds=new Xe(1),this.bindStatesCmds=new Xe(1),this.drawCmds=new Xe(1),this.updateBufferCmds=new Xe(1),this.copyBufferToTextureCmds=new Xe(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function bH(e,t,n,i,r){if(t.usage&wr.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&wr.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),AH.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),AH.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var AH={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function wH(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=t.colorAttachments[h];if(_.format!==Cr.UNKNOWN)switch(_.loadOp){case jr.LOAD:break;case jr.CLEAR:c.bs.targets[0].blendColorMask!==Hr.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case jr.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Cr.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case jr.LOAD:break;case jr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case jr.DISCARD:}if(fa[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case jr.LOAD:break;case jr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case jr.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==Hr.ALL){var d=(p&Hr.R)!==Hr.NONE,m=(p&Hr.G)!==Hr.NONE,v=(p&Hr.B)!==Hr.NONE,g=(p&Hr.A)!==Hr.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function RH(e,t,n,i,r,o){var a,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,_=!1;if(t&&AH.gpuPipelineState!==t){if(AH.gpuPipelineState=t,AH.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var p=t.rs;if(p){if(u.rs.cullMode!==p.cullMode){switch(p.cullMode){case Jr.NONE:l.disable(l.CULL_FACE);break;case Jr.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Jr.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=p.cullMode}var d=p.isFrontFaceCCW;u.rs.isFrontFaceCCW!==d&&(l.frontFace(d?l.CCW:l.CW),u.rs.isFrontFaceCCW=d),u.rs.depthBias===p.depthBias&&u.rs.depthBiasSlop===p.depthBiasSlop||(l.polygonOffset(p.depthBias,p.depthBiasSlop),u.rs.depthBias=p.depthBias,u.rs.depthBiasSlop=p.depthBiasSlop),u.rs.lineWidth!==p.lineWidth&&(l.lineWidth(p.lineWidth),u.rs.lineWidth=p.lineWidth)}var v=t.dss;v&&(u.dss.depthTest!==v.depthTest&&(v.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=v.depthTest),u.dss.depthWrite!==v.depthWrite&&(l.depthMask(v.depthWrite),u.dss.depthWrite=v.depthWrite),u.dss.depthFunc!==v.depthFunc&&(l.depthFunc(pH[v.depthFunc]),u.dss.depthFunc=v.depthFunc),u.dss.stencilTestFront===v.stencilTestFront&&u.dss.stencilTestBack===v.stencilTestBack||(v.stencilTestFront||v.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=v.stencilTestFront,u.dss.stencilTestBack=v.stencilTestBack),u.dss.stencilFuncFront===v.stencilFuncFront&&u.dss.stencilRefFront===v.stencilRefFront&&u.dss.stencilReadMaskFront===v.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,pH[v.stencilFuncFront],v.stencilRefFront,v.stencilReadMaskFront),u.dss.stencilFuncFront=v.stencilFuncFront,u.dss.stencilRefFront=v.stencilRefFront,u.dss.stencilReadMaskFront=v.stencilReadMaskFront),u.dss.stencilFailOpFront===v.stencilFailOpFront&&u.dss.stencilZFailOpFront===v.stencilZFailOpFront&&u.dss.stencilPassOpFront===v.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,dH[v.stencilFailOpFront],dH[v.stencilZFailOpFront],dH[v.stencilPassOpFront]),u.dss.stencilFailOpFront=v.stencilFailOpFront,u.dss.stencilZFailOpFront=v.stencilZFailOpFront,u.dss.stencilPassOpFront=v.stencilPassOpFront),u.dss.stencilWriteMaskFront!==v.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,v.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=v.stencilWriteMaskFront),u.dss.stencilFuncBack===v.stencilFuncBack&&u.dss.stencilRefBack===v.stencilRefBack&&u.dss.stencilReadMaskBack===v.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,pH[v.stencilFuncBack],v.stencilRefBack,v.stencilReadMaskBack),u.dss.stencilFuncBack=v.stencilFuncBack,u.dss.stencilRefBack=v.stencilRefBack,u.dss.stencilReadMaskBack=v.stencilReadMaskBack),u.dss.stencilFailOpBack===v.stencilFailOpBack&&u.dss.stencilZFailOpBack===v.stencilZFailOpBack&&u.dss.stencilPassOpBack===v.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,dH[v.stencilFailOpBack],dH[v.stencilZFailOpBack],dH[v.stencilPassOpBack]),u.dss.stencilFailOpBack=v.stencilFailOpBack,u.dss.stencilZFailOpBack=v.stencilZFailOpBack,u.dss.stencilPassOpBack=v.stencilPassOpBack),u.dss.stencilWriteMaskBack!==v.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,v.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=v.stencilWriteMaskBack));var g=t.bs;if(g){u.bs.isA2C!==g.isA2C&&(g.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=g.isA2C),u.bs.blendColor.x===g.blendColor.x&&u.bs.blendColor.y===g.blendColor.y&&u.bs.blendColor.z===g.blendColor.z&&u.bs.blendColor.w===g.blendColor.w||(l.blendColor(g.blendColor.x,g.blendColor.y,g.blendColor.z,g.blendColor.w),u.bs.blendColor.x=g.blendColor.x,u.bs.blendColor.y=g.blendColor.y,u.bs.blendColor.z=g.blendColor.z,u.bs.blendColor.w=g.blendColor.w);var y=g.targets[0],S=u.bs.targets[0];S.blend!==y.blend&&(y.blend?l.enable(l.BLEND):l.disable(l.BLEND),S.blend=y.blend),S.blendEq===y.blendEq&&S.blendAlphaEq===y.blendAlphaEq||(l.blendEquationSeparate(mH[y.blendEq],mH[y.blendAlphaEq]),S.blendEq=y.blendEq,S.blendAlphaEq=y.blendAlphaEq),S.blendSrc===y.blendSrc&&S.blendDst===y.blendDst&&S.blendSrcAlpha===y.blendSrcAlpha&&S.blendDstAlpha===y.blendDstAlpha||(l.blendFuncSeparate(vH[y.blendSrc],vH[y.blendDst],vH[y.blendSrcAlpha],vH[y.blendDstAlpha]),S.blendSrc=y.blendSrc,S.blendDst=y.blendDst,S.blendSrcAlpha=y.blendSrcAlpha,S.blendDstAlpha=y.blendDstAlpha),S.blendColorMask!==y.blendColorMask&&(l.colorMask((y.blendColorMask&Hr.R)!==Hr.NONE,(y.blendColorMask&Hr.G)!==Hr.NONE,(y.blendColorMask&Hr.B)!==Hr.NONE,(y.blendColorMask&Hr.A)!==Hr.NONE),S.blendColorMask=y.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var x=h.glBlocks.length,T=t.gpuPipelineLayout.dynamicOffsetIndices,E=0;E<x;E++){var C=h.glBlocks[E],b=i[C.set],A=b&&b.descriptorIndices[C.binding],w=A>=0&&b.gpuDescriptors[A],R=null,I=0;if(w&&w.gpuBuffer){var P=w.gpuBuffer,O=T[C.set],D=O&&O[C.binding];D>=0&&(I=r[D]),"vf32"in P?R=P.vf32:(I+=P.offset,R=P.gpuBuffer.vf32),I>>=2}if(R)for(var M=C.glActiveUniforms.length,N=0;N<M;N++){var L=C.glActiveUniforms[N];switch(L.glType){case l.BOOL:case l.INT:for(var B=0;B<L.array.length;++B){var F=L.offset+I+B;if(R[F]!==L.array[B]){for(var z=B,U=F;z<L.array.length;++z,++U)L.array[z]=R[U];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<L.array.length;++k){var G=L.offset+I+k;if(R[G]!==L.array[k]){for(var H=k,V=G;H<L.array.length;++H,++V)L.array[H]=R[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<L.array.length;++j){var W=L.offset+I+j;if(R[W]!==L.array[j]){for(var q=j,X=W;q<L.array.length;++q,++X)L.array[q]=R[X];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+I+Y;if(R[K]!==L.array[Y]){for(var Q=Y,Z=K;Q<L.array.length;++Q,++Z)L.array[Q]=R[Z];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var J=0;J<L.array.length;++J){var $=L.offset+I+J;if(R[$]!==L.array[J]){for(var ee=J,te=$;ee<L.array.length;++ee,++te)L.array[ee]=R[te];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<L.array.length;++ne){var ie=L.offset+I+ne;if(R[ie]!==L.array[ne]){for(var re=ne,oe=ie;re<L.array.length;++re,++oe)L.array[re]=R[oe];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var ae=0;ae<L.array.length;++ae){var se=L.offset+I+ae;if(R[se]!==L.array[ae]){for(var ce=ae,le=se;ce<L.array.length;++ce,++le)L.array[ce]=R[le];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<L.array.length;++ue){var he=L.offset+I+ue;if(R[he]!==L.array[ue]){for(var _e=ue,fe=he;_e<L.array.length;++_e,++fe)L.array[_e]=R[fe];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var pe=0;pe<L.array.length;++pe){var de=L.offset+I+pe;if(R[de]!==L.array[pe]){for(var me=pe,ve=de;me<L.array.length;++me,++ve)L.array[me]=R[ve];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<L.array.length;++ge){var ye=L.offset+I+ge;if(R[ye]!==L.array[ge]){for(var Se=ge,xe=ye;Se<L.array.length;++Se,++xe)L.array[Se]=R[xe];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var Te=0;Te<L.array.length;++Te){var Ee=L.offset+I+Te;if(R[Ee]!==L.array[Te]){for(var Ce=Te,be=Ee;Ce<L.array.length;++Ce,++be)L.array[Ce]=R[be];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else m("Buffer binding '"+C.name+"' at set "+C.set+" binding "+C.binding+" is not bounded")}for(var Ae=h.glSamplerTextures.length,we=0;we<Ae;we++)for(var Re=h.glSamplerTextures[we],Ie=i[Re.set],Pe=Ie&&Ie.descriptorIndices[Re.binding],Oe=Pe>=0&&Ie.gpuDescriptors[Pe],De=Re.units.length,Me=0;Me<De;Me++){var Ne=Re.units[Me];if(Oe&&Oe.gpuSampler){if(Oe.gpuTexture&&Oe.gpuTexture.size>0){var Le=Oe.gpuTexture,Be=u.glTexUnits[Ne];Be.glTexture!==Le.glTexture&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),Le.glTexture?l.bindTexture(Le.glTarget,Le.glTexture):l.bindTexture(Le.glTarget,e.nullTex2D.gpuTexture.glTexture),Be.glTexture=Le.glTexture);var Fe=Oe.gpuSampler;Le.isPowerOf2?(a=Fe.glWrapS,s=Fe.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Le.isPowerOf2?Le.mipLevel<=1&&(Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Fe.glMinFilter:Fe.glMinFilter===l.LINEAR||Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Le.glWrapS!==a&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_S,a),Le.glWrapS=a),Le.glWrapT!==s&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_T,s),Le.glWrapT=s),Le.glMinFilter!==c&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_MIN_FILTER,c),Le.glMinFilter=c),Le.glMagFilter!==Fe.glMagFilter&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_MAG_FILTER,Fe.glMagFilter),Le.glMagFilter=Fe.glMagFilter)}Oe=Ie.gpuDescriptors[++Pe]}else m("Sampler binding '"+Re.name+"' at set "+Re.set+" binding "+Re.binding+" index "+Me+" is not bounded")}}if(n&&h&&(_||AH.gpuInputAssembler!==n)){AH.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ue=e.extensions.OES_vertex_array_object,ke=n.glVAOs.get(h.glProgram);if(!ke){var Ge;ke=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,ke),Ue.bindVertexArrayOES(ke),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var je=h.glInputs[Ve];Ge=null;for(var We=n.glAttribs.length,qe=0;qe<We;qe++){var Xe=n.glAttribs[qe];if(Xe.name===je.name){Ge=Xe;break}}if(Ge){u.glArrayBuffer!==Ge.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ge.glBuffer),u.glArrayBuffer=Ge.glBuffer);for(var Ye=0;Ye<Ge.componentCount;++Ye){var Ke=je.glLoc+Ye,Qe=Ge.offset+Ge.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,Ge.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==ke&&(Ue.bindVertexArrayOES(ke),u.glVAO=ke)}else{for(var Je=0;Je<e.capabilities.maxVertexAttributes;++Je)u.glCurrentAttribLocs[Je]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var ot=n.glAttribs[rt];if(ot.name===tt.name){nt=ot;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var at=0;at<nt.componentCount;++at){var st=tt.glLoc+at,ct=nt.offset+nt.size*at;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,_t=0;_t<ht;_t++)switch(t.dynamicStates[_t]){case $r.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case $r.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case $r.BLEND_CONSTANTS:var ft=o.blendConstant;u.bs.blendColor.x===ft.x&&u.bs.blendColor.y===ft.y&&u.bs.blendColor.z===ft.z&&u.bs.blendColor.w===ft.w||(l.blendColor(ft.x,ft.y,ft.z,ft.w),u.bs.blendColor.copy(ft));break;case $r.STENCIL_WRITE_MASK:var pt=o.stencilStatesFront,dt=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==pt.writeMask&&(l.stencilMaskSeparate(l.FRONT,pt.writeMask),u.dss.stencilWriteMaskFront=pt.writeMask),u.dss.stencilWriteMaskBack!==dt.writeMask&&(l.stencilMaskSeparate(l.BACK,dt.writeMask),u.dss.stencilWriteMaskBack=dt.writeMask);break;case $r.STENCIL_COMPARE_MASK:var mt=o.stencilStatesFront,vt=o.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,pH[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,pH[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function IH(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=AH.gpuInputAssembler,s=AH.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var f=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,a.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var p=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,a.glIndexType,p)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var PH=new Array(fH.COUNT);function OH(e,t){PH.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=PH[i]++;switch(i){case fH.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];wH(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case fH.BIND_STATES:var a=t.bindStatesCmds.array[r];RH(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case fH.DRAW:IH(e,t.drawCmds.array[r].drawInfo);break;case fH.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];bH(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case fH.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];DH(e,c.buffers,c.gpuTexture,c.regions)}}}function DH(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=fa[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt===rH.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[a++];u?n.glInternalFmt===rH.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Mr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var MH=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=Nn(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),NH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&wr.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new MH,glTarget:0,glBuffer:null},this._usage&wr.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&wr.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),AH.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&wr.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),AH.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&wr.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&wr.INDIRECT||t.usage&wr.TRANSFER_DST||t.usage&wr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(aH.instance,this._gpuBuffer),aH.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),AH.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),AH.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(aH.instance,this._gpuBuffer),aH.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&wr.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),AH.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&wr.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),AH.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&wr.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&wr.INDIRECT||t.usage&wr.TRANSFER_DST||t.usage&wr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(aH.instance,this._gpuBuffer),aH.instance.memoryStatus.bufferSize-=t,aH.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&wr.INDIRECT?0:e.byteLength,bH(aH.instance,this._gpuBuffer,e,0,n))},B(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(ba),LH=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Xe(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),BH=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new LH(yH,1),this.bindStatesCmdPool=new LH(SH,1),this.drawCmdPool=new LH(xH,1),this.updateBufferCmdPool=new LH(TH,1),this.copyBufferToTextureCmdPool=new LH(EH,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),FH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new CH,t._cmdAllocator=new BH,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new ha,t._isStateInvalied=!1,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=aH.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(yH);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(fH.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&eo.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&eo.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&eo.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&eo.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===ro.PRIMARY&&this._isInRenderPass||this._type===ro.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(xH);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(fH.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===ro.PRIMARY&&!this._isInRenderPass||this._type===ro.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(TH),a=0;e.usage&wr.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(fH.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===ro.PRIMARY&&!this._isInRenderPass||this._type===ro.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(EH);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(fH.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(SH);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(fH.BIND_STATES),this._isStateInvalied=!1)},t}(Aa),zH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;++n){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=fa[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(aH.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=aH.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},B(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(Ia),UH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=sH(o.format,n),l=fa[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:fa[o.format].count,stride:s.stride,componentCount:_H(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(aH.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=aH.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next();!i.done;)e.extensions.OES_vertex_array_object.deleteVertexArrayOES(i.value),i=n.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},B(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Ma),kH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&ma)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},B(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(La),GH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},B(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Ba),HH=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],VH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:HH[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},B(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Ha),jH=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){wH(aH.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;IH(aH.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=aH.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=aH.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&wr.INDIRECT?0:t.byteLength,bH(aH.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&DH(aH.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];OH(aH.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){RH(aH.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(FH),WH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Va),qH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},B(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(ja),XH=[10497,33648,33071,33071],YH=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===Br.LINEAR||a===Br.ANISOTROPIC?c===Br.LINEAR||c===Br.ANISOTROPIC?9987:c===Br.POINT?9985:9729:c===Br.LINEAR||c===Br.ANISOTROPIC?9986:c===Br.POINT?9984:9728,o=s===Br.LINEAR||s===Br.ANISOTROPIC?9729:9728;var l=XH[i._info.addressU],u=XH[i._info.addressV],h=XH[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return z(t,e),B(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Wa),KH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Vr.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Vr.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));g("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var p,d=f.name.indexOf("[");p=-1!==d?f.name.substr(0,d):f.name;var m=n.getAttribLocation(t.glProgram,p),v=uH(f.type,n),y=hH(f.type,n);t.glInputs[_]={binding:m,name:p,type:v,stride:y,count:f.size,size:y*f.size,glType:f.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var S=0;S<t.blocks.length;++S){var x=t.blocks[S],T={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};t.glBlocks[S]=T;for(var E=0;E<x.members.length;++E){var C=x.members[E],b=cH(C.type,n),A=hH(b,n),w=A*C.count;T.glUniforms[E]={binding:-1,name:C.name,type:C.type,stride:A,count:C.count,size:w,offset:0,glType:b,glLoc:null,array:null}}}}for(var R=0;R<t.subpassInputs.length;++R){var I=t.subpassInputs[R];t.samplerTextures.push(new Bo(I.set,I.binding,I.name,Ar.SAMPLER2D,I.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var P=0;P<t.samplerTextures.length;++P){var O=t.samplerTextures[P];t.glSamplerTextures[P]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:cH(O.type,n),glLoc:null}}}for(var D=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),M=0;M<D;++M){var N=n.getActiveUniform(t.glProgram,M);if(N&&N.type!==n.SAMPLER_2D&&N.type!==n.SAMPLER_CUBE){var L=n.getUniformLocation(t.glProgram,N.name);if(e.extensions.isLocationActive(L)){var B,F=N.name.indexOf("[");B=-1!==F?N.name.substr(0,F):N.name;for(var z=0;z<t.glBlocks.length;z++)for(var U=t.glBlocks[z],k=0;k<U.glUniforms.length;k++){var G=U.glUniforms[k];if(G.name===B){G.glLoc=L,G.count=N.size,G.size=G.stride*G.count,G.array=new(lH(G.type))(G.size/4),U.glActiveUniforms.push(G);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],j=0;j<V.glUniforms.length;j++){var W=V.glUniforms[j];W.offset=V.size/4,V.size+=W.size}for(var q=[],X=[],Y=e.bindingMappingInfo,K=e.stateCache.texUnitCacheMap,Q=0,Z=0;Z<t.blocks.length;++Z)t.blocks[Z].set===Y.flexibleSet&&Q++;for(var J=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(q.push(t.glSamplerTextures[$]),X.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerOffsets[ee.set]+J;ee.set===Y.flexibleSet&&(ne-=Q),K[ee.name]=ne%e.capabilities.maxTextureUnits,J+=ee.count-1}}if(q.length){for(var ie=[],re=0;re<q.length;++re){var oe=q[re],ae=K[oe.name];if(void 0!==ae){oe.glLoc=X[re];for(var se=0;se<oe.count;++se){for(;ie[ae];)ae=(ae+1)%e.capabilities.maxTextureUnits;oe.units.push(ae),ie[ae]=!0}}}for(var ce=0,le=0;le<q.length;++le){var ue=q[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=X[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var _e=0;_e<q.length;_e++){var fe=q[_e];fe.glUnits=new Int32Array(fe.units),n.uniform1iv(fe.glLoc,fe.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var pe=0;pe<t.glBlocks.length;)t.glBlocks[pe].glActiveUniforms.length?pe++:(t.glBlocks[pe]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}(aH.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),t.glProgram=null}}(aH.instance,this._gpuShader),this._gpuShader=null)},B(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(qa),QH=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new xo,this.scissorRect=new fo(0,0,0,0),this.rs=new Fa,this.dss=new za,this.bs=new ka,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),ZH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=ga(this._width)&&ga(this._height),this._size=Sa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case Cr.A8:return t.ALPHA;case Cr.L8:return t.LUMINANCE;case Cr.LA8:return t.LUMINANCE_ALPHA;case Cr.RGB8:case Cr.RGB16F:case Cr.RGB32F:return t.RGB;case Cr.BGRA8:case Cr.RGBA8:case Cr.SRGB8_A8:case Cr.RGBA16F:case Cr.RGBA32F:return t.RGBA;case Cr.R5G6B5:return t.RGB;case Cr.RGB5A1:case Cr.RGBA4:return t.RGBA;case Cr.DEPTH:return t.DEPTH_COMPONENT;case Cr.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Cr.BC1:return rH.COMPRESSED_RGB_S3TC_DXT1_EXT;case Cr.BC1_ALPHA:return rH.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Cr.BC1_SRGB:return rH.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Cr.BC1_SRGB_ALPHA:return rH.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Cr.BC2:return rH.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Cr.BC2_SRGB:return rH.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Cr.BC3:return rH.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Cr.BC3_SRGB:return rH.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Cr.ETC_RGB8:return rH.COMPRESSED_RGB_ETC1_WEBGL;case Cr.ETC2_RGB8:return rH.COMPRESSED_RGB8_ETC2;case Cr.ETC2_SRGB8:return rH.COMPRESSED_SRGB8_ETC2;case Cr.ETC2_RGB8_A1:return rH.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_SRGB8_A1:return rH.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_RGBA8:return rH.COMPRESSED_RGBA8_ETC2_EAC;case Cr.ETC2_SRGB8_A8:return rH.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Cr.EAC_R11:return rH.COMPRESSED_R11_EAC;case Cr.EAC_R11SN:return rH.COMPRESSED_SIGNED_R11_EAC;case Cr.EAC_RG11:return rH.COMPRESSED_RG11_EAC;case Cr.EAC_RG11SN:return rH.COMPRESSED_SIGNED_RG11_EAC;case Cr.PVRTC_RGB2:return rH.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGBA2:return rH.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGB4:return rH.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Cr.PVRTC_RGBA4:return rH.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Cr.ASTC_RGBA_4X4:return rH.COMPRESSED_RGBA_ASTC_4x4_KHR;case Cr.ASTC_RGBA_5X4:return rH.COMPRESSED_RGBA_ASTC_5x4_KHR;case Cr.ASTC_RGBA_5X5:return rH.COMPRESSED_RGBA_ASTC_5x5_KHR;case Cr.ASTC_RGBA_6X5:return rH.COMPRESSED_RGBA_ASTC_6x5_KHR;case Cr.ASTC_RGBA_6X6:return rH.COMPRESSED_RGBA_ASTC_6x6_KHR;case Cr.ASTC_RGBA_8X5:return rH.COMPRESSED_RGBA_ASTC_8x5_KHR;case Cr.ASTC_RGBA_8X6:return rH.COMPRESSED_RGBA_ASTC_8x6_KHR;case Cr.ASTC_RGBA_8X8:return rH.COMPRESSED_RGBA_ASTC_8x8_KHR;case Cr.ASTC_RGBA_10X5:return rH.COMPRESSED_RGBA_ASTC_10x5_KHR;case Cr.ASTC_RGBA_10X6:return rH.COMPRESSED_RGBA_ASTC_10x6_KHR;case Cr.ASTC_RGBA_10X8:return rH.COMPRESSED_RGBA_ASTC_10x8_KHR;case Cr.ASTC_RGBA_10X10:return rH.COMPRESSED_RGBA_ASTC_10x10_KHR;case Cr.ASTC_RGBA_12X10:return rH.COMPRESSED_RGBA_ASTC_12x10_KHR;case Cr.ASTC_RGBA_12X12:return rH.COMPRESSED_RGBA_ASTC_12x12_KHR;case Cr.ASTC_SRGBA_4X4:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Cr.ASTC_SRGBA_5X4:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Cr.ASTC_SRGBA_5X5:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Cr.ASTC_SRGBA_6X5:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Cr.ASTC_SRGBA_6X6:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Cr.ASTC_SRGBA_8X5:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Cr.ASTC_SRGBA_8X6:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Cr.ASTC_SRGBA_8X8:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Cr.ASTC_SRGBA_10X5:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Cr.ASTC_SRGBA_10X6:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Cr.ASTC_SRGBA_10X8:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Cr.ASTC_SRGBA_10X10:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Cr.ASTC_SRGBA_12X10:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Cr.ASTC_SRGBA_12X12:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=sH(t.format,n);var i=t.width,r=t.height;switch(t.type){case Or.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&w(9100,o,e.capabilities.maxTextureSize),!e.extensions.WEBGL_depth_texture&&fa[t.format].hasDepth)t.glInternalFmt=function(e,t){switch(e){case Cr.R5G6B5:return t.RGB565;case Cr.RGB5A1:return t.RGB5_A1;case Cr.RGBA4:return t.RGBA4;case Cr.RGBA16F:return rH.RGBA16F_EXT;case Cr.RGBA32F:return rH.RGBA32F_EXT;case Cr.SRGB8_A8:return rH.SRGB8_ALPHA8_EXT;case Cr.DEPTH:return t.DEPTH_COMPONENT16;case Cr.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));else if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),fa[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=ya(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;case Or.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&w(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),fa[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=ya(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Or.TEX2D,t.glTarget=n.TEXTURE_2D}}(aH.instance,this._gpuTexture),aH.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){var e,t;this._gpuTexture&&(e=aH.instance,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),aH.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=Sa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Or.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&w(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),fa[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=ya(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Or.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&w(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),fa[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=ya(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Or.TEX2D,t.glTarget=n.TEXTURE_2D}}}(aH.instance,this._gpuTexture),aH.instance.memoryStatus.textureSize-=n,aH.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new Oo;t.format=e.format,t.usage=fa[e.format].hasDepth?Dr.DEPTH_STENCIL_ATTACHMENT:Dr.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},B(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Xa),JH="webglcontextlost";function $H(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function eV(e){var t={EXT_texture_filter_anisotropic:$H(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:$H(e,"EXT_blend_minmax"),EXT_frag_depth:$H(e,"EXT_frag_depth"),EXT_shader_texture_lod:$H(e,"EXT_shader_texture_lod"),EXT_sRGB:$H(e,"EXT_sRGB"),OES_vertex_array_object:$H(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:$H(e,"EXT_color_buffer_half_float"),WEBGL_multi_draw:$H(e,"WEBGL_multi_draw"),WEBGL_color_buffer_float:$H(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:$H(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:$H(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:$H(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:$H(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:$H(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:$H(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:$H(e,"WEBGL_draw_buffers"),WEBGL_lose_context:$H(e,"WEBGL_lose_context"),WEBGL_depth_texture:$H(e,"WEBGL_depth_texture"),OES_texture_half_float:$H(e,"OES_texture_half_float"),OES_texture_half_float_linear:$H(e,"OES_texture_half_float_linear"),OES_texture_float:$H(e,"OES_texture_float"),OES_texture_float_linear:$H(e,"OES_texture_float_linear"),OES_standard_derivatives:$H(e,"OES_standard_derivatives"),OES_element_index_uint:$H(e,"OES_element_index_uint"),ANGLE_instanced_arrays:$H(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:$H(e,"WEBGL_debug_renderer_info"),WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return ph.os===un.IOS&&14===ph.osMainVersion&&ph.isBrowser||(t.WEBGL_compressed_texture_astc=$H(e,"WEBGL_compressed_texture_astc")),ph.browserType===sn.UC&&(t.ANGLE_instanced_arrays=null),ph.os===un.IOS&&ph.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var tV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new QH,t.cmdAllocator=new BH,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(JH,this._onWebGLContextLost);var t=aH.instance.gl;this.stateCache.initialize(aH.instance.capabilities.maxTextureUnits,aH.instance.capabilities.maxVertexAttributes),this._extensions=eV(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=Cr.RGBA8,i=Cr.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=Cr.DEPTH_STENCIL:r&&(i=Cr.DEPTH),this._colorTexture=new ZH,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new ZH,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=aH.instance.createTexture(new Oo(Or.TEX2D,Dr.SAMPLED,Cr.RGBA8,2,2,Mr.GEN_MIPMAP)),this.nullTexCube=aH.instance.createTexture(new Oo(Or.CUBE,Dr.SAMPLED,Cr.RGBA8,2,2,Mr.GEN_MIPMAP,6));var a=new So;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),aH.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,aH.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(JH,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(g("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){b(11e3),d(e)},B(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(Ra),nV=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){aH.setInstance(this),this._gfxAPI=xr.WEBGL,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:et.ENABLE_TRANSPARENT_CANVAS,antialias:et.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(wa.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new aa(no.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new oa(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE);var n=t.getSupportedExtensions(),i="";if(n)for(var r,o=q(n);!(r=o()).done;)i+=r.value+" ";var a=eV(t);a.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[Er.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[Er.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[Er.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[Er.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[Er.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[Er.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[Er.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[Er.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Er.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[Er.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[Er.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[Er.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[Er.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[Er.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[Er.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[Er.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[Er.FORMAT_ASTC]=!0,c+="astc "),g("WebGL device initialized."),g("RENDERER: "+this._renderer),g("VENDOR: "+this._vendor),g("VERSION: "+s),g("COMPRESSED_FORMAT: "+c),g("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===ro.PRIMARY?jH:FH);return t.initialize(e),t},n.createSwapchain=function(e){var t=new tV;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new NH;return t.initialize(e),t},n.createTexture=function(e){var t=new ZH;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new oH;return t.initialize(e),t},n.createShader=function(e){var t=new KH;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new UH;return t.initialize(e),t},n.createRenderPass=function(e){var t=new qH;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new zH;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new kH;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new GH;return t.initialize(e),t},n.createPipelineState=function(e){var t=new VH;return t.initialize(e),t},n.createQueue=function(e){var t=new WH;return t.initialize(e),t},n.getSampler=function(e){var t=Wa.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new YH(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=Ya.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new Ya(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Ka.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Ka(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){DH(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Mr.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},B(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(wa));r.WebGLDevice=nV;var iV,rV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&pa?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&da&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},B(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Na);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(iV||(iV={}));var oV=function(){function e(){}return e.setInstance=function(t){e._instance=t},B(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();oV._instance=null;var aV=[10497,33648,33071,33071],sV=new Float32Array(4);function cV(e,t){switch(e){case Cr.R8:return t.UNSIGNED_BYTE;case Cr.R8SN:return t.BYTE;case Cr.R8UI:return t.UNSIGNED_BYTE;case Cr.R8I:return t.BYTE;case Cr.R16F:return t.HALF_FLOAT;case Cr.R16UI:return t.UNSIGNED_SHORT;case Cr.R16I:return t.SHORT;case Cr.R32F:return t.FLOAT;case Cr.R32UI:return t.UNSIGNED_INT;case Cr.R32I:return t.INT;case Cr.RG8:return t.UNSIGNED_BYTE;case Cr.RG8SN:return t.BYTE;case Cr.RG8UI:return t.UNSIGNED_BYTE;case Cr.RG8I:return t.BYTE;case Cr.RG16F:return t.HALF_FLOAT;case Cr.RG16UI:return t.UNSIGNED_SHORT;case Cr.RG16I:return t.SHORT;case Cr.RG32F:return t.FLOAT;case Cr.RG32UI:return t.UNSIGNED_INT;case Cr.RG32I:return t.INT;case Cr.RGB8:case Cr.SRGB8:return t.UNSIGNED_BYTE;case Cr.RGB8SN:return t.BYTE;case Cr.RGB8UI:return t.UNSIGNED_BYTE;case Cr.RGB8I:return t.BYTE;case Cr.RGB16F:return t.HALF_FLOAT;case Cr.RGB16UI:return t.UNSIGNED_SHORT;case Cr.RGB16I:return t.SHORT;case Cr.RGB32F:return t.FLOAT;case Cr.RGB32UI:return t.UNSIGNED_INT;case Cr.RGB32I:return t.INT;case Cr.BGRA8:case Cr.RGBA8:case Cr.SRGB8_A8:return t.UNSIGNED_BYTE;case Cr.RGBA8SN:return t.BYTE;case Cr.RGBA8UI:return t.UNSIGNED_BYTE;case Cr.RGBA8I:return t.BYTE;case Cr.RGBA16F:return t.HALF_FLOAT;case Cr.RGBA16UI:return t.UNSIGNED_SHORT;case Cr.RGBA16I:return t.SHORT;case Cr.RGBA32F:return t.FLOAT;case Cr.RGBA32UI:return t.UNSIGNED_INT;case Cr.RGBA32I:return t.INT;case Cr.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Cr.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case Cr.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Cr.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Cr.RGB10A2:case Cr.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case Cr.RGB9E5:case Cr.DEPTH:return t.FLOAT;case Cr.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case Cr.BC1:case Cr.BC1_SRGB:case Cr.BC2:case Cr.BC2_SRGB:case Cr.BC3:case Cr.BC3_SRGB:case Cr.BC4:return t.UNSIGNED_BYTE;case Cr.BC4_SNORM:return t.BYTE;case Cr.BC5:return t.UNSIGNED_BYTE;case Cr.BC5_SNORM:return t.BYTE;case Cr.BC6H_SF16:case Cr.BC6H_UF16:return t.FLOAT;case Cr.BC7:case Cr.BC7_SRGB:case Cr.ETC_RGB8:case Cr.ETC2_RGB8:case Cr.ETC2_SRGB8:case Cr.ETC2_RGB8_A1:case Cr.ETC2_SRGB8_A1:case Cr.EAC_R11:return t.UNSIGNED_BYTE;case Cr.EAC_R11SN:return t.BYTE;case Cr.EAC_RG11:return t.UNSIGNED_BYTE;case Cr.EAC_RG11SN:return t.BYTE;case Cr.PVRTC_RGB2:case Cr.PVRTC_RGBA2:case Cr.PVRTC_RGB4:case Cr.PVRTC_RGBA4:case Cr.PVRTC2_2BPP:case Cr.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Cr.ASTC_RGBA_4X4:case Cr.ASTC_RGBA_5X4:case Cr.ASTC_RGBA_5X5:case Cr.ASTC_RGBA_6X5:case Cr.ASTC_RGBA_6X6:case Cr.ASTC_RGBA_8X5:case Cr.ASTC_RGBA_8X6:case Cr.ASTC_RGBA_8X8:case Cr.ASTC_RGBA_10X5:case Cr.ASTC_RGBA_10X6:case Cr.ASTC_RGBA_10X8:case Cr.ASTC_RGBA_10X10:case Cr.ASTC_RGBA_12X10:case Cr.ASTC_RGBA_12X12:case Cr.ASTC_SRGBA_4X4:case Cr.ASTC_SRGBA_5X4:case Cr.ASTC_SRGBA_5X5:case Cr.ASTC_SRGBA_6X5:case Cr.ASTC_SRGBA_6X6:case Cr.ASTC_SRGBA_8X5:case Cr.ASTC_SRGBA_8X6:case Cr.ASTC_SRGBA_8X8:case Cr.ASTC_SRGBA_10X5:case Cr.ASTC_SRGBA_10X6:case Cr.ASTC_SRGBA_10X8:case Cr.ASTC_SRGBA_10X10:case Cr.ASTC_SRGBA_12X10:case Cr.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function lV(e,t){switch(e){case Ar.BOOL:return t.BOOL;case Ar.BOOL2:return t.BOOL_VEC2;case Ar.BOOL3:return t.BOOL_VEC3;case Ar.BOOL4:return t.BOOL_VEC4;case Ar.INT:return t.INT;case Ar.INT2:return t.INT_VEC2;case Ar.INT3:return t.INT_VEC3;case Ar.INT4:return t.INT_VEC4;case Ar.UINT:return t.UNSIGNED_INT;case Ar.FLOAT:return t.FLOAT;case Ar.FLOAT2:return t.FLOAT_VEC2;case Ar.FLOAT3:return t.FLOAT_VEC3;case Ar.FLOAT4:return t.FLOAT_VEC4;case Ar.MAT2:return t.FLOAT_MAT2;case Ar.MAT2X3:return t.FLOAT_MAT2x3;case Ar.MAT2X4:return t.FLOAT_MAT2x4;case Ar.MAT3X2:return t.FLOAT_MAT3x2;case Ar.MAT3:return t.FLOAT_MAT3;case Ar.MAT3X4:return t.FLOAT_MAT3x4;case Ar.MAT4X2:return t.FLOAT_MAT4x2;case Ar.MAT4X3:return t.FLOAT_MAT4x3;case Ar.MAT4:return t.FLOAT_MAT4;case Ar.SAMPLER2D:return t.SAMPLER_2D;case Ar.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case Ar.SAMPLER3D:return t.SAMPLER_3D;case Ar.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Ar.UNKNOWN}}function uV(e,t){switch(e){case t.BOOL:return Ar.BOOL;case t.BOOL_VEC2:return Ar.BOOL2;case t.BOOL_VEC3:return Ar.BOOL3;case t.BOOL_VEC4:return Ar.BOOL4;case t.INT:return Ar.INT;case t.INT_VEC2:return Ar.INT2;case t.INT_VEC3:return Ar.INT3;case t.INT_VEC4:return Ar.INT4;case t.UNSIGNED_INT:return Ar.UINT;case t.UNSIGNED_INT_VEC2:return Ar.UINT2;case t.UNSIGNED_INT_VEC3:return Ar.UINT3;case t.UNSIGNED_INT_VEC4:return Ar.UINT4;case t.FLOAT:return Ar.FLOAT;case t.FLOAT_VEC2:return Ar.FLOAT2;case t.FLOAT_VEC3:return Ar.FLOAT3;case t.FLOAT_VEC4:return Ar.FLOAT4;case t.FLOAT_MAT2:return Ar.MAT2;case t.FLOAT_MAT2x3:return Ar.MAT2X3;case t.FLOAT_MAT2x4:return Ar.MAT2X4;case t.FLOAT_MAT3x2:return Ar.MAT3X2;case t.FLOAT_MAT3:return Ar.MAT3;case t.FLOAT_MAT3x4:return Ar.MAT3X4;case t.FLOAT_MAT4x2:return Ar.MAT4X2;case t.FLOAT_MAT4x3:return Ar.MAT4X3;case t.FLOAT_MAT4:return Ar.MAT4;case t.SAMPLER_2D:return Ar.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return Ar.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return Ar.SAMPLER3D;case t.SAMPLER_CUBE:return Ar.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Ar.UNKNOWN}}function hV(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function _V(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var fV,pV=[512,513,514,515,516,517,518,519],dV=[0,7680,7681,7682,7683,5386,34055,34056],mV=[32774,32778,32779,32775,32776],vV=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(fV||(fV={}));var gV=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},yV=function(e){function t(){var t;return(t=e.call(this,fV.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new fo,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return z(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(gV),SV=function(e){function t(){var t;return(t=e.call(this,fV.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new ha,t}return z(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},t}(gV),xV=function(e){function t(){var t;return(t=e.call(this,fV.DRAW)||this).drawInfo=new Ro,t}return z(t,e),t.prototype.clear=function(){},t}(gV),TV=function(e){function t(){var t;return(t=e.call(this,fV.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return z(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(gV),EV=function(e){function t(){var t;return(t=e.call(this,fV.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return z(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(gV),CV=function(){function e(){this.cmds=new Xe(1),this.beginRenderPassCmds=new Xe(1),this.bindStatesCmds=new Xe(1),this.drawCmds=new Xe(1),this.updateBufferCmds=new Xe(1),this.copyBufferToTextureCmds=new Xe(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function bV(e,t,n,i,r){if(t.usage&wr.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),RV.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),RV.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function AV(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case Cr.A8:return t.ALPHA;case Cr.L8:return t.LUMINANCE;case Cr.LA8:return t.LUMINANCE_ALPHA;case Cr.R8:return t.R8;case Cr.R8SN:return t.R8_SNORM;case Cr.R8UI:return t.R8UI;case Cr.R8I:return t.R8I;case Cr.RG8:return t.RG8;case Cr.RG8SN:return t.RG8_SNORM;case Cr.RG8UI:return t.RG8UI;case Cr.RG8I:return t.RG8I;case Cr.RGB8:return t.RGB8;case Cr.RGB8SN:return t.RGB8_SNORM;case Cr.RGB8UI:return t.RGB8UI;case Cr.RGB8I:return t.RGB8I;case Cr.BGRA8:case Cr.RGBA8:return t.RGBA8;case Cr.RGBA8SN:return t.RGBA8_SNORM;case Cr.RGBA8UI:return t.RGBA8UI;case Cr.RGBA8I:return t.RGBA8I;case Cr.R16I:return t.R16I;case Cr.R16UI:return t.R16UI;case Cr.R16F:return t.R16F;case Cr.RG16I:return t.RG16I;case Cr.RG16UI:return t.RG16UI;case Cr.RG16F:return t.RG16F;case Cr.RGB16I:return t.RGB16I;case Cr.RGB16UI:return t.RGB16UI;case Cr.RGB16F:return t.RGB16F;case Cr.RGBA16I:return t.RGBA16I;case Cr.RGBA16UI:return t.RGBA16UI;case Cr.RGBA16F:return t.RGBA16F;case Cr.R32I:return t.R32I;case Cr.R32UI:return t.R32UI;case Cr.R32F:return t.R32F;case Cr.RG32I:return t.RG32I;case Cr.RG32UI:return t.RG32UI;case Cr.RG32F:return t.RG32F;case Cr.RGB32I:return t.RGB32I;case Cr.RGB32UI:return t.RGB32UI;case Cr.RGB32F:return t.RGB32F;case Cr.RGBA32I:return t.RGBA32I;case Cr.RGBA32UI:return t.RGBA32UI;case Cr.RGBA32F:return t.RGBA32F;case Cr.R5G6B5:return t.RGB565;case Cr.RGB5A1:return t.RGB5_A1;case Cr.RGBA4:return t.RGBA4;case Cr.SRGB8:return t.SRGB8;case Cr.SRGB8_A8:return t.SRGB8_ALPHA8;case Cr.RGB10A2:return t.RGB10_A2;case Cr.RGB10A2UI:return t.RGB10_A2UI;case Cr.R11G11B10F:return t.R11F_G11F_B10F;case Cr.DEPTH:return t.DEPTH_COMPONENT32F;case Cr.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case Cr.BC1:return iV.COMPRESSED_RGB_S3TC_DXT1_EXT;case Cr.BC1_ALPHA:return iV.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Cr.BC1_SRGB:return iV.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Cr.BC1_SRGB_ALPHA:return iV.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Cr.BC2:return iV.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Cr.BC2_SRGB:return iV.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Cr.BC3:return iV.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Cr.BC3_SRGB:return iV.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Cr.ETC_RGB8:return iV.COMPRESSED_RGB_ETC1_WEBGL;case Cr.ETC2_RGB8:return iV.COMPRESSED_RGB8_ETC2;case Cr.ETC2_SRGB8:return iV.COMPRESSED_SRGB8_ETC2;case Cr.ETC2_RGB8_A1:return iV.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_SRGB8_A1:return iV.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_RGBA8:return iV.COMPRESSED_RGBA8_ETC2_EAC;case Cr.ETC2_SRGB8_A8:return iV.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Cr.EAC_R11:return iV.COMPRESSED_R11_EAC;case Cr.EAC_R11SN:return iV.COMPRESSED_SIGNED_R11_EAC;case Cr.EAC_RG11:return iV.COMPRESSED_RG11_EAC;case Cr.EAC_RG11SN:return iV.COMPRESSED_SIGNED_RG11_EAC;case Cr.PVRTC_RGB2:return iV.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGBA2:return iV.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGB4:return iV.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Cr.PVRTC_RGBA4:return iV.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Cr.ASTC_RGBA_4X4:return iV.COMPRESSED_RGBA_ASTC_4x4_KHR;case Cr.ASTC_RGBA_5X4:return iV.COMPRESSED_RGBA_ASTC_5x4_KHR;case Cr.ASTC_RGBA_5X5:return iV.COMPRESSED_RGBA_ASTC_5x5_KHR;case Cr.ASTC_RGBA_6X5:return iV.COMPRESSED_RGBA_ASTC_6x5_KHR;case Cr.ASTC_RGBA_6X6:return iV.COMPRESSED_RGBA_ASTC_6x6_KHR;case Cr.ASTC_RGBA_8X5:return iV.COMPRESSED_RGBA_ASTC_8x5_KHR;case Cr.ASTC_RGBA_8X6:return iV.COMPRESSED_RGBA_ASTC_8x6_KHR;case Cr.ASTC_RGBA_8X8:return iV.COMPRESSED_RGBA_ASTC_8x8_KHR;case Cr.ASTC_RGBA_10X5:return iV.COMPRESSED_RGBA_ASTC_10x5_KHR;case Cr.ASTC_RGBA_10X6:return iV.COMPRESSED_RGBA_ASTC_10x6_KHR;case Cr.ASTC_RGBA_10X8:return iV.COMPRESSED_RGBA_ASTC_10x8_KHR;case Cr.ASTC_RGBA_10X10:return iV.COMPRESSED_RGBA_ASTC_10x10_KHR;case Cr.ASTC_RGBA_12X10:return iV.COMPRESSED_RGBA_ASTC_12x10_KHR;case Cr.ASTC_RGBA_12X12:return iV.COMPRESSED_RGBA_ASTC_12x12_KHR;case Cr.ASTC_SRGBA_4X4:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Cr.ASTC_SRGBA_5X4:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Cr.ASTC_SRGBA_5X5:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Cr.ASTC_SRGBA_6X5:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Cr.ASTC_SRGBA_6X6:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Cr.ASTC_SRGBA_8X5:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Cr.ASTC_SRGBA_8X6:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Cr.ASTC_SRGBA_8X8:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Cr.ASTC_SRGBA_10X5:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Cr.ASTC_SRGBA_10X6:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Cr.ASTC_SRGBA_10X8:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Cr.ASTC_SRGBA_10X10:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Cr.ASTC_SRGBA_12X10:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Cr.ASTC_SRGBA_12X12:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=function(e,t){switch(e){case Cr.A8:return t.ALPHA;case Cr.L8:return t.LUMINANCE;case Cr.LA8:return t.LUMINANCE_ALPHA;case Cr.R8:case Cr.R8SN:return t.RED;case Cr.R8UI:case Cr.R8I:return t.RED;case Cr.RG8:case Cr.RG8SN:case Cr.RG8UI:case Cr.RG8I:return t.RG;case Cr.RGB8:case Cr.RGB8SN:case Cr.RGB8UI:case Cr.RGB8I:return t.RGB;case Cr.BGRA8:case Cr.RGBA8:case Cr.RGBA8SN:case Cr.RGBA8UI:case Cr.RGBA8I:return t.RGBA;case Cr.R16UI:case Cr.R16I:case Cr.R16F:return t.RED;case Cr.RG16UI:case Cr.RG16I:case Cr.RG16F:return t.RG;case Cr.RGB16UI:case Cr.RGB16I:case Cr.RGB16F:return t.RGB;case Cr.RGBA16UI:case Cr.RGBA16I:case Cr.RGBA16F:return t.RGBA;case Cr.R32UI:case Cr.R32I:case Cr.R32F:return t.RED;case Cr.RG32UI:case Cr.RG32I:case Cr.RG32F:return t.RG;case Cr.RGB32UI:case Cr.RGB32I:case Cr.RGB32F:return t.RGB;case Cr.RGBA32UI:case Cr.RGBA32I:case Cr.RGBA32F:case Cr.RGB10A2:return t.RGBA;case Cr.R11G11B10F:case Cr.R5G6B5:return t.RGB;case Cr.RGB5A1:case Cr.RGBA4:return t.RGBA;case Cr.SRGB8:return t.RGB;case Cr.SRGB8_A8:return t.RGBA;case Cr.DEPTH:return t.DEPTH_COMPONENT;case Cr.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Cr.BC1:return iV.COMPRESSED_RGB_S3TC_DXT1_EXT;case Cr.BC1_ALPHA:return iV.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Cr.BC1_SRGB:return iV.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Cr.BC1_SRGB_ALPHA:return iV.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Cr.BC2:return iV.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Cr.BC2_SRGB:return iV.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Cr.BC3:return iV.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Cr.BC3_SRGB:return iV.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Cr.ETC_RGB8:return iV.COMPRESSED_RGB_ETC1_WEBGL;case Cr.ETC2_RGB8:return iV.COMPRESSED_RGB8_ETC2;case Cr.ETC2_SRGB8:return iV.COMPRESSED_SRGB8_ETC2;case Cr.ETC2_RGB8_A1:return iV.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_SRGB8_A1:return iV.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_RGBA8:return iV.COMPRESSED_RGBA8_ETC2_EAC;case Cr.ETC2_SRGB8_A8:return iV.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Cr.EAC_R11:return iV.COMPRESSED_R11_EAC;case Cr.EAC_R11SN:return iV.COMPRESSED_SIGNED_R11_EAC;case Cr.EAC_RG11:return iV.COMPRESSED_RG11_EAC;case Cr.EAC_RG11SN:return iV.COMPRESSED_SIGNED_RG11_EAC;case Cr.PVRTC_RGB2:return iV.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGBA2:return iV.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGB4:return iV.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Cr.PVRTC_RGBA4:return iV.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Cr.ASTC_RGBA_4X4:return iV.COMPRESSED_RGBA_ASTC_4x4_KHR;case Cr.ASTC_RGBA_5X4:return iV.COMPRESSED_RGBA_ASTC_5x4_KHR;case Cr.ASTC_RGBA_5X5:return iV.COMPRESSED_RGBA_ASTC_5x5_KHR;case Cr.ASTC_RGBA_6X5:return iV.COMPRESSED_RGBA_ASTC_6x5_KHR;case Cr.ASTC_RGBA_6X6:return iV.COMPRESSED_RGBA_ASTC_6x6_KHR;case Cr.ASTC_RGBA_8X5:return iV.COMPRESSED_RGBA_ASTC_8x5_KHR;case Cr.ASTC_RGBA_8X6:return iV.COMPRESSED_RGBA_ASTC_8x6_KHR;case Cr.ASTC_RGBA_8X8:return iV.COMPRESSED_RGBA_ASTC_8x8_KHR;case Cr.ASTC_RGBA_10X5:return iV.COMPRESSED_RGBA_ASTC_10x5_KHR;case Cr.ASTC_RGBA_10X6:return iV.COMPRESSED_RGBA_ASTC_10x6_KHR;case Cr.ASTC_RGBA_10X8:return iV.COMPRESSED_RGBA_ASTC_10x8_KHR;case Cr.ASTC_RGBA_10X10:return iV.COMPRESSED_RGBA_ASTC_10x10_KHR;case Cr.ASTC_RGBA_12X10:return iV.COMPRESSED_RGBA_ASTC_12x10_KHR;case Cr.ASTC_RGBA_12X12:return iV.COMPRESSED_RGBA_ASTC_12x12_KHR;case Cr.ASTC_SRGBA_4X4:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Cr.ASTC_SRGBA_5X4:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Cr.ASTC_SRGBA_5X5:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Cr.ASTC_SRGBA_6X5:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Cr.ASTC_SRGBA_6X6:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Cr.ASTC_SRGBA_8X5:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Cr.ASTC_SRGBA_8X6:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Cr.ASTC_SRGBA_8X8:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Cr.ASTC_SRGBA_10X5:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Cr.ASTC_SRGBA_10X6:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Cr.ASTC_SRGBA_10X8:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Cr.ASTC_SRGBA_10X10:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Cr.ASTC_SRGBA_12X10:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Cr.ASTC_SRGBA_12X12:return iV.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=cV(t.format,n);var i=t.width,r=t.height;switch(t.type){case Or.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&w(9100,o,e.capabilities.maxTextureSize),t.samples===Nr.ONE){if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),fa[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=ya(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r)}}else t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Or.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>e.capabilities.maxCubeMapTextureSize&&w(9100,u,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),fa[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){for(var f=ya(t.format,i,r,1),p=new Uint8Array(f),d=0;d<6;++d)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+d,_,t.glInternalFmt,i,r,0,p);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Or.TEX2D,t.glTarget=n.TEXTURE_2D}}function wV(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}var RV={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function IV(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),RV.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==Cr.UNKNOWN)switch(h.loadOp){case jr.LOAD:break;case jr.CLEAR:if(c.bs.targets[0].blendColorMask!==Hr.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)sV[0]=r[u].x,sV[1]=r[u].y,sV[2]=r[u].z,sV[3]=r[u].w,s.clearBufferfv(s.COLOR,u,sV);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case jr.DISCARD:RV.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Cr.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case jr.LOAD:break;case jr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case jr.DISCARD:RV.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(fa[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case jr.LOAD:break;case jr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case jr.DISCARD:RV.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&RV.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,RV.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==Hr.ALL){var p=(f&Hr.R)!==Hr.NONE,d=(f&Hr.G)!==Hr.NONE,m=(f&Hr.B)!==Hr.NONE,v=(f&Hr.A)!==Hr.NONE;s.colorMask(p,d,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function PV(e,t,n,i,r,o){var a=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&RV.gpuPipelineState!==t){if(RV.gpuPipelineState=t,RV.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Jr.NONE:a.disable(a.CULL_FACE);break;case Jr.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case Jr.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}e.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==_&&(a.frontFace(_?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=_),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var f=t.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(a.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(a.depthFunc(pV[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,pV[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,dV[f.stencilFailOpFront],dV[f.stencilZFailOpFront],dV[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,pV[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,dV[f.stencilFailOpBack],dV[f.stencilZFailOpBack],dV[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var p=t.bs;if(p){s.bs.isA2C!==p.isA2C&&(p.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=p.isA2C),s.bs.blendColor.x===p.blendColor.x&&s.bs.blendColor.y===p.blendColor.y&&s.bs.blendColor.z===p.blendColor.z&&s.bs.blendColor.w===p.blendColor.w||(a.blendColor(p.blendColor.x,p.blendColor.y,p.blendColor.z,p.blendColor.w),s.bs.blendColor.x=p.blendColor.x,s.bs.blendColor.y=p.blendColor.y,s.bs.blendColor.z=p.blendColor.z,s.bs.blendColor.w=p.blendColor.w);var d=p.targets[0],v=s.bs.targets[0];v.blend!==d.blend&&(d.blend?a.enable(a.BLEND):a.disable(a.BLEND),v.blend=d.blend),v.blendEq===d.blendEq&&v.blendAlphaEq===d.blendAlphaEq||(a.blendEquationSeparate(mV[d.blendEq],mV[d.blendAlphaEq]),v.blendEq=d.blendEq,v.blendAlphaEq=d.blendAlphaEq),v.blendSrc===d.blendSrc&&v.blendDst===d.blendDst&&v.blendSrcAlpha===d.blendSrcAlpha&&v.blendDstAlpha===d.blendDstAlpha||(a.blendFuncSeparate(vV[d.blendSrc],vV[d.blendDst],vV[d.blendSrcAlpha],vV[d.blendDstAlpha]),v.blendSrc=d.blendSrc,v.blendDst=d.blendDst,v.blendSrcAlpha=d.blendSrcAlpha,v.blendDstAlpha=d.blendDstAlpha),v.blendColorMask!==d.blendColorMask&&(a.colorMask((d.blendColorMask&Hr.R)!==Hr.NONE,(d.blendColorMask&Hr.G)!==Hr.NONE,(d.blendColorMask&Hr.B)!==Hr.NONE,(d.blendColorMask&Hr.A)!==Hr.NONE),v.blendColorMask=d.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var g=c.glBlocks.length,y=t.gpuPipelineLayout.dynamicOffsetIndices,S=0;S<g;S++){var x=c.glBlocks[S],T=i[x.set],E=T&&T.descriptorIndices[x.binding],C=E>=0&&T.gpuDescriptors[E];if(C&&C.gpuBuffer){var b=y[x.set],A=b&&b[x.binding],w=C.gpuBuffer.glOffset;A>=0&&(w+=r[A]),s.glBindUBOs[x.glBinding]===C.gpuBuffer.glBuffer&&s.glBindUBOOffsets[x.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,x.glBinding,C.gpuBuffer.glBuffer,w,C.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,x.glBinding,C.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[x.glBinding]=C.gpuBuffer.glBuffer,s.glBindUBOOffsets[x.glBinding]=w)}else m("Buffer binding '"+x.name+"' at set "+x.set+" binding "+x.binding+" is not bounded")}for(var R=c.glSamplerTextures.length,I=0;I<R;I++)for(var P=c.glSamplerTextures[I],O=i[P.set],D=O&&O.descriptorIndices[P.binding],M=D>=0&&O.gpuDescriptors[D],N=0;N<P.units.length;N++){var L=P.units[N],B=s.glTexUnits[L];if(M&&M.gpuTexture&&M.gpuSampler){if(M.gpuTexture&&M.gpuTexture.size>0){var F=M.gpuTexture;B.glTexture!==F.glTexture&&(s.texUnit!==L&&(a.activeTexture(a.TEXTURE0+L),s.texUnit=L),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,e.nullTex2D.gpuTexture.glTexture),B.glTexture=F.glTexture);var z=M.gpuSampler;s.glSamplerUnits[L]!==z.glSampler&&(a.bindSampler(L,z.glSampler),s.glSamplerUnits[L]=z.glSampler)}M=O.gpuDescriptors[++D]}else m("Sampler binding '"+P.name+"' at set "+P.set+" binding "+P.binding+" index "+N+" is not bounded")}}if(n&&c&&(l||RV.gpuInputAssembler!==n))if(RV.gpuInputAssembler=n,e.extensions.useVAO){var U=n.glVAOs.get(c.glProgram);if(!U){var k;U=a.createVertexArray(),n.glVAOs.set(c.glProgram,U),a.bindVertexArray(U),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var G=0;G<c.glInputs.length;G++){var H=c.glInputs[G];k=null;for(var V=0;V<n.glAttribs.length;V++){var j=n.glAttribs[V];if(j.name===H.name){k=j;break}}if(k){s.glArrayBuffer!==k.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,k.glBuffer),s.glArrayBuffer=k.glBuffer);for(var W=0;W<k.componentCount;++W){var q=H.glLoc+W,X=k.offset+k.size*W;a.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,a.vertexAttribPointer(q,k.count,k.glType,k.isNormalized,k.stride,X),a.vertexAttribDivisor(q,k.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==U&&(a.bindVertexArray(U),s.glVAO=U)}else{for(var K=0;K<e.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var Q=0;Q<c.glInputs.length;Q++){for(var Z=c.glInputs[Q],J=null,$=0;$<n.glAttribs.length;$++){var ee=n.glAttribs[$];if(ee.name===Z.name){J=ee;break}}if(J){s.glArrayBuffer!==J.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,J.glBuffer),s.glArrayBuffer=J.glBuffer);for(var te=0;te<J.componentCount;++te){var ne=Z.glLoc+te,ie=J.offset+J.size*te;!s.glEnabledAttribLocs[ne]&&ne>=0&&(a.enableVertexAttribArray(ne),s.glEnabledAttribLocs[ne]=!0),s.glCurrentAttribLocs[ne]=!0,a.vertexAttribPointer(ne,J.count,J.glType,J.isNormalized,J.stride,ie),a.vertexAttribDivisor(ne,J.isInstanced?1:0)}}}var re=n.gpuIndexBuffer;re&&s.glElementArrayBuffer!==re.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,re.glBuffer),s.glElementArrayBuffer=re.glBuffer);for(var oe=0;oe<e.capabilities.maxVertexAttributes;++oe)s.glEnabledAttribLocs[oe]!==s.glCurrentAttribLocs[oe]&&(a.disableVertexAttribArray(oe),s.glEnabledAttribLocs[oe]=!1)}if(t&&t.dynamicStates.length)for(var ae=t.dynamicStates.length,se=0;se<ae;se++)switch(t.dynamicStates[se]){case $r.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case $r.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case $r.BLEND_CONSTANTS:var ce=o.blendConstant;s.bs.blendColor.x===ce.x&&s.bs.blendColor.y===ce.y&&s.bs.blendColor.z===ce.z&&s.bs.blendColor.w===ce.w||(a.blendColor(ce.x,ce.y,ce.z,ce.w),s.bs.blendColor.copy(ce));break;case $r.STENCIL_WRITE_MASK:var le=o.stencilStatesFront,ue=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==le.writeMask&&(a.stencilMaskSeparate(a.FRONT,le.writeMask),s.dss.stencilWriteMaskFront=le.writeMask),s.dss.stencilWriteMaskBack!==ue.writeMask&&(a.stencilMaskSeparate(a.BACK,ue.writeMask),s.dss.stencilWriteMaskBack=ue.writeMask);break;case $r.STENCIL_COMPARE_MASK:var he=o.stencilStatesFront,_e=o.stencilStatesBack;s.dss.stencilRefFront===he.reference&&s.dss.stencilReadMaskFront===he.compareMask||(a.stencilFuncSeparate(a.FRONT,pV[s.dss.stencilFuncFront],he.reference,he.compareMask),s.dss.stencilRefFront=he.reference,s.dss.stencilReadMaskFront=he.compareMask),s.dss.stencilRefBack===_e.reference&&s.dss.stencilReadMaskBack===_e.compareMask||(a.stencilFuncSeparate(a.BACK,pV[s.dss.stencilFuncBack],_e.reference,_e.compareMask),s.dss.stencilRefBack=_e.reference,s.dss.stencilReadMaskBack=_e.compareMask)}}function OV(e,t){var n=e.gl,i=RV.gpuInputAssembler,r=RV.glPrimitive,o=e.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(t.instanceCount)if(a){if(t.indexCount>0){var h=t.firstIndex*a.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(a){if(t.indexCount>0){var _=t.firstIndex*a.stride;n.drawElements(r,t.indexCount,i.glIndexType,_)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}var DV=new Array(fV.COUNT);function MV(e,t){DV.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=DV[i]++;switch(i){case fV.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];IV(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case fV.BIND_STATES:var a=t.bindStatesCmds.array[r];PV(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case fV.DRAW:OV(e,t.drawCmds.array[r].drawInfo);break;case fV.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];bV(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case fV.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];NV(e,c.buffers,c.gpuTexture,c.regions)}}}function NV(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=fa[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt!==iV.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[a++];u?n.glInternalFmt!==iV.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Mr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var LV=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=Nn(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),BV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new LV,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&wr.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),RV.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&wr.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),RV.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&wr.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&wr.INDIRECT||t.usage&wr.TRANSFER_DST||t.usage&wr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(oV.instance,this._gpuBuffer),oV.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),RV.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),RV.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(oV.instance,this._gpuBuffer),oV.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Pr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&wr.VERTEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),RV.gpuInputAssembler=null,i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&wr.INDEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),RV.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&wr.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&wr.INDIRECT||t.usage&wr.TRANSFER_DST||t.usage&wr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(oV.instance,this._gpuBuffer),oV.instance.memoryStatus.bufferSize-=t,oV.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&wr.INDIRECT?0:e.byteLength,bV(oV.instance,this._gpuBuffer,e,0,n))},B(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(ba),FV=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Xe(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),zV=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new FV(yV,1),this.bindStatesCmdPool=new FV(SV,1),this.drawCmdPool=new FV(xV,1),this.updateBufferCmdPool=new FV(TV,1),this.copyBufferToTextureCmdPool=new FV(EV,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),UV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new CV,t._cmdAllocator=new zV,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new ha,t._isStateInvalied=!1,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=oV.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(yV);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(fV.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&eo.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&eo.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&eo.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&eo.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===ro.PRIMARY&&this._isInRenderPass||this._type===ro.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(xV);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(fV.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===ro.PRIMARY&&!this._isInRenderPass||this._type===ro.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(TV),a=0;e.usage&wr.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(fV.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===ro.PRIMARY&&!this._isInRenderPass||this._type===ro.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(EV);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(fV.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(SV);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(fV.BIND_STATES),this._isStateInvalied=!1},t}(Aa),kV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=fa[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(oV.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=oV.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},B(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(Ia),GV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=cV(o.format,n),l=fa[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:fa[o.format].count,stride:s.stride,componentCount:_V(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(oV.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=oV.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next();!i.done;)e.gl.deleteVertexArray(i.value),i=n.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},B(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Ma),HV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&ma)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},B(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(La),VV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},B(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Ba),jV=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],WV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:jV[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},B(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Ha),qV=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){IV(oV.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;OV(oV.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=oV.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=oV.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&wr.INDIRECT?0:t.byteLength,bV(oV.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&NV(oV.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];MV(oV.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){PV(oV.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(UV),XV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Va),YV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},B(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(ja),KV=function(e){function t(t,n){var i,r,o,a,s;return(i=e.call(this,t,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=oV.instance,o=i._gpuSampler,(s=(a=r.gl).createSampler())&&(o.minFilter===Br.LINEAR||o.minFilter===Br.ANISOTROPIC?o.mipFilter===Br.LINEAR||o.mipFilter===Br.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===Br.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===Br.LINEAR||o.mipFilter===Br.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===Br.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===Br.LINEAR||o.magFilter===Br.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=aV[o.addressU],o.glWrapT=aV[o.addressV],o.glWrapR=aV[o.addressW],o.glSampler=s,a.samplerParameteri(s,a.TEXTURE_MIN_FILTER,o.glMinFilter),a.samplerParameteri(s,a.TEXTURE_MAG_FILTER,o.glMagFilter),a.samplerParameteri(s,a.TEXTURE_WRAP_S,o.glWrapS),a.samplerParameteri(s,a.TEXTURE_WRAP_T,o.glWrapT),a.samplerParameteri(s,a.TEXTURE_WRAP_R,o.glWrapR),a.samplerParameterf(s,a.TEXTURE_MIN_LOD,0),a.samplerParameterf(s,a.TEXTURE_MAX_LOD,1e3)),i}return z(t,e),t.prototype.destroy=function(){var e,t;this._gpuSampler&&(e=oV.instance,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)},B(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Wa),QV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Vr.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Vr.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));g("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var p,d=f.name.indexOf("[");p=-1!==d?f.name.substr(0,d):f.name;var v=n.getAttribLocation(t.glProgram,p),y=uV(f.type,n),S=hV(f.type,n);t.glInputs[_]={name:p,type:y,stride:S,count:f.size,size:S*f.size,glType:f.type,glLoc:v}}}var x,T,E,C,b=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(b){t.glBlocks=new Array(b);for(var A=0;A<b;++A){var w=(x=n.getActiveUniformBlockName(t.glProgram,A)).indexOf("[");-1!==w&&(x=x.substr(0,w)),C=null;for(var R=0;R<t.blocks.length;R++)if(t.blocks[R].name===x){C=t.blocks[R];break}if(C){T=A,E=n.getActiveUniformBlockParameter(t.glProgram,T,n.UNIFORM_BLOCK_DATA_SIZE);var I=C.binding+(e.bindingMappingInfo.bufferOffsets[C.set]||0);n.uniformBlockBinding(t.glProgram,T,I),t.glBlocks[A]={set:C.set,binding:C.binding,idx:T,name:x,size:E,glBinding:I}}else m("Block '"+x+"' does not bound")}}for(var P=0;P<t.subpassInputs.length;++P){var O=t.subpassInputs[P];t.samplerTextures.push(new Bo(O.set,O.binding,O.name,Ar.SAMPLER2D,O.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var D=0;D<t.samplerTextures.length;++D){var M=t.samplerTextures[D];t.glSamplerTextures[D]={set:M.set,binding:M.binding,name:M.name,type:M.type,count:M.count,units:[],glUnits:null,glType:lV(M.type,n),glLoc:null}}}for(var N=[],L=[],B=e.stateCache.texUnitCacheMap,F=0,z=0;z<t.blocks.length;++z)t.blocks[z].set===e.bindingMappingInfo.flexibleSet&&F++;for(var U=0,k=0;k<t.samplerTextures.length;++k){var G=t.samplerTextures[k],H=n.getUniformLocation(t.glProgram,G.name);if(H&&-1!==H.id&&(N.push(t.glSamplerTextures[k]),L.push(H)),void 0===B[G.name]){var V=G.binding+e.bindingMappingInfo.samplerOffsets[G.set]+U;G.set===e.bindingMappingInfo.flexibleSet&&(V-=F),B[G.name]=V%e.capabilities.maxTextureUnits,U+=G.count-1}}if(N.length){for(var j=[],W=0;W<N.length;++W){var q=N[W],X=B[q.name];if(void 0!==X){q.glLoc=L[W];for(var Y=0;Y<q.count;++Y){for(;j[X];)X=(X+1)%e.capabilities.maxTextureUnits;q.units.push(X),j[X]=!0}}}for(var K=0,Q=0;Q<N.length;++Q){var Z=N[Q];if(!Z.glLoc){for(Z.glLoc=L[Q];j[K];)K++;for(var J=0;J<Z.count;++J){for(;j[K];)K=(K+1)%e.capabilities.maxTextureUnits;void 0===B[Z.name]&&(B[Z.name]=K),Z.units.push(K),j[K]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var $=0;$<N.length;$++){var ee=N[$];ee.glUnits=new Int32Array(ee.units),n.uniform1iv(ee.glLoc,ee.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=N}}(oV.instance,this._gpuShader)},n.destroy=function(){var e,t;this._gpuShader&&(e=oV.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)},B(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(qa),ZV=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new xo,this.scissorRect=new fo(0,0,0,0),this.rs=new Fa,this.dss=new za,this.bs=new ka,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},e}(),JV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL2 does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=ga(this._width)&&ga(this._height),this._size=Sa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},AV(oV.instance,this._gpuTexture),oV.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(wV(oV.instance,this._gpuTexture),oV.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=Sa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Or.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&w(9100,o,e.capabilities.maxTextureSize),t.samples===Nr.ONE){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),fa[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=ya(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else wV(e,t),AV(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Or.CUBE:t.type=Or.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>e.capabilities.maxCubeMapTextureSize&&w(9100,u,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),fa[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var f=0;f<t.mipLevel;++f){var p=ya(t.format,i,r,1),d=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,t.glInternalFmt,i,r,0,d),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else wV(e,t),AV(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Or.TEX2D,t.glTarget=n.TEXTURE_2D}}}(oV.instance,this._gpuTexture),oV.instance.memoryStatus.textureSize-=n,oV.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new Oo;t.format=e.format,t.usage=fa[e.format].hasDepth?Dr.DEPTH_STENCIL_ATTACHMENT:Dr.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},B(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Xa),$V="webglcontextlost";function ej(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function tj(e){return{EXT_texture_filter_anisotropic:ej(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:ej(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:ej(e,"EXT_color_buffer_float"),WEBGL_multi_draw:ej(e,"WEBGL_multi_draw"),WEBGL_compressed_texture_etc1:ej(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:ej(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:ej(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:ej(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:ej(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:ej(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:ej(e,"WEBGL_debug_shaders"),WEBGL_lose_context:ej(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:ej(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:ej(e,"OES_texture_half_float_linear"),OES_texture_float_linear:ej(e,"OES_texture_float_linear"),useVAO:!0}}var nj,ij=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new ZV,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener($V,this._onWebGLContextLost);var t=oV.instance.gl;this.stateCache.initialize(oV.instance.capabilities.maxTextureUnits,oV.instance.capabilities.maxUniformBufferBindings,oV.instance.capabilities.maxVertexAttributes),this._extensions=tj(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=Cr.RGBA8,i=Cr.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=Cr.DEPTH_STENCIL:r&&(i=Cr.DEPTH),this._colorTexture=new JV,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new JV,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=oV.instance.createTexture(new Oo(Or.TEX2D,Dr.SAMPLED,Cr.RGBA8,2,2,Mr.NONE)),this.nullTexCube=oV.instance.createTexture(new Oo(Or.CUBE,Dr.SAMPLED,Cr.RGBA8,2,2,Mr.NONE,6));var a=new So;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),oV.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,oV.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener($V,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(g("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){b(11e3),d(e)},B(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(Ra),rj=e("WebGL2Device",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}z(t,e);var n=t.prototype;return n.initialize=function(e){oV.setInstance(this),this._gfxAPI=xr.WEBGL2,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:et.ENABLE_TRANSPARENT_CANVAS,antialias:et.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(wa.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new aa(no.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new oa(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=t.getSupportedExtensions(),i="";if(n)for(var r,o=q(n);!(r=o()).done;)i+=r.value+" ";var a=tj(t);a.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),this._features[Er.TEXTURE_FLOAT]=!0,this._features[Er.TEXTURE_HALF_FLOAT]=!0,this._features[Er.FORMAT_R11G11B10F]=!0,this._features[Er.FORMAT_SRGB]=!0,this._features[Er.FORMAT_RGB8]=!0,this._features[Er.ELEMENT_INDEX_UINT]=!0,this._features[Er.INSTANCED_ARRAYS]=!0,this._features[Er.MULTIPLE_RENDER_TARGETS]=!0,this._features[Er.BLEND_MINMAX]=!0,a.EXT_color_buffer_float&&(this._features[Er.COLOR_FLOAT]=!0,this._features[Er.COLOR_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[Er.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[Er.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[Er.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[Er.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[Er.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[Er.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[Er.FORMAT_ASTC]=!0,c+="astc "),g("WebGL2 device initialized."),g("RENDERER: "+this._renderer),g("VENDOR: "+this._vendor),g("VERSION: "+s),g("COMPRESSED_FORMAT: "+c),g("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===ro.PRIMARY?qV:UV);return t.initialize(e),t},n.createSwapchain=function(e){var t=new ij;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new BV;return t.initialize(e),t},n.createTexture=function(e){var t=new JV;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new rV;return t.initialize(e),t},n.createShader=function(e){var t=new QV;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new GV;return t.initialize(e),t},n.createRenderPass=function(e){var t=new YV;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new kV;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new HV;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new VV;return t.initialize(e),t},n.createPipelineState=function(e){var t=new WV;return t.initialize(e),t},n.createQueue=function(e){var t=new XV;return t.initialize(e),t},n.getSampler=function(e){var t=Wa.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new KV(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=Ya.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new Ya(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Ka.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Ka(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){NV(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Mr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},B(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(wa));r.WebGL2Device=rj,function(e){e[e.positions=lo.ATTR_POSITION]="positions",e[e.normals=lo.ATTR_NORMAL]="normals",e[e.uvs=lo.ATTR_TEX_COORD]="uvs",e[e.colors=lo.ATTR_COLOR]="colors"}(nj||(nj={}));var oj,aj,sj,cj,lj,uj=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer},e}(),hj=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>wd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new fj(this._mesh,i,this._mesh.struct.morph,t):this._subMeshRenderings[i]=new _j(this._mesh,i,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(lo.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(lo.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(lo.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=q(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}},e}(),_j=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[t];this._subMeshMorph=r,vj(e,t,i);var o=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=mj(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(t,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(t,i){for(var r=t.displacements[n],s=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:t,morphTexture:i}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=q(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new dj(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=q(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case lo.ATTR_POSITION:a=Dd;break;case lo.ATTR_NORMAL:a=Ld;break;case lo.ATTR_TANGENT:a=zd;break;default:d("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(wd.BINDING,t.buffer),n.update()},destroy:function(){}}},e}(),fj=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[t];vj(e,t,i),this._attributes=r.attributes.map((function(t,n){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[n].offset,t.displacements[n].count)}}))}}))}return e.prototype.createInstance=function(){return new pj(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},B(e,[{key:"data",get:function(){return this._attributes}}]),e}(),pj=function(){function e(e,t,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new dj(n,0);var i=mj(n,t);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=i.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=e[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,n=q(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case lo.ATTR_POSITION:r=Dd;break;case lo.ATTR_NORMAL:r=Ld;break;case lo.ATTR_TANGENT:r=zd;break;default:d("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(wd.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}(),dj=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(wd.SIZE)),this._remoteBuffer=e.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,wd.SIZE,wd.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(wd.OFFSET_OF_WEIGHTS+4*t,e[t],r.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(wd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,r.sys.isLittleEndian),this._localBuffer.setFloat32(wd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,r.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(wd.OFFSET_OF_VERTICES_COUNT,e,r.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},B(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function mj(e,t){var n,i,r,o;e.hasFeature(Er.TEXTURE_FLOAT)?(n=t,r=16,i=lv.PixelFormat.RGBA32F,o=Float32Array):(n=4*t,r=4,i=lv.PixelFormat.RGBA8888,o=Uint8Array);var a=function(e){e<5&&(e=5);var t=Dn(Nn(e)),n=t>>1;return{width:1<<(1&t?n+1:n),height:1<<n}}(n),s=a.width,c=a.height;return{width:s,height:c,create:function(){var t=new ArrayBuffer(s*c*r),n=new Float32Array(t),a=o===Float32Array?n:new o(t),l=new zm({width:s,height:c,_data:a,_compressed:!1,format:i}),u=new lv;u.setFilters(lv.Filter.NEAREST,lv.Filter.NEAREST),u.setMipFilter(lv.Filter.NONE),u.setWrapMode(lv.WrapMode.CLAMP_TO_EDGE,lv.WrapMode.CLAMP_TO_EDGE,lv.WrapMode.CLAMP_TO_EDGE),u.image=l,u.getGFXTexture()||d("Unexpected: failed to create morph texture?");var h=e.getSampler(u.getSamplerInfo());return{get texture(){return u.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){u.destroy()},updatePixels:function(){u.uploadData(a)}}}}}function vj(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function gj(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var yj=new gi,Sj=new gi,xj=new Uint8Array,Tj=e("Mesh",al("cc.Mesh")((lj=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,X(t,"_struct",sj,j(t)),X(t,"_hash",cj,j(t)),t._data=xj,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t}z(t,e);var n=t.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=r.director.root.device,n=this._createVertexBuffers(t,e),i=[],o=0;o<this._struct.primitives.length;o++){var a=this._struct.primitives[o];if(0!==a.vertexBundelIndices.length){var s=null,c=null;if(a.indexView){var l=a.indexView,u=l.stride,h=l.length;if(4===u&&!t.hasFeature(Er.ELEMENT_INDEX_UINT)){var _=this._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(_>=65536){b(10001,_,65536);continue}u>>=1,h>>=1}s=t.createBuffer(new Ao(wr.INDEX,Pr.DEVICE,h,u)),c=new(gj(l.stride))(e,l.offset,l.count),l.stride!==u&&(c=gj(u).from(c)),s.update(c)}var f=a.vertexBundelIndices.map((function(e){return n[e]})),p=[];if(a.vertexBundelIndices.length>0)for(var d=a.vertexBundelIndices[0],m=this._struct.vertexBundles[d].attributes,v=0;v<m.length;++v){var g=m[v];p[v]=new Vo(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new KA(f,p,a.primitiveMode,s);y.mesh=this,y.subMeshIdx=o,i.push(y)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(e,t){return new hj(e,t)}(this,t))}},n.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(e,t){this.reset({struct:e,data:t})},n.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},n.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new Fc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,lo.ATTR_JOINTS),c=this.readAttribute(a,lo.ATTR_WEIGHTS),l=this.readAttribute(a,lo.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){gi.set(yj,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,p=s[f];if(!(0===c[f]||p>=i.length)){gi.transformMat4(Sj,yj,i[p]),n[p]=!0;var d=t[p];gi.min(d.center,d.center,Sj),gi.max(d.halfExtents,d.halfExtents,Sj)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?Fc.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t},n.merge=function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new gi,r=t&&new bi,o=t&&new Fc;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(gi.add(o.center,a.maxPosition,a.minPosition),gi.multiplyScalar(o.center,o.center,.5),gi.subtract(o.halfExtents,a.maxPosition,a.minPosition),gi.multiplyScalar(o.halfExtents,o.halfExtents,.5),Fc.transform(o,o,t),gi.add(a.maxPosition,o.center,o.halfExtents),gi.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===lo.ATTR_POSITION||l.attributes[u].name===lo.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+Ej(l.attributes,u)),f=Aj(_,h),p=wj(_,h);if(!f||!p)continue;for(var d=l.view.count,m=l.view.stride,v=bj(h),g=0;g<d;g++){var y=g*m,S=y+v,x=S+v;switch(i.set(f(y),f(S),f(x)),l.attributes[u].name){case lo.ATTR_POSITION:i.transformMat4(t);break;case lo.ATTR_NORMAL:gi.transformQuat(i,i,r)}p(y,i.x),p(S,i.y),p(x,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var T,E,C,b,A,w=new uj,R=0,I=0,P=0,O=0,D=0,M=0,N=0,L=0,B=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var U=this._struct.vertexBundles[z],k=e._struct.vertexBundles[z];P=U.view.offset,O=k.view.offset,I=U.view.stride,R=U.view.count+k.view.count,T=new ArrayBuffer(R*I),E=new Uint8Array(T),P+=(C=this._data.subarray(P,P+U.view.length)).length,O+=(b=e._data.subarray(O,O+k.view.length)).length,E.set(C),D=0;for(var G,H=q(U.attributes);!(G=H()).done;){var V=G.value;N=0,B=!1;for(var j,W=q(k.attributes);!(j=W()).done;){var X=j.value;if(V.name===X.name&&V.format===X.format){B=!0;break}N+=fa[X.format].size}if(B){L=fa[V.format].size,M=U.view.length+D;for(var Y=0;Y<k.view.count;++Y){if(A=b.subarray(N,N+L),E.set(A,M),(V.name===lo.ATTR_POSITION||V.name===lo.ATTR_NORMAL)&&t){var K=new Float32Array(E.buffer,M,3);switch(i.set(K[0],K[1],K[2]),V.name){case lo.ATTR_POSITION:i.transformMat4(t);break;case lo.ATTR_NORMAL:gi.transformQuat(i,i,r)}K[0]=i.x,K[1]=i.y,K[2]=i.z}M+=U.view.stride,N+=k.view.stride}}D+=fa[V.format].size}F[z]={attributes:U.attributes,view:{offset:w.getLength(),length:T.byteLength,count:R,stride:I}},w.addBuffer(T)}for(var Q,Z,J,$=0,ee=2,te=0,ne=new Array(this._struct.primitives.length),ie=0;ie<this._struct.primitives.length;++ie){var re=this._struct.primitives[ie],oe=e._struct.primitives[ie];ne[ie]={primitiveMode:re.primitiveMode,vertexBundelIndices:re.vertexBundelIndices};for(var ae,se=q(re.vertexBundelIndices);!(ae=se()).done;){var ce=ae.value;te=Math.max(te,this._struct.vertexBundles[ce].view.count)}if(re.indexView&&oe.indexView){$=re.indexView.count,$+=oe.indexView.count,P=re.indexView.offset,O=oe.indexView.offset,ee=$<256?1:$<65536?2:4;var le=new ArrayBuffer($*ee);if(Q=2===ee?new Uint16Array(le):1===ee?new Uint8Array(le):new Uint32Array(le),Z=2===re.indexView.stride?new Uint16Array(this._data.buffer,P,re.indexView.count):1===re.indexView.stride?new Uint8Array(this._data.buffer,P,re.indexView.count):new Uint32Array(this._data.buffer,P,re.indexView.count),ee===re.indexView.stride)Q.set(Z);else for(var ue=0;ue<re.indexView.count;++ue)Q[ue]=Z[ue];P+=re.indexView.length,J=2===oe.indexView.stride?new Uint16Array(e._data.buffer,O,oe.indexView.count):1===oe.indexView.stride?new Uint8Array(e._data.buffer,O,oe.indexView.count):new Uint32Array(e._data.buffer,O,oe.indexView.count);for(var he=0;he<oe.indexView.count;++he)Q[re.indexView.count+he]=te+J[he];O+=oe.indexView.length,ne[ie].indexView={offset:w.getLength(),length:le.byteLength,count:$,stride:ee},w.setNextAlignment(ee),w.addBuffer(le)}}var _e={vertexBundles:F,primitives:ne,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _e.minPosition&&e._struct.minPosition&&_e.maxPosition&&e._struct.maxPosition&&(t?(gi.add(o.center,e._struct.maxPosition,e._struct.minPosition),gi.multiplyScalar(o.center,o.center,.5),gi.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),gi.multiplyScalar(o.halfExtents,o.halfExtents,.5),Fc.transform(o,o,t),gi.add(i,o.center,o.halfExtents),gi.max(_e.maxPosition,_e.maxPosition,i),gi.subtract(i,o.center,o.halfExtents),gi.min(_e.minPosition,_e.minPosition,i)):(gi.min(_e.minPosition,_e.minPosition,e._struct.minPosition),gi.max(_e.maxPosition,_e.maxPosition,e._struct.maxPosition))),this.reset({struct:_e,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=Ea(fa[o]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+Ej(e.attributes,t)),c=fa[o],l=Aj(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=e.view.stride,f=0;f<r;++f)for(var p=0;p<u;++p)h[u*f+p]=l(_*f+h.BYTES_PER_ELEMENT*p);i=h}}})),i},n.copyAttribute=function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+Ej(e.attributes,t)),u=new DataView(n,r),h=fa[c],_=Aj(l,c),f=wj(u,c);if(_&&f){for(var p=h.count,d=e.view.stride,m=bj(c),v=i,g=m,y=0;y<s;++y)for(var S=0;S<p;++S)f(v*y+g*S,_(d*y+m*S));a=!0}}else a=!0})),a},n.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},n.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?Cr.R8UI:2===n.indexView.stride?Cr.R16UI:Cr.R32UI,o=Aj(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+fa[r].size*a);return!0},n._accessAttribute=function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=q(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new Ao(wr.VERTEX,Pr.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.reset({struct:{vertexBundles:[],primitives:[]},data:xj})},B(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=Da(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(Fu),sj=Y((aj=lj).prototype,"_struct",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),cj=Y(aj.prototype,"_hash",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oj=aj))||oj);function Ej(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=fa[r.format].size}return n}r.Mesh=Tj;var Cj=ph.isLittleEndian;function bj(e){var t=fa[e];return t.size/t.count}function Aj(e,t){var n=fa[t],i=n.size/n.count;switch(n.type){case br.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,Cj)};case 4:return function(t){return e.getUint32(t,Cj)}}break;case br.SNORM:case br.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,Cj)};case 4:return function(t){return e.getInt32(t,Cj)}}break;case br.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,Cj)};case 4:return function(t){return e.getUint32(t,Cj)}}break;case br.FLOAT:return function(t){return e.getFloat32(t,Cj)}}return null}function wj(e,t){var n=fa[t],i=n.size/n.count;switch(n.type){case br.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,Cj)};case 4:return function(t,n){return e.setUint32(t,n,Cj)}}break;case br.SNORM:case br.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,Cj)};case 4:return function(t,n){return e.setInt32(t,n,Cj)}}break;case br.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,Cj)};case 4:return function(t,n){return e.setUint32(t,n,Cj)}}break;case br.FLOAT:return function(t,n){return e.setFloat32(t,n,Cj)}}return null}var Rj=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_NORMAL,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RG32F),new Vo(lo.ATTR_TANGENT,Cr.RGBA32F),new Vo(lo.ATTR_COLOR,Cr.RGBA32F)],Ij=new gi;function Pj(e,t,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=q(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===lo.ATTR_POSITION){i=h;break}}i||(i=Rj[0]),r.push(i);var _=fa[i.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:i}),o+=_.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var f,p=q(e.attributes);!(f=p()).done;){var d=f.value;if(d.name===lo.ATTR_NORMAL){i=d;break}}i||(i=Rj[1]);var m=fa[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,g=q(e.attributes);!(v=g()).done;){var y=v.value;if(y.name===lo.ATTR_TEX_COORD){i=y;break}}i||(i=Rj[2]);var S=fa[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/S.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=S.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var x,T=q(e.attributes);!(x=T()).done;){var E=x.value;if(E.name===lo.ATTR_TANGENT){i=E;break}}i||(i=Rj[3]);var C=fa[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/C.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=C.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var b,A=q(e.attributes);!(b=A()).done;){var w=b.value;if(w.name===lo.ATTR_COLOR){i=w;break}}i||(i=Rj[4]);var R=fa[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/R.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=R.size}if(e.customAttributes)for(var I,P=q(e.customAttributes);!(I=P()).done;){var O=I.value,D=fa[O.attr.format];r.push(O.attr),s=Math.max(s,Math.floor(O.values.length/D.count)),a.push({offset:o,data:O.values,attribute:O.attr}),o+=D.size}for(var M=new uj,N=new ArrayBuffer(s*o),L=new DataView(N),B=0,F=a;B<F.length;B++){var z=F[B];jA(L,z.data,z.attribute.format,z.offset,o)}M.setNextAlignment(0);var U={attributes:r,view:{offset:M.getLength(),length:N.byteLength,count:s,stride:o}};M.addBuffer(N);var k=null,G=0;if(e.indices){var H=e.indices;G=H.length,k=new ArrayBuffer(2*G),jA(new DataView(k),H,Cr.R16UI)}var V={primitiveMode:e.primitiveMode||Kr.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(M.setNextAlignment(2),V.indexView={offset:M.getLength(),length:k.byteLength,count:G,stride:2},M.addBuffer(k));var j=e.minPos;if(!j&&n.calculateBounds){j=gi.set(new gi,1/0,1/0,1/0);for(var W=0;W<s;++W)gi.set(Ij,c[3*W+0],c[3*W+1],c[3*W+2]),gi.min(j,j,Ij)}var X=e.maxPos;if(!X&&n.calculateBounds){X=gi.set(new gi,-1/0,-1/0,-1/0);for(var Y=0;Y<s;++Y)gi.set(Ij,c[3*Y+0],c[3*Y+1],c[3*Y+2]),gi.max(X,X,Ij)}var K={vertexBundles:[U],primitives:[V]};return j&&(K.minPosition=new gi(j.x,j.y,j.z)),X&&(K.maxPosition=new gi(X.x,X.y,X.z)),t||(t=new Tj),t.reset({struct:K,data:new Uint8Array(M.getCombined())}),t}var Oj=Object.freeze({__proto__:null,find:DO,toPPM:function(e,t,n){return"P3 "+t+" "+n+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:function(e,t){void 0===t&&(t=0);for(var n,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),o=e.struct,a=o.primitives[t],s=q(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,_=u.view,f=_.length,p=_.stride,d=q(u.attributes);!(c=d()).done;){var m=c.value,v=nj[m.name];v&&(i[v]=(i[v]||[]).concat(WA(r,m.format,h,f,p))),h+=fa[m.format].size}var g=a.indexView;return i.indices=WA(r,Cr["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:Pj,readBuffer:WA,writeBuffer:jA,mapBuffer:qA});e("utils",Oj);var Dj,Mj,Nj,Lj,Bj,Fj,zj,Uj,kj,Gj,Hj,Vj,jj,Wj,qj,Xj,Yj,Kj,Qj,Zj,Jj,$j,eW,tW,nW,iW,rW,oW,aW,sW,cW,lW,uW,hW,_W,fW,pW,dW,mW,vW,gW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}z(t,e);var n=t.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):null},n.initSubModel=function(t,n,i){return e.prototype.initSubModel.call(this,t,n,this._launderMaterial(i))},n.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(t,n){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(n))},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,n)},n._launderMaterial=function(e){return e},n.setMorphRendering=function(e){this._morphRenderingInstance=e},t}(og),yW=Ke({OFF:0,ON:1}),SW=Ke({OFF:0,ON:1}),xW=(Dj=al("cc.ModelLightmapSettings"),Mj=fl("_recieveShadow"),Dj((Hj=function(){function e(){X(this,"texture",Bj,this),X(this,"uvParam",Fj,this),X(this,"_bakeable",zj,this),X(this,"_castShadow",Uj,this),X(this,"_receiveShadow",kj,this),X(this,"_lightmapSize",Gj,this)}return B(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),Bj=Y((Lj=Hj).prototype,"texture",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fj=Y(Lj.prototype,"uvParam",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi}}),zj=Y(Lj.prototype,"_bakeable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uj=Y(Lj.prototype,"_castShadow",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kj=Y(Lj.prototype,"_receiveShadow",[Mj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gj=Y(Lj.prototype,"_lightmapSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Y(Lj.prototype,"bakeable",[El],Object.getOwnPropertyDescriptor(Lj.prototype,"bakeable"),Lj.prototype),Y(Lj.prototype,"castShadow",[El],Object.getOwnPropertyDescriptor(Lj.prototype,"castShadow"),Lj.prototype),Y(Lj.prototype,"receiveShadow",[El],Object.getOwnPropertyDescriptor(Lj.prototype,"receiveShadow"),Lj.prototype),Y(Lj.prototype,"lightmapSize",[El],Object.getOwnPropertyDescriptor(Lj.prototype,"lightmapSize"),Lj.prototype),Nj=Lj))||Nj),TW=function(t){return e({MeshRenderer:t,ModelComponent:t}),t}((Vj=al("cc.MeshRenderer"),jj=Tl(),Wj=cl(100),qj=gl(),Xj=Gl(yW),Yj=wl(),Kj=Gl(SW),Qj=wl(),Zj=Gl(Tj),Jj=wl(),$j=Cl(),Vj(eW=jj(eW=Wj(eW=qj(eW=vl((cW=sW=function(e){function t(){var t;return X(t=e.call(this)||this,"lightmapSettings",nW,j(t)),X(t,"_mesh",iW,j(t)),X(t,"_shadowCastingMode",rW,j(t)),X(t,"_shadowReceivingMode",oW,j(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,X(t,"_enableMorph",aW,j(t)),t._modelType=og,t}z(t,e);var n=t.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(r.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]},n.setWeights=function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},n.setWeight=function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}},n.setInstancedAttribute=function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===e){r[o].set(t);break}},n._updateLightmap=function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===og?gW:this._modelType,t=this._model=r.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof gW&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=ng.POSITION,this._model.transform.hasChangedFlags|=ng.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return Hv.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===yW.OFF?this._model.castShadow=!1:(this._shadowCastingMode,yW.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===SW.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof gW&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,o=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},B(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),t}(EF),sW.ShadowCastingMode=yW,sW.ShadowReceivingMode=SW,nW=Y((tW=cW).prototype,"lightmapSettings",[_l,El,Bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xW}}),iW=Y(tW.prototype,"_mesh",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rW=Y(tW.prototype,"_shadowCastingMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yW.OFF}}),oW=Y(tW.prototype,"_shadowReceivingMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SW.ON}}),Y(tW.prototype,"shadowCastingMode",[Xj,Yj,Bl],Object.getOwnPropertyDescriptor(tW.prototype,"shadowCastingMode"),tW.prototype),Y(tW.prototype,"receiveShadow",[Kj,Qj,Bl],Object.getOwnPropertyDescriptor(tW.prototype,"receiveShadow"),tW.prototype),Y(tW.prototype,"mesh",[Zj,Jj],Object.getOwnPropertyDescriptor(tW.prototype,"mesh"),tW.prototype),Y(tW.prototype,"enableMorph",[$j,Bl],Object.getOwnPropertyDescriptor(tW.prototype,"enableMorph"),tW.prototype),aW=Y(tW.prototype,"_enableMorph",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eW=tW))||eW)||eW)||eW)||eW)||eW));function EW(e,t){var n=e.sharedMaterials.length;if(n!==t.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(e.getRenderMaterial(i)!==t.getRenderMaterial(i))return!1;return!0}e("BatchingUtility",function(){function e(){}return e.batchStaticModel=function(e,t){var n=e.getComponentsInChildren(TW);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!EW(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new Tj,o=new Mi,a=new Mi;e.getWorldMatrix(a),Mi.invert(a,a);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(o),Mi.multiply(o,a,o),r.merge(n[s].mesh,o),c.enabled=!1}var l=t.addComponent(TW);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var n=e.getComponentsInChildren(TW),i=0;i<n.length;i++)n[i].enabled=!0;var r=t.getComponent(TW);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}()),Fn(Tj.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),zn(Tj.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var CW,bW,AW,wW,RW,IW,PW,OW,DW,MW,NW,LW,BW,FW,zW,UW,kW,GW,HW,VW,jW,WW=e("Skeleton",(lW=al("cc.Skeleton"),uW=Gl([bt]),hW=Gl([Mi]),lW((vW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_joints",pW,j(t)),X(t,"_bindposes",dW,j(t)),X(t,"_hash",mW,j(t)),t._invBindposes=null,t}z(t,e);var n=t.prototype;return n.destroy=function(){var t,n;return null===(t=null===(n=r.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===t||t.releaseSkeleton(this),e.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},B(t,[{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new Mi;Mi.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=Da(e,666)}return this._hash}}]),t}(Fu),pW=Y((fW=vW).prototype,"_joints",[uW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dW=Y(fW.prototype,"_bindposes",[hW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mW=Y(fW.prototype,"_hash",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_W=fW))||_W));r.Skeleton=WW,zn(TW.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),r.ModelComponent=TW,He.setClassAlias(TW,"cc.ModelComponent");var qW,XW,YW,KW,QW,ZW,JW,$W,eq,tq,nq,iq,rq,oq,aq,sq,cq,lq,uq,hq,_q,fq,pq,dq,mq,vq,gq,yq,Sq,xq,Tq,Eq,Cq,bq,Aq,wq,Rq,Iq,Pq,Oq,Dq,Mq,Nq,Lq,Bq,Fq,zq,Uq,kq,Gq=Ke({LUMINOUS_FLUX:0,LUMINANCE:1}),Hq=new gi,Vq=al("cc.StaticLightSettings")((PW=function(){function e(){X(this,"_baked",AW,this),X(this,"_editorOnly",wW,this),X(this,"_bakeable",RW,this),X(this,"_castShadow",IW,this)}return B(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),AW=Y((bW=PW).prototype,"_baked",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wW=Y(bW.prototype,"_editorOnly",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RW=Y(bW.prototype,"_bakeable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IW=Y(bW.prototype,"_castShadow",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(bW.prototype,"editorOnly",[El],Object.getOwnPropertyDescriptor(bW.prototype,"editorOnly"),bW.prototype),Y(bW.prototype,"bakeable",[El],Object.getOwnPropertyDescriptor(bW.prototype,"bakeable"),bW.prototype),Y(bW.prototype,"castShadow",[El],Object.getOwnPropertyDescriptor(bW.prototype,"castShadow"),bW.prototype),CW=bW))||CW,jq=function(t){return e({Light:t,LightComponent:t}),t}((OW=al("cc.Light"),DW=wl(),MW=wl(),NW=Rl(),LW=wl(),BW=Gl(Vq),OW((jW=VW=function(e){function t(){var t;return X(t=e.call(this)||this,"_color",UW,j(t)),X(t,"_useColorTemperature",kW,j(t)),X(t,"_colorTemperature",GW,j(t)),X(t,"_staticSettings",HW,j(t)),t._type=kg.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=jg,t}z(t,e);var n=t.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=r.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(r.director.root.destroyLight(this),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case kg.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case kg.SPHERE:e.addSphereLight(this._light);break;case kg.SPOT:e.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case kg.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case kg.SPHERE:e.removeSphereLight(this._light);break;case kg.SPOT:e.removeSpotLight(this._light)}}},B(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(Hq.x=e.r/255,Hq.y=e.g/255,Hq.z=e.b/255,this._light.color=Hq)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}}]),t}(rh),VW.Type=kg,VW.PhotometricTerm=Gq,UW=Y((zW=jW).prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),kW=Y(zW.prototype,"_useColorTemperature",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GW=Y(zW.prototype,"_colorTemperature",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),HW=Y(zW.prototype,"_staticSettings",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vq}}),Y(zW.prototype,"color",[DW],Object.getOwnPropertyDescriptor(zW.prototype,"color"),zW.prototype),Y(zW.prototype,"useColorTemperature",[MW],Object.getOwnPropertyDescriptor(zW.prototype,"useColorTemperature"),zW.prototype),Y(zW.prototype,"colorTemperature",[Dl,NW,LW],Object.getOwnPropertyDescriptor(zW.prototype,"colorTemperature"),zW.prototype),Y(zW.prototype,"staticSettings",[BW],Object.getOwnPropertyDescriptor(zW.prototype,"staticSettings"),zW.prototype),FW=zW))||FW)),Wq=function(t){return e({DirectionalLight:t,DirectionalLightComponent:t}),t}((qW=al("cc.DirectionalLight"),XW=Tl(),YW=gl(),KW=fl("_illuminance"),QW=wl(),qW(ZW=XW(ZW=YW(ZW=vl((tq=function(e){function t(){var t;return X(t=e.call(this)||this,"_illuminanceHDR",$W,j(t)),X(t,"_illuminanceLDR",eq,j(t)),t._type=kg.DIRECTIONAL,t._light=null,t._lightType=Xg,t}return z(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*Em.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},B(t,[{key:"illuminance",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),t}(jq),$W=Y((JW=tq).prototype,"_illuminanceHDR",[ul,KW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),eq=Y(JW.prototype,"_illuminanceLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Y(JW.prototype,"illuminance",[QW],Object.getOwnPropertyDescriptor(JW.prototype,"illuminance"),JW.prototype),ZW=JW))||ZW)||ZW)||ZW)||ZW)),qq=function(t){return e({SphereLight:t,SphereLightComponent:t}),t}((nq=al("cc.SphereLight"),iq=Tl(),rq=gl(),oq=fl("_luminance"),aq=wl(),sq=wl(),cq=Gl(Gq),lq=wl(),uq=wl(),hq=wl(),nq(_q=iq(_q=rq(_q=vl((yq=function(e){function t(){var t;return X(t=e.call(this)||this,"_size",pq,j(t)),X(t,"_luminanceHDR",dq,j(t)),X(t,"_luminanceLDR",mq,j(t)),X(t,"_term",vq,j(t)),X(t,"_range",gq,j(t)),t._type=kg.SPHERE,t._light=null,t._lightType=ty,t}return z(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,r.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*Em.standardExposureValue*Em.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/Em.standardExposureValue/Em.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},B(t,[{key:"luminousFlux",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Vg(this._size):this._luminanceLDR},set:function(e){var t=0;r.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Vg(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(jq),pq=Y((fq=yq).prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),dq=Y(fq.prototype,"_luminanceHDR",[_l,oq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Vg(.15)}}),mq=Y(fq.prototype,"_luminanceLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),vq=Y(fq.prototype,"_term",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gq.LUMINOUS_FLUX}}),gq=Y(fq.prototype,"_range",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Y(fq.prototype,"luminousFlux",[aq],Object.getOwnPropertyDescriptor(fq.prototype,"luminousFlux"),fq.prototype),Y(fq.prototype,"luminance",[sq],Object.getOwnPropertyDescriptor(fq.prototype,"luminance"),fq.prototype),Y(fq.prototype,"term",[cq,lq],Object.getOwnPropertyDescriptor(fq.prototype,"term"),fq.prototype),Y(fq.prototype,"size",[uq],Object.getOwnPropertyDescriptor(fq.prototype,"size"),fq.prototype),Y(fq.prototype,"range",[hq],Object.getOwnPropertyDescriptor(fq.prototype,"range"),fq.prototype),_q=fq))||_q)||_q)||_q)||_q)),Xq=function(t){return e({SpotLight:t,SpotLightComponent:t}),t}((Sq=al("cc.SpotLight"),xq=Tl(),Tq=gl(),Eq=fl("_luminance"),Cq=wl(),bq=wl(),Aq=Gl(Gq),wq=wl(),Rq=wl(),Iq=wl(),Pq=Rl(),Oq=wl(),Sq(Dq=xq(Dq=Tq(Dq=vl((kq=function(e){function t(){var t;return X(t=e.call(this)||this,"_size",Nq,j(t)),X(t,"_luminanceHDR",Lq,j(t)),X(t,"_luminanceLDR",Bq,j(t)),X(t,"_term",Fq,j(t)),X(t,"_range",zq,j(t)),X(t,"_spotAngle",Uq,j(t)),t._type=kg.SPOT,t._light=null,t._lightType=cy,t}return z(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,r.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*Em.standardExposureValue*Em.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/Em.standardExposureValue/Em.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},B(t,[{key:"luminousFlux",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Vg(this._size):this._luminanceLDR},set:function(e){var t=0;r.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Vg(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return r.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){r.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=ei(e))}}]),t}(jq),Nq=Y((Mq=kq).prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),Lq=Y(Mq.prototype,"_luminanceHDR",[_l,Eq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Vg(.15)}}),Bq=Y(Mq.prototype,"_luminanceLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Fq=Y(Mq.prototype,"_term",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gq.LUMINOUS_FLUX}}),zq=Y(Mq.prototype,"_range",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Uq=Y(Mq.prototype,"_spotAngle",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Y(Mq.prototype,"luminousFlux",[Cq],Object.getOwnPropertyDescriptor(Mq.prototype,"luminousFlux"),Mq.prototype),Y(Mq.prototype,"luminance",[bq],Object.getOwnPropertyDescriptor(Mq.prototype,"luminance"),Mq.prototype),Y(Mq.prototype,"term",[Aq,wq],Object.getOwnPropertyDescriptor(Mq.prototype,"term"),Mq.prototype),Y(Mq.prototype,"size",[Rq],Object.getOwnPropertyDescriptor(Mq.prototype,"size"),Mq.prototype),Y(Mq.prototype,"range",[Iq],Object.getOwnPropertyDescriptor(Mq.prototype,"range"),Mq.prototype),Y(Mq.prototype,"spotAngle",[Dl,Pq,Oq],Object.getOwnPropertyDescriptor(Mq.prototype,"spotAngle"),Mq.prototype),Dq=Mq))||Dq)||Dq)||Dq)||Dq));r.LightComponent=jq,He.setClassAlias(jq,"cc.LightComponent"),r.DirectionalLightComponent=Wq,He.setClassAlias(Wq,"cc.DirectionalLightComponent"),r.SphereLightComponent=qq,He.setClassAlias(qq,"cc.SphereLightComponent"),r.SpotLightComponent=Xq,He.setClassAlias(Xq,"cc.SpotLightComponent"),Fn(Xq.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),Fn(qq.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),Fn(jq.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var Yq=function(e,t,n){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14};function Kq(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*n,e)/12)}new bi,new bi,new gi,new bi,new gi;var Qq=new Mo(Br.POINT,Br.POINT,Br.NONE,Fr.CLAMP,Fr.CLAMP,Fr.CLAMP),Zq=new gi,Jq=new gi,$q=new gi,eX=new gi,tX=new Mi,nX=new Mi,iX=new Fc,rX=Number.MAX_SAFE_INTEGER,oX=function(){function e(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=function(e){return e.hasFeature(Er.TEXTURE_FLOAT)?Cr.RGBA32F:Cr.RGBA8}(this._device);this._formatSize=fa[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new _y(e),this._pool.initialize({format:t,roundUpFn:Kq}),this._customPool=new _y(e),this._customPool.initialize({format:t,roundUpFn:Kq})}var t=e.prototype;return t.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},t.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},t.getDefaultPoseTexture=function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),_=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!_)return r;r={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:_},s=new Float32Array(u),c=!0}gi.set($q,rX,rX,rX),gi.set(eX,-rX,-rX,-rX);for(var f=t.getBoneSpaceBounds(e),p=0,d=0;p<l;p++,d+=12){var m=n.getChildByPath(o[p]),v=m?KG(m,n,tX):e.inverseBindposes[p],g=f[p];g&&(Fc.transform(iX,g,v),iX.getBoundary(Zq,Jq),gi.min($q,$q,Zq),gi.max(eX,eX,Jq)),c&&(m&&Mi.multiply(v,v,a[p]),Yq(s,d,m?v:Mi.IDENTITY))}var y=[new Fc];return r.bounds.set(t.hash,y),Fc.fromPoints(y[0],$q,eX),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},t.getSequencePoseTexture=function(e,t,n,i){var r=e.hash^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=e.joints,s=e.bindposes,c=dU.getOrExtract(t).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var _=12*h*c,f=this._chunkIdxMap.get(r),p=void 0!==f?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,f):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!p)return null;var d=this._createAnimInfos(e,t,i);o={pixelOffset:p.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:p,animInfos:d},l=new Float32Array(_),u=!0}var m=n.getBoneSpaceBounds(e),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new Fc(rX,rX,rX,-rX,-rX,-rX));for(var y=0,S=0;y<c;y++){for(var x=v[y],T=0;T<h;T++,S+=12){var E=o.animInfos[T],C=E.curveData,b=E.downstream,A=E.bindposeIdx,w=E.bindposeCorrection,R=void 0,I=!0;C&&b?R=Mi.multiply(tX,C[y],b):C?R=C[y]:b?R=b:(R=e.inverseBindposes[A],I=!1);var P=m[T];if(P){var O=w?Mi.multiply(nX,R,w):R;Fc.transform(iX,P,O),iX.getBoundary(Zq,Jq),gi.min(x.center,x.center,Zq),gi.max(x.halfExtents,x.halfExtents,Jq)}u&&(I&&Mi.multiply(tX,R,s[A]),Yq(l,S,I?tX:Mi.IDENTITY))}Fc.fromPoints(x,x.center,x.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},t.releaseHandle=function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}},t.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t._createAnimInfos=function(e,t,n){for(var i=[],r=e.joints,o=e.bindposes,a=r.length,s=dU.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),_=void 0,f=void 0;!u;){var p=l.lastIndexOf("/");if(l=l.substring(0,p),u=s.joints[l],h?(_||(_=new Mi),Mi.fromRTS(tX,h.rotation,h.position,h.scale),Mi.multiply(_,tX,_),h=h.parent):f=l,p<0)break}var d=c,m=void 0;if(void 0!==f&&u){d=c-1;for(var v=0;v<a;v++)if(r[v]===f){d=v,m=new Mi,Mi.multiply(m,o[v],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:_,bindposeIdx:d,bindposeCorrection:m})}return i},B(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),e}(),aX=function(){function e(e){this._pool=new Map,this._device=void 0,this._device=e}var t=e.prototype;return t.getData=function(e){void 0===e&&(e="-1");var t=this._pool.get(e);if(t)return t;var n=this._device.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,Cd.SIZE,Cd.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1};return this._setAnimInfoDirty(r,!1),this._pool.set(e,r),r},t.destroy=function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))},t._setAnimInfoDirty=function(e,t){e.dirty=t},t.switchClip=function(e){return e.data[0]=0,e.buffer.update(e.data),this._setAnimInfoDirty(e,!1),e},t.clear=function(){for(var e,t=q(this._pool.values());!(e=t()).done;)e.value.buffer.destroy();this._pool.clear()},e}(),sX=function(){function e(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new oX(e),this.jointAnimationInfo=new aX(e)}var t=e.prototype;return t.releaseSkeleton=function(e){this.jointTexturePool.releaseSkeleton(e)},t.releaseAnimationClip=function(e){this.jointTexturePool.releaseAnimationClip(e)},t.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},e}();r.internal.DataPoolManager=sX;var cX=[{name:"CC_USE_SKINNING",value:!0}];function lX(e,t,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(t.push(r),e.push(a))}}var uX,hX,_X,fX,pX,dX,mX,vX,gX,yX,SX,xX,TX,EX,CX,bX,AX,wX,RX,IX,PX,OX,DX,MX,NX,LX,BX,FX,zX,UX,kX,GX,HX,VX,jX,WX,qX,XX,YX,KX,QX,ZX,JX,$X,eY,tY=new gi,nY=new gi,iY=new gi,rY=new gi,oY=new Mi,aY=new Fc,sY=function(e){function t(){var t;return(t=e.call(this)||this).uploadAnimation=null,t._buffers=[],t._dataArray=[],t._joints=[],t._bufferIndices=null,t.type=Qv.SKINNING,t}z(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)HG(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=GG(c,t),u=e.bindposes[a],h=[],_=[];o?lX(h,_,o,a):(h.push(a),_.push(0)),this._joints.push({indices:h,buffers:_,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0),gi.set(tY,1/0,1/0,1/0),gi.set(nY,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=kG(i.transform,e);Fc.transform(aY,r,o),aY.getBoundary(iY,rY),gi.min(tY,tY,iY),gi.max(nY,nY,rY)}var a=this._worldBounds;this._modelBounds&&a&&(Fc.fromPoints(this._modelBounds,tY,nY),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;Mi.multiply(oY,a.world,s);for(var c=0;c<o.length;c++)Yq(this._dataArray[o[c]],12*r[c],oY)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(t,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,e.prototype.initSubModel.call(this,t,n,i),o.vertexBuffers=r},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?cX.concat(n):cX},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._buffers[this._bufferIndices[t]];i&&n.bindBuffer(Ad.BINDING,i)},n._updateInstancedAttributes=function(t,n){n.batchingScheme!==Uv.NONE&&b(3936,this.node.name),e.prototype._updateInstancedAttributes.call(this,t,n)},n._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,Ad.SIZE,Ad.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(Ad.COUNT))},t}(gW),cY=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],lY=function(e){function t(){var t;(t=e.call(this)||this).uploadedAnim=void 0,t._jointsMedium=void 0,t._skeleton=null,t._mesh=null,t._dataPoolManager=void 0,t._instAnimInfoIdx=-1,t.type=Qv.BAKED_SKINNING,t._dataPoolManager=r.director.root.dataPoolManager;var n=new Float32Array(4),i=t._dataPoolManager.jointAnimationInfo.getData();return t._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:i,texture:null,boundsInfo:null},t}z(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),this._skeleton=e,this._mesh=n,e&&t&&n){this.transform=t;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.DEVICE,Ed.SIZE,Ed.SIZE)))}},n.updateTransform=function(t){if(e.prototype.updateTransform.call(this,t),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(e){this._modelBounds=e},n.uploadAnimation=function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,n=null;e?(n=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=e.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Id,o)}},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?n.concat(cY):cY},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(Ed.BINDING,r),n.bindBuffer(Cd.BINDING,a.buffer),o){var s=this._device.getSampler(Qq);n.bindTexture(Id,o.handle.texture),n.bindSampler(Id,s)}},n._setInstAnimInfoIdx=function(e){this._instAnimInfoIdx=e},n._updateInstancedAttributes=function(t,n){e.prototype._updateInstancedAttributes.call(this,t,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(bd)),this.updateInstancedJointTextureInfo()},n.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,n=e.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=t[1],r[2]=t[2]}},t}(gW),uY=function(t){return e({SkinnedMeshRenderer:t,SkinningModelComponent:t}),t}((uX=al("cc.SkinnedMeshRenderer"),hX=Tl(),_X=cl(100),fX=gl(),pX=Gl(WW),dX=Gl($b),mX=Gl(WW),vX=Gl($b),gX=wl(),uX(yX=hX(yX=_X(yX=vl(yX=fX((EX=function(e){function t(){var t;return X(t=e.call(this)||this,"_skeleton",xX,j(t)),X(t,"_skinningRoot",TX,j(t)),t._clip=null,t._modelType=lY,t}z(t,e);var n=t.prototype;return n.__preload=function(){this._updateModelType()},n.uploadAnimation=function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)},n.setUseBakedAnimation=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1);var n=e?lY:sY;(t||this._modelType!==n)&&(this._modelType=n,this._model&&(r.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(t,n){e.prototype.setMaterial.call(this,t,n),this._modelType===sY&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),e.prototype._updateModelParams.call(this)},n._updateModelType=function(){if(this._skinningRoot){var e=this._skinningRoot.getComponent("cc.SkeletalAnimation");e?this.setUseBakedAnimation(e.useBakedAnimation):this.setUseBakedAnimation(!1)}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},B(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){e!==this._skinningRoot&&(this._skinningRoot=e,this._updateModelType(),this._update())}},{key:"model",get:function(){return this._model}}]),t}(TW),xX=Y((SX=EX).prototype,"_skeleton",[pX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TX=Y(SX.prototype,"_skinningRoot",[dX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(SX.prototype,"skeleton",[mX],Object.getOwnPropertyDescriptor(SX.prototype,"skeleton"),SX.prototype),Y(SX.prototype,"skinningRoot",[vX,gX],Object.getOwnPropertyDescriptor(SX.prototype,"skinningRoot"),SX.prototype),yX=SX))||yX)||yX)||yX)||yX)||yX)),hY=new Vo(lo.ATTR_BATCH_ID,Cr.R32F),_Y=new Vo(lo.ATTR_BATCH_UV,Cr.RG32F),fY=fa[hY.format].size+fa[_Y.format].size,pY=function(t){return e({SkinnedMeshUnit:t,SkinningModelUnit:t}),t}((CX=al("cc.SkinnedMeshUnit"),bX=Gl(Tj),AX=Gl(WW),wX=Gl(Mg),RX=Gl(uY),CX((FX=function(){function e(){X(this,"mesh",OX,this),X(this,"skeleton",DX,this),X(this,"material",MX,this),X(this,"_localTransform",NX,this),X(this,"_offset",LX,this),X(this,"_size",BX,this)}return B(e,[{key:"offset",get:function(){return this._offset},set:function(e){Fi.copy(this._offset,e)}},{key:"size",get:function(){return this._size},set:function(e){Fi.copy(this._size,e)}},{key:"copyFrom",get:function(){return null},set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&KG(e.node,e.skinningRoot,this._localTransform))}}]),e}(),OX=Y((PX=FX).prototype,"mesh",[bX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DX=Y(PX.prototype,"skeleton",[AX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MX=Y(PX.prototype,"material",[wX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NX=Y(PX.prototype,"_localTransform",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi}}),LX=Y(PX.prototype,"_offset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0)}}),BX=Y(PX.prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1)}}),Y(PX.prototype,"offset",[El],Object.getOwnPropertyDescriptor(PX.prototype,"offset"),PX.prototype),Y(PX.prototype,"size",[El],Object.getOwnPropertyDescriptor(PX.prototype,"size"),PX.prototype),Y(PX.prototype,"copyFrom",[RX],Object.getOwnPropertyDescriptor(PX.prototype,"copyFrom"),PX.prototype),IX=PX))||IX)),dY=new Mi,mY=(new Mi,new gi),vY=function(t){return e({SkinnedMeshBatchRenderer:t,BatchedSkinningModelComponent:t}),t}((zX=al("cc.SkinnedMeshBatchRenderer"),UX=Tl(),kX=cl(100),GX=gl(),HX=wl(),VX=Gl([bt]),jX=wl(),WX=Gl([pY]),qX=wl(),XX=Cl(),YX=Cl(),zX(KX=UX(KX=kX(KX=vl(KX=GX((eY=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"atlasSize",ZX,j(t)),X(t,"batchableTextureNames",JX,j(t)),X(t,"units",$X,j(t)),t._textures={},t._batchMaterial=null,t}z(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),e.prototype.onDestroy.call(this)},n._onMaterialModified=function(t){this.cookMaterials(),e.prototype._onMaterialModified.call(this,t,this.getMaterialInstance(t))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var n=t.effectAsset.techniques[t.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=Ar.SAMPLER1D){var o=null;e.batchableTextureNames.find((function(e){return e===n}))?((o=e._textures[n])||(o=e.createTexture(n)),e.cookTextures(o,n,i)):e.units.some((function(e){return o=e.material&&e.material.getProperty(n,i)})),o&&t.setProperty(n,o,i)}else{for(var a=[],s=0;s<e.units.length;s++){var c=e.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}t.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var e=[],t=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;Mi.invert(dY,i._localTransform);for(var o=function(n){var i=r.joints[n];if(e.findIndex((function(e){return e===i}))>=0)return"continue";e.push(i),t.push(Mi.multiply(new Mi,r.bindposes[n]||Mi.IDENTITY,dY))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(e.length).keys()).sort((function(t,n){return e[t]>e[n]?1:e[t]<e[n]?-1:0})),c=new WW;c.joints=e.map((function(e,t,n){return n[s[t]]})),c.bindposes=t.map((function(e,t,n){return n[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var e=this,t=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){t=!0;break}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Tj;for(var i=0,r=Cr.UNKNOWN,o=0,a=Cr.UNKNOWN,s=0,c=Cr.UNKNOWN,l=0,u=Cr.UNKNOWN,h=0,_=Cr.UNKNOWN,f=new Array(this.units.length),p=this.units.length,d=0;d<p;d++){var m=this.units[d];m&&m.skeleton&&(f[d]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var n=e.units[t];if(!n||!n.mesh||!n.mesh.data)return"continue";var p=e._createUnitMesh(t,n.mesh),d=new DataView(p.data.buffer);Mi.inverseTranspose(dY,n._localTransform);for(var m=n.offset,v=n.size,g=function(e){var g=p.struct.vertexBundles[e];i=g.view.offset,r=Cr.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var S=g.attributes[y];if(S.name===lo.ATTR_POSITION){r=S.format;break}i+=fa[S.format].size}if(r){for(var x=WA(d,r,i,g.view.length,g.view.stride),T=0;T<x.length;T+=3)gi.fromArray(mY,x,T),gi.transformMat4(mY,mY,n._localTransform),gi.toArray(x,mY,T);jA(d,x,r,i,g.view.stride)}o=g.view.offset,a=Cr.UNKNOWN;for(var E=0;E<g.attributes.length;E++){var C=g.attributes[E];if(C.name===lo.ATTR_NORMAL){a=C.format;break}o+=fa[C.format].size}if(a){for(var b=WA(d,a,o,g.view.length,g.view.stride),A=0;A<b.length;A+=3)gi.fromArray(mY,b,A),gi.transformMat4Normal(mY,mY,dY),gi.toArray(b,mY,A);jA(d,b,a,o,g.view.stride)}s=g.view.offset,c=Cr.UNKNOWN;for(var w=0;w<g.attributes.length;w++){var R=g.attributes[w];if(R.name===lo.ATTR_TANGENT){c=R.format;break}s+=fa[R.format].size}if(c){for(var I=WA(d,c,s,g.view.length,g.view.stride),P=0;P<I.length;P+=3)gi.fromArray(mY,I,P),gi.transformMat4Normal(mY,mY,dY),gi.toArray(I,mY,P);jA(d,I,c,s,g.view.stride)}l=g.view.offset,u=Cr.UNKNOWN;for(var O=0;O<g.attributes.length;O++){var D=g.attributes[O];if(D.name===lo.ATTR_BATCH_UV){u=D.format;break}l+=fa[D.format].size}u&&qA(d,(function(e,t){var n,i=0===t?"x":"y";return(e=(n=e)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,d);var M=f[t];if(!M)return"continue";h=g.view.offset,_=Cr.UNKNOWN;for(var N=0;N<g.attributes.length;N++){var L=g.attributes[N];if(L.name===lo.ATTR_JOINTS){_=L.format;break}h+=fa[L.format].size}_&&qA(d,(function(e){return M[e]}),_,h,g.view.length,g.view.stride,d)},y=0;y<p.struct.vertexBundles.length;y++)g(y);e._mesh.merge(p)},g=0;g<p;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(e,t,n){for(var i=[],o=[],a=[],s=[],c=0;c<this.units.length;c++){var l=this.units[c];if(l.material){var u=l.material.getProperty(t,n);if(u&&u.image&&u.image.data){var h=new So;h.texOffset.x=l.offset.x*this.atlasSize,h.texOffset.y=l.offset.y*this.atlasSize,h.texExtent.width=l.size.x*this.atlasSize,h.texExtent.height=l.size.y*this.atlasSize;var _=u.image.data;ArrayBuffer.isView(_)?(a.push(_),s.push(h)):(i.push(_),o.push(h))}}}var f=e.getGFXTexture(),p=r.director.root.device;a.length>0&&p.copyBuffersToTexture(a,f,s),i.length>0&&p.copyTexImagesToTexture(i,f,o)},n.createTexture=function(e){var t=new lv;return t.setFilters(um.LINEAR,um.LINEAR),t.setMipFilter(um.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:cm.RGBA8888}),this._textures[e]=t,t},n.resizeAtlases=function(){for(var e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:cm.RGBA8888})},n._createUnitMesh=function(e,t){for(var n=JSON.parse(JSON.stringify(t.struct)),i={},o=0;o<t.struct.primitives.length;o++){for(var a=t.struct.primitives[o],s=0,c=Cr.UNKNOWN,l=0;l<a.vertexBundelIndices.length;l++){var u=t.struct.vertexBundles[a.vertexBundelIndices[l]];s=u.view.offset,c=Cr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===lo.ATTR_TEX_COORD){c=_.format;break}s+=fa[_.format].size}if(c)break}if(void 0===i[l]){i[l]=[c,s];var f=n.vertexBundles[l];f.attributes.push(hY),f.attributes.push(_Y),f.view.offset=0,f.view.length+=f.view.count*fY,f.view.stride+=fY}}for(var p=0,d=0;d<n.vertexBundles.length;d++)p+=n.vertexBundles[d].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=p,p+=v.indexView.length)}var g=new Uint8Array(p),y=t.data,S=new DataView(g.buffer),x=new DataView(y.buffer),T=r.sys.isLittleEndian;for(var E in i)for(var C=n.vertexBundles[E],b=t.struct.vertexBundles[E],A=i[E],w=WA(x,A[0],A[1],b.view.length,b.view.stride),R=b.view,I=C.view,P=R.stride,O=I.stride,D=R.offset,M=I.offset,N=0;N<I.count;N++){var L=y.subarray(D,D+P);g.set(L,M),S.setFloat32(M+P,e),S.setFloat32(M+P+4,w[2*N],T),S.setFloat32(M+P+8,w[2*N+1],T),M+=O,D+=P}for(var B=0;B<n.primitives.length;B++){var F=t.struct.primitives[B],z=n.primitives[B];if(F.indexView&&z.indexView)for(var U=F.indexView.stride,k=z.indexView.stride,G=F.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var j=y.subarray(G,G+U);g.set(j,H),H+=k,G+=U}}var W=new Tj;return W.reset({struct:n,data:g}),W},B(t,[{key:"mesh",get:function(){return e.prototype.mesh},set:function(e){this.mesh=e}},{key:"skeleton",get:function(){return e.prototype.skeleton},set:function(e){this.skeleton=e}}]),t}(uY),ZX=Y((QX=eY).prototype,"atlasSize",[_l,HX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),JX=Y(QX.prototype,"batchableTextureNames",[VX,_l,jX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$X=Y(QX.prototype,"units",[WX,_l,qX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Y(QX.prototype,"mesh",[Zl,XX],Object.getOwnPropertyDescriptor(QX.prototype,"mesh"),QX.prototype),Y(QX.prototype,"skeleton",[Zl,YX],Object.getOwnPropertyDescriptor(QX.prototype,"skeleton"),QX.prototype),KX=QX))||KX)||KX)||KX)||KX)||KX));r.SkinningModelComponent=uY,He.setClassAlias(uY,"cc.SkinningModelComponent"),r.SkinningModelUnit=pY,He.setClassAlias(pY,"cc.SkinningModelUnit"),r.BatchedSkinningModelComponent=vY,He.setClassAlias(vY,"cc.BatchedSkinningModelComponent");var gY,yY,SY,xY,TY,EY,CY,bY,AY,wY,RY,IY,PY,OY,DY,MY,NY,LY,BY,FY,zY=new Mi,UY=new Mi,kY=e("SkeletalAnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this,t,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._comps=[],i._parent=null,i._curvesInited=!1,i._animInfoMgr=r.director.root.dataPoolManager.jointAnimationInfo,i}z(t,e);var n=t.prototype;return n.initialize=function(t){if(!this._curveLoaded){this._comps.length=0;for(var n=t.getComponentsInChildren(uY),i=0;i<n.length;++i){var r=n[i];r.skinningRoot===t&&this._comps.push(r)}this._parent=t.getComponent("cc.SkeletalAnimation");var o=this._parent.useBakedAnimation;this._doNotCreateEval=o,e.prototype.initialize.call(this,t),this._curvesInited=!o;var a=dU.getOrExtract(this.clip),s=a.frames,c=a.samples;this._frames=s-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/c}},n.onPlay=function(){if(e.prototype.onPlay.call(this),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip);for(var t=0;t<this._comps.length;++t)this._comps[t].uploadAnimation(this.clip)}else this._sampleCurves=e.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,e.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0)},n.rebuildSocketCurves=function(e){if(this._sockets.length=0,this._targetNode)for(var t=this._targetNode,n=0;n<e.length;++n){var i=e[n],r=t.getChildByPath(i.path);if(i.target){for(var o=dU.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=Mi.identity(UY)),Mi.fromRTS(zY,c.rotation,c.position,c.scale),Mi.multiply(l,zY,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,_=o.frames,f=[],p=0;p<_;p++){var d;d=h&&l?Mi.multiply(zY,h[p],l):h?h[p]:l||new Mi;var m={pos:new gi,rot:new bi,scale:new gi};Mi.toRTS(d,m.rot,m.pos,m.scale),f.push(m)}this._sockets.push({target:i.target,frames:f})}}},n._setAnimInfoDirty=function(e,t){e.dirty=t},n._sampleCurvesBaked=function(e){var t=e/this.duration,n=this._animInfo,i=t*this._frames+.5|0;if(i!==n.data[0]){n.data[0]=i,this._setAnimInfoDirty(n,!0);for(var r=0;r<this._sockets.length;++r){var o=this._sockets[r],a=o.target,s=o.frames[i],c=s.pos,l=s.rot,u=s.scale;a.setRTS(l,c,u)}}},t}(cG)),GY=e("Socket",(gY=al("cc.SkeletalAnimation.Socket"),yY=Gl($b),gY((TY=Y((xY=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),X(this,"path",TY,this),X(this,"target",EY,this),this.path=e,this.target=t}).prototype,"path",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),EY=Y(xY.prototype,"target",[yY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SY=xY))||SY));He.setClassAlias(GY,"cc.SkeletalAnimationComponent.Socket");var HY=new Mi,VY=new Mi;function jY(e,t,n){void 0===t&&(t=""),void 0===n&&(n=[]);for(var i=0;i<e.children.length;i++){var r=e.children[i];if(r){var o=t?t+"/"+r.name:r.name;n.push(o),jY(r,o,n)}}return n}var WY=function(t){return e({SkeletalAnimation:t,SkeletalAnimationComponent:t}),t}((CY=al("cc.SkeletalAnimation"),bY=Tl(),AY=cl(99),wY=gl(),RY=Gl([GY]),IY=wl(),PY=wl(),OY=Gl([GY]),CY(DY=bY(DY=AY(DY=vl(DY=wY((FY=BY=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_useBakedAnimation",NY,j(t)),X(t,"_sockets",LY,j(t)),t}z(t,e);var n=t.prototype;return n.onDestroy=function(){e.prototype.onDestroy.call(this),r.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),r.director.getAnimationManager().removeSockets(this.node,this._sockets)},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,e.prototype.start.call(this)},n.querySockets=function(){var e=this._defaultClip&&Object.keys(dU.getOrExtract(this._defaultClip).joints).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e}),[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],n=0;n<e.length;n++){var i=e[n],r=this.node.getChildByPath(i);r&&(t.push(i),jY(r,i,t))}return t},n.rebuildSocketAnimations=function(){for(var e,t=q(this._sockets);!(e=t()).done;){var n=e.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,KG(i,this.node,HY),Mi.fromRTS(VY,r.rotation,r.position,r.scale),Mi.equals(VY,HY)||(r.matrix=HY))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var n=new $b;return n.parent=this.node,this._sockets.push(new GY(e,n)),this.rebuildSocketAnimations(),n},n._createState=function(e,t){return new kY(e,t)},n._doCreateState=function(t,n){var i=e.prototype._doCreateState.call(this,t,n);return i.rebuildSocketCurves(this._sockets),i},B(t,[{key:"sockets",get:function(){return this._sockets},set:function(e){if(!this._useBakedAnimation){var t=r.director.getAnimationManager();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){this._useBakedAnimation=e;for(var t=this.node.getComponentsInChildren(uY),n=0;n<t.length;++n){var i=t[n];i.skinningRoot===this.node&&i.setUseBakedAnimation(this._useBakedAnimation,!0)}this._useBakedAnimation?r.director.getAnimationManager().removeSockets(this.node,this._sockets):r.director.getAnimationManager().addSockets(this.node,this._sockets)}}]),t}(wG),BY.Socket=GY,Y((MY=FY).prototype,"sockets",[RY,IY],Object.getOwnPropertyDescriptor(MY.prototype,"sockets"),MY.prototype),Y(MY.prototype,"useBakedAnimation",[PY],Object.getOwnPropertyDescriptor(MY.prototype,"useBakedAnimation"),MY.prototype),NY=Y(MY.prototype,"_useBakedAnimation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),LY=Y(MY.prototype,"_sockets",[OY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DY=MY))||DY)||DY)||DY)||DY)||DY));r.SkeletalAnimationComponent=WY,He.setClassAlias(WY,"cc.SkeletalAnimationComponent"),r.utils=Oj;var qY=new gi,XY=new Mi;function YY(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);var u=o.vData,h=o.iData;e.getWorldMatrix(XY);for(var _=0;_<s;_++){var f=r[_];gi.set(qY,f.x,f.y,0),gi.transformMat4(qY,qY,XY),u[a++]=qY.x,u[a++]=qY.y,u[a++]=qY.z,u[a++]=f.u,u[a++]=f.v,mi.toArray(u,i,a),a+=4}for(var p=0,d=s/4;p<d;p++){var m=l+4*p;h[c++]=m,h[c++]=m+1,h[c++]=m+2,h[c++]=m+1,h[c++]=m+3,h[c++]=m+2}}var KY=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new QY;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,i=this._innerTextureInfos[n.getId()],o=t.x,a=t.y;if(i)o+=i.x,a+=i.y;else{var s=n.width,c=n.height;if(this._x+s+2>this._width&&(this._x=2,this._y=this._nexty),this._y+c+2>this._nexty&&(this._nexty=this._y+c+2),this._nexty>this._height)return null;r.internal.dynamicAtlasManager.textureBleeding&&((s<=8||c<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,o+=this._x,a+=this._y,this._x+=s+2}var l={x:o,y:a,texture:this._texture};return this._innerSpriteFrames.push(e),l},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),QY=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=cm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new So;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(lv),ZY=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new KY(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==um.LINEAR||t.magFilter!==um.LINEAR||t.mipFilter!==um.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],He.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(!t._original&&t.packable){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},B(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),r.director.on(r.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),r.director.off(r.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();ZY.instance=void 0;var JY,$Y=e("dynamicAtlasManager",ZY.instance=new ZY);r.internal.dynamicAtlasManager=$Y;var eK,tK,nK,iK,rK=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],oK=e("SpriteFrame",al("cc.SpriteFrame")(JY=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.uvHash=0,t.unbiasUV=[],t.uvSliced=[],t._rect=new qi,t._offset=new Fi,t._originalSize=new ji,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}z(t,e),t.createWithImage=function(e){var n=e instanceof zm?e:new zm(e),i=new lv;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(w(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(w(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&$Y&&$Y.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,t=this.texture,n=t.width,i=t.height,r=this._capInsets[0],o=this._capInsets[2],a=e.width-r-o,s=this._capInsets[1],c=this._capInsets[3],l=e.height-s-c,u=this.uvSliced;if(u.length=0,this._rotated){rK[0].u=e.x/n,rK[1].u=(e.x+c)/n,rK[2].u=(e.x+c+l)/n,rK[3].u=(e.x+e.height)/n,rK[3].v=e.y/i,rK[2].v=(e.y+r)/i,rK[1].v=(e.y+r+a)/i,rK[0].v=(e.y+e.width)/i;for(var h=0;h<4;++h)for(var _=rK[h],f=0;f<4;++f){var p=rK[3-f];u.push({u:_.u,v:p.v})}}else{rK[0].u=e.x/n,rK[1].u=(e.x+r)/n,rK[2].u=(e.x+r+a)/n,rK[3].u=(e.x+e.width)/n,rK[3].v=e.y/i,rK[2].v=(e.y+s)/i,rK[1].v=(e.y+s+l)/i,rK[0].v=(e.y+e.height)/i;for(var d=0;d<4;++d)for(var m=rK[d],v=0;v<4;++v){var g=rK[v];u.push({u:g.u,v:m.v})}}},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===o?0:e.y/o,l=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=a,t[5]=l,t[6]=a,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=a,t[5]=c,t[6]=a,t[7]=l):this._isFlipUVY?(t[0]=a,t[1]=l,t[2]=a,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,_=0===o?0:e.y/o,f=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var p=0===r?0:e.x/r,d=0===r?1:(e.x+e.width)/r,m=0===o?1:(e.y+e.height)/o,v=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):this._isFlipUVX?(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v):this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,S=0===o?1:(e.y+e.height)/o,x=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVX?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVY?(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S):(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x)}for(var T="",E=0;E<t.length;E++)T+=t[E];this.uvHash=Da(T,666);var C=this.vertices;if(C){C.nu.length=0,C.nv.length=0;for(var b=0;b<C.u.length;b++)C.nu[b]=C.u[b]/r,C.nv[b]=C.v[b]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=$Y;if(e){var t=this._texture;if(t instanceof lv&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new qi(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new Fi(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new ji(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var o=t.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,o,a,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),l.uvHash=this.uvHash,(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new qi(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new ji(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new lv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},n._calculateTillingOffset=function(){this._rotated?(this.tillingOffset[0]=this.uv[4]-this.uv[0],this.tillingOffset[1]=this.uv[3]-this.uv[5],this.tillingOffset[2]=this.uv[0],this.tillingOffset[3]=this.uv[5],this.tillingOffset[0]=-this.tillingOffset[0]):(this.tillingOffset[0]=this.uv[2]-this.uv[0],this.tillingOffset[1]=this.uv[1]-this.uv[5],this.tillingOffset[2]=this.uv[4],this.tillingOffset[3]=this.uv[5])},n._calculateSlicedData=function(){var e=this._rect,t=this._capInsets[0],n=this._capInsets[2],i=e.width-t-n,r=this._capInsets[1],o=this._capInsets[3],a=e.height-r-o,s=this.slicedData;s.length=0,s[0]=t/e.width,s[1]=r/e.height,s[2]=(t+i)/e.width,s[3]=(r+a)/e.height},B(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(Fu))||JY);r.SpriteFrame=oK;var aK,sK=e("SpriteAtlas",al("cc.SpriteAtlas")((iK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",nK,j(t)),t}z(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=fe();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],Ue(oK))},t}(Fu),nK=Y((tK=iK).prototype,"spriteFrames",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fe()}}),eK=tK))||eK);r.SpriteAtlas=sK;var cK,lK,uK,hK,_K=e("Font",al("cc.Font")(aK=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(Fu))||aK);r.Font=_K;var fK,pK,dK,mK,vK,gK,yK,SK,xK,TK=e("TTFFont",al("cc.TTFFont")((hK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",uK,j(t)),t}return z(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},B(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:yn(this._native),__isNative__:!0}}}]),t}(_K),uK=Y((lK=hK).prototype,"_fontFamily",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(lK.prototype,"_nativeAsset",[Zl,kl],Object.getOwnPropertyDescriptor(lK.prototype,"_nativeAsset"),lK.prototype),Y(lK.prototype,"_nativeDep",[Zl],Object.getOwnPropertyDescriptor(lK.prototype,"_nativeDep"),lK.prototype),cK=lK))||cK);r.TTFFont=TK;var EK,CK=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},bK=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new CK;Ce(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),AK=e("BitmapFont",(fK=al("cc.BitmapFont"),pK=Gl(oK),fK((xK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",vK,j(t)),X(t,"spriteFrame",gK,j(t)),X(t,"fontSize",yK,j(t)),X(t,"fntConfig",SK,j(t)),t}return z(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new bK(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new CK,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else d("The fnt config is not exists!")},t}(_K),vK=Y((mK=xK).prototype,"fntDataStr",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gK=Y(mK.prototype,"spriteFrame",[pK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yK=Y(mK.prototype,"fontSize",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),SK=Y(mK.prototype,"fntConfig",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dK=mK))||dK));r.BitmapFont=AK;var wK=e("LabelAtlas",al("cc.LabelAtlas")(EK=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(AK))||EK);r.LabelAtlas=wK;var RK=e("BASELINE_RATIO",.26),IK=e("MIDDLE_RATIO",(RK+1)/2-RK);var PK=new ke(2);PK.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var OK,DK=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=PK.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,PK.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),MK=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,NK=/^[!,.:;'}\]%\?>、‘“》？。，！]/,LK=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,BK=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,FK=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function zK(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function UK(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function kK(e,t,n){var i=(n||e.font)+"🎮"+t,r=DK.get(i);if(null!==r)return r;var o=e.measureText(t),a=o&&o.width||0;return DK.put(i,a),a}function GK(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}function HK(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var o=e;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=GK(o,a),c=t-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=t-i(s=GK(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var _=MK.exec(s);u=_?_[0].length:1,l=s}c=t-i(s=GK(o,a+=u))}0==(a-=u)?(a=1,l=GK(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=GK(o,2));var f=GK(o,0,a),p=void 0;NK.test(l||s)&&(0==(a-=(p=LK.exec(f))?p[0].length:0)&&(a=1),l=GK(o,a),f=GK(o,0,a)),FK.test(l)&&(p=BK.exec(f))&&f!==p[0]&&(l=GK(o,a-=p[0].length),f=GK(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var VK,jK,WK,qK,XK,YK,KK,QK,ZK,JK,$K,eQ,tQ,nQ,iQ,rQ=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return OK||(OK=new e),OK};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=et.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),oQ=mi.WHITE.clone(),aQ=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},sQ="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",cQ=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=rQ.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=kK(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+RK)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*RK/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new zm),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=sQ,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,o=n/2,a=i/2+r*IK+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||oQ;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,o,a)}e.fillText(this.char,o,a)}},e}(),lQ=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=cm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new So;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(lv),uQ=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new lQ;n.initWithSize(e,t),this.fontDefDictionary=new bK(n),this._halfBleed=1,this._width=e,this._height=t,$M.on(JM.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=$M.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return b(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var o=new aQ;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new lQ;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new cQ(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},B(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),hQ={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:mi.WHITE.clone(),isOutlined:!1,out:mi.WHITE.clone(),margin:0},_Q=function(){this.material=null,this.vertexCount=0,this.indicesCount=0},fQ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._data=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t.renderScene=null,t.layer=0,t.nodeDirty=!0,t.blendHash=-1,t.passDirty=!0,t.frame=void 0,t.textureHash=0,t.textureDirty=!0,t.hashDirty=!0,t.dataHash=0,t}z(t,e),t.add=function(){return mQ.add()},t.remove=function(e){var t=mQ.data.indexOf(e);-1!==t&&(mQ.data[t].clear(),mQ.removeAt(t))};var n=t.prototype;return n.updateNode=function(e){this.renderScene=e.node.scene?e._getRenderScene():null,this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=" "+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=Da(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty&&(this.renderScene=e.node.scene?e._getRenderScene():null,this.layer=e.node.layer,null!==this.renderScene&&(this.nodeDirty=!1),this.hashDirty=!0),this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty){var n=" "+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=Da(n,666),this.hashDirty=!1}},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.renderScene=null,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},B(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)dQ.free(t[i]);for(i=n;i<e;i++)t[i]=dQ.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(_Q),pQ=function(e){function t(t){var n;return void 0===t&&(t=9),(n=e.call(this)||this).vData=void 0,n.iData=void 0,n.vertexStart=0,n.indicesStart=0,n.byteStart=0,n.byteCount=0,n.lastFilledIndices=0,n.lastFilledVertex=0,n._formatByte=void 0,n._formatByte=t*Float32Array.BYTES_PER_ELEMENT,n.vData=new Float32Array(256*t*Float32Array.BYTES_PER_ELEMENT),n.iData=new Uint16Array(1536),n}z(t,e),t.add=function(){return vQ.add()},t.remove=function(e){var t=vQ.data.indexOf(e);-1!==t&&(vQ.data[t].reset(),vQ.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this.byteCount+e*this._formatByte;return this.reserve(e,t),this.vertexCount+=e,this.indicesCount+=t,this.byteCount=n,!0},n.reserve=function(e,t){var n=this.byteCount+e*this._formatByte,i=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.advance=function(e,t){this.vertexCount+=e,this.indicesCount+=t,this.byteCount+=e*this._formatByte},n.reset=function(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.lastFilledIndices=0,this.lastFilledVertex=0},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),this.iData.set(i,0)},B(t,[{key:"formatByte",get:function(){return this._formatByte},set:function(e){this._formatByte=e}},{key:"floatStride",get:function(){return this._formatByte>>2}},{key:"vDataOffset",get:function(){return this.byteCount>>>2}}]),t}(_Q),dQ=(function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;n._fillQuadBuffer=function(){for(var e=this.iData.length/6,t=this.iData,n=0,i=0;n<e;n++){var r=4*n;t[i++]=r,t[i++]=r+1,t[i++]=r+2,t[i++]=r+1,t[i++]=r+3,t[i++]=r+2}},n._reallocBuffer=function(t,n){e.prototype._reallocBuffer.call(this,t,n),this._fillQuadBuffer()}}(pQ),new We((function(){return{x:0,y:0,z:0,u:0,v:0,color:mi.WHITE.clone()}}),128)),mQ=new qe((function(){return new fQ}),32),vQ=new qe((function(){return new pQ}),32),gQ=new Fi,yQ=new Fi,SQ=new gi,xQ=new Mi,TQ=new Mi,EQ=new Mi,CQ=new Mi(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),bQ=new qi,AQ=function(t){return e({UITransform:t,UITransformComponent:t}),t}((VK=al("cc.UITransform"),jK=Tl(),WK=cl(110),qK=gl(),XK=Ml(),YK=wl(),KK=Ml(),QK=wl(),VK(ZK=jK(ZK=WK(ZK=qK(ZK=ll(ZK=vl((nQ=tQ=function(e){function t(){var t;return(t=e.call(this)||this)._priority=0,X(t,"_contentSize",$K,j(t)),X(t,"_anchorPoint",eQ,j(t)),t}z(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(ZE.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(ZE.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit(ZE.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(ZE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t,n=this._contentSize.width,i=this._contentSize.height,r=gQ,o=yQ,a=null===(t=this.node)||void 0===t?void 0:t.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(xQ);var u=xQ.m12,h=xQ.m13,_=nN.center;if(xQ.m12=_.x-(xQ.m00*u+xQ.m04*h),xQ.m13=_.y-(xQ.m01*u+xQ.m05*h),Mi.invert(xQ,xQ),Fi.transformMat4(r,e,xQ),this.node.getWorldMatrix(EQ),Mi.invert(xQ,EQ),!Mi.strictEquals(xQ,CQ)){Fi.transformMat4(o,r,xQ),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var f=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(f=!0,a&&a.maskList))for(var p=a.maskList,d=this.node,m=p?p.length:0,v=0,g=0;d&&g<m;++v,d=d.parent){var y=p[g];if(v===y.index){if(d!==y.comp.node){p.length=g;break}var S=y.comp;if(S&&S._enabled&&!S.isHit(r)){f=!1;break}g++}else if(v>y.index){p.length=g;break}}if(f)return!0}}}return!1},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(EQ),Mi.invert(xQ,EQ),t||(t=new gi),gi.transformMat4(t,e,xQ)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(EQ),t||(t=new gi),gi.transformMat4(t,e,EQ)},n.getBoundingBox=function(){Mi.fromRTS(TQ,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new qi(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(TQ),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(EQ),this.getBoundingBoxTo(EQ)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){Mi.fromRTS(TQ,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new qi(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Mi.multiply(EQ,e,TQ),r.transformMat4(EQ),!this.node.children)return r;for(var o,a=q(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&qi.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;bQ.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),bQ.transformMat4(this.node.worldMatrix);var i=bQ.x+.5*bQ.width,r=bQ.y+.5*bQ.height,o=this.node.worldPosition.z,a=bQ.width/2,s=bQ.height/2;return null!=e?(Fc.set(e,i,r,o,a,s,.001),e):new Fc(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},n.checkAndUpdateRect=function(e,t){if(this._rectDirty){this._rectWithScale.x=t.x*this.width,this._rectWithScale.y=t.y*this.height,this._rectWithScale.z=t.z;var n=(.5-this.anchorPoint.x)*this.width*t.x,i=(.5-this.anchorPoint.y)*this.height*t.y;gi.transformQuat(this._anchorCache,SQ.set(n,i,0),e)}},n.setRectDirty=function(e){e&ng.RS&&(this._rectDirty=!0)},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},B(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(ZE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(ZE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(ZE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(ZE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(ZE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(ZE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?b(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=$M.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=$M.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(rh),tQ.EventType=ZE,tQ.priorityChangeNodeMap=new Map,Y((JK=nQ).prototype,"contentSize",[XK,YK],Object.getOwnPropertyDescriptor(JK.prototype,"contentSize"),JK.prototype),Y(JK.prototype,"anchorPoint",[KK,QK],Object.getOwnPropertyDescriptor(JK.prototype,"anchorPoint"),JK.prototype),$K=Y(JK.prototype,"_contentSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ji(100,100)}}),eQ=Y(JK.prototype,"_anchorPoint",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(.5,.5)}}),ZK=JK))||ZK)||ZK)||ZK)||ZK)||ZK)||ZK));$M.on(JM.EVENT_AFTER_UPDATE,AQ._sortSiblings),$M.on(JM.EVENT_BEFORE_SCENE_LAUNCH,AQ._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(iQ||(iQ={}));var wQ,RQ,IQ,PQ,OQ,DQ,MQ,NQ,LQ,BQ,FQ,zQ,UQ,kQ,GQ,HQ,VQ,jQ,WQ,qQ,XQ=e("StencilManager",function(){function e(){this.stage=iQ.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:zr.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Ur.KEEP,zFailOp:Ur.KEEP,passOp:Ur.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?iQ.CLEAR_INVERTED:iQ.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?iQ.ENTER_LEVEL_INVERTED:iQ.ENTER_LEVEL},t.enableMask=function(){this.stage=iQ.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=iQ.DISABLED:this.stage=iQ.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=iQ.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,o=zr.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(e);var u=new za(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===iQ.DISABLED?(t.stencilTest=!1,t.func=zr.ALWAYS,t.failOp=Ur.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===iQ.ENABLED?(t.func=zr.EQUAL,t.failOp=Ur.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===iQ.CLEAR?(t.func=zr.NEVER,t.failOp=Ur.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===iQ.CLEAR_INVERTED||e===iQ.ENTER_LEVEL?(t.func=zr.NEVER,t.failOp=Ur.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===iQ.ENTER_LEVEL_INVERTED&&(t.func=zr.NEVER,t.failOp=Ur.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},B(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());XQ.sharedManager=null,XQ.sharedManager=new XQ,Je(kr),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(qQ||(qQ=e("InstanceMaterialType",{})));var YQ,KQ,QQ,ZQ,JQ,$Q,eZ,tZ,nZ,iZ,rZ,oZ,aZ,sZ,cZ,lZ,uZ,hZ,_Z,fZ,pZ,dZ,mZ,vZ,gZ,yZ,SZ,xZ,TZ,EZ,CZ,bZ,AZ,wZ,RZ,IZ,PZ,OZ,DZ,MZ,NZ,LZ,BZ,FZ,zZ,UZ,kZ,GZ,HZ,VZ,jZ,WZ,qZ,XZ,YZ,KZ,QZ,ZZ,JZ,$Z,eJ,tJ,nJ,iJ,rJ,oJ,aJ,sJ,cJ,lJ=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((wQ=al("cc.Renderable2D"),RQ=sl(AQ),IQ=Cl(),PQ=Gl(Mg),OQ=Gl(Mg),DQ=Ml(),MQ=wl(),NQ=Al(),LQ=Ml(),BQ=wl(),wQ(FQ=RQ(FQ=ll(FQ=vl((WQ=jQ=function(e){z(n,e);var t=n.prototype;function n(){var t;return X(t=e.call(this)||this,"_materials",UQ,j(t)),X(t,"_customMaterial",kQ,j(t)),t.stencilStage=iQ.DISABLED,X(t,"_srcBlendFactor",GQ,j(t)),X(t,"_dstBlendFactor",HQ,j(t)),X(t,"_color",VQ,j(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new ka,t._blendHash=0,t._colorDirty=!0,t._lastParent=null,t}return t.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},t.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},t.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler(),sC.markOpacityTree(this.node)},t.onEnable=function(){this.node.on(ZE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(ZE.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},t.onRestore=function(){this.updateMaterial(),this._renderFlag=this._canRender()},t.onDisable=function(){this.node.off(ZE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(ZE.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},t.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++)this._materialInstances[e]&&this._materialInstances[e].destroy();this._renderData=null,this._blendState&&this._blendState.destroy()},t.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e&&this._renderFlag){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)},t.requestRenderData=function(){var e=fQ.add();return this._renderData=e,e},t.destroyRenderData=function(){this._renderData&&(fQ.remove(this._renderData),this._renderData=null)},t.updateAssembler=function(e){this._updateColor(),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))},t.postUpdateAssembler=function(e){this._renderFlag&&this._postRender(e)},t._render=function(){},t._postRender=function(){},t._checkAndUpdateRenderData=function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)},t._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this.node._uiProps.opacity>0},t._postCanRender=function(){},t._updateColor=function(){this._colorDirty&&this._assembler&&this._assembler.updateColor&&(this._assembler.updateColor(this),this._renderFlag=this._canRender(),this._colorDirty=!1)},t.markColorDirty=function(){this._colorDirty=!0},t._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new Ua,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=kr.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},t.getBlendState=function(){return this._blendState},t._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var t=this.node.children[e].getComponent(n);t&&t.markForUpdateRenderData()}},t._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},t._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case qQ.ADD_COLOR:e=Hv.get("ui-base-material");break;case qQ.GRAYSCALE:e=Hv.get("ui-sprite-gray-material");break;case qQ.USE_ALPHA_SEPARATED:e=Hv.get("ui-sprite-alpha-sep-material");break;case qQ.USE_ALPHA_SEPARATED_AND_GRAY:e=Hv.get("ui-sprite-gray-alpha-sep-material");break;default:e=Hv.get("ui-sprite-material")}return e},t.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},t.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},B(n,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&b(12001),this._srcBlendFactor},set:function(e){this._customMaterial?b(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&b(12001),this._dstBlendFactor},set:function(e){this._customMaterial?b(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){if(!this._color.equals(e)){var t=this._color.a;this._color.set(e),t!==this.color.a&&sC.markOpacityTree(this.node),this._colorDirty=!0}}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}}]),n}(EF),jQ.BlendState=kr,jQ.Assembler=null,jQ.PostAssembler=null,UQ=Y((zQ=WQ).prototype,"_materials",[Zl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Y(zQ.prototype,"sharedMaterials",[Zl,IQ],Object.getOwnPropertyDescriptor(zQ.prototype,"sharedMaterials"),zQ.prototype),kQ=Y(zQ.prototype,"_customMaterial",[PQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(zQ.prototype,"customMaterial",[OQ,DQ,MQ,NQ],Object.getOwnPropertyDescriptor(zQ.prototype,"customMaterial"),zQ.prototype),Y(zQ.prototype,"color",[LQ,BQ],Object.getOwnPropertyDescriptor(zQ.prototype,"color"),zQ.prototype),GQ=Y(zQ.prototype,"_srcBlendFactor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.SRC_ALPHA}}),HQ=Y(zQ.prototype,"_dstBlendFactor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.ONE_MINUS_SRC_ALPHA}}),VQ=Y(zQ.prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),FQ=zQ))||FQ)||FQ)||FQ)||FQ));r.internal.Renderable2D=lJ,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(oJ||(oJ=e("HorizontalTextAlignment",{}))),Je(oJ),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(aJ||(aJ=e("VerticalTextAlignment",{}))),Je(aJ),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(sJ||(sJ=e("Overflow",{}))),Je(sJ),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(cJ||(cJ=e("CacheMode",{}))),Je(cJ);var uJ,hJ,_J,fJ=function(t){return e({Label:t,LabelComponent:t}),t}((YQ=al("cc.Label"),KQ=Tl(),QQ=cl(110),ZQ=gl(),JQ=Ml(),$Q=wl(),eZ=Gl(oJ),tZ=Ml(),nZ=wl(),iZ=Gl(aJ),rZ=Ml(),oZ=wl(),aZ=Ml(),sZ=wl(),cZ=Ml(),lZ=Cl(),uZ=wl(),hZ=Ml(),_Z=wl(),fZ=Cl(),pZ=Ml(),dZ=wl(),mZ=Gl(sJ),vZ=Ml(),gZ=wl(),yZ=Ml(),SZ=wl(),xZ=Gl(_K),TZ=Ml(),EZ=Cl(),CZ=wl(),bZ=Ml(),AZ=wl(),wZ=Gl(cJ),RZ=Ml(),IZ=wl(),PZ=Ml(),OZ=wl(),DZ=Ml(),MZ=wl(),NZ=Ml(),LZ=wl(),BZ=Cl(),FZ=Ml(),zZ=wl(),YQ(UZ=KQ(UZ=QQ(UZ=ZQ((rJ=iJ=function(e){function t(){var t;return X(t=e.call(this)||this,"_string",GZ,j(t)),X(t,"_horizontalAlign",HZ,j(t)),X(t,"_verticalAlign",VZ,j(t)),X(t,"_actualFontSize",jZ,j(t)),X(t,"_fontSize",WZ,j(t)),X(t,"_fontFamily",qZ,j(t)),X(t,"_lineHeight",XZ,j(t)),X(t,"_overflow",YZ,j(t)),X(t,"_enableWrapText",KZ,j(t)),X(t,"_font",QZ,j(t)),X(t,"_isSystemFontUsed",ZZ,j(t)),t._spacingX=0,X(t,"_isItalic",JZ,j(t)),X(t,"_isBold",$Z,j(t)),X(t,"_isUnderline",eJ,j(t)),X(t,"_underlineHeight",tJ,j(t)),X(t,"_cacheMode",nJ,j(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}z(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this._texture,this._assembler,null)},n._updateColor=function(){this._colorDirty&&(this.updateRenderData(!1),this._colorDirty=!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof AK){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof AK){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===cJ.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new oK,this._assemblerData=this._assembler.getAssemblerData();var n=new zm(this._assemblerData.canvas),i=new lv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==cJ.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==cJ.CHAR){var t=this._texture.texture;if(t instanceof km){var n=t.getPixelFormat();e=n===cm.RGBA_ETC1||n===cm.RGB_A_PVRTC_4BPPV1||n===cm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?qQ.USE_ALPHA_SEPARATED:qQ.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},B(t,[{key:"string",get:function(){return this._string},set:function(e){e?e+="":e="",this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==cJ.BITMAP||this._font instanceof AK||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===cJ.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof AK?this._font.fontSize:-1}}]),t}(lJ),iJ.HorizontalAlign=oJ,iJ.VerticalAlign=aJ,iJ.Overflow=sJ,iJ.CacheMode=cJ,iJ._canvasPool=rQ.getInstance(),Y((kZ=rJ).prototype,"string",[JQ,$Q,Ll],Object.getOwnPropertyDescriptor(kZ.prototype,"string"),kZ.prototype),Y(kZ.prototype,"horizontalAlign",[eZ,tZ,nZ],Object.getOwnPropertyDescriptor(kZ.prototype,"horizontalAlign"),kZ.prototype),Y(kZ.prototype,"verticalAlign",[iZ,rZ,oZ],Object.getOwnPropertyDescriptor(kZ.prototype,"verticalAlign"),kZ.prototype),Y(kZ.prototype,"fontSize",[aZ,sZ],Object.getOwnPropertyDescriptor(kZ.prototype,"fontSize"),kZ.prototype),Y(kZ.prototype,"fontFamily",[cZ,lZ,uZ],Object.getOwnPropertyDescriptor(kZ.prototype,"fontFamily"),kZ.prototype),Y(kZ.prototype,"lineHeight",[hZ,_Z],Object.getOwnPropertyDescriptor(kZ.prototype,"lineHeight"),kZ.prototype),Y(kZ.prototype,"spacingX",[fZ,pZ,dZ],Object.getOwnPropertyDescriptor(kZ.prototype,"spacingX"),kZ.prototype),Y(kZ.prototype,"overflow",[mZ,vZ,gZ],Object.getOwnPropertyDescriptor(kZ.prototype,"overflow"),kZ.prototype),Y(kZ.prototype,"enableWrapText",[yZ,SZ],Object.getOwnPropertyDescriptor(kZ.prototype,"enableWrapText"),kZ.prototype),Y(kZ.prototype,"font",[xZ,TZ,EZ,CZ],Object.getOwnPropertyDescriptor(kZ.prototype,"font"),kZ.prototype),Y(kZ.prototype,"useSystemFont",[bZ,AZ],Object.getOwnPropertyDescriptor(kZ.prototype,"useSystemFont"),kZ.prototype),Y(kZ.prototype,"cacheMode",[wZ,RZ,IZ],Object.getOwnPropertyDescriptor(kZ.prototype,"cacheMode"),kZ.prototype),Y(kZ.prototype,"isBold",[PZ,OZ],Object.getOwnPropertyDescriptor(kZ.prototype,"isBold"),kZ.prototype),Y(kZ.prototype,"isItalic",[DZ,MZ],Object.getOwnPropertyDescriptor(kZ.prototype,"isItalic"),kZ.prototype),Y(kZ.prototype,"isUnderline",[NZ,LZ],Object.getOwnPropertyDescriptor(kZ.prototype,"isUnderline"),kZ.prototype),Y(kZ.prototype,"underlineHeight",[BZ,El,FZ,zZ],Object.getOwnPropertyDescriptor(kZ.prototype,"underlineHeight"),kZ.prototype),GZ=Y(kZ.prototype,"_string",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),HZ=Y(kZ.prototype,"_horizontalAlign",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oJ.CENTER}}),VZ=Y(kZ.prototype,"_verticalAlign",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aJ.CENTER}}),jZ=Y(kZ.prototype,"_actualFontSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WZ=Y(kZ.prototype,"_fontSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),qZ=Y(kZ.prototype,"_fontFamily",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),XZ=Y(kZ.prototype,"_lineHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),YZ=Y(kZ.prototype,"_overflow",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sJ.NONE}}),KZ=Y(kZ.prototype,"_enableWrapText",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),QZ=Y(kZ.prototype,"_font",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZZ=Y(kZ.prototype,"_isSystemFontUsed",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JZ=Y(kZ.prototype,"_isItalic",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$Z=Y(kZ.prototype,"_isBold",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eJ=Y(kZ.prototype,"_isUnderline",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tJ=Y(kZ.prototype,"_underlineHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),nJ=Y(kZ.prototype,"_cacheMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cJ.NONE}}),UZ=kZ))||UZ)||UZ)||UZ)||UZ));!function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(uJ||(uJ={})),Je(uJ),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(hJ||(hJ={})),Je(hJ),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(_J||(_J={})),Je(_J);var pJ=Math.PI,dJ=Math.min,mJ=Math.max,vJ=Math.cos,gJ=Math.sin,yJ=Math.abs,SJ=Math.sign,xJ=.5522847493;function TJ(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*xJ,t-i*xJ,n+r,t,n+r),e.bezierCurveTo(t+i*xJ,n+r,t+i,n+r*xJ,t+i,n),e.bezierCurveTo(t+i,n-r*xJ,t+i*xJ,n-r,t,n-r),e.bezierCurveTo(t-i*xJ,n-r,t-i,n-r*xJ,t-i,n),e.close()}function EJ(e,t,n,i,r,o,a,s,c,l,u){var h,_,f,p,d,m,v,g,y,S,x,T,E,C,b,A;l>10||(d=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(t+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(p=.5*(r+a))),((b=yJ((i-s)*(C=c-n)-(r-c)*(E=s-t)))+(A=yJ((o-s)*C-(a-c)*E)))*(b+A)<e.tessTol*(E*E+C*C)?e.addPoint(s,c,0===u?u|_J.PT_BEVEL:u):(EJ(e,t,n,h,_,v,g,x=.5*(v+(y=.5*(f+d))),T=.5*(g+(S=.5*(p+m))),l+1,0),EJ(e,x,T,y,S,d,m,s,c,l+1,u)))}var CJ,bJ,AJ,wJ,RJ,IJ,PJ,OJ,DJ,MJ,NJ,LJ,BJ,FJ,zJ,UJ,kJ,GJ,HJ,VJ,jJ,WJ,qJ,XJ=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return z(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(Fi),YJ=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),KJ=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=mi.WHITE.clone(),this.lineCap=uJ.BUTT,this.strokeColor=mi.BLACK.clone(),this.lineJoin=hJ.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,_J.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,_J.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==o?(EJ(this,s.x,s.y,e,t,n,i,r,o,0,_J.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,o){!function(e,t,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,S=0,x=0,T=0;if(u=o-r,a=a||!1)if(yJ(u)>=2*pJ)u=2*pJ;else for(;u<0;)u+=2*pJ;else if(yJ(u)>=2*pJ)u=2*-pJ;else for(;u>0;)u-=2*pJ;for(c=0|mJ(1,dJ(yJ(u)/(.5*pJ)+.5,5)),h=yJ(4/3*(1-vJ(s=u/c/2))/gJ(s)),a||(h=-h),T=0;T<=c;T++)p=t+(_=vJ(l=r+u*(T/c)))*i,d=n+(f=gJ(l))*i,m=-f*i*h,v=_*i*h,0===T?e.moveTo(p,d):e.bezierCurveTo(g+S,y+x,p-m,d-v,p,d),g=p,y=d,S=m,x=v}(this,e,t,n,i,r,o)},t.ellipse=function(e,t,n,i){TJ(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){TJ(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,o){if(o<.1)e.rect(t,n,i,r);else{var a=dJ(o,.5*yJ(i))*SJ(i),s=dJ(o,.5*yJ(r))*SJ(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-xJ),t+a*(1-xJ),n+r,t+a,n+r),e.lineTo(t+i-a,n+r),e.bezierCurveTo(t+i-a*(1-xJ),n+r,t+i,n+r-s*(1-xJ),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-xJ),t+i-a*(1-xJ),n,t+i-a,n),e.lineTo(t+a,n),e.bezierCurveTo(t+a*(1-xJ),n,t,n+s*(1-xJ),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&pQ.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=pQ.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new XJ(e,t),r.push(a)),a.flags=n,o.push(a)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new YJ,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),QJ=[new Vo(lo.ATTR_POSITION,Cr.RGB32F)],ZJ=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_COLOR,Cr.RGBA32F)],JJ=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RG32F),new Vo(lo.ATTR_COLOR,Cr.RGBA32F)],$J=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RG32F),new Vo(lo.ATTR_COLOR,Cr.RGBA32F),new Vo(lo.ATTR_COLOR2,Cr.RGBA32F)];function e$(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=fa[i.format].count}return t}function t$(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=fa[i.format].size}return t}r.internal.vfmtPosUvColor=JJ,r.internal.vfmtPosUvTwoColor=$J,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:QJ,vfmtPosColor:ZJ,vfmtPosUvColor:JJ,vfmtPosUvTwoColor:$J,getComponentPerVertex:e$,getAttributeStride:t$}));var n$,i$,r$,o$,a$,s$,c$,l$,u$,h$,_$,f$,p$,d$,m$,v$,g$,y$,S$,x$,T$,E$,C$,b$,A$,w$,R$=ZJ.concat([new Vo("a_dist",Cr.R32F)]),I$=e$(R$),P$=t$(R$),O$=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((CJ=al("cc.Graphics"),bJ=Tl(),AJ=cl(110),wJ=gl(),RJ=wl(),IJ=Gl(hJ),PJ=wl(),OJ=Gl(uJ),DJ=wl(),MJ=wl(),NJ=wl(),LJ=wl(),BJ=Cl(),CJ(FJ=bJ(FJ=AJ(FJ=wJ((qJ=WJ=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,X(t,"_lineWidth",UJ,j(t)),X(t,"_strokeColor",kJ,j(t)),X(t,"_lineJoin",GJ,j(t)),X(t,"_lineCap",HJ,j(t)),X(t,"_fillColor",VJ,j(t)),X(t,"_miterLimit",jJ,j(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=qQ.ADD_COLOR,t.impl=new KJ,t}z(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=$M.root.createModel(og),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._sceneGetter=null,this.model&&($M.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,o){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,o)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,o){this.impl&&this.impl.arc(e,t,n,i,r,o)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=Hv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=r.director.root.device,n=t.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE,65535*P$,P$)),i=t.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new KA([n],R$,Kr.TRIANGLE_LIST,i);o.subMeshIdx=0,this.model.initSubModel(e,o,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(o)}}else b(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*I$);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indicesStart);o.indexBuffer.update(s),o.indexCount=r.indicesStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndices=r.indicesStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},B(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(lJ),WJ.LineJoin=hJ,WJ.LineCap=uJ,Y((zJ=qJ).prototype,"lineWidth",[El,RJ],Object.getOwnPropertyDescriptor(zJ.prototype,"lineWidth"),zJ.prototype),Y(zJ.prototype,"lineJoin",[IJ,PJ],Object.getOwnPropertyDescriptor(zJ.prototype,"lineJoin"),zJ.prototype),Y(zJ.prototype,"lineCap",[OJ,DJ],Object.getOwnPropertyDescriptor(zJ.prototype,"lineCap"),zJ.prototype),Y(zJ.prototype,"strokeColor",[MJ],Object.getOwnPropertyDescriptor(zJ.prototype,"strokeColor"),zJ.prototype),Y(zJ.prototype,"fillColor",[NJ],Object.getOwnPropertyDescriptor(zJ.prototype,"fillColor"),zJ.prototype),Y(zJ.prototype,"miterLimit",[LJ],Object.getOwnPropertyDescriptor(zJ.prototype,"miterLimit"),zJ.prototype),Y(zJ.prototype,"color",[Zl,BJ],Object.getOwnPropertyDescriptor(zJ.prototype,"color"),zJ.prototype),UJ=Y(zJ.prototype,"_lineWidth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kJ=Y(zJ.prototype,"_strokeColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.BLACK.clone()}}),GJ=Y(zJ.prototype,"_lineJoin",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hJ.MITER}}),HJ=Y(zJ.prototype,"_lineCap",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uJ.BUTT}}),VJ=Y(zJ.prototype,"_fillColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),jJ=Y(zJ.prototype,"_miterLimit",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),FJ=zJ))||FJ)||FJ)||FJ)||FJ)),D$=new Mi,M$=new Fi,N$=new Mi,L$=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(w$||(w$={})),Je(w$);var B$=function(t){return e({Mask:t,MaskComponent:t}),t}((n$=al("cc.Mask"),i$=Tl(),r$=cl(110),o$=gl(),a$=Gl(w$),s$=Ml(),c$=wl(),l$=Ml(),u$=wl(),h$=Cl(),_$=Gl(oK),f$=Cl(),p$=Cl(),d$=Rl(),m$=Cl(),v$=Cl(),n$(g$=i$(g$=r$(g$=o$((A$=b$=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,X(t,"_type",S$,j(t)),X(t,"_inverted",x$,j(t)),X(t,"_segments",T$,j(t)),X(t,"_spriteFrame",E$,j(t)),X(t,"_alphaThreshold",C$,j(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=qQ.ADD_COLOR,t}z(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._clearModel&&this._clearModelMesh&&($M.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,o=M$;this.node.getWorldMatrix(D$),Mi.invert(N$,D$),Fi.transformMat4(o,e,N$);var a=t.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===w$.RECT||this.type===w$.GRAPHICS_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===w$.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==w$.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new O$;e._objFlags|=Kt.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=mi.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===w$.RECT||this._type===w$.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,o=e.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===w$.RECT)t.rect(a,s,i,r);else if(this._type===w$.ELLIPSE){for(var c=function(e,t,n){L$.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)L$.push(new gi(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return L$}(new gi(a+i/2,s+r/2,0),new gi(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=Hv.get("default-clear-stencil");this._clearStencilMtl=new Kg({parent:e,owner:this,subModelIdx:0}),this._clearModel=$M.root.createModel(og),this._clearModel.node=this._clearModel.transform=this.node;var t=t$(QJ),n=r.director.root.device,i=n.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE,4*t,t)),o=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(o);var a=n.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),s=new Uint16Array([0,1,2,2,1,3]);a.update(s),this._clearModelMesh=new KA([i],QJ,Kr.TRIANGLE_LIST,a),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=iQ.DISABLED,this._type===w$.IMAGE_STENCIL?(e=Hv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=Hv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==w$.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},B(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==w$.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=iQ.DISABLED,this._graphics&&(this._graphics.stencilStage=iQ.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=Zn(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===w$.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===w$.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(lJ),b$.Type=w$,Y((y$=A$).prototype,"type",[a$,s$,c$],Object.getOwnPropertyDescriptor(y$.prototype,"type"),y$.prototype),Y(y$.prototype,"inverted",[l$,u$],Object.getOwnPropertyDescriptor(y$.prototype,"inverted"),y$.prototype),Y(y$.prototype,"segments",[h$],Object.getOwnPropertyDescriptor(y$.prototype,"segments"),y$.prototype),Y(y$.prototype,"spriteFrame",[_$,f$],Object.getOwnPropertyDescriptor(y$.prototype,"spriteFrame"),y$.prototype),Y(y$.prototype,"alphaThreshold",[p$,d$,Dl],Object.getOwnPropertyDescriptor(y$.prototype,"alphaThreshold"),y$.prototype),Y(y$.prototype,"color",[Zl,m$],Object.getOwnPropertyDescriptor(y$.prototype,"color"),y$.prototype),Y(y$.prototype,"customMaterial",[Zl,v$],Object.getOwnPropertyDescriptor(y$.prototype,"customMaterial"),y$.prototype),S$=Y(y$.prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w$.RECT}}),x$=Y(y$.prototype,"_inverted",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T$=Y(y$.prototype,"_segments",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),E$=Y(y$.prototype,"_spriteFrame",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),C$=Y(y$.prototype,"_alphaThreshold",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),g$=y$))||g$)||g$)||g$)||g$));BP._maskComp=B$,r.Mask=B$;var F$,z$,U$,k$,G$,H$,V$,j$,W$,q$,X$,Y$,K$,Q$,Z$,J$,$$,e0,t0,n0,i0,r0,o0,a0,s0,c0,l0,u0,h0,_0,f0,p0,d0,m0,v0,g0,y0,S0,x0,T0,E0,C0,b0,A0,w0,R0,I0,P0,O0,D0,M0,N0,L0,B0,F0,z0,U0,k0,G0,H0,V0=/^(click)(\s)*=|(param)(\s)*=/,j0=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,W0=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var o=e.substring(t,r),a=e.substring(r+1,i);""===a&&(o=e.substring(t,i+1)),this._processResult(o),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,o="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(o=e.substring(r+1).trim(),t.event=this._processEventHandler(o)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=j0.exec(e);for(var c=!1;n;){if(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}t.isImage=!0,t.src=s}else if("height"===i)t.imageHeight=parseInt(s);else if("width"===i)t.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}t.imageAlign=s.toLowerCase()}else"offset"===i?t.imageOffset=s:"click"===i&&(t.event=this._processEventHandler(i+"="+s));t.event&&"param"===i&&(t.event[i]=s.replace(/^"|"$/g,"")),n=j0.exec(e)}return c&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var l={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),t.event&&"param"===i&&(t.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(e)}t.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=V0.exec(e);r;){var o=r[0],a="";if(i=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(a=s?s[0]:"").length}i&&(t[o=o.substring(0,o.length-1).trim()]=a),e=e.substring(n).trim(),r=V0.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=q(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],o=i[1];e=e.replace(r,o)}return e},e}()),q0=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((F$=al("cc.LabelOutline"),z$=Tl(),U$=cl(110),k$=gl(),G$=sl(fJ),H$=wl(),V$=wl(),F$(j$=z$(j$=U$(j$=k$(j$=G$(j$=vl((Y$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_color",q$,j(t)),X(t,"_width",X$,j(t)),t}z(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(fJ);e&&e.updateRenderData(!0)},B(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(rh),q$=Y((W$=Y$).prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(0,0,0,255)}}),X$=Y(W$.prototype,"_width",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Y(W$.prototype,"color",[H$],Object.getOwnPropertyDescriptor(W$.prototype,"color"),W$.prototype),Y(W$.prototype,"width",[V$],Object.getOwnPropertyDescriptor(W$.prototype,"width"),W$.prototype),j$=W$))||j$)||j$)||j$)||j$)||j$)||j$));!function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(U0||(U0={})),Je(U0),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(k0||(k0={})),Je(k0),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(G0||(G0={})),Je(G0),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(H0||(H0={}));var X0,Y0,K0,Q0,Z0,J0,$0,e1,t1,n1,i1,r1,o1,a1,s1=function(t){return e({Sprite:t,SpriteComponent:t}),t}((K$=al("cc.Sprite"),Q$=Tl(),Z$=cl(110),J$=gl(),$$=Gl(Mg),e0=Ml(),t0=Al(),n0=Gl(sK),i0=Ml(),r0=wl(),o0=Gl(oK),a0=Ml(),s0=wl(),c0=Gl(U0),l0=Ml(),u0=wl(),h0=Gl(k0),_0=wl(),f0=wl(),p0=Rl(),d0=wl(),m0=Rl(),v0=wl(),g0=Cl(),y0=Ml(),S0=wl(),x0=wl(),T0=Gl(G0),E0=Ml(),C0=wl(),K$(b0=Q$(b0=Z$(b0=J$((z0=F0=function(e){function t(){var t;return X(t=e.call(this)||this,"_spriteFrame",w0,j(t)),X(t,"_type",R0,j(t)),X(t,"_fillType",I0,j(t)),X(t,"_sizeMode",P0,j(t)),X(t,"_fillCenter",O0,j(t)),X(t,"_fillStart",D0,j(t)),X(t,"_fillRange",M0,j(t)),X(t,"_isTrimmedMode",N0,j(t)),X(t,"_useGrayscale",L0,j(t)),X(t,"_atlas",B0,j(t)),t}z(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial(),this._markForUpdateUvDirty()},n.onDestroy=function(){this.destroyRenderData(),e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof km){var i=e.getPixelFormat();n=i===cm.RGBA_ETC1||i===cm.RGB_A_PVRTC_4BPPV1||i===cm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=qQ.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=qQ.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=qQ.GRAYSCALE:this._instanceMaterialType=qQ.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof CT){var n=F({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new Mg;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(G0.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(G0.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._applySpriteFrame=function(e){var t=this._spriteFrame;this._renderData&&(this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty);var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize())},n._markForUpdateUvDirty=function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)},n._calculateSlicedData=function(e){var t=this.node._uiProps.uiTransformComp.contentSize,n=t.width,i=t.height,r=this.spriteFrame.insetLeft,o=n-r-this.spriteFrame.insetRight,a=this.spriteFrame.insetTop,s=i-a-this.spriteFrame.insetBottom;return e.length=0,e[0]=r/n,e[1]=a/i,e[2]=(r+o)/n,e[3]=(a+s)/i,e},n.calculateTiledData=function(e){var t=this.node._uiProps.uiTransformComp.contentSize,n=this.spriteFrame.rect;e.x=t.width/n.width,e.y=t.height/n.height},n._updateUVWithTrim=function(){this.tillingOffsetWithTrim.length=0;var e=this.spriteFrame,t=e.originalSize,n=e.rect,i=e.texture,r=i.width,o=i.height,a=0,s=0;e.original&&(a=n.x-e.original._x,s=n.y-e.original._y);var c=0===r?0:a/r,l=0===r?1:(a+t.width)/r,u=0===o?1:(s+t.height)/o,h=0===o?0:s/o;e.rotated&&(c=0===r?0:a/r,l=0===r?1:(a+t.height)/r,h=0===o?0:s/o,u=0===o?1:(s+t.width)/o),this.tillingOffsetWithTrim[0]=l-c,this.tillingOffsetWithTrim[1]=u-h,this.tillingOffsetWithTrim[2]=c,this.tillingOffsetWithTrim[3]=h,e.rotated&&(this.tillingOffsetWithTrim[0]=-this.tillingOffsetWithTrim[0])},B(t,[{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===k0.RADIAL||this._fillType===k0.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===U0.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=Zn(e,0,1),this._type===U0.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=Zn(e,-1,1),this._type===U0.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===U0.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?qQ.GRAYSCALE:qQ.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==G0.CUSTOM&&this._applySpriteSize())}}]),t}(lJ),F0.FillType=k0,F0.Type=U0,F0.SizeMode=G0,F0.EventType=H0,Y((A0=z0).prototype,"customMaterial",[$$,e0,t0,Zl],Object.getOwnPropertyDescriptor(A0.prototype,"customMaterial"),A0.prototype),Y(A0.prototype,"spriteAtlas",[n0,i0,r0],Object.getOwnPropertyDescriptor(A0.prototype,"spriteAtlas"),A0.prototype),Y(A0.prototype,"spriteFrame",[o0,a0,s0],Object.getOwnPropertyDescriptor(A0.prototype,"spriteFrame"),A0.prototype),Y(A0.prototype,"type",[c0,l0,u0],Object.getOwnPropertyDescriptor(A0.prototype,"type"),A0.prototype),Y(A0.prototype,"fillType",[h0,_0],Object.getOwnPropertyDescriptor(A0.prototype,"fillType"),A0.prototype),Y(A0.prototype,"fillCenter",[f0],Object.getOwnPropertyDescriptor(A0.prototype,"fillCenter"),A0.prototype),Y(A0.prototype,"fillStart",[p0,d0],Object.getOwnPropertyDescriptor(A0.prototype,"fillStart"),A0.prototype),Y(A0.prototype,"fillRange",[m0,v0],Object.getOwnPropertyDescriptor(A0.prototype,"fillRange"),A0.prototype),Y(A0.prototype,"trim",[g0,y0,S0],Object.getOwnPropertyDescriptor(A0.prototype,"trim"),A0.prototype),Y(A0.prototype,"grayscale",[El,x0],Object.getOwnPropertyDescriptor(A0.prototype,"grayscale"),A0.prototype),Y(A0.prototype,"sizeMode",[T0,E0,C0],Object.getOwnPropertyDescriptor(A0.prototype,"sizeMode"),A0.prototype),w0=Y(A0.prototype,"_spriteFrame",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R0=Y(A0.prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U0.SIMPLE}}),I0=Y(A0.prototype,"_fillType",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k0.HORIZONTAL}}),P0=Y(A0.prototype,"_sizeMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G0.TRIMMED}}),O0=Y(A0.prototype,"_fillCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0)}}),D0=Y(A0.prototype,"_fillStart",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),M0=Y(A0.prototype,"_fillRange",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),N0=Y(A0.prototype,"_isTrimmedMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),L0=Y(A0.prototype,"_useGrayscale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B0=Y(A0.prototype,"_atlas",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b0=A0))||b0)||b0)||b0)||b0)),c1=e("RenderRoot2D",al("cc.RenderRoot2D")(X0=cl(100)(X0=gl()(X0=sl(AQ)(X0=ll(X0=vl(X0=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.onEnable=function(){r.director.root.batcher2D.addScreen(this)},n.onDisable=function(){r.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){r.director.root.batcher2D.removeScreen(this)},t}(rh))||X0)||X0)||X0)||X0)||X0)||X0),l1=new gi,u1=Ke({OVERLAY:0,INTERSPERSE:1}),h1=function(t){return e({Canvas:t,CanvasComponent:t}),t}((Y0=al("cc.Canvas"),K0=Tl(),Q0=cl(100),Z0=gl(),J0=Gl(fF),$0=wl(),e1=wl(),t1=Gl(fF),Y0(n1=K0(n1=Q0(n1=Z0(n1=vl(n1=ll((Y((i1=function(e){function t(){var t;return X(t=e.call(this)||this,"_cameraComponent",r1,j(t)),X(t,"_alignCanvasWithScreen",o1,j(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new gi,t._renderMode=u1.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(j(t)),t}z(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(fF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(ZE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(fF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(fF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(ZE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=nN.height/2;else{var e=fh.windowSize;this._cameraComponent.orthoHeight=e.height/lN.getScaleY()/2}this.node.getWorldPosition(l1),this._cameraComponent.node.setWorldPosition(l1.x,l1.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===u1.OVERLAY?t|1<<30:t&~(1<<30)}return 0},B(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(c1)).prototype,"cameraComponent",[J0,$0],Object.getOwnPropertyDescriptor(i1.prototype,"cameraComponent"),i1.prototype),Y(i1.prototype,"alignCanvasWithScreen",[e1],Object.getOwnPropertyDescriptor(i1.prototype,"alignCanvasWithScreen"),i1.prototype),r1=Y(i1.prototype,"_cameraComponent",[t1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),o1=Y(i1.prototype,"_alignCanvasWithScreen",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n1=i1))||n1)||n1)||n1)||n1)||n1)||n1));r.Canvas=h1;var _1,f1,p1,d1,m1,v1,g1,y1,S1,x1,T1,E1,C1,b1,A1,w1,R1,I1,P1,O1,D1,M1,N1,L1,B1,F1,z1,U1,k1,G1,H1,V1,j1,W1,q1,X1=e("UIComponent",al("cc.UIComponent")(a1=sl(AQ)(a1=cl(110)(a1=ll(a1=vl(a1=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=iQ.DISABLED,t}z(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(rh))||a1)||a1)||a1)||a1)||a1);zn(X1.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),Fn(h1.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:mi.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),Un(lJ.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),Un(AQ.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),r.UITransformComponent=AQ,He.setClassAlias(AQ,"cc.UITransformComponent"),He.setClassAlias(lJ,"cc.RenderComponent"),r.CanvasComponent=h1,He.setClassAlias(h1,"cc.CanvasComponent");var Y1=new W0,K1="RICHTEXT_CHILD",Q1="RICHTEXT_Image_CHILD",Z1=new ke((function(e){if(!r.isValid(e.node))return!1;var t=e.node.getComponent(q0);return t&&(t.width=0),!0}),20),J1=new ke((function(e){return r.isValid(e.node)}),10);function $1(e){return{node:new $b(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function e2(e,t){var n;e===K1?n=Z1._get():e===Q1&&(n=J1._get());var i=(n=n||$1(e)).node;return i||(i=new $b(e)),i.hideFlags|=Kt.Flags.DontSave|Kt.Flags.HideInHierarchy,e===Q1?(n.comp=i.getComponent(s1)||i.addComponent(s1),n.comp.spriteFrame=t,n.comp.type=s1.Type.SLICED,n.comp.sizeMode=s1.SizeMode.CUSTOM):(n.comp=i.getComponent(fJ)||i.addComponent(fJ),n.comp.string=t,n.comp.horizontalAlign=oJ.LEFT,n.comp.verticalAlign=aJ.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var t2,n2=function(t){return e({RichText:t,RichTextComponent:t}),t}((_1=al("cc.RichText"),f1=Tl(),p1=cl(110),d1=gl(),m1=wl(),v1=Gl(oJ),g1=wl(),y1=wl(),S1=wl(),x1=Gl(_K),T1=wl(),E1=wl(),C1=Gl(cJ),b1=wl(),A1=wl(),w1=wl(),R1=Gl(sK),I1=wl(),P1=wl(),_1(O1=f1(O1=p1(O1=d1(O1=vl((q1=W1=function(e){function t(){var t;return X(t=e.call(this)||this,"_lineHeight",M1,j(t)),X(t,"_string",N1,j(t)),X(t,"_horizontalAlign",L1,j(t)),X(t,"_fontSize",B1,j(t)),X(t,"_maxWidth",F1,j(t)),X(t,"_fontFamily",z1,j(t)),X(t,"_font",U1,j(t)),X(t,"_isSystemFontUsed",k1,j(t)),X(t,"_userDefinedFont",G1,j(t)),X(t,"_cacheMode",H1,j(t)),X(t,"_imageAtlas",V1,j(t)),X(t,"_handleTouchEvent",j1,j(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._updateRichTextStatus=t._updateRichText,t}z(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(ZE.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(ZE.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=q(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===K1?Z1.put(n):n.type===Q1&&J1.put(n)}this.node.off(ZE.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(ZE.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(ZE.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(ZE.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return e2(K1,e)},n._createImage=function(e){return e2(Q1,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(e,t){var n=this,i=function(t){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(t),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(fJ).string=t,i.styleIndex=e,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return t?i(t):i},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(rh),r=function(){var r=t.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[o];t.enabledInHierarchy&&n&&n.call(t,e,a)})),e.propagationStopped=!0)},o=q(this._segments);!(t=o()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(AQ);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===K1||n.name===Q1){n.parent===this.node?n.parent=null:e.splice(t,1);var i=$1(n.name);i.node=n,n.name===K1?(i.comp=n.getComponent(fJ),Z1.put(i)):(i.comp=n.getComponent(s1),J1.put(i))}}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==K1&&n.name!==Q1||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(fJ);i&&(i.string=e)}return n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(e,r,e.length),a=e.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=HK(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else b(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=Y1.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+RK)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(zK(i)||UK(i))return 1;for(var r=1,o=t+1;o<n&&!UK(i=e.charAt(o))&&!zK(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case oJ.LEFT:break;case oJ.CENTER:l-=this._linesWidth[c-1]/2;break;case oJ.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(s1)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+RK);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var p=s.imageOffset.split(",");if(1===p.length&&p[0]){var d=parseFloat(p[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===p.length){var m=parseFloat(p[0]),v=parseFloat(p[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(q0);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return mi[t]?mi[t]:(new mi).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(fJ);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(q0);r||(r=e.node.addComponent(q0)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var o=n.event;o&&(e.clickHandler=o.click||"",e.clickParam=o.param||"")}t.cacheMode=this._cacheMode,this._font instanceof _K&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var a=t._assembler;a&&a.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=q(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=mi.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},B(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(X1),W1.HorizontalAlign=oJ,W1.VerticalAlign=aJ,Y((D1=q1).prototype,"string",[Ll,m1],Object.getOwnPropertyDescriptor(D1.prototype,"string"),D1.prototype),Y(D1.prototype,"horizontalAlign",[v1,g1],Object.getOwnPropertyDescriptor(D1.prototype,"horizontalAlign"),D1.prototype),Y(D1.prototype,"fontSize",[y1],Object.getOwnPropertyDescriptor(D1.prototype,"fontSize"),D1.prototype),Y(D1.prototype,"fontFamily",[S1],Object.getOwnPropertyDescriptor(D1.prototype,"fontFamily"),D1.prototype),Y(D1.prototype,"font",[x1,T1],Object.getOwnPropertyDescriptor(D1.prototype,"font"),D1.prototype),Y(D1.prototype,"useSystemFont",[E1],Object.getOwnPropertyDescriptor(D1.prototype,"useSystemFont"),D1.prototype),Y(D1.prototype,"cacheMode",[C1,b1],Object.getOwnPropertyDescriptor(D1.prototype,"cacheMode"),D1.prototype),Y(D1.prototype,"maxWidth",[A1],Object.getOwnPropertyDescriptor(D1.prototype,"maxWidth"),D1.prototype),Y(D1.prototype,"lineHeight",[w1],Object.getOwnPropertyDescriptor(D1.prototype,"lineHeight"),D1.prototype),Y(D1.prototype,"imageAtlas",[R1,I1],Object.getOwnPropertyDescriptor(D1.prototype,"imageAtlas"),D1.prototype),Y(D1.prototype,"handleTouchEvent",[P1],Object.getOwnPropertyDescriptor(D1.prototype,"handleTouchEvent"),D1.prototype),M1=Y(D1.prototype,"_lineHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),N1=Y(D1.prototype,"_string",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),L1=Y(D1.prototype,"_horizontalAlign",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oJ.LEFT}}),B1=Y(D1.prototype,"_fontSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),F1=Y(D1.prototype,"_maxWidth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),z1=Y(D1.prototype,"_fontFamily",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),U1=Y(D1.prototype,"_font",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),k1=Y(D1.prototype,"_isSystemFontUsed",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),G1=Y(D1.prototype,"_userDefinedFont",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H1=Y(D1.prototype,"_cacheMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cJ.NONE}}),V1=Y(D1.prototype,"_imageAtlas",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j1=Y(D1.prototype,"_handleTouchEvent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),O1=D1))||O1)||O1)||O1)||O1)||O1)),i2=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(al("cc.UIMeshRenderer")(t2=Tl()(t2=cl(110)(t2=gl()(t2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._models=null,t._modelComponent=null,t}z(t,e);var n=t.prototype;return n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onEnable=function(){e.prototype.onEnable.call(this)},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(e){if(this._models){this._modelComponent._detachFromScene();for(var t,n=q(this._models);!(t=n()).done;){var i=t.value;e.commitModel.call(e,this,i,this._modelComponent.material)}return!0}return!1},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=Hp.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},B(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(X1))||t2)||t2)||t2)||t2),r2=e("MeshBuffer",function(e){function t(t){var n;return(n=e.call(this)||this).vData=null,n.iData=null,n.byteStart=0,n.byteOffset=0,n.indicesStart=0,n.indicesOffset=0,n.vertexStart=0,n.vertexOffset=0,n.lastByteOffset=1,n._attributes=null,n._vertexBuffers=[],n._indexBuffer=null,n._iaInfo=null,n._batcher=void 0,n._dirty=!1,n._vertexFormatBytes=0,n._initVDataCount=0,n._initIDataCount=1536,n._outOfCallback=null,n._hInputAssemblers=[],n._nextFreeIAHandle=0,n._lastUsedVDataSize=0,n._lastUsedIDataSize=0,n._batcher=t,n}z(t,e);var n=t.prototype;return n.initialize=function(e,t){this._outOfCallback=t;var n=e$(e);this._vertexFormatBytes=n*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;var i=Float32Array.BYTES_PER_ELEMENT*n;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,i,i)));var r=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,r,r))),this._attributes=e,this._iaInfo=new Wo(this.attributes,this.vertexBuffers,this.indexBuffer),this.vData&&this.iData||this._reallocBuffer()},n.request=function(e,t){void 0===e&&(e=4),void 0===t&&(t=6),this.lastByteOffset=this.byteOffset;var n=this.byteOffset+e*this._vertexFormatBytes,i=this.indicesOffset+t;if(e+this.vertexOffset>65535)return this._outOfCallback&&this._outOfCallback.call(this._batcher,e,t),!1;var r=this.vData.byteLength,o=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indicesOffset+=t,this.byteOffset=n,this._dirty=!0,!0},n.reset=function(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1},n.tryShrink=function(){if(!this._dirty&&this.vData&&this.iData&&this.vData.byteLength>>2>this._lastUsedVDataSize&&this.iData.length>>2>this._lastUsedIDataSize){var e=Math.max(256*this._vertexFormatBytes,this._initVDataCount>>1),t=Math.max(1536,this._initIDataCount>>1);e===this._initVDataCount&&t===this._initIDataCount||(this._initIDataCount=t,this._initVDataCount=e,this._reallocBuffer())}},n.destroy=function(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(var t=0;t<this._hInputAssemblers.length;t++)this._hInputAssemblers[t].destroy();this._hInputAssemblers.length=0,e.prototype.destroy.call(this)},n.recordBatch=function(){var e=this.indicesOffset-this.indicesStart;if(!e)return null;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(this._batcher.device.createInputAssembler(this._iaInfo));var t=this._hInputAssemblers[this._nextFreeIAHandle++];return t.firstIndex=this.indicesStart,t.indexCount=e,t},n.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(e),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(t),this._lastUsedVDataSize=this.byteOffset,this._lastUsedIDataSize=this.indicesOffset,this._dirty=!1}},n._reallocBuffer=function(){this._reallocVData(!0),this._reallocIData(!0)},n._reallocVData=function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var n=new Uint8Array(this.vData.buffer),i=0,r=t.length;i<r;i++)n[i]=t[i]},n._reallocIData=function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var n=this.iData,i=0,r=t.length;i<r;i++)n[i]=t[i]},B(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),t}(je));r2.OPACITY_OFFSET=8;var o2,a2,s2,c2,l2,u2,h2,_2,f2,p2,d2,m2,v2,g2,y2,S2,x2,T2,E2,C2,b2,A2,w2,R2,I2,P2,O2,D2,M2,N2=kp.Enum.NONE|kp.Enum.UI_3D,L2=e("UIDrawBatch",function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=N2,this._inputAssember=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=N2,this.renderScene=null},t.fillPasses=function(e,t,n,i,o,a){if(e){var s=e.passes;if(!s)return;var c=0;this._shaders.length=s.length;for(var l=0;l<s.length;l++){this._passes[l]||(this._passes[l]=new Kv(r.director.root));var u=s[l],h=this._passes[l];u.update(),t||(t=u.depthStencilState,n=0),i||(i=u.blendState,o=0),-1===o&&(o=0),c=n<<16|o,h._initPassFromTarget(u,t,i,c),this._shaders[l]=h.getShaderVariant(a)}}},B(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssember},set:function(e){this._inputAssember=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}()),B2=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((o2=al("cc.UIStaticBatch"),a2=Tl(),s2=gl(),c2=cl(110),l2=Cl(),o2(u2=a2(u2=s2(u2=c2((Y((h2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._meshBuffer=null,t._dirty=!0,t._lastMeshBuffer=null,t._uiDrawBatchList=[],t}z(t,e);var n=t.prototype;return n.onLoad=function(){var e=this._getBatcher();if(e){var t=JJ,n=new r2(e);n.initialize(t,this._arrivalMaxBuffer.bind(this)),this._meshBuffer=n}},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)},n.updateAssembler=function(e){e.currIsStatic=!0,this._dirty&&(e.finishMergeBatches(),this._lastMeshBuffer=e.currBufferBatch,e.currBufferBatch=this._meshBuffer,e.currStaticRoot=this),this._init&&(e.finishMergeBatches(),e.commitStaticBatch(this))},n.postUpdateAssembler=function(e){this._dirty&&(e.finishMergeBatches(),e.currBufferBatch=this._lastMeshBuffer,e.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadBuffers()),e.currIsStatic=!1},n.markAsDirty=function(){this._getBatcher()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())},n._requireDrawBatch=function(){var e=new L2;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._meshBuffer){this._meshBuffer.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return $M.root&&$M.root.batcher2D?$M.root.batcher2D:(b(9301),null)},n._arrivalMaxBuffer=function(){var e=this._getBatcher();e&&e.autoMergeBatches(),b(9300)},B(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(lJ)).prototype,"color",[Zl,l2],Object.getOwnPropertyDescriptor(h2.prototype,"color"),h2.prototype),u2=h2))||u2)||u2)||u2)||u2)),F2=e("LabelShadow",(_2=al("cc.LabelShadow"),f2=Tl(),p2=cl(110),d2=gl(),m2=sl(fJ),v2=wl(),g2=wl(),y2=wl(),_2(S2=f2(S2=p2(S2=d2(S2=m2(S2=vl((b2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_color",T2,j(t)),X(t,"_offset",E2,j(t)),X(t,"_blur",C2,j(t)),t}z(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(fJ);e&&e.updateRenderData(!0)},B(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(rh),T2=Y((x2=b2).prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(0,0,0,255)}}),E2=Y(x2.prototype,"_offset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(2,2)}}),C2=Y(x2.prototype,"_blur",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Y(x2.prototype,"color",[v2],Object.getOwnPropertyDescriptor(x2.prototype,"color"),x2.prototype),Y(x2.prototype,"offset",[g2],Object.getOwnPropertyDescriptor(x2.prototype,"offset"),x2.prototype),Y(x2.prototype,"blur",[y2],Object.getOwnPropertyDescriptor(x2.prototype,"blur"),x2.prototype),S2=x2))||S2)||S2)||S2)||S2)||S2)||S2)),z2=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}((A2=al("cc.UIOpacity"),w2=Tl(),R2=cl(110),I2=gl(),P2=wl(),A2(O2=w2(O2=R2(O2=I2(O2=vl((Y((D2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_opacity",M2,j(t)),t}z(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},B(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=_t(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(rh)).prototype,"opacity",[El,P2],Object.getOwnPropertyDescriptor(D2.prototype,"opacity"),D2.prototype),M2=Y(D2.prototype,"_opacity",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),O2=D2))||O2)||O2)||O2)||O2)||O2));r.MaskComponent=B$,He.setClassAlias(B$,"cc.MaskComponent"),r.LabelComponent=fJ,He.setClassAlias(fJ,"cc.LabelComponent"),r.LabelOutlineComponent=q0,He.setClassAlias(q0,"cc.LabelOutlineComponent"),r.RichTextComponent=n2,He.setClassAlias(n2,"cc.RichTextComponent"),r.SpriteComponent=s1,He.setClassAlias(s1,"cc.SpriteComponent"),r.UIModelComponent=i2,He.setClassAlias(i2,"cc.UIModelComponent"),r.GraphicsComponent=O$,He.setClassAlias(O$,"cc.GraphicsComponent"),He.setClassAlias(B2,"cc.UIStaticBatchComponent"),He.setClassAlias(z2,"cc.UIOpacityComponent");var U2=function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n};function k2(e,t,n,i,r){var o=0,a=null;if(r===function(e,t,n,i){for(var r=0,o=t,a=n-i;o<n;o+=i)r+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return r}(e,t,n,i)>0)for(o=t;o<n;o+=i)a=r4(o,e[o],e[o+1],a);else for(o=n-i;o>=t;o-=i)a=r4(o,e[o],e[o+1],a);return a&&e4(a,a.next)&&(o4(a),a=a.next),a}function G2(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!e4(n,n.next)&&0!==$2(n.prev,n,n.next))n=n.next;else{if(o4(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function H2(e,t,n,i,r,o,a){if(void 0===a&&(a=0),e){!a&&o&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=K2(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(e,i,r,o);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,o?j2(e,i,r,o):V2(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),o4(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?H2(e=W2(e,t,n),t,n,i,r,o,2):2===a&&q2(e,t,n,i,r,o):H2(G2(e),t,n,i,r,o,1);break}}}function V2(e){var t=e.prev,n=e,i=e.next;if($2(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(Z2(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&$2(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function j2(e,t,n,i){var r=e.prev,o=e,a=e.next;if($2(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=K2(s,c,t,n,i),_=K2(l,u,t,n,i),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&Z2(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&$2(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&Z2(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&$2(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function W2(e,t,n){var i=e;do{var r=i.prev,o=i.next.next;!e4(r,o)&&t4(r,i,i.next,o)&&n4(r,o)&&n4(o,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(o.i/n),o4(i),o4(i.next),i=e=o),i=i.next}while(i!==e);return i}function q2(e,t,n,i,r,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&J2(a,s)){var c=i4(a,s);return a=G2(a,a.next),c=G2(c,c.next),H2(a,t,n,i,r,o),void H2(c,t,n,i,r,o)}s=s.next}a=a.next}while(a!==e)}function X2(e,t){return e.x-t.x}function Y2(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&Z2(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&n4(n,e)&&(a=n,_=c),n=n.next;return a}(e,t)){var n=i4(t,e);G2(n,n.next)}}function K2(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Q2(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function Z2(e,t,n,i,r,o,a,s){return(r-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(i-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function J2(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&t4(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&n4(e,t)&&n4(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function $2(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function e4(e,t){return e.x===t.x&&e.y===t.y}function t4(e,t,n,i){return!!(e4(e,t)&&e4(n,i)||e4(e,i)&&e4(n,t))||$2(e,t,n)>0!=$2(e,t,i)>0&&$2(n,i,e)>0!=$2(n,i,t)>0}function n4(e,t){return $2(e.prev,e,e.next)<0?$2(e,t,e.next)>=0&&$2(e,e.prev,t)>=0:$2(e,t,e.prev)<0||$2(e,e.next,t)<0}function i4(e,t){var n=new U2(e.i,e.x,e.y),i=new U2(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function r4(e,t,n,i){var r=new U2(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function o4(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function a4(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,o=k2(e,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(e,t,n,i){var r,o=[],a=0,s=null;for(a=0,r=t.length;a<r;a++)(s=k2(e,t[a]*i,a<r-1?t[a+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(Q2(s)));if(o.sort(X2),!n)return n;for(a=0;a<o.length;a++)Y2(o[a],n),n=G2(n,n.next);return n}(e,t,o,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var p=n;p<r;p+=n)(h=e[p])<s&&(s=h),(_=e[p+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return H2(o,a,n,s,c,f),a}for(var s4=Math.PI,c4=Math.min,l4=Math.max,u4=Math.ceil,h4=Math.acos,_4=Math.cos,f4=Math.sin,p4=Math.atan2,d4=null,m4=null,v4=new mi,g4=[],y4=0;y4<4;y4++)g4.push(new gi);function S4(e,t,n){return e<t?t:e>n?n:e}var x4={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!m4)return null;var n=m4.getRenderDataList(),i=n[m4.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+t:0;return(o>65535||3*o>131070)&&(++m4.dataOffset,m4.dataOffset<n.length?i=n[m4.dataOffset]:(i=m4.requestRenderData(),n[m4.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(t,3*t),i},stroke:function(e){mi.copy(v4,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){mi.copy(v4,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t=.5*e.lineWidth,n=e.lineCap,i=e.lineJoin,r=e.miterLimit;if(m4=e.impl){var o=function(e,t,n){var i=2*h4(e/(e+n));return l4(2,u4(t/i))}(t,s4,m4.tessTol);this._calculateJoins(m4,t,i,r);for(var a=m4.paths,s=0,c=m4.pathOffset,l=m4.pathLength;c<l;c++){var u=a[c],h=u.points.length;i===hJ.ROUND?s+=2*(h+u.bevel*(o+2)+1):s+=2*(h+5*u.bevel+1),u.closed||(n===uJ.ROUND?s+=2*(2*o+2):s+=12)}var _=d4=this.getRenderData(e,s);if(_){for(var f=_.vData,p=_.iData,d=m4.pathOffset,m=m4.pathLength;d<m;d++){var v=a[d],g=v.points,y=g.length,S=_.vertexStart,x=void 0,T=void 0,E=0,C=0,b=v.closed;if(b?(x=g[y-1],T=g[0],E=0,C=y):(x=g[0],T=g[1],E=1,C=y-1),T=T||x,!b){var A=new XJ(T.x,T.y);A.subtract(x),A.normalize();var w=A.x,R=A.y;n===uJ.BUTT?this._buttCapStart(x,w,R,t,0):n===uJ.SQUARE?this._buttCapStart(x,w,R,t,t):n===uJ.ROUND&&this._roundCapStart(x,w,R,t,o)}for(var I=E;I<C;++I)i===hJ.ROUND?this._roundJoin(x,T,t,t,o):0!=(T.flags&(_J.PT_BEVEL|_J.PT_INNERBEVEL))?this._bevelJoin(x,T,t,t):(this._vSet(T.x+T.dmx*t,T.y+T.dmy*t,1),this._vSet(T.x-T.dmx*t,T.y-T.dmy*t,-1)),x=T,T=g[I+1];if(b){var P=8*S;this._vSet(f[P],f[P+1],1),this._vSet(f[P+8],f[P+8+1],-1)}else{var O=new XJ(T.x,T.y);O.subtract(x),O.normalize();var D=O.x,M=O.y;n===uJ.BUTT?this._buttCapEnd(T,D,M,t,0):n===uJ.SQUARE?this._buttCapEnd(T,D,M,t,t):n===uJ.ROUND&&this._roundCapEnd(T,D,M,t,o)}for(var N=_.indicesStart,L=S+2,B=_.vertexStart;L<B;L++)p[N++]=L-2,p[N++]=L-1,p[N++]=L;_.indicesStart=N}d4=null,m4=null}}},_expandFill:function(e){if(m4=e.impl){for(var t=m4.paths,n=0,i=m4.pathOffset,r=m4.pathLength;i<r;i++)n+=t[i].points.length;var o=d4=this.getRenderData(e,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=m4.pathOffset,u=m4.pathLength;l<u;l++){var h=t[l],_=h.points,f=_.length;if(0!==f){for(var p=o.vertexStart,d=0;d<f;++d)this._vSet(_[d].x,_[d].y);var m=o.indicesStart;if(h.complex){for(var v=[],g=p,y=o.vertexStart;g<y;g++){var S=8*g;v.push(s[S++]),v.push(s[S++]),v.push(s[S++])}var x=a4(v,null,3);if(!x||0===x.length)continue;for(var T=0,E=x.length;T<E;T++)c[m++]=x[T]+p}else for(var C=p,b=p+2,A=a.vertexStart;b<A;b++)c[m++]=C,c[m++]=b-1,c[m++]=b;a.indicesStart=m}}d4=null,m4=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var p,d,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(p=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var S=1/p;S>600&&(S=600),_.dmx*=S,_.dmy*=S}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=_J.PT_LEFT),p*(d=l4(11,c4(h.len,_.len)*r))*d<1&&(_.flags|=_J.PT_INNERBEVEL),_.flags&_J.PT_CORNER&&(p*i*i<1||n===hJ.BEVEL||n===hJ.ROUND)&&(_.flags|=_J.PT_BEVEL),0!=(_.flags&(_J.PT_BEVEL|_J.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new XJ(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*i,s=o-t.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(e,t,n,i,r){var o=e.x-t*r,a=e.y-n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var o=e.x+t*r,a=e.y+n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var o=e.x,a=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*s4,h=_4(u)*i,_=f4(u)*i;this._vSet(o-s*h-t*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var o=e.x,a=e.y,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*s4,h=_4(u)*i,_=f4(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+t*_,a-c*h+n*_,1)}},_roundJoin:function(e,t,n,i,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&_J.PT_LEFT)){var h=this._chooseBevel(t.flags&_J.PT_INNERBEVEL,e,t,n),_=h[0],f=h[1],p=h[2],d=h[3],m=p4(-a,-o),v=p4(-c,-s);v>m&&(v-=2*s4),this._vSet(_,f,1),this._vSet(l-o*i,t.y-a*i,-1);for(var g=S4(u4((m-v)/s4)*r,2,r),y=0;y<g;y++){var S=m+y/(g-1)*(v-m),x=l+_4(S)*i,T=u+f4(S)*i;this._vSet(l,u,0),this._vSet(x,T,-1)}this._vSet(p,d,1),this._vSet(l-s*i,u-c*i,-1)}else{var E=this._chooseBevel(t.flags&_J.PT_INNERBEVEL,e,t,-i),C=E[0],b=E[1],A=E[2],w=E[3],R=p4(a,o),I=p4(c,s);I<R&&(I+=2*s4),this._vSet(l+o*i,u+a*i,1),this._vSet(C,b,-1);for(var P=S4(u4((I-R)/s4)*r,2,r),O=0;O<P;O++){var D=R+O/(P-1)*(I-R),M=l+_4(D)*n,N=u+f4(D)*n;this._vSet(M,N,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(A,w,-1)}},_bevelJoin:function(e,t,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=e.dy,f=-e.dx,p=t.dy,d=-t.dx;if(t.flags&_J.PT_LEFT){var m=this._chooseBevel(t.flags&_J.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-_*i,t.y-f*i,-1),this._vSet(u,h,1),this._vSet(t.x-p*i,t.y-d*i,-1)}else{var v=this._chooseBevel(t.flags&_J.PT_INNERBEVEL,e,t,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(t.x+_*n,t.y+f*n,1),this._vSet(r,o,-1),this._vSet(t.x+p*n,t.y+d*n,1),this._vSet(a,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),d4){var i=d4,r=8*i.vertexStart,o=i.vData;o[r++]=e,o[r++]=t,o[r++]=0,mi.toArray(o,v4,r),r+=4,o[r++]=n,i.vertexStart++}}},T4=e("graphicsAssembler",{getAssembler:function(){return x4}});O$.Assembler=T4;var E4=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},C4=new qi,b4=null,A4=null,w4=[],R4=[],I4=[],P4=[],O4=new ji,D4=new ji,M4=new Fi,N4=null,L4=0,B4=0,F4=0,z4=0,U4=0,k4=1,G4=null,H4="",V4=0,j4=0,W4=0,q4=0,X4=0,Y4=0,K4=0,Q4=!1,Z4=0,J4=0,$4=0,e3={updateRenderData:function(e){e.renderData&&b4!==e&&(e.renderData.vertDirty&&(A4=(b4=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),b4.actualFontSize=V4,A4.setContentSize(D4),b4.renderData.vertDirty=b4.renderData.uvDirty=!1,b4.markForUpdateRenderData(!1),b4=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},_updateFontScale:function(){k4=V4/j4},_updateFontFamily:function(e){var t=e.font;G4=t.spriteFrame,N4=t.fntConfig,hQ.fontAtlas=t.fontDefDictionary,$Y.packToDynamicAtlas(e,G4)},_updateLabelInfo:function(){hQ.hash="",hQ.margin=0},_updateProperties:function(e){H4=e.string.toString(),V4=e.fontSize,j4=N4?N4.fontSize:e.fontSize,W4=e.horizontalAlign,q4=e.verticalAlign,X4=e.spacingX,K4=e.overflow,Y4=e._lineHeight;var t=A4.contentSize;D4.width=t.width,D4.height=t.height,K4===sJ.NONE?(Q4=!1,D4.width+=2*hQ.margin,D4.height+=2*hQ.margin):K4===sJ.RESIZE_HEIGHT?(Q4=!0,D4.height+=2*hQ.margin):Q4=e.enableWrapText,hQ.lineHeight=Y4,hQ.fontSize=V4,this._setupBMFontOverflowMetrics()},_resetProperties:function(){N4=null,G4=null,hQ.hash="",hQ.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=H4,t=e.length,n=N4.kerningDict,i=w4,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t=H4.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<t;){var h=H4.charAt(u);if("\n"!==h){for(var _=e(H4,u,t),f=s,p=c,d=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=H4.charAt(y)))if(l=hQ.fontAtlas.getLetterDefinitionForChar(h,hQ)){var S=m+l.offsetX*k4-hQ.margin;if(Q4&&$4>0&&i>0&&S+l.w*k4>$4&&!UK(h)){I4.push(a),a=0,n++,i=0,r-=Y4*this._getFontScale()+0,v=!0;break}M4.x=S,M4.y=r-l.offsetY*k4,this._recordLetterInfo(M4,h,y,n),y+1<w4.length&&y<t-1&&(m+=w4[y+1]),m+=l.xAdvance*k4+X4,d=M4.x+l.w*k4,f<M4.y&&(f=M4.y),p>M4.y-l.h*k4&&(p=M4.y-l.h*k4)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+N4.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>p&&(c=p),o<(a=d)&&(o=a),u+=_)}else I4.push(a),a=0,n++,i=0,r-=Y4*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return I4.push(a),B4=(L4=n+1)*Y4*this._getFontScale(),L4>1&&(B4+=0*(L4-1)),D4.width=Z4,D4.height=J4,Z4<=0&&(D4.width=parseFloat(o.toFixed(2))+2*hQ.margin),J4<=0&&(D4.height=parseFloat(B4.toFixed(2))+2*hQ.margin),z4=D4.height,U4=0,s>0&&(z4=D4.height+s),c<-B4&&(U4=B4+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return K4===sJ.SHRINK?k4:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(zK(i)||"\n"===i||UK(i))return 1;var r=1,o=hQ.fontAtlas.getLetterDefinitionForChar(i,hQ);if(!o)return r;for(var a=o.xAdvance*k4+X4,s=t+1;s<n&&(i=e.charAt(s),o=hQ.fontAtlas.getLetterDefinitionForChar(i,hQ));++s){if(a+o.offsetX*k4+o.w*k4>$4&&!UK(i)&&$4>0)return r;if(a+=o.xAdvance*k4+X4,"\n"===i||UK(i)||zK(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=R4.length){var n=new E4;R4.push(n)}R4[e].char=t,R4[e].hash=""+t.charCodeAt(0)+hQ.hash,R4[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=R4.length){var r=new E4;R4.push(r)}var o=""+t.charCodeAt(0)+hQ.hash;R4[n].line=i,R4[n].char=t,R4[n].hash=o,R4[n].valid=hQ.fontAtlas.getLetter(o).valid,R4[n].x=e.x,R4[n].y=e.y},_alignText:function(){B4=0,I4.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),K4===sJ.SHRINK&&V4>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||K4===sJ.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),V4=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|V4,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;k4=r/j4,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return B4>D4.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=H4.length;t<n;++t){var i=R4[t];if(i.valid){var r=hQ.fontAtlas.getLetterDefinitionForChar(i.char,hQ);if(!r)continue;var o=i.x+r.w*k4,a=i.line;if(Z4>0)if(Q4){if(I4[a]>D4.width&&(o>D4.width||o<0)){e=!0;break}}else if(o>D4.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=I4[t],i=e>D4.width||e<0;return Q4?n>D4.width&&i:i},_updateQuads:function(){if(!b4)return!1;var e=G4?G4.texture:hQ.fontAtlas.getTexture(),t=b4.renderData;t.dataLength=t.vertexCount=t.indicesCount=0;for(var n=A4.anchorPoint,i=D4,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=H4.length;s<c;++s){var l=R4[s];if(l.valid){var u=hQ.fontAtlas.getLetter(l.hash);if(u){C4.height=u.h,C4.width=u.w,C4.x=u.u,C4.y=u.v;var h=l.y+F4;if(J4>0){if(h>z4){var _=h-z4;C4.y+=_,C4.height-=_,h-=_}h-u.h*k4<U4&&K4===sJ.CLAMP&&(C4.height=h<U4?0:(h-U4)/k4)}var f=l.line,p=l.x+u.w/2*k4+P4[f];if(Z4>0&&this._isHorizontalClamped(p,f))if(K4===sJ.CLAMP)C4.width=0;else if(K4===sJ.SHRINK){if(D4.width>u.w){a=!1;break}C4.width=0}if(C4.height>0&&C4.width>0){var d=this._determineRect(),m=l.x+P4[l.line];this.appendQuad(b4,e,C4,d,m-r,h-o,k4)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var e=G4.isRotated(),t=G4.getOriginalSize(),n=G4.getRect(),i=G4.getOffset(),r=i.x+(t.width-n.width)/2,o=i.y-(t.height-n.height)/2;if(e){var a=C4.x;C4.x=n.x+n.height-C4.y-C4.height-o,C4.y=a+n.y-r,C4.y<0&&(C4.height+=o)}else C4.x+=n.x-r,C4.y+=n.y+o;return e},_computeAlignmentOffset:function(){switch(P4.length=0,W4){case oJ.LEFT:for(var e=0;e<L4;++e)P4.push(0);break;case oJ.CENTER:for(var t=0,n=I4.length;t<n;t++)P4.push((D4.width-I4[t])/2);break;case oJ.RIGHT:for(var i=0,r=I4.length;i<r;i++)P4.push(D4.width-I4[i])}if(F4=D4.height,q4!==aJ.TOP){var o=D4.height-B4+Y4*this._getFontScale()-j4*k4;q4===aJ.BOTTOM?F4-=o:F4-=o/2}},_setupBMFontOverflowMetrics:function(){var e=D4.width,t=D4.height;K4===sJ.RESIZE_HEIGHT&&(t=0),K4===sJ.NONE&&(e=0,t=0),Z4=e,J4=t,O4.width=e,O4.height=t,$4=e}},t3=new mi(255,255,255,255),n3={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){var n=e.node;t3.set(e.color),t3.a=255*n._uiProps.opacity,YY(n,t,e.renderData,t3)},appendQuad:function(e,t,n,i,r,o,a){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.vertexCount=s.dataLength,s.indicesCount=s.dataLength/2*3;var l=s.data,u=t.width,h=t.height,_=n.width,f=n.height,p=0,d=0,m=0,v=0;i?(p=n.x/u,v=(n.x+f)/u,d=(n.y+_)/h,m=n.y/h,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(p=n.x/u,v=(n.x+_)/u,d=(n.y+f)/h,m=n.y/h,l[c].u=p,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=p,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}}};Ee(n3,e3);var i3=null,r3=Ce(e3,{getAssemblerData:function(){return i3||(i3=new uQ(1024,1024)),i3.getTexture()},_updateFontFamily:function(e){hQ.fontAtlas=i3,hQ.fontFamily=this._getFontFamily(e);var t=e.getComponent(q0);t&&t.enabled?(hQ.isOutlined=!0,hQ.margin=t.width,hQ.out=t.color.clone(),hQ.out.a=t.color.a*e.color.a/255):(hQ.isOutlined=!1,hQ.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){hQ.fontDesc=this._getFontDesc(),hQ.color=e.color,hQ.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(hQ)},_getFontDesc:function(){return hQ.fontSize.toString()+"px "+hQ.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),o3=new mi(255,255,255,255),a3={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var n=e.node;o3.a=255*n._uiProps.opacity,YY(n,t,e.renderData,o3)}},appendQuad:n3.appendQuad};Ee(a3,r3);var s3=fJ.Overflow,c3=(1/255).toFixed(3),l3=null,u3=null,h3=null,_3="",f3="",p3=0,d3=0,m3=[],v3=new ji,g3=0,y3=0,S3=0,x3=new mi,T3="",E3=s3.NONE,C3=!1,b3=null,A3=mi.BLACK.clone(),w3=null,R3=mi.BLACK.clone(),I3=new qi,P3=ji.ZERO.clone(),O3=ji.ZERO.clone(),D3=Fi.ZERO.clone(),M3=Fi.ZERO.clone(),N3=0,L3=0,B3=!1,F3=!1,z3=!1,U3=["left","center","right"],k3={getAssemblerData:function(){return fJ._canvasPool.get()},resetAssemblerData:function(e){e&&fJ._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this.updateOpacity(e),this._calDynamicAtlas(e),e.actualFontSize=p3,t.setContentSize(v3),this.updateVertexData(e),this.updateUvs(e),e.markForUpdateRenderData(!1),l3=null,u3=null,h3=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUvs:function(){},updateOpacity:function(e){for(var t=e.renderData.vData,n=5,i=e.node._uiProps.opacity,r=0;r<4;r++)t[n+3]=i,n+=9},_updateFontFamily:function(e){T3=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(l3=n.context,u3=n.canvas,h3=e.spriteFrame,f3=e.string.toString(),p3=e.fontSize,d3=p3,E3=e.overflow,O3.width=v3.width=t.width,O3.height=v3.height=t.height,L3=e.underlineHeight,g3=e.lineHeight,y3=e.horizontalAlign,S3=e.verticalAlign,x3=e.color,e.node._uiProps.opacity,B3=e.isBold,F3=e.isItalic,z3=e.isUnderline,C3=E3!==s3.NONE&&(E3===s3.RESIZE_HEIGHT||e.enableWrapText),(b3=(b3=q0&&e.getComponent(q0))&&b3.enabled&&b3.width>0?b3:null)&&A3.set(b3.color),(w3=(w3=F2&&e.getComponent(F2))&&w3.enabled?w3:null)&&R3.set(w3.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(P3.width=P3.height=0,b3&&(e=t=n=i=r=b3.width,P3.width=P3.height=2*r),w3){var o=w3.blur+r,a=w3.offset.x,s=w3.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),e=Math.max(e,s+o),t=Math.max(t,-s+o)}if(F3){var c=d3*Math.tan(.20943951);i+=c,P3.width+=c}I3.x=n,I3.y=e,I3.width=n+i,I3.height=e+t},_calculateFillTextStartPosition:function(){var e=0;y3===oJ.RIGHT?e=v3.width-I3.width:y3===oJ.CENTER&&(e=(v3.width-I3.width)/2);var t=this._getLineHeight()*(m3.length-1),n=p3*(1-RK/2);if(S3!==aJ.TOP){var i=t+I3.height+p3-v3.height;S3===aJ.BOTTOM?n-=i+=RK/2*p3:n-=i/2}n+=0*p3,D3.set(e+I3.x,n+I3.y)},_updateTexture:function(e){if(l3&&u3){l3.clearRect(0,0,u3.width,u3.height),l3.font=_3,this._calculateFillTextStartPosition();var t=this._getLineHeight();l3.lineJoin="round",b3?(l3.fillStyle="rgba("+A3.r+", "+A3.g+", "+A3.b+", "+c3+")",l3.fillRect(0,0,u3.width,u3.height)):e._srcBlendFactor===kr.SRC_ALPHA&&(l3.fillStyle="rgba("+x3.r+", "+x3.g+", "+x3.b+", "+c3+")",l3.fillRect(0,0,u3.width,u3.height)),l3.fillStyle="rgb("+x3.r+", "+x3.g+", "+x3.b+")";var n=D3.x,i=0;this._drawTextEffect(D3,t);for(var r=0;r<m3.length;++r)i=D3.y+r*t,b3&&l3.strokeText(m3[r],n,i),l3.fillText(m3[r],n,i);w3&&(l3.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===fJ.CacheMode.BITMAP){var t=e.ttfSpriteFrame;$Y.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;h3&&u3&&(n=h3 instanceof oK?h3.texture:h3,0!==u3.width&&0!==u3.height&&(n.reset({width:u3.width,height:u3.height,mipmapLevel:1}),n.uploadData(u3),h3 instanceof oK&&(h3.rect=new qi(0,0,u3.width,u3.height),h3._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),r.director.root&&r.director.root.batcher2D&&r.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(e.cacheMode===fJ.CacheMode.BITMAP){var t=e.ttfSpriteFrame;$Y.packToDynamicAtlas(e,t),e.renderData.uvDirty=!0}},_setupOutline:function(){l3.strokeStyle="rgba("+A3.r+", "+A3.g+", "+A3.b+", "+A3.a/255+")",l3.lineWidth=2*b3.width},_setupShadow:function(){l3.shadowColor="rgba("+R3.r+", "+R3.g+", "+R3.b+", "+R3.a/255+")",l3.shadowBlur=w3.blur,l3.shadowOffsetX=w3.offset.x,l3.shadowOffsetY=-w3.offset.y},_drawTextEffect:function(e,t){if(w3||b3||z3){var n=m3.length>1&&w3,i=this._measureText(l3,_3),r=0,o=0;w3&&this._setupShadow(),b3&&this._setupOutline();for(var a=0;a<m3.length;++a)r=e.x,o=e.y+a*t,n&&(b3&&l3.strokeText(m3[a],r,o),l3.fillText(m3[a],r,o)),z3&&(N3=i(m3[a]),y3===oJ.RIGHT?M3.x=e.x-N3:y3===oJ.CENTER?M3.x=e.x-N3/2:M3.x=e.x,M3.y=o+d3/8,l3.fillRect(M3.x,M3.y,N3,L3));n&&(l3.shadowColor="transparent")}},_updateLabelDimensions:function(){v3.width=Math.min(v3.width,2048),v3.height=Math.min(v3.height,2048);var e=!1;u3.width!==v3.width&&(u3.width=v3.width,e=!0),u3.height!==v3.height&&(u3.height=v3.height,e=!0),e&&(l3.font=_3),l3.textAlign=U3[y3],l3.textBaseline="alphabetic"},_getFontDesc:function(){var e=p3.toString()+"px ";return e+=T3,B3&&(e="bold "+e),F3&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===g3?p3:g3*p3/d3)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=q(e);!(n=r()).done;){var o=kK(t,n.value,_3);i.push(o)}return i},_measureText:function(e,t){return function(n){return kK(e,n,t)}},_calculateShrinkFont:function(e){if(l3){var t=this._calculateParagraphLength(e,l3),n=0,i=0,r=0;if(C3){var o=O3.width,a=O3.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|p3+1,l=0;s<c;){if((l=s+c+1>>1)<=0){E(4003);break}p3=l,_3=this._getFontDesc(),l3.font=_3;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=kK(l3,e[n],_3);i+=HK(e[n],h,o,this._measureText(l3,_3)).length*u}i>a?c=l-1:s=l}0===s?E(4003):(p3=s,_3=this._getFontDesc(),l3.font=_3)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var _=(v3.width-I3.width)/r,f=v3.height/i;p3=d3*Math.min(1,_,f)|0,_3=this._getFontDesc(),l3.font=_3}}},_calculateWrapText:function(e){if(C3&&l3){m3=[];for(var t=O3.width,n=0;n<e.length;++n){var i=kK(l3,e[n],_3),r=HK(e[n],i,t,this._measureText(l3,_3));m3=m3.concat(r)}}},_calculateLabelFont:function(){if(l3){var e=f3.split("\n");switch(m3=e,_3=this._getFontDesc(),l3.font=_3,E3){case s3.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=kK(l3,e[i],_3);t=t>r?t:r}n=(m3.length+RK)*this._getLineHeight();var o=parseFloat(t.toFixed(2)),a=parseFloat(n.toFixed(2));v3.width=o+I3.width,v3.height=a+I3.height,O3.width=o+P3.width,O3.height=a+P3.height;break;case s3.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case s3.CLAMP:this._calculateWrapText(e);break;case s3.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(m3.length+RK)*this._getLineHeight();v3.height=s+I3.height,O3.height=s+P3.height}}}},G3=mi.WHITE.clone(),H3={createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indicesCount=6;var n=t.vData=new Float32Array(36);n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)mi.toArray(n,G3,i),i+=9;return t},fillBuffers:function(e,t){var n=e.renderData,i=n.data,r=e.node,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=o.indicesOffset,c=o.vertexOffset;o.request()||(o=t.currBufferBatch,s=0,c=0,a=0);var l=o.vData,u=o.iData,h=n.vData,_=i[0],f=i[3];r.updateWorldTransform();var p=r._pos,d=r._rot,m=r._scale,v=_.x*m.x,g=f.x*m.x,y=_.y*m.y,S=f.y*m.y,x=d.x,T=d.y,E=d.z,C=d.w,b=x*T,A=E*C,w=x*x-T*T,R=C*C-E*E,I=R+w,P=2*(b-A),O=R-w,D=2*(b+A),M=p.x,N=p.y;h[0]=I*v+P*y+M,h[1]=O*y+D*v+N,h[9]=I*g+P*y+M,h[10]=O*y+D*g+N,h[18]=I*v+P*S+M,h[19]=O*S+D*v+N,h[27]=I*g+P*S+M,h[28]=O*S+D*g+N,l.set(h,a),u[s++]=c,u[s++]=c+1,u[s++]=c+2,u[s++]=c+2,u[s++]=c+1,u[s++]=c+3},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.data;s[0].x=-o,s[0].y=-a,s[3].x=i-o,s[3].y=r-a}},updateUvs:function(e){var t=e.renderData;if(t){var n=t.vData;if(n&&t.uvDirty){var i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],t.uvDirty=!1}}}};Ee(H3,k3);var V3=e("labelAssembler",{getAssembler:function(e){var t=H3;return e.font instanceof AK?t=n3:e.cacheMode===fJ.CacheMode.CHAR&&(t=a3),t}});fJ.Assembler=V3;var j3=s1.FillType,W3=new Mi,q3=new mi(255,255,255,255),X3={useModel:!1,updateRenderData:function(e){var t=e.spriteFrame;$Y.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){n.updateRenderData(e,t);var i=n.uvDirty,r=n.vertDirty;if(!i&&!r)return;var o=e.fillStart,a=e.fillRange;a<0&&(o+=a,a=-a),a=(a=(a=o+a)>1?1:a)<0?0:a;var s=(o=(o=o>1?1:o)<0?0:o)+(a=(a-=o)<0?0:a);s=s>1?1:s,i&&this.updateUVs(e,o,s),r&&(this.updateVertexData&&this.updateVertexData(e,o,s),this.updateWorldVertexData(e))}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData,o=r.data,a=i.width,s=i.height,c=i.getRect(),l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0;switch(i.isRotated()?(l=c.x/a,u=(c.y+c.width)/s,h=f=l,d=v=(c.x+c.height)/a,p=g=u,_=m=c.y/s):(l=c.x/a,u=(c.y+c.height)/s,h=d=l,f=v=(c.x+c.width)/a,_=p=u,m=g=c.y/s),e.fillType){case j3.HORIZONTAL:o[0].u=h+(f-h)*t,o[0].v=_+(p-_)*t,o[1].u=h+(f-h)*n,o[1].v=_+(p-_)*n,o[2].u=d+(v-d)*t,o[2].v=m+(g-m)*t,o[3].u=d+(v-d)*n,o[3].v=m+(g-m)*n;break;case j3.VERTICAL:o[0].u=h+(d-h)*t,o[0].v=_+(m-_)*t,o[1].u=f+(v-f)*t,o[1].v=p+(g-p)*t,o[2].u=h+(d-h)*n,o[2].v=_+(m-_)*n,o[3].u=f+(v-f)*n,o[3].v=p+(g-p)*n;break;default:w(2626)}r.uvDirty=!1},updateVertexData:function(e,t,n){var i=e.renderData,r=i.data,o=e.node._uiProps.uiTransformComp,a=o.width,s=o.height,c=o.anchorX*a,l=o.anchorY*s,u=-c,h=-l,_=a-c,f=s-l,p=0;switch(e.fillType){case j3.HORIZONTAL:p=u+(_-u)*n,u+=(_-u)*t,_=p;break;case j3.VERTICAL:p=h+(f-h)*n,h+=(f-h)*t,f=p;break;default:w(2626)}r[4].x=u,r[4].y=h,r[5].x=_,r[5].y=h,r[6].x=u,r[6].y=f,r[7].x=_,r[7].y=f,i.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indicesCount=6;for(var n,i=q(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e){var t=e.node,n=e.renderData.data;t.getWorldMatrix(W3);for(var i=0;i<4;i++){var r=n[i+4],o=n[i];gi.transformMat4(o,r,W3)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);var n=e.node;q3.set(e.color),q3.a=255*n._uiProps.opacity,function(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);for(var u=o.vData,h=0;h<s;h++){var _=r[h];u[a++]=_.x,u[a++]=_.y,u[a++]=_.z,u[a++]=_.u,u[a++]=_.v,mi.toArray(u,i,a),a+=4}var f=o.iData;f[c++]=l,f[c++]=l+1,f[c++]=l+2,f[c++]=l+1,f[c++]=l+3,f[c++]=l+2}(0,t,e.renderData,q3)},updateColor:function(){}},Y3=2*Math.PI,K3=1e-6,Q3=new mi(255,255,255,255),Z3=[new Fi,new Fi,new Fi,new Fi],J3=new Array(4),$3=new Array(8),e5=[new Fi,new Fi,new Fi,new Fi],t5=[new Fi,new Fi,new Fi,new Fi],n5=new Fi,i5=[new Fi,new Fi,new Fi,new Fi];function r5(e,t,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>K3?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>K3?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);a[0].x=e,a[0].y=h}if((t-r.x)*c>0){var _=r.y+l*(t-r.x);a[2].x=t,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var p=r.x+u*(n-r.y);a[1].x=p,a[1].y=n}}}function o5(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function a5(e,t,n,i,r){var o=J3,a=o[0],s=o[1],c=o[2],l=o[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,s5((n.x-a)/(c-a),(n.y-s)/(l-s),e,t),s5((i.x-a)/(c-a),(i.y-s)/(l-s),e,t+1),s5((r.x-a)/(c-a),(r.y-s)/(l-s),e,t+2)}function s5(e,t,n,i){var r=$3,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=o+(a-o)*t,l.v=s+(c-s)*t}for(var c5={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;$Y.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.vertDirty||n.uvDirty){var i=n.data,r=e.fillStart,o=e.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=Y3)+(o*=Y3);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,o=t.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=J3;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,_=n5.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=n5.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;Z3[0].x=Z3[3].x=a,Z3[1].x=Z3[2].x=c,Z3[0].y=Z3[1].y=s,Z3[2].y=Z3[3].y=l;for(var p,d=q(i5);!(p=d()).done;){var m=p.value;Fi.set(m,0,0)}_!==u[0]&&Fi.set(i5[0],3,0),_!==u[2]&&Fi.set(i5[2],1,2),f!==u[1]&&Fi.set(i5[1],0,1),f!==u[3]&&Fi.set(i5[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,o=0,a=0,s=0,c=$3;e.isRotated()?(r=i.x/t,o=(i.x+i.height)/t,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/t,o=(i.x+i.width)/t,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(t),r5(J3[0],J3[2],J3[1],J3[3],n5,r,e5),r5(J3[0],J3[2],J3[1],J3[3],n5,r+o,t5);for(var s=0,c=0;c<4;++c){var l=i5[c];if(l)if(o>=Y3)n.dataLength=s+3,a5(i,s,n5,Z3[l.x],Z3[l.y]),s+=3;else{var u=o5(n5,Z3[l.x]),h=o5(n5,Z3[l.y]);h<u&&(h+=Y3),u-=Y3,h-=Y3;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,a5(i,s,n5,Z3[l.x],h>=a?t5[c]:Z3[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,a5(i,s,n5,e5[c],Z3[l.y]),s+=3):(n.dataLength=s+3,a5(i,s,n5,e5[c],t5[c]),s+=3))),u+=Y3,h+=Y3}}n.indicesCount=n.vertexCount=s,n.vertDirty=n.uvDirty=!1}n.updateRenderData(e,t)}},fillBuffers:function(e,t){var n=e.node,i=e.renderData;Q3.set(e.color),Q3.a=255*n._uiProps.opacity,function(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);var u=o.vData;e.getWorldMatrix(XY);for(var h=0;h<s;h++){var _=r[h];gi.set(qY,_.x,_.y,0),gi.transformMat4(qY,qY,XY),u[a++]=qY.x,u[a++]=qY.y,u[a++]=qY.z,u[a++]=_.u,u[a++]=_.v,mi.toArray(u,i,a),a+=4}for(var f=o.iData,p=0;p<n.dataLength;p++)f[c+p]=l+p}(n,t,i,Q3)},updateColor:function(){}},l5=[],u5=0;u5<4;u5++)l5.push(new gi);for(var h5={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame;$Y.packToDynamicAtlas(e,t);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.uvDirty&&this.updateUvs(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData.data,i=e.node,r=n[0],o=n[3],a=i.worldMatrix,s=a.m00,c=a.m01,l=a.m04,u=a.m05,h=1===s&&0===c&&0===l&&1===u,_=a.m12,f=a.m13,p=r.x,d=o.x,m=r.y,v=o.y;if(h){var g=p+_,y=d+_,S=m+f,x=v+f;t[0]=g,t[1]=S,t[9]=y,t[10]=S,t[18]=g,t[19]=x,t[27]=y,t[28]=x}else{var T=s*p,E=s*d,C=c*p,b=c*d,A=l*m+_,w=l*v+_,R=u*m+f,I=u*v+f;t[0]=T+A,t[1]=C+R,t[9]=E+A,t[10]=b+R,t[18]=T+w,t[19]=C+I,t[27]=E+w,t[28]=b+I}},fillBuffers:function(e,t){if(null!==e){var n=e.renderData.vData;e.node.hasChangedFlags&&this.updateWorldVerts(e,n);var i=t.acquireBufferBatch(),r=i.byteOffset>>2,o=i.indicesOffset,a=i.vertexOffset;i.request()||(i=t.currBufferBatch,r=0,o=0,a=0);var s=i.vData,c=i.iData;s.set(n,r);var l=a,u=a+1,h=a+2,_=a+3;c[o++]=l,c[o++]=u,c[o++]=h,c[o++]=h,c[o++]=u,c[o++]=_}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=e.spriteFrame,f=_.getOriginalSize(),p=_.getRect(),d=f.width,m=f.height,v=p.width,g=p.height,y=_.getOffset(),S=r/d,x=o/m,T=y.x+(d-v)/2,E=y.x-(d-v)/2;c=T*S-a,l=(y.y+(m-g)/2)*x-s,u=r+E*S-a,h=o+(y.y-(m-g)/2)*x-s}i[0].x=c,i[0].y=l,i[3].x=u,i[3].y=h,t.vertDirty=!1,this.updateWorldVerts(e,t.vData)}},updateUvs:function(e){var t=e.renderData,n=t.vData,i=e.spriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,n=5,i=e.color,r=i.r/255,o=i.g/255,a=i.b/255,s=e.node._uiProps.opacity,c=0;c<4;c++)t[n]=r,t[n+1]=o,t[n+2]=a,t[n+3]=s,n+=9}},_5=new gi,f5=new Mi,p5={useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indicesCount=54,t},updateRenderData:function(e){var t=e.spriteFrame;$Y.packToDynamicAtlas(e,t);var n=e.renderData;n&&t&&(n.vertDirty&&(this.updateVertexData(e),this.updateWorldVertexData(e)),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData,n=t.data,i=e.node._uiProps.uiTransformComp,r=i.width,o=i.height,a=i.anchorX*r,s=i.anchorY*o,c=e.spriteFrame,l=c.insetLeft,u=c.insetRight,h=c.insetTop,_=c.insetBottom,f=r-l-u,p=o-h-_,d=r/(l+u),m=o/(h+_);d=Number.isNaN(d)||d>1?1:d,m=Number.isNaN(m)||m>1?1:m,f=f<0?0:f,p=p<0?0:p,n[0].x=-a,n[0].y=-s,n[1].x=l*d-a,n[1].y=_*m-s,n[2].x=n[1].x+f,n[2].y=n[1].y+p,n[3].x=r-a,n[3].y=o-s,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);var n=t.acquireBufferBatch(),i=e.renderData,r=i.data,o=n.byteOffset>>2,a=i.vertexCount,s=n.indicesOffset,c=n.vertexOffset,l=e.spriteFrame.uvSliced;n.request(a,i.indicesCount)||(n=t.currBufferBatch,o=0,s=0,c=0);for(var u=n.vData,h=n.iData,_=4;_<20;++_){var f=r[_],p=l[_-4];u[o++]=f.x,u[o++]=f.y,u[o++]=f.z,u[o++]=p.u,u[o++]=p.v,mi.toArray(u,r[_].color,o),o+=4}for(var d=0;d<3;++d)for(var m=0;m<3;++m){var v=c+4*d+m;h[s++]=v,h[s++]=v+1,h[s++]=v+4,h[s++]=v+1,h[s++]=v+5,h[s++]=v+4}},updateWorldVertexData:function(e){var t=e.node,n=e.renderData.data;t.getWorldMatrix(f5);for(var i=0;i<4;++i)for(var r=n[i],o=0;o<4;++o){var a=n[o],s=n[4+4*i+o];gi.set(_5,a.x,r.y,0),gi.transformMat4(s,_5,f5)}},updateColor:function(e){for(var t=e.renderData.data,n=e.color,i=n.r,r=n.g,o=n.b,a=255*e.node._uiProps.opacity,s=4;s<20;s++)t[s].color.r=i,t[s].color.g=r,t[s].color.b=o,t[s].color.a=a}},d5=[],m5=0;m5<4;m5++)d5.push(new gi);var v5={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.uvDirty||t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,p=o-u-h;f=f>0?f:0,p=p>0?p:0;var d=0===l?f:f/l,m=0===_?p:p/_,v=Math.ceil(m+2),g=Math.ceil(d+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,f,p,v,g),t.vertexCount=v*g*4,t.indicesCount=v*g*6,t.uvDirty=!1,t.vertDirty=!1,this.updateColor(e)}},fillBuffers:function(e,t){var n=e.node,i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=e.renderData,s=t.acquireBufferBatch(),c=s.indicesOffset,l=s.byteOffset>>2,u=s.vertexOffset,h=a.vertexCount,_=a.indicesCount,f=s.vData,p=s.iData;s.request(h,_)||(s=t.currBufferBatch,l=0,c=0,u=0);var d=e.spriteFrame,m=d.isRotated(),v=d.uv,g=e.spriteFrame.uvSliced,y=d.getRect(),S=d.insetLeft,x=d.insetRight,T=y.width-S-x,E=d.insetTop,C=d.insetBottom,b=y.height-E-C,A=r-S-x,w=o-E-C;A=A>0?A:0,w=w>0?w:0;var R=0===T?A:A/T,I=0===b?w:w/b,P=Math.ceil(I+2),O=Math.ceil(R+2),D=n.worldMatrix,M=a.data;this.fillVertices(f,l,D,P,O,M);for(var N=0,L=0,B=[],F=[],z=0,U=P;z<U;++z){L=w>b?w>=z*b?1:I%1:I;for(var k=0,G=O;k<G;++k){N=A>T?A>=k*T?1:R%1:R;var H=l+3,V=H+1;m?(0===z?(B[0]=g[0].u,B[1]=g[0].u,B[2]=g[4].u+(g[8].u-g[4].u)*L):z<P-1?(B[0]=g[4].u,B[1]=g[4].u,B[2]=g[4].u+(g[8].u-g[4].u)*L):z===P-1&&(B[0]=g[8].u,B[1]=g[8].u,B[2]=g[12].u),0===k?(F[0]=g[0].v,F[1]=g[1].v+(g[2].v-g[1].v)*N,F[2]=g[0].v):k<O-1?(F[0]=g[1].v,F[1]=g[1].v+(g[2].v-g[1].v)*N,F[2]=g[1].v):k===O-1&&(F[0]=g[2].v,F[1]=g[3].v,F[2]=g[2].v),B[3]=B[2],F[3]=F[1]):(0===k?(B[0]=g[0].u,B[1]=g[1].u+(g[2].u-g[1].u)*N,B[2]=v[0]):k<O-1?(B[0]=g[1].u,B[1]=g[1].u+(g[2].u-g[1].u)*N,B[2]=g[1].u):k===O-1&&(B[0]=g[2].u,B[1]=g[3].u,B[2]=g[2].u),0===z?(F[0]=g[0].v,F[1]=g[0].v,F[2]=g[4].v+(g[8].v-g[4].v)*L):z<P-1?(F[0]=g[4].v,F[1]=g[4].v,F[2]=g[4].v+(g[8].v-g[4].v)*L):z===P-1&&(F[0]=g[8].v,F[1]=g[8].v,F[2]=g[12].v),B[3]=B[1],F[3]=F[2]),f[H]=B[0],f[V]=F[0],f[H+9]=B[1],f[V+9]=F[1],f[H+18]=B[2],f[V+18]=F[2],f[H+27]=B[3],f[V+27]=F[3],mi.toArray(f,M[0].color,V+1),mi.toArray(f,M[0].color,V+9+1),mi.toArray(f,M[0].color,V+18+1),mi.toArray(f,M[0].color,V+27+1),l+=36}}for(var j=0;j<_;j+=6)p[c++]=u,p[c++]=u+1,p[c++]=u+2,p[c++]=u+1,p[c++]=u+3,p[c++]=u+2,u+=4},fillVertices:function(e,t,n,i,r,o){for(var a=0,s=0,c=0,l=0,u=0,h=i;u<h;++u){c=o[u].y,l=o[u+1].y;for(var _=0,f=r;_<f;++_){a=o[_].x,s=o[_+1].x,gi.set(d5[0],a,c,0),gi.set(d5[1],s,c,0),gi.set(d5[2],a,l,0),gi.set(d5[3],s,l,0);for(var p=0;p<4;p++){var d=d5[p];gi.transformMat4(d,d,n);var m=9*p;e[t+m]=d.x,e[t+m+1]=d.y,e[t+m+2]=d.z}t+=36}}},updateVerts:function(e,t,n,i,r){var o,a,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.getRect(),h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,p=s.anchorY*_,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,S=u.height-g-y,x=s.width/(d+m)>1?1:s.width/(d+m),T=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=S>0?Math.floor(1e3*n)/1e3%S==0?S:n%S:n;for(var E=0;E<=r;E++)0===E?c[E].x=-f:E>0&&E<r?c[E].x=1===E?d*x+Math.min(v,t)-f:v>0?E===r-1?d+o+v*(E-2)-f:d+Math.min(v,t)+v*(E-2)-f:d+t-f:E===r&&(c[E].x=Math.min(d+t+m,h)-f);for(var C=0;C<=i;C++)0===C?c[C].y=-p:C>0&&C<i?c[C].y=1===C?y*T+Math.min(S,n)-p:S>0?C===i-1?y+a+(C-2)*S-p:y+Math.min(S,n)+(C-2)*S-p:y+n-p:C===i&&(c[C].y=Math.min(y+n+g,_)-p)},updateColor:function(e){var t=e.renderData.data,n=t.length;if(0!==n)for(var i=e.color,r=i.r,o=i.g,a=i.b,s=255*e.node._uiProps.opacity,c=0;c<n;c++)t[c].color.r=r,t[c].color.g=o,t[c].color.b=a,t[c].color.a=s}},g5=s1.Type,y5=s1.FillType,S5=e("spriteAssembler",{getAssembler:function(e){var t=h5,n=e;switch(n.type){case g5.SLICED:t=p5;break;case g5.TILED:t=v5;break;case g5.FILLED:t=n.fillType===y5.RADIAL?c5:X3}return t}});s1.Assembler=S5;var x5=XQ.sharedManager,T5={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){e.type===w$.IMAGE_STENCIL&&(h5.updateRenderData(e),h5.updateColor(e))},fillBuffers:function(e,t){(e.type!==w$.IMAGE_STENCIL||e.spriteFrame)&&(x5.pushMask(e),t.finishMergeBatches(),function(e,t){x5.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(x5.enterLevel(e),e.type===w$.IMAGE_STENCIL){h5.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),x5.enableMask())}},E5={fillBuffers:function(){x5.exitMask()}},C5={getAssembler:function(){return T5}},b5={getAssembler:function(){return E5}};B$.Assembler=C5,B$.PostAssembler=b5,new(function(){function e(){this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],gO.on(mO.EventType.MOUSE_DOWN,this.dispatchEventMouse,this),gO.on(mO.EventType.MOUSE_MOVE,this.dispatchEventMouse,this),gO.on(mO.EventType.MOUSE_UP,this.dispatchEventMouse,this),gO.on(mO.EventType.MOUSE_WHEEL,this.dispatchEventMouse,this),gO.on(mO.EventType.TOUCH_START,this.dispatchEventTouch,this),gO.on(mO.EventType.TOUCH_MOVE,this.dispatchEventTouch,this),gO.on(mO.EventType.TOUCH_END,this.dispatchEventTouch,this),gO.on(mO.EventType.TOUCH_CANCEL,this.dispatchEventTouch,this),BP.callbacksInvoker.on(QA.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),BP.callbacksInvoker.on(QA.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this)}var t=e.prototype;return t.addPointerEventProcessor=function(e){0===this._inDispatchCount?(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.push(e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(He.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.push(e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var o=t[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(e)&&(i=!1,!e.preventSwallow))break}var a=yO[e.type];i&&a&&gO._eventTarget.emit(a,e),--this._inDispatchCount<=0&&this._updatePointerEventProcessorList()},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,o=0;o<n;++o){var a=t[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===YA.TOUCH_START){if(a._handleEventTouch(e)&&(a.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow))break}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s&&(a._handleEventTouch(e),e.type!==YA.TOUCH_END&&e.type!==YA.TOUCH_CANCEL||He.array.removeAt(a.claimedTouchIdList,s),r=!1,!e.preventSwallow))break}}var c=yO[e.type];r&&c&&gO._eventTarget.emit(c,e.touch,e),--this._inDispatchCount<=0&&this._updatePointerEventProcessorList()},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node._uiProps.uiTransformComp;i.cachedCameraPriority=r.cameraPriority}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,p=o?o.getSiblingIndex():0;return a?f-p:p-f},e}());var A5=new na(null),w5=new Mi,R5=e("UI",function(){var e=t.prototype;function t(e){var t=this;this.device=void 0,this._screens=[],this._bufferBatchPool=new qe((function(){return new r2(t)}),128,(function(e){return e.destroy()})),this._drawBatchPool=void 0,this._meshBuffers=new Map,this._customMeshBuffers=new Map,this._meshBufferUseCount=new Map,this._batches=void 0,this._emptyMaterial=new Mg,this._currScene=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currBlendTargetHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._descriptorSetCache=new P5,this._root=e,this.device=e.device,this._batches=new Xe(64),this._drawBatchPool=new We((function(){return new L2}),128,(function(e){return e.destroy(t)}))}return e.acquireBufferBatch=function(e){void 0===e&&(e=JJ);var t=e===JJ?36:t$(e);return this._currMeshBuffer&&this._currMeshBuffer.vertexFormatBytes===t||this._requireBufferBatch(e),this._currMeshBuffer},e.registerCustomBuffer=function(e,t){var n;e instanceof r2?n=e:(n=this._bufferBatchPool.add()).initialize(e,t||this._recreateMeshBuffer.bind(this,e));var i=n.vertexFormatBytes,r=this._customMeshBuffers.get(i);return r||(r=[],this._customMeshBuffers.set(i,r)),r.push(n),n},e.unRegisterCustomBuffer=function(e){var t=this._customMeshBuffers.get(e.vertexFormatBytes);if(t)for(var n=0;n<t.length;n++)if(t[n]===e){t.splice(n,1);break}var i=this._bufferBatchPool.data.indexOf(e);-1!==i&&(e.reset(),this._bufferBatchPool.removeAt(i))},e.initialize=function(){return!0},e.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy();for(var t,n=q(this._meshBuffers.keys());!(t=n()).done;){var i=t.value,r=this._meshBuffers.get(i);r&&r.forEach((function(e){return e.destroy()}))}this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),this._meshBuffers.clear(),XQ.sharedManager.destroy()},e.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},e.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.update=function(){for(var e=this._screens,t=0;t<e.length;++t){var n=e[t];n.enabledInHierarchy&&this._recursiveScreenNode(n.node)}var i=0;if(this._batches.length)for(var r=0;r<this._batches.length;++r){var o=this._batches.array[r];if(o.renderScene){if(o.model)for(var a=o.model.subModels,s=0;s<a.length;s++)a[s].priority=i++;else o.descriptorSet=this._descriptorSetCache.getDescriptorSet(o);o.renderScene.addBatch(o)}}},e.uploadBuffers=function(){this._batches.length>0&&(this._meshBuffers.forEach((function(e){e.forEach((function(e){e.uploadBuffers(),e.reset()}))})),this._customMeshBuffers.forEach((function(e){e.forEach((function(e){e.uploadBuffers(),e.reset()}))})),this._descriptorSetCache.update())},e.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._currHash=0,this._currLayer=0,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._currScene=null,this._currMeshBuffer=null,this._meshBufferUseCount.clear(),this._batches.clear(),XQ.sharedManager.reset(),this._descriptorSetCache.reset()},e.commitComp=function(e,t,n,i){var r,o=e,a=e.renderData,s=0;a&&(s=a.dataHash,r=a.material),o.stencilStage=XQ.sharedManager.stage;var c=o.stencilStage;if(this._currHash!==s||0===s||this._currMaterial!==r||this._currDepthStencilStateStage!==c)if(this.autoMergeBatches(this._currComponent),a){this._currHash=a.dataHash,this._currScene=a.renderScene,this._currComponent=o,this._currTransform=i,this._currMaterial=a.material,this._currBlendTargetHash=a.blendHash,this._currDepthStencilStateStage=c,this._currLayer=a.layer;var l=a.frame;l?(this._currTexture=l.getGFXTexture(),this._currSampler=l.getGFXSampler(),this._currTextureHash=a.textureHash,this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)}else this._currHash=s,this._currScene=o._getRenderScene(),this._currComponent=o,this._currTransform=i,this._currMaterial=o.getRenderMaterial(0),this._currBlendTargetHash=o.blendHash,this._currDepthStencilStateStage=c,this._currLayer=o.node.layer,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0);n&&n.fillBuffers(o,this)},e.commitModel=function(e,t,n){var i;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);var o=0;n&&(e.stencilStage!==iQ.ENABLED&&e.stencilStage!==iQ.DISABLED||(e.stencilStage=XQ.sharedManager.stage),i=XQ.sharedManager.getStencilStage(e.stencilStage,n),o=XQ.sharedManager.getStencilHash(e.stencilStage));var a=r.director.getTotalFrames();t&&(t.updateTransform(a),t.updateUBOs(a));for(var s=0;s<t.subModels.length;s++){var c=this._drawBatchPool.alloc(),l=t.subModels[s];c.renderScene=e._getRenderScene(),c.visFlags=e.node.layer,c.model=t,c.bufferBatch=null,c.texture=null,c.sampler=null,c.useLocalData=null,i||(i=null),c.fillPasses(n,i,o,null,0,l.patches,this),c.inputAssembler=l.inputAssembler,c.model.visFlags=c.visFlags,c.descriptorSet=l.descriptorSet,this._batches.push(c)}this._currMaterial=this._emptyMaterial,this._currScene=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currLayer=0},e.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(e){var t=this.currBufferBatch,n=null==t?void 0:t.recordBatch(),i=this._currMaterial;if(n&&i&&t){var r,o,a=0,s=0;e&&(r=-1===e.blendHash?null:e.getBlendState(),s=e.blendHash,o=null!==e.customMaterial?XQ.sharedManager.getStencilStage(e.stencilStage,i):XQ.sharedManager.getStencilStage(e.stencilStage),a=XQ.sharedManager.getStencilHash(e.stencilStage));var c=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();c.renderScene=this._currScene,c.visFlags=this._currLayer,c.bufferBatch=t,c.texture=this._currTexture,c.sampler=this._currSampler,c.inputAssembler=n,c.useLocalData=this._currTransform,c.textureHash=this._currTextureHash,c.samplerHash=this._currSamplerHash,c.fillPasses(this._currMaterial,o,a,r,s,null,this),this._batches.push(c),t.vertexStart=t.vertexOffset,t.indicesStart=t.indicesOffset,t.byteStart=t.byteOffset,ph.__isWebIOS14OrIPadOS14Env&&!this._currIsStatic&&(this._currMeshBuffer=null)}},e.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this._currScene=n._getRenderScene(),this.autoMergeBatches(n)},e.finishMergeBatches=function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.flushMaterial=function(e){this._currMaterial=e},e.walk=function(e,t){void 0===t&&(t=0);var n=e.children.length;if(this._preProcess(e),n>0&&!e._static)for(var i=e.children,r=0;r<i.length;++r){var o=i[r];this.walk(o,t)}this._postProcess(e),t+=1},e._preProcess=function(e){if(e._uiProps.opacityDirty){var t,n=1;if(null===(t=e.parent)||void 0===t?void 0:t._uiProps){n=e.parent._uiProps.opacity;var i=e._uiProps.uiComp;i&&i.markColorDirty&&(n*=i.color.a/255,i.markColorDirty())}e._uiProps.opacityDirty=!1,e._uiProps.applyOpacity(n)}var r=e._uiProps.uiComp;e._uiProps.uiTransformComp&&r&&r.enabledInHierarchy&&r.updateAssembler(this)},e._postProcess=function(e){var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)},e._recursiveScreenNode=function(e){this.walk(e),this.autoMergeBatches(this._currComponent)},e._createMeshBuffer=function(e){var t=this._bufferBatchPool.add();t.initialize(e,this._recreateMeshBuffer.bind(this,e));var n=t$(e),i=this._meshBuffers.get(n);return i||(i=[],this._meshBuffers.set(n,i)),i.push(t),t},e._recreateMeshBuffer=function(e,t,n){this.autoMergeBatches(),this._requireBufferBatch(e,t,n)},e._requireBufferBatch=function(e,t,n){var i=t$(e),r=this._meshBuffers.get(i);r||(r=[],this._meshBuffers.set(i,r));var o=this._meshBufferUseCount.get(i)||0;(t&&n||ph.__isWebIOS14OrIPadOS14Env)&&o++,this._currMeshBuffer=r[o],this._currMeshBuffer||(this._currMeshBuffer=this._createMeshBuffer(e)),this._meshBufferUseCount.set(i,o),t&&n&&this._currMeshBuffer.request(t,n)},e._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},B(t,[{key:"currBufferBatch",get:function(){return this._currMeshBuffer||(this._currMeshBuffer=this.acquireBufferBatch()),this._currMeshBuffer},set:function(e){e&&(this._currMeshBuffer=e)}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),t}()),I5=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=r.director.root.device;this._localData=new Float32Array(vd.COUNT),this._localBuffer=e.createBuffer(new Ao(wr.UNIFORM|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,vd.SIZE,vd.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=r.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,A5.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(A5),this._descriptorSet.bindBuffer(vd.BINDING,this._localBuffer);var n=Kp.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.updateLocal=function(){this._transform&&this.uploadLocalData()},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&e.updateWorldTransform(),this._transformUpdate){var t=e._mat;Mi.toArray(this._localData,t,vd.MAT_WORLD_OFFSET),Mi.inverseTranspose(w5,t);var n=Mi.determinant(w5),i=1/Math.sqrt(n);Mi.multiplyScalar(w5,w5,i),Mi.toArray(this._localData,w5,vd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},B(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),P5=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new We((function(){return new I5}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=r.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,o=0,a=i.length;o<a;o++){var s=i[o];if(s.equals(e.useLocalData,e.textureHash,e.samplerHash))return s.descriptorSet}var c=this._localCachePool.alloc();return c.initialize(e),this._localDescriptorSetCache.push(c),c.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);A5.layout=e.passes[0].localSetLayout;var l=n.device.createDescriptorSet(A5),u=Kp.SAMPLER_SPRITE;return l.bindTexture(u,e.texture),l.bindSampler(u,e.sampler),l.update(),this._descriptorSetCache.set(t,l),this._dsCacheHashByTexture.set(e.textureHash,t),l},t.update=function(){this._localDescriptorSetCache.forEach((function(e){e.updateLocal()}))},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();r.internal.Batcher2D=R5;var O5,D5,M5,N5,L5,B5,F5,z5,U5,k5,G5,H5,V5,j5,W5,q5,X5,Y5,K5,Q5,Z5,J5,$5,e8,t8,n8,i8,r8,o8,a8,s8,c8,l8,u8,h8,_8,f8,p8,d8,m8,v8,g8,y8,S8,x8,T8,E8,C8,b8,A8,w8,R8=null,I8=-1,P8="BES bswy:->@123丁ぁᄁ",O8=Object.create(null),D8=[],M8=3e3;function N8(){for(var e=!0,t=Date.now(),n=D8.length-1;n>=0;n--){var i=D8[n],r=i.fontFamilyName;if(t-i.startTime>M8)b(4933,r),i.onComplete(null,r),D8.splice(n,1);else{var o=i.refWidth,a="40px "+r;R8.font=a,o!==kK(R8,P8,a)?(D8.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(I8),I8=-1)}function L8(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(O8[i])n(null,i);else{if(!R8){var r=document.createElement("canvas");r.width=100,r.height=100,R8=r.getContext("2d")}var o=kK(R8,P8,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===O5)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);O5=e?parseInt(e[1],10)>42:!t}else O5=!1;return O5}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=M8?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(e,t){r=setTimeout(t,M8)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){b(4933,t),n(null,t)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};D8.push(u),-1===I8&&(I8=setInterval(N8,100))}O8[i]=a}}function B8(e,t,n,i){var r=new TK;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}VN.register({".font":L8,".eot":L8,".ttf":L8,".woff":L8,".svg":L8,".ttc":L8}),QN.register({".font":B8,".eot":B8,".ttf":B8,".woff":B8,".svg":B8,".ttc":B8}),r.UI={MeshBuffer:r2,spriteAssembler:S5,graphicsAssembler:T4,labelAssembler:V3};var F8,z8,U8,k8=new mi;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(F8||(F8={})),Je(F8),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(z8||(z8={})),function(e){e.CLICK="click"}(U8||(U8={}));var G8,H8,V8,j8=function(t){return e({Button:t,ButtonComponent:t}),t}((D5=al("cc.Button"),M5=Tl(),N5=cl(110),L5=gl(),B5=sl(AQ),F5=Gl($b),z5=Ml(),U5=wl(),k5=Ml(),G5=wl(),H5=Gl(F8),V5=Ml(),j5=wl(),W5=wl(),q5=wl(),X5=wl(),Y5=wl(),K5=Il(),Q5=Pl(),Z5=wl(),J5=wl(),$5=Gl(oK),e8=wl(),t8=Gl(oK),n8=wl(),i8=Gl(oK),r8=wl(),o8=Gl(oK),a8=wl(),s8=Gl([YB]),c8=Ml(),l8=wl(),D5(u8=M5(u8=N5(u8=L5(u8=B5(u8=vl((w8=A8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",_8,j(t)),X(t,"_interactable",f8,j(t)),X(t,"_transition",p8,j(t)),X(t,"_normalColor",d8,j(t)),X(t,"_hoverColor",m8,j(t)),X(t,"_pressedColor",v8,j(t)),X(t,"_disabledColor",g8,j(t)),X(t,"_normalSprite",y8,j(t)),X(t,"_hoverSprite",S8,j(t)),X(t,"_pressedSprite",x8,j(t)),X(t,"_disabledSprite",T8,j(t)),X(t,"_duration",E8,j(t)),X(t,"_zoomScale",C8,j(t)),X(t,"_target",b8,j(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new mi,t._toColor=new mi,t._time=0,t._transitionFinished=!0,t._fromScale=new gi,t._toScale=new gi,t._originalScale=null,t._sprite=null,t._targetScale=new gi,t}z(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(s1);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===F8.COLOR||this._transition===F8.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===F8.COLOR){var i=t._uiProps.uiComp;mi.lerp(k8,this._fromColor,this._toColor,n),i&&(i.color=k8)}else this.transition===F8.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=$n(this._fromScale.x,this._toScale.x,n),this._targetScale.y=$n(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===F8.COLOR&&this._interactable){var n=e.getComponent(lJ);n&&(n.color=this._normalColor)}else t===F8.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(ZE.TOUCH_START,this._onTouchBegan,this),this.node.on(ZE.TOUCH_MOVE,this._onTouchMove,this),this.node.on(ZE.TOUCH_END,this._onTouchEnded,this),this.node.on(ZE.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(ZE.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(ZE.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(ZE.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(ZE.TOUCH_START,this._onTouchBegan,this),this.node.off(ZE.TOUCH_MOVE,this._onTouchMove,this),this.node.off(ZE.TOUCH_END,this._onTouchEnded,this),this.node.off(ZE.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(ZE.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(ZE.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(ZE.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(s1)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new gi),gi.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===F8.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case z8.NORMAL:this._normalSprite=e;break;case z8.HOVER:this._hoverSprite=e;break;case z8.PRESSED:this._pressedSprite=e;break;case z8.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===F8.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case z8.NORMAL:this._normalColor=e;break;case z8.HOVER:this._hoverColor=e;break;case z8.PRESSED:this._pressedColor=e;break;case z8.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&ng.SCALE&&this._originalScale&&this._transition===F8.SCALE&&this._transitionFinished&&gi.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());this._transition===F8.SCALE&&this.target&&this._originalScale?i?(gi.copy(this._fromScale,this._originalScale),gi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?z8.PRESSED:z8.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(YB.emitEvents(this.clickEvents,e),this.node.emit(U8.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==F8.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=z8.NORMAL;return this._interactable?this._pressed?e=z8.PRESSED:this._hovered&&(e=z8.HOVER):e=z8.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(lJ);i&&(e===z8.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===z8.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(gi.copy(this._fromScale,this._originalScale),gi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(gi.copy(this._fromScale,this.target.getScale()),gi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===F8.COLOR?this._updateColorTransition(e):t===F8.SPRITE?this._updateSpriteTransition(e):t===F8.SCALE&&this._updateScaleTransition(e)},B(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===F8.COLOR?this._updateColorTransition(z8.NORMAL):this._transition===F8.SPRITE&&this._updateSpriteTransition(z8.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(s1);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(rh),A8.Transition=F8,A8.EventType=U8,Y((h8=w8).prototype,"target",[F5,z5,U5],Object.getOwnPropertyDescriptor(h8.prototype,"target"),h8.prototype),Y(h8.prototype,"interactable",[k5,G5],Object.getOwnPropertyDescriptor(h8.prototype,"interactable"),h8.prototype),Y(h8.prototype,"transition",[H5,V5,j5],Object.getOwnPropertyDescriptor(h8.prototype,"transition"),h8.prototype),Y(h8.prototype,"normalColor",[W5],Object.getOwnPropertyDescriptor(h8.prototype,"normalColor"),h8.prototype),Y(h8.prototype,"pressedColor",[q5],Object.getOwnPropertyDescriptor(h8.prototype,"pressedColor"),h8.prototype),Y(h8.prototype,"hoverColor",[X5],Object.getOwnPropertyDescriptor(h8.prototype,"hoverColor"),h8.prototype),Y(h8.prototype,"disabledColor",[Y5],Object.getOwnPropertyDescriptor(h8.prototype,"disabledColor"),h8.prototype),Y(h8.prototype,"duration",[K5,Q5,Z5],Object.getOwnPropertyDescriptor(h8.prototype,"duration"),h8.prototype),Y(h8.prototype,"zoomScale",[J5],Object.getOwnPropertyDescriptor(h8.prototype,"zoomScale"),h8.prototype),Y(h8.prototype,"normalSprite",[$5,e8],Object.getOwnPropertyDescriptor(h8.prototype,"normalSprite"),h8.prototype),Y(h8.prototype,"pressedSprite",[t8,n8],Object.getOwnPropertyDescriptor(h8.prototype,"pressedSprite"),h8.prototype),Y(h8.prototype,"hoverSprite",[i8,r8],Object.getOwnPropertyDescriptor(h8.prototype,"hoverSprite"),h8.prototype),Y(h8.prototype,"disabledSprite",[o8,a8],Object.getOwnPropertyDescriptor(h8.prototype,"disabledSprite"),h8.prototype),_8=Y(h8.prototype,"clickEvents",[s8,_l,c8,l8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),f8=Y(h8.prototype,"_interactable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),p8=Y(h8.prototype,"_transition",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return F8.NONE}}),d8=Y(h8.prototype,"_normalColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),m8=Y(h8.prototype,"_hoverColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(211,211,211,255)}}),v8=Y(h8.prototype,"_pressedColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),g8=Y(h8.prototype,"_disabledColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi(124,124,124,255)}}),y8=Y(h8.prototype,"_normalSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S8=Y(h8.prototype,"_hoverSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x8=Y(h8.prototype,"_pressedSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T8=Y(h8.prototype,"_disabledSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E8=Y(h8.prototype,"_duration",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),C8=Y(h8.prototype,"_zoomScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),b8=Y(h8.prototype,"_target",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),u8=h8))||u8)||u8)||u8)||u8)||u8)||u8)),W8=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();W8._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(G8||(G8={})),Ke(G8),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(H8||(H8={})),Ke(H8),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(V8||(V8={})),Ke(V8);var q8,X8,Y8,K8,Q8,Z8,J8,$8,e6,t6,n6,i6,r6,o6,a6,s6,c6,l6,u6,h6,_6,f6,p6,d6,m6,v6,g6,y6,S6,x6,T6,E6,C6,b6,A6,w6,R6,I6,P6,O6,D6,M6,N6,L6,B6,F6,z6,U6,k6,G6,H6,V6,j6,W6,q6,X6,Y6,K6,Q6,Z6,J6,$6=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),e7=new Mi,t7=new Mi,n7=new gi,i7=null,r7=0,o7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++r7,t}z(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===H8.ANY?this._createTextArea():this._createInput(),W8.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),W8.remove(this),i7===this&&(i7=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,W8.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){i7&&i7!==this&&i7.setFocus(!1),this._editing=!0,i7=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){r.GAME_VIEW&&this._edTxt?(r.gameView.container.appendChild(this._edTxt),r.gameView.head.appendChild(this._placeholderStyleSheet)):ZM.container&&this._edTxt&&(ZM.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(r.GAME_VIEW?ct(r.gameView.container,this._edTxt):ct(ZM.container,this._edTxt))&&this._edTxt&&(r.GAME_VIEW?r.gameView.container.removeChild(this._edTxt):ZM.container.removeChild(this._edTxt)),(r.GAME_VIEW?ct(r.gameView.head,this._placeholderStyleSheet):ct(document.head,this._placeholderStyleSheet))&&(r.GAME_VIEW?r.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),ph.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),ph.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){ph.os!==un.ANDROID&&ph.os!==un.OHOS||(hh.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){ph.os!==un.ANDROID&&ph.os!==un.OHOS||(hh.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){ph.browserType!==sn.WECHAT||ph.os!==un.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=lN.getScaleX(),n=lN.getScaleY(),i=1,o=1;r.GAME_VIEW&&(i=r.gameView.canvas.width/r.game.canvas.width,o=r.gameView.canvas.height/r.game.canvas.height),t*=i,n*=o;var a=lN.getViewportRect(),s=hh.devicePixelRatio;e.getWorldMatrix(e7);var c=e._uiProps.uiTransformComp;if(c&&gi.set(n7,-c.anchorX*c.width,-c.anchorY*c.height,n7.z),Mi.transform(e7,e7,n7),e._uiProps.uiTransformComp){var l=$M.root.batcher2D.getFirstRenderCamera(e);if(l){l.node.getWorldRT(t7);var u=t7.m12,h=t7.m13,_=nN.center;t7.m12=_.x-(t7.m00*u+t7.m04*h),t7.m13=_.y-(t7.m01*u+t7.m05*h),Mi.multiply(t7,t7,e7),t/=s,n/=s;var f=r.GAME_VIEW?r.gameView.container:ZM.container,p=t7.m00*t,d=e7.m01,m=e7.m04,v=t7.m05*n,g=parseInt(f&&f.style.paddingLeft||"0");g+=a.x*i/s;var y=parseInt(f&&f.style.paddingBottom||"0");y+=a.y/s;var S="matrix("+p+","+-d+","+-m+","+v+","+(t7.m12*t+g)+","+-(t7.m13*n+y)+")";this._edTxt.style.transform=S,this._edTxt.style["-webkit-transform"]=S,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===V8.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===V8.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===V8.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===H8.EMAIL_ADDR?a="email":t===H8.NUMERIC||t===H8.DECIMAL?a="number":t===H8.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===H8.URL?a="url":(a="text",i===G8.SEARCH&&(a="search")),r.type=a;var s="none";n===V8.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===V8.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof AK?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case fJ.HorizontalAlign.LEFT:i.style.textAlign="left";break;case fJ.HorizontalAlign.CENTER:i.style.textAlign="center";break;case fJ.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof AK?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case fJ.HorizontalAlign.LEFT:a="left";break;case fJ.HorizontalAlign.CENTER:a="center";break;case fJ.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",ph.browserType===sn.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&ph.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===iO.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===iO.TAB&&(n.propagationStopped=!0,n.preventDefault(),W8.next(e))},i.onBlur=function(){ph.isMobile&&n&&i.compositionEnd(),e._editing=!1,i7=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}($6);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(J6||(J6={}));var a7,s7,c7,l7,u7,h7,_7,f7,p7,d7,m7,v7,g7,y7,S7,x7,T7,E7,C7,b7,A7,w7,R7,I7,P7,O7,D7,M7,N7,L7,B7,F7,z7,U7,k7,G7,H7,V7,j7,W7,q7,X7,Y7,K7,Q7,Z7,J7,$7,e9,t9,n9,i9,r9,o9,a9,s9,c9,l9,u9,h9,_9=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((q8=al("cc.EditBox"),X8=Tl(),Y8=cl(110),K8=gl(),Q8=sl(AQ),Z8=Ml(),J8=wl(),$8=Ml(),e6=wl(),t6=Gl(fJ),n6=Ml(),i6=wl(),r6=Gl(fJ),o6=Ml(),a6=wl(),s6=Gl(oK),c6=Ml(),l6=wl(),u6=Gl(V8),h6=Ml(),_6=wl(),f6=Gl(H8),p6=Ml(),d6=wl(),m6=Gl(G8),v6=Ml(),g6=wl(),y6=Ml(),S6=wl(),x6=Ml(),T6=wl(),E6=Gl([YB]),C6=Ml(),b6=wl(),A6=Gl([YB]),w6=Ml(),R6=wl(),I6=Gl([YB]),P6=Ml(),O6=wl(),D6=Gl([YB]),M6=Ml(),N6=wl(),q8(L6=X8(L6=Y8(L6=K8(L6=Q8(L6=vl((Z6=Q6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",F6,j(t)),X(t,"textChanged",z6,j(t)),X(t,"editingDidEnded",U6,j(t)),X(t,"editingReturn",k6,j(t)),t._impl=null,t._background=null,X(t,"_textLabel",G6,j(t)),X(t,"_placeholderLabel",H6,j(t)),X(t,"_returnType",V6,j(t)),X(t,"_string",j6,j(t)),X(t,"_tabIndex",W6,j(t)),X(t,"_backgroundImage",q6,j(t)),X(t,"_inputFlag",X6,j(t)),X(t,"_inputMode",Y6,j(t)),X(t,"_maxLength",K6,j(t)),t._isLabelVisible=!1,t}z(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){YB.emitEvents(this.editingDidBegan,this),this.node.emit(J6.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){YB.emitEvents(this.editingDidEnded,this),this.node.emit(J6.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,YB.emitEvents(this.textChanged,e,this),this.node.emit(J6.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){YB.emitEvents(this.editingReturn,this),this.node.emit(J6.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(ZE.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(s1);e||(e=this.node.addComponent(s1)),e!==this._background&&(e.type=s1.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||(t=new $b("TEXT_LABEL")),(e=t.getComponent(fJ))||(e=t.addComponent(fJ)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=fJ.Overflow.CLAMP,this._inputMode===H8.ANY?(e.verticalAlign=aJ.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||(t=new $b("PLACEHOLDER_LABEL")),(e=t.getComponent(fJ))||(e=t.addComponent(fJ)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=fJ.Overflow.CLAMP,this._inputMode===H8.ANY?(e.verticalAlign=aJ.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==V8.PASSWORD)i===V8.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===V8.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===V8.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=e.length,a=0;a<o;++a)r+="●";e=r}return e},n._registerEvent=function(){this.node.on(ZE.TOUCH_START,this._onTouchBegan,this),this.node.on(ZE.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(ZE.TOUCH_START,this._onTouchBegan,this),this.node.off(ZE.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(s1.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(s1.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(n+2,i+e.height,o.node.position.z),this._inputMode===H8.ANY&&(o.verticalAlign=aJ.TOP),o.enableWrapText=this._inputMode===H8.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),this._inputMode===H8.ANY&&(r.verticalAlign=aJ.TOP),r.enableWrapText=this._inputMode===H8.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize)},B(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(rh),Q6._EditBoxImpl=$6,Q6.KeyboardReturnType=G8,Q6.InputFlag=V8,Q6.InputMode=H8,Q6.EventType=J6,Y((B6=Z6).prototype,"string",[Z8,J8],Object.getOwnPropertyDescriptor(B6.prototype,"string"),B6.prototype),Y(B6.prototype,"placeholder",[$8,e6],Object.getOwnPropertyDescriptor(B6.prototype,"placeholder"),B6.prototype),Y(B6.prototype,"textLabel",[t6,n6,i6],Object.getOwnPropertyDescriptor(B6.prototype,"textLabel"),B6.prototype),Y(B6.prototype,"placeholderLabel",[r6,o6,a6],Object.getOwnPropertyDescriptor(B6.prototype,"placeholderLabel"),B6.prototype),Y(B6.prototype,"backgroundImage",[s6,c6,l6],Object.getOwnPropertyDescriptor(B6.prototype,"backgroundImage"),B6.prototype),Y(B6.prototype,"inputFlag",[u6,h6,_6],Object.getOwnPropertyDescriptor(B6.prototype,"inputFlag"),B6.prototype),Y(B6.prototype,"inputMode",[f6,p6,d6],Object.getOwnPropertyDescriptor(B6.prototype,"inputMode"),B6.prototype),Y(B6.prototype,"returnType",[m6,v6,g6],Object.getOwnPropertyDescriptor(B6.prototype,"returnType"),B6.prototype),Y(B6.prototype,"maxLength",[y6,S6],Object.getOwnPropertyDescriptor(B6.prototype,"maxLength"),B6.prototype),Y(B6.prototype,"tabIndex",[x6,T6],Object.getOwnPropertyDescriptor(B6.prototype,"tabIndex"),B6.prototype),F6=Y(B6.prototype,"editingDidBegan",[E6,_l,C6,b6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z6=Y(B6.prototype,"textChanged",[A6,_l,w6,R6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),U6=Y(B6.prototype,"editingDidEnded",[I6,_l,P6,O6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),k6=Y(B6.prototype,"editingReturn",[D6,_l,M6,N6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),G6=Y(B6.prototype,"_textLabel",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H6=Y(B6.prototype,"_placeholderLabel",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),V6=Y(B6.prototype,"_returnType",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G8.DEFAULT}}),j6=Y(B6.prototype,"_string",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),W6=Y(B6.prototype,"_tabIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),q6=Y(B6.prototype,"_backgroundImage",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X6=Y(B6.prototype,"_inputFlag",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return V8.DEFAULT}}),Y6=Y(B6.prototype,"_inputMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return H8.ANY}}),K6=Y(B6.prototype,"_maxLength",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),L6=B6))||L6)||L6)||L6)||L6)||L6)||L6));"object"==typeof window&&"object"==typeof document&&(_9._EditBoxImpl=o7),function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(a9||(a9={})),Je(a9),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(s9||(s9={})),Je(s9),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(c9||(c9={})),Je(c9),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(l9||(l9={})),Je(l9),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(u9||(u9={})),Je(u9),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(h9||(h9={})),Je(h9);var f9,p9,d9,m9,v9,g9,y9,S9,x9,T9,E9,C9,b9,A9,w9,R9,I9,P9,O9,D9,M9,N9,L9,B9=new gi,F9=function(t){return e({Layout:t,LayoutComponent:t}),t}((a7=al("cc.Layout"),s7=Tl(),c7=cl(110),l7=gl(),u7=sl(AQ),h7=Cl(),_7=wl(),f7=Cl(),p7=wl(),d7=Gl(a9),m7=wl(),v7=Gl(s9),g7=Cl(),y7=wl(),S7=Cl(),x7=wl(),T7=Gl(c9),E7=wl(),C7=wl(),b7=wl(),A7=wl(),w7=wl(),R7=wl(),I7=wl(),P7=Gl(l9),O7=wl(),D7=Gl(u9),M7=wl(),N7=Gl(h9),L7=Cl(),B7=wl(),F7=Cl(),z7=wl(),U7=wl(),a7(k7=s7(k7=c7(k7=l7(k7=u7(k7=vl((o9=r9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",H7,j(t)),X(t,"_layoutType",V7,j(t)),X(t,"_cellSize",j7,j(t)),X(t,"_startAxis",W7,j(t)),X(t,"_paddingLeft",q7,j(t)),X(t,"_paddingRight",X7,j(t)),X(t,"_paddingTop",Y7,j(t)),X(t,"_paddingBottom",K7,j(t)),X(t,"_spacingX",Q7,j(t)),X(t,"_spacingY",Z7,j(t)),X(t,"_verticalDirection",J7,j(t)),X(t,"_horizontalDirection",$7,j(t)),X(t,"_constraint",e9,j(t)),X(t,"_constraintNum",t9,j(t)),X(t,"_affectedByScale",n9,j(t)),X(t,"_isAlign",i9,j(t)),t._layoutSize=new ji(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}z(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(ji.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){$M.on(JM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(ZE.SIZE_CHANGED,this._resized,this),this.node.on(ZE.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(ZE.CHILD_ADDED,this._childAdded,this),this.node.on(ZE.CHILD_REMOVED,this._childRemoved,this),this.node.on(ZE.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){$M.off(JM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(ZE.SIZE_CHANGED,this._resized,this),this.node.off(ZE.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(ZE.CHILD_ADDED,this._childAdded,this),this.node.off(ZE.CHILD_REMOVED,this._childRemoved,this),this.node.off(ZE.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(ZE.SIZE_CHANGED,this._doLayoutDirty,this),n.on(ZE.TRANSFORM_CHANGED,this._transformDirty,this),n.on(ZE.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(ZE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(ZE.SIZE_CHANGED,this._doLayoutDirty,this),n.off(ZE.TRANSFORM_CHANGED,this._transformDirty,this),n.off(ZE.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(ZE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(e){e.on(ZE.SIZE_CHANGED,this._doLayoutDirty,this),e.on(ZE.TRANSFORM_CHANGED,this._transformDirty,this),e.on(ZE.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(ZE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(ZE.SIZE_CHANGED,this._doLayoutDirty,this),e.off(ZE.TRANSFORM_CHANGED,this._transformDirty,this),e.off(ZE.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(ZE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===u9.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==a9.GRID&&this._resizeMode===s9.CHILDREN&&(m=(e-v-(d-1)*this._spacingX)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],x=S.node,T=x.scale,E=this._getUsedScaleValue(T.x),C=this._getUsedScaleValue(T.y);this._resizeMode===s9.CHILDREN&&(S.width=m/E,this._layoutType===a9.GRID&&(S.height=this._cellSize.height/C));var b=Math.abs(this._horizontalDirection-S.anchorX),A=S.width*E,w=S.height*C;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=a*(b*A+this._spacingX);var R=a*(1-b)*A;if(t){if(o>0)(p=y/o>0&&y%o==0)&&(h=_>w?_:h);else if(A>e-v)l>c+a*b*A&&(p=!0);else{var I=(1-this._horizontalDirection-r.x)*e,P=l+R+a*(a>0?this._paddingRight:this._paddingLeft);p=Math.abs(P)>Math.abs(I)}p&&(l=c+a*b*A,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var O=n(x,S,u);i&&x.setPosition(l,O),l+=R}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===l9.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==a9.GRID&&this._resizeMode===s9.CHILDREN&&(m=(e-v-(d-1)*this._spacingY)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],x=S.node,T=x.scale,E=this._getUsedScaleValue(T.x),C=this._getUsedScaleValue(T.y);this._resizeMode===s9.CHILDREN&&(S.height=m/C,this._layoutType===a9.GRID&&(S.width=this._cellSize.width/E));var b=Math.abs(this._verticalDirection-S.anchorY),A=S.width*E,w=S.height*C;A>u&&(h=Math.max(u,h),_=u||A,u=A),l+=a*(b*w+this._spacingY);var R=a*(1-b)*w;if(t){if(o>0)(p=y/o>0&&y%o==0)&&(_=u>w?u:_);else if(w>e-v)l>c+a*b*w&&(p=!0);else{var I=(1-this._verticalDirection-r.y)*e,P=l+R+a*(a>0?this._paddingTop:this._paddingBottom);p=Math.abs(P)>Math.abs(I)}p&&(l=c+a*b*w,A!==u&&(_=u),f+=_+this._spacingX,_=u=A)}var O=n(x,S,f);i&&(x.getPosition(B9),x.setPosition(O,l,B9.z)),l+=R}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,o=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===l9.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*t.height,a=this._paddingTop);var s=function(e,t,i){return o+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+a)},c=0;this._resizeMode===s9.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-e.y*c,this._verticalDirection===l9.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===s9.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,o=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===u9.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*t.width,a=this._paddingRight);var s=function(e,t,i){return o+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+a)},c=0;this._resizeMode===s9.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-e.x*c,this._horizontalDirection===u9.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===s9.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===c9.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===c9.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===s9.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===s9.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===a9.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?gi.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===a9.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?gi.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===a9.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&ng.SCALE&&e&ng.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==a9.GRID||this._constraint===h9.NONE||this._constraintNum<=0)return 0;var e=this._constraint===h9.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===c9.VERTICAL&&(e=this._constraint===h9.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},B(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===a9.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===a9.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==a9.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==a9.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==h9.NONE&&this._constraintNum!==e&&(e<=0&&d("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(rh),r9.Type=a9,r9.VerticalDirection=l9,r9.HorizontalDirection=u9,r9.ResizeMode=s9,r9.AxisDirection=c9,r9.Constraint=h9,Y((G7=o9).prototype,"alignHorizontal",[h7,_7],Object.getOwnPropertyDescriptor(G7.prototype,"alignHorizontal"),G7.prototype),Y(G7.prototype,"alignVertical",[f7,p7],Object.getOwnPropertyDescriptor(G7.prototype,"alignVertical"),G7.prototype),Y(G7.prototype,"type",[d7,m7],Object.getOwnPropertyDescriptor(G7.prototype,"type"),G7.prototype),Y(G7.prototype,"resizeMode",[v7,g7,y7],Object.getOwnPropertyDescriptor(G7.prototype,"resizeMode"),G7.prototype),Y(G7.prototype,"cellSize",[S7,x7],Object.getOwnPropertyDescriptor(G7.prototype,"cellSize"),G7.prototype),Y(G7.prototype,"startAxis",[T7,E7],Object.getOwnPropertyDescriptor(G7.prototype,"startAxis"),G7.prototype),Y(G7.prototype,"paddingLeft",[C7],Object.getOwnPropertyDescriptor(G7.prototype,"paddingLeft"),G7.prototype),Y(G7.prototype,"paddingRight",[b7],Object.getOwnPropertyDescriptor(G7.prototype,"paddingRight"),G7.prototype),Y(G7.prototype,"paddingTop",[A7],Object.getOwnPropertyDescriptor(G7.prototype,"paddingTop"),G7.prototype),Y(G7.prototype,"paddingBottom",[w7],Object.getOwnPropertyDescriptor(G7.prototype,"paddingBottom"),G7.prototype),Y(G7.prototype,"spacingX",[R7],Object.getOwnPropertyDescriptor(G7.prototype,"spacingX"),G7.prototype),Y(G7.prototype,"spacingY",[I7],Object.getOwnPropertyDescriptor(G7.prototype,"spacingY"),G7.prototype),Y(G7.prototype,"verticalDirection",[P7,O7],Object.getOwnPropertyDescriptor(G7.prototype,"verticalDirection"),G7.prototype),Y(G7.prototype,"horizontalDirection",[D7,M7],Object.getOwnPropertyDescriptor(G7.prototype,"horizontalDirection"),G7.prototype),Y(G7.prototype,"constraint",[N7,L7,B7],Object.getOwnPropertyDescriptor(G7.prototype,"constraint"),G7.prototype),Y(G7.prototype,"constraintNum",[F7,z7],Object.getOwnPropertyDescriptor(G7.prototype,"constraintNum"),G7.prototype),Y(G7.prototype,"affectedByScale",[U7],Object.getOwnPropertyDescriptor(G7.prototype,"affectedByScale"),G7.prototype),H7=Y(G7.prototype,"_resizeMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return s9.NONE}}),V7=Y(G7.prototype,"_layoutType",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a9.NONE}}),j7=Y(G7.prototype,"_cellSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ji(40,40)}}),W7=Y(G7.prototype,"_startAxis",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return c9.HORIZONTAL}}),q7=Y(G7.prototype,"_paddingLeft",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X7=Y(G7.prototype,"_paddingRight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y7=Y(G7.prototype,"_paddingTop",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),K7=Y(G7.prototype,"_paddingBottom",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q7=Y(G7.prototype,"_spacingX",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Z7=Y(G7.prototype,"_spacingY",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),J7=Y(G7.prototype,"_verticalDirection",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return l9.TOP_TO_BOTTOM}}),$7=Y(G7.prototype,"_horizontalDirection",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return u9.LEFT_TO_RIGHT}}),e9=Y(G7.prototype,"_constraint",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return h9.NONE}}),t9=Y(G7.prototype,"_constraintNum",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),n9=Y(G7.prototype,"_affectedByScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i9=Y(G7.prototype,"_isAlign",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k7=G7))||k7)||k7)||k7)||k7)||k7)||k7));!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(L9||(L9={})),Ke(L9);var z9,U9,k9,G9,H9,V9,j9,W9,q9,X9,Y9,K9,Q9,Z9,J9,$9,eee,tee,nee,iee,ree,oee,aee,see,cee,lee=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((f9=al("cc.ProgressBar"),p9=Tl(),d9=cl(110),m9=gl(),v9=sl(AQ),g9=Gl(s1),y9=wl(),S9=Gl(L9),x9=wl(),T9=wl(),E9=Rl(),C9=wl(),b9=wl(),f9(A9=p9(A9=d9(A9=m9(A9=v9((N9=M9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",R9,j(t)),X(t,"_mode",I9,j(t)),X(t,"_totalLength",P9,j(t)),X(t,"_progress",O9,j(t)),X(t,"_reverse",D9,j(t)),t}z(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===s1.FillType.RADIAL&&(this._mode=L9.FILLED),this._mode===L9.HORIZONTAL?this.totalLength=r.width:this._mode===L9.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var o=-n.width*i.x;e.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),o=new Fi(0,.5),a=Jn(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case L9.HORIZONTAL:this._reverse&&(o=new Fi(1,.5)),c=new ji(s,i.height),l=this._totalLength,u=i.height;break;case L9.VERTICAL:o=this._reverse?new Fi(.5,1):new Fi(.5,0),c=new ji(i.width,s),l=i.width,u=this._totalLength}if(this._mode===L9.FILLED)this._barSprite.type!==s1.Type.FILLED?d("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==s1.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new gi(l*h,u*_,0);e.setPosition(r.x+f.x,r.y+f.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)}else d("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},B(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===L9.HORIZONTAL?this.totalLength=n.width:this._mode===L9.VERTICAL?this.totalLength=n.height:this._mode===L9.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===L9.FILLED&&(e=Jn(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(rh),M9.Mode=L9,Y((w9=N9).prototype,"barSprite",[g9,y9],Object.getOwnPropertyDescriptor(w9.prototype,"barSprite"),w9.prototype),Y(w9.prototype,"mode",[S9,x9],Object.getOwnPropertyDescriptor(w9.prototype,"mode"),w9.prototype),Y(w9.prototype,"totalLength",[T9],Object.getOwnPropertyDescriptor(w9.prototype,"totalLength"),w9.prototype),Y(w9.prototype,"progress",[E9,Dl,C9],Object.getOwnPropertyDescriptor(w9.prototype,"progress"),w9.prototype),Y(w9.prototype,"reverse",[b9],Object.getOwnPropertyDescriptor(w9.prototype,"reverse"),w9.prototype),R9=Y(w9.prototype,"_barSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I9=Y(w9.prototype,"_mode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L9.HORIZONTAL}}),P9=Y(w9.prototype,"_totalLength",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),O9=Y(w9.prototype,"_progress",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),D9=Y(w9.prototype,"_reverse",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),A9=w9))||A9)||A9)||A9)||A9)||A9)),uee=new gi,hee=new gi,_ee=new gi,fee=new Fi,pee=new mi,dee=new Fi;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(cee||(cee={})),Je(cee);var mee,vee,gee,yee,See,xee,Tee,Eee,Cee,bee,Aee,wee,Ree,Iee,Pee,Oee,Dee,Mee,Nee,Lee,Bee,Fee,zee,Uee,kee,Gee,Hee,Vee,jee,Wee,qee,Xee,Yee,Kee,Qee,Zee,Jee,$ee,ete,tte,nte,ite,rte,ote,ate,ste,cte,lte,ute,hte=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((z9=al("cc.ScrollBar"),U9=Tl(),k9=cl(110),G9=gl(),H9=sl(AQ),V9=Gl(s1),j9=Ml(),W9=wl(),q9=Gl(cee),X9=Ml(),Y9=wl(),K9=Ml(),Q9=wl(),Z9=Ml(),J9=wl(),z9($9=U9($9=k9($9=G9($9=H9((see=aee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",tee,j(t)),X(t,"_handle",nee,j(t)),X(t,"_direction",iee,j(t)),X(t,"_enableAutoHide",ree,j(t)),X(t,"_autoHideTime",oee,j(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}z(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=dee;u.set(0,0),this._direction===cee.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===cee.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(o,a,l,s),_=dee;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(s1);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){uee.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(uee,hee);var r=n.convertToNodeSpaceAR(hee);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(Fi.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(s1);t&&(pee.set(t.color),pee.a=e,t.color=pee),(t=this._handle.getComponent(s1))&&(pee.set(t.color),pee.a=e,t.color=pee)}},n._updateHandlerPosition=function(e){if(this._handle){var t=_ee;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;gi.set(uee,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(uee,hee),s=e;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===cee.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===cee.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===cee.HORIZONTAL||e.height<=t.height&&this._direction===cee.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,o,a){var s=t-n;o&&(s+=Math.abs(o));var c=0;s&&(c=Jn(c=r/s));var l=(i-a)*c;this._direction===cee.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===fee.x&&i.y===fee.y||t.setAnchorPoint(fee),this._direction===cee.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},B(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(Fi.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(Fi.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(rh),aee.Direction=cee,Y((eee=see).prototype,"handle",[V9,j9,W9],Object.getOwnPropertyDescriptor(eee.prototype,"handle"),eee.prototype),Y(eee.prototype,"direction",[q9,X9,Y9],Object.getOwnPropertyDescriptor(eee.prototype,"direction"),eee.prototype),Y(eee.prototype,"enableAutoHide",[K9,Q9],Object.getOwnPropertyDescriptor(eee.prototype,"enableAutoHide"),eee.prototype),Y(eee.prototype,"autoHideTime",[Z9,J9],Object.getOwnPropertyDescriptor(eee.prototype,"autoHideTime"),eee.prototype),tee=Y(eee.prototype,"_scrollView",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nee=Y(eee.prototype,"_handle",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iee=Y(eee.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cee.HORIZONTAL}}),ree=Y(eee.prototype,"_enableAutoHide",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oee=Y(eee.prototype,"_autoHideTime",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$9=eee))||$9)||$9)||$9)||$9)||$9)),_te=e("ViewGroup",al("cc.ViewGroup")(mee=cl(110)(mee=function(e){function t(){return e.apply(this,arguments)||this}return z(t,e),t}(rh))||mee)||mee);r.ViewGroup=_te;var fte,pte=1e-4,dte=new gi,mte=new gi,vte=new Fi,gte=new Fi,yte=function(){return(new Date).getMilliseconds()},Ste={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(fte||(fte={}));var xte,Tte,Ete,Cte,bte,Ate,wte,Rte,Ite,Pte,Ote,Dte,Mte,Nte,Lte,Bte,Fte,zte,Ute,kte,Gte,Hte,Vte=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((vee=al("cc.ScrollView"),gee=Tl(),yee=cl(110),See=gl(),xee=sl(AQ),Tee=Rl(),Eee=Ml(),Cee=wl(),bee=Rl(),Aee=Ml(),wee=wl(),Ree=Ml(),Iee=wl(),Pee=Ml(),Oee=wl(),Dee=Gl($b),Mee=Ml(),Nee=wl(),Lee=Ml(),Bee=wl(),Fee=Gl(hte),zee=Ml(),Uee=wl(),kee=Ml(),Gee=wl(),Hee=Gl(hte),Vee=Ml(),jee=wl(),Wee=Ml(),qee=wl(),Xee=Gl([YB]),Yee=Ml(),Kee=wl(),vee(Qee=gee(Qee=yee(Qee=See(Qee=xee((ute=lte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",Jee,j(t)),X(t,"brake",$ee,j(t)),X(t,"elastic",ete,j(t)),X(t,"inertia",tte,j(t)),X(t,"horizontal",nte,j(t)),X(t,"vertical",ite,j(t)),X(t,"cancelInnerEvents",rte,j(t)),X(t,"scrollEvents",ote,j(t)),t._autoScrolling=!1,t._scrolling=!1,X(t,"_content",ate,j(t)),X(t,"_horizontalScrollBar",ste,j(t)),X(t,"_verticalScrollBar",cte,j(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new gi,t._autoScrollTargetDelta=new gi,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new gi,t._outOfBoundaryAmount=new gi,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new gi,t._deltaPos=new gi,t}z(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Fi(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Fi(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Fi(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Fi(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Fi(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Fi(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Fi(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Fi(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Fi(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Fi(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Fi.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new Fi(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Fi(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Fi(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Fi(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<pte&&Math.abs(e.y-t.y)<pte||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):gi.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return pte},n.start=function(){this._calculateBoundary(),this._content&&$M.once(JM.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(ZE.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(ZE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(ZE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(ZE.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(ZE.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(ZE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(ZE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(ZE.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(ZE.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(ZE.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(ZE.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(ZE.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(ZE.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(ZE.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(ZE.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(ZE.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(ZE.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(ZE.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new gi,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(vte);if(i.subtract(n.getUIStartLocation(gte)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new nO(e.getTouches(),e.bubbles,XA.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(fte.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent(F9);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==ZP.CAPTURING_PHASE)return!1;if(t)for(var n,i=q(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(_te));if(r.getComponent(_te))return!0}return!1},n._startInertiaScroll=function(e){var t=new gi(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,gi.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(gi.ZERO,pte)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new gi,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(gi.ZERO);else{var n=new gi;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);dte.set(this._getContentPosition()),dte.add(n),dte.set(Math.round(1e4*dte.x)*pte,Math.round(1e4*dte.y)*pte,dte.z),this._setContentPosition(dte);var i=this._getHowMuchOutOfBoundary();vte.set(i.x,i.y),this._updateScrollBar(vte),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new gi).equals(gi.ZERO,pte)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new gi,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):o+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(o+e.y)),e.equals(gi.ZERO,pte)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===fte.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===fte.SCROLL_TO_TOP||e===fte.SCROLL_TO_BOTTOM||e===fte.SCROLL_TO_LEFT||e===fte.SCROLL_TO_RIGHT){var t=1<<Ste[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}YB.emitEvents(this.scrollEvents,this,Ste[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();dte.set(this._getContentPosition()),dte.add(e),this._content.setPosition(dte),this._updateScrollBar(Fi.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===ZP.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(fte.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new gi;n&&(t.getUILocation(vte),t.getUIPreviousLocation(gte),dte.set(vte.x,vte.y,0),mte.set(gte.x,gte.y,0),n.convertToNodeSpaceAR(dte,dte),n.convertToNodeSpaceAR(mte,mte),gi.subtract(i,dte,mte)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||gi.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=fte.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=fte.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=fte.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=fte.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(fte.SCROLL_BEGAN)),this._dispatchEvent(fte.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(fte.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=yte(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=yte();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(gi.ZERO,pte))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(fte.BOUNCE_TOP),e.y<0&&this._dispatchEvent(fte.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(fte.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(fte.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(dte,pte)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(gi.ZERO,pte)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=pte;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(fte.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(gi.ZERO,pte)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(fte.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(fte.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(gi.ZERO,pte))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(fte.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(fte.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(Fi.ZERO,Fi.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new gi;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*t.x),i&&(s=c.height-l.height,a.y=r-s*t.y)}return a},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new gi,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(i=o.height-e.height,n.y=t-i),o.width<e.width&&(i=o.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===ng.SCALE&&this._calculateBoundary()},B(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):E(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Fi.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Fi.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(_te),lte.EventType=fte,Jee=Y((Zee=ute).prototype,"bounceDuration",[_l,Tee,Eee,Cee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$ee=Y(Zee.prototype,"brake",[_l,bee,Aee,wee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),ete=Y(Zee.prototype,"elastic",[_l,Ree,Iee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tte=Y(Zee.prototype,"inertia",[_l,Pee,Oee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y(Zee.prototype,"content",[Dee,Mee,Nee],Object.getOwnPropertyDescriptor(Zee.prototype,"content"),Zee.prototype),nte=Y(Zee.prototype,"horizontal",[_l,Lee,Bee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y(Zee.prototype,"horizontalScrollBar",[Fee,zee,Uee],Object.getOwnPropertyDescriptor(Zee.prototype,"horizontalScrollBar"),Zee.prototype),ite=Y(Zee.prototype,"vertical",[_l,kee,Gee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y(Zee.prototype,"verticalScrollBar",[Hee,Vee,jee],Object.getOwnPropertyDescriptor(Zee.prototype,"verticalScrollBar"),Zee.prototype),rte=Y(Zee.prototype,"cancelInnerEvents",[_l,Wee,qee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ote=Y(Zee.prototype,"scrollEvents",[Xee,_l,Yee,Kee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ate=Y(Zee.prototype,"_content",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ste=Y(Zee.prototype,"_horizontalScrollBar",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cte=Y(Zee.prototype,"_verticalScrollBar",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qee=Zee))||Qee)||Qee)||Qee)||Qee)||Qee)),jte=new gi;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Hte||(Hte={})),Je(Hte);var Wte,qte,Xte,Yte,Kte,Qte,Zte,Jte,$te,ene,tne,nne,ine,rne,one,ane,sne,cne,lne,une,hne=function(t){return e({Slider:t,SliderComponent:t}),t}((xte=al("cc.Slider"),Tte=Tl(),Ete=cl(110),Cte=gl(),bte=sl(AQ),Ate=Gl(s1),wte=wl(),Rte=Gl(Hte),Ite=wl(),Pte=Rl(),Ote=wl(),Dte=Gl([YB]),Mte=wl(),xte(Nte=Tte(Nte=Ete(Nte=Cte(Nte=bte((Gte=kte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",Bte,j(t)),X(t,"_handle",Fte,j(t)),X(t,"_direction",zte,j(t)),X(t,"_progress",Ute,j(t)),t._offset=new gi,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new gi,t._touchPos=new gi,t}z(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(ZE.TOUCH_START,this._onTouchBegan,this),this.node.on(ZE.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(ZE.TOUCH_END,this._onTouchEnded,this),this.node.on(ZE.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(ZE.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(ZE.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(ZE.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(ZE.TOUCH_START,this._onTouchBegan,this),this.node.off(ZE.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(ZE.TOUCH_END,this._onTouchEnded,this),this.node.off(ZE.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(ZE.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(ZE.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(ZE.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();gi.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new gi,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){YB.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();gi.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,jte);this.direction===Hte.Horizontal?this.progress=Jn(.5+(i.x-this._offset.x)/n.width):this.progress=Jn(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===Hte.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===Hte.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},B(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(rh),kte.Direction=Hte,Y((Lte=Gte).prototype,"handle",[Ate,wte],Object.getOwnPropertyDescriptor(Lte.prototype,"handle"),Lte.prototype),Y(Lte.prototype,"direction",[Rte,Ite],Object.getOwnPropertyDescriptor(Lte.prototype,"direction"),Lte.prototype),Y(Lte.prototype,"progress",[Dl,Pte,Ote],Object.getOwnPropertyDescriptor(Lte.prototype,"progress"),Lte.prototype),Bte=Y(Lte.prototype,"slideEvents",[Dte,_l,Mte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fte=Y(Lte.prototype,"_handle",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zte=Y(Lte.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hte.Horizontal}}),Ute=Y(Lte.prototype,"_progress",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Nte=Lte))||Nte)||Nte)||Nte)||Nte)||Nte));function _ne(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}!function(e){e.TOGGLE="toggle"}(une||(une={}));var fne,pne,dne,mne,vne,gne,yne,Sne,xne,Tne,Ene,Cne,bne,Ane,wne,Rne,Ine,Pne,One,Dne,Mne,Nne,Lne,Bne,Fne,zne,Une,kne,Gne,Hne,Vne,jne,Wne,qne,Xne,Yne,Kne,Qne,Zne,Jne,$ne,eie,tie,nie,iie,rie,oie,aie,sie,cie,lie,uie,hie,_ie,fie,pie,die,mie,vie,gie=function(t){return e({Toggle:t,ToggleComponent:t}),t}((Wte=al("cc.Toggle"),qte=Tl(),Xte=cl(110),Yte=gl(),Kte=sl(AQ),Qte=Ml(),Zte=wl(),Jte=Gl(s1),$te=Ml(),ene=wl(),tne=Gl([YB]),nne=wl(),Wte(ine=qte(ine=Xte(ine=Yte(ine=Kte((lne=cne=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",one,j(t)),X(t,"_isChecked",ane,j(t)),X(t,"_checkMark",sne,j(t)),t}z(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&YB.emitEvents(this.checkEvents,this)},B(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return r.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(j8),cne.EventType=_ne(une,U8),Y((rne=lne).prototype,"isChecked",[Qte,Zte],Object.getOwnPropertyDescriptor(rne.prototype,"isChecked"),rne.prototype),Y(rne.prototype,"checkMark",[Jte,$te,ene],Object.getOwnPropertyDescriptor(rne.prototype,"checkMark"),rne.prototype),one=Y(rne.prototype,"checkEvents",[tne,_l,nne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ane=Y(rne.prototype,"_isChecked",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sne=Y(rne.prototype,"_checkMark",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ine=rne))||ine)||ine)||ine)||ine)||ine)),yie=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((fne=al("cc.ToggleContainer"),pne=Tl(),dne=cl(110),mne=gl(),vne=wl(),gne=Gl([YB]),yne=wl(),fne(Sne=pne(Sne=dne(Sne=mne(Sne=vl((Cne=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",Tne,j(t)),X(t,"checkEvents",Ene,j(t)),t}z(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(ZE.CHILD_ADDED,this.ensureValidState,this),this.node.on(ZE.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(ZE.CHILD_ADDED,this.ensureValidState,this),this.node.off(ZE.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==e&&(t?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&r.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},B(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(rh),Tne=Y((xne=Cne).prototype,"_allowSwitchOff",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(xne.prototype,"allowSwitchOff",[vne],Object.getOwnPropertyDescriptor(xne.prototype,"allowSwitchOff"),xne.prototype),Ene=Y(xne.prototype,"checkEvents",[gne,_l,yne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sne=xne))||Sne)||Sne)||Sne)||Sne)||Sne)),Sie=new Fi;function xie(e){return e instanceof OO?nN:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:ji.ZERO}function Tie(e,t,n,i){e.parent?Sie.set(e.parent.getScale().x,e.parent.getScale().y):Sie.set(0,0);for(var r=Sie.x,o=Sie.y,a=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?Sie.set(c.getScale().x,c.getScale().y):Sie.set(0,0);var u=Sie.x,h=Sie.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(mie||(mie={})),Je(mie),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(vie||(vie={}));var Eie,Cie,bie,Aie,wie,Rie,Iie,Pie,Oie,Die,Mie,Nie,Lie,Bie,Fie,zie,Uie,kie,Gie,Hie=vie.TOP|vie.BOT,Vie=vie.LEFT|vie.RIGHT,jie=function(t){return e({Widget:t,WidgetComponent:t}),t}((bne=al("cc.Widget"),Ane=Tl(),wne=cl(110),Rne=gl(),Ine=sl(AQ),Pne=Gl($b),One=wl(),Dne=wl(),Mne=wl(),Nne=wl(),Lne=wl(),Bne=wl(),Fne=wl(),zne=Cl(),Une=Cl(),kne=wl(),Gne=wl(),Hne=wl(),Vne=wl(),jne=wl(),Wne=wl(),qne=Gl(mie),Xne=wl(),bne(Yne=Ane(Yne=wne(Yne=Rne(Yne=Ine(Yne=vl((die=pie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new gi,t._lastSize=new ji,t._dirty=!0,t._hadAlignOnce=!1,X(t,"_alignFlags",Qne,j(t)),X(t,"_target",Zne,j(t)),X(t,"_left",Jne,j(t)),X(t,"_right",$ne,j(t)),X(t,"_top",eie,j(t)),X(t,"_bottom",tie,j(t)),X(t,"_horizontalCenter",nie,j(t)),X(t,"_verticalCenter",iie,j(t)),X(t,"_isAbsLeft",rie,j(t)),X(t,"_isAbsRight",oie,j(t)),X(t,"_isAbsTop",aie,j(t)),X(t,"_isAbsBottom",sie,j(t)),X(t,"_isAbsHorizontalCenter",cie,j(t)),X(t,"_isAbsVerticalCenter",lie,j(t)),X(t,"_originalWidth",uie,j(t)),X(t,"_originalHeight",hie,j(t)),X(t,"_alignMode",_ie,j(t)),X(t,"_lockFlags",fie,j(t)),t}z(t,e);var n=t.prototype;return n.updateAlignment=function(){r._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),r._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){r._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(ZE.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(ZE.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(ZE.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(ZE.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(ZE.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(ZE.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(ZE.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(ZE.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:nN;this.isAlignLeft&&e===vie.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===vie.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===vie.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===vie.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===vie.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===vie.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(AQ)&&(e.on(ZE.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(ZE.SIZE_CHANGED,this._setDirtyByMode,this),e.on(ZE.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(ZE.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(ZE.SIZE_CHANGED,this._setDirtyByMode,this),e.off(ZE.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(ZE.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(ZE.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===mie.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&Vie)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},B(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&vie.TOP)>0},set:function(e){this._setAlign(vie.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&vie.BOT)>0},set:function(e){this._setAlign(vie.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&vie.LEFT)>0},set:function(e){this._setAlign(vie.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&vie.RIGHT)>0},set:function(e){this._setAlign(vie.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&vie.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=vie.MID):this._alignFlags&=~vie.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&vie.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=vie.CENTER):this._alignFlags&=~vie.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&Vie)===Vie}},{key:"isStretchHeight",get:function(){return(this._alignFlags&Hie)===Hie}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(vie.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(vie.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(vie.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(vie.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(vie.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(vie.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(rh),pie.AlignMode=mie,Y((Kne=die).prototype,"target",[Pne,One],Object.getOwnPropertyDescriptor(Kne.prototype,"target"),Kne.prototype),Y(Kne.prototype,"isAlignTop",[Dne],Object.getOwnPropertyDescriptor(Kne.prototype,"isAlignTop"),Kne.prototype),Y(Kne.prototype,"isAlignBottom",[Mne],Object.getOwnPropertyDescriptor(Kne.prototype,"isAlignBottom"),Kne.prototype),Y(Kne.prototype,"isAlignLeft",[Nne],Object.getOwnPropertyDescriptor(Kne.prototype,"isAlignLeft"),Kne.prototype),Y(Kne.prototype,"isAlignRight",[Lne],Object.getOwnPropertyDescriptor(Kne.prototype,"isAlignRight"),Kne.prototype),Y(Kne.prototype,"isAlignVerticalCenter",[Bne],Object.getOwnPropertyDescriptor(Kne.prototype,"isAlignVerticalCenter"),Kne.prototype),Y(Kne.prototype,"isAlignHorizontalCenter",[Fne],Object.getOwnPropertyDescriptor(Kne.prototype,"isAlignHorizontalCenter"),Kne.prototype),Y(Kne.prototype,"isStretchWidth",[zne],Object.getOwnPropertyDescriptor(Kne.prototype,"isStretchWidth"),Kne.prototype),Y(Kne.prototype,"isStretchHeight",[Une],Object.getOwnPropertyDescriptor(Kne.prototype,"isStretchHeight"),Kne.prototype),Y(Kne.prototype,"top",[kne],Object.getOwnPropertyDescriptor(Kne.prototype,"top"),Kne.prototype),Y(Kne.prototype,"editorTop",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"editorTop"),Kne.prototype),Y(Kne.prototype,"bottom",[Gne],Object.getOwnPropertyDescriptor(Kne.prototype,"bottom"),Kne.prototype),Y(Kne.prototype,"editorBottom",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"editorBottom"),Kne.prototype),Y(Kne.prototype,"left",[Hne],Object.getOwnPropertyDescriptor(Kne.prototype,"left"),Kne.prototype),Y(Kne.prototype,"editorLeft",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"editorLeft"),Kne.prototype),Y(Kne.prototype,"right",[Vne],Object.getOwnPropertyDescriptor(Kne.prototype,"right"),Kne.prototype),Y(Kne.prototype,"editorRight",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"editorRight"),Kne.prototype),Y(Kne.prototype,"horizontalCenter",[jne],Object.getOwnPropertyDescriptor(Kne.prototype,"horizontalCenter"),Kne.prototype),Y(Kne.prototype,"editorHorizontalCenter",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"editorHorizontalCenter"),Kne.prototype),Y(Kne.prototype,"verticalCenter",[Wne],Object.getOwnPropertyDescriptor(Kne.prototype,"verticalCenter"),Kne.prototype),Y(Kne.prototype,"editorVerticalCenter",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"editorVerticalCenter"),Kne.prototype),Y(Kne.prototype,"isAbsoluteTop",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"isAbsoluteTop"),Kne.prototype),Y(Kne.prototype,"isAbsoluteBottom",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"isAbsoluteBottom"),Kne.prototype),Y(Kne.prototype,"isAbsoluteLeft",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"isAbsoluteLeft"),Kne.prototype),Y(Kne.prototype,"isAbsoluteRight",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"isAbsoluteRight"),Kne.prototype),Y(Kne.prototype,"isAbsoluteHorizontalCenter",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"isAbsoluteHorizontalCenter"),Kne.prototype),Y(Kne.prototype,"isAbsoluteVerticalCenter",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"isAbsoluteVerticalCenter"),Kne.prototype),Y(Kne.prototype,"alignMode",[qne,Xne],Object.getOwnPropertyDescriptor(Kne.prototype,"alignMode"),Kne.prototype),Y(Kne.prototype,"alignFlags",[El],Object.getOwnPropertyDescriptor(Kne.prototype,"alignFlags"),Kne.prototype),Qne=Y(Kne.prototype,"_alignFlags",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zne=Y(Kne.prototype,"_target",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jne=Y(Kne.prototype,"_left",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$ne=Y(Kne.prototype,"_right",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eie=Y(Kne.prototype,"_top",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tie=Y(Kne.prototype,"_bottom",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nie=Y(Kne.prototype,"_horizontalCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iie=Y(Kne.prototype,"_verticalCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rie=Y(Kne.prototype,"_isAbsLeft",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oie=Y(Kne.prototype,"_isAbsRight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),aie=Y(Kne.prototype,"_isAbsTop",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sie=Y(Kne.prototype,"_isAbsBottom",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cie=Y(Kne.prototype,"_isAbsHorizontalCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lie=Y(Kne.prototype,"_isAbsVerticalCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uie=Y(Kne.prototype,"_originalWidth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hie=Y(Kne.prototype,"_originalHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_ie=Y(Kne.prototype,"_alignMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mie.ON_WINDOW_RESIZE}}),fie=Y(Kne.prototype,"_lockFlags",[_l,pl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yne=Kne))||Yne)||Yne)||Yne)||Yne)||Yne)||Yne));r.internal.computeInverseTransForTarget=Tie,r.internal.getReadonlyNodeSize=xie;var Wie,qie=new mi;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Wie||(Wie={})),Je(Wie);var Xie,Yie,Kie,Qie,Zie,Jie,$ie,ere,tre,nre,ire,rre,ore,are,sre,cre,lre,ure,hre,_re,fre,pre,dre,mre,vre,gre,yre,Sre,xre,Tre,Ere,Cre,bre,Are,wre,Rre,Ire,Pre,Ore,Dre,Mre,Nre,Lre,Bre,Fre,zre,Ure=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((Eie=al("cc.PageViewIndicator"),Cie=Tl(),bie=cl(110),Aie=gl(),wie=Gl(oK),Rie=wl(),Iie=Gl(Wie),Pie=wl(),Oie=Gl(ji),Die=wl(),Mie=wl(),Eie(Nie=Cie(Nie=bie(Nie=Aie((Gie=kie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"spacing",Bie,j(t)),X(t,"_spriteFrame",Fie,j(t)),X(t,"_direction",zie,j(t)),X(t,"_cellSize",Uie,j(t)),t._layout=null,t._pageView=null,t._indicators=[],t}z(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(F9),this._layout||(this._layout=this.addComponent(F9));var e=this._layout;this.direction===Wie.HORIZONTAL?(e.type=F9.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===Wie.VERTICAL&&(e.type=F9.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=F9.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new $b;e.layer=this.node.layer;var t=e.addComponent(s1);return t.spriteFrame=this.spriteFrame,t.sizeMode=s1.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;qie.set(r.color),qie.a=127.5,r.color=qie}}if(e[t]._uiProps.uiComp){var o=e[t]._uiProps.uiComp;qie.set(o.color),qie.a=255,o.color=qie}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},B(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(rh),kie.Direction=Wie,Y((Lie=Gie).prototype,"spriteFrame",[wie,Rie],Object.getOwnPropertyDescriptor(Lie.prototype,"spriteFrame"),Lie.prototype),Y(Lie.prototype,"direction",[Iie,Pie],Object.getOwnPropertyDescriptor(Lie.prototype,"direction"),Lie.prototype),Y(Lie.prototype,"cellSize",[Oie,Die],Object.getOwnPropertyDescriptor(Lie.prototype,"cellSize"),Lie.prototype),Bie=Y(Lie.prototype,"spacing",[_l,Mie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fie=Y(Lie.prototype,"_spriteFrame",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zie=Y(Lie.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wie.HORIZONTAL}}),Uie=Y(Lie.prototype,"_cellSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ji(20,20)}}),Nie=Lie))||Nie)||Nie)||Nie)||Nie)),kre=new Fi;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(Bre||(Bre={})),Je(Bre),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Fre||(Fre={})),Je(Fre),function(e){e.PAGE_TURNING="page-turning"}(zre||(zre={}));var Gre=function(t){return e({PageView:t,PageViewComponent:t}),t}((Xie=al("cc.PageView"),Yie=Tl(),Kie=cl(110),Qie=gl(),Zie=Gl(Bre),Jie=wl(),$ie=Gl(Fre),ere=wl(),tre=Rl(),nre=wl(),ire=Rl(),rre=wl(),ore=Gl(Ure),are=wl(),sre=wl(),cre=Gl(hte),lre=Cl(),ure=Gl(hte),hre=Cl(),_re=Cl(),fre=Cl(),pre=Cl(),dre=Gl([YB]),mre=Cl(),vre=wl(),gre=Gl([YB]),yre=wl(),Xie(Sre=Yie(Sre=Kie(Sre=Qie((Lre=Nre=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",Tre,j(t)),X(t,"horizontal",Ere,j(t)),X(t,"vertical",Cre,j(t)),X(t,"cancelInnerEvents",bre,j(t)),X(t,"scrollEvents",Are,j(t)),X(t,"pageTurningSpeed",wre,j(t)),X(t,"pageEvents",Rre,j(t)),X(t,"_sizeMode",Ire,j(t)),X(t,"_direction",Pre,j(t)),X(t,"_scrollThreshold",Ore,j(t)),X(t,"_pageTurningEventTiming",Dre,j(t)),X(t,"_indicator",Mre,j(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new gi,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Fi,t._touchEndPosition=new Fi,t}z(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(ZE.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(ZE.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):E(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void E(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):b(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent(F9);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===Fre.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===Bre.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(kre),Fi.set(this._touchBeganPosition,kre.x,kre.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(kre),Fi.set(this._touchEndPosition,kre.x,kre.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(kre),Fi.set(this._touchEndPosition,kre.x,kre.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===Fre.Horizontal,this.vertical=this.direction===Fre.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(F9);if(t){if(this._sizeMode===Bre.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===Fre.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===Fre.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,YB.emitEvents(this.pageEvents,this,zre.PAGE_TURNING),this.node.emit(zre.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===Fre.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===Fre.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new Fi;if(this._sizeMode===Bre.Free)this.direction===Fre.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===Fre.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===Fre.Horizontal?t.x=e*n.width:this.direction===Fre.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===Fre.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===Bre.Free){var i=0,r=0;if(this.direction===Fre.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===Fre.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===Fre.Horizontal)return Math.abs(e.x)>=o.width*this.scrollThreshold;if(this.direction===Fre.Vertical)return Math.abs(e.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new Fi;Fi.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},B(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(Vte),Nre.SizeMode=Bre,Nre.Direction=Fre,Nre.EventType=_ne(zre,fte),Y((xre=Lre).prototype,"sizeMode",[Zie,Jie],Object.getOwnPropertyDescriptor(xre.prototype,"sizeMode"),xre.prototype),Y(xre.prototype,"direction",[$ie,ere],Object.getOwnPropertyDescriptor(xre.prototype,"direction"),xre.prototype),Y(xre.prototype,"scrollThreshold",[Dl,tre,nre],Object.getOwnPropertyDescriptor(xre.prototype,"scrollThreshold"),xre.prototype),Y(xre.prototype,"pageTurningEventTiming",[Dl,ire,rre],Object.getOwnPropertyDescriptor(xre.prototype,"pageTurningEventTiming"),xre.prototype),Y(xre.prototype,"indicator",[ore,are],Object.getOwnPropertyDescriptor(xre.prototype,"indicator"),xre.prototype),Tre=Y(xre.prototype,"autoPageTurningThreshold",[_l,sre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Y(xre.prototype,"verticalScrollBar",[cre,Zl,lre],Object.getOwnPropertyDescriptor(xre.prototype,"verticalScrollBar"),xre.prototype),Y(xre.prototype,"horizontalScrollBar",[ure,Zl,hre],Object.getOwnPropertyDescriptor(xre.prototype,"horizontalScrollBar"),xre.prototype),Ere=Y(xre.prototype,"horizontal",[Zl,_l,_re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Cre=Y(xre.prototype,"vertical",[Zl,_l,fre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bre=Y(xre.prototype,"cancelInnerEvents",[Zl,_l,pre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Are=Y(xre.prototype,"scrollEvents",[dre,_l,Zl,mre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wre=Y(xre.prototype,"pageTurningSpeed",[_l,El,vre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Rre=Y(xre.prototype,"pageEvents",[gre,_l,yre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ire=Y(xre.prototype,"_sizeMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bre.Unified}}),Pre=Y(xre.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fre.Horizontal}}),Ore=Y(xre.prototype,"_scrollThreshold",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Dre=Y(xre.prototype,"_pageTurningEventTiming",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Mre=Y(xre.prototype,"_indicator",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sre=xre))||Sre)||Sre)||Sre)||Sre)),Hre=new gi,Vre=new Fi,jre=new Fi,Wre=new Fi(1,1),qre=new Fi,Xre=new Fi;function Yre(e,t){if(!t._hadAlignOnce){t.alignMode===mie.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=jre,o=Wre;i?Tie(e,n=i,r,o):n=e.parent;var a=xie(n),s=n instanceof OO||!n.getComponent(AQ),c=s?Vre:n.getComponent(AQ).anchorPoint,l=s;e.getPosition(Hre);var u=e._uiProps.uiTransformComp,h=Hre.x,_=Hre.y,f=u.anchorPoint,p=e.getScale();if(t.alignFlags&vie.HORIZONTAL){var d=0,m=0,v=a.width;l?(d=nN.left.x,m=nN.right.x):m=(d=-c.x*v)+v,d+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(d+=r.x,d*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,S=p.x;if(S<0&&(y=1-y,S=-S),t.isStretchWidth)g=m-d,0!==S&&(u.width=g/S),h=d+y*g;else if(g=u.width*S,t.isAlignHorizontalCenter){var x=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,T=(.5-c.x)*a.width;i&&(x*=o.x,T+=r.x,T*=o.x),h=T+(y-.5)*g+x}else h=t.isAlignLeft?d+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&vie.VERTICAL){var E=0,C=0,b=a.height;l?(C=nN.bottom.y,E=nN.top.y):E=(C=-c.y*b)+b,C+=t.isAbsoluteBottom?t.bottom:t.bottom*b,E-=t.isAbsoluteTop?t.top:t.top*b,i&&(C+=r.y,C*=o.y,E+=r.y,E*=o.y);var A=0,w=f.y,R=p.y;if(R<0&&(w=1-w,R=-R),t.isStretchHeight)A=E-C,0!==R&&(u.height=A/R),_=C+w*A;else if(A=u.height*R,t.isAlignVerticalCenter){var I=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*b,P=(.5-c.y)*a.height;i&&(I*=o.y,P+=r.y,P*=o.y),_=P+(w-.5)*A+I}else _=t.isAlignBottom?C+w*A:E+(w-1)*A;t._lastSize.height=A}e.setPosition(h,_,Hre.z),gi.set(t._lastPos,h,_,Hre.z)}}function Kre(e){var t=e.getComponent(jie);if(t&&t.enabled){if(!r.isValid(e,!0))return;Jre.push(t)}for(var n,i=q(e.children);!(n=i()).done;){var o=n.value;o.active&&Kre(o)}}function Qre(){var e=$M.getScene();if(e){$re.isAligning=!0,$re._nodesOrderDirty&&(Jre.length=0,Kre(e),$re._nodesOrderDirty=!1);var t=null,n=$re._activeWidgetsIterator;for(n.i=0;n.i<Jre.length;++n.i)(t=Jre[n.i])._dirty&&(Yre(t.node,t),t._dirty=!1);$re.isAligning=!1}}var Zre,Jre=[],$re=e("widgetManager",r._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Ge.MutableForwardIterator(Jre),animationState:null,init:function(){$M.on(JM.EVENT_AFTER_SCENE_LAUNCH,Qre),$M.on(JM.EVENT_AFTER_UPDATE,Qre),oN.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);oN.instance.on("canvas-resize",e),hh.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=$M.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=$b.isNode(e)&&e.getComponent(jie);t&&t.enabled&&(t.alignMode===mie.ON_WINDOW_RESIZE||t.alignMode===mie.ALWAYS)&&t.setDirty();for(var n,i=q(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var o=qre;o.set(0,0);var a=Xre;if(a.set(1,1),e.target&&Tie(i,r=e.target,o,a),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:Vre,l=i._uiProps.uiTransformComp,u=xie(r),h=l.anchorPoint,_=i.getPosition(),f=vie,p=i.getScale(),d=0;if(t&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,d=_.x-h.x*l.width*p.x-m,e.isAbsoluteLeft||(d/=u.width),d/=a.x,e.left=n(e.left,d)}if(t&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,d=(v*=a.x)-(_.x+(1-h.x)*l.width*p.x),e.isAbsoluteRight||(d/=u.width),d/=a.x,e.right=n(e.right,d)}if(t&f.TOP){var g=(1-c.y)*u.height;g+=o.y,d=(g*=a.y)-(_.y+(1-h.y)*l.height*p.y),e.isAbsoluteTop||(d/=u.height),d/=a.y,e.top=n(e.top,d)}if(t&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,d=_.y-h.y*l.height*p.y-y,e.isAbsoluteBottom||(d/=u.height),d/=a.y,e.bottom=n(e.bottom,d)}}},updateAlignment:function e(t){var n=t.parent;n&&$b.isNode(n)&&e(n);var i=t.getComponent(jie);i&&n&&Yre(t,i)},AlignMode:mie,AlignFlags:vie});$M.on(JM.EVENT_INIT,(function(){$re.init()}));var eoe,toe,noe,ioe,roe,ooe,aoe,soe,coe,loe,uoe,hoe,_oe,foe,poe,doe,moe,voe,goe,yoe,Soe=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(al("cc.SafeArea")(Zre=Tl()(Zre=cl(110)(Zre=vl(Zre=gl()(Zre=sl(jie)(Zre=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),hh.on("window-resize",this.updateArea,this),hh.on("orientation-change",this.updateArea,this)},n.onDisable=function(){hh.off("window-resize",this.updateArea,this),hh.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(jie),t=this.node.getComponent(AQ);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=lN.getVisibleSize(),o=r.width,a=r.height,s=ph.getSafeAreaRect();e.top=a-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=o-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),$re.add(e)}},t}(rh))||Zre)||Zre)||Zre)||Zre)||Zre)||Zre),xoe=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((eoe=al("cc.UICoordinateTracker"),toe=Tl(),noe=gl(),ioe=cl(110),roe=Gl($b),ooe=wl(),aoe=Gl(fF),soe=wl(),coe=wl(),loe=wl(),uoe=Gl([YB]),hoe=wl(),eoe(_oe=toe(_oe=noe(_oe=ioe((Y((foe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",poe,j(t)),X(t,"_target",doe,j(t)),X(t,"_camera",moe,j(t)),X(t,"_useScale",voe,j(t)),X(t,"_distance",goe,j(t)),t._transformPos=new gi,t._viewPos=new gi,t._canMove=!0,t._lastWPos=new gi,t._lastCameraPos=new gi,t}z(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&gi.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);YB.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},B(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(rh)).prototype,"target",[roe,ooe],Object.getOwnPropertyDescriptor(foe.prototype,"target"),foe.prototype),Y(foe.prototype,"camera",[aoe,soe],Object.getOwnPropertyDescriptor(foe.prototype,"camera"),foe.prototype),Y(foe.prototype,"useScale",[coe],Object.getOwnPropertyDescriptor(foe.prototype,"useScale"),foe.prototype),Y(foe.prototype,"distance",[loe],Object.getOwnPropertyDescriptor(foe.prototype,"distance"),foe.prototype),poe=Y(foe.prototype,"syncEvents",[uoe,_l,hoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),doe=Y(foe.prototype,"_target",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),moe=Y(foe.prototype,"_camera",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),voe=Y(foe.prototype,"_useScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),goe=Y(foe.prototype,"_distance",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_oe=foe))||_oe)||_oe)||_oe)||_oe)),Toe=[ZE.TOUCH_START,ZE.TOUCH_END,ZE.TOUCH_MOVE,ZE.MOUSE_DOWN,ZE.MOUSE_MOVE,ZE.MOUSE_UP,ZE.MOUSE_ENTER,ZE.MOUSE_LEAVE,ZE.MOUSE_WHEEL];function Eoe(e){e.propagationStopped=!0}var Coe,boe,Aoe,woe,Roe,Ioe,Poe,Ooe,Doe,Moe,Noe,Loe,Boe=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(al("cc.BlockInputEvents")(yoe=Tl()(yoe=gl()(yoe=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<Toe.length;e++)this.node.on(Toe[e],Eoe,this)},n.onDisable=function(){for(var e=0;e<Toe.length;e++)this.node.off(Toe[e],Eoe,this)},t}(rh))||yoe)||yoe)||yoe),Foe={},zoe=e("SubContextView",(Coe=al("cc.SubContextView"),boe=Tl(),Aoe=cl(110),woe=sl(AQ),Roe=gl(),Ioe=wl(),Poe=wl(),Coe(Ooe=boe(Ooe=Aoe(Ooe=woe(Ooe=Roe((Y((Doe=function(e){function t(){var t;return X(t=e.call(this)||this,"_fps",Moe,j(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,X(t,"_designResolutionSize",Noe,j(t)),t._content=new $b("content"),t._content.hideFlags|=Kt.Flags.DontSave|Kt.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new zm,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new lv,t}z(t,e);var n=t.prototype;return n.onLoad=function(){Foe.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=Foe.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas;e.width=this._designResolutionSize.width,e.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(s1),this._sprite||(this._sprite=this._content.addComponent(s1)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new oK;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(AQ),t=this._content.getComponent(AQ),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var o=lN.getViewportRect(),a=t.getBoundingBoxToWorld(),s=lN.getVisibleSize(),c=hh.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(ZE.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(ZE.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(ZE.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(ZE.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(ZE.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(ZE.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},B(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(rh)).prototype,"designResolutionSize",[Ioe],Object.getOwnPropertyDescriptor(Doe.prototype,"designResolutionSize"),Doe.prototype),Y(Doe.prototype,"fps",[Poe],Object.getOwnPropertyDescriptor(Doe.prototype,"fps"),Doe.prototype),Moe=Y(Doe.prototype,"_fps",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Noe=Y(Doe.prototype,"_designResolutionSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ji(640,960)}}),Ooe=Doe))||Ooe)||Ooe)||Ooe)||Ooe)||Ooe));r.SubContextView=zoe;var Uoe,koe,Goe,Hoe,Voe,joe,Woe,qoe,Xoe,Yoe,Koe,Qoe,Zoe,Joe,$oe,eae,tae=e("UIReorderComponent",al("cc.UIReorderComponent")(Loe=function(){b(1408,"UIReorderComponent")})||Loe);r.UIReorderComponent=tae,r.ButtonComponent=j8,He.setClassAlias(j8,"cc.ButtonComponent"),r.EditBoxComponent=_9,He.setClassAlias(_9,"cc.EditBoxComponent"),r.LayoutComponent=F9,He.setClassAlias(F9,"cc.LayoutComponent"),r.ProgressBarComponent=lee,He.setClassAlias(lee,"cc.ProgressBarComponent"),r.ScrollViewComponent=Vte,He.setClassAlias(Vte,"cc.ScrollViewComponent"),r.ScrollBarComponent=hte,He.setClassAlias(hte,"cc.ScrollBarComponent"),r.SliderComponent=hne,He.setClassAlias(hne,"cc.SliderComponent"),r.ToggleComponent=gie,He.setClassAlias(gie,"cc.ToggleComponent"),r.ToggleContainerComponent=yie,He.setClassAlias(yie,"cc.ToggleContainerComponent"),r.WidgetComponent=jie,He.setClassAlias(jie,"cc.WidgetComponent"),r.PageViewComponent=Gre,He.setClassAlias(Gre,"cc.PageViewComponent"),r.PageViewIndicatorComponent=Ure,He.setClassAlias(Ure,"cc.PageViewIndicatorComponent"),r.SafeAreaComponent=Soe,He.setClassAlias(Soe,"cc.SafeAreaComponent"),He.setClassAlias(xoe,"cc.UICoordinateTrackerComponent"),r.BlockInputEventsComponent=Boe,He.setClassAlias(Boe,"cc.BlockInputEventsComponent");var nae,iae,rae,oae,aae,sae,cae,lae,uae,hae,_ae,fae,pae,dae,mae,vae,gae,yae,Sae,xae,Tae,Eae,Cae,bae,Aae,wae,Rae,Iae,Pae,Oae,Dae,Mae,Nae=function(t){return e({Billboard:t,BillboardComponent:t}),t}((Uoe=al("cc.Billboard"),koe=Tl(),Goe=gl(),Hoe=Gl(lv),Voe=Gl(lv),joe=wl(),Woe=wl(),qoe=wl(),Xoe=wl(),Uoe(Yoe=koe(Yoe=Goe(Yoe=vl((eae=function(e){function t(){var t;return X(t=e.call(this)||this,"_texture",Qoe,j(t)),X(t,"_height",Zoe,j(t)),X(t,"_width",Joe,j(t)),X(t,"_rotation",$oe,j(t)),t._model=null,t._mesh=null,t._material=null,t._uniform=new Gi(1,1,0,0),t}z(t,e);var n=t.prototype;return n.onLoad=function(){this.createModel()},n.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},n.onDisable=function(){this.detachFromScene()},n.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},n.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n.createModel=function(){this._mesh=Pj({primitiveMode:Kr.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[mi.WHITE.r,mi.WHITE.g,mi.WHITE.b,mi.WHITE.a,mi.WHITE.r,mi.WHITE.g,mi.WHITE.b,mi.WHITE.a,mi.WHITE.r,mi.WHITE.g,mi.WHITE.b,mi.WHITE.a,mi.WHITE.r,mi.WHITE.g,mi.WHITE.b,mi.WHITE.a],attributes:[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RG32F),new Vo(lo.ATTR_COLOR,Cr.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var e=this._model=r.director.root.createModel(og,this.node);e.node=e.transform=this.node,null==this._material&&(this._material=new Mg,this._material.copy(Hv.get("default-billboard-material"))),e.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},B(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*ti(this._rotation))/100},set:function(e){this._rotation=ei(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),t}(rh),Qoe=Y((Koe=eae).prototype,"_texture",[Hoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Koe.prototype,"texture",[Voe,joe],Object.getOwnPropertyDescriptor(Koe.prototype,"texture"),Koe.prototype),Zoe=Y(Koe.prototype,"_height",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(Koe.prototype,"height",[Woe],Object.getOwnPropertyDescriptor(Koe.prototype,"height"),Koe.prototype),Joe=Y(Koe.prototype,"_width",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(Koe.prototype,"width",[qoe],Object.getOwnPropertyDescriptor(Koe.prototype,"width"),Koe.prototype),$oe=Y(Koe.prototype,"_rotation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(Koe.prototype,"rotation",[Xoe],Object.getOwnPropertyDescriptor(Koe.prototype,"rotation"),Koe.prototype),Yoe=Koe))||Yoe)||Yoe)||Yoe)||Yoe)),Lae=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RGBA32F),new Vo(lo.ATTR_TEX_COORD1,Cr.RGB32F),new Vo(lo.ATTR_COLOR,Cr.RGBA8,!0)],Bae=new gi,Fae=new gi,zae=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=null,t._vertCount=0,t._indexCount=0,t._material=null,t.type=Qv.LINE,t._capacity=100,t._iaInfo=new Po([new Ro]),t._iaInfoBuffer=t._device.createBuffer(new Ao(wr.INDIRECT,Pr.DEVICE,va,va)),t}z(t,e);var n=t.prototype;return n.setCapacity=function(e){this._capacity=e,this.createBuffer()},n.createBuffer=function(){this._vertSize=0;for(var e,t=q(Lae);!(e=t()).done;){var n=e.value;n.offset=this._vertSize,this._vertSize+=fa[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.updateMaterial=function(t){this._material=t,e.prototype.setSubModelMaterial.call(this,0,t)},n.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var n=new Uint16Array((this._capacity-1)*this._indexCount),i=0,r=0;r<this._capacity-1;++r){var o=2*r;n[i++]=o,n[i++]=o+1,n[i++]=o+2,n[i++]=o+3,n[i++]=o+2,n[i++]=o+1}var a=this._device.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(n),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new KA([e],Lae,Kr.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.addLineVertexData=function(e,t,n){if(e.length>1){var i=0;gi.subtract(Bae,e[1],e[0]),this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=0,this._vdataF32[i++]=Bae.x,this._vdataF32[i++]=Bae.y,this._vdataF32[i++]=Bae.z,this._vdataUint32[i++]=n.evaluate(0,1)._val,this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=1,this._vdataF32[i++]=Bae.x,this._vdataF32[i++]=Bae.y,this._vdataF32[i++]=Bae.z,this._vdataUint32[i++]=n.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){gi.subtract(Bae,e[r-1],e[r]),gi.subtract(Fae,e[r+1],e[r]),gi.subtract(Fae,Fae,Bae);var o=r/e.length;this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=0,this._vdataF32[i++]=Fae.x,this._vdataF32[i++]=Fae.y,this._vdataF32[i++]=Fae.z,this._vdataUint32[i++]=n.evaluate(o,1)._val,this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=1,this._vdataF32[i++]=Fae.x,this._vdataF32[i++]=Fae.y,this._vdataF32[i++]=Fae.z,this._vdataUint32[i++]=n.evaluate(o,1)._val}gi.subtract(Bae,e[e.length-1],e[e.length-2]),this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=0,this._vdataF32[i++]=Bae.x,this._vdataF32[i++]=Bae.y,this._vdataF32[i++]=Bae.z,this._vdataUint32[i++]=n.evaluate(1,1)._val,this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=1,this._vdataF32[i++]=Bae.x,this._vdataF32[i++]=Bae.y,this._vdataF32[i++]=Bae.z,this._vdataUint32[i++]=n.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))},n.updateIA=function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},t}(og),Uae=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],kae=Ke({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),Gae=e("CurveRange",(nae=al("cc.CurveRange"),iae=Gl(kae),rae=Gl(Sf),oae=Gl(Sf),aae=Gl(Sf),nae((gae=vae=function(){function e(){X(this,"mode",lae,this),X(this,"spline",uae,this),X(this,"splineMin",hae,this),X(this,"splineMax",_ae,this),X(this,"constant",fae,this),X(this,"constantMin",pae,this),X(this,"constantMax",dae,this),X(this,"multiplier",mae,this),this._curve=new Cp(this.spline),this._curveMin=new Cp(this.splineMin),this._curveMax=new Cp(this.splineMax)}var t=e.prototype;return t.evaluate=function(e,t){switch(this.mode){default:case kae.Constant:return this.constant;case kae.Curve:return this.spline.evaluate(e)*this.multiplier;case kae.TwoCurves:return $n(this.splineMin.evaluate(e),this.splineMax.evaluate(e),t)*this.multiplier;case kae.TwoConstants:return $n(this.constantMin,this.constantMax,t)}},t.getMax=function(){switch(this.mode){default:case kae.Constant:return this.constant;case kae.Curve:return this.multiplier;case kae.TwoConstants:return this.constantMax;case kae.TwoCurves:return this.multiplier}},t._onBeforeSerialize=function(){return Uae[this.mode]},B(e,[{key:"curve",get:function(){return this._curve},set:function(e){this._curve=e,this.spline=e._internalCurve}},{key:"curveMin",get:function(){return this._curveMin},set:function(e){this._curveMin=e,this.splineMin=e._internalCurve}},{key:"curveMax",get:function(){return this._curveMax},set:function(e){this._curveMax=e,this.splineMax=e._internalCurve}}]),e}(),vae.Mode=kae,lae=Y((cae=gae).prototype,"mode",[iae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kae.Constant}}),uae=Y(cae.prototype,"spline",[rae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wp()}}),hae=Y(cae.prototype,"splineMin",[oae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wp()}}),_ae=Y(cae.prototype,"splineMax",[aae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wp()}}),fae=Y(cae.prototype,"constant",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pae=Y(cae.prototype,"constantMin",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dae=Y(cae.prototype,"constantMax",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mae=Y(cae.prototype,"multiplier",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sae=cae))||sae));function Hae(e,t,n){switch(e.mode){case kae.Constant:return e.constant;case kae.Curve:return e.spline.evaluate(t)*e.multiplier;case kae.TwoCurves:return 0===n?e.splineMin.evaluate(t)*e.multiplier:e.splineMax.evaluate(t)*e.multiplier;case kae.TwoConstants:return 0===n?e.constantMin:e.constantMax;default:return 0}}function Vae(e){switch(e.mode){case kae.TwoConstants:case kae.TwoCurves:return 2;default:return 1}}function jae(e,t,n){var i=new zm({width:t,height:n,_data:e,_compressed:!1,format:cm.RGBA32F}),r=new lv;return r.setFilters(um.NEAREST,um.NEAREST),r.setMipFilter(um.NONE),r.setWrapMode(lm.CLAMP_TO_EDGE,lm.CLAMP_TO_EDGE,lm.CLAMP_TO_EDGE),r.image=i,r}function Wae(e,t,n,i,r){for(var o=Math.max(Vae(t),Vae(n),Vae(i)),a=new Float32Array(e*o*4),s=[t,n,i],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],_=0,f=0,p=0;p<e;p++){var d=Hae(h,c*p,l);f=r?d:(_+=d)/(p+1),a[4*p+u]=f}return jae(a,e,o)}var qae,Xae,Yae,Kae,Qae,Zae,Jae,$ae,ese,tse,nse,ise,rse,ose,ase,sse,cse,lse,use,hse,_se,fse,pse,dse,mse,vse,gse,yse,Sse,xse,Tse,Ese,Cse,bse,Ase,wse,Rse,Ise,Pse,Ose,Dse,Mse,Nse,Lse,Bse,Fse,zse,Use,kse,Gse,Hse,Vse,jse,Wse,qse,Xse=Ke({Blend:0,Fixed:1}),Yse=(e("ColorKey",al("cc.ColorKey")((xae=Y((Sae=function(){X(this,"color",xae,this),X(this,"time",Tae,this)}).prototype,"color",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),Tae=Y(Sae.prototype,"time",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yae=Sae))||yae),e("AlphaKey",al("cc.AlphaKey")((bae=Y((Cae=function(){X(this,"alpha",bae,this),X(this,"time",Aae,this)}).prototype,"alpha",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Aae=Y(Cae.prototype,"time",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eae=Cae))||Eae),e("Gradient",al("cc.Gradient")((Mae=Dae=function(){function e(){X(this,"colorKeys",Iae,this),X(this,"alphaKeys",Pae,this),X(this,"mode",Oae,this),this._color=void 0,this._color=mi.WHITE.clone()}var t=e.prototype;return t.setKeys=function(e,t){this.colorKeys=e,this.alphaKeys=t},t.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(e,t){return e.time-t.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(e,t){return e.time-t.time}))},t.evaluate=function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color},t.randomColor=function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color},t.getRGB=function(e){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(mi.WHITE),this._color);e=li(e,1);for(var t=1;t<this.colorKeys.length;++t){var n=this.colorKeys[t-1].time,i=this.colorKeys[t].time;if(e>=n&&e<i){if(this.mode===Xse.Fixed)return this.colorKeys[t].color;var r=(e-n)/(i-n);return mi.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var o=this.colorKeys.length-1;e<this.colorKeys[0].time?mi.lerp(this._color,mi.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[o].time&&mi.lerp(this._color,this.colorKeys[o].color,mi.BLACK,(e-this.colorKeys[o].time)/(1-this.colorKeys[o].time))},t.getAlpha=function(e){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=li(e,1);for(var t=1;t<this.alphaKeys.length;++t){var n=this.alphaKeys[t-1].time,i=this.alphaKeys[t].time;if(e>=n&&e<i){if(this.mode===Xse.Fixed)return this.alphaKeys[t].alpha;var r=(e-n)/(i-n);return $n(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var o=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?$n(0,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[o].time?$n(this.alphaKeys[o].alpha,0,(e-this.alphaKeys[o].time)/(1-this.alphaKeys[o].time)):void 0},e}(),Dae.Mode=Xse,Iae=Y((Rae=Mae).prototype,"colorKeys",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),Pae=Y(Rae.prototype,"alphaKeys",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),Oae=Y(Rae.prototype,"mode",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xse.Blend}}),wae=Rae))||wae)),Kse=Ke({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),Qse=e("GradientRange",(qae=al("cc.GradientRange"),Xae=Gl(Kse),Yae=Gl(Yse),Kae=Gl(Yse),Qae=Gl(Yse),Zae=Gl(Kse),qae((cse=sse=function(){function e(){X(this,"color",ese,this),X(this,"colorMin",tse,this),X(this,"colorMax",nse,this),X(this,"gradient",ise,this),X(this,"gradientMin",rse,this),X(this,"gradientMax",ose,this),X(this,"_mode",ase,this),this._color=mi.WHITE.clone()}var t=e.prototype;return t.evaluate=function(e,t){switch(this._mode){case Kse.Color:return this.color;case Kse.TwoColors:return mi.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case Kse.RandomColor:return this.gradient.randomColor();case Kse.Gradient:return this.gradient.evaluate(e);case Kse.TwoGradients:return mi.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}},t._onBeforeSerialize=function(){return(!1)[this._mode]},B(e,[{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),sse.Mode=Kse,Y(($ae=cse).prototype,"mode",[Xae],Object.getOwnPropertyDescriptor($ae.prototype,"mode"),$ae.prototype),ese=Y($ae.prototype,"color",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),tse=Y($ae.prototype,"colorMin",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),nse=Y($ae.prototype,"colorMax",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi.WHITE.clone()}}),ise=Y($ae.prototype,"gradient",[Yae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yse}}),rse=Y($ae.prototype,"gradientMin",[Kae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yse}}),ose=Y($ae.prototype,"gradientMax",[Qae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yse}}),ase=Y($ae.prototype,"_mode",[Zae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kse.Color}}),Jae=$ae))||Jae));function Zse(e,t,n){switch(e.mode){case Kse.Color:return e.color;case Kse.TwoColors:return 0===n?e.colorMin:e.colorMax;case Kse.RandomColor:return e.gradient.randomColor();case Kse.Gradient:return e.gradient.evaluate(t);case Kse.TwoGradients:return 0===n?e.gradientMin.evaluate(t):e.gradientMax.evaluate(t);default:return e.color}}var Jse={parent:null,owner:null,subModelIdx:0},$se={CC_USE_WORLD_SPACE:!1},ece=function(t){return e({Line:t,LineComponent:t}),t}((lse=al("cc.Line"),use=Tl(),hse=gl(),_se=Gl(lv),fse=Gl(lv),pse=Ml(),dse=wl(),mse=Ml(),vse=wl(),gse=Gl([gi]),yse=Gl([gi]),Sse=Ml(),xse=wl(),Tse=Gl(Gae),Ese=Gl(Gae),Cse=Rl(),bse=Ml(),Ase=wl(),wse=Gl(Fi),Rse=Ml(),Ise=wl(),Pse=Gl(Fi),Ose=Ml(),Dse=wl(),Mse=Gl(Qse),Nse=Gl(Qse),Lse=Ml(),Bse=wl(),lse(Fse=use(Fse=hse(Fse=vl((qse=function(e){function t(){var t;return X(t=e.call(this)||this,"_texture",Use,j(t)),t._material=null,t._materialInstance=null,X(t,"_worldSpace",kse,j(t)),X(t,"_positions",Gse,j(t)),X(t,"_width",Hse,j(t)),X(t,"_tile",Vse,j(t)),X(t,"_offset",jse,j(t)),X(t,"_color",Wse,j(t)),t._model=null,t._tile_offset=new Gi,t}z(t,e);var n=t.prototype;return n.onLoad=function(){var e=this._model=r.director.root.createModel(zae);e.node=e.transform=this.node,null===this._material&&(this._material=new Mg,this._material.copy(Hv.get("default-trail-material")),$se.CC_USE_WORLD_SPACE=this.worldSpace,Jse.parent=this._material,Jse.subModelIdx=0,this._materialInstance=new Kg(Jse),Jse.parent=null,Jse.subModelIdx=0,this._materialInstance.recompileShaders($se)),e.updateMaterial(this._materialInstance),e.setCapacity(100)},n.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},n.onDisable=function(){this._model&&this._detachFromScene()},n._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},B(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._materialInstance&&this._materialInstance.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._materialInstance&&($se.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders($se),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),t}(rh),Use=Y((zse=qse).prototype,"_texture",[_se],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(zse.prototype,"texture",[fse,pse,dse],Object.getOwnPropertyDescriptor(zse.prototype,"texture"),zse.prototype),kse=Y(zse.prototype,"_worldSpace",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(zse.prototype,"worldSpace",[mse,vse],Object.getOwnPropertyDescriptor(zse.prototype,"worldSpace"),zse.prototype),Gse=Y(zse.prototype,"_positions",[gse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Y(zse.prototype,"positions",[yse,Sse,xse],Object.getOwnPropertyDescriptor(zse.prototype,"positions"),zse.prototype),Hse=Y(zse.prototype,"_width",[Tse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Y(zse.prototype,"width",[Ese,Cse,bse,Ase],Object.getOwnPropertyDescriptor(zse.prototype,"width"),zse.prototype),Vse=Y(zse.prototype,"_tile",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1)}}),Y(zse.prototype,"tile",[wse,Rse,Ise],Object.getOwnPropertyDescriptor(zse.prototype,"tile"),zse.prototype),jse=Y(zse.prototype,"_offset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0)}}),Y(zse.prototype,"offset",[Pse,Ose,Dse],Object.getOwnPropertyDescriptor(zse.prototype,"offset"),zse.prototype),Wse=Y(zse.prototype,"_color",[Mse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qse}}),Y(zse.prototype,"color",[Nse,Lse,Bse],Object.getOwnPropertyDescriptor(zse.prototype,"color"),zse.prototype),Fse=zse))||Fse)||Fse)||Fse)||Fse)),tce=function(){function e(e){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new gi(0,0,0),this.velocity=new gi(0,0,0),this.animatedVelocity=new gi(0,0,0),this.ultimateVelocity=new gi(0,0,0),this.angularVelocity=new gi(0,0,0),this.axisOfRotation=new gi(0,0,0),this.rotation=new gi(0,0,0),this.startEuler=new gi(0,0,0),this.startRotation=new bi,this.startRotated=!1,this.deltaQuat=new bi,this.deltaMat=new Mi,this.localMat=new Mi,this.startSize=new gi(0,0,0),this.size=new gi(0,0,0),this.startColor=mi.WHITE.clone(),this.color=mi.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return e.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},e}();tce.INDENTIFY_NEG_QUAT=10,tce.R2D=180/Math.PI;var nce,ice,rce,oce,ace,sce,cce,lce,uce,hce,_ce,fce,pce,dce,mce,vce,gce,yce,Sce,xce,Tce,Ece,Cce,bce,Ace,wce,Rce,Ice,Pce,Oce,Dce,Mce,Nce,Lce,Bce="colorModule",Fce="rotationModule",zce="sizeModule",Uce="textureModule",kce=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],Gce=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],Hce=function(){function e(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var t=e.prototype;return t.bindTarget=function(e){this.target=e},t.update=function(){},e}(),Vce=Ke({World:0,Local:1,Custom:2}),jce=Ke({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),Wce=Ke({World:0,Local:1,View:2}),qce=Ke({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),Xce=Ke({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),Yce=Ke({Base:0,Edge:1,Shell:2,Volume:3}),Kce=Ke({Random:0,Loop:1,PingPong:2}),Qce=Ke({Particles:0}),Zce=Ke({Stretch:0}),Jce=(nce=al("cc.ColorOvertimeModule"),ice=Ml(),rce=Gl(Qse),oce=Ml(),nce((uce=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_enable",cce,j(t)),X(t,"color",lce,j(t)),t.name=Bce,t}return z(t,e),t.prototype.animate=function(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,oi(e.randomSeed+91041)))},B(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Hce),cce=Y((sce=uce).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(sce.prototype,"enable",[ice],Object.getOwnPropertyDescriptor(sce.prototype,"enable"),sce.prototype),lce=Y(sce.prototype,"color",[rce,_l,oce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qse}}),ace=sce))||ace),$ce=new gi(0,0,-1);function ele(e,t,n,i){return t!==e?(e===Vce.World||Mi.invert(n,n),Mi.getRotation(i,n),!0):(bi.set(i,0,0,0,1),!1)}function tle(e,t){Fi.set(e,Math.cos(t),Math.sin(t))}function nle(e){var t=ii(-1,1),n=ii(0,2*Math.PI),i=Math.sqrt(1-t*t),r=i*Math.cos(n),o=i*Math.sin(n);gi.set(e,r,o,t)}function ile(e,t,n){nle(e),gi.multiplyScalar(e,e,t+(n-t)*ni())}function rle(e,t,n,i){tle(e,i),e.z=0,gi.multiplyScalar(e,e,t+(n-t)*ni())}function ole(e){for(var t=0;t<e.length;t++){var n=t+ri(0,e.length-t),i=e[n];e[n]=e[t],e[t]=i}}function ale(){var e=ii(-1,1);return 0===e&&e++,On(e)}var sle,cle,lle,ule,hle,_le,fle,ple,dle,mle,vle,gle,yle,Sle,xle,Tle,Ele,Cle,ble,Ale,wle,Rle,Ile,Ple,Ole,Dle,Mle,Nle,Lle,Ble,Fle,zle,Ule,kle,Gle,Hle,Vle,jle,Wle,qle,Xle,Yle,Kle,Qle,Zle,Jle,$le,eue,tue,nue,iue,rue,oue,aue,sue,cue,lue,uue,hue,_ue,fue=212165,pue=new gi,due=(hce=al("cc.ForceOvertimeModule"),_ce=Ml(),fce=Gl(Gae),pce=Rl(),dce=Ml(),mce=wl(),vce=Gl(Gae),gce=Rl(),yce=Ml(),Sce=wl(),xce=Gl(Gae),Tce=Rl(),Ece=Ml(),Cce=wl(),bce=Gl(Vce),Ace=Ml(),wce=wl(),hce((Lce=function(e){function t(){var t;return X(t=e.call(this)||this,"_enable",Pce,j(t)),X(t,"x",Oce,j(t)),X(t,"y",Dce,j(t)),X(t,"z",Mce,j(t)),X(t,"space",Nce,j(t)),t.randomized=!1,t.rotation=void 0,t.needTransform=void 0,t.name="forceModule",t.rotation=new bi,t.needTransform=!1,t.needUpdate=!0,t}z(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=ele(e,this.space,t,this.rotation)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=gi.set(pue,this.x.evaluate(n,oi(e.randomSeed+fue)),this.y.evaluate(n,oi(e.randomSeed+fue)),this.z.evaluate(n,oi(e.randomSeed+fue)));this.needTransform&&gi.transformQuat(i,i,this.rotation),gi.scaleAndAdd(e.velocity,e.velocity,i,t),gi.copy(e.ultimateVelocity,e.velocity)},B(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Hce),Pce=Y((Ice=Lce).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(Ice.prototype,"enable",[_ce],Object.getOwnPropertyDescriptor(Ice.prototype,"enable"),Ice.prototype),Oce=Y(Ice.prototype,"x",[fce,_l,pce,dce,mce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Dce=Y(Ice.prototype,"y",[vce,_l,gce,yce,Sce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Mce=Y(Ice.prototype,"z",[xce,_l,Tce,Ece,Cce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Nce=Y(Ice.prototype,"space",[bce,_l,Ace,wce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vce.Local}}),Rce=Ice))||Rce),mue=23541,vue=new gi,gue=new gi,yue=(sle=al("cc.LimitVelocityOvertimeModule"),cle=Ml(),lle=Gl(Gae),ule=Rl(),hle=Ml(),_le=wl(),fle=Gl(Gae),ple=Rl(),dle=Ml(),mle=wl(),vle=Gl(Gae),gle=Rl(),yle=Ml(),Sle=wl(),xle=Gl(Gae),Tle=Rl(),Ele=Ml(),Cle=wl(),ble=Ml(),Ale=wl(),wle=Ml(),Rle=wl(),Ile=Gl(Vce),Ple=Ml(),Ole=wl(),sle((Hle=function(e){function t(){var t;return X(t=e.call(this)||this,"_enable",Nle,j(t)),X(t,"limitX",Lle,j(t)),X(t,"limitY",Ble,j(t)),X(t,"limitZ",Fle,j(t)),X(t,"limit",zle,j(t)),X(t,"dampen",Ule,j(t)),X(t,"separateAxes",kle,j(t)),X(t,"space",Gle,j(t)),t.drag=null,t.multiplyDragByParticleSize=!1,t.multiplyDragByParticleVelocity=!1,t.name="limitModule",t.rotation=void 0,t.needTransform=void 0,t.rotation=new bi,t.needTransform=!1,t.needUpdate=!0,t}z(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=ele(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=vue;this.separateAxes?(gi.set(gue,this.limitX.evaluate(t,oi(e.randomSeed+mue)),this.limitY.evaluate(t,oi(e.randomSeed+mue)),this.limitZ.evaluate(t,oi(e.randomSeed+mue))),this.needTransform&&gi.transformQuat(gue,gue,this.rotation),gi.set(n,Sue(e.ultimateVelocity.x,gue.x,this.dampen),Sue(e.ultimateVelocity.y,gue.y,this.dampen),Sue(e.ultimateVelocity.z,gue.z,this.dampen))):(gi.normalize(n,e.ultimateVelocity),gi.multiplyScalar(n,n,Sue(e.ultimateVelocity.length(),this.limit.evaluate(t,oi(e.randomSeed+mue)),this.dampen))),gi.copy(e.ultimateVelocity,n)},B(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Hce),Nle=Y((Mle=Hle).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(Mle.prototype,"enable",[cle],Object.getOwnPropertyDescriptor(Mle.prototype,"enable"),Mle.prototype),Lle=Y(Mle.prototype,"limitX",[lle,_l,ule,hle,_le],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Ble=Y(Mle.prototype,"limitY",[fle,_l,ple,dle,mle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Fle=Y(Mle.prototype,"limitZ",[vle,_l,gle,yle,Sle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),zle=Y(Mle.prototype,"limit",[xle,_l,Tle,Ele,Cle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Ule=Y(Mle.prototype,"dampen",[_l,ble,Ale],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),kle=Y(Mle.prototype,"separateAxes",[_l,wle,Rle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gle=Y(Mle.prototype,"space",[Ile,_l,Ple,Ole],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vce.Local}}),Dle=Mle))||Dle);function Sue(e,t,n){var i=Math.sign(e),r=Math.abs(e);return r>t&&(r=$n(r,t,n)),r*i}var xue,Tue,Eue,Cue,bue,Aue,wue,Rue,Iue,Pue,Oue,Due,Mue,Nue,Lue,Bue,Fue,zue,Uue,kue,Gue,Hue,Vue,jue,Wue,que,Xue,Yue,Kue,Que,Zue,Jue,$ue,ehe,the,nhe,ihe,rhe,ohe,ahe,she,che,lhe,uhe,hhe,_he,fhe,phe,dhe,mhe,vhe,ghe,yhe,She,xhe,The,Ehe,Che,bhe,Ahe,whe,Rhe,Ihe,Phe,Ohe,Dhe,Mhe,Nhe,Lhe,Bhe,Fhe,zhe,Uhe,khe,Ghe,Hhe,Vhe,jhe,Whe,qhe,Xhe,Yhe,Khe,Qhe,Zhe,Jhe,$he,e_e,t_e,n_e,i_e,r_e,o_e,a_e,s_e,c_e,l_e,u_e,h_e,__e,f_e,p_e,d_e,m_e,v_e,g_e,y_e,S_e,x_e,T_e,E_e,C_e,b_e,A_e,w_e,R_e,I_e,P_e,O_e,D_e,M_e,N_e,L_e,B_e,F_e,z_e,U_e,k_e,G_e,H_e,V_e,j_e,W_e,q_e,X_e,Y_e,K_e,Q_e,Z_e,J_e,$_e,efe,tfe,nfe,ife,rfe,ofe,afe,sfe,cfe,lfe,ufe,hfe,_fe,ffe,pfe,dfe,mfe,vfe,gfe,yfe,Sfe,xfe,Tfe,Efe,Cfe,bfe,Afe,wfe,Rfe,Ife,Pfe,Ofe,Dfe,Mfe,Nfe,Lfe,Bfe,Ffe,zfe,Ufe,kfe,Gfe=(Vle=al("cc.RotationOvertimeModule"),jle=Ml(),Wle=Ml(),qle=wl(),Xle=Gl(Gae),Yle=Rl(),Kle=Ml(),Qle=wl(),Zle=Gl(Gae),Jle=Rl(),$le=Ml(),eue=wl(),tue=Gl(Gae),nue=Rl(),iue=Ml(),rue=wl(),Vle((_ue=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_enable",sue,j(t)),X(t,"_separateAxes",cue,j(t)),X(t,"x",lue,j(t)),X(t,"y",uue,j(t)),X(t,"z",hue,j(t)),t.name=Fce,t._startMat=new Mi,t._matRot=new Mi,t._quatRot=new bi,t._otherEuler=new gi,t}z(t,e);var n=t.prototype;return n._processRotation=function(e){var t=e.particleSystem.processor.getInfo().renderMode;t!==qce.Mesh&&t===qce.StrecthedBillboard&&this._quatRot.set(0,0,0,1),bi.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=tce.INDENTIFY_NEG_QUAT)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=oi(e.randomSeed+125292),r=e.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==qce.VerticalBillboard&&r!==qce.HorizontalBillboard?bi.fromEuler(e.deltaQuat,this.x.evaluate(n,i)*t*tce.R2D,this.y.evaluate(n,i)*t*tce.R2D,this.z.evaluate(n,i)*t*tce.R2D):bi.fromEuler(e.deltaQuat,0,0,this.z.evaluate(n,i)*t*tce.R2D),e.deltaMat=Mi.fromQuat(e.deltaMat,e.deltaQuat),e.localMat=e.localMat.multiply(e.deltaMat),e.startRotated||(r!==qce.Mesh&&(r===qce.StrecthedBillboard?e.startEuler.set(0,0,0):r!==qce.Billboard&&e.startEuler.set(0,0,e.startEuler.z)),bi.fromEuler(e.startRotation,e.startEuler.x*tce.R2D,e.startEuler.y*tce.R2D,e.startEuler.z*tce.R2D),e.startRotated=!0),this._startMat=Mi.fromQuat(this._startMat,e.startRotation),this._matRot=this._startMat.multiply(e.localMat),Mi.getRotation(this._quatRot,this._matRot),this._processRotation(e,tce.R2D),e.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},B(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),t}(Hce),sue=Y((aue=_ue).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(aue.prototype,"enable",[jle],Object.getOwnPropertyDescriptor(aue.prototype,"enable"),aue.prototype),cue=Y(aue.prototype,"_separateAxes",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(aue.prototype,"separateAxes",[Wle,qle],Object.getOwnPropertyDescriptor(aue.prototype,"separateAxes"),aue.prototype),lue=Y(aue.prototype,"x",[Xle,_l,Yle,Nl,Kle,Qle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),uue=Y(aue.prototype,"y",[Zle,_l,Jle,Nl,$le,eue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),hue=Y(aue.prototype,"z",[tue,_l,nue,Nl,iue,rue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),oue=aue))||oue),Hfe=(xue=al("cc.SizeOvertimeModule"),Tue=Ml(),Eue=Ml(),Cue=wl(),bue=Gl(Gae),Aue=Rl(),wue=Ml(),Rue=wl(),Iue=Gl(Gae),Pue=Rl(),Oue=Ml(),Due=wl(),Mue=Gl(Gae),Nue=Rl(),Lue=Ml(),Bue=wl(),Fue=Gl(Gae),zue=Rl(),Uue=Ml(),kue=wl(),xue((Kue=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_enable",Vue,j(t)),X(t,"separateAxes",jue,j(t)),X(t,"size",Wue,j(t)),X(t,"x",que,j(t)),X(t,"y",Xue,j(t)),X(t,"z",Yue,j(t)),t.name=zce,t}return z(t,e),t.prototype.animate=function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,n=oi(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,n),e.size.y=e.startSize.y*this.y.evaluate(t,n),e.size.z=e.startSize.z*this.z.evaluate(t,n)}else gi.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,oi(e.randomSeed+39825)))},B(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Hce),Vue=Y((Hue=Kue).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(Hue.prototype,"enable",[Tue],Object.getOwnPropertyDescriptor(Hue.prototype,"enable"),Hue.prototype),jue=Y(Hue.prototype,"separateAxes",[_l,Eue,Cue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wue=Y(Hue.prototype,"size",[bue,_l,Aue,wue,Rue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),que=Y(Hue.prototype,"x",[Iue,_l,Pue,Oue,Due],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Xue=Y(Hue.prototype,"y",[Mue,_l,Nue,Lue,Bue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Yue=Y(Hue.prototype,"z",[Fue,_l,zue,Uue,kue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Gue=Hue))||Gue),Vfe=90794,jfe=Ke({Grid:0}),Wfe=Ke({WholeSheet:0,SingleRow:1}),qfe=(Que=al("cc.TextureAnimationModule"),Zue=fl("numTilesX"),Jue=fl("numTilesY"),$ue=Ml(),ehe=Gl(jfe),the=Gl(jfe),nhe=Ml(),ihe=wl(),rhe=Ml(),ohe=wl(),ahe=Ml(),she=wl(),che=Gl(Wfe),lhe=Ml(),uhe=wl(),hhe=Gl(Gae),_he=Rl(),fhe=Ml(),phe=wl(),dhe=Gl(Gae),mhe=Rl(),vhe=Ml(),ghe=wl(),yhe=Ml(),She=wl(),xhe=Ml(),The=wl(),Ehe=Ml(),Che=wl(),Que((khe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_enable",whe,j(t)),X(t,"_numTilesX",Rhe,j(t)),X(t,"_numTilesY",Ihe,j(t)),X(t,"_mode",Phe,j(t)),X(t,"animation",Ohe,j(t)),X(t,"frameOverTime",Dhe,j(t)),X(t,"startFrame",Mhe,j(t)),X(t,"cycleCount",Nhe,j(t)),X(t,"_flipU",Lhe,j(t)),X(t,"_flipV",Bhe,j(t)),X(t,"_uvChannelMask",Fhe,j(t)),X(t,"randomRow",zhe,j(t)),X(t,"rowIndex",Uhe,j(t)),t.name=Uce,t}z(t,e);var n=t.prototype;return n.init=function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=this.startFrame.evaluate(t,oi(e.randomSeed+Vfe))/(this.numTilesX*this.numTilesY);if(this.animation===Wfe.WholeSheet)e.frameIndex=li(this.cycleCount*(this.frameOverTime.evaluate(t,oi(e.randomSeed+Vfe))+n),1);else if(this.animation===Wfe.SingleRow){var i=1/this.numTilesY;if(this.randomRow){var r=li(this.cycleCount*(this.frameOverTime.evaluate(t,oi(e.randomSeed+Vfe))+n),1),o=e.startRow*i,a=o+i;e.frameIndex=$n(o,a,r)}else{var s=this.rowIndex*i,c=s+i;e.frameIndex=$n(s,c,li(this.cycleCount*(this.frameOverTime.evaluate(t,oi(e.randomSeed+Vfe))+n),1))}}},B(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}},{key:"mode",get:function(){return this._mode},set:function(e){e!==jfe.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),t}(Hce),whe=Y((Ahe=khe).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rhe=Y(Ahe.prototype,"_numTilesX",[Zue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ihe=Y(Ahe.prototype,"_numTilesY",[Jue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(Ahe.prototype,"enable",[$ue],Object.getOwnPropertyDescriptor(Ahe.prototype,"enable"),Ahe.prototype),Phe=Y(Ahe.prototype,"_mode",[ehe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jfe.Grid}}),Y(Ahe.prototype,"mode",[the,nhe,ihe],Object.getOwnPropertyDescriptor(Ahe.prototype,"mode"),Ahe.prototype),Y(Ahe.prototype,"numTilesX",[rhe,ohe],Object.getOwnPropertyDescriptor(Ahe.prototype,"numTilesX"),Ahe.prototype),Y(Ahe.prototype,"numTilesY",[ahe,she],Object.getOwnPropertyDescriptor(Ahe.prototype,"numTilesY"),Ahe.prototype),Ohe=Y(Ahe.prototype,"animation",[che,_l,lhe,uhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wfe.WholeSheet}}),Dhe=Y(Ahe.prototype,"frameOverTime",[hhe,_l,_he,fhe,phe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Mhe=Y(Ahe.prototype,"startFrame",[dhe,_l,mhe,vhe,ghe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Nhe=Y(Ahe.prototype,"cycleCount",[_l,yhe,She],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lhe=Y(Ahe.prototype,"_flipU",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bhe=Y(Ahe.prototype,"_flipV",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fhe=Y(Ahe.prototype,"_uvChannelMask",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),zhe=Y(Ahe.prototype,"randomRow",[_l,xhe,The],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uhe=Y(Ahe.prototype,"rowIndex",[_l,Ehe,Che],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bhe=Ahe))||bhe),Xfe=197866,Yfe=new gi,Kfe=(Ghe=al("cc.VelocityOvertimeModule"),Hhe=Ml(),Vhe=Gl(Gae),jhe=Rl(),Whe=Ml(),qhe=wl(),Xhe=Gl(Gae),Yhe=Rl(),Khe=Ml(),Qhe=wl(),Zhe=Gl(Gae),Jhe=Rl(),$he=Ml(),e_e=wl(),t_e=Gl(Gae),n_e=Rl(),i_e=Ml(),r_e=wl(),o_e=Gl(Vce),a_e=Ml(),s_e=wl(),Ghe((m_e=function(e){function t(){var t;return X(t=e.call(this)||this,"_enable",u_e,j(t)),X(t,"x",h_e,j(t)),X(t,"y",__e,j(t)),X(t,"z",f_e,j(t)),X(t,"speedModifier",p_e,j(t)),X(t,"space",d_e,j(t)),t.rotation=void 0,t.needTransform=void 0,t.name="velocityModule",t.rotation=new bi,t.speedModifier.constant=1,t.needTransform=!1,t.needUpdate=!0,t}z(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=ele(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=gi.set(Yfe,this.x.evaluate(t,oi(e.randomSeed^Xfe)),this.y.evaluate(t,oi(156497^e.randomSeed)),this.z.evaluate(t,oi(984136^e.randomSeed)));this.needTransform&&gi.transformQuat(n,n,this.rotation),gi.add(e.animatedVelocity,e.animatedVelocity,n),gi.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),gi.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,oi(e.randomSeed+Xfe)))},B(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Hce),u_e=Y((l_e=m_e).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(l_e.prototype,"enable",[Hhe],Object.getOwnPropertyDescriptor(l_e.prototype,"enable"),l_e.prototype),h_e=Y(l_e.prototype,"x",[Vhe,_l,jhe,Whe,qhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),__e=Y(l_e.prototype,"y",[Xhe,_l,Yhe,Khe,Qhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),f_e=Y(l_e.prototype,"z",[Zhe,_l,Jhe,$he,e_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),p_e=Y(l_e.prototype,"speedModifier",[t_e,_l,n_e,i_e,r_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),d_e=Y(l_e.prototype,"space",[o_e,_l,a_e,s_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vce.Local}}),c_e=l_e))||c_e),Qfe=e("Burst",(v_e=al("cc.Burst"),g_e=Gl(Gae),y_e=Rl(),v_e((A_e=function(){function e(){X(this,"_time",T_e,this),X(this,"_repeatCount",E_e,this),X(this,"repeatInterval",C_e,this),X(this,"count",b_e,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var t=e.prototype;return t.update=function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var n=li(e._time-e.startDelay.evaluate(0,1),e.duration)-t;n=n>0?n:0;var i=li(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=n&&this._curTime<i&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(i-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},t.getMaxCount=function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)},B(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),e}(),T_e=Y((x_e=A_e).prototype,"_time",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(x_e.prototype,"time",[El],Object.getOwnPropertyDescriptor(x_e.prototype,"time"),x_e.prototype),E_e=Y(x_e.prototype,"_repeatCount",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Y(x_e.prototype,"repeatCount",[El],Object.getOwnPropertyDescriptor(x_e.prototype,"repeatCount"),x_e.prototype),C_e=Y(x_e.prototype,"repeatInterval",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b_e=Y(x_e.prototype,"count",[g_e,_l,y_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),S_e=x_e))||S_e)),Zfe=new gi(0,0,0),Jfe=[],$fe=new gi(.5,.5,.5),epe=(w_e=al("cc.ShapeModule"),R_e=Ml(),I_e=wl(),P_e=Ml(),O_e=wl(),D_e=Ml(),M_e=wl(),N_e=Ml(),L_e=wl(),B_e=Ml(),F_e=wl(),z_e=Ml(),U_e=Gl(Xce),k_e=fl("shapeType"),G_e=Ml(),H_e=Gl(Xce),V_e=wl(),j_e=Gl(Yce),W_e=Ml(),q_e=wl(),X_e=Ml(),Y_e=wl(),K_e=Ml(),Q_e=wl(),Z_e=Ml(),J_e=wl(),$_e=Ml(),efe=wl(),tfe=Ml(),nfe=wl(),ife=Ml(),rfe=wl(),ofe=Gl(Kce),afe=Ml(),sfe=wl(),cfe=Cl(),lfe=Ml(),ufe=wl(),hfe=Gl(Gae),_fe=Cl(),ffe=Rl(),pfe=Ml(),dfe=wl(),mfe=Ml(),vfe=wl(),gfe=Ml(),yfe=wl(),w_e((Y((xfe=function(){function e(){X(this,"_enable",Tfe,this),X(this,"_shapeType",Efe,this),X(this,"emitFrom",Cfe,this),X(this,"alignToDirection",bfe,this),X(this,"randomDirectionAmount",Afe,this),X(this,"sphericalDirectionAmount",wfe,this),X(this,"randomPositionAmount",Rfe,this),X(this,"radius",Ife,this),X(this,"radiusThickness",Pfe,this),X(this,"arcMode",Ofe,this),X(this,"arcSpread",Dfe,this),X(this,"arcSpeed",Mfe,this),X(this,"length",Nfe,this),X(this,"boxThickness",Lfe,this),X(this,"_position",Bfe,this),X(this,"_rotation",Ffe,this),X(this,"_scale",zfe,this),X(this,"_arc",Ufe,this),X(this,"_angle",kfe,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Mi,this.quat=new bi,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var t=e.prototype;return t.onInit=function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time},t.emit=function(e){switch(this.shapeType){case Xce.Box:!function(e,t,n,i){switch(e){case Yce.Volume:r=n,o=$fe,gi.set(r,ii(-o.x,o.x),ii(-o.y,o.y),ii(-o.z,o.z));break;case Yce.Shell:Jfe.splice(0,Jfe.length),Jfe.push(ii(-.5,.5)),Jfe.push(ii(-.5,.5)),Jfe.push(.5*ale()),ole(Jfe),tpe(Jfe,t),gi.set(n,Jfe[0],Jfe[1],Jfe[2]);break;case Yce.Edge:Jfe.splice(0,Jfe.length),Jfe.push(ii(-.5,.5)),Jfe.push(.5*ale()),Jfe.push(.5*ale()),ole(Jfe),tpe(Jfe,t),gi.set(n,Jfe[0],Jfe[1],Jfe[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,o;gi.copy(i,$ce)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case Xce.Circle:!function(e,t,n,i,r){rle(i,e*(1-t),e,n),gi.normalize(r,i)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case Xce.Cone:!function(e,t,n,i,r,o,a,s){switch(e){case Yce.Base:rle(a,t*(1-n),t,i),Fi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,gi.normalize(s,s),a.z=0;break;case Yce.Shell:tle(a,i),Fi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r),gi.normalize(s,s),Fi.multiplyScalar(a,a,t),a.z=0;break;case Yce.Volume:rle(a,t*(1-n),t,i),Fi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,gi.normalize(s,s),a.z=0,gi.add(a,a,gi.multiplyScalar(Zfe,s,o*ni()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case Xce.Sphere:!function(e,t,n,i,r){switch(e){case Yce.Volume:ile(i,t*(1-n),t),gi.normalize(r,i);break;case Yce.Shell:nle(i),gi.multiplyScalar(i,i,t),gi.normalize(r,i);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case Xce.Hemisphere:!function(e,t,n,i,r){switch(e){case Yce.Volume:ile(i,t*(1-n),t),i.z>0&&(i.z*=-1),gi.normalize(r,i);break;case Yce.Shell:nle(i),gi.multiplyScalar(i,i,t),i.z>0&&(i.z*=-1),gi.normalize(r,i);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(e.position.x+=ii(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=ii(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=ii(-this.randomPositionAmount,this.randomPositionAmount)),gi.transformQuat(e.velocity,e.velocity,this.quat),gi.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){var t=gi.normalize(Zfe,e.position);gi.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},t.constructMat=function(){bi.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Mi.fromRTS(this.mat,this.quat,this._position,this._scale)},t.generateArcAngle=function(){if(this.arcMode===Kce.Random)return ii(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case Kce.Loop:return li(e,this._arc);case Kce.PingPong:return ui(e,this._arc);default:return li(e,this._arc)}},B(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return ti(this._arc)},set:function(e){this._arc=ei(e)}},{key:"angle",get:function(){return Math.round(100*ti(this._angle))/100},set:function(e){this._angle=ei(e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case Xce.Box:this.emitFrom===Yce.Base&&(this.emitFrom=Yce.Volume);break;case Xce.Cone:this.emitFrom===Yce.Edge&&(this.emitFrom=Yce.Base);break;case Xce.Sphere:case Xce.Hemisphere:this.emitFrom!==Yce.Base&&this.emitFrom!==Yce.Edge||(this.emitFrom=Yce.Volume)}}}]),e}()).prototype,"position",[R_e,I_e],Object.getOwnPropertyDescriptor(xfe.prototype,"position"),xfe.prototype),Y(xfe.prototype,"rotation",[P_e,O_e],Object.getOwnPropertyDescriptor(xfe.prototype,"rotation"),xfe.prototype),Y(xfe.prototype,"scale",[D_e,M_e],Object.getOwnPropertyDescriptor(xfe.prototype,"scale"),xfe.prototype),Y(xfe.prototype,"arc",[N_e,L_e],Object.getOwnPropertyDescriptor(xfe.prototype,"arc"),xfe.prototype),Y(xfe.prototype,"angle",[B_e,F_e],Object.getOwnPropertyDescriptor(xfe.prototype,"angle"),xfe.prototype),Tfe=Y(xfe.prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(xfe.prototype,"enable",[z_e],Object.getOwnPropertyDescriptor(xfe.prototype,"enable"),xfe.prototype),Efe=Y(xfe.prototype,"_shapeType",[U_e,k_e,G_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xce.Cone}}),Y(xfe.prototype,"shapeType",[H_e,V_e],Object.getOwnPropertyDescriptor(xfe.prototype,"shapeType"),xfe.prototype),Cfe=Y(xfe.prototype,"emitFrom",[j_e,_l,W_e,q_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yce.Volume}}),bfe=Y(xfe.prototype,"alignToDirection",[_l,X_e,Y_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Afe=Y(xfe.prototype,"randomDirectionAmount",[_l,K_e,Q_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wfe=Y(xfe.prototype,"sphericalDirectionAmount",[_l,Z_e,J_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rfe=Y(xfe.prototype,"randomPositionAmount",[_l,$_e,efe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ife=Y(xfe.prototype,"radius",[_l,tfe,nfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Pfe=Y(xfe.prototype,"radiusThickness",[_l,ife,rfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ofe=Y(xfe.prototype,"arcMode",[ofe,_l,afe,sfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kce.Random}}),Dfe=Y(xfe.prototype,"arcSpread",[cfe,_l,lfe,ufe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mfe=Y(xfe.prototype,"arcSpeed",[hfe,_fe,ffe,_l,pfe,dfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Nfe=Y(xfe.prototype,"length",[_l,mfe,vfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Lfe=Y(xfe.prototype,"boxThickness",[_l,gfe,yfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(0,0,0)}}),Bfe=Y(xfe.prototype,"_position",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(0,0,0)}}),Ffe=Y(xfe.prototype,"_rotation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(0,0,0)}}),zfe=Y(xfe.prototype,"_scale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(1,1,1)}}),Ufe=Y(xfe.prototype,"_arc",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ei(360)}}),kfe=Y(xfe.prototype,"_angle",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ei(25)}}),Sfe=xfe))||Sfe);function tpe(e,t){t.x>0&&(e[0]+=.5*ii(-t.x,t.x),e[0]=Zn(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*ii(-t.y,t.y),e[1]=Zn(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*ii(-t.z,t.z),e[2]=Zn(e[2],-.5,.5))}var npe,ipe,rpe,ope,ape,spe,cpe,lpe,upe,hpe,_pe,fpe,ppe,dpe,mpe,vpe,gpe,ype,Spe,xpe,Tpe,Epe,Cpe,bpe,Ape,wpe,Rpe,Ipe,Ppe,Ope,Dpe,Mpe,Npe,Lpe,Bpe=[0,0,1,0,0,1,1,1],Fpe=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertAttrs=void 0,t._vertSize=void 0,t._vBuffer=void 0,t._vertAttrsFloatCount=void 0,t._vdataF32=void 0,t._vdataUint32=void 0,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=void 0,t._mesh=void 0,t._vertCount=0,t._indexCount=0,t._startTimeOffset=0,t._lifeTimeOffset=0,t._material=null,t.type=Qv.PARTICLE_BATCH,t._capacity=0,t._vertAttrs=null,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=new Po([new Ro]),t._iaInfoBuffer=t._device.createBuffer(new Ao(wr.INDIRECT,Pr.HOST|Pr.DEVICE,va,va)),t._subMeshData=null,t._mesh=null,t}z(t,e);var n=t.prototype;return n.setCapacity=function(e){var t=this._capacity!==e;this._capacity=e,this._subMeshData&&t&&this.rebuild()},n.setVertexAttributes=function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(var n,i=q(this._vertAttrs);!(n=i()).done;){var r=n.value;r.offset=this._vertSize,this._vertSize+=fa[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},n.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var n=this._vertAttrs[this._vertAttrs.findIndex((function(e){return e.name===lo.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,lo.ATTR_TEX_COORD,t,this._vertSize,n);var i=this._vertAttrs.findIndex((function(e){return e.name===lo.ATTR_TEX_COORD3}));if(n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,lo.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,lo.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,lo.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+n/4]=mi.WHITE._val;for(var a=new Float32Array(t),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,_=0;_<this._capacity;++_){var f=4*_;c[h++]=f,c[h++]=f+1,c[h++]=f+2,c[h++]=f+3,c[h++]=f+2,c[h++]=f+1}var p=this._device.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return p.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new Ao(wr.INDIRECT,Pr.HOST|Pr.DEVICE,va,va))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new KA([e],this._vertAttrs,Kr.TRIANGLE_LIST,p,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.updateMaterial=function(e){this._material=e,this.setSubModelMaterial(0,e)},n.addParticleVertexData=function(e,t){if(this._mesh)for(var n=0;n<this._vertCount;n++){var i=(e*this._vertCount+n)*this._vertAttrsFloatCount;this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,i+=2,this._vdataF32[i++]=t[1].z,this._vdataF32[i++]=t[2].x,this._vdataF32[i++]=t[2].y,this._vdataF32[i++]=t[2].z,this._vdataF32[i++]=t[3].x,this._vdataF32[i++]=t[3].y,this._vdataF32[i++]=t[3].z,this._vdataUint32[i++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}},n.addGPUParticleVertexData=function(e,t,n){for(var i=t*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=i;this._vdataF32[o++]=e.position.x,this._vdataF32[o++]=e.position.y,this._vdataF32[o++]=e.position.z,this._vdataF32[o++]=n,this._vdataF32[o++]=e.startSize.x,this._vdataF32[o++]=e.startSize.y,this._vdataF32[o++]=e.startSize.z,this._vdataF32[o++]=Bpe[2*r],this._vdataF32[o++]=e.rotation.x,this._vdataF32[o++]=e.rotation.y,this._vdataF32[o++]=e.rotation.z,this._vdataF32[o++]=Bpe[2*r+1],this._vdataF32[o++]=e.startColor.r/255,this._vdataF32[o++]=e.startColor.g/255,this._vdataF32[o++]=e.startColor.b/255,this._vdataF32[o++]=e.startColor.a/255,this._vdataF32[o++]=e.velocity.x,this._vdataF32[o++]=e.velocity.y,this._vdataF32[o++]=e.velocity.z,this._vdataF32[o++]=e.startLifetime,this._vdataF32[o++]=e.randomSeed,i+=this._vertAttrsFloatCount}},n.updateGPUParticles=function(e,t,n){for(var i=this._vertAttrsFloatCount*this._vertCount,r=0,o=0,a=0,s=0;s<e;++s)r=s*i,o=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(t-o)<n&&(a=--e*i,this._vdataF32.copyWithin(r,a,a+i),s--);return e},n.constructAttributeIndex=function(){if(this._vertAttrs){var e=this._vertAttrs.findIndex((function(e){return"a_position_starttime"===e.name})),t=this._vertAttrs[e].offset;this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex((function(e){return"a_dir_life"===e.name})),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3}},n.updateIA=function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)},n.clear=function(){this._subModels[0].inputAssembler.indexCount=0},n.destroy=function(){e.prototype.destroy.call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},n.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},t}(og),zpe=function(){function e(e){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=e}var t=e.prototype;return t.getInfo=function(){return this._renderInfo},t.onInit=function(e){this._particleSystem=e},t.onEnable=function(){if(this._particleSystem){this.attachToScene();var e=this._model;e&&(e.node=e.transform=this._particleSystem.node,e.enabled=this._particleSystem.enabledInHierarchy)}},t.onDisable=function(){this.detachFromScene()},t.onDestroy=function(){this._model&&(r.director.root.destroyModel(this._model),this._model=null)},t.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},t.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},t.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===qce.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},t.clear=function(){this._model&&(this._model.enabled=!1)},t.getModel=function(){return this._model},t._initModel=function(){this._model||(this._model=r.director.root.createModel(Fpe),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},t.updateTrailMaterial=function(){},t.getDefaultTrailMaterial=function(){return null},e}(),Upe=new gi,kpe=new Mi,Gpe=new bi,Hpe=(new gi,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),Vpe=[0,0,1,0,0,1,1,1],jpe=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD1,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD2,Cr.RGB32F),new Vo(lo.ATTR_COLOR,Cr.RGBA8,!0)],Wpe=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD1,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD2,Cr.RGB32F),new Vo(lo.ATTR_COLOR,Cr.RGBA8,!0),new Vo(lo.ATTR_COLOR1,Cr.RGB32F)],qpe=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD1,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD2,Cr.RGB32F),new Vo(lo.ATTR_COLOR,Cr.RGBA8,!0),new Vo(lo.ATTR_TEX_COORD3,Cr.RGB32F),new Vo(lo.ATTR_NORMAL,Cr.RGB32F),new Vo(lo.ATTR_COLOR1,Cr.RGBA8,!0)],Xpe={parent:null,owner:null,subModelIdx:0},Ype=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._trailDefines=void 0,n._frameTile_velLenScale=void 0,n._tmp_velLenScale=void 0,n._defaultMat=null,n._node_scale=void 0,n._attrs=void 0,n._particles=null,n._defaultTrailMat=null,n._updateList=new Map,n._animateList=new Map,n._runAnimateList=new Array,n._fillDataFunc=null,n._uScaleHandle=0,n._uLenHandle=0,n._uNodeRotHandle=0,n._alignSpace=Wce.View,n._inited=!1,n._localMat=new Mi,n._gravity=new Gi,n._model=null,n._frameTile_velLenScale=new Gi(1,1,0,0),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new Gi,n._attrs=new Array(5),n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},n._trailDefines={CC_USE_WORLD_SPACE:!0},n}z(t,e);var n=t.prototype;return n.onInit=function(t){var n=this;e.prototype.onInit.call(this,t),this._particles=new qe((function(){return new tce(n)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},n.clear=function(){e.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},n.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},n.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},n.getDefaultTrailMaterial=function(){return this._defaultTrailMat},n.setNewParticle=function(){},n._initModuleList=function(){var e=this;Hpe.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=kce.length;t<n;t++){var i=this._animateList[kce[t]];i&&this._runAnimateList.push(i)}},n.enableModule=function(e,t,n){t?(n.needUpdate&&(this._updateList[n.name]=n),n.needAnimate&&(this._animateList[n.name]=n)):(delete this._animateList[e],delete this._updateList[e]),this._runAnimateList.length=0;for(var i=0,r=kce.length;i<r;i++){var o=this._animateList[kce[i]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},n.updateAlignSpace=function(e){this._alignSpace=e},n.updateRotation=function(){var e=this._particleSystem;if(e){var t=(e.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateRotation(t)}},n.doUpdateRotation=function(e){if(this._alignSpace===Wce.Local)this._particleSystem.node.getRotation(Gpe);else if(this._alignSpace===Wce.World)this._particleSystem.node.getWorldRotation(Gpe);else if(this._alignSpace===Wce.View){var t;Gpe.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){bi.fromViewUp(Gpe,r.forward);break}}}else Gpe.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,Gpe)},n.updateScale=function(){var e=this._particleSystem;if(e){var t=(e.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(t)}},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case Vce.Local:this._particleSystem.node.getScale(this._node_scale);break;case Vce.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(this._uScaleHandle,this._node_scale)},n.updateParticles=function(e){var t=this,n=this._particleSystem;if(!n)return this._particles.length;n.node.getWorldMatrix(kpe);var i=(n.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(i),this.doUpdateRotation(i),this._updateList.forEach((function(e){e.update(n._simulationSpace,kpe)}));var r=n._trailModule,o=r&&r.enable;if(o&&r.update(),n.simulationSpace===Vce.Local){var a=n.node.getRotation();Mi.fromQuat(this._localMat,a),this._localMat.transpose()}for(var s=function(i){var a=t._particles.data[i];if(a.remainingLifetime-=e,gi.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return o&&r.removeParticle(a),t._particles.removeAt(i),--i,c=i,"continue";if(n.simulationSpace===Vce.Local){var s=9.8*-n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,oi(a.randomSeed))*e;t._gravity.x=0,t._gravity.y=s,t._gravity.z=0,t._gravity.w=1,t._gravity=t._gravity.transformMat4(t._localMat),a.velocity.x+=t._gravity.x,a.velocity.y+=t._gravity.y,a.velocity.z+=t._gravity.z}else a.velocity.y-=9.8*n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,oi(a.randomSeed))*e;gi.copy(a.ultimateVelocity,a.velocity),t._runAnimateList.forEach((function(t){t.animate(a,e)})),gi.scaleAndAdd(a.position,a.position,a.ultimateVelocity,e),o&&r.animate(a,e),c=i},c=0;c<this._particles.length;++c)s(c);return this._model.enabled=this._particles.length>0,this._particles.length},n.updateRenderData=function(){for(var e=0,t=0;t<this._particles.length;++t){var n=this._particles.data[t],i=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(i=n.frameIndex),e=4*t,this._fillDataFunc(n,e,i)}},n.beforeRender=function(){this._model.updateIA(this._particles.length)},n.getParticleCount=function(){return this._particles.length},n.onMaterialModified=function(e){this._inited&&(0===e?this.updateMaterialParams():this.updateTrailMaterial())},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);var n=this._particleSystem._trailModule;n&&n._trailModel&&1===e&&n._trailModel.setSubModelMaterial(0,t)},n._setFillFunc=function(){this._renderInfo.renderMode===qce.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===qce.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},n._fillMeshData=function(e,t,n){var i=t/4;this._attrs[0]=e.position,Upe.z=n,this._attrs[1]=Upe,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._model.addParticleVertexData(i,this._attrs)},n._fillStrecthedData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,Upe.x=Vpe[2*i],Upe.y=Vpe[2*i+1],Upe.z=n,this._attrs[1]=Upe,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=e.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(t++,this._attrs)},n._fillNormalData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,Upe.x=Vpe[2*i],Upe.y=Vpe[2*i+1],Upe.z=n,this._attrs[1]=Upe,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=null,this._model.addParticleVertexData(t++,this._attrs)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case qce.StrecthedBillboard:this._vertAttrs=Wpe.slice();break;case qce.Mesh:this._vertAttrs=qpe.slice();break;default:this._vertAttrs=jpe.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!=t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1!==n.indexOf("particle")&&-1===n.indexOf("particle-gpu")||e.setMaterial(null,0)}null==e.sharedMaterial&&null==this._defaultMat&&(Xpe.parent=Hv.get("default-particle-material"),Xpe.owner=this._particleSystem,Xpe.subModelIdx=0,this._defaultMat=new Kg(Xpe),Xpe.parent=null,Xpe.owner=null,Xpe.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e._simulationSpace===Vce.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=i.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var o=this._renderInfo.renderMode,a=this._frameTile_velLenScale;o===qce.Billboard?this._defines.CC_RENDER_MODE=0:o===qce.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,a.z=this._renderInfo.velocityScale,a.w=this._renderInfo.lengthScale):o===qce.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:o===qce.VerticalBillboard?this._defines.CC_RENDER_MODE=3:o===qce.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+o+" not support.");var s=e._textureAnimationModule;s&&s.enable?(Gi.copy(this._tmp_velLenScale,a),Fi.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)):r.setUniform(this._uLenHandle,a);var c,l=this._particleSystem._rotationOvertimeModule;c=l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=c,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},n.updateTrailMaterial=function(){if(this._particleSystem){var e=this._particleSystem,t=e._trailModule;if(t&&t.enable){e.simulationSpace===Vce.World||t.space===Vce.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var n=e.getMaterialInstance(1);null===n&&null===this._defaultTrailMat&&(Xpe.parent=Hv.get("default-trail-material"),Xpe.owner=this._particleSystem,Xpe.subModelIdx=1,this._defaultTrailMat=new Kg(Xpe),Xpe.parent=null,Xpe.owner=null,Xpe.subModelIdx=0),(n=n||this._defaultTrailMat).recompileShaders(this._trailDefines),t.updateMaterial()}}},t}(zpe),Kpe=new Mi,Qpe=new Gi,Zpe=new bi,Jpe=new bi,$pe=(new gi,32),ede="a_position_starttime",tde="a_size_uv",nde="a_rotation_uv",ide="a_color",rde="a_dir_life",ode="a_rndSeed",ade=[new Vo(ede,Cr.RGBA32F),new Vo(tde,Cr.RGBA32F),new Vo(nde,Cr.RGBA32F),new Vo(ide,Cr.RGBA32F),new Vo(rde,Cr.RGBA32F),new Vo(ode,Cr.R32F)],sde=[new Vo(ede,Cr.RGBA32F),new Vo(tde,Cr.RGBA32F),new Vo(nde,Cr.RGBA32F),new Vo(ide,Cr.RGBA32F),new Vo(rde,Cr.RGBA32F),new Vo(ode,Cr.R32F),new Vo(lo.ATTR_TEX_COORD,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD3,Cr.RGB32F),new Vo(lo.ATTR_NORMAL,Cr.RGB32F),new Vo(lo.ATTR_COLOR1,Cr.RGBA8,!0)],cde={parent:null,owner:null,subModelIdx:0},lde=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._frameTile_velLenScale=void 0,n._unifrom_velLenScale=void 0,n._tmp_velLenScale=void 0,n._node_scale=void 0,n._vertAttrs=[],n._defaultMat=null,n._particleNum=0,n._tempParticle=null,n._colorTexture=null,n._forceTexture=null,n._velocityTexture=null,n._rotationTexture=null,n._sizeTexture=null,n._animTexture=null,n._uTimeHandle=0,n._uRotHandle=0,n._uNodeRotHandle=0,n._alignSpace=Wce.View,n._inited=!1,n._frameTile_velLenScale=new Gi(1,1,0,0),n._unifrom_velLenScale=n._frameTile_velLenScale.clone(),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new Gi,n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},n._tempParticle=new tce(null),n._particleNum=0,n}z(t,e);var n=t.prototype;return n.onInit=function(t){e.prototype.onInit.call(this,t),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},n.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},n.setVertexAttributes=function(){e.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},n.clear=function(){e.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},n.enableModule=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;e&&(this.initShaderUniform(e),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e))},n.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},n.setNewParticle=function(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++},n.updateRotation=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var t=e.passes[0];this.doUpdateRotation(t)}},n.doUpdateRotation=function(e){if(this._alignSpace===Wce.Local)this._particleSystem.node.getRotation(Jpe);else if(this._alignSpace===Wce.World)this._particleSystem.node.getWorldRotation(Jpe);else if(this._alignSpace===Wce.View){var t;Jpe.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){bi.fromViewUp(Jpe,r.forward);break}}}else Jpe.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,Jpe)},n.updateScale=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var t=e.passes[0];this.doUpdateScale(t)}},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case Vce.Local:this._particleSystem.node.getScale(this._node_scale);break;case Vce.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(e.getHandle("scale"),this._node_scale)},n.updateParticles=function(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._model.enabled=this._particleNum>0,this._particleNum},n.updateRenderData=function(){},n.beforeRender=function(){this._model.updateIA(this._particleNum)},n.updateAlignSpace=function(e){this._alignSpace=e},n.updateShaderUniform=function(e){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(t){var n=t.passes[0];Qpe.x=this._particleSystem._time,Qpe.y=e,n.setUniform(this._uTimeHandle,Qpe),this._particleSystem.node.getWorldRotation(Zpe),n.setUniform(this._uRotHandle,Zpe),this.doUpdateRotation(n)}},n.initShaderUniform=function(e){var t=e.passes[0];this._uTimeHandle=t.getHandle("u_timeDelta"),this._uRotHandle=t.getHandle("u_worldRot"),this._uNodeRotHandle=t.getHandle("nodeRotation"),this.doUpdateScale(t),t.setUniform(t.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),Qpe.x=$pe,Qpe.y=.03125,t.setUniform(t.getHandle("u_sampleInfo"),Qpe);var n=!1,i=this._particleSystem._forceOvertimeModule;if(n=i&&i.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=n,n){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=Wae($pe,i.x,i.y,i.z);var r=t.getHandle("force_over_time_tex0"),o=Kv.getBindingFromHandle(r);t.bindSampler(o,this._forceTexture.getGFXSampler()),t.bindTexture(o,this._forceTexture.getGFXTexture());var a=t.getHandle("u_force_space");t.setUniform(a,i.space);var s=t.getHandle("u_force_mode");t.setUniform(s,this._forceTexture.height)}var c=this._particleSystem._velocityOvertimeModule;if(n=c&&c.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=n,n){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,n,i,r){for(var o=Math.max(Vae(t),Vae(n),Vae(i),Vae(r)),a=new Float32Array(e*o*4),s=[t,n,i,r],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<4;u++)for(var h=s[u],_=0,f=0,p=0;p<e;p++){var d=Hae(h,c*p,l);f=(_+=d)/(p+1),a[4*p+u]=f}return jae(a,e,o)}($pe,c.x,c.y,c.z,c.speedModifier);var l=t.getHandle("velocity_over_time_tex0"),u=Kv.getBindingFromHandle(l);t.bindSampler(u,this._velocityTexture.getGFXSampler()),t.bindTexture(u,this._velocityTexture.getGFXTexture());var h=t.getHandle("u_velocity_space");t.setUniform(h,c.space);var _=t.getHandle("u_velocity_mode");t.setUniform(_,this._velocityTexture.height)}var f=this._particleSystem._colorOverLifetimeModule;if(n=f&&f.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=n,n){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(e,t){for(var n=function(e){switch(e.mode){case Kse.TwoColors:case Kse.TwoGradients:return 2;default:return 1}}(t),i=new Uint8Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=Zse(t,r*s,a);i[o]=c.r,i[o+1]=c.g,i[o+2]=c.b,i[o+3]=c.a,o+=4}var l=new lv;return l.create(e,n,cm.RGBA8888),l.setFilters(um.LINEAR,um.LINEAR),l.setWrapMode(lm.CLAMP_TO_EDGE,lm.CLAMP_TO_EDGE),l.uploadData(i),l}($pe,f.color);var p=t.getHandle("color_over_time_tex0"),d=Kv.getBindingFromHandle(p);t.bindSampler(d,this._colorTexture.getGFXSampler()),t.bindTexture(d,this._colorTexture.getGFXTexture());var m=t.getHandle("u_color_mode");t.setUniform(m,this._colorTexture.height)}var v=this._particleSystem._rotationOvertimeModule;if(n=v&&v.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=n,n){this._rotationTexture&&this._rotationTexture.destroy(),v.separateAxes?this._rotationTexture=Wae($pe,v.x,v.y,v.z):this._rotationTexture=function(e,t){for(var n=Vae(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=Hae(t,r*s,a);i[o+2]=c,o+=4}return jae(i,e,n)}($pe,v.z);var g=t.getHandle("rotation_over_time_tex0"),y=Kv.getBindingFromHandle(g);t.bindSampler(y,this._rotationTexture.getGFXSampler()),t.bindTexture(y,this._rotationTexture.getGFXTexture());var S=t.getHandle("u_rotation_mode");t.setUniform(S,this._rotationTexture.height)}var x=this._particleSystem._sizeOvertimeModule;if(n=x&&x.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=n,n){this._sizeTexture&&this._sizeTexture.destroy(),x.separateAxes?this._sizeTexture=Wae($pe,x.x,x.y,x.z,!0):this._sizeTexture=function(e,t){for(var n=Vae(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0,s=0;s<n;s++){0;for(var c=0;c<e;c++){var l=Hae(t,r*c,s);o=l,i[a]=o,i[a+1]=o,i[a+2]=o,a+=4}}return jae(i,e,n)}($pe,x.size);var T=t.getHandle("size_over_time_tex0"),E=Kv.getBindingFromHandle(T);t.bindSampler(E,this._sizeTexture.getGFXSampler()),t.bindTexture(E,this._sizeTexture.getGFXTexture());var C=t.getHandle("u_size_mode");t.setUniform(C,this._sizeTexture.height)}var b=this._particleSystem._textureAnimationModule;if(n=b&&b.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=n,n){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t,n){for(var i=Math.max(Vae(t),Vae(n)),r=new Float32Array(e*i*4),o=[t,n],a=1/(e-1),s=0;s<i;s++)for(var c=0;c<2;c++)for(var l=o[c],u=0,h=0,_=0;_<e;_++){var f=Hae(l,a*_,s);h=(u+=f)/(_+1),r[4*_+c]=h}return jae(r,e,i)}($pe,b.startFrame,b.frameOverTime);var A=t.getHandle("texture_animation_tex0"),w=Kv.getBindingFromHandle(A);t.bindSampler(w,this._animTexture.getGFXSampler()),t.bindTexture(w,this._animTexture.getGFXTexture());var R=t.getHandle("u_anim_info");Qpe.x=this._animTexture.height,Qpe.y=b.numTilesX*b.numTilesY,Qpe.z=b.cycleCount,t.setUniform(R,Qpe)}},n.getParticleCount=function(){return this._particleNum},n.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case qce.StrecthedBillboard:this._vertAttrs=ade.slice();break;case qce.Mesh:this._vertAttrs=sde.slice();break;default:this._vertAttrs=ade.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!==t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1===n.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=t.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==e.sharedMaterial&&null==this._defaultMat&&(cde.parent=Hv.get("default-particle-gpu-material"),cde.owner=e,cde.subModelIdx=0,this._defaultMat=new Kg(cde),cde.parent=null,cde.owner=null,cde.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e.node.getWorldMatrix(Kpe),e._simulationSpace===Vce.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===qce.Billboard?this._defines.CC_RENDER_MODE=0:r===qce.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===qce.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===qce.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===qce.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support.");var o=e._textureAnimationModule;o&&o.enable?(Fi.set(this._frameTile_velLenScale,o.numTilesX,o.numTilesY),Gi.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,Gi.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},t}(zpe);function ude(){var e=$M.root.device;return!!(e.capabilities.maxVertexTextureUnits>=8&&e.hasFeature(Er.TEXTURE_FLOAT))||(r.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var hde,_de,fde,pde,dde,mde,vde,gde,yde,Sde,xde,Tde,Ede,Cde,bde,Ade,wde,Rde,Ide,Pde,Ode,Dde,Mde,Nde,Lde,Bde,Fde,zde,Ude,kde,Gde,Hde,Vde,jde,Wde,qde,Xde,Yde,Kde,Qde,Zde,Jde,$de,eme,tme,nme,ime,rme,ome,ame,sme,cme,lme,ume,hme,_me,fme,pme,dme,mme,vme,gme,yme,Sme,xme,Tme,Eme,Cme,bme,Ame,wme,Rme,Ime,Pme,Ome,Dme,Mme,Nme,Lme,Bme,Fme,zme,Ume,kme,Gme,Hme,Vme,jme,Wme,qme,Xme,Yme,Kme,Qme,Zme,Jme,$me,eve,tve,nve,ive,rve,ove,ave,sve,cve,lve,uve,hve,_ve,fve,pve,dve,mve,vve,gve,yve,Sve,xve,Tve,Eve,Cve,bve,Ave,wve,Rve,Ive,Pve,Ove,Dve,Mve,Nve,Lve,Bve,Fve,zve,Uve,kve,Gve,Hve,Vve,jve,Wve,qve,Xve,Yve,Kve,Qve,Zve,Jve,$ve,ege,tge,nge,ige,rge,oge,age,sge,cge,lge,uge,hge,_ge,fge,pge,dge,mge,vge,gge,yge,Sge,xge,Tge,Ege,Cge,bge,Age,wge,Rge,Ige,Pge,Oge,Dge,Mge,Nge,Lge,Bge,Fge,zge,Uge,kge,Gge,Hge,Vge,jge,Wge,qge,Xge,Yge,Kge,Qge,Zge,Jge,$ge,eye,tye,nye,iye,rye,oye,aye,sye,cye,lye,uye,hye,_ye,fye,pye,dye,mye,vye,gye,yye,Sye,xye,Tye,Eye,Cye,bye,Aye,wye,Rye,Iye,Pye,Oye,Dye,Mye,Nye,Lye=(npe=al("cc.ParticleSystemRenderer"),ipe=Gl(qce),rpe=Ml(),ope=wl(),ape=Ml(),spe=wl(),cpe=Ml(),lpe=wl(),upe=Gl(qce),hpe=Gl(Tj),_pe=Ml(),fpe=wl(),ppe=Gl(Mg),dpe=Ml(),mpe=wl(),vpe=Gl(Mg),gpe=Ml(),ype=wl(),Spe=Ml(),xpe=wl(),Tpe=Gl(Wce),Epe=Ml(),Cpe=wl(),npe((Lpe=Npe=function(){function e(){X(this,"_renderMode",wpe,this),X(this,"_velocityScale",Rpe,this),X(this,"_lengthScale",Ipe,this),X(this,"_mesh",Ppe,this),X(this,"_mainTexture",Ope,this),X(this,"_useGPU",Dpe,this),X(this,"_alignSpace",Mpe,this),this._particleSystem=null}var t=e.prototype;return t.create=function(e){null===this._particleSystem?this._particleSystem=e:this._particleSystem!==e&&w(6033)},t.onInit=function(e){if(this.create(e),this._particleSystem.processor)w(6034);else{var t=this._useGPU&&ude();this._particleSystem.processor=t?new lde(this):new Ype(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(e)}},t._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new lde(this):new Ype(this),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},B(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(e){this._mainTexture=e}},{key:"useGPU",get:function(){return this._useGPU},set:function(e){this._useGPU!==e&&(ude()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(e){this._alignSpace=e,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),e}(),Npe.AlignmentSpace=Wce,Y((Ape=Lpe).prototype,"renderMode",[ipe,rpe,ope],Object.getOwnPropertyDescriptor(Ape.prototype,"renderMode"),Ape.prototype),Y(Ape.prototype,"velocityScale",[ape,spe],Object.getOwnPropertyDescriptor(Ape.prototype,"velocityScale"),Ape.prototype),Y(Ape.prototype,"lengthScale",[cpe,lpe],Object.getOwnPropertyDescriptor(Ape.prototype,"lengthScale"),Ape.prototype),wpe=Y(Ape.prototype,"_renderMode",[upe,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qce.Billboard}}),Rpe=Y(Ape.prototype,"_velocityScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ipe=Y(Ape.prototype,"_lengthScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ppe=Y(Ape.prototype,"_mesh",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Ape.prototype,"mesh",[hpe,_pe,fpe],Object.getOwnPropertyDescriptor(Ape.prototype,"mesh"),Ape.prototype),Y(Ape.prototype,"particleMaterial",[ppe,dpe,mpe],Object.getOwnPropertyDescriptor(Ape.prototype,"particleMaterial"),Ape.prototype),Y(Ape.prototype,"trailMaterial",[vpe,gpe,ype],Object.getOwnPropertyDescriptor(Ape.prototype,"trailMaterial"),Ape.prototype),Ope=Y(Ape.prototype,"_mainTexture",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dpe=Y(Ape.prototype,"_useGPU",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(Ape.prototype,"useGPU",[Spe,xpe],Object.getOwnPropertyDescriptor(Ape.prototype,"useGPU"),Ape.prototype),Y(Ape.prototype,"alignSpace",[Tpe,Epe,Cpe],Object.getOwnPropertyDescriptor(Ape.prototype,"alignSpace"),Ape.prototype),Mpe=Y(Ape.prototype,"_alignSpace",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wce.View}}),bpe=Ape))||bpe),Bye=Math.cos(ei(100)),Fye={position:new gi,velocity:new gi},zye=new bi,Uye=new Mi,kye=new gi,Gye=new gi,Hye=new mi,Vye=function(){function e(e){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new gi,lifetime:0,width:0,velocity:new gi,direction:0,color:new mi})}var t=e.prototype;return t.getElement=function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])},t.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new gi,lifetime:0,width:0,velocity:new gi,direction:0,color:new mi}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]},t.iterateElement=function(e,t,n,i){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)t(e,this.trailElements[o%this.trailElements.length],n,i)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},t.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},t.clear=function(){this.start=-1,this.end=-1},e}(),jye=(hde=al("cc.TrailModule"),_de=Ml(),fde=Gl(Qce),pde=Ml(),dde=wl(),mde=Gl(Gae),vde=Rl(),gde=Ml(),yde=wl(),Sde=Ml(),xde=wl(),Tde=Gl(Vce),Ede=Ml(),Cde=wl(),bde=Gl(Zce),Ade=Ml(),wde=wl(),Rde=Ml(),Ide=wl(),Pde=Gl(Gae),Ode=Rl(),Dde=Ml(),Mde=wl(),Nde=Ml(),Lde=wl(),Bde=Gl(Qse),Fde=Ml(),zde=wl(),Ude=Gl(Qse),kde=Ml(),Gde=wl(),Hde=Gl(Vce),hde((Y((jde=function(){function e(){X(this,"_enable",Wde,this),X(this,"mode",qde,this),X(this,"lifeTime",Xde,this),X(this,"_minParticleDistance",Yde,this),X(this,"existWithParticles",Kde,this),X(this,"textureMode",Qde,this),X(this,"widthFromParticle",Zde,this),X(this,"widthRatio",Jde,this),X(this,"colorFromParticle",$de,this),X(this,"colorOverTrail",eme,this),X(this,"colorOvertime",tme,this),X(this,"_space",nme,this),X(this,"_particleSystem",ime,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new Po([new Ro]),this._vertAttrs=[new Vo(lo.ATTR_POSITION,Cr.RGB32F),new Vo(lo.ATTR_TEX_COORD,Cr.RGBA32F),new Vo(lo.ATTR_TEX_COORD1,Cr.RGB32F),new Vo(lo.ATTR_COLOR,Cr.RGBA8,!0)],this._vertSize=0;for(var e,t=q(this._vertAttrs);!(e=t()).done;){var n=e.value;this._vertSize+=fa[n.format].size}this._particleTrail=new Map}var t=e.prototype;return t.onInit=function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;for(var t=0,n=e.startLifetime.getMax(),i=e.rateOverTime.getMax(),r=e.duration,o=0,a=e.bursts.length;o<a;o++)t+=e.bursts[o].getMaxCount(e)*Math.ceil(n/r);this._trailNum=Math.ceil(n*this.lifeTime.getMax()*60*(i*r+t)),this._trailSegments=new We((function(){return new Vye(10)}),Math.ceil(i*r),(function(e){return e.trailElements.length=0})),this._enable&&(this.enable=this._enable)},t.onEnable=function(){this._attachToScene()},t.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},t._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},t._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},t.destroy=function(){this.destroySubMeshData(),this._trailModel&&($M.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},t.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},t.clear=function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},t.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},t.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===Vce.World&&this._particleSystem._simulationSpace===Vce.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(Uye),this._particleSystem.node.getWorldRotation(zye)):this._needTransform=!1},t.animate=function(e,t){if(this._trailSegments)if(e.loopCount>e.lastLoop)e.trailDelay>1?(e.lastLoop=e.loopCount,e.trailDelay=0):e.trailDelay++;else{var n=this._particleTrail.get(e);if(!n)return n=this._trailSegments.alloc(),void this._particleTrail.set(e,n);var i=n.getElement(n.end-1);if(this._needTransform?gi.transformMat4(kye,e.position,Uye):gi.copy(kye,e.position),!(i&&(n.iterateElement(this,this._updateTrailElement,e,t),gi.squaredDistance(i.position,kye)<this._minSquaredDistance))&&(i=n.addElement())){gi.copy(i.position,kye),i.lifetime=0,this.widthFromParticle?i.width=e.size.x*this.widthRatio.evaluate(0,1):i.width=this.widthRatio.evaluate(0,1);var r=n.count();if(2===r){var o=n.getElement(n.end-2);gi.subtract(o.velocity,i.position,o.position)}else if(r>2){var a=n.getElement(n.end-2),s=n.getElement(n.end-3);gi.subtract(kye,s.position,a.position),gi.subtract(Gye,i.position,a.position),gi.subtract(a.velocity,Gye,kye),gi.equals(gi.ZERO,a.velocity)&&gi.copy(a.velocity,kye),gi.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,s)}this.colorFromParticle?i.color.set(e.color):i.color.set(this.colorOvertime.evaluate(0,1))}}},t.removeParticle=function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))},t.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var e,t=q(this._particleTrail.keys());!(e=t()).done;){var n=e.value,i=this._particleTrail.get(n);if(-1!==i.start){var r=4*this.vbOffset/this._vertSize,o=i.start>=i.end?i.end+i.trailElements.length:i.end,a=o-i.start,s=1/a,c=i.trailElements[i.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var l=i.start+1;l<o;l++){var u=i.trailElements[l%i.trailElements.length],h=l-i.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/a,1),r,1-h*s,h,5)}this._needTransform?gi.transformMat4(Fye.position,n.position,Uye):gi.copy(Fye.position,n.position);var _=this._trailModel;if(_&&_.node.invalidateChildren(ng.POSITION),1===a||2===a){var f=i.getElement(i.end-1);gi.subtract(f.velocity,Fye.position,f.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=f.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=f.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=f.velocity.z,this._vbF32[this.vbOffset-4]=f.velocity.x,this._vbF32[this.vbOffset-3]=f.velocity.y,this._vbF32[this.vbOffset-2]=f.velocity.z,gi.subtract(Fye.velocity,Fye.position,f.position),this._checkDirectionReverse(Fye,f)}else if(a>2){var p=i.getElement(i.end-1),d=i.getElement(i.end-2);gi.subtract(kye,d.position,p.position),gi.subtract(Gye,Fye.position,p.position),gi.normalize(kye,kye),gi.normalize(Gye,Gye),gi.subtract(p.velocity,Gye,kye),gi.normalize(p.velocity,p.velocity),this._checkDirectionReverse(p,d),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(p,this.colorOverTrail.evaluate(s,1),r,s,a-1,5),gi.subtract(Fye.velocity,Fye.position,p.position),gi.normalize(Fye.velocity,Fye.velocity),this._checkDirectionReverse(Fye,p)}this.widthFromParticle?Fye.width=n.size.x*this.widthRatio.evaluate(0,1):Fye.width=this.widthRatio.evaluate(0,1),Fye.color=n.color,gi.equals(Fye.velocity,gi.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Fye,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel.enabled=this.ibOffset>0},t.updateIA=function(e){var t=this._trailModel&&this._trailModel.subModels;if(t&&t.length>0){var n=t[0];n.inputAssembler.vertexBuffers[0].update(this._vbF32),n.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=e,this._iaInfoBuffer.update(this._iaInfo)}},t.beforeRender=function(){this.updateIA(this.ibOffset)},t._createModel=function(){this._trailModel||(this._trailModel=r.director.root.createModel(og))},t.rebuild=function(){var e=$M.root.device,t=e.createBuffer(new Ao(wr.VERTEX|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),n=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(n),this._vbUint32=new Uint32Array(n),t.update(n);var i=e.createBuffer(new Ao(wr.INDEX|wr.TRANSFER_DST,Pr.HOST|Pr.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),i.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer(new Ao(wr.INDIRECT,Pr.HOST|Pr.DEVICE,va,va)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new KA([t],this._vertAttrs,Kr.TRIANGLE_LIST,i,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},t._updateTrailElement=function(e,t,n,i){return t.lifetime+=i,e.colorFromParticle?(t.color.set(n.color),t.color.multiply(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1)),e.widthFromParticle?t.width=n.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime},t._fillVertexBuffer=function(e,t,n,i,r,o){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,Hye.set(e.color),Hye.multiply(t),this._vbUint32[this.vbOffset++]=Hye._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=Hye._val,1&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r-1,this._iBuffer[this.ibOffset++]=n+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r+1,this._iBuffer[this.ibOffset++]=n+2*r+2)},t._checkDirectionReverse=function(e,t){gi.dot(e.velocity,t.velocity)<Bye?e.direction=1-t.direction:e.direction=t.direction},t.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},B(e,[{key:"enable",get:function(){return this._enable},set:function(e){e===this._enable&&this._trailModel||(e&&!this._enable&&(this._enable=e,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),e&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e;var t=this._particleSystem;t&&t.processor&&t.processor.updateTrailMaterial()}}]),e}()).prototype,"enable",[_de],Object.getOwnPropertyDescriptor(jde.prototype,"enable"),jde.prototype),Wde=Y(jde.prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qde=Y(jde.prototype,"mode",[fde,_l,pde,dde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qce.Particles}}),Xde=Y(jde.prototype,"lifeTime",[mde,_l,vde,gde,yde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Yde=Y(jde.prototype,"_minParticleDistance",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Y(jde.prototype,"minParticleDistance",[Sde,xde],Object.getOwnPropertyDescriptor(jde.prototype,"minParticleDistance"),jde.prototype),Y(jde.prototype,"space",[Tde,Ede,Cde],Object.getOwnPropertyDescriptor(jde.prototype,"space"),jde.prototype),Kde=Y(jde.prototype,"existWithParticles",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Qde=Y(jde.prototype,"textureMode",[bde,_l,Ade,wde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zce.Stretch}}),Zde=Y(jde.prototype,"widthFromParticle",[_l,Rde,Ide],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Jde=Y(jde.prototype,"widthRatio",[Pde,_l,Ode,Dde,Mde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),$de=Y(jde.prototype,"colorFromParticle",[_l,Nde,Lde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eme=Y(jde.prototype,"colorOverTrail",[Bde,_l,Fde,zde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qse}}),tme=Y(jde.prototype,"colorOvertime",[Ude,_l,kde,Gde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qse}}),nme=Y(jde.prototype,"_space",[Hde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vce.World}}),ime=Y(jde.prototype,"_particleSystem",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vde=jde))||Vde),Wye=new Mi,qye=new bi,Xye=new gi,Yye=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],Kye=function(){function e(e){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new Mi,this._gravity=new Gi,this.minPos=new gi,this.maxPos=new gi,this._nodePos=new gi,this._nodeSize=new gi,this._particleSystem=e,this._processor=this._particleSystem.processor,this._node=e.node,this._particlesAll=[],this._initModuleList()}var t=e.prototype;return t._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},t.setBoundingBoxSize=function(e){this.maxPos.x=this._nodePos.x+e.x,this.maxPos.y=this._nodePos.y+e.y,this.maxPos.z=this._nodePos.z+e.z,this.minPos.x=this._nodePos.x-e.x,this.minPos.y=this._nodePos.y-e.y,this.minPos.z=this._nodePos.z-e.z,this._updateBoundingNode()},t.setBoundingBoxCenter=function(e,t,n){this.maxPos.x=e+.5*this._nodeSize.x,this.maxPos.y=t+.5*this._nodeSize.y,this.maxPos.z=n+.5*this._nodeSize.z,this.minPos.x=e-.5*this._nodeSize.x,this.minPos.y=t-.5*this._nodeSize.y,this.minPos.z=n-.5*this._nodeSize.z,this._updateBoundingNode()},t._initModuleList=function(){var e=this;Yye.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=kce.length;t<n;t++){var i=this._animateList[kce[t]];i&&this._runAnimateList.push(i)}},t._emit=function(e,t,n){var i=this._particleSystem,r=this._node,o=i.time%i.duration/i.duration;r.invalidateChildren(ng.POSITION),i.simulationSpace===Vce.World&&(r.getWorldMatrix(Wye),r.getWorldRotation(qye));for(var a=0;a<e;++a){var s=new tce(i);s.particleSystem=i,s.reset();var c=oi(ri(0,Pn));i._shapeModule&&i._shapeModule.enable?i._shapeModule.emit(s):(gi.set(s.position,0,0,0),gi.copy(s.velocity,$ce)),i._textureAnimationModule&&i._textureAnimationModule.enable&&i._textureAnimationModule.init(s);var l=i.startSpeed.evaluate(o,c);gi.multiplyScalar(s.velocity,s.velocity,l),i.simulationSpace===Vce.World&&(gi.transformMat4(s.position,s.position,Wye),gi.transformQuat(s.velocity,s.velocity,qye)),gi.copy(s.ultimateVelocity,s.velocity),gi.set(s.rotation,0,0,0),i.startSize3D?gi.set(s.startSize,i.startSizeX.evaluate(o,c),i.startSizeY.evaluate(o,c),i.startSizeZ.evaluate(o,c)):(gi.set(s.startSize,i.startSizeX.evaluate(o,c),1,1),s.startSize.y=s.startSize.x),gi.copy(s.size,s.startSize),s.startLifetime=i.startLifetime.evaluate(o,c)+t,s.remainingLifetime=s.startLifetime,n.push(s)}},t._updateParticles=function(e,t){var n=this,i=this._particleSystem;switch(i.node.getWorldMatrix(Wye),i.scaleSpace){case Vce.Local:i.node.getScale(Xye);break;case Vce.World:i.node.getWorldScale(Xye)}if(this._updateList.forEach((function(e){e.update(i.simulationSpace,Wye)})),i.simulationSpace===Vce.Local){var r=i.node.getRotation();Mi.fromQuat(this._localMat,r),this._localMat.transpose()}for(var o=function(r){var o=t[r];if(o.remainingLifetime-=e,gi.set(o.animatedVelocity,0,0,0),i.simulationSpace===Vce.Local){var a=9.8*-i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,oi(o.randomSeed))*e;n._gravity.x=0,n._gravity.y=a,n._gravity.z=0,n._gravity.w=1,n._gravity=n._gravity.transformMat4(n._localMat),o.velocity.x+=n._gravity.x,o.velocity.y+=n._gravity.y,o.velocity.z+=n._gravity.z}else o.velocity.y-=9.8*i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,oi(o.randomSeed))*e;gi.copy(o.ultimateVelocity,o.velocity),n._runAnimateList.forEach((function(t){t.animate(o,e)})),gi.scaleAndAdd(o.position,o.position,o.ultimateVelocity,e)},a=0;a<t.length;++a)o(a)},t._calculateBounding=function(e){var t=new gi,n=new gi,i=new gi,r=new gi,o=new gi(1,1,1);if(this._processor.getInfo().renderMode===qce.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var s=new Fc;Fc.fromPoints(s,a.struct.minPosition,a.struct.maxPosition);var c=Math.max(s.halfExtents.x,s.halfExtents.y,s.halfExtents.z);o.set(c,c,c)}}for(var l=0;l<this._particlesAll.length;++l){var u=this._particlesAll[l];gi.multiply(t,Xye,u.size),gi.multiply(t,t,o),n.set(u.position),this._particleSystem.simulationSpace!==Vce.World&&gi.transformMat4(n,n,this._particleSystem.node._mat),e&&0===l?(gi.subtract(this.minPos,n,t),gi.add(this.maxPos,n,t)):(gi.subtract(i,n,t),gi.add(r,n,t),gi.min(this.minPos,this.minPos,i),gi.max(this.maxPos,this.maxPos,r))}},t.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var e=oi(ri(0,Pn));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,e),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},t.clear=function(){this._particlesAll.length=0},t.destroy=function(){},e}(),Qye=new Mi,Zye=new bi,Jye=Object.getOwnPropertyDescriptor(EF.prototype,"sharedMaterials"),$ye=function(t){return e({ParticleSystem:t,ParticleSystemComponent:t}),t}((rme=al("cc.ParticleSystem"),ome=Tl(),ame=gl(),sme=cl(99),cme=Ml(),lme=wl(),ume=Gl(Qse),hme=Ml(),_me=wl(),fme=Gl(Vce),pme=Ml(),dme=wl(),mme=Ml(),vme=wl(),gme=fl("startSize"),yme=Rl(),Sme=Gl(Gae),xme=Ml(),Tme=wl(),Eme=Gl(Gae),Cme=Rl(),bme=Ml(),Ame=wl(),wme=Gl(Gae),Rme=Rl(),Ime=Ml(),Pme=wl(),Ome=Gl(Gae),Dme=Rl(),Mme=Ml(),Nme=wl(),Lme=Ml(),Bme=wl(),Fme=Gl(Gae),zme=Rl(),Ume=Ml(),kme=wl(),Gme=Gl(Gae),Hme=Rl(),Vme=Ml(),jme=wl(),Wme=Gl(Gae),qme=fl("startRotation"),Xme=Rl(),Yme=Ml(),Kme=wl(),Qme=Gl(Gae),Zme=Rl(),Jme=Ml(),$me=wl(),eve=Gl(Gae),tve=Rl(),nve=Ml(),ive=wl(),rve=Ml(),ove=wl(),ave=Ml(),sve=wl(),cve=Ml(),lve=wl(),uve=Gl(Vce),hve=Ml(),_ve=wl(),fve=Ml(),pve=wl(),dve=Ml(),mve=wl(),vve=Gl(Gae),gve=Rl(),yve=Ml(),Sve=wl(),xve=Gl(Gae),Tve=Rl(),Eve=Ml(),Cve=wl(),bve=Gl(Gae),Ave=Rl(),wve=Ml(),Rve=wl(),Ive=Gl([Qfe]),Pve=Ml(),Ove=wl(),Dve=Gl(Boolean),Mve=Ml(),Nve=wl(),Lve=Gl(jce),Bve=Ml(),Fve=wl(),zve=Gl(Number),Uve=Ml(),kve=wl(),Gve=Gl(Number),Hve=Ml(),Vve=wl(),jve=Gl(Number),Wve=Ml(),qve=wl(),Xve=Ml(),Yve=wl(),Kve=fl("enableCulling"),Qve=Cl(),Zve=Gl(Mg),Jve=Al(),$ve=Gl(Jce),ege=Gl(Jce),tge=Ml(),nge=wl(),ige=Gl(epe),rge=Gl(epe),oge=Ml(),age=wl(),sge=Gl(Hfe),cge=Gl(Hfe),lge=Ml(),uge=wl(),hge=Gl(Kfe),_ge=Gl(Kfe),fge=Ml(),pge=wl(),dge=Gl(due),mge=Gl(due),vge=Ml(),gge=wl(),yge=Gl(yue),Sge=Gl(yue),xge=Ml(),Tge=wl(),Ege=Gl(Gfe),Cge=Gl(Gfe),bge=Ml(),Age=wl(),wge=Gl(qfe),Rge=Gl(qfe),Ige=Ml(),Pge=wl(),Oge=Gl(jye),Dge=Gl(jye),Mge=Ml(),Nge=wl(),Lge=Gl(Lye),Bge=Ml(),Fge=wl(),rme(zge=ome(zge=ame(zge=sme(zge=vl((wye=Aye=function(e){function t(){var t;return X(t=e.call(this)||this,"startColor",kge,j(t)),X(t,"scaleSpace",Gge,j(t)),X(t,"startSize3D",Hge,j(t)),X(t,"startSizeX",Vge,j(t)),X(t,"startSizeY",jge,j(t)),X(t,"startSizeZ",Wge,j(t)),X(t,"startSpeed",qge,j(t)),X(t,"startRotation3D",Xge,j(t)),X(t,"startRotationX",Yge,j(t)),X(t,"startRotationY",Kge,j(t)),X(t,"startRotationZ",Qge,j(t)),X(t,"startDelay",Zge,j(t)),X(t,"startLifetime",Jge,j(t)),X(t,"duration",$ge,j(t)),X(t,"loop",eye,j(t)),X(t,"simulationSpeed",tye,j(t)),X(t,"playOnAwake",nye,j(t)),X(t,"gravityModifier",iye,j(t)),X(t,"rateOverTime",rye,j(t)),X(t,"rateOverDistance",oye,j(t)),X(t,"bursts",aye,j(t)),X(t,"_renderCulling",sye,j(t)),X(t,"_cullingMode",cye,j(t)),X(t,"_aabbHalfX",lye,j(t)),X(t,"_aabbHalfY",uye,j(t)),X(t,"_aabbHalfZ",hye,j(t)),X(t,"_dataCulling",_ye,j(t)),X(t,"_colorOverLifetimeModule",fye,j(t)),X(t,"_shapeModule",pye,j(t)),X(t,"_sizeOvertimeModule",dye,j(t)),X(t,"_velocityOvertimeModule",mye,j(t)),X(t,"_forceOvertimeModule",vye,j(t)),X(t,"_limitVelocityOvertimeModule",gye,j(t)),X(t,"_rotationOvertimeModule",yye,j(t)),X(t,"_textureAnimationModule",Sye,j(t)),X(t,"_trailModule",xye,j(t)),X(t,"renderer",Tye,j(t)),t._isPlaying=void 0,t._isPaused=void 0,t._isStopped=void 0,t._isEmitting=void 0,t._needRefresh=void 0,t._time=void 0,t._emitRateTimeCounter=void 0,t._emitRateDistanceCounter=void 0,t._oldWPos=void 0,t._curWPos=void 0,t._boundingBox=void 0,t._culler=void 0,t._oldPos=void 0,t._curPos=void 0,t._isCulled=void 0,t._customData1=void 0,t._customData2=void 0,t._subEmitters=void 0,X(t,"_prewarm",Eye,j(t)),X(t,"_capacity",Cye,j(t)),X(t,"_simulationSpace",bye,j(t)),t.processor=null,t.rateOverTime.constant=10,t.startLifetime.constant=5,t.startSizeX.constant=1,t.startSpeed.constant=5,t._isPlaying=!1,t._isPaused=!1,t._isStopped=!0,t._isEmitting=!1,t._needRefresh=!0,t._time=0,t._emitRateTimeCounter=0,t._emitRateDistanceCounter=0,t._oldWPos=new gi,t._curWPos=new gi,t._boundingBox=null,t._culler=null,t._oldPos=null,t._curPos=null,t._isCulled=!1,t._customData1=new Fi,t._customData2=new Fi,t._subEmitters=[],t}z(t,e);var n=t.prototype;return n.onFocusInEditor=function(){this.renderer.create(this)},n.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},n._onMaterialModified=function(e,t){null!==this.processor&&this.processor.onMaterialModified(e,t)},n._onRebuildPSO=function(e,t){this.processor.onRebuildPSO(e,t)},n._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},n._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},n._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},n.play=function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play()},n.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},n.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0},n.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!0)},n.getParticleCount=function(){return this.processor.getParticleCount()},n.setCustomData1=function(e,t){Fi.set(this._customData1,e,t)},n.setCustomData2=function(e,t){Fi.set(this._customData2,e,t)},n.onDestroy=function(){r.director.off(r.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.onEnable=function(){r.director.on(r.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},n.onDisable=function(){r.director.off(r.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n._calculateBounding=function(e){this._boundingBox&&(this._culler||(this._culler=new Kye(this)),this._culler.calculatePositions(),Fc.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),e?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},n.update=function(e){var t=e*this.simulationSpeed;if(this.renderCulling){var n;if(this._boundingBox||(this._boundingBox=new Fc,this._calculateBounding(!1)),this._curPos||(this._curPos=new gi),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new gi,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var i=this._curPos.x-this._oldPos.x,r=this._curPos.y-this._oldPos.y,o=this._curPos.z-this._oldPos.z,a=this._boundingBox.center;a.x+=i,a.y+=r,a.z+=o,this._culler.setBoundingBoxCenter(a.x,a.y,a.z),this._oldPos.set(this._curPos)}var s=null===(n=this.node.scene.renderScene)||void 0===n?void 0:n.cameras,c=!0;if(void 0!==s&&this._boundingBox)for(var l=0;l<s.length;++l){var u=s[l];if((u.visibility&this.node.layer)===this.node.layer&&ic.aabbFrustum(this._boundingBox,u.frustum)){c=!1;break}}if(c){if(this._cullingMode!==jce.AlwaysSimulate&&this.pause(),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===jce.PauseAndCatchup&&(this._time+=t),this._cullingMode!==jce.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isPlaying||this.play()}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null);this._isPlaying?(this._time+=t,this._emit(t),0!==this.processor.updateParticles(t)||this._isEmitting||this.stop()):(this.processor.updateRotation(),this.processor.updateScale()),this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()},n.beforeRender=function(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},n._onVisibilityChange=function(e){this.processor._model&&(this.processor._model.visFlags=e)},n.emit=function(e,t){var n=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(ng.POSITION),this._needRefresh=!1),this._simulationSpace===Vce.World&&(this.node.getWorldMatrix(Qye),this.node.getWorldRotation(Zye));for(var i=0;i<e;++i){var r=this.processor.getFreeParticle();if(null===r)return;r.particleSystem=this,r.reset();var o=oi(ri(0,Pn));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(r):(gi.set(r.position,0,0,0),gi.copy(r.velocity,$ce)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(r);var a=this.startSpeed.evaluate(n,o);gi.multiplyScalar(r.velocity,r.velocity,a),this._simulationSpace===Vce.World&&(gi.transformMat4(r.position,r.position,Qye),gi.transformQuat(r.velocity,r.velocity,Zye)),gi.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?r.startEuler.set(this.startRotationX.evaluate(n,o),this.startRotationY.evaluate(n,o),this.startRotationZ.evaluate(n,o)):r.startEuler.set(0,0,this.startRotationZ.evaluate(n,o)),gi.set(r.rotation,r.startEuler.x,r.startEuler.y,r.startEuler.z),this.startSize3D?gi.set(r.startSize,this.startSizeX.evaluate(n,o),this.startSizeY.evaluate(n,o),this.startSizeZ.evaluate(n,o)):(gi.set(r.startSize,this.startSizeX.evaluate(n,o),1,1),r.startSize.y=r.startSize.x),gi.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(n,o)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(n,o)+t,r.remainingLifetime=r.startLifetime,r.randomSeed=ri(0,233280),r.loopCount++,this.processor.setNewParticle(r)}},n._prewarmSystem=function(){this.startDelay.mode=kae.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)},n._emit=function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){var n=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=n,this.emit(n,e)}this.node.getWorldPosition(this._curWPos);var i=gi.distance(this._curWPos,this._oldWPos);if(gi.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=i*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}for(var o,a=q(this.bursts);!(o=a()).done;)o.value.update(this,e)}},n._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),gi.copy(this._curWPos,this._oldWPos)},n.addSubEmitter=function(e){this._subEmitters.push(e)},n.removeSubEmitter=function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)},n.addBurst=function(e){this.bursts.push(e)},n.removeBurst=function(e){this.bursts.splice(this.bursts.indexOf(e),1)},n.getBoundingX=function(){return this._aabbHalfX},n.getBoundingY=function(){return this._aabbHalfY},n.getBoundingZ=function(){return this._aabbHalfZ},n.setBoundingX=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=e)},n.setBoundingY=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=e)},n.setBoundingZ=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=e)},n._onBeforeSerialize=function(e){var t=this;return this.dataCulling?e.filter((function(e){return!Gce.includes(e)||t[e]&&t[e].enable})):e},B(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=Math.floor(e),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(e){this._renderCulling=e,e&&(this._boundingBox||(this._boundingBox=new Fc,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(e){this._cullingMode=e}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(e){this.setBoundingX(e)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(e){this.setBoundingY(e)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(e){this.setBoundingZ(e)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(e){this._dataCulling=e}},{key:"sharedMaterials",get:function(){return Jye.get.call(this)},set:function(e){Jye.set.call(this,e)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(e){e&&(this._colorOverLifetimeModule=e)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(e){e&&(this._shapeModule=e)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(e){e&&(this._sizeOvertimeModule=e)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(e){e&&(this._velocityOvertimeModule=e)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(e){e&&(this._forceOvertimeModule=e)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(e){e&&(this._limitVelocityOvertimeModule=e)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(e){e&&(this._rotationOvertimeModule=e)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(e){e&&(this._textureAnimationModule=e)}},{key:"trailModule",get:function(){return this._trailModule},set:function(e){e&&(this._trailModule=e)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}(EF),Aye.CullingMode=jce,Y((Uge=wye).prototype,"capacity",[cme,lme],Object.getOwnPropertyDescriptor(Uge.prototype,"capacity"),Uge.prototype),kge=Y(Uge.prototype,"startColor",[ume,_l,hme,_me],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qse}}),Gge=Y(Uge.prototype,"scaleSpace",[fme,_l,pme,dme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vce.Local}}),Hge=Y(Uge.prototype,"startSize3D",[_l,mme,vme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Vge=Y(Uge.prototype,"startSizeX",[gme,yme,Sme,xme,Tme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),jge=Y(Uge.prototype,"startSizeY",[Eme,_l,Cme,bme,Ame],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Wge=Y(Uge.prototype,"startSizeZ",[wme,_l,Rme,Ime,Pme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),qge=Y(Uge.prototype,"startSpeed",[Ome,_l,Dme,Mme,Nme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Xge=Y(Uge.prototype,"startRotation3D",[_l,Lme,Bme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yge=Y(Uge.prototype,"startRotationX",[Fme,_l,zme,Nl,Ume,kme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Kge=Y(Uge.prototype,"startRotationY",[Gme,_l,Hme,Nl,Vme,jme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Qge=Y(Uge.prototype,"startRotationZ",[Wme,qme,Xme,Nl,Yme,Kme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Zge=Y(Uge.prototype,"startDelay",[Qme,_l,Zme,Jme,$me],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),Jge=Y(Uge.prototype,"startLifetime",[eve,_l,tve,nve,ive],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),$ge=Y(Uge.prototype,"duration",[_l,rve,ove],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),eye=Y(Uge.prototype,"loop",[_l,ave,sve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y(Uge.prototype,"prewarm",[cve,lve],Object.getOwnPropertyDescriptor(Uge.prototype,"prewarm"),Uge.prototype),Y(Uge.prototype,"simulationSpace",[uve,_l,hve,_ve],Object.getOwnPropertyDescriptor(Uge.prototype,"simulationSpace"),Uge.prototype),tye=Y(Uge.prototype,"simulationSpeed",[_l,fve,pve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nye=Y(Uge.prototype,"playOnAwake",[_l,dve,mve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iye=Y(Uge.prototype,"gravityModifier",[vve,_l,gve,yve,Sve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),rye=Y(Uge.prototype,"rateOverTime",[xve,_l,Tve,Eve,Cve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),oye=Y(Uge.prototype,"rateOverDistance",[bve,_l,Ave,wve,Rve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gae}}),aye=Y(Uge.prototype,"bursts",[Ive,_l,Pve,Ove],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Y(Uge.prototype,"renderCulling",[Dve,Mve,Nve],Object.getOwnPropertyDescriptor(Uge.prototype,"renderCulling"),Uge.prototype),sye=Y(Uge.prototype,"_renderCulling",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(Uge.prototype,"cullingMode",[Lve,Bve,Fve],Object.getOwnPropertyDescriptor(Uge.prototype,"cullingMode"),Uge.prototype),cye=Y(Uge.prototype,"_cullingMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jce.Pause}}),Y(Uge.prototype,"aabbHalfX",[zve,Uve,kve],Object.getOwnPropertyDescriptor(Uge.prototype,"aabbHalfX"),Uge.prototype),lye=Y(Uge.prototype,"_aabbHalfX",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(Uge.prototype,"aabbHalfY",[Gve,Hve,Vve],Object.getOwnPropertyDescriptor(Uge.prototype,"aabbHalfY"),Uge.prototype),uye=Y(Uge.prototype,"_aabbHalfY",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(Uge.prototype,"aabbHalfZ",[jve,Wve,qve],Object.getOwnPropertyDescriptor(Uge.prototype,"aabbHalfZ"),Uge.prototype),hye=Y(Uge.prototype,"_aabbHalfZ",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(Uge.prototype,"dataCulling",[Xve,Yve],Object.getOwnPropertyDescriptor(Uge.prototype,"dataCulling"),Uge.prototype),_ye=Y(Uge.prototype,"_dataCulling",[_l,Kve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y(Uge.prototype,"sharedMaterials",[Zl,Qve,Zve,_l,Jve],Object.getOwnPropertyDescriptor(Uge.prototype,"sharedMaterials"),Uge.prototype),fye=Y(Uge.prototype,"_colorOverLifetimeModule",[$ve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"colorOverLifetimeModule",[ege,tge,nge],Object.getOwnPropertyDescriptor(Uge.prototype,"colorOverLifetimeModule"),Uge.prototype),pye=Y(Uge.prototype,"_shapeModule",[ige],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"shapeModule",[rge,oge,age],Object.getOwnPropertyDescriptor(Uge.prototype,"shapeModule"),Uge.prototype),dye=Y(Uge.prototype,"_sizeOvertimeModule",[sge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"sizeOvertimeModule",[cge,lge,uge],Object.getOwnPropertyDescriptor(Uge.prototype,"sizeOvertimeModule"),Uge.prototype),mye=Y(Uge.prototype,"_velocityOvertimeModule",[hge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"velocityOvertimeModule",[_ge,fge,pge],Object.getOwnPropertyDescriptor(Uge.prototype,"velocityOvertimeModule"),Uge.prototype),vye=Y(Uge.prototype,"_forceOvertimeModule",[dge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"forceOvertimeModule",[mge,vge,gge],Object.getOwnPropertyDescriptor(Uge.prototype,"forceOvertimeModule"),Uge.prototype),gye=Y(Uge.prototype,"_limitVelocityOvertimeModule",[yge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"limitVelocityOvertimeModule",[Sge,xge,Tge],Object.getOwnPropertyDescriptor(Uge.prototype,"limitVelocityOvertimeModule"),Uge.prototype),yye=Y(Uge.prototype,"_rotationOvertimeModule",[Ege],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"rotationOvertimeModule",[Cge,bge,Age],Object.getOwnPropertyDescriptor(Uge.prototype,"rotationOvertimeModule"),Uge.prototype),Sye=Y(Uge.prototype,"_textureAnimationModule",[wge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"textureAnimationModule",[Rge,Ige,Pge],Object.getOwnPropertyDescriptor(Uge.prototype,"textureAnimationModule"),Uge.prototype),xye=Y(Uge.prototype,"_trailModule",[Oge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y(Uge.prototype,"trailModule",[Dge,Mge,Nge],Object.getOwnPropertyDescriptor(Uge.prototype,"trailModule"),Uge.prototype),Tye=Y(Uge.prototype,"renderer",[Lge,_l,Bge,Fge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Lye}}),Eye=Y(Uge.prototype,"_prewarm",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cye=Y(Uge.prototype,"_capacity",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),bye=Y(Uge.prototype,"_simulationSpace",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vce.Local}}),zge=Uge))||zge)||zge)||zge)||zge)||zge)),eSe=e("ParticleUtils",function(){function e(){}return e.instantiate=function(e){return this.registeredSceneEvent||($M.on(JM.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new We((function(){return r_(e)||new $b}),1,(function(e){return e.destroy()}))),this.particleSystemPool.get(e._uuid).alloc()},e.destroy=function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))},e.play=function(e){for(var t,n=q(e.getComponentsInChildren($ye));!(t=n()).done;)t.value.play()},e.stop=function(e){for(var t,n=q(e.getComponentsInChildren($ye));!(t=n()).done;)t.value.stop()},e.onSceneUnload=function(){this.particleSystemPool.forEach((function(e){return e.destroy()})),this.particleSystemPool.clear()},e}());function tSe(e){r._global.CC_PHYSICS_BUILTIN="builtin"===e,r._global.CC_PHYSICS_CANNON="cannon.js"===e,r._global.CC_PHYSICS_AMMO="ammo.js"===e}eSe.particleSystemPool=new Map,eSe.registeredSceneEvent=!1,zn(Qfe.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),Fn($ye.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),r.ParticleSystemComponent=$ye,He.setClassAlias($ye,"cc.ParticleSystemComponent"),r.BillboardComponent=Nae,He.setClassAlias(Nae,"cc.BillboardComponent"),r.LineComponent=ece,He.setClassAlias(ece,"cc.LineComponent"),r.ParticleUtils=eSe,function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(Rye||(Rye=e("ERigidBodyType",{}))),Ke(Rye),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(Iye||(Iye=e("EAxisDirection",{}))),Ke(Iye),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(Pye||(Pye={})),Ke(Pye),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}(Oye||(Oye={})),Ke(Oye),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST"}(Dye||(Dye={})),Ke(Dye),function(e){e[e.DEFAULT=1]="DEFAULT"}(Mye||(Mye={})),Ke(Mye);var nSe,iSe={id:"",switchTo:function(e){if(iSe.runInEditor){var t=iSe;if(iSe.physicsWorld&&e!==iSe.id&&null!=iSe.backend[e]?(iSe.physicsWorld.destroy(),console.info("[PHYSICS]: switch from "+iSe.id+" to "+e+"."),tSe(e),t.id=e,t.wrapper=iSe.backend[e],t.physicsWorld=sSe()):(console.info("[PHYSICS]: using "+e+"."),t.physicsWorld=sSe()),Nye){var n=t.physicsWorld;n.setGravity(Nye.gravity),n.setAllowSleep(Nye.allowSleep),n.setDefaultMaterial(Nye.defaultMaterial)}}},register:function(e,t){if(console.info("[PHYSICS]: register "+e+"."),iSe.backend[e]=t,!iSe.physicsWorld||iSe.id===e){tSe(e);var n=iSe;n.id=e,n.wrapper=t}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},rSe=function(){return 0},oSe={impl:null,setGravity:rSe,setAllowSleep:rSe,setDefaultMaterial:rSe,step:rSe,syncAfterEvents:rSe,syncSceneToPhysics:rSe,raycast:rSe,raycastClosest:rSe,emitEvents:rSe,destroy:rSe};function aSe(e,t){return null==e&&(iSe.id?d(iSe.id+" physics does not support "+nSe[t]):w(9600),!0)}function sSe(){return aSe(iSe.wrapper.PhysicsWorld,nSe.World)?oSe:new iSe.wrapper.PhysicsWorld}!function(e){e[e.World=0]="World",e[e.RigidBody=1]="RigidBody",e[e.BoxCollider=2]="BoxCollider",e[e.SphereCollider=3]="SphereCollider",e[e.CapsuleCollider=4]="CapsuleCollider",e[e.MeshCollider=5]="MeshCollider",e[e.CylinderCollider=6]="CylinderCollider",e[e.ConeCollider=7]="ConeCollider",e[e.TerrainCollider=8]="TerrainCollider",e[e.SimplexCollider=9]="SimplexCollider",e[e.PlaneCollider=10]="PlaneCollider",e[e.PointToPointConstraint=11]="PointToPointConstraint",e[e.HingeConstraint=12]="HingeConstraint",e[e.ConeTwistConstraint=13]="ConeTwistConstraint"}(nSe||(nSe={}));var cSe={impl:null,rigidBody:null,isAwake:!1,isSleepy:!1,isSleeping:!1,initialize:rSe,onEnable:rSe,onDisable:rSe,onDestroy:rSe,setType:rSe,setMass:rSe,setLinearDamping:rSe,setAngularDamping:rSe,useGravity:rSe,setLinearFactor:rSe,setAngularFactor:rSe,setAllowSleep:rSe,wakeUp:rSe,sleep:rSe,clearState:rSe,clearForces:rSe,clearVelocity:rSe,setSleepThreshold:rSe,getSleepThreshold:rSe,getLinearVelocity:rSe,setLinearVelocity:rSe,getAngularVelocity:rSe,setAngularVelocity:rSe,applyForce:rSe,applyLocalForce:rSe,applyImpulse:rSe,applyLocalImpulse:rSe,applyTorque:rSe,applyLocalTorque:rSe,setGroup:rSe,getGroup:rSe,addGroup:rSe,removeGroup:rSe,setMask:rSe,getMask:rSe,addMask:rSe,removeMask:rSe,isUsingCCD:rSe,useCCD:rSe},lSe={INITED:!1},uSe={impl:null,collider:null,attachedRigidBody:null,initialize:rSe,onLoad:rSe,onEnable:rSe,onDisable:rSe,onDestroy:rSe,setGroup:rSe,getGroup:rSe,addGroup:rSe,removeGroup:rSe,setMask:rSe,getMask:rSe,addMask:rSe,removeMask:rSe,setMaterial:rSe,setAsTrigger:rSe,setCenter:rSe,getAABB:rSe,getBoundingSphere:rSe,updateSize:rSe,updateRadius:rSe,setRadius:rSe,setCylinderHeight:rSe,setDirection:rSe,setHeight:rSe,setShapeType:rSe,setVertices:rSe,setMesh:rSe,setTerrain:rSe,setNormal:rSe,setConstant:rSe,updateEventListener:rSe};var hSe={INITED:!1},_Se={impl:null,initialize:rSe,onLoad:rSe,onEnable:rSe,onDisable:rSe,onDestroy:rSe,setEnableCollision:rSe,setConnectedBody:rSe,setPivotA:rSe,setPivotB:rSe,setAxis:rSe};function fSe(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}var pSe=new gi,dSe=new gi,mSe=new gi,vSe=new gi,gSe=new gi,ySe=new gi,SSe=new gi,xSe=new gi,TSe=new gi,ESe=new gi,CSe=new gi,bSe=new gi,ASe=new gi(0,0,0),wSe=new gi(0,0,0);function RSe(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,s=void 0===i.capped||i.capped,c=i.arc||2*Math.PI,l=0;s||(e>0&&l++,t>0&&l++);var u=(o+1)*(a+1);s&&(u+=(o+1)*l+o*l);var h=o*a*6;s&&(h+=o*l*3);var _=new Array(h),f=new Array(3*u),p=new Array(3*u),d=new Array(2*u),m=Math.max(e,t),v=new gi(-m,-r,-m),g=new gi(m,r,m),y=Math.sqrt(m*m+r*r),S=0,x=0;return function(){for(var i=[],s=e-t,l=s*s/n*Math.sign(s),u=0;u<=a;u++){for(var h=[],m=u/a,v=m*s+t,g=0;g<=o;++g){var y=g/o,T=y*c,E=Math.sin(T),C=Math.cos(T);f[3*S]=v*E,f[3*S+1]=m*n-r,f[3*S+2]=v*C,gi.normalize(ASe,gi.set(wSe,E,-l,C)),p[3*S]=ASe.x,p[3*S+1]=ASe.y,p[3*S+2]=ASe.z,d[2*S]=2*(1-y)%1,d[2*S+1]=m,h.push(S),++S}i.push(h)}for(var b=0;b<a;++b)for(var A=0;A<o;++A){var w=i[b][A],R=i[b+1][A],I=i[b+1][A+1],P=i[b][A+1];_[x]=w,++x,_[x]=P,++x,_[x]=R,++x,_[x]=P,++x,_[x]=I,++x,_[x]=R,++x}}(),s&&(t>0&&T(!1),e>0&&T(!0)),{positions:f,normals:p,uvs:d,indices:_,minPos:v,maxPos:g,boundingRadius:y};function T(n){for(var i=n?e:t,a=n?1:-1,s=S,l=1;l<=o;++l)f[3*S]=0,f[3*S+1]=r*a,f[3*S+2]=0,p[3*S]=0,p[3*S+1]=a,p[3*S+2]=0,d[2*S]=.5,d[2*S+1]=.5,++S;for(var u=S,h=0;h<=o;++h){var m=h/o*c,v=Math.cos(m),g=Math.sin(m);f[3*S]=i*g,f[3*S+1]=r*a,f[3*S+2]=i*v,p[3*S]=0,p[3*S+1]=a,p[3*S+2]=0,d[2*S]=.5-.5*g*a,d[2*S+1]=.5+.5*v,++S}for(var y=0;y<o;++y){var T=s+y,E=u+y;n?(_[x]=E+1,++x,_[x]=T,++x,_[x]=E,++x):(_[x]=T,++x,_[x]=E+1,++x,_[x]=E,++x)}}}var ISe=new gi(0,0,0),PSe=new gi(0,0,0),OSe=new gi(0,0,0),DSe=new gi(0,0,0),MSe=new gi(0,0,0),NSe=new gi(0,0,0),LSe=new gi(0,0,0),BSe=new gi(0,0,0),FSe=new gi(0,0,0),zSe=Object.freeze({__proto__:null,box:function(e){var t=(e=e||{}).widthSegments||1,n=e.heightSegments||1,i=e.lengthSegments||1,r=(e.width||1)/2,o=(e.height||1)/2,a=(e.length||1)/2,s=[gi.set(gSe,-r,-o,a),gi.set(ySe,r,-o,a),gi.set(SSe,r,o,a),gi.set(xSe,-r,o,a),gi.set(TSe,r,-o,-a),gi.set(ESe,-r,-o,-a),gi.set(CSe,-r,o,-a),gi.set(bSe,r,o,-a)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],h=[],_=[],f=[],p=[],d=[],m=new gi(-r,-o,-a),v=new gi(r,o,a),g=Math.sqrt(r*r+o*o+a*a);function y(e,t,n){var i,r,o,a,m=h.length/3,v=c[e],g=l[e],y=u[e];for(a=0;a<=n;a++)for(o=0;o<=t;o++)if(i=o/t,r=a/n,gi.lerp(pSe,s[v[0]],s[v[1]],i),gi.lerp(dSe,s[v[0]],s[v[2]],r),gi.subtract(mSe,dSe,s[v[0]]),gi.add(vSe,pSe,mSe),h.push(vSe.x,vSe.y,vSe.z),_.push(g[0],g[1],g[2]),f.push(i,r),p.push(y[0],y[1],y[2],y[3]),o<t&&a<n){var S=t+1,x=o+a*S,T=o+(a+1)*S,E=o+1+(a+1)*S,C=o+1+a*S;d.push(m+x,m+C,m+T),d.push(m+T,m+C,m+E)}}return y(0,t,n),y(4,i,n),y(1,t,n),y(5,i,n),y(3,t,i),y(2,t,i),{positions:h,normals:_,uvs:f,tangents:p,indices:d,minPos:m,maxPos:v,boundingRadius:g}},cone:function(e,t,n){return void 0===e&&(e=.5),void 0===t&&(t=1),void 0===n&&(n={}),RSe(0,e,t,n)},cylinder:RSe,plane:function(e){var t=function(e){return(e=fSe(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),n=t.width,i=t.length,r=t.widthSegments,o=t.lengthSegments,a=.5*n,s=.5*i,c=[],l=[],u=[],h=new gi(-a,0,-s),_=new gi(a,0,s),f=Math.sqrt(n*n+i*i);gi.set(MSe,-a,0,s),gi.set(NSe,a,0,s),gi.set(LSe,-a,0,-s);for(var p=0;p<=o;p++)for(var d=0;d<=r;d++){var m=d/r,v=p/o;if(gi.lerp(ISe,MSe,NSe,m),gi.lerp(PSe,MSe,LSe,v),gi.subtract(OSe,PSe,MSe),gi.add(DSe,ISe,OSe),c.push(DSe.x,DSe.y,DSe.z),t.includeUV&&l.push(m,v),d<r&&p<o){var g=r+1,y=d+p*g,S=d+(p+1)*g,x=d+1+(p+1)*g,T=d+1+p*g;u.push(y,T,S),u.push(T,x,S)}}var E={positions:c,indices:u,minPos:h,maxPos:_,boundingRadius:f};if(t.includeNormal){var C=(o+1)*(r+1),b=new Array(3*C);E.normals=b;for(var A=0;A<C;++A)b[3*A+0]=0,b[3*A+1]=1,b[3*A+2]=0}return t.includeUV&&(E.uvs=l),E},quad:function(e){var t=fSe(e),n={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(n.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(n.uvs=[0,0,0,1,1,1,1,0]),n},sphere:function(e,t){void 0===e&&(e=.5),void 0===t&&(t={});for(var n=void 0!==t.segments?t.segments:32,i=[],r=[],o=[],a=[],s=new gi(-e,-e,-e),c=new gi(e,e,e),l=e,u=0;u<=n;++u)for(var h=u*Math.PI/n,_=Math.sin(h),f=-Math.cos(h),p=0;p<=n;++p){var d=2*p*Math.PI/n-Math.PI/2,m=Math.sin(d)*_,v=f,g=Math.cos(d)*_,y=p/n,S=u/n;if(i.push(m*e,v*e,g*e),r.push(m,v,g),o.push(y,S),u<n&&p<n){var x=n+1,T=x*u+p,E=x*(u+1)+p,C=x*(u+1)+p+1,b=x*u+p+1;a.push(T,b,E),a.push(b,C,E)}}return{positions:i,indices:a,normals:r,uvs:o,minPos:s,maxPos:c,boundingRadius:l}},torus:function(e,t,n){void 0===e&&(e=.4),void 0===t&&(t=.1),void 0===n&&(n={});for(var i=n.radialSegments||32,r=n.tubularSegments||32,o=n.arc||2*Math.PI,a=[],s=[],c=[],l=[],u=new gi(-e-t,-t,-e-t),h=new gi(e+t,t,e+t),_=e+t,f=0;f<=i;f++)for(var p=0;p<=r;p++){var d=p/r,m=f/i,v=d*o,g=m*Math.PI*2,y=(e+t*Math.cos(g))*Math.sin(v),S=t*Math.sin(g),x=(e+t*Math.cos(g))*Math.cos(v),T=Math.sin(v)*Math.cos(g),E=Math.sin(g),C=Math.cos(v)*Math.cos(g);if(a.push(y,S,x),s.push(T,E,C),c.push(d,m),p<r&&f<i){var b=r+1,A=b*f+p,w=b*(f+1)+p,R=b*(f+1)+p+1,I=b*f+p+1;l.push(A,I,w),l.push(I,R,w)}}return{positions:a,normals:s,uvs:c,indices:l,minPos:u,maxPos:h,boundingRadius:_}},capsule:function(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=n-e-t,o=i.sides||32,a=i.heightSegments||32,s=t/n,c=r/n,l=e/n,u=Math.floor(a*s),h=Math.floor(a*l),_=Math.floor(a*c),f=r+t-n/2,p=t-n/2,d=t-n/2,m=i.arc||2*Math.PI,v=[],g=[],y=[],S=[],x=Math.max(e,t),T=new gi(-x,-n/2,-x),E=new gi(x,n/2,x),C=n/2,b=0,A=[];return function(){for(var e=0;e<=u;++e)for(var n=e*Math.PI/u/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,h=r,_=Math.cos(c)*i,f=s/o,p=e/a;if(v.push(l*t,h*t+d,_*t),g.push(l,h,_),y.push(f,p),e<u&&s<o){var m=o+1,x=m*e+s,T=m*(e+1)+s,E=m*(e+1)+s+1,C=m*e+s+1;S.push(x,C,T),S.push(C,E,T)}++b}}(),function(){for(var n=(e-t)/r,i=0;i<=_;i++){for(var a=[],l=i/_,u=l*(e-t)+t,h=0;h<=o;++h){var f=h/o,d=l*c+s,x=f*m-m/4,T=Math.sin(x),E=Math.cos(x);v.push(u*T),v.push(l*r+p),v.push(u*E),gi.normalize(BSe,gi.set(FSe,T,-n,E)),g.push(BSe.x),g.push(BSe.y),g.push(BSe.z),y.push(f,d),a.push(b),++b}A.push(a)}for(var C=0;C<_;++C)for(var w=0;w<o;++w){var R=A[C][w],I=A[C+1][w],P=A[C+1][w+1],O=A[C][w+1];S.push(R),S.push(O),S.push(I),S.push(O),S.push(P),S.push(I)}}(),function(){for(var t=0;t<=h;++t)for(var n=t*Math.PI/h/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,u=Math.sin(c)*i,p=r,d=Math.cos(c)*i,m=s/o,x=t/a+(1-l);if(v.push(u*e,p*e+f,d*e),g.push(u,p,d),y.push(m,x),t<h&&s<o){var T=o+1,E=T*t+s+A[_][o]+1,C=T*(t+1)+s+A[_][o]+1,b=T*(t+1)+s+1+A[_][o]+1,w=T*t+s+1+A[_][o]+1;S.push(E,w,C),S.push(w,b,C)}}}(),{positions:v,normals:g,uvs:y,indices:S,minPos:T,maxPos:E,boundingRadius:C}},circle:function(e){var t=function(e){return(e=fSe(e)).segments=64,e}(e).segments,n=new Array(3*(t+1));n[0]=0,n[1]=0,n[2]=0;var i=new Array(1+2*t);i[0]=0;for(var r=2*Math.PI/t,o=0;o<t;++o){var a=r*o,s=Math.cos(a),c=Math.sin(a),l=3*(o+1);n[l+0]=s,n[l+1]=c,n[l+2]=0;var u=2*o;i[1+u]=o+1,i[1+(u+1)]=o+2}return t>0&&(i[i.length-1]=1),{positions:n,indices:i,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Kr.TRIANGLE_FAN}},translate:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]+=n,e.positions[c]+=i,e.positions[l]+=r}return e.minPos&&(e.minPos.x+=n,e.minPos.y+=i,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=n,e.maxPos.y+=i,e.maxPos.z+=r),e},scale:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]*=n,e.positions[c]*=i,e.positions[l]*=r}return e.minPos&&(e.minPos.x*=n,e.minPos.y*=i,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=n,e.maxPos.y*=i,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(n,i),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Kr.TRIANGLE_LIST)return e;for(var n=[[0,1],[1,2],[2,0]],i=[],r={},o=0;o<t.length;o+=3)for(var a=0;a<3;++a){var s=t[o+n[a][0]],c=t[o+n[a][1]],l=s>c?c<<16|s:s<<16|c;void 0===r[l]&&(r[l]=0,i.push(s,c))}return e.indices=i,e.primitiveMode=Kr.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],n=[],i={},r=0;r<e.length;r+=3)for(var o=0;o<3;++o){var a=e[r+t[o][0]],s=e[r+t[o][1]],c=a>s?s<<16|a:a<<16|s;void 0===i[c]&&(i[c]=0,n.push(a,s))}return n},invWinding:function(e){for(var t=[],n=0;n<e.length;n+=3)t.push(e[n],e[n+2],e[n+1]);return t},toWavefrontOBJ:function(e,t){if(void 0===t&&(t=1),!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Kr.TRIANGLE_LIST)return"";for(var n=e.positions,i=e.uvs,r=e.normals,o=e.indices,a=function(e){return o[e]+1+"/"+(o[e]+1)+"/"+(o[e]+1)},s="",c=0;c<n.length;c+=3)s+="v "+n[c]*t+" "+n[c+1]*t+" "+n[c+2]*t+"\n";for(var l=0;l<i.length;l+=2)s+="vt "+i[l]+" "+i[l+1]+"\n";for(var u=0;u<r.length;u+=3)s+="vn "+r[u]+" "+r[u+1]+" "+r[u+2]+"\n";for(var h=0;h<o.length;h+=3)s+="f "+a(h)+" "+a(h+1)+" "+a(h+2)+"\n";return s},normals:function(e,t,n){void 0===n&&(n=1);for(var i=new Array(2*e.length),r=0;r<e.length/3;++r){var o=3*r,a=6*r;i[a+0]=e[o+0],i[a+1]=e[o+1],i[a+2]=e[o+2],i[a+3]=e[o+0]+t[o+0]*n,i[a+4]=e[o+1]+t[o+1]*n,i[a+5]=e[o+2]+t[o+2]*n}return i},applyDefaultGeometryOptions:fSe});e("primitives",zSe);var USe=new gi,kSe={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},GSe={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null};function HSe(e){var t=[];if(e.length>=3){t[0]=e[0],t[1]=e[1],t[2]=e[2];for(var n=e.length,i=3;i<n;i+=3){for(var r=e[i],o=e[i+1],a=e[i+2],s=t.length,c=!0,l=0;l<s;l+=3)if(Kn(r,t[l])&&Kn(o,t[l+1])&&Kn(a,t[l+2])){c=!1;break}c&&(t.push(r),t.push(o),t.push(a))}}return t}function VSe(e){return e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e}var jSe,WSe,qSe,XSe,YSe,KSe,QSe,ZSe,JSe=Object.freeze({__proto__:null,setWrap:function(e,t){e.__cc_wrapper__=t},getWrap:function(e){return e.__cc_wrapper__},maxComponent:function(e){return Math.max(e.x,Math.max(e.y,e.z))},VEC3_0:USe,TriggerEventObject:kSe,CollisionEventObject:GSe,shrinkPositions:HSe,absolute:VSe,cylinder:RSe}),$Se=function(t){return e({PhysicsMaterial:t,PhysicMaterial:t}),t}(al("cc.PhysicsMaterial")((ZSe=QSe=function(e){function t(){var n;return(n=e.call(this)||this).id=void 0,X(n,"_friction",qSe,j(n)),X(n,"_rollingFriction",XSe,j(n)),X(n,"_spinningFriction",YSe,j(n)),X(n,"_restitution",KSe,j(n)),t.allMaterials.push(j(n)),n.id=t._idCounter++,n._uuid||(n._uuid="pm_"+n.id),n}z(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e._rollingFriction=this._rollingFriction,e._spinningFriction=this._spinningFriction,e},n.destroy=function(){if(e.prototype.destroy.call(this)){var n=t.allMaterials.indexOf(this);return n>=0&&t.allMaterials.splice(n,1),!0}return!1},n.setValues=function(e,n,i,r){var o=this._friction!==e||this._rollingFriction!==n||this._spinningFriction!==i||this._restitution!==r;this._friction=e,this._rollingFriction=n,this._spinningFriction=i,this._restitution=r,o&&this.emit(t.EVENT_UPDATE)},B(t,[{key:"friction",get:function(){return this._friction},set:function(e){Kn(this._friction,e)||(this._friction=e,this.emit(t.EVENT_UPDATE))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){Kn(this._rollingFriction,e)||(this._rollingFriction=e,this.emit(t.EVENT_UPDATE))}},{key:"spinningFriction",get:function(){return this._spinningFriction},set:function(e){Kn(this._spinningFriction,e)||(this._spinningFriction=e,this.emit(t.EVENT_UPDATE))}},{key:"restitution",get:function(){return this._restitution},set:function(e){Kn(this._restitution,e)||(this._restitution=e,this.emit(t.EVENT_UPDATE))}}]),t}(Fu),QSe.allMaterials=[],QSe.EVENT_UPDATE="event_update",QSe._idCounter=0,Y((WSe=ZSe).prototype,"friction",[El],Object.getOwnPropertyDescriptor(WSe.prototype,"friction"),WSe.prototype),Y(WSe.prototype,"rollingFriction",[El],Object.getOwnPropertyDescriptor(WSe.prototype,"rollingFriction"),WSe.prototype),Y(WSe.prototype,"spinningFriction",[El],Object.getOwnPropertyDescriptor(WSe.prototype,"spinningFriction"),WSe.prototype),Y(WSe.prototype,"restitution",[El],Object.getOwnPropertyDescriptor(WSe.prototype,"restitution"),WSe.prototype),qSe=Y(WSe.prototype,"_friction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.6}}),XSe=Y(WSe.prototype,"_rollingFriction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YSe=Y(WSe.prototype,"_spinningFriction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KSe=Y(WSe.prototype,"_restitution",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jSe=WSe))||jSe),exe=e("PhysicsRayResult",function(){function e(){this._hitPoint=new gi,this._hitNormal=new gi,this._distance=0,this._collider=null}var t=e.prototype;return t._assign=function(e,t,n,i){gi.copy(this._hitPoint,e),gi.copy(this._hitNormal,i),this._distance=t,this._collider=n},t.clone=function(){var t=new e;return gi.copy(t._hitPoint,this._hitPoint),gi.copy(t._hitNormal,this._hitNormal),t._distance=this._distance,t._collider=this._collider,t},B(e,[{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),e}()),txe=function(e){if(1===e){for(var t=this,n=function(e){var n="_"+(1<<e);t[n]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})},i=0;i<32;i++)n(i);this._1=Mye.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=Mye.DEFAULT}};r.internal.PhysicsGroup=Mye;var nxe,ixe,rxe,oxe,axe,sxe,cxe,lxe,uxe,hxe,_xe,fxe,pxe,dxe,mxe,vxe,gxe,yxe,Sxe,xxe,Txe,Exe,Cxe,bxe,Axe,wxe,Rxe,Ixe,Pxe,Oxe,Dxe,Mxe,Nxe,Lxe,Bxe,Fxe,zxe,Uxe,kxe,Gxe,Hxe,Vxe,jxe,Wxe,qxe=e("PhysicsSystem",function(e){function t(){var t;return(t=e.call(this)||this).raycastClosestResult=new exe,t.raycastResults=[],t.collisionMatrix=new txe(1),t.minVolumeSize=1e-5,t.useNodeChains=!1,t._enable=!0,t._allowSleep=!0,t._maxSubSteps=1,t._subStepCount=0,t._fixedTimeStep=1/60,t._autoSimulation=!0,t._accumulator=0,t._sleepThreshold=.1,t._gravity=new gi(0,-10,0),t._material=new $Se,t.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},t.raycastResultPool=new qe((function(){return new exe}),1),t._material.on($Se.EVENT_UPDATE,t._updateMaterial,j(t)),t}z(t,e);var n=t.prototype;return n.postUpdate=function(e){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=e,$M.emit(JM.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}$M.emit(JM.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()},n.resetConfiguration=function(e){var t=e||(ZM.config?ZM.config.physics:null);if(t){if("boolean"==typeof t.allowSleep&&(this._allowSleep=t.allowSleep),"number"==typeof t.fixedTimeStep&&(this._fixedTimeStep=t.fixedTimeStep),"number"==typeof t.maxSubSteps&&(this._maxSubSteps=t.maxSubSteps),"number"==typeof t.sleepThreshold&&(this._sleepThreshold=t.sleepThreshold),"boolean"==typeof t.autoSimulation&&(this.autoSimulation=t.autoSimulation),t.gravity&&gi.copy(this._gravity,t.gravity),t.defaultMaterial&&this._material.setValues(t.defaultMaterial.friction,t.defaultMaterial.rollingFriction,t.defaultMaterial.spinningFriction,t.defaultMaterial.restitution),t.collisionMatrix)for(var n in t.collisionMatrix)this.collisionMatrix[""+(1<<parseInt(n))]=t.collisionMatrix[n];if(t.collisionGroups){var i=t.collisionGroups;i instanceof Array&&(i.forEach((function(e){Mye[e.name]=1<<e.index})),Ke.update(Mye))}}this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep),this.physicsWorld.setDefaultMaterial(this._material))},n.resetAccumulator=function(e){void 0===e&&(e=0),this._accumulator=e},n.step=function(e,t,n){this.physicsWorld&&this.physicsWorld.step(e,t,n)},n.syncSceneToPhysics=function(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()},n.emitEvents=function(){this.physicsWorld&&this.physicsWorld.emitEvents()},n.raycast=function(e,t,n,i){return void 0===t&&(t=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults))},n.raycastClosest=function(e,t,n,i){return void 0===t&&(t=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycastClosest(e,this.raycastOptions,this.raycastClosestResult))},n._updateMaterial=function(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)},t.constructAndRegister=function(){if(!t._instance){var e=new t;e.resetConfiguration(),function(e){if(Nye||(Nye=e),iSe.runInEditor&&!iSe.physicsWorld){console.info("[PHYSICS]: using "+iSe.id+".");var t=iSe.physicsWorld=sSe();t.setGravity(Nye.gravity),t.setAllowSleep(Nye.allowSleep),t.setDefaultMaterial(Nye.defaultMaterial)}}(e),t._instance=e,$M.registerSystem(t.ID,e,e.priority)}},B(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld&&this.physicsWorld.setAllowSleep(e)}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld&&this.physicsWorld.setGravity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"defaultMaterial",get:function(){return this._material}},{key:"physicsWorld",get:function(){return iSe.physicsWorld}}],[{key:"PHYSICS_NONE",get:function(){return!iSe.id}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===iSe.id}},{key:"PHYSICS_CANNON",get:function(){return"cannon.js"===iSe.id}},{key:"PHYSICS_BULLET",get:function(){return"bullet"===iSe.id}},{key:"PHYSICS_PHYSX",get:function(){return"physx"===iSe.id}},{key:"PhysicsGroup",get:function(){return Mye}},{key:"instance",get:function(){return t._instance}}]),t}(UM));qxe.ID="PHYSICS",qxe._instance=null,$M.once(JM.EVENT_INIT,(function(){qxe.constructAndRegister()}));var Xxe,Yxe,Kxe,Qxe,Zxe,Jxe,$xe,eTe,tTe,nTe,iTe,rTe,oTe,aTe,sTe,cTe,lTe,uTe,hTe,_Te,fTe,pTe,dTe=function(t){return e({RigidBody:t,RigidBodyComponent:t}),t}((nxe=al("cc.RigidBody"),ixe=Tl(),rxe=gl(),oxe=cl(-1),axe=Gl(qxe.PhysicsGroup),sxe=Ml(),cxe=wl(),lxe=Gl(Rye),uxe=Ml(),hxe=wl(),_xe=Cl(),fxe=Ml(),pxe=wl(),dxe=Cl(),mxe=Ml(),vxe=wl(),gxe=Cl(),yxe=Ml(),Sxe=wl(),xxe=Cl(),Txe=Ml(),Exe=wl(),Cxe=Cl(),bxe=Ml(),Axe=wl(),wxe=Cl(),Rxe=Ml(),Ixe=wl(),Pxe=Cl(),Oxe=Ml(),Dxe=wl(),nxe(Mxe=ixe(Mxe=rxe(Mxe=vl(Mxe=ll(Mxe=oxe((Wxe=jxe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._body=null,X(t,"_group",Lxe,j(t)),X(t,"_type",Bxe,j(t)),X(t,"_mass",Fxe,j(t)),X(t,"_allowSleep",zxe,j(t)),X(t,"_linearDamping",Uxe,j(t)),X(t,"_angularDamping",kxe,j(t)),X(t,"_useGravity",Gxe,j(t)),X(t,"_linearFactor",Hxe,j(t)),X(t,"_angularFactor",Vxe,j(t)),t}z(t,e);var n=t.prototype;return n.onLoad=function(){iSe.runInEditor&&(this._body=aSe(iSe.wrapper.RigidBody,nSe.RigidBody)?cSe:new iSe.wrapper.RigidBody,this._body.initialize(this))},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},n.applyForce=function(e,t){this._isInitialized&&this._body.applyForce(e,t)},n.applyLocalForce=function(e,t){this._isInitialized&&this._body.applyLocalForce(e,t)},n.applyImpulse=function(e,t){this._isInitialized&&this._body.applyImpulse(e,t)},n.applyLocalImpulse=function(e,t){this._isInitialized&&this._body.applyLocalImpulse(e,t)},n.applyTorque=function(e){this._isInitialized&&this._body.applyTorque(e)},n.applyLocalTorque=function(e){this._isInitialized&&this._body.applyLocalTorque(e)},n.wakeUp=function(){this._isInitialized&&this._body.wakeUp()},n.sleep=function(){this._isInitialized&&this._body.sleep()},n.clearState=function(){this._isInitialized&&this._body.clearState()},n.clearForces=function(){this._isInitialized&&this._body.clearForces()},n.clearVelocity=function(){this._isInitialized&&this._body.clearVelocity()},n.getLinearVelocity=function(e){this._isInitialized&&this._body.getLinearVelocity(e)},n.setLinearVelocity=function(e){this._isInitialized&&this._body.setLinearVelocity(e)},n.getAngularVelocity=function(e){this._isInitialized&&this._body.getAngularVelocity(e)},n.setAngularVelocity=function(e){this._isInitialized&&this._body.setAngularVelocity(e)},n.getGroup=function(){return this._isInitialized?this._body.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._body.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._body.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._body.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._body.getMask():0},n.setMask=function(e){this._isInitialized&&this._body.setMask(e)},n.addMask=function(e){this._isInitialized&&this._body.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._body.removeMask(e)},B(t,[{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._body&&this._body.getGroup()!==e&&this._body.setGroup(e)}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._body&&this._body.setType(e))}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass!==e&&(e=e<=0?1e-4:e,this._mass=e,this._body&&this._body.setMass(e))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body&&this._body.useGravity(e)}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){gi.copy(this._linearFactor,e),this._body&&this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){gi.copy(this._angularFactor,e),this._body&&this._body.setAngularFactor(this._angularFactor)}},{key:"sleepThreshold",get:function(){return this._isInitialized?this._body.getSleepThreshold():.1},set:function(e){this._isInitialized&&this._body.setSleepThreshold(e)}},{key:"useCCD",get:function(){return!!this._isInitialized&&this._body.isUsingCCD()},set:function(e){this._isInitialized&&this._body.useCCD(e)}},{key:"isAwake",get:function(){return!!this._isInitialized&&this._body.isAwake}},{key:"isSleepy",get:function(){return!!this._isInitialized&&this._body.isSleepy}},{key:"isSleeping",get:function(){return!!this._isInitialized&&this._body.isSleeping}},{key:"isStatic",get:function(){return this._type===Rye.STATIC},set:function(e){e&&this.isStatic||!e&&!this.isStatic||(this.type=e?Rye.STATIC:Rye.DYNAMIC)}},{key:"isDynamic",get:function(){return this._type===Rye.DYNAMIC},set:function(e){e&&this.isDynamic||!e&&!this.isDynamic||(this.type=e?Rye.DYNAMIC:Rye.KINEMATIC)}},{key:"isKinematic",get:function(){return this._type===Rye.KINEMATIC},set:function(e){e&&this.isKinematic||!e&&!this.isKinematic||(this.type=e?Rye.KINEMATIC:Rye.DYNAMIC)}},{key:"body",get:function(){return this._body}},{key:"_isInitialized",get:function(){var e=null===this._body;return e&&m("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),t}(rh),jxe.Type=Rye,Y((Nxe=Wxe).prototype,"group",[axe,sxe,cxe],Object.getOwnPropertyDescriptor(Nxe.prototype,"group"),Nxe.prototype),Y(Nxe.prototype,"type",[lxe,uxe,hxe],Object.getOwnPropertyDescriptor(Nxe.prototype,"type"),Nxe.prototype),Y(Nxe.prototype,"mass",[_xe,fxe,pxe],Object.getOwnPropertyDescriptor(Nxe.prototype,"mass"),Nxe.prototype),Y(Nxe.prototype,"allowSleep",[dxe,mxe,vxe],Object.getOwnPropertyDescriptor(Nxe.prototype,"allowSleep"),Nxe.prototype),Y(Nxe.prototype,"linearDamping",[gxe,yxe,Sxe],Object.getOwnPropertyDescriptor(Nxe.prototype,"linearDamping"),Nxe.prototype),Y(Nxe.prototype,"angularDamping",[xxe,Txe,Exe],Object.getOwnPropertyDescriptor(Nxe.prototype,"angularDamping"),Nxe.prototype),Y(Nxe.prototype,"useGravity",[Cxe,bxe,Axe],Object.getOwnPropertyDescriptor(Nxe.prototype,"useGravity"),Nxe.prototype),Y(Nxe.prototype,"linearFactor",[wxe,Rxe,Ixe],Object.getOwnPropertyDescriptor(Nxe.prototype,"linearFactor"),Nxe.prototype),Y(Nxe.prototype,"angularFactor",[Pxe,Oxe,Dxe],Object.getOwnPropertyDescriptor(Nxe.prototype,"angularFactor"),Nxe.prototype),Lxe=Y(Nxe.prototype,"_group",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qxe.PhysicsGroup.DEFAULT}}),Bxe=Y(Nxe.prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rye.DYNAMIC}}),Fxe=Y(Nxe.prototype,"_mass",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zxe=Y(Nxe.prototype,"_allowSleep",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Uxe=Y(Nxe.prototype,"_linearDamping",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),kxe=Y(Nxe.prototype,"_angularDamping",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Gxe=Y(Nxe.prototype,"_useGravity",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hxe=Y(Nxe.prototype,"_linearFactor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(1,1,1)}}),Vxe=Y(Nxe.prototype,"_angularFactor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(1,1,1)}}),Mxe=Nxe))||Mxe)||Mxe)||Mxe)||Mxe)||Mxe)||Mxe));dTe||(dTe=function(t){return e({RigidBody:t,RigidBodyComponent:t}),t}({}));var mTe,vTe,gTe,yTe,STe,xTe,TTe,ETe,CTe=function(t){return e({Collider:t,ColliderComponent:t}),t}((Xxe=al("cc.Collider"),Yxe=Gl(dTe),Kxe=Al(),Qxe=Ml(),Zxe=wl(),Jxe=Gl($Se),$xe=Al(),eTe=Ml(),tTe=wl(),nTe=Ml(),iTe=wl(),rTe=Gl(gi),oTe=Ml(),aTe=wl(),sTe=Gl($Se),Xxe((pTe=fTe=function(e){function t(t){var n;return(n=e.call(this)||this).type=void 0,n._shape=null,n._aabb=null,n._boundingSphere=null,n._isSharedMaterial=!0,n._needTriggerEvent=!1,n._needCollisionEvent=!1,X(n,"_material",uTe,j(n)),X(n,"_isTrigger",hTe,j(n)),X(n,"_center",_Te,j(n)),n.type=t,n}z(t,e);var n=t.prototype;return n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return this._updateNeedEvent(t),o},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),this._updateNeedEvent()},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return this._updateNeedEvent(t),r},n.removeAll=function(t){e.prototype.removeAll.call(this,t),this._updateNeedEvent()},n.getGroup=function(){return this._isInitialized?this._shape.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._shape.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._shape.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._shape.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._shape.getMask():0},n.setMask=function(e){this._isInitialized&&this._shape.setMask(e)},n.addMask=function(e){this._isInitialized&&this._shape.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._shape.removeMask(e)},n.onLoad=function(){iSe.runInEditor&&(this.sharedMaterial=null==this._material?qxe.instance.defaultMaterial:this._material,this._shape=function(e){return lSe.INITED||(lSe.INITED=!0,lSe[Oye.BOX]=function(){return aSe(iSe.wrapper.BoxShape,nSe.BoxCollider)?uSe:new iSe.wrapper.BoxShape},lSe[Oye.SPHERE]=function(){return aSe(iSe.wrapper.SphereShape,nSe.SphereCollider)?uSe:new iSe.wrapper.SphereShape},lSe[Oye.CAPSULE]=function(){return aSe(iSe.wrapper.CapsuleShape,nSe.CapsuleCollider)?uSe:new iSe.wrapper.CapsuleShape},lSe[Oye.CYLINDER]=function(){return aSe(iSe.wrapper.CylinderShape,nSe.CylinderCollider)?uSe:new iSe.wrapper.CylinderShape},lSe[Oye.CONE]=function(){return aSe(iSe.wrapper.ConeShape,nSe.ConeCollider)?uSe:new iSe.wrapper.ConeShape},lSe[Oye.MESH]=function(){return aSe(iSe.wrapper.TrimeshShape,nSe.MeshCollider)?uSe:new iSe.wrapper.TrimeshShape},lSe[Oye.TERRAIN]=function(){return aSe(iSe.wrapper.TerrainShape,nSe.TerrainCollider)?uSe:new iSe.wrapper.TerrainShape},lSe[Oye.SIMPLEX]=function(){return aSe(iSe.wrapper.SimplexShape,nSe.SimplexCollider)?uSe:new iSe.wrapper.SimplexShape},lSe[Oye.PLANE]=function(){return aSe(iSe.wrapper.PlaneShape,nSe.PlaneCollider)?uSe:new iSe.wrapper.PlaneShape}),lSe[e]()}(this.type),this._shape.initialize(this),this._shape.onLoad())},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&(this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._shape.updateEventListener(),this._material&&this._material.off($Se.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()},n._updateMaterial=function(){this._shape&&this._shape.setMaterial(this._material)},n._updateNeedEvent=function(e){this.isValid&&(void 0!==e?("onCollisionEnter"!==e&&"onCollisionStay"!==e&&"onCollisionExit"!==e||(this._needCollisionEvent=!0),"onTriggerEnter"!==e&&"onTriggerStay"!==e&&"onTriggerExit"!==e||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())},B(t,[{key:"attachedRigidBody",get:function(){return e=this.node,(t=e.getComponent(dTe))&&t.isValid?t:null;var e,t}},{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&this._material&&(this._material.off($Se.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on($Se.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){this._shape?(e&&this._material?this._material.id!==e.id&&(this._material.off($Se.EVENT_UPDATE,this._updateMaterial,this),e.on($Se.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):e&&!this._material?(e.on($Se.EVENT_UPDATE,this._updateMaterial,this),this._material=e):!e&&this._material&&(this._material.off($Se.EVENT_UPDATE,this._updateMaterial,this),this._material=e),this._updateMaterial()):this._material=e}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._shape&&this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(e){gi.copy(this._center,e),this._shape&&this._shape.setCenter(this._center)}},{key:"shape",get:function(){return this._shape}},{key:"worldBounds",get:function(){return null==this._aabb&&(this._aabb=new Fc),this._shape&&this._shape.getAABB(this._aabb),this._aabb}},{key:"boundingSphere",get:function(){return null==this._boundingSphere&&(this._boundingSphere=new ao),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}},{key:"needTriggerEvent",get:function(){return this._needTriggerEvent}},{key:"needCollisionEvent",get:function(){return this._needCollisionEvent}},{key:"_isInitialized",get:function(){var e=null===this._shape;return e&&m("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),t}(an(rh)),fTe.Type=Oye,fTe.Axis=Iye,Y((lTe=pTe).prototype,"attachedRigidBody",[Yxe,bl,Kxe,Qxe,Zxe],Object.getOwnPropertyDescriptor(lTe.prototype,"attachedRigidBody"),lTe.prototype),Y(lTe.prototype,"sharedMaterial",[Jxe,$xe,eTe,tTe],Object.getOwnPropertyDescriptor(lTe.prototype,"sharedMaterial"),lTe.prototype),Y(lTe.prototype,"isTrigger",[nTe,iTe],Object.getOwnPropertyDescriptor(lTe.prototype,"isTrigger"),lTe.prototype),Y(lTe.prototype,"center",[rTe,oTe,aTe],Object.getOwnPropertyDescriptor(lTe.prototype,"center"),lTe.prototype),uTe=Y(lTe.prototype,"_material",[sTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hTe=Y(lTe.prototype,"_isTrigger",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_Te=Y(lTe.prototype,"_center",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),cTe=lTe))||cTe));CTe||(CTe=function(t){return e({Collider:t,ColliderComponent:t}),t}({}));var bTe,ATe,wTe,RTe,ITe,PTe,OTe,DTe,MTe,NTe,LTe,BTe,FTe,zTe,UTe,kTe,GTe,HTe,VTe,jTe,WTe,qTe,XTe,YTe,KTe,QTe,ZTe,JTe,$Te,eEe,tEe,nEe,iEe,rEe,oEe,aEe,sEe,cEe,lEe,uEe,hEe,_Ee,fEe,pEe,dEe,mEe,vEe,gEe,yEe,SEe,xEe,TEe,EEe,CEe,bEe,AEe,wEe,REe,IEe,PEe,OEe,DEe,MEe,NEe,LEe,BEe,FEe,zEe,UEe,kEe,GEe,HEe,VEe,jEe,WEe,qEe,XEe,YEe,KEe,QEe,ZEe,JEe,$Ee,eCe,tCe,nCe,iCe,rCe,oCe,aCe,sCe,cCe,lCe,uCe,hCe,_Ce,fCe,pCe,dCe,mCe,vCe,gCe,yCe,SCe,xCe,TCe,ECe,CCe,bCe,ACe,wCe,RCe,ICe,PCe,OCe,DCe,MCe,NCe,LCe,BCe,FCe=function(t){return e({BoxCollider:t,BoxColliderComponent:t}),t}((mTe=al("cc.BoxCollider"),vTe=Tl(),gTe=gl(),yTe=Gl(gi),STe=wl(),mTe(xTe=vTe(xTe=gTe(xTe=vl((Y((TTe=function(e){function t(){var t;return X(t=e.call(this,Oye.BOX)||this,"_size",ETe,j(t)),t}return z(t,e),B(t,[{key:"size",get:function(){return this._size},set:function(e){gi.strictEquals(this._size,e)||(gi.copy(this._size,e),VSe(this._size),this._shape&&this.shape.updateSize())}},{key:"shape",get:function(){return this._shape}}]),t}(CTe)).prototype,"size",[yTe,STe],Object.getOwnPropertyDescriptor(TTe.prototype,"size"),TTe.prototype),ETe=Y(TTe.prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(1,1,1)}}),xTe=TTe))||xTe)||xTe)||xTe)||xTe)),zCe=function(t){return e({SphereCollider:t,SphereColliderComponent:t}),t}((bTe=al("cc.SphereCollider"),ATe=Tl(),wTe=gl(),RTe=wl(),bTe(ITe=ATe(ITe=wTe(ITe=vl((Y((PTe=function(e){function t(){var t;return X(t=e.call(this,Oye.SPHERE)||this,"_radius",OTe,j(t)),t}return z(t,e),B(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.updateRadius())}},{key:"shape",get:function(){return this._shape}}]),t}(CTe)).prototype,"radius",[RTe],Object.getOwnPropertyDescriptor(PTe.prototype,"radius"),PTe.prototype),OTe=Y(PTe.prototype,"_radius",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),ITe=PTe))||ITe)||ITe)||ITe)||ITe)),UCe=function(t){return e({CapsuleCollider:t,CapsuleColliderComponent:t}),t}((DTe=al("cc.CapsuleCollider"),MTe=Tl(),NTe=gl(),LTe=wl(),BTe=wl(),FTe=Gl(Iye),zTe=wl(),DTe(UTe=MTe(UTe=NTe(UTe=vl((Y((kTe=function(e){function t(){var t;return X(t=e.call(this,Oye.CAPSULE)||this,"_radius",GTe,j(t)),X(t,"_cylinderHeight",HTe,j(t)),X(t,"_direction",VTe,j(t)),t}z(t,e);var n=t.prototype;return n._getRadiusScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===Iye.Y_AXIS?Math.abs(fi(e.x,e.z)):this._direction===Iye.X_AXIS?Math.abs(fi(e.y,e.z)):Math.abs(fi(e.x,e.y))},n._getHeightScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===Iye.Y_AXIS?Math.abs(e.y):this._direction===Iye.X_AXIS?Math.abs(e.x):Math.abs(e.z)},B(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(e){this._cylinderHeight!==e&&(this._cylinderHeight=Math.abs(e),this._shape&&this.shape.setCylinderHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){(e=Math.floor(e))<Iye.X_AXIS||e>Iye.Z_AXIS||this._direction!==e&&(this._direction=e,this._shape&&this.shape.setDirection(e))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(e){var t=e-2*this._radius;t<0&&(t=0),this.cylinderHeight=t}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),t}(CTe)).prototype,"radius",[LTe],Object.getOwnPropertyDescriptor(kTe.prototype,"radius"),kTe.prototype),Y(kTe.prototype,"cylinderHeight",[BTe],Object.getOwnPropertyDescriptor(kTe.prototype,"cylinderHeight"),kTe.prototype),Y(kTe.prototype,"direction",[FTe,zTe],Object.getOwnPropertyDescriptor(kTe.prototype,"direction"),kTe.prototype),GTe=Y(kTe.prototype,"_radius",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),HTe=Y(kTe.prototype,"_cylinderHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),VTe=Y(kTe.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Iye.Y_AXIS}}),UTe=kTe))||UTe)||UTe)||UTe)||UTe)),kCe=function(t){return e({CylinderCollider:t,CylinderColliderComponent:t}),t}((jTe=al("cc.CylinderCollider"),WTe=Tl(),qTe=gl(),XTe=wl(),YTe=wl(),KTe=Gl(Iye),QTe=wl(),jTe(ZTe=WTe(ZTe=qTe(ZTe=vl((Y((JTe=function(e){function t(){var t;return X(t=e.call(this,Oye.CYLINDER)||this,"_radius",$Te,j(t)),X(t,"_height",eEe,j(t)),X(t,"_direction",tEe,j(t)),t}return z(t,e),B(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=Math.abs(e),this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(e<Iye.X_AXIS||e>Iye.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(CTe)).prototype,"radius",[XTe],Object.getOwnPropertyDescriptor(JTe.prototype,"radius"),JTe.prototype),Y(JTe.prototype,"height",[YTe],Object.getOwnPropertyDescriptor(JTe.prototype,"height"),JTe.prototype),Y(JTe.prototype,"direction",[KTe,QTe],Object.getOwnPropertyDescriptor(JTe.prototype,"direction"),JTe.prototype),$Te=Y(JTe.prototype,"_radius",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),eEe=Y(JTe.prototype,"_height",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),tEe=Y(JTe.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Iye.Y_AXIS}}),ZTe=JTe))||ZTe)||ZTe)||ZTe)||ZTe)),GCe=e("ConeCollider",(nEe=al("cc.ConeCollider"),iEe=Tl(),rEe=gl(),oEe=wl(),aEe=wl(),sEe=Gl(Iye),cEe=wl(),nEe(lEe=iEe(lEe=rEe(lEe=vl((Y((uEe=function(e){function t(){var t;return X(t=e.call(this,Oye.CONE)||this,"_radius",hEe,j(t)),X(t,"_height",_Ee,j(t)),X(t,"_direction",fEe,j(t)),t}return z(t,e),B(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(e<0&&(e=0),this._height=e,this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(e<Iye.X_AXIS||e>Iye.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(CTe)).prototype,"radius",[oEe],Object.getOwnPropertyDescriptor(uEe.prototype,"radius"),uEe.prototype),Y(uEe.prototype,"height",[aEe],Object.getOwnPropertyDescriptor(uEe.prototype,"height"),uEe.prototype),Y(uEe.prototype,"direction",[sEe,cEe],Object.getOwnPropertyDescriptor(uEe.prototype,"direction"),uEe.prototype),hEe=Y(uEe.prototype,"_radius",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),_Ee=Y(uEe.prototype,"_height",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fEe=Y(uEe.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Iye.Y_AXIS}}),lEe=uEe))||lEe)||lEe)||lEe)||lEe)),HCe=function(t){return e({MeshCollider:t,MeshColliderComponent:t}),t}((pEe=al("cc.MeshCollider"),dEe=Tl(),mEe=gl(),vEe=Gl(Tj),gEe=wl(),yEe=wl(),pEe(SEe=dEe(SEe=mEe(SEe=vl((Y((xEe=function(e){function t(){var t;return X(t=e.call(this,Oye.MESH)||this,"_mesh",TEe,j(t)),X(t,"_convex",EEe,j(t)),t}return z(t,e),B(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e,this._shape&&this.shape.setMesh(this._mesh))}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex!==e&&(this._convex=e)}},{key:"shape",get:function(){return this._shape}}]),t}(CTe)).prototype,"mesh",[vEe,gEe],Object.getOwnPropertyDescriptor(xEe.prototype,"mesh"),xEe.prototype),Y(xEe.prototype,"convex",[El,yEe],Object.getOwnPropertyDescriptor(xEe.prototype,"convex"),xEe.prototype),TEe=Y(xEe.prototype,"_mesh",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EEe=Y(xEe.prototype,"_convex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SEe=xEe))||SEe)||SEe)||SEe)||SEe)),VCe=e("ConstantForce",(CEe=al("cc.ConstantForce"),bEe=Tl(),AEe=sl(dTe),wEe=gl(),REe=Ml(),IEe=wl(),PEe=Ml(),OEe=wl(),DEe=Ml(),MEe=wl(),NEe=Ml(),LEe=wl(),CEe(BEe=bEe(BEe=AEe(BEe=wEe(BEe=ll(BEe=vl((HEe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._rigidBody=null,X(t,"_force",zEe,j(t)),X(t,"_localForce",UEe,j(t)),X(t,"_torque",kEe,j(t)),X(t,"_localTorque",GEe,j(t)),t._mask=0,t}z(t,e);var n=t.prototype;return n.onLoad=function(){this._rigidBody=this.node.getComponent(dTe),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)},n.lateUpdate=function(){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))},n._maskUpdate=function(e,t){e.strictEquals(gi.ZERO)?this._mask&=~t:this._mask|=t},B(t,[{key:"force",get:function(){return this._force},set:function(e){gi.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){gi.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){gi.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){gi.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),t}(rh),zEe=Y((FEe=HEe).prototype,"_force",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),UEe=Y(FEe.prototype,"_localForce",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),kEe=Y(FEe.prototype,"_torque",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),GEe=Y(FEe.prototype,"_localTorque",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),Y(FEe.prototype,"force",[REe,IEe],Object.getOwnPropertyDescriptor(FEe.prototype,"force"),FEe.prototype),Y(FEe.prototype,"localForce",[PEe,OEe],Object.getOwnPropertyDescriptor(FEe.prototype,"localForce"),FEe.prototype),Y(FEe.prototype,"torque",[DEe,MEe],Object.getOwnPropertyDescriptor(FEe.prototype,"torque"),FEe.prototype),Y(FEe.prototype,"localTorque",[NEe,LEe],Object.getOwnPropertyDescriptor(FEe.prototype,"localTorque"),FEe.prototype),BEe=FEe))||BEe)||BEe)||BEe)||BEe)||BEe)||BEe)),jCe=16842754,WCe=16842755,qCe=16842756,XCe=16842757,YCe=16843025,KCe=function(){function e(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}var t=e.prototype;return t.reserve=function(e){if(!(this.buffer.byteLength>e)){for(var t=this.buffer.byteLength;t<e;)t+=t;for(var n=new Uint8Array(t),i=0;i<this.length;++i)n[i]=this.buffer[i];this.buffer=n,this._buffView=new DataView(this.buffer.buffer)}},t.assign=function(e){this.buffer=e,this.length=e.length,this._seekPos=e.byteOffset,this._buffView=new DataView(e.buffer)},t.writeInt8=function(e){this.reserve(this.length+1),this._buffView.setInt8(this.length,e),this.length+=1},t.writeInt16=function(e){this.reserve(this.length+2),this._buffView.setInt16(this.length,e,!0),this.length+=2},t.writeInt32=function(e){this.reserve(this.length+4),this._buffView.setInt32(this.length,e,!0),this.length+=4},t.writeIntArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setInt32(this.length+4*t,e[t],!0);this.length+=4*e.length},t.writeFloat=function(e){this.reserve(this.length+4),this._buffView.setFloat32(this.length,e,!0),this.length+=4},t.writeFloatArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setFloat32(this.length+4*t,e[t],!0);this.length+=4*e.length},t.writeString=function(e){this.reserve(this.length+e.length+4),this._buffView.setInt32(this.length,e.length,!0);for(var t=0;t<e.length;++t)this._buffView.setInt8(this.length+4+t,e.charCodeAt(t));this.length+=e.length+4},t.readInt8=function(){var e=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,e},t.readInt16=function(){var e=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,e},t.readInt=function(){var e=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,e},t.readIntArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getInt32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},t.readFloat=function(){var e=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,e},t.readFloatArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getFloat32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},t.readString=function(){for(var e=this.readInt(),t="",n=0;n<e;++n)t+=String.fromCharCode(this.readInt8());return t},e}(),QCe=(al("cc.TerrainLayerInfo")((jEe=Y((VEe=function(){X(this,"slot",jEe,this),X(this,"tileSize",WEe,this),X(this,"detailMap",qEe,this),X(this,"normalMap",XEe,this),X(this,"roughness",YEe,this),X(this,"metallic",KEe,this)}).prototype,"slot",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WEe=Y(VEe.prototype,"tileSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qEe=Y(VEe.prototype,"detailMap",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XEe=Y(VEe.prototype,"normalMap",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YEe=Y(VEe.prototype,"roughness",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),KEe=Y(VEe.prototype,"metallic",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VEe)),al("cc.TerrainLayerBinaryInfo")(QEe=function(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""})||QEe),ZCe=al("cc.TerrainAsset")((eCe=function(e){function t(){var t;return(t=e.call(this)||this)._version=0,t._data=null,t._tileSize=1,t._blockCount=[1,1],t._weightMapSize=128,t._lightMapSize=128,t._heights=new Uint16Array,t._weights=new Uint8Array,t._layerBuffer=[-1,-1,-1,-1],t._layerBinaryInfos=[],X(t,"_layerInfos",$Ee,j(t)),t}z(t,e);var n=t.prototype;return n.getLayer=function(e,t,n){var i=4*(t*this.blockCount[0]+e)+n;return e<this.blockCount[0]&&t<this.blockCount[1]&&i<this._layerBuffer.length?this._layerBuffer[i]:-1},n.getHeight=function(e,t){var n=32*this._blockCount[0]+1;return.001953125*(this._heights[t*n+e]-32768)},n.getVertexCountI=function(){return this._blockCount.length<1?0:32*this._blockCount[0]+1},n.getVertexCountJ=function(){return this._blockCount.length<2?0:32*this._blockCount[1]+1},n._setNativeData=function(e){this._data=e},n._loadNativeData=function(e){if(!e||0===e.length)return!1;var t=new KCe;if(t.assign(e),this._version=t.readInt(),this._version===YCe)return!0;if(16842753!==this._version&&this._version!==jCe&&this._version!==WCe&&this._version!==qCe&&this._version!==XCe)return!1;this.tileSize=t.readFloat(),t.readIntArray(this._blockCount),this.weightMapSize=t.readInt16(),this.lightMapSize=t.readInt16();var n=t.readInt();this.heights=new Uint16Array(n);for(var i=0;i<this.heights.length;++i)this.heights[i]=t.readInt16();var r=t.readInt();this.weights=new Uint8Array(r);for(var o=0;o<this.weights.length;++o)this.weights[o]=t.readInt8();if(this._version>=jCe){var a=t.readInt();this.layerBuffer=new Array(a);for(var s=0;s<this.layerBuffer.length;++s)this.layerBuffer[s]=t.readInt16()}if(this._version>=WCe){var c=t.readInt();this._layerBinaryInfos=new Array(c);for(var l=0;l<this._layerBinaryInfos.length;++l)this._layerBinaryInfos[l]=new QCe,this._layerBinaryInfos[l].slot=t.readInt(),this._layerBinaryInfos[l].tileSize=t.readFloat(),this._layerBinaryInfos[l].detailMapId=t.readString(),this._version>=qCe&&(this._layerBinaryInfos[l].normalMapId=t.readString(),this._layerBinaryInfos[l].roughness=t.readFloat(),this._layerBinaryInfos[l].metallic=t.readFloat())}return!0},n._exportNativeData=function(){var e=new KCe;e.writeInt32(XCe),e.writeFloat(this.tileSize),e.writeIntArray(this._blockCount),e.writeInt16(this.weightMapSize),e.writeInt16(this.lightMapSize),e.writeInt32(this.heights.length);for(var t=0;t<this.heights.length;++t)e.writeInt16(this.heights[t]);e.writeInt32(this.weights.length);for(var n=0;n<this.weights.length;++n)e.writeInt8(this.weights[n]);e.writeInt32(this.layerBuffer.length);for(var i=0;i<this.layerBuffer.length;++i)e.writeInt16(this.layerBuffer[i]);var r=[];r.length=this.layerInfos.length;for(var o=0;o<r.length;++o){var a=this.layerInfos[o],s=new QCe;s.slot=o,s.tileSize=a.tileSize,s.detailMapId=a.detailMap?a.detailMap._uuid:"",s.normalMapId=a.normalMap?a.normalMap._uuid:"",s.metallic=a.metallic,s.roughness=a.roughness,r[o]=s}e.writeInt32(r.length);for(var c=0;c<r.length;++c)e.writeInt32(r[c].slot),e.writeFloat(r[c].tileSize),e.writeString(r[c].detailMapId),e.writeString(r[c].normalMapId),e.writeFloat(r[c].roughness),e.writeFloat(r[c].metallic);return e.buffer},n._exportDefaultNativeData=function(){var e=new KCe;return e.writeInt32(YCe),e.buffer},B(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?this._data.set(new Uint8Array(e)):this._data=new Uint8Array(e),this._loadNativeData(this._data)}},{key:"version",get:function(){return this._version}},{key:"tileSize",get:function(){return this._tileSize},set:function(e){this._tileSize=e}},{key:"blockCount",get:function(){return this._blockCount},set:function(e){this._blockCount=e}},{key:"lightMapSize",get:function(){return this._lightMapSize},set:function(e){this._lightMapSize=e}},{key:"weightMapSize",get:function(){return this._weightMapSize},set:function(e){this._weightMapSize=e}},{key:"heights",get:function(){return this._heights},set:function(e){this._heights=e}},{key:"weights",get:function(){return this._weights},set:function(e){this._weights=e}},{key:"layerBuffer",get:function(){return this._layerBuffer},set:function(e){this._layerBuffer=e}},{key:"layerInfos",get:function(){return this._layerInfos},set:function(e){this._layerInfos=e}},{key:"layerBinaryInfos",get:function(){return this._layerBinaryInfos}}]),t}(Fu),$Ee=Y((JEe=eCe).prototype,"_layerInfos",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZEe=JEe))||ZEe,JCe=e("TerrainCollider",(tCe=al("cc.TerrainCollider"),nCe=Tl(),iCe=gl(),rCe=Gl(ZCe),oCe=wl(),tCe(aCe=nCe(aCe=iCe(aCe=vl((Y((sCe=function(e){function t(){var t;return X(t=e.call(this,Oye.TERRAIN)||this,"_terrain",cCe,j(t)),t}return z(t,e),B(t,[{key:"terrain",get:function(){return this._terrain},set:function(e){this._terrain=e,this._shape&&this.shape.setTerrain(this._terrain)}},{key:"shape",get:function(){return this._shape}}]),t}(CTe)).prototype,"terrain",[rCe,oCe],Object.getOwnPropertyDescriptor(sCe.prototype,"terrain"),sCe.prototype),cCe=Y(sCe.prototype,"_terrain",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aCe=sCe))||aCe)||aCe)||aCe)||aCe)),$Ce=e("SimplexCollider",(lCe=al("cc.SimplexCollider"),uCe=Tl(),hCe=gl(),_Ce=Gl(Pye),fCe=wl(),pCe=wl(),dCe=Cl(),mCe=wl(),vCe=Cl(),gCe=wl(),yCe=Cl(),SCe=wl(),lCe(xCe=uCe(xCe=hCe(xCe=vl((ACe=bCe=function(e){function t(){var t;return X(t=e.call(this,Oye.SIMPLEX)||this,"_shapeType",ECe,j(t)),X(t,"_vertices",CCe,j(t)),t}return z(t,e),t.prototype.updateVertices=function(){this._shape&&this.shape.setVertices(this._vertices)},B(t,[{key:"shapeType",get:function(){return this._shapeType},set:function(e){this._shapeType=e,this._shape&&this.shape.setShapeType(e)}},{key:"vertex0",get:function(){return this._vertices[0]},set:function(e){gi.copy(this._vertices[0],e),this.updateVertices()}},{key:"vertex1",get:function(){return this._vertices[1]},set:function(e){gi.copy(this._vertices[1],e),this.updateVertices()}},{key:"vertex2",get:function(){return this._vertices[2]},set:function(e){gi.copy(this._vertices[2],e),this.updateVertices()}},{key:"vertex3",get:function(){return this._vertices[3]},set:function(e){gi.copy(this._vertices[3],e),this.updateVertices()}},{key:"shape",get:function(){return this._shape}},{key:"vertices",get:function(){return this._vertices}}]),t}(CTe),bCe.ESimplexType=Pye,Y((TCe=ACe).prototype,"shapeType",[_Ce,fCe],Object.getOwnPropertyDescriptor(TCe.prototype,"shapeType"),TCe.prototype),Y(TCe.prototype,"vertex0",[El,pCe],Object.getOwnPropertyDescriptor(TCe.prototype,"vertex0"),TCe.prototype),Y(TCe.prototype,"vertex1",[dCe,mCe],Object.getOwnPropertyDescriptor(TCe.prototype,"vertex1"),TCe.prototype),Y(TCe.prototype,"vertex2",[vCe,gCe],Object.getOwnPropertyDescriptor(TCe.prototype,"vertex2"),TCe.prototype),Y(TCe.prototype,"vertex3",[yCe,SCe],Object.getOwnPropertyDescriptor(TCe.prototype,"vertex3"),TCe.prototype),ECe=Y(TCe.prototype,"_shapeType",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pye.TETRAHEDRON}}),CCe=Y(TCe.prototype,"_vertices",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new gi(0,0,0),new gi(0,0,1),new gi(1,0,0),new gi(0,1,0)]}}),xCe=TCe))||xCe)||xCe)||xCe)||xCe));$Ce||($Ce=e("SimplexCollider",{}));var ebe,tbe,nbe,ibe,rbe,obe,abe,sbe,cbe,lbe,ube,hbe,_be,fbe,pbe,dbe,mbe,vbe,gbe,ybe,Sbe,xbe,Tbe,Ebe,Cbe,bbe,Abe,wbe,Rbe=e("PlaneCollider",(wCe=al("cc.PlaneCollider"),RCe=Tl(),ICe=gl(),PCe=Gl(gi),OCe=wl(),DCe=wl(),wCe(MCe=RCe(MCe=ICe(MCe=vl((Y((NCe=function(e){function t(){var t;return X(t=e.call(this,Oye.PLANE)||this,"_normal",LCe,j(t)),X(t,"_constant",BCe,j(t)),t}return z(t,e),B(t,[{key:"normal",get:function(){return this._normal},set:function(e){gi.strictEquals(this._normal,e)||(gi.copy(this._normal,e),this._shape&&this.shape.setNormal(this._normal))}},{key:"constant",get:function(){return this._constant},set:function(e){this._constant!==e&&(this._constant=e,this._shape&&this.shape.setConstant(this._constant))}},{key:"shape",get:function(){return this._shape}}]),t}(CTe)).prototype,"normal",[PCe,OCe],Object.getOwnPropertyDescriptor(NCe.prototype,"normal"),NCe.prototype),Y(NCe.prototype,"constant",[El,DCe],Object.getOwnPropertyDescriptor(NCe.prototype,"constant"),NCe.prototype),LCe=Y(NCe.prototype,"_normal",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi(0,1,0)}}),BCe=Y(NCe.prototype,"_constant",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MCe=NCe))||MCe)||MCe)||MCe)||MCe)),Ibe=e("Constraint",(ebe=al("cc.Constraint"),tbe=sl(dTe),nbe=Gl(dTe),ibe=Ml(),rbe=Gl(dTe),obe=Ml(),abe=Ml(),sbe=Gl(dTe),ebe(cbe=tbe((fbe=_be=function(e){function t(t){var n;return(n=e.call(this)||this).TYPE=void 0,X(n,"_enableCollision",ube,j(n)),X(n,"_connectedBody",hbe,j(n)),n._constraint=null,n.TYPE=t,n}z(t,e);var n=t.prototype;return n.onLoad=function(){iSe.runInEditor&&(this._constraint=function(e){return hSe.INITED||(hSe.INITED=!0,hSe[Dye.POINT_TO_POINT]=function(){return aSe(iSe.wrapper.PointToPointConstraint,nSe.PointToPointConstraint)?_Se:new iSe.wrapper.PointToPointConstraint},hSe[Dye.HINGE]=function(){return aSe(iSe.wrapper.HingeConstraint,nSe.HingeConstraint)?_Se:new iSe.wrapper.HingeConstraint},hSe[Dye.CONE_TWIST]=function(){return aSe(iSe.wrapper.ConeTwistConstraint,nSe.ConeTwistConstraint)?_Se:new iSe.wrapper.ConeTwistConstraint}),hSe[e]()}(this.TYPE),this._constraint.initialize(this))},n.onEnable=function(){this._constraint&&this._constraint.onEnable()},n.onDisable=function(){this._constraint&&this._constraint.onDisable()},n.onDestroy=function(){this._constraint&&this._constraint.onDestroy()},B(t,[{key:"attachedBody",get:function(){return this.getComponent(dTe)}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(e){this._connectedBody=e,this._constraint&&this._constraint.setConnectedBody(e)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._enableCollision=e,this._constraint&&this._constraint.setEnableCollision(e)}}]),t}(an(rh)),_be.Type=Dye,Y((lbe=fbe).prototype,"attachedBody",[nbe,bl,ibe],Object.getOwnPropertyDescriptor(lbe.prototype,"attachedBody"),lbe.prototype),Y(lbe.prototype,"connectedBody",[rbe,obe],Object.getOwnPropertyDescriptor(lbe.prototype,"connectedBody"),lbe.prototype),Y(lbe.prototype,"enableCollision",[abe],Object.getOwnPropertyDescriptor(lbe.prototype,"enableCollision"),lbe.prototype),ube=Y(lbe.prototype,"_enableCollision",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hbe=Y(lbe.prototype,"_connectedBody",[sbe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cbe=lbe))||cbe)||cbe));Ibe||(Ibe=e("Constraint",{}));var Pbe,Obe,Dbe,Mbe,Nbe,Lbe,Bbe,Fbe,zbe,Ube=e("HingeConstraint",(pbe=al("cc.HingeConstraint"),dbe=Tl(),mbe=gl(),vbe=Gl(gi),gbe=Gl(gi),ybe=Gl(gi),Sbe=fl("axisA"),xbe=fl("pivotA"),Tbe=fl("pivotB"),pbe(Ebe=dbe(Ebe=mbe((Y((Cbe=function(e){function t(){var t;return X(t=e.call(this,Dye.HINGE)||this,"_axis",bbe,j(t)),X(t,"_pivotA",Abe,j(t)),X(t,"_pivotB",wbe,j(t)),t}return z(t,e),B(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){gi.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){gi.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"axis",get:function(){return this._axis},set:function(e){gi.copy(this._axis,e),this.constraint.setAxis(this._axis)}},{key:"constraint",get:function(){return this._constraint}}]),t}(Ibe)).prototype,"pivotA",[vbe],Object.getOwnPropertyDescriptor(Cbe.prototype,"pivotA"),Cbe.prototype),Y(Cbe.prototype,"pivotB",[gbe],Object.getOwnPropertyDescriptor(Cbe.prototype,"pivotB"),Cbe.prototype),Y(Cbe.prototype,"axis",[ybe],Object.getOwnPropertyDescriptor(Cbe.prototype,"axis"),Cbe.prototype),bbe=Y(Cbe.prototype,"_axis",[_l,Sbe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),Abe=Y(Cbe.prototype,"_pivotA",[_l,xbe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),wbe=Y(Cbe.prototype,"_pivotB",[_l,Tbe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),Ebe=Cbe))||Ebe)||Ebe)||Ebe)),kbe=e("PointToPointConstraint",(Pbe=al("cc.PointToPointConstraint"),Obe=Tl(),Dbe=gl(),Mbe=Gl(gi),Nbe=Gl(gi),Pbe(Lbe=Obe(Lbe=Dbe((Y((Bbe=function(e){function t(){var t;return X(t=e.call(this,Dye.POINT_TO_POINT)||this,"_pivotA",Fbe,j(t)),X(t,"_pivotB",zbe,j(t)),t}return z(t,e),B(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){gi.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){gi.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"constraint",get:function(){return this._constraint}}]),t}(Ibe)).prototype,"pivotA",[Mbe],Object.getOwnPropertyDescriptor(Bbe.prototype,"pivotA"),Bbe.prototype),Y(Bbe.prototype,"pivotB",[Nbe],Object.getOwnPropertyDescriptor(Bbe.prototype,"pivotB"),Bbe.prototype),Fbe=Y(Bbe.prototype,"_pivotA",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),zbe=Y(Bbe.prototype,"_pivotB",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),Lbe=Bbe))||Lbe)||Lbe)||Lbe));r.PhysicsSystem=qxe,r.PhysicsMaterial=$Se,r.PhysicsRayResult=exe,r.ConstantForce=VCe;var Gbe=Object.freeze({__proto__:null,PhysicsSystem:qxe,PhysicsRayResult:exe,get Collider(){return CTe},BoxCollider:FCe,SphereCollider:zCe,CapsuleCollider:UCe,MeshCollider:HCe,CylinderCollider:kCe,ConeCollider:GCe,TerrainCollider:JCe,get SimplexCollider(){return $Ce},PlaneCollider:Rbe,get Constraint(){return Ibe},HingeConstraint:Ube,PointToPointConstraint:kbe,get RigidBody(){return dTe},PhysicsMaterial:$Se,ConstantForce:VCe,selector:iSe,utils:JSe,get ERigidBodyType(){return Rye},get EAxisDirection(){return Iye},get ESimplexType(){return Pye},get EColliderType(){return Oye},get EConstraintType(){return Dye},get PhysicsGroup(){return Mye}});e("physics",Gbe);var Hbe,Vbe,jbe,Wbe,qbe,Xbe,Ybe=function(){};Ybe.foundation=void 0,Ybe.physics=void 0,Ybe.cooking=void 0,Ybe.pvd=void 0,Ybe.queryfilterData=void 0,Ybe.singleResult=void 0,Ybe.mutipleResults=void 0,Ybe.simulationCB=void 0,Ybe.queryFilterCB=void 0,Ybe.mutipleResultSize=12,function(e){e[e.QUERY_FILTER=1]="QUERY_FILTER",e[e.QUERY_CHECK_TRIGGER=2]="QUERY_CHECK_TRIGGER",e[e.QUERY_SINGLE_HIT=4]="QUERY_SINGLE_HIT",e[e.DETECT_TRIGGER_EVENT=8]="DETECT_TRIGGER_EVENT",e[e.DETECT_CONTACT_EVENT=16]="DETECT_CONTACT_EVENT",e[e.DETECT_CONTACT_POINT=32]="DETECT_CONTACT_POINT",e[e.DETECT_CONTACT_CCD=64]="DETECT_CONTACT_CCD"}(Hbe||(Hbe={})),function(e){e[e.ePOSITION=1]="ePOSITION",e[e.eNORMAL=2]="eNORMAL",e[e.eUV=8]="eUV",e[e.eASSUME_NO_INITIAL_OVERLAP=16]="eASSUME_NO_INITIAL_OVERLAP",e[e.eMESH_MULTIPLE=32]="eMESH_MULTIPLE",e[e.eMESH_ANY=64]="eMESH_ANY",e[e.eMESH_BOTH_SIDES=128]="eMESH_BOTH_SIDES",e[e.ePRECISE_SWEEP=256]="ePRECISE_SWEEP",e[e.eMTD=512]="eMTD",e[e.eFACE_INDEX=1024]="eFACE_INDEX",e[e.eDEFAULT=e.ePOSITION|e.eNORMAL|e.eFACE_INDEX]="eDEFAULT",e[e.eMODIFIABLE_FLAGS=e.eMESH_MULTIPLE|e.eMESH_BOTH_SIDES|e.eASSUME_NO_INITIAL_OVERLAP|e.ePRECISE_SWEEP]="eMODIFIABLE_FLAGS"}(Vbe||(Vbe={})),function(e){e[e.eSTATIC=1]="eSTATIC",e[e.eDYNAMIC=2]="eDYNAMIC",e[e.ePREFILTER=4]="ePREFILTER",e[e.ePOSTFILTER=8]="ePOSTFILTER",e[e.eANY_HIT=16]="eANY_HIT",e[e.eNO_BLOCK=32]="eNO_BLOCK",e[e.eRESERVED=32768]="eRESERVED"}(jbe||(jbe={})),function(e){e[e.eSOLVE_CONTACT=1]="eSOLVE_CONTACT",e[e.eMODIFY_CONTACTS=2]="eMODIFY_CONTACTS",e[e.eNOTIFY_TOUCH_FOUND=4]="eNOTIFY_TOUCH_FOUND",e[e.eNOTIFY_TOUCH_PERSISTS=8]="eNOTIFY_TOUCH_PERSISTS",e[e.eNOTIFY_TOUCH_LOST=16]="eNOTIFY_TOUCH_LOST",e[e.eNOTIFY_TOUCH_CCD=32]="eNOTIFY_TOUCH_CCD",e[e.eNOTIFY_THRESHOLD_FORCE_FOUND=64]="eNOTIFY_THRESHOLD_FORCE_FOUND",e[e.eNOTIFY_THRESHOLD_FORCE_PERSISTS=128]="eNOTIFY_THRESHOLD_FORCE_PERSISTS",e[e.eNOTIFY_THRESHOLD_FORCE_LOST=256]="eNOTIFY_THRESHOLD_FORCE_LOST",e[e.eNOTIFY_CONTACT_POINTS=512]="eNOTIFY_CONTACT_POINTS",e[e.eDETECT_DISCRETE_CONTACT=1024]="eDETECT_DISCRETE_CONTACT",e[e.eDETECT_CCD_CONTACT=2048]="eDETECT_CCD_CONTACT",e[e.ePRE_SOLVER_VELOCITY=4096]="ePRE_SOLVER_VELOCITY",e[e.ePOST_SOLVER_VELOCITY=8192]="ePOST_SOLVER_VELOCITY",e[e.eCONTACT_EVENT_POSE=16384]="eCONTACT_EVENT_POSE",e[e.eNEXT_FREE=32768]="eNEXT_FREE",e[e.eCONTACT_DEFAULT=1025]="eCONTACT_DEFAULT",e[e.eTRIGGER_DEFAULT=1044]="eTRIGGER_DEFAULT"}(Wbe||(Wbe={})),function(e){e[e.eREMOVED_SHAPE_0=1]="eREMOVED_SHAPE_0",e[e.eREMOVED_SHAPE_1=2]="eREMOVED_SHAPE_1",e[e.eACTOR_PAIR_HAS_FIRST_TOUCH=4]="eACTOR_PAIR_HAS_FIRST_TOUCH",e[e.eACTOR_PAIR_LOST_TOUCH=8]="eACTOR_PAIR_LOST_TOUCH",e[e.eINTERNAL_HAS_IMPULSES=16]="eINTERNAL_HAS_IMPULSES",e[e.eINTERNAL_CONTACTS_ARE_FLIPPED=32]="eINTERNAL_CONTACTS_ARE_FLIPPED"}(qbe||(qbe={})),function(e){e[e.eREMOVED_SHAPE_TRIGGER=1]="eREMOVED_SHAPE_TRIGGER",e[e.eREMOVED_SHAPE_OTHER=2]="eREMOVED_SHAPE_OTHER",e[e.eNEXT_FREE=4]="eNEXT_FREE"}(Xbe||(Xbe={}));var Kbe={},Qbe=r._global,Zbe=!!Qbe.PHYSX;ZM.once(QM.EVENT_ENGINE_INITED,(function(){console.info("[PHYSICS]:","Use PhysX js or wasm Libs."),Qbe.PhysX=Qbe.PHYSX?Qbe.PHYSX:n,null!=Qbe.PhysX?Qbe.PhysX().then((function(e){var t;console.info("[PHYSICS]:",(Zbe?"External":"Internal")+" PhysX libs loaded."),(t=e).VECTOR_MAT=new t.PxMaterialVector,t.MeshScale=t.PxMeshScale,t.ShapeFlag=t.PxShapeFlag,t.ActorFlag=t.PxActorFlag,t.ForceMode=t.PxForceMode,t.CombineMode=t.PxCombineMode,t.BoxGeometry=t.PxBoxGeometry,t.QueryHitType=t.PxQueryHitType,t.RigidBodyFlag=t.PxRigidBodyFlag,t.PlaneGeometry=t.PxPlaneGeometry,t.SphereGeometry=t.PxSphereGeometry,t.CapsuleGeometry=t.PxCapsuleGeometry,t.ConvexMeshGeometry=t.PxConvexMeshGeometry,t.TriangleMeshGeometry=t.PxTriangleMeshGeometry,t.RigidDynamicLockFlag=t.PxRigidDynamicLockFlag,t.createRevoluteJoint=function(e,n,i,r){return t.PxRevoluteJointCreate(Kbe.physics,e,n,i,r)},t.createDistanceJoint=function(e,n,i,r){return t.PxDistanceJointCreate(Kbe.physics,e,n,i,r)},function(e){Qbe.PhysX=e,e.EPSILON=.001,e.MULTI_THREAD=!1,e.SUB_THREAD_COUNT=1,e.CACHE_MAT={},e.IMPL_PTR={},e.MESH_CONVEX={},e.MESH_STATIC={},e.TERRAIN_STATIC={}}(e),Object.assign(Kbe,e)}),(function(e){console.error("[PHYSICS]:","PhysX load failed: "+e)})):console.error("[PHYSICS]:","Not Found PhysX js or wasm Libs.")}));var Jbe={x:0,y:0,z:0},$be={x:0,y:0,z:0,w:1},eAe={translation:Jbe,rotation:$be,p:Jbe,q:$be},tAe=eAe;function nAe(e){return Kbe.IMPL_PTR[e.$$.ptr]}function iAe(e,t){return gi.copy(tAe.translation,e),bi.copy(tAe.rotation,t),tAe}function rAe(e,t){return gi.copy(eAe.p,e),bi.copy(eAe.q,t),eAe}function oAe(e,t){e.addActor(t,null)}function aAe(e,t,n){e.setActors(t,n)}function sAe(e,t){e.setMassAndUpdateInertia(t)}function cAe(e,t){var n=e.translation;return gi.equals(n,t,Kbe.EPSILON)}function lAe(e,t){var n=e.rotation;return bi.equals(n,t,Kbe.EPSILON)}function uAe(e,t,n,i){e?t.applyImpulse(n,i):t.applyLocalImpulse(n,i)}function hAe(e,t,n,i){e?t.applyForce(n,i):t.applyLocalForce(n,i)}function _Ae(e,t){e.addTorque(t)}function fAe(e,t,n){for(var i=HSe(e),r=i.length,o=new Kbe.PxVec3Vector,a=0;a<r;a+=3)o.push_back({x:i[a],y:i[a+1],z:i[a+2]});var s=t.createConvexMesh(o,n);return o.delete(),s}function pAe(e,t){return t?new Kbe.PxConvexMeshGeometryFlags(e):new Kbe.PxMeshGeometryFlags(e)}function dAe(e,t){gi.copy(t,e.position)}function mAe(e,t){gi.copy(t,e.normal)}function vAe(e,t){var n=Kbe.getGContacts(),i=n.get(e+t);return n.delete(),i}var gAe=function(){function e(t,n){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.wrappedShapes=[],this.wrappedJoints0=[],this.wrappedJoints1=[],this._index=-1,this._ref=0,this._isStatic=!1,this._isKinematic=!1,this._wrappedBody=null,this._filterData=void 0,this.id=e.idCounter++,this.node=t,this.wrappedWorld=n,this._filterData={word0:1,word1:1,word2:0,word3:0}}e.getSharedBody=function(t,n,i){var r,o=t.uuid;if(e.sharedBodesMap.has(o)?r=e.sharedBodesMap.get(o):((r=new e(t,n)).filterData.word0=Mye.DEFAULT,r.filterData.word1=qxe.instance.collisionMatrix[Mye.DEFAULT],e.sharedBodesMap.set(t.uuid,r)),i){r._wrappedBody=i;var a=i.rigidBody.group,s=qxe.instance.collisionMatrix[a];r.filterData.word0=a,r.filterData.word1=s}return r};var t=e.prototype;return t._initActor=function(){var e=this._isStatic,t=this.wrappedBody;t?t.rigidBody.type===Rye.STATIC?(this._isStatic=!0,this._isKinematic=!1,this._initStaticActor()):(this._isStatic=!1,this._initDynamicActor()):(this._isStatic=!0,this._isKinematic=!1,this._initStaticActor()),e!==this._isStatic&&this._switchActor(e)},t._initStaticActor=function(){if(!this._staticActor){var e=iAe(this.node.worldPosition,this.node.worldRotation);this._staticActor=Ybe.physics.createRigidStatic(e),this._staticActor.$$&&(Kbe.IMPL_PTR[this._staticActor.$$.ptr]=this)}},t._initDynamicActor=function(){if(!this._dynamicActor){var e=iAe(this.node.worldPosition,this.node.worldRotation);this._dynamicActor=Ybe.physics.createRigidDynamic(e),this._dynamicActor.$$&&(Kbe.IMPL_PTR[this._dynamicActor.$$.ptr]=this);var t=this.wrappedBody;if(t){var n=t.rigidBody;this._dynamicActor.setMass(n.mass),this._dynamicActor.setActorFlag(Kbe.ActorFlag.eDISABLE_GRAVITY,!n.useGravity),this.setLinearDamping(n.linearDamping),this.setAngularDamping(n.angularDamping),this.setRigidBodyFlag(Kbe.RigidBodyFlag.eKINEMATIC,n.isKinematic);var i=n.linearFactor;this._dynamicActor.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_LINEAR_X,!i.x),this._dynamicActor.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_LINEAR_Y,!i.y),this._dynamicActor.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_LINEAR_Z,!i.z);var r=n.angularFactor;this._dynamicActor.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_ANGULAR_X,!r.x),this._dynamicActor.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_ANGULAR_Y,!r.y),this._dynamicActor.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_ANGULAR_Z,!r.z)}}},t._switchActor=function(e){if(this._staticActor&&this._dynamicActor){var t=e?this._staticActor:this._dynamicActor,n=e?this._dynamicActor:this._staticActor;this._index>=0&&(this.wrappedWorld.scene.removeActor(t,!1),oAe(this.wrappedWorld.scene,n));for(var i=0;i<this.wrappedShapes.length;i++){var r=this.wrappedShapes[i];t.detachShape(r.impl,!1),n.attachShape(r.impl)}if(e){var o=this._dynamicActor;sAe(o,this._wrappedBody.rigidBody.mass);var a=USe;a.set(0,0,0);for(var s=0;s<this.wrappedShapes.length;s++){var c=this.wrappedShapes[s].collider;c.isTrigger||a.subtract(c.center)}o.setCMassLocalPose(iAe(a,bi.IDENTITY))}}},t.addShape=function(e){this.wrappedShapes.indexOf(e)<0&&(e.setIndex(this.wrappedShapes.length),e.updateFilterData(this._filterData),this.impl.attachShape(e.impl),this.wrappedShapes.push(e),e.collider.isTrigger||(gi.strictEquals(e.collider.center,gi.ZERO)||this.updateCenterOfMass(),this.isDynamic&&sAe(this.impl,this._wrappedBody.rigidBody.mass)))},t.removeShape=function(e){var t=this.wrappedShapes.indexOf(e);t>=0&&(e.setIndex(-1),this.impl.detachShape(e.impl,!0),Z(this.wrappedShapes,t),e.collider.isTrigger||(gi.strictEquals(e.collider.center,gi.ZERO)||this.updateCenterOfMass(),this.isDynamic&&sAe(this.impl,this._wrappedBody.rigidBody.mass)))},t.addJoint=function(e,t){t?this.wrappedJoints1.indexOf(e)<0&&this.wrappedJoints1.push(e):this.wrappedJoints0.indexOf(e)<0&&this.wrappedJoints0.push(e)},t.removeJoint=function(e,t){if(t){var n=this.wrappedJoints1.indexOf(e);n>=0&&Z(this.wrappedJoints1,n)}else{var i=this.wrappedJoints0.indexOf(e);i>=0&&Z(this.wrappedJoints0,i)}},t.setLinearDamping=function(e){if(this._dynamicActor){var t=qxe.instance.fixedTimeStep;this._dynamicActor.setLinearDamping((1-Math.pow(1-e,t))/t)}},t.setAngularDamping=function(e){if(this._dynamicActor){var t=qxe.instance.fixedTimeStep;this._dynamicActor.setAngularDamping((1-Math.pow(1-e,t))/t)}},t.setMass=function(e){e<=0||this.isDynamic&&sAe(this.impl,e)},t.setType=function(e){if(this._initActor(),!this.isStatic)switch(e){case Rye.DYNAMIC:this.setRigidBodyFlag(Kbe.RigidBodyFlag.eKINEMATIC,!1);break;case Rye.KINEMATIC:default:this.setRigidBodyFlag(Kbe.RigidBodyFlag.eKINEMATIC,!0)}},t.setRigidBodyFlag=function(e,t){e===Kbe.RigidBodyFlag.eKINEMATIC&&(this._isKinematic=t),this.impl.setRigidBodyFlag(e,t)},t.syncSceneToPhysics=function(){var e=this.node;if(e.hasChangedFlags)if(e.hasChangedFlags&ng.SCALE&&this.syncScale(),this._isKinematic){var t=iAe(e.worldPosition,e.worldRotation);this.impl.setKinematicTarget(t)}else{var n=rAe(e.worldPosition,e.worldRotation);this.impl.setGlobalPose(n,!0)}},t.syncSceneWithCheck=function(){var e=this.node;if(e.hasChangedFlags){e.hasChangedFlags&ng.SCALE&&this.syncScale();var t=e.worldPosition,n=e.worldRotation,i=this.impl.getGlobalPose();if(!cAe(i,t)||!lAe(i,n))if(this._isKinematic){var r=iAe(e.worldPosition,e.worldRotation);this.impl.setKinematicTarget(r)}else{var o=rAe(e.worldPosition,e.worldRotation);this.impl.setGlobalPose(o,!0)}}},t.syncPhysicsToScene=function(){var e,t;this.isDynamic&&(e=this._dynamicActor,t=this.node,e.isSleeping()||function(e,t){var n=e.worldPosition,i=e.worldRotation;cAe(t,n)&&lAe(t,i)||(e.setWorldPosition(t.translation),e.setWorldRotation(t.rotation))}(t,e.getGlobalPose()))},t.syncScale=function(){for(var e=0;e<this.wrappedShapes.length;e++)this.wrappedShapes[e].updateScale();for(var t=0;t<this.wrappedJoints0.length;t++)this.wrappedJoints0[t].updateScale0();for(var n=0;n<this.wrappedJoints1.length;n++)this.wrappedJoints1[n].updateScale1()},t.setGroup=function(e){this._filterData.word0=e,this.updateFilterData()},t.getGroup=function(){return this._filterData.word0},t.addGroup=function(e){this._filterData.word0|=e,this.updateFilterData()},t.removeGroup=function(e){this._filterData.word0&=~e,this.updateFilterData()},t.setMask=function(e){-1===e&&(e=4294967295),this._filterData.word1=e,this.updateFilterData()},t.getMask=function(){return this._filterData.word1},t.addMask=function(e){this._filterData.word1|=e,this.updateFilterData()},t.removeMask=function(e){this._filterData.word1&=~e,this.updateFilterData()},t.updateFilterData=function(){for(var e=0;e<this.wrappedShapes.length;e++)this.wrappedShapes[e].updateFilterData(this._filterData)},t.updateCenterOfMass=function(){if(this._initActor(),!this._isStatic){var e=USe;e.set(0,0,0);for(var t=0;t<this.wrappedShapes.length;t++){var n=this.wrappedShapes[t].collider;n.isTrigger||e.subtract(n.center)}this.impl.setCMassLocalPose(iAe(e,bi.IDENTITY))}},t.clearForces=function(){this._isStatic||this._isKinematic||(this.impl.clearForce(Kbe.ForceMode.eFORCE),this.impl.clearForce(Kbe.ForceMode.eIMPULSE),this.impl.clearTorque(Kbe.ForceMode.eFORCE),this.impl.clearTorque(Kbe.ForceMode.eIMPULSE))},t.clearVelocity=function(){this._isStatic||this._isKinematic||(this.impl.setLinearVelocity(gi.ZERO,!1),this.impl.setAngularVelocity(gi.ZERO,!1))},t.destroy=function(){this._dynamicActor&&(this._dynamicActor.$$&&(Kbe.IMPL_PTR[this._dynamicActor.$$.ptr]=null,delete Kbe.IMPL_PTR[this._dynamicActor.$$.ptr]),this._dynamicActor.release(),this._dynamicActor=null),this._staticActor&&(this._staticActor.$$&&(Kbe.IMPL_PTR[this._staticActor.$$.ptr]=null,delete Kbe.IMPL_PTR[this._staticActor.$$.ptr]),this._staticActor.release(),this._staticActor=null),e.sharedBodesMap.delete(this.node.uuid)},B(e,[{key:"isStatic",get:function(){return this._isStatic}},{key:"isKinematic",get:function(){return this._isKinematic}},{key:"isDynamic",get:function(){return!this._isStatic&&!this._isKinematic}},{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"filterData",get:function(){return this._filterData}},{key:"isInScene",get:function(){return-1!==this._index}},{key:"impl",get:function(){return this._initActor(),this.isStatic?this._staticActor:this._dynamicActor}},{key:"reference",set:function(e){this._ref=e?this._ref+1:this._ref-1,0===this._ref&&this.destroy()}},{key:"enabled",set:function(e){if(e)this._index<0&&(this._index=this.wrappedWorld.wrappedBodies.length,this.wrappedWorld.addActor(this));else if(this._index>=0){var t=this.wrappedShapes,n=this.wrappedBody;(0===t.length&&null==n||0===t.length&&null!=n&&!n.isEnabled)&&(this._index=-1,this.clearForces(),this.clearVelocity(),this.wrappedWorld.removeActor(this))}}}]),e}();gAe.idCounter=0,gAe.sharedBodesMap=new Map;var yAe,SAe=function(){function e(){this.data=void 0,this.data={keys:[]}}var t=e.prototype;return t.get=function(e,t){if(e>t){var n=t;t=e,e=n}return this.data[e+"-"+t]},t.set=function(e,t,n){if(e>t){var i=t;t=e,e=i}var r=e+"-"+t;if(null==n){var o=this.data.keys.indexOf(r);if(-1!==o)return this.data.keys.splice(o,1),delete this.data[r],n}return this.get(e,t)||this.data.keys.push(r),this.data[r]=n,this.data[r]},t.reset=function(){this.data={keys:[]}},t.getLength=function(){return this.data.keys.length},t.getKeyByIndex=function(e){return this.data.keys[e]},t.getDataByKey=function(e){return this.data[e]},e}(),xAe=new bi,TAe=function(){function e(e){this.impl=null,this.event=void 0,this.event=e}var t=e.prototype;return t.getLocalPointOnA=function(e){dAe(this.impl,e,this.event.impl),gi.subtract(e,e,this.colliderA.node.worldPosition)},t.getLocalPointOnB=function(e){dAe(this.impl,e,this.event.impl),gi.subtract(e,e,this.colliderB.node.worldPosition)},t.getWorldPointOnA=function(e){dAe(this.impl,e,this.event.impl)},t.getWorldPointOnB=function(e){dAe(this.impl,e,this.event.impl)},t.getLocalNormalOnA=function(e){this.getWorldNormalOnA(e),bi.conjugate(xAe,this.colliderA.node.worldRotation),gi.transformQuat(e,e,xAe)},t.getLocalNormalOnB=function(e){this.getWorldNormalOnB(e),bi.conjugate(xAe,this.colliderB.node.worldRotation),gi.transformQuat(e,e,xAe)},t.getWorldNormalOnA=function(e){mAe(this.impl,e,this.event.impl),this.isBodyA||gi.negate(e,e)},t.getWorldNormalOnB=function(e){mAe(this.impl,e,this.event.impl)},B(e,[{key:"isBodyA",get:function(){return this.colliderA.uuid===this.event.selfCollider.uuid}}]),e}(),EAe=function(e){z(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this).scene=void 0,t.callback=PAe,t.wrappedBodies=[],t._isNeedFetch=!1,function(e){if(!Ybe.foundation){var t=Kbe.PX_PHYSICS_VERSION,n=new Kbe.PxDefaultAllocator,i=new Kbe.PxDefaultErrorCallback,r=Ybe.foundation=Kbe.PxCreateFoundation(t,n,i);Ybe.pvd=null;var o=new Kbe.PxTolerancesScale;Ybe.physics=Kbe.physics=Kbe.PxCreatePhysics(t,r,o,!1,Ybe.pvd),Ybe.cooking=Kbe.PxCreateCooking(t,r,new Kbe.PxCookingParams(o)),Kbe.PxInitExtensions(Ybe.physics,Ybe.pvd),Ybe.singleResult=new Kbe.PxRaycastHit,(Ybe.mutipleResults=new Kbe.PxRaycastHitVector).resize(Ybe.mutipleResultSize,Ybe.singleResult),Ybe.queryfilterData=new Kbe.PxQueryFilterData,Ybe.simulationCB=Kbe.PxSimulationEventCallback.implement(e.callback.eventCallback),Ybe.queryFilterCB=Kbe.PxQueryFilterCallback.implement(e.callback.queryCallback)}var a=Kbe.getDefaultSceneDesc(Ybe.physics.getTolerancesScale(),0,Ybe.simulationCB);e.scene=Ybe.physics.createScene(a)}(j(t)),t}return t.setAllowSleep=function(){},t.setDefaultMaterial=function(){},t.setGravity=function(e){this.scene.setGravity(e)},t.destroy=function(){this.wrappedBodies.length&&m("You should destroy all physics component first."),this.scene.release()},t.step=function(e){if(this._simulate(e),!Kbe.MULTI_THREAD){this._fetchResults();for(var t=0;t<this.wrappedBodies.length;t++)this.wrappedBodies[t].syncPhysicsToScene()}},t._simulate=function(e){var t;this._isNeedFetch||(t=e,this.scene.simulate(t,!0),this._isNeedFetch=!0)},t._fetchResults=function(){this._isNeedFetch&&(this.scene.fetchResults(!0),this._isNeedFetch=!1)},t.syncSceneToPhysics=function(){for(var e=0;e<this.wrappedBodies.length;e++)this.wrappedBodies[e].syncSceneToPhysics()},t.syncPhysicsToScene=function(){this._fetchResults();for(var e=0;e<this.wrappedBodies.length;e++)this.wrappedBodies[e].syncPhysicsToScene()},t.syncAfterEvents=function(){for(var e=0;e<this.wrappedBodies.length;e++)this.wrappedBodies[e].syncSceneWithCheck()},t.getSharedBody=function(e,t){return gAe.getSharedBody(e,this,t)},t.addActor=function(e){this.wrappedBodies.indexOf(e)<0&&(oAe(this.scene,e.impl),this.wrappedBodies.push(e))},t.removeActor=function(e){var t=this.wrappedBodies.indexOf(e);t>=0&&(this.scene.removeActor(e.impl,!0),Z(this.wrappedBodies,t))},t.addConstraint=function(){},t.removeConstraint=function(){},t.raycast=function(e,t,n,i){return function(e,t,n,i,r){var o=n.maxDistance,a=Vbe.ePOSITION|Vbe.eNORMAL,s=Hbe.QUERY_FILTER|(n.queryTrigger?0:Hbe.QUERY_CHECK_TRIGGER),c=jbe.eSTATIC|jbe.eDYNAMIC|jbe.ePREFILTER|jbe.eNO_BLOCK,l=Ybe.queryfilterData,u=Ybe.queryFilterCB,h=Ybe.mutipleResults;l.setWords(n.mask>>>0,0),l.setWords(s,3),l.setFlags(c);var _=h,f=e.scene.raycastMultiple(t.o,t.d,o,a,_,_.size(),l,u,null);if(f>0){for(var p=0;p<f;p++){var d=_.get(p),m=nAe(d.getShape()).collider,v=i.add();v._assign(d.position,d.distance,m,d.normal),r.push(v)}return!0}return-1===f&&console.error("not enough memory."),!1}(this,e,t,n,i)},t.raycastClosest=function(e,t,n){return function(e,t,n,i){n.maxDistance;var r=Vbe.ePOSITION|Vbe.eNORMAL,o=Hbe.QUERY_FILTER|(n.queryTrigger?0:Hbe.QUERY_CHECK_TRIGGER)|Hbe.QUERY_SINGLE_HIT,a=jbe.eSTATIC|jbe.eDYNAMIC|jbe.ePREFILTER,s=Ybe.queryfilterData,c=Ybe.queryFilterCB;s.setWords(n.mask>>>0,0),s.setWords(o,3),s.setFlags(a);var l=Ybe.singleResult;if(e.scene.raycastSingle(t.o,t.d,n.maxDistance,r,l,s,c,null)){var u=nAe(l.getShape()).collider;return i._assign(l.position,l.distance,u,l.normal),!0}return!1}(this,e,t,n)},t.emitEvents=function(){PAe.emitTriggerEvent(),PAe.emitCollisionEvent()},B(n,[{key:"impl",get:function(){return this.scene}}]),n}(Ybe),CAe=new SAe,bAe=new SAe,AAe=[],wAe=new SAe,RAe=[],IAe=[],PAe={eventCallback:{onContactBegin:function(e,t,n,i,r){var o=nAe(e),a=nAe(t);PAe.onCollision("onCollisionEnter",o,a,n,i,r)},onContactEnd:function(e,t,n,i,r){var o=nAe(e),a=nAe(t);PAe.onCollision("onCollisionExit",o,a,n,i,r)},onContactPersist:function(e,t,n,i,r){var o=nAe(e),a=nAe(t);PAe.onCollision("onCollisionStay",o,a,n,i,r)},onTriggerBegin:function(e,t){var n=nAe(e),i=nAe(t);PAe.onTrigger("onTriggerEnter",n,i,!0)},onTriggerEnd:function(e,t){var n=nAe(e),i=nAe(t);PAe.onTrigger("onTriggerExit",n,i,!1)}},queryCallback:{preFilter:function(e,t){var n=e.word3,i=t.getFlags();return n&Hbe.QUERY_CHECK_TRIGGER&&i.isSet(Kbe.ShapeFlag.eTRIGGER_SHAPE)?Kbe.QueryHitType.eNONE:n&Hbe.QUERY_SINGLE_HIT?Kbe.QueryHitType.eBLOCK:Kbe.QueryHitType.eTOUCH},preFilterForByteDance:function(e,t){var n=e.word3;return n&Hbe.QUERY_CHECK_TRIGGER&&t&Kbe.ShapeFlag.eTRIGGER_SHAPE?Kbe.QueryHitType.eNONE:n&Hbe.QUERY_SINGLE_HIT?Kbe.QueryHitType.eBLOCK:Kbe.QueryHitType.eTOUCH}},onTrigger:function(e,t,n,i){var r;t&&n&&(t.collider.needTriggerEvent||n.collider.needTriggerEvent)&&(AAe.length>0?((r=AAe.pop()).a=t,r.b=n,r.times=0):r={a:t,b:n,times:0},i?CAe.set(t.id,n.id,r):bAe.set(t.id,n.id,r))},emitTriggerEvent:function(){for(var e=bAe.getLength();e--;){var t=bAe.getKeyByIndex(e),n=bAe.getDataByKey(t);AAe.push(n);var i=CAe.getDataByKey(t);i&&(AAe.push(i),CAe.set(n.a.id,n.b.id,null));var r=n.a.collider,o=n.b.collider;if(r&&o){var a="onTriggerExit";kSe.type=a,r.needTriggerEvent&&(kSe.selfCollider=r,kSe.otherCollider=o,r.emit(a,kSe)),o.needTriggerEvent&&(kSe.selfCollider=o,kSe.otherCollider=r,o.emit(a,kSe))}}for(bAe.reset(),e=CAe.getLength();e--;){var s=CAe.getKeyByIndex(e),c=CAe.getDataByKey(s),l=c.a.collider,u=c.b.collider;if(l&&l.isValid&&u&&u.isValid){var h=c.times++?"onTriggerStay":"onTriggerEnter";kSe.type=h,l.needTriggerEvent&&(kSe.selfCollider=l,kSe.otherCollider=u,l.emit(h,kSe)),u.needTriggerEvent&&(kSe.selfCollider=u,kSe.otherCollider=l,u.emit(h,kSe))}else AAe.push(c),CAe.set(c.a.id,c.b.id,null)}},onCollision:function(e,t,n,i,r,o){if(t&&n&&(t.collider.needCollisionEvent||n.collider.needCollisionEvent))if(RAe.length>0){var a=RAe.pop();a.type=e,a.a=t,a.b=n,a.contactCount=i,a.buffer=r,a.offset=o,wAe.set(t.id,n.id,a)}else{var s={type:e,a:t,b:n,contactCount:i,buffer:r,offset:o};wAe.set(t.id,n.id,s)}},emitCollisionEvent:function(){for(var e=wAe.getLength();e--;){var t=wAe.getKeyByIndex(e),n=wAe.getDataByKey(t);RAe.push(n);var i=n.a.collider,r=n.b.collider;if(i&&i.isValid&&r&&r.isValid){GSe.type=n.type,GSe.impl=n.buffer;var o=n.contactCount,a=(n.buffer,n.offset),s=GSe.contacts;IAe.push.apply(IAe,s),s.length=0;for(var c=0;c<o;c++)if(IAe.length>0){var l=IAe.pop();l.colliderA=i,l.colliderB=r,l.impl=vAe(c,a),s.push(l)}else{var u=new TAe(GSe);u.colliderA=i,u.colliderB=r,u.impl=vAe(c,a),s.push(u)}i.needCollisionEvent&&(GSe.selfCollider=i,GSe.otherCollider=r,i.emit(GSe.type,GSe)),r.needCollisionEvent&&(GSe.selfCollider=r,GSe.otherCollider=i,r.emit(GSe.type,GSe))}}wAe.reset()}},OAe=new gi,DAe=function(){function e(){this.isSleepy=!1,this._isEnabled=!1,this._isUsingCCD=!1}var t=e.prototype;return t.initialize=function(e){this._rigidBody=e,this._sharedBody=qxe.instance.physicsWorld.getSharedBody(e.node,this),this._sharedBody.reference=!0},t.onEnable=function(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setType(this._rigidBody.type),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.enabled=!0},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.enabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.setType=function(e){this._sharedBody.setType(e)},t.setMass=function(e){this.isStatic||this._sharedBody.setMass(e)},t.setLinearDamping=function(e){this._sharedBody.setLinearDamping(e)},t.setAngularDamping=function(e){this._sharedBody.setAngularDamping(e)},t.useGravity=function(e){this.isStatic||this.impl.setActorFlag(Kbe.ActorFlag.eDISABLE_GRAVITY,!e)},t.useCCD=function(e){this.isStatic||(this.impl.setRigidBodyFlag(Kbe.RigidBodyFlag.eENABLE_CCD,e),this._isUsingCCD=e)},t.isUsingCCD=function(){return this._isUsingCCD},t.setLinearFactor=function(e){this.isStatic||(this.impl.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_LINEAR_X,!e.x),this.impl.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_LINEAR_Y,!e.y),this.impl.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_LINEAR_Z,!e.z))},t.setAngularFactor=function(e){this.isStatic||(this.impl.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_ANGULAR_X,!e.x),this.impl.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_ANGULAR_Y,!e.y),this.impl.setRigidDynamicLockFlag(Kbe.RigidDynamicLockFlag.eLOCK_ANGULAR_Z,!e.z))},t.setAllowSleep=function(e){if(!this.isStaticOrKinematic){var t=this.impl.getSleepThreshold(),n=e?Math.max(0,t-.001):t+4294967295;this.impl.setWakeCounter(n)}},t.wakeUp=function(){this.isInScene&&!this.isStatic&&this.impl.wakeUp()},t.sleep=function(){this.isInScene&&!this.isStatic&&this.impl.putToSleep()},t.clearState=function(){this.isInScene&&!this.isStatic&&(this.clearForces(),this.clearVelocity())},t.clearForces=function(){this.isInScene&&!this.isStatic&&this._sharedBody.clearForces()},t.clearVelocity=function(){this.isStatic||this._sharedBody.clearVelocity()},t.setSleepThreshold=function(e){this.isStatic||this.impl.setSleepThreshold(e)},t.getSleepThreshold=function(){return this.isStatic?0:this.impl.getSleepThreshold()},t.getLinearVelocity=function(e){this.isStatic||gi.copy(e,this.impl.getLinearVelocity())},t.setLinearVelocity=function(e){this.isStaticOrKinematic||this.impl.setLinearVelocity(e,!0)},t.getAngularVelocity=function(e){this.isStatic||gi.copy(e,this.impl.getAngularVelocity())},t.setAngularVelocity=function(e){this.isStaticOrKinematic||this.impl.setAngularVelocity(e,!0)},t.applyForce=function(e,t){if(this.isInScene&&!this.isStaticOrKinematic){this._sharedBody.syncSceneToPhysics();var n=t||gi.ZERO;hAe(!0,this.impl,e,n)}},t.applyLocalForce=function(e,t){if(this.isInScene&&!this.isStaticOrKinematic){this._sharedBody.syncSceneToPhysics();var n=t||gi.ZERO;hAe(!1,this.impl,e,n)}},t.applyImpulse=function(e,t){if(this.isInScene&&!this.isStaticOrKinematic){this._sharedBody.syncSceneToPhysics();var n=t||gi.ZERO;uAe(!0,this.impl,e,n)}},t.applyLocalImpulse=function(e,t){if(this.isInScene&&!this.isStaticOrKinematic){this._sharedBody.syncSceneToPhysics();var n=t||gi.ZERO;uAe(!1,this.impl,e,n)}},t.applyTorque=function(e){this.isInScene&&!this.isStaticOrKinematic&&_Ae(this.impl,e)},t.applyLocalTorque=function(e){this.isInScene&&!this.isStaticOrKinematic&&(this._sharedBody.syncSceneToPhysics(),gi.transformQuat(OAe,e,this._sharedBody.node.worldRotation),_Ae(this.impl,OAe))},t.setGroup=function(e){this._sharedBody.setGroup(e)},t.getGroup=function(){return this._sharedBody.getGroup()},t.addGroup=function(e){this._sharedBody.addGroup(e)},t.removeGroup=function(e){this._sharedBody.removeGroup(e)},t.setMask=function(e){this._sharedBody.setMask(e)},t.getMask=function(){return this._sharedBody.getMask()},t.addMask=function(e){this._sharedBody.addMask(e)},t.removeMask=function(e){this._sharedBody.removeMask(e)},B(e,[{key:"impl",get:function(){return this._sharedBody.impl}},{key:"isAwake",get:function(){return!(!this.isInScene||this.isStatic||this.impl.isSleeping())}},{key:"isSleeping",get:function(){return!(this.isInScene&&!this.isStatic)||this.impl.isSleeping()}},{key:"isEnabled",get:function(){return this._isEnabled}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isStatic",get:function(){return!this.impl||this._sharedBody.isStatic}},{key:"isStaticOrKinematic",get:function(){return!this.impl||this._sharedBody.isStatic||this._sharedBody.isKinematic}},{key:"isInScene",get:function(){return this._sharedBody.isInScene}}]),e}();!function(e){e[e.SPHERE=0]="SPHERE",e[e.BOX=1]="BOX",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.PLANE=5]="PLANE",e[e.TERRAIN=6]="TERRAIN",e[e.MESH=7]="MESH"}(yAe||(yAe={}));var MAe=function(){function e(t){this.id=void 0,this.type=void 0,this._impl=null,this._collider=null,this._flags=void 0,this._rotation=new bi(0,0,0,1),this._index=-1,this._word3=0,this._isEnabled=!1,this.type=t,this.id=e.idCounter++}var t=e.prototype;return t.initialize=function(e){var t,n;this._collider=e,this._flags=(t=(e.isTrigger?Kbe.PxShapeFlag.eTRIGGER_SHAPE.value:Kbe.PxShapeFlag.eSIMULATION_SHAPE.value)|Kbe.PxShapeFlag.eSCENE_QUERY_SHAPE.value,new Kbe.PxShapeFlags(t)),this._sharedBody=qxe.instance.physicsWorld.getSharedBody(e.node),this._sharedBody.reference=!0,this.onComponentSet(),(n=this._impl)&&n.$$&&(Kbe.IMPL_PTR[n.$$.ptr]=this)},t.setIndex=function(e){this._index=e},t.onComponentSet=function(){},t.updateScale=function(){},t.onLoad=function(){this.setMaterial(this._collider.sharedMaterial),this.setCenter(this._collider.center)},t.onEnable=function(){this.addToBody(),this._isEnabled=!0,this._sharedBody.enabled=!0},t.onDisable=function(){this.removeFromBody(),this._isEnabled=!1,this._sharedBody.enabled=!1},t.onDestroy=function(){var e;this._sharedBody.reference=!1,this._impl&&((e=this._impl)&&e.$$&&(Kbe.IMPL_PTR[e.$$.ptr]=null,delete Kbe.IMPL_PTR[e.$$.ptr]),this._impl.release(),this._impl=null),this._flags=null,this._collider=null},t.setMaterial=function(e){null==e&&(e=qxe.instance.defaultMaterial);var t,n=this.getSharedMaterial(e);this._impl.setMaterials((t=n,Kbe.VECTOR_MAT.size()>0?Kbe.VECTOR_MAT.set(0,t):Kbe.VECTOR_MAT.push_back(t),Kbe.VECTOR_MAT))},t.getSharedMaterial=function(e){if(!Kbe.CACHE_MAT[e.id]){var t=Ybe.physics.createMaterial(e.friction,e.friction,e.restitution);return t.setFrictionCombineMode(Kbe.CombineMode.eMULTIPLY),t.setRestitutionCombineMode(Kbe.CombineMode.eMULTIPLY),Kbe.CACHE_MAT[e.id]=t,t}var n=Kbe.CACHE_MAT[e.id];return n.setStaticFriction(e.friction),n.setDynamicFriction(e.friction),n.setRestitution(e.restitution),n},t.setAsTrigger=function(e){e?(this._impl.setFlag(Kbe.ShapeFlag.eSIMULATION_SHAPE,!e),this._impl.setFlag(Kbe.ShapeFlag.eTRIGGER_SHAPE,e)):(this._impl.setFlag(Kbe.ShapeFlag.eTRIGGER_SHAPE,e),this._impl.setFlag(Kbe.ShapeFlag.eSIMULATION_SHAPE,!e)),this._index>=0&&(this._sharedBody.removeShape(this),this._sharedBody.addShape(this))},t.setCenter=function(e){var t=eAe.translation,n=eAe.rotation;gi.multiply(t,e,this._collider.node.worldScale),bi.copy(n,this._rotation);var i=iAe(t,n);this._impl.setLocalPose(i),this._collider.enabled&&!this._collider.isTrigger&&this._sharedBody.updateCenterOfMass()},t.getAABB=function(e){!function(e,t,n,i){void 0===n&&(n=1.01);var r=e.getWorldBounds(t,n);Fc.fromPoints(i,r.minimum,r.maximum)}(this.impl,this._sharedBody.impl,1,e)},t.getBoundingSphere=function(e){Fc.toBoundingSphere(e,this._collider.worldBounds)},t.setGroup=function(e){this._sharedBody.setGroup(e)},t.getGroup=function(){return this._sharedBody.getGroup()},t.addGroup=function(e){this._sharedBody.addGroup(e)},t.removeGroup=function(e){this._sharedBody.removeGroup(e)},t.setMask=function(e){this._sharedBody.setMask(e)},t.getMask=function(){return this._sharedBody.getMask()},t.addMask=function(e){this._sharedBody.addMask(e)},t.removeMask=function(e){this._sharedBody.removeMask(e)},t.updateFilterData=function(e){this._word3=Hbe.DETECT_CONTACT_CCD,this._collider.needTriggerEvent&&(this._word3|=Hbe.DETECT_TRIGGER_EVENT),this._collider.needCollisionEvent&&(this._word3|=Hbe.DETECT_CONTACT_EVENT|Hbe.DETECT_CONTACT_POINT),e.word2=this.id,e.word3=this._word3,this.setFilerData(e)},t.updateEventListener=function(){this._sharedBody&&this.updateFilterData(this._sharedBody.filterData)},t.updateByReAdd=function(){this._isEnabled&&(this.removeFromBody(),this.addToBody())},t.setFilerData=function(e){this._impl.setQueryFilterData(e),this._impl.setSimulationFilterData(e)},t.addToBody=function(){this._sharedBody.addShape(this)},t.removeFromBody=function(){this._sharedBody.removeShape(this)},B(e,[{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}},{key:"attachedRigidBody",get:function(){return null}}],[{key:"MESH_SCALE",get:function(){return this._MESH_SCALE||(this._MESH_SCALE=new Kbe.MeshScale(gi.ZERO,bi.IDENTITY)),this._MESH_SCALE}}]),e}();MAe._MESH_SCALE=void 0,MAe.idCounter=0;var NAe=function(e){function t(){var n;return n=e.call(this,yAe.SPHERE)||this,t.SPHERE_GEOMETRY||(t.SPHERE_GEOMETRY=new Kbe.SphereGeometry(.5)),n}z(t,e);var n=t.prototype;return n.updateRadius=function(){this.updateScale()},n.onComponentSet=function(){this.updateGeometry();var e=this.getSharedMaterial(this.collider.sharedMaterial);this._impl=Ybe.physics.createShape(t.SPHERE_GEOMETRY,e,!0,this._flags)},n.updateScale=function(){this.updateGeometry(),this._impl.setGeometry(t.SPHERE_GEOMETRY),this.setCenter(this._collider.center)},n.updateGeometry=function(){var e=this.collider,n=Math.abs(_i(this.collider.node.worldScale));t.SPHERE_GEOMETRY.setRadius(Math.max(1e-4,e.radius*n))},B(t,[{key:"collider",get:function(){return this._collider}}]),t}(MAe);NAe.SPHERE_GEOMETRY=void 0;var LAe=function(e){function t(){var n;return n=e.call(this,yAe.BOX)||this,t.BOX_GEOMETRY||(USe.set(.5,.5,.5),t.BOX_GEOMETRY=new Kbe.BoxGeometry(USe)),n}z(t,e);var n=t.prototype;return n.updateSize=function(){this.updateScale()},n.onComponentSet=function(){this.updateGeometry();var e=this.getSharedMaterial(this._collider.sharedMaterial);this._impl=Ybe.physics.createShape(t.BOX_GEOMETRY,e,!0,this._flags)},n.updateScale=function(){this.updateGeometry(),this._impl.setGeometry(t.BOX_GEOMETRY),this.setCenter(this._collider.center)},n.updateGeometry=function(){var e=this.collider,n=e.node.worldScale;USe.set(e.size).multiplyScalar(.5).multiply(n),t.BOX_GEOMETRY.setHalfExtents(VSe(USe))},B(t,[{key:"collider",get:function(){return this._collider}}]),t}(MAe);LAe.BOX_GEOMETRY=void 0;var BAe=function(e){function t(){var n;return n=e.call(this,yAe.CAPSULE)||this,t.CAPSULE_GEOMETRY||(t.CAPSULE_GEOMETRY=new Kbe.CapsuleGeometry(.5,.5)),n}z(t,e);var n=t.prototype;return n.setCylinderHeight=function(){this.updateScale()},n.setDirection=function(){this.updateScale()},n.setRadius=function(){this.updateScale()},n.onComponentSet=function(){this.updateGeometry();var e=this.getSharedMaterial(this._collider.sharedMaterial);this._impl=Ybe.physics.createShape(t.CAPSULE_GEOMETRY,e,!0,this._flags)},n.updateScale=function(){this.updateGeometry(),this._impl.setGeometry(t.CAPSULE_GEOMETRY),this.setCenter(this._collider.center)},n.updateGeometry=function(){var e=this.collider,n=e.node.worldScale,i=e.direction,r=.5,o=.5;i===Iye.Y_AXIS?(r=e.radius*Math.abs(fi(n.x,n.z)),o=e.cylinderHeight/2*Math.abs(n.y),bi.fromEuler(this._rotation,0,0,90)):i===Iye.X_AXIS?(r=e.radius*Math.abs(fi(n.y,n.z)),o=e.cylinderHeight/2*Math.abs(n.x),bi.fromEuler(this._rotation,0,0,0)):(r=e.radius*Math.abs(fi(n.x,n.y)),o=e.cylinderHeight/2*Math.abs(n.z),bi.fromEuler(this._rotation,0,90,0)),t.CAPSULE_GEOMETRY.setRadius(Math.max(1e-4,r)),t.CAPSULE_GEOMETRY.setHalfHeight(Math.max(1e-4,o))},B(t,[{key:"collider",get:function(){return this._collider}}]),t}(MAe);BAe.CAPSULE_GEOMETRY=void 0;var FAe=function(e){function t(){var n;return n=e.call(this,yAe.PLANE)||this,t.PLANE_GEOMETRY||(t.PLANE_GEOMETRY=new Kbe.PlaneGeometry),n}z(t,e);var n=t.prototype;return n.setNormal=function(){this.setCenter()},n.setConstant=function(){this.setCenter()},n.setCenter=function(){var e=this.collider,t=eAe.translation,n=eAe.rotation;gi.scaleAndAdd(t,e.center,e.normal,e.constant),bi.rotationTo(n,gi.UNIT_X,e.normal);var i=iAe(t,n);this._impl.setLocalPose(i)},n.onComponentSet=function(){var e=this.collider,n=this.getSharedMaterial(e.sharedMaterial);this._impl=Ybe.physics.createShape(t.PLANE_GEOMETRY,n,!0,this._flags),this.setCenter()},n.updateScale=function(){this.setCenter()},B(t,[{key:"collider",get:function(){return this._collider}}]),t}(MAe);FAe.PLANE_GEOMETRY=void 0;var zAe=function(e){function t(){var t;return(t=e.call(this,yAe.MESH)||this).geometry=void 0,t}z(t,e);var n=t.prototype;return n.setMesh=function(e){if(e&&e.renderingSubMeshes.length>0&&null==this._impl){var t=Ybe.physics,n=this.collider,i=this.getSharedMaterial(n.sharedMaterial),r=MAe.MESH_SCALE;if(r.setScale(gi.ONE),r.setRotation(bi.IDENTITY),n.convex){if(null==Kbe.MESH_CONVEX[e._uuid]){var o=Ybe.cooking,a=e.readAttribute(0,lo.ATTR_POSITION);Kbe.MESH_CONVEX[e._uuid]=fAe(a,o,t)}var s=Kbe.MESH_CONVEX[e._uuid];this.geometry=new Kbe.ConvexMeshGeometry(s,r,pAe(0,!0))}else{if(null==Kbe.MESH_STATIC[e._uuid]){var c=Ybe.cooking,l=e.readAttribute(0,lo.ATTR_POSITION),u=e.readIndices(0);Kbe.MESH_STATIC[e._uuid]=function(e,t,n,i){for(var r=e.length,o=t.length,a=new Kbe.PxVec3Vector,s=0;s<r;s+=3)a.push_back({x:e[s],y:e[s+1],z:e[s+2]});for(var c=new Kbe.PxU16Vector,l=0;l<o;l+=3)c.push_back(t[l]),c.push_back(t[l+1]),c.push_back(t[l+2]);var u=n.createTriMeshExt(a,c,i);return a.delete(),c.delete(),u}(l,u,c,t)}var h=Kbe.MESH_STATIC[e._uuid];this.geometry=new Kbe.TriangleMeshGeometry(h,r,pAe(0,!1))}this.updateGeometry(),this._impl=t.createShape(this.geometry,i,!0,this._flags),this.updateByReAdd()}},n.onComponentSet=function(){this.setMesh(this.collider.mesh)},n.updateScale=function(){this.updateGeometry(),this.setCenter(this._collider.center)},n.updateGeometry=function(){var e=MAe.MESH_SCALE;e.setScale(this.collider.node.worldScale),e.setRotation(bi.IDENTITY),this.geometry.setScale(e)},n.setMaterial=function(t){this._impl&&e.prototype.setMaterial.call(this,t)},n.setCenter=function(t){this._impl&&e.prototype.setCenter.call(this,t)},n.setAsTrigger=function(t){this._impl&&e.prototype.setAsTrigger.call(this,t)},n.setFilerData=function(t){this._impl&&e.prototype.setFilerData.call(this,t)},n.addToBody=function(){this._impl&&e.prototype.addToBody.call(this)},n.removeFromBody=function(){this._impl&&e.prototype.removeFromBody.call(this)},B(t,[{key:"collider",get:function(){return this._collider}}]),t}(MAe),UAe=function(e){function t(){return e.call(this,yAe.TERRAIN)||this}z(t,e);var n=t.prototype;return n.setTerrain=function(e){if(e&&null==this._impl){var n=Ybe.physics,i=this.collider;if(null==Kbe.TERRAIN_STATIC[e._uuid]){var r=Ybe.cooking;Kbe.TERRAIN_STATIC[e._uuid]=function(e,t,n,i){for(var r=e.getVertexCountI(),o=e.getVertexCountJ(),a=new Kbe.PxHeightFieldSampleVector,s=0;s<r;s++)for(var c=0;c<o;c++){var l=new Kbe.PxHeightFieldSample;l.height=e.getHeight(s,c)/t,a.push_back(l)}return n.createHeightFieldExt(r,o,a,i)}(e,t.heightScale,r,n)}var o=Kbe.TERRAIN_STATIC[e._uuid],a=this.getSharedMaterial(i.sharedMaterial),s=function(e,t,n,i,r){return new Kbe.PxHeightFieldGeometry(e,new Kbe.PxMeshGeometryFlags(0),n,i,r)}(o,0,t.heightScale,e.tileSize,e.tileSize);this._impl=n.createShape(s,a,!0,this._flags),this.updateByReAdd()}},n.onComponentSet=function(){this.setTerrain(this.collider.terrain)},n.updateScale=function(){this.setCenter(this._collider.center)},n.setCenter=function(e){this._impl&&this._impl.setLocalPose(iAe(e,this._rotation))},n.setMaterial=function(t){this._impl&&e.prototype.setMaterial.call(this,t)},n.setAsTrigger=function(t){this._impl&&e.prototype.setAsTrigger.call(this,t)},n.setFilerData=function(t){this._impl&&e.prototype.setFilerData.call(this,t)},n.addToBody=function(){this._impl&&e.prototype.addToBody.call(this)},n.removeFromBody=function(){this._impl&&e.prototype.removeFromBody.call(this)},B(t,[{key:"collider",get:function(){return this._collider}}]),t}(MAe);UAe.heightScale=2e-4;var kAe=function(e){function t(){var t;return(t=e.call(this,yAe.CYLINDER)||this).geometry=void 0,t}z(t,e);var n=t.prototype;return n.setRadius=function(){this.updateGeometry()},n.setHeight=function(){this.updateGeometry()},n.setDirection=function(){this.updateGeometry()},n.onComponentSet=function(){var e=this.collider,n=Ybe.physics;if(!t.CONVEX_MESH){var i=Ybe.cooking,r=RSe(.5,.5,2,{radialSegments:32,heightSegments:1});t.CONVEX_MESH=fAe(r.positions,i,n)}var o=MAe.MESH_SCALE;o.setScale(gi.ONE),o.setRotation(bi.IDENTITY);var a=t.CONVEX_MESH,s=this.getSharedMaterial(e.sharedMaterial);this.geometry=new Kbe.ConvexMeshGeometry(a,o,pAe(0,!0)),this.updateGeometry(),this._impl=n.createShape(this.geometry,s,!0,this._flags)},n.updateScale=function(){this.updateGeometry(),this.setCenter(this._collider.center)},n.updateGeometry=function(){var e=this.collider,t=e.radius,n=e.height,i=e.direction,r=eAe.translation;gi.copy(r,e.node.worldScale),r.y*=Math.max(1e-4,n/2);var o=Math.max(1e-4,t/.5);r.x*=o,r.z*=o;var a=eAe.rotation;switch(i){case Iye.X_AXIS:bi.fromEuler(a,0,0,90);break;case Iye.Y_AXIS:default:bi.copy(a,bi.IDENTITY);break;case Iye.Z_AXIS:bi.fromEuler(a,90,0,0)}var s=MAe.MESH_SCALE;s.setScale(r),s.setRotation(a),this.geometry.setScale(s),bi.copy(this._rotation,a)},B(t,[{key:"collider",get:function(){return this._collider}}]),t}(MAe);kAe.CONVEX_MESH=void 0;var GAe=function(e){function t(){var t;return(t=e.call(this,yAe.CONE)||this).geometry=void 0,t}z(t,e);var n=t.prototype;return n.setRadius=function(){this.updateGeometry()},n.setHeight=function(){this.updateGeometry()},n.setDirection=function(){this.updateGeometry()},n.onComponentSet=function(){var e=this.collider,n=Ybe.physics;if(!t.CONVEX_MESH){var i=Ybe.cooking,r=RSe(0,.5,1,{radialSegments:32,heightSegments:1});t.CONVEX_MESH=fAe(r.positions,i,n)}var o=MAe.MESH_SCALE;o.setScale(gi.ONE),o.setRotation(bi.IDENTITY);var a=t.CONVEX_MESH,s=this.getSharedMaterial(e.sharedMaterial);this.geometry=new Kbe.ConvexMeshGeometry(a,o,pAe(0,!0)),this.updateGeometry(),this._impl=n.createShape(this.geometry,s,!0,this._flags)},n.updateScale=function(){this.updateGeometry(),this.setCenter(this._collider.center)},n.updateGeometry=function(){var e=this.collider,t=e.radius,n=e.height,i=e.direction,r=eAe.translation;gi.copy(r,e.node.worldScale),r.y*=Math.max(1e-4,n/1);var o=Math.max(1e-4,t/.5);r.x*=o,r.z*=o;var a=eAe.rotation;switch(i){case Iye.X_AXIS:bi.fromEuler(a,0,0,90);break;case Iye.Y_AXIS:default:bi.copy(a,bi.IDENTITY);break;case Iye.Z_AXIS:bi.fromEuler(a,90,0,0)}var s=MAe.MESH_SCALE;s.setScale(r),s.setRotation(a),this.geometry.setScale(s),bi.copy(this._rotation,a)},B(t,[{key:"collider",get:function(){return this._collider}}]),t}(MAe);GAe.CONVEX_MESH=void 0;var HAe=function(){function e(){}var t=e.prototype;return t.setConnectedBody=function(){},t.setEnableCollision=function(e){this._impl.setConstraintFlag(8,e)},t.initialize=function(e){this._com=e,this._rigidBody=e.attachedBody,this.onComponentSet(),this.setEnableCollision(this._com.enableCollision),this._impl.$$&&(Kbe.IMPL_PTR[this._impl.$$.ptr]=this)},t.onComponentSet=function(){},t.updateScale0=function(){},t.updateScale1=function(){},t.onEnable=function(){var e=this._rigidBody.body.sharedBody,t=this._com.connectedBody;if(e.addJoint(this,0),t){var n=t.body.sharedBody;aAe(this._impl,e.impl,n.impl),n.addJoint(this,1)}else aAe(this._impl,e.impl,null)},t.onDisable=function(){aAe(this._impl,e.tempActor,null),this._rigidBody.body.sharedBody.removeJoint(this,0);var t=this.constraint.connectedBody;t&&t.body.sharedBody.removeJoint(this,1)},t.onDestroy=function(){this._impl.$$&&(Kbe.IMPL_PTR[this._impl.$$.ptr]=null,delete Kbe.IMPL_PTR[this._impl.$$.ptr]),this._impl.release(),this._com=null,this._rigidBody=null,this._impl=null},B(e,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}],[{key:"tempActor",get:function(){return this._tempActor||(this._tempActor=Ybe.physics.createRigidDynamic(tAe)),this._tempActor}}]),e}();HAe._tempActor=void 0;var VAe,jAe,WAe,qAe,XAe,YAe,KAe,QAe,ZAe,JAe=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.setPivotA=function(){var e=this.constraint,t=eAe.translation,n=eAe.rotation;gi.multiply(t,e.node.worldScale,e.pivotA),bi.copy(n,bi.IDENTITY),this._impl.setLocalPose(0,iAe(t,n)),e.connectedBody||this.setPivotB(e.pivotB)},n.setPivotB=function(){var e=this.constraint,t=e.connectedBody,n=eAe.translation,i=eAe.rotation;if(gi.copy(n,e.pivotB),bi.copy(i,bi.IDENTITY),t)gi.multiply(n,t.node.worldScale,e.pivotB);else{var r=e.node;gi.multiply(n,r.worldScale,e.pivotA),gi.add(n,n,r.worldPosition),gi.add(n,n,e.pivotB),bi.multiply(i,i,r.worldRotation)}this._impl.setLocalPose(1,iAe(n,i))},n.onComponentSet=function(){this._impl=Kbe.createDistanceJoint(HAe.tempActor,tAe,null,tAe),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},B(t,[{key:"constraint",get:function(){return this._com}}]),t}(HAe),$Ae=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.setPivotA=function(){var e=this.constraint,t=eAe.translation,n=eAe.rotation;gi.multiply(t,e.node.worldScale,e.pivotA),bi.rotationTo(n,gi.UNIT_X,e.axis),this._impl.setLocalPose(0,iAe(t,n)),e.connectedBody||this.setPivotB(e.pivotB)},n.setPivotB=function(){var e=this.constraint,t=e.connectedBody,n=eAe.translation,i=eAe.rotation;if(bi.rotationTo(i,gi.UNIT_X,e.axis),t)gi.multiply(n,t.node.worldScale,e.pivotB);else{var r=e.node;gi.multiply(n,r.worldScale,e.pivotA),gi.add(n,n,r.worldPosition),gi.add(n,n,e.pivotB),bi.multiply(i,i,r.worldRotation)}this._impl.setLocalPose(1,iAe(n,i))},n.setAxis=function(){this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},n.onComponentSet=function(){this._impl=Kbe.createRevoluteJoint(HAe.tempActor,tAe,null,tAe),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},B(t,[{key:"constraint",get:function(){return this._com}}]),t}(HAe);ZM.once(QM.EVENT_ENGINE_INITED,(function(){iSe.register("physx",{PhysicsWorld:EAe,RigidBody:DAe,BoxShape:LAe,SphereShape:NAe,CapsuleShape:BAe,TrimeshShape:zAe,CylinderShape:kAe,ConeShape:GAe,TerrainShape:UAe,PlaneShape:FAe,PointToPointConstraint:JAe,HingeConstraint:$Ae})})),Fn(qxe,"PhysicsSystem",[{name:"ins",newName:"instance"},{name:"PHYSICS_AMMO",newName:"PHYSICS_BULLET"}]),Fn(qxe.prototype,"PhysicsSystem.prototype",[{name:"deltaTime",newName:"fixedTimeStep"},{name:"maxSubStep",newName:"maxSubSteps"}]),zn(qxe.prototype,"PhysicsSystem.prototype",[{name:"useFixedTime"},{name:"useCollisionMatrix"},{name:"updateCollisionMatrix"},{name:"resetCollisionMatrix"},{name:"isCollisionGroup"},{name:"setCollisionGroup"}]),Fn(CTe.prototype,"Collider.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"},{name:"TYPE",newName:"type"}]),Fn(CTe,"Collider",[{name:"EColliderType",newName:"Type"},{name:"EAxisDirection",newName:"Axis"}]),Fn(Ibe,"Constraint",[{name:"EConstraintType",newName:"Type"}]),Fn(FCe.prototype,"BoxCollider.prototype",[{name:"boxShape",newName:"shape"}]),Fn(zCe.prototype,"SphereCollider.prototype",[{name:"sphereShape",newName:"shape"}]),Fn(UCe.prototype,"CapsuleCollider.prototype",[{name:"capsuleShape",newName:"shape"}]),Fn(dTe.prototype,"RigidBody.prototype",[{name:"rigidBody",newName:"body"}]),Fn(dTe,"RigidBody",[{name:"ERigidBodyType",newName:"Type"}]),zn(dTe.prototype,"RigidBody.prototype",[{name:"fixedRotation"}]),r.RigidBodyComponent=dTe,He.setClassAlias(dTe,"cc.RigidBodyComponent"),r.ColliderComponent=CTe,He.setClassAlias(CTe,"cc.ColliderComponent"),r.BoxColliderComponent=FCe,He.setClassAlias(FCe,"cc.BoxColliderComponent"),r.SphereColliderComponent=zCe,He.setClassAlias(zCe,"cc.SphereColliderComponent"),He.setClassAlias(UCe,"cc.CapsuleColliderComponent"),He.setClassAlias(HCe,"cc.MeshColliderComponent"),He.setClassAlias(kCe,"cc.CylinderColliderComponent"),r.PhysicMaterial=$Se,He.setClassAlias($Se,"cc.PhysicMaterial"),r.physics=Gbe,function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(ZAe||(ZAe={})),Je(ZAe);var ewe=e("Primitive",(VAe=al("cc.Primitive"),jAe=Gl(ZAe),VAe((QAe=KAe=function(e){function t(t){var n;return void 0===t&&(t=ZAe.BOX),X(n=e.call(this)||this,"type",XAe,j(n)),X(n,"info",YAe,j(n)),n.type=t,n}return z(t,e),t.prototype.onLoaded=function(){Pj(zSe[ZAe[this.type].toLowerCase()](this.info),this)},t}(Tj),KAe.PrimitiveType=ZAe,XAe=Y((qAe=QAe).prototype,"type",[jAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZAe.BOX}}),YAe=Y(qAe.prototype,"info",[_l,El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),WAe=qAe))||WAe));r.Primitive=ewe,r.primitives=zSe;var twe,nwe,iwe,rwe,owe=function(){function e(e,t,n){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=n}var t=e.prototype;return t.sample=function(e){this._average(this._value,e)},t.human=function(){var e=this._opts,t=e.average,n=e.isInteger,i=t?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100},t.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},t._average=function(e,t){if(void 0===t&&(t=0),this._opts.average){this._accumValue+=e,++this._accumSamples;var n=t;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}},B(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),e}(),awe=al("cc.PerfCounter")(twe=function(e){function t(t,n,i){var r;return(r=e.call(this,t,n,i)||this)._time=void 0,r._time=i,r}z(t,e);var n=t.prototype;return n.start=function(e){void 0===e&&(e=0),this._time=e},n.end=function(e){void 0===e&&(e=0),this._value=e-this._time,this._average(this._value)},n.tick=function(){this.end(),this.start()},n.frame=function(e){var t=e,n=t-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=t,this._average(this._value))},t}(owe))||twe,swe="0123456789. ",cwe=500,lwe={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},uwe={fps:{desc:"Framerate (FPS)",below:30,average:cwe,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:cwe},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:cwe,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:cwe},render:{desc:"Renderer (ms)",min:0,max:50,average:cwe,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},hwe=e("Profiler",function(){function e(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new So,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(uwe).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var t=e.prototype;return t.isShowingStats=function(){return this._showFPS},t.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),r.game.off(r.Game.EVENT_RESTART,this.generateNode,this),r.director.off(r.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),r.director.off(r.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),r.director.off(r.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),r.director.off(r.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),r.director.off(r.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),r.director.off(r.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,r.game.config.showFPS=!1)},t.showStats=function(){if(!this._showFPS){if(!this._device){var e=r.director.root;this._device=e.device,this._swapchain=e.mainWindow.swapchain,this._pipeline=e.pipeline}this.generateCanvas(),this.generateStats(),r.game.once(r.Game.EVENT_ENGINE_INITED,this.generateNode,this),r.game.on(r.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),r.director.on(r.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),r.director.on(r.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),r.director.on(r.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),r.director.on(r.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),r.director.on(r.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),r.director.on(r.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,r.game.config.showFPS=!0}},t.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Oo(Or.TEX2D,Dr.SAMPLED|Dr.TRANSFER_DST,Cr.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},t.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var n in uwe){var i=uwe[n];this._ctx.fillText(i.desc,0,t*this._lineHeight),i.counter=new awe(n,i,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<swe.length;++r){var o=this._ctx.measureText(swe[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(var a=0;a<swe.length;++a)this._ctx.fillText(swe[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=uwe,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},t.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new $b("PROFILER_NODE"),r.game.addPersistRootNode(this._rootNode);var e=new $b("Profiler_Root");e.parent=this._rootNode;for(var t=.4,n=t/this._totalLines,i=t/this._wordHeight,o=n/23,a=this._eachNumWidth*this._canvas.width*o,s=[0,t,0,i,t,0,i,0,0,0,0,0],c=[0,2,1,0,3,2],l=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],u=0,h=0;h<this._totalLines;h++)for(var _=0;_<8;_++){s.push(i+_*a,t-h*n,0),s.push(i+(_+1)*a,t-h*n,0),s.push(i+(_+1)*a,t-(h+1)*n,0),s.push(i+_*a,t-(h+1)*n,0),u=4*(8*h+_+1),c.push(0+u,2+u,1+u,0+u,3+u,2+u);var f=8*h+_,p=Math.floor(f/4),d=f-4*p;l.push(0,this._wordHeight,p,d),l.push(this._eachNumWidth,this._wordHeight,p,d),l.push(this._eachNumWidth,1,p,d),l.push(0,1,p,d)}this._meshRenderer=e.addComponent(TW),this._meshRenderer.mesh=Pj({positions:s,indices:c,colors:l});var m=new Mg;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),S=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[S],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=kp.Enum.PROFILER,this._inited=!0}},t.beforeUpdate=function(){if(this._stats){var e=performance.now();this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}},t.afterUpdate=function(){if(this._stats){var e=performance.now();r.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}},t.beforePhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}},t.afterPhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}},t.beforeDraw=function(){if(this._stats&&this._inited){var e=this._swapchain.surfaceTransform,t=this._device.capabilities.clipSpaceSignY;if(e!==this.offsetData[3]){var n=Di[e],i=-.9*t;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=e}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}},t.afterDraw=function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.frame.counter.end(e),this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),!(e-this.lastTime<cwe)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var o=this._stats[r];o.counter.sample(e);for(var a=o.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=a[a.length-(8-s)],u=lwe[l];void 0===u&&(u=11),i[c]=u}n++}}}},e}()),_we=e("profiler",new hwe);r.profiler=_we,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(nwe||(nwe={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(iwe||(iwe={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(rwe||(rwe={}));var fwe,pwe=0;function dwe(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(t.args)).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&dwe(e,n)})).catch((function(){})))}function mwe(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=pwe++,o=e;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),t),dwe(o,o._operationQueue[0])}))}}function vwe(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var gwe,ywe,Swe=function(){function e(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=e,e.volume=t}var t=e.prototype;return t.play=function(){var e=this;vwe(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))},t.stop=function(){this._domAudio.pause()},B(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}}]),e}(),xwe=(Y((fwe=function(){function e(e){var t=this;this._domAudio=void 0,this._state=rwe.INIT,this._onEnded=void 0,this._eventTarget=new fn,this._operationQueue=[],this._domAudio=e,pn.on("hide",this._onHide,this),pn.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch((function(){})),t._state=rwe.INIT,t._eventTarget.emit(nwe.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var t=e.prototype;return t.destroy=function(){pn.off("hide",this._onHide,this),pn.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";pn.os===un.IOS?r="loadedmetadata":pn.browserType===sn.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),t(i)},c=function(){a(),n("load audio failure - "+e)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new Swe(e,n);i(t)})).catch(r)}))},t._onHide=function(){var e=this;this._state===rwe.PLAYING&&this.pause().then((function(){e._state=rwe.INTERRUPTED,e._eventTarget.emit(nwe.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===rwe.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(nwe.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){return e=Zn(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},t.play=function(){var e=this;return new Promise((function(t){vwe(e._domAudio).then((function(){e._state=rwe.PLAYING,t()})).catch((function(){}))}))},t.pause=function(){return this._domAudio.pause(),this._state=rwe.PAUSED,Promise.resolve()},t.stop=function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=rwe.STOPPED,t()}))},t.onInterruptionBegin=function(e){this._eventTarget.on(nwe.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(nwe.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(nwe.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(nwe.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(nwe.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(nwe.ENDED,e)},B(e,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return iwe.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=Jn(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),e}()).prototype,"seek",[mwe],Object.getOwnPropertyDescriptor(fwe.prototype,"seek"),fwe.prototype),Y(fwe.prototype,"play",[mwe],Object.getOwnPropertyDescriptor(fwe.prototype,"play"),fwe.prototype),Y(fwe.prototype,"pause",[mwe],Object.getOwnPropertyDescriptor(fwe.prototype,"pause"),fwe.prototype),Y(fwe.prototype,"stop",[mwe],Object.getOwnPropertyDescriptor(fwe.prototype,"stop"),fwe.prototype),fwe),Twe=function(){function e(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e}var t=e.prototype;return t.destroy=function(){this._nativeAudio=void 0},t._now=function(){return performance.now()/1e3},t._calculateCurrentTime=function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration},t.start=function(){this._isPaused=!1,this._startTime=this._now()},t.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},t.stop=function(){this._isPaused=!0,this._startOffset=0},t.seek=function(e){this._startTime=this._now(),this._startOffset=Zn(e,0,this.duration)},B(e,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),e}(),Ewe=new(function(){function e(){this._audioBufferDataMap={}}var t=e.prototype;return t.addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},t.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},t.getCache=function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer},t.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},e}()),Cwe=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,bwe=function(){function e(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var t=e.prototype;return t.decodeAudioData=function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))},t.runContext=function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))},t.createBufferSource=function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n},t.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},t.setGainValue=function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t},t.connectContext=function(e){this._context&&e.connect(this._context.destination)},B(e,[{key:"currentTime",get:function(){return this._context.currentTime}}]),e}();bwe.support=!!Cwe,bwe.support&&(ywe=new bwe);var Awe,wwe,Rwe,Iwe,Pwe,Owe=function(){function e(e,t,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=n,this._bufferSourceNode=ywe.createBufferSource(e,!1);var i=ywe.createGain(t);this._bufferSourceNode.connect(i),ywe.connectContext(i)}var t=e.prototype;return t.play=function(){var e=this;this._bufferSourceNode.start(),ywe.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;Ewe.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))},t.stop=function(){clearTimeout(this._currentTimer),Ewe.tryReleasingCache(this._url),this._bufferSourceNode.stop()},B(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]),e}(),Dwe=(Y((gwe=function(){function e(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=rwe.INIT,this._audioTimer=void 0,this._eventTarget=new fn,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new Twe(e),this._gainNode=ywe.createGain(),ywe.connectContext(this._gainNode),this._src=t,pn.on("hide",this._onHide,this),pn.on("show",this._onShow,this)}var t=e.prototype;return t.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),Ewe.tryReleasingCache(this._src),pn.off("hide",this._onHide,this),pn.off("show",this._onShow,this)},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=Ewe.getCache(e);if(i)return Ewe.retainCache(e),void t(i);var r=new XMLHttpRequest,o="load audio failed: "+e+", status: ";r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?ywe.decodeAudioData(r.response).then((function(n){Ewe.addCache(e,n),t(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new Owe(e,n,t);i(r)})).catch(r)}))},t._onHide=function(){var e=this;this._state===rwe.PLAYING&&this.pause().then((function(){e._state=rwe.INTERRUPTED,e._eventTarget.emit(nwe.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===rwe.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(nwe.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===rwe.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))},t.play=function(){return this._doPlay()},t._doPlay=function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=ywe.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),ywe.runContext().then((function(){e._state=rwe.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(nwe.ENDED),e._state=rwe.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))},t._stopSourceNode=function(){try{var e;null===(e=this._sourceNode)||void 0===e||e.stop()}catch(e){}},t.pause=function(){return this._state===rwe.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=rwe.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=rwe.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.onInterruptionBegin=function(e){this._eventTarget.on(nwe.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(nwe.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(nwe.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(nwe.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(nwe.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(nwe.ENDED,e)},B(e,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return iwe.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=Jn(e),this._volume=e,ywe.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),e}()).prototype,"seek",[mwe],Object.getOwnPropertyDescriptor(gwe.prototype,"seek"),gwe.prototype),Y(gwe.prototype,"play",[mwe],Object.getOwnPropertyDescriptor(gwe.prototype,"play"),gwe.prototype),Y(gwe.prototype,"pause",[mwe],Object.getOwnPropertyDescriptor(gwe.prototype,"pause"),gwe.prototype),Y(gwe.prototype,"stop",[mwe],Object.getOwnPropertyDescriptor(gwe.prototype,"stop"),gwe.prototype),gwe),Mwe=function(){function e(e){this._audio=void 0,this._audio=e}var t=e.prototype;return t.play=function(){this._audio.play()},t.stop=function(){this._audio.stop()},B(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),e}(),Nwe=function(){function e(e){this._player=void 0,this._player=e}e.load=function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==iwe.DOM_AUDIO&&bwe.support?Dwe.load(t).then((function(t){i(new e(t))})).catch((function(){})):(bwe.support||b(5201),xwe.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))};var t=e.prototype;return t.destroy=function(){this._player.destroy()},e.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==iwe.DOM_AUDIO&&bwe.support?Dwe.loadNative(e):(bwe.support||b(5201),xwe.loadNative(e))},e.loadOneShotAudio=function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==iwe.DOM_AUDIO&&bwe.support?Dwe.loadOneShotAudio(e,t).then((function(e){i(new Mwe(e))})).catch(r):(bwe.support||b(5201),xwe.loadOneShotAudio(e,t).then((function(e){i(new Mwe(e))})).catch(r))}))},t.seek=function(e){return this._player.seek(e)},t.play=function(){return this._player.play()},t.pause=function(){return this._player.pause()},t.stop=function(){return this._player.stop()},t.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},t.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},t.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},t.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},t.onEnded=function(e){this._player.onEnded(e)},t.offEnded=function(e){this._player.offEnded(e)},B(e,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),e}();Nwe.maxAudioChannel=24;var Lwe=e("AudioClip",al("cc.AudioClip")((Pwe=Iwe=function(e){function t(){var t;return X(t=e.call(this)||this,"_duration",Rwe,j(t)),t._loadMode=iwe.UNKNOWN_AUDIO,t._meta=null,t._player=void 0,t}z(t,e);var n=t.prototype;return n.destroy=function(){var t,n=e.prototype.destroy.call(this);return null===(t=this._player)||void 0===t||t.destroy(),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))},n.setVolume=function(e){this._player&&(this._player.volume=e)},n.setLoop=function(e){this._player&&(this._player.loop=e)},n.play=function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))},n.pause=function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))},n.stop=function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))},n.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&Nwe.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))},B(t,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=iwe.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:rwe.INIT}}]),t}(Fu),Iwe.AudioType=iwe,Rwe=Y((wwe=Pwe).prototype,"_duration",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y(wwe.prototype,"_nativeDep",[Zl],Object.getOwnPropertyDescriptor(wwe.prototype,"_nativeDep"),wwe.prototype),Awe=wwe))||Awe);function Bwe(e,t,n){Nwe.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function Fwe(e,t,n,i){var r=new Lwe;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}r.AudioClip=Lwe,VN.register({".mp3":Bwe,".ogg":Bwe,".wav":Bwe,".m4a":Bwe}),QN.register({".mp3":Fwe,".ogg":Fwe,".wav":Fwe,".m4a":Fwe});var zwe,Uwe,kwe,Gwe,Hwe,Vwe,jwe,Wwe,qwe,Xwe,Ywe,Kwe,Qwe,Zwe,Jwe,$we,eRe,tRe,nRe,iRe=new(function(){function e(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var t=e.prototype;return t._findIndex=function(e,t){return e.findIndex((function(e){return e.audio===t}))},t._tryAddPlaying=function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},t.addPlaying=function(e){if(e instanceof Nwe){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)},t._tryRemovePlaying=function(e,t){var n=this._findIndex(e,t);return-1!==n&&(Z(e,n),!0)},t.removePlaying=function(e){if(e instanceof Nwe){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)},t.discardOnePlayingIfNeeded=function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<Nwe.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))},e}());!function(e){e.STARTED="started",e.ENDED="ended"}(nRe||(nRe={}));var rRe=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((zwe=al("cc.AudioSource"),Uwe=Tl(),kwe=gl(),Gwe=Gl(Lwe),Hwe=Gl(Lwe),Vwe=wl(),jwe=wl(),Wwe=wl(),qwe=Rl(),Xwe=wl(),zwe(Ywe=Uwe(Ywe=kwe((tRe=eRe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return X(t=e.call.apply(e,[this].concat(i))||this,"_clip",Qwe,j(t)),t._player=null,X(t,"_loop",Zwe,j(t)),X(t,"_playOnAwake",Jwe,j(t)),X(t,"_volume",$we,j(t)),t._cachedCurrentTime=0,t._operationsBeforeLoading=[],t._isLoaded=!1,t._lastSetClip=void 0,t}z(t,e);var n=t.prototype;return n._syncPlayer=function(){var e=this,t=this._clip;this._isLoaded=!1,t&&this._lastSetClip!==t&&(t._nativeAsset?(this._lastSetClip=t,Nwe.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t&&(e._isLoaded=!0,e._player&&(e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){iRe.removePlaying(n),e.node.emit(nRe.ENDED,e)})),n.onInterruptionBegin((function(){iRe.removePlaying(n)})),n.onInterruptionEnd((function(){iRe.addPlaying(n)})),e._syncStates())})).catch((function(){}))):console.error("Invalid audio clip"))},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()},n.onDestroy=function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy()},n._getRootNode=function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var e,t,n=this;this._isLoaded?(iRe.discardOnePlayingIfNeeded(),this.state===rwe.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){iRe.addPlaying(n._player),n.node.emit(nRe.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){iRe.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){iRe.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?Nwe.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){iRe.discardOnePlayingIfNeeded(),e.onPlay=function(){iRe.addPlaying(e)},e.onEnd=function(){iRe.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))},B(t,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=Zn(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=Zn(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:rwe.INIT}},{key:"playing",get:function(){return this.state===t.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return Nwe.maxAudioChannel}}]),t}(rh),eRe.AudioState=rwe,eRe.EventType=nRe,Qwe=Y((Kwe=tRe).prototype,"_clip",[Gwe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zwe=Y(Kwe.prototype,"_loop",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jwe=Y(Kwe.prototype,"_playOnAwake",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$we=Y(Kwe.prototype,"_volume",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Y(Kwe.prototype,"clip",[Hwe,Vwe],Object.getOwnPropertyDescriptor(Kwe.prototype,"clip"),Kwe.prototype),Y(Kwe.prototype,"loop",[jwe],Object.getOwnPropertyDescriptor(Kwe.prototype,"loop"),Kwe.prototype),Y(Kwe.prototype,"playOnAwake",[Wwe],Object.getOwnPropertyDescriptor(Kwe.prototype,"playOnAwake"),Kwe.prototype),Y(Kwe.prototype,"volume",[qwe,Xwe],Object.getOwnPropertyDescriptor(Kwe.prototype,"volume"),Kwe.prototype),Ywe=Kwe))||Ywe)||Ywe)||Ywe));Fn(Lwe,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:rRe,targetName:"AudioSource"}]),Un(Lwe.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(e){return{name:e,suggest:"please use AudioSource.prototype."+e+" instead"}}))),r.AudioSourceComponent=rRe,He.setClassAlias(rRe,"cc.AudioSourceComponent");var oRe=function(){function e(){this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}var t=e.prototype;return t.clone=function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t},t.isDone=function(){return!0},t.startWithTarget=function(e){this.originalTarget=e,this.target=e},t.stop=function(){this.target=null},t.step=function(){E(1006)},t.update=function(){E(1007)},t.getTarget=function(){return this.target},t.setTarget=function(e){this.target=e},t.getOriginalTarget=function(){return this.originalTarget},t.setOriginalTarget=function(e){this.originalTarget=e},t.getTag=function(){return this.tag},t.setTag=function(e){this.tag=e},t.reverse=function(){return E(1008),null},t.retain=function(){},t.release=function(){},e}();oRe.TAG_INVALID=-1;var aRe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._duration=0,t._timesForRepeat=1,t}z(t,e);var n=t.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(e){this._duration=e},n.clone=function(){return new t},t}(oRe),sRe=(function(e){function t(t,n){var i;return void 0===n&&(n=1),(i=e.call(this)||this)._speed=0,i._innerAction=null,t&&i.initWithAction(t,n),i}z(t,e);var n=t.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(e){this._speed=e},n.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(w(1021),!1)},n.clone=function(){var e=new t;return e.initWithAction(this._innerAction.clone(),this._speed),e},n.startWithTarget=function(e){oRe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),oRe.prototype.stop.call(this)},n.step=function(e){this._innerAction.step(e*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new t(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction}}(oRe),0),cRe=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},lRe=function(){function e(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var t=e.prototype;return t._searchElementByTarget=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].target)return e[n];return null},t._getElement=function(e,t){var n=this._elementPool.pop();return n||(n=new cRe),n.target=e,n.paused=!!t,n},t._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},t.addAction=function(e,t,n){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+sRe++);var i=this._hashTargets.get(t);i?i.actions||(i.actions=[]):(i=this._getElement(t,n),this._hashTargets.set(t,i),this._arrayTargets.push(i)),i.target=t,i.actions.push(e),e.startWithTarget(t)}else w(1e3)},t.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var n=e[t];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},t.removeAllActionsFromTarget=function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}},t.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),n=this._hashTargets.get(t);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===e){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},t._removeActionByTag=function(e,t,n){for(var i=0,r=t.actions.length;i<r;++i){var o=t.actions[i];if(o&&o.getTag()===e){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t);break}}},t.removeActionByTag=function(e,t){var n=this;e===oRe.TAG_INVALID&&E(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeActionByTag(e,r,t)}else i.forEach((function(t){n._removeActionByTag(e,t)}))},t.getActionByTag=function(e,t){e===oRe.TAG_INVALID&&E(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===e)return r}E(1005,e)}return null},t.getNumberOfRunningActionsInTarget=function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0},t.pauseTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)},t.resumeTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)},t.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,n=0;n<t.length;n++){var i=t[n];i&&!i.paused&&(i.paused=!0,e.push(i.target))}return e},t.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},t.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},t.purgeSharedManager=function(){r.director.getScheduler().unscheduleUpdate(this)},t._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},t._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}this._putElement(e),t=!0}return t},t.update=function(e){for(var t,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(t=this._currentTarget).target;if(r instanceof Kt&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var o=t.currentAction;t.currentAction=null,this.removeAction(o)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&i--}}},e}(),uRe=e("TweenSystem",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).actionMgr=new lRe,t}return z(t,e),t.prototype.update=function(e){this.actionMgr.update(e)},B(t,[{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(UM));uRe.ID="TWEEN",uRe.instance=void 0,$M.on(JM.EVENT_INIT,(function(){var e=new uRe;uRe.instance=e,$M.registerSystem(uRe.ID,e,UM.Priority.MEDIUM)}));var hRe=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new t},t}(aRe),_Re=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(EF),t=0;t<e.length;++t)e[t].enabled=!0},n.reverse=function(){return new fRe},n.clone=function(){return new t},t}(hRe),fRe=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(EF),t=0;t<e.length;++t)e[t].enabled=!1},n.reverse=function(){return new _Re},n.clone=function(){return new t},t}(hRe);!function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;n.update=function(){for(var e=this.target.getComponentsInChildren(EF),t=0;t<e.length;++t){var n=e[t];n.enabled=!n.enabled}},n.reverse=function(){return new t},n.clone=function(){return new t}}(hRe);var pRe=function(e){function t(t){var n;return(n=e.call(this)||this)._isNeedCleanUp=!0,void 0!==t&&n.init(t),n}z(t,e);var n=t.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(e){return this._isNeedCleanUp=e,!0},n.reverse=function(){return new t(this._isNeedCleanUp)},n.clone=function(){return new t(this._isNeedCleanUp)},t}(hRe),dRe=function(e){function t(t,n,i){var r;return(r=e.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(t,n,i),r}z(t,e);var n=t.prototype;return n.initWithFunction=function(e,t,n){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},n.clone=function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},t}(hRe),mRe=function(e){function t(t){var n;return(n=e.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===t||isNaN(t)||n.initWithDuration(t),n}z(t,e);var n=t.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(e){return this._duration=0===e?et.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},n._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},n.clone=function(){var e=new t(this._duration);return this._cloneDecoration(e),e},n.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},n._computeEaseTime=function(e){return e},n.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(e){oRe.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return E(1010),this},n.setAmplitudeRate=function(){E(1011)},n.getAmplitudeRate=function(){return E(1012),0},n.speed=function(e){return e<=0?(E(1013),this):(this._speedMethod=!0,this._speed*=e,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(e){return this._speed=e,this},n.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?(E(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},t}(aRe),vRe=function(e){function t(n){var i;(i=e.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return w(1019),j(i);var o=r.length-1;if(o>=0&&null==r[o]&&E(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}z(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return w(1025),!1;var n=e._duration,i=t._duration,r=(n*=e._repeatMethod?e._timesForRepeat:1)+(i*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},n.startWithTarget=function(e){mRe.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),oRe.prototype.stop.call(this)},n.update=function(e){var t,n,i=0,r=this._split,o=this._actions,a=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,t=1===r?1:(e-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),t*=n._timesForRepeat,n.update(t>1?t%1:t),this._last=i)},n.reverse=function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},t}(mRe);function gRe(e){var t=e instanceof Array?e:arguments;if(1===t.length)return w(1019),null;var n=t.length-1;n>=0&&null==t[n]&&E(1015);var i=null;if(n>=0){i=t[0];for(var r=1;r<=n;r++)t[r]&&(i=vRe._actionOneTwo(i,t[r]))}return i}vRe._actionOneTwo=function(e,t){var n=new vRe;return n.initWithTwoActions(e,t),n};var yRe=function(e){function t(t,n){var i;return(i=e.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(t,n),i}z(t,e);var n=t.prototype;return n.initWithAction=function(e,t){var n=e._duration*t;return!!this.initWithDuration(n)&&(this._times=t,this._innerAction=e,e instanceof hRe&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},n.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,mRe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),oRe.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<i;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/n,this._nextDt=r>1?1:r;e>=1&&this._total<i&&(t.update(1),this._total++),this._actionInstant||(this._total===i?t.stop():t.update(e-(r-t._duration/n)))}else t.update(e*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(mRe),SRe=function(e){function t(t){var n;return(n=e.call(this)||this)._innerAction=null,t&&n.initWithAction(t),n}z(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?(this._innerAction=e,!0):(w(1026),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},n.startWithTarget=function(e){mRe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},n.isDone=function(){return!1},n.reverse=function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(mRe),xRe=function(e){function t(n){var i;(i=e.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return w(1020),j(i);var o=r.length-1;if(o>=0&&null==r[o]&&E(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}z(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return w(1027),!1;var n=!1,i=e._duration,r=t._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=e,this._two=t,i>r?this._two=vRe._actionOneTwo(t,CRe(i-r)):i<r&&(this._one=vRe._actionOneTwo(e,CRe(r-i))),n=!0),n},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},n.startWithTarget=function(e){mRe.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},n.stop=function(){this._one.stop(),this._two.stop(),oRe.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},n.reverse=function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},t}(mRe);function TRe(e){var t=e instanceof Array?e:arguments;if(1===t.length)return w(1020),null;t.length>0&&null==t[t.length-1]&&E(1015);for(var n=t[0],i=1;i<t.length;i++)null!=t[i]&&(n=xRe._actionOneTwo(n,t[i]));return n}xRe._actionOneTwo=function(e,t){var n=new xRe;return n.initWithTwoActions(e,t),n};var ERe=function(e){function t(){return e.apply(this,arguments)||this}z(t,e);var n=t.prototype;return n.update=function(){},n.reverse=function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e},t}(mRe);function CRe(e){return new ERe(e)}var bRe=function(e){function t(t){var n;return(n=e.call(this)||this)._other=null,t&&n.initWithAction(t),n}z(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?e===this._other?(w(1029),!1):!!mRe.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(w(1028),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},n.startWithTarget=function(e){mRe.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},n.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),oRe.prototype.stop.call(this)},t}(mRe),ARe=e("TweenAction",function(e){function t(t,n,i){var r;if((r=e.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==i)i=Object.create(null);else if(function(e){var t=" [Tween:] ",n=" option is not support in v + "+o,i=e;i.delay&&d(t+"delay"+n),i.repeat&&d(t+"repeat"+n),i.repeatDelay&&d(t+"repeatDelay"+n),i.interpolation&&d(t+"interpolation"+n),i.onStop&&d(t+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var n=(e=e.replace(t,t.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)e="linear";else{var r=n[1];switch(i){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=i+r}}}}return e}(i.easing)),i.progress||(i.progress=r.progress),i.easing&&"string"==typeof i.easing){var a=i.easing;i.easing=af[a],i.easing||b(1031,a)}for(var s in r._opts=i,r._props=Object.create(null),n)if(n.hasOwnProperty(s)){var c=n[s];if("function"==typeof c&&(c=c()),null!=c&&"string"!=typeof c){var l=void 0,u=void 0;void 0!==c.value&&(c.easing||c.progress)&&("string"==typeof c.easing?(l=af[c.easing])||b(1031,c.easing):l=c.easing,u=c.progress,c=c.value);var h=Object.create(null);h.value=c,h.easing=l,h.progress=u,r._props[s]=h}}return r._originProps=n,r.initWithDuration(t),r}z(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},n.startWithTarget=function(e){mRe.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var i in n){var r=e[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=t?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=t?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(e){var t=this.target;if(t){var n=this._props,i=this._opts,r=e;i.easing&&(r=i.easing(e));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(e):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var _ in u)s.current[_]=l(u[_],h[_],s.current[_],c);t[a]=s.current}i.onUpdate&&i.onUpdate(this.target,e),1===e&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(e,t,n,i){return e+(t-e)*i},t}(mRe)),wRe=function(e){function t(t){var n;return(n=e.call(this)||this)._props=void 0,n._props={},void 0!==t&&n.init(t),n}z(t,e);var n=t.prototype;return n.init=function(e){for(var t in e)this._props[t]=e[t];return!0},n.update=function(){var e=this._props,t=this.target;for(var n in e)t[n]=e[n]},n.clone=function(){var e=new t;return e.init(this._props),e},t}(hRe),RRe=e("Tween",function(){function e(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=oRe.TAG_INVALID,this._target=void 0===e?null:e}var t=e.prototype;return t.tag=function(e){return this._tag=e,this},t.then=function(e){return e instanceof oRe?this._actions.push(e.clone()):this._actions.push(e._union()),this},t.target=function(e){return this._target=e,this},t.start=function(){return this._target?(this._finalAction&&uRe.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),uRe.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(d("Please set target to tween first"),this)},t.stop=function(){return this._finalAction&&uRe.instance.ActionManager.removeAction(this._finalAction),this},t.clone=function(e){var t=this._union();return IRe(e).then(t.clone())},t.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},t.to=function(e,t,n){(n=n||Object.create(null)).relative=!1;var i=new ARe(e,t,n);return this._actions.push(i),this},t.by=function(e,t,n){(n=n||Object.create(null)).relative=!0;var i=new ARe(e,t,n);return this._actions.push(i),this},t.set=function(e){var t=new wRe(e);return this._actions.push(t),this},t.delay=function(e){var t=CRe(e);return this._actions.push(t),this},t.call=function(e){var t=function(e){return new dRe(e,void 0,void 0)}(e);return this._actions.push(t),this},t.sequence=function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this},t.parallel=function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this},t.repeat=function(t,n){if(t==1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof e?n._union():r.pop(),r.push(function(e,t){return new yRe(e,t)}(i,t)),this},t.repeatForever=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new SRe(e)}(n)),this},t.reverseTime=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new bRe(e)}(n)),this},t.hide=function(){var e=new fRe;return this._actions.push(e),this},t.show=function(){var e=new _Re;return this._actions.push(e),this},t.removeSelf=function(){var e=new pRe(!1);return this._actions.push(e),this},e.stopAll=function(){uRe.instance.ActionManager.removeAllActions()},e.stopAllByTag=function(e,t){uRe.instance.ActionManager.removeActionByTag(e,t)},e.stopAllByTarget=function(e){uRe.instance.ActionManager.removeAllActionsFromTarget(e)},t._union=function(){var e=this._actions;return 1===e.length?e[0]:gRe(e)},t._destroy=function(){this.stop()},e._wrappedSequence=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return gRe.apply(gRe,t)},e._wrappedParallel=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return TRe.apply(TRe,t)},e}());function IRe(e){return new RRe(e)}function PRe(e){return d("tweenUtil' is deprecated, please use 'tween' instead "),new RRe(e)}RRe._tmp_args=[],r.Tween=RRe,r.tween=IRe,r.tweenUtil=PRe}}}));
